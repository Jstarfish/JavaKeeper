# è·³è¡¨â”€â”€æ²¡å¬è¿‡ä½†å¾ˆçŠ€åˆ©çš„æ•°æ®ç»“æ„

![](https://tva1.sinaimg.cn/large/008i3skNly1grm8yuyywxj30zk0qomyg.jpg)

> Redis æ˜¯æ€ä¹ˆæƒ³çš„ï¼šç”¨è·³è¡¨æ¥å®ç°æœ‰åºé›†åˆï¼Ÿ
>
> Redis çš„ zset æ˜¯ä¸€ä¸ªå¤åˆç»“æ„ï¼Œä¸€æ–¹é¢å®ƒéœ€è¦ä¸€ä¸ª hash ç»“æ„æ¥å­˜å‚¨ value å’Œ score çš„å¯¹åº”å…³ç³»ï¼Œå¦ä¸€æ–¹é¢éœ€è¦æä¾›æŒ‰ç…§ score æ¥æ’åºçš„åŠŸèƒ½ï¼Œè¿˜éœ€è¦èƒ½å¤ŸæŒ‡å®š score çš„èŒƒå›´æ¥è·å– value åˆ—è¡¨çš„åŠŸèƒ½

å¹²è¿‡æœåŠ¡ç«¯å¼€å‘çš„åº”è¯¥éƒ½çŸ¥é“ Redis çš„ ZSet ä½¿ç”¨è·³è¡¨å®ç°çš„ï¼ˆå½“ç„¶è¿˜æœ‰å‹ç¼©åˆ—è¡¨ï¼‰ï¼Œæˆ‘å°±ä¸ä» 1990 å¹´çš„é‚£ä¸ªç¾å›½å¤§ä½¬ William Pugh å‘è¡¨çš„é‚£ç¯‡è®ºæ–‡å¼€å§‹äº†ï¼Œç›´æ¥å¼€è·³

![é©¬é‡Œå¥¥](https://i03piccdn.sogoucdn.com/bbdcce2d04b2bd83)

æ–‡ç« æ‹¢å…±ä¸¤éƒ¨åˆ†

- è·³è¡¨æ˜¯æ€ä¹ˆæçš„
- Redis æ˜¯æ€ä¹ˆæƒ³çš„



## ä¸€ã€è·³è¡¨

### è·³è¡¨çš„ç®€å†

![](https://cdn.jsdelivr.net/gh/Jstarfish/picBed/datastrucutre/skiplist-resume.png)

è·³è¡¨ï¼Œè‹±æ–‡åï¼šSkip List

çˆ¶äº²ï¼šä»è‹±æ–‡åå¯ä»¥çœ‹å‡ºæ¥ï¼Œå®ƒé¦–å…ˆæ˜¯ä¸ª Listï¼Œå®é™…ä¸Šï¼Œå®ƒæ˜¯åœ¨æœ‰åºé“¾è¡¨çš„åŸºç¡€ä¸Šå‘å±•èµ·æ¥çš„

ç«äº‰å¯¹æ‰‹ï¼šè·³è¡¨ï¼ˆskip listï¼‰å¯¹æ ‡çš„æ˜¯å¹³è¡¡æ ‘ï¼ˆAVL Treeï¼‰

ä¼˜ç‚¹ï¼šæ˜¯ä¸€ç§ æ’å…¥/åˆ é™¤/æœç´¢ éƒ½æ˜¯ $O(logn)$ çš„æ•°æ®ç»“æ„ã€‚å®ƒæœ€å¤§çš„ä¼˜åŠ¿æ˜¯åŸç†ç®€å•ã€å®¹æ˜“å®ç°ã€æ–¹ä¾¿æ‰©å±•ã€æ•ˆç‡æ›´é«˜



### è·³è¡¨çš„åŸºæœ¬æ€æƒ³

ä¸€å¦‚å¾€å¸¸ï¼Œé‡‡ç”¨å¾ªåºæ¸è¿›çš„æ‰‹æ³•å¸¦ä½ çª¥æ¢ William Pugh çš„å°å¿ƒæ€~

å‰æï¼šè·³è¡¨å¤„ç†çš„æ˜¯æœ‰åºçš„é“¾è¡¨ï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆçœ‹ä¸ªä¸èƒ½å†æ™®é€šäº†çš„æœ‰åºåˆ—è¡¨ï¼ˆä¸€èˆ¬æ˜¯åŒå‘é“¾è¡¨ï¼‰

![](https://cdn.jsdelivr.net/gh/Jstarfish/picBed/datastrucutre/linkedlist.png)

å¦‚æœæˆ‘ä»¬æƒ³æŸ¥æ‰¾æŸä¸ªæ•°ï¼Œåªèƒ½éå†é“¾è¡¨é€ä¸ªæ¯”å¯¹ï¼Œæ—¶é—´å¤æ‚åº¦ $O(n)$ï¼Œæ’å…¥å’Œåˆ é™¤æ“ä½œéƒ½ä¸€æ ·ã€‚

ä¸ºäº†æé«˜æŸ¥æ‰¾æ•ˆç‡ï¼Œæˆ‘ä»¬å¯¹é“¾è¡¨åšä¸ªâ€ç´¢å¼•â€œ

![](https://cdn.jsdelivr.net/gh/Jstarfish/picBed/datastrucutre/skip-index.png)

åƒè¿™æ ·ï¼Œæˆ‘ä»¬æ¯éš”ä¸€ä¸ªèŠ‚ç‚¹å–ä¸€ä¸ªæ•°æ®ä½œä¸ºç´¢å¼•èŠ‚ç‚¹ï¼ˆæˆ–è€…å¢åŠ ä¸€ä¸ªæŒ‡é’ˆï¼‰ï¼Œæ¯”å¦‚æˆ‘ä»¬è¦æ‰¾ 31 ç›´æ¥åœ¨ç´¢å¼•é“¾è¡¨å°±æ‰¾åˆ°äº†ï¼ˆéå† 3 æ¬¡ï¼‰ï¼Œå¦‚æœæ‰¾ 16 çš„è¯ï¼Œåœ¨éå†åˆ° 31çš„æ—¶å€™ï¼Œå‘ç°å¤§äºç›®æ ‡èŠ‚ç‚¹ï¼Œå°±è·³åˆ°ä¸‹ä¸€å±‚ï¼Œæ¥ç€éå†~ (è“çº¿è¡¨ç¤ºæœç´¢è·¯å¾„)

> æ©ï¼Œå¦‚æœä½ æ•°äº†ä¸‹éå†æ¬¡æ•°ï¼Œæ²¡é”™ï¼ŒåŠ ä¸åŠ ç´¢å¼•éƒ½æ˜¯ 4 æ¬¡éå†æ‰èƒ½æ‰¾åˆ° 16ï¼Œè¿™æ˜¯å› ä¸ºæ•°æ®é‡å¤ªå°‘
>
> æ•°æ®é‡å¤šçš„è¯ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å¤šå»ºå‡ å±‚ç´¢å¼•ï¼Œå¦‚ä¸‹ 4 å±‚ç´¢å¼•ï¼Œæ•ˆæœå°±æ¯”è¾ƒæ˜æ˜¾äº†

![](https://cdn.jsdelivr.net/gh/Jstarfish/picBed/datastrucutre/skiplist.png)

æ¯åŠ ä¸€å±‚ç´¢å¼•ï¼Œæˆ‘ä»¬æœç´¢çš„æ—¶é—´å¤æ‚åº¦å°±é™ä¸ºåŸæ¥çš„ $O(n/2)$

åŠ äº†å‡ å±‚ç´¢å¼•ï¼ŒæŸ¥æ‰¾ä¸€ä¸ªèŠ‚ç‚¹éœ€è¦éå†çš„èŠ‚ç‚¹ä¸ªæ•°æ˜çº¿å‡å°‘äº†ï¼Œæ•ˆç‡æé«˜ä¸å°‘ï¼Œbingo~

æœ‰æ²¡æœ‰ä¼¼æ›¾ç›¸è¯†çš„æ„Ÿè§‰ï¼Œåƒä¸åƒäºŒåˆ†æŸ¥æ‰¾æˆ–è€…äºŒå‰æœç´¢æ ‘ï¼Œé€šè¿‡ç´¢å¼•æ¥è·³è¿‡å¤§é‡çš„èŠ‚ç‚¹ï¼Œä»è€Œæé«˜æœç´¢æ•ˆç‡ã€‚

è¿™æ ·çš„å¤šå±‚é“¾è¡¨ç»“æ„ï¼Œå°±æ˜¯ã€**è·³è¡¨**ã€äº†~~



**é‚£åˆ°åº•æé«˜äº†å¤šå°‘å‘¢ï¼Ÿ**

æ¨ç†ä¸€ç•ªï¼š

1. å¦‚æœä¸€ä¸ªé“¾è¡¨æœ‰ n ä¸ªç»“ç‚¹ï¼Œå¦‚æœæ¯ä¸¤ä¸ªç»“ç‚¹æŠ½å–å‡ºä¸€ä¸ªç»“ç‚¹å»ºç«‹ç´¢å¼•çš„è¯ï¼Œé‚£ä¹ˆç¬¬ä¸€çº§ç´¢å¼•çš„ç»“ç‚¹æ•°å¤§çº¦å°±æ˜¯ n/2ï¼Œç¬¬äºŒçº§ç´¢å¼•çš„ç»“ç‚¹æ•°å¤§çº¦ä¸º n/4ï¼Œä»¥æ­¤ç±»æ¨ç¬¬ m çº§ç´¢å¼•çš„èŠ‚ç‚¹æ•°å¤§çº¦ä¸º $n/(2^m)$ã€‚

2. å‡å¦‚ä¸€å…±æœ‰ m çº§ç´¢å¼•ï¼Œç¬¬ m çº§çš„ç»“ç‚¹æ•°ä¸ºä¸¤ä¸ªï¼Œé€šè¿‡ä¸Šè¾¹æˆ‘ä»¬æ‰¾åˆ°çš„è§„å¾‹ï¼Œé‚£ä¹ˆå¾—å‡º $n/(2^m)=2$ï¼Œä»è€Œæ±‚å¾— m=$log(n)$-1ã€‚å¦‚æœåŠ ä¸ŠåŸå§‹é“¾è¡¨ï¼Œé‚£ä¹ˆæ•´ä¸ªè·³è¡¨çš„é«˜åº¦å°±æ˜¯ $log(n)$ã€‚

3. æˆ‘ä»¬åœ¨æŸ¥è¯¢è·³è¡¨çš„æ—¶å€™ï¼Œå¦‚æœæ¯ä¸€å±‚éƒ½éœ€è¦éå† k ä¸ªç»“ç‚¹ï¼Œé‚£ä¹ˆæœ€ç»ˆçš„æ—¶é—´å¤æ‚åº¦å°±ä¸º $O(k*log(n))$ã€‚

4. é‚£è¿™ä¸ª k å€¼ä¸ºå¤šå°‘å‘¢ï¼ŒæŒ‰ç…§æˆ‘ä»¬æ¯ä¸¤ä¸ªç»“ç‚¹æå–ä¸€ä¸ªåŸºç‚¹å»ºç«‹ç´¢å¼•çš„æƒ…å†µï¼Œæˆ‘ä»¬æ¯ä¸€çº§æœ€å¤šéœ€è¦éå†ä¸¤ä¸ªèŠ‚ç‚¹ï¼Œæ‰€ä»¥ k=2ã€‚

   > ä¸ºä»€ä¹ˆæ¯ä¸€å±‚æœ€å¤šéå†ä¸¤ä¸ªç»“ç‚¹å‘¢ï¼Ÿ
   >
   > å› ä¸ºæˆ‘ä»¬æ˜¯æ¯ä¸¤ä¸ªèŠ‚ç‚¹æå–ä¸€ä¸ªèŠ‚ç‚¹å»ºç«‹ç´¢å¼•ï¼Œæœ€é«˜ä¸€çº§ç´¢å¼•åªæœ‰ä¸¤ä¸ªèŠ‚ç‚¹ï¼Œç„¶åä¸‹ä¸€å±‚ç´¢å¼•æ¯”ä¸Šä¸€å±‚ç´¢å¼•ä¸¤ä¸ªç»“ç‚¹ä¹‹é—´å¢åŠ äº†ä¸€ä¸ªç»“ç‚¹ï¼Œä¹Ÿå°±æ˜¯ä¸Šä¸€å±‚ç´¢å¼•ä¸¤ç»“ç‚¹çš„ä¸­å€¼ï¼Œçœ‹åˆ°è¿™é‡Œæ˜¯ä¸æ˜¯æƒ³èµ·äº†äºŒåˆ†æŸ¥æ‰¾ï¼Œæ¯æ¬¡æˆ‘ä»¬åªéœ€è¦åˆ¤æ–­è¦æ‰¾çš„å€¼åœ¨ä¸åœ¨å½“å‰èŠ‚ç‚¹å’Œä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¹‹é—´å°±å¯ä»¥äº†ã€‚
   >
   > ä¸ä¿¡ï¼Œä½ ç…§ç€ä¸‹å›¾æ¯”åˆ’æ¯”åˆ’ï¼Œçœ‹çœ‹åŒä¸€å±‚èƒ½ç”»å‡º 3 æ¡çº¿ä¸~~
   >
   > ![](https://cdn.jsdelivr.net/gh/Jstarfish/picBed/datastrucutre/skiplist-index-count.png)

5. æ—¢ç„¶çŸ¥é“äº†æ¯ä¸€å±‚æœ€å¤šéå†ä¸¤ä¸ªèŠ‚ç‚¹ï¼Œé‚£è·³è¡¨æŸ¥è¯¢æ•°æ®çš„æ—¶é—´å¤æ‚åº¦å°±æ˜¯ $O(2*log(n))$ï¼Œå¸¸æ•° 2 å¿½ç•¥ä¸è®¡ï¼Œå°±æ˜¯ $O(logn)$ äº†ã€‚



**ç©ºé—´æ¢æ—¶é—´**

è·³è¡¨çš„æ•ˆç‡æ¯”é“¾è¡¨é«˜äº†ï¼Œä½†æ˜¯è·³è¡¨éœ€è¦é¢å¤–å­˜å‚¨å¤šçº§ç´¢å¼•ï¼Œæ‰€ä»¥éœ€è¦æ›´å¤šçš„å†…å­˜ç©ºé—´ã€‚

è·³è¡¨çš„ç©ºé—´å¤æ‚åº¦åˆ†æå¹¶ä¸éš¾ï¼Œå¦‚æœä¸€ä¸ªé“¾è¡¨æœ‰ n ä¸ªèŠ‚ç‚¹ï¼Œæ¯ä¸¤ä¸ªèŠ‚ç‚¹æŠ½å–å‡ºä¸€ä¸ªèŠ‚ç‚¹å»ºç«‹ç´¢å¼•çš„è¯ï¼Œé‚£ä¹ˆç¬¬ä¸€çº§ç´¢å¼•çš„èŠ‚ç‚¹æ•°å¤§çº¦å°±æ˜¯ n/2ï¼Œç¬¬äºŒçº§ç´¢å¼•çš„èŠ‚ç‚¹æ•°å¤§çº¦ä¸º n/4ï¼Œä»¥æ­¤ç±»æ¨ç¬¬ m çº§ç´¢å¼•çš„èŠ‚ç‚¹æ•°å¤§çº¦ä¸º $n/(2^m)$ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºæ¥è¿™æ˜¯ä¸€ä¸ªç­‰æ¯”æ•°åˆ—ã€‚

è¿™å‡ çº§ç´¢å¼•çš„ç»“ç‚¹æ€»å’Œå°±æ˜¯ n/2+n/4+n/8â€¦+8+4+2=n-2ï¼Œæ‰€ä»¥è·³è¡¨çš„ç©ºé—´å¤æ‚åº¦ä¸º  $O(n)$ã€‚

> å®é™…ä¸Šï¼Œåœ¨è½¯ä»¶å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ä¸å¿…å¤ªåœ¨æ„ç´¢å¼•å ç”¨çš„é¢å¤–ç©ºé—´ã€‚åœ¨è®²æ•°æ®ç»“æ„å’Œç®—æ³•æ—¶ï¼Œæˆ‘ä»¬ä¹ æƒ¯æ€§åœ°æŠŠè¦å¤„ç†çš„æ•°æ®çœ‹æˆæ•´æ•°ï¼Œä½†æ˜¯åœ¨å®é™…çš„è½¯ä»¶å¼€å‘ä¸­ï¼ŒåŸå§‹é“¾è¡¨ä¸­å­˜å‚¨çš„æœ‰å¯èƒ½æ˜¯å¾ˆå¤§çš„å¯¹è±¡ï¼Œè€Œç´¢å¼•ç»“ç‚¹åªéœ€è¦å­˜å‚¨å…³é”®å€¼å’Œå‡ ä¸ªæŒ‡é’ˆï¼Œå¹¶ä¸éœ€è¦å­˜å‚¨å¯¹è±¡ï¼Œæ‰€ä»¥å½“å¯¹è±¡æ¯”ç´¢å¼•ç»“ç‚¹å¤§å¾ˆå¤šæ—¶ï¼Œé‚£ç´¢å¼•å ç”¨çš„é¢å¤–ç©ºé—´å°±å¯ä»¥å¿½ç•¥äº†ã€‚



#### æ’å…¥æ•°æ®

å…¶å®æ’å…¥æ•°æ®å’ŒæŸ¥æ‰¾ä¸€æ ·ï¼Œå…ˆæ‰¾åˆ°å…ƒç´ è¦æ’å…¥çš„ä½ç½®ï¼Œæ—¶é—´å¤æ‚åº¦ä¹Ÿæ˜¯ $O(logn)$ï¼Œä½†æœ‰ä¸ªé—®é¢˜å°±æ˜¯å¦‚æœä¸€ç›´å¾€åŸå§‹åˆ—è¡¨é‡ŒåŠ æ•°æ®ï¼Œä¸æ›´æ–°æˆ‘ä»¬çš„ç´¢å¼•å±‚ï¼Œæç«¯æƒ…å†µä¸‹å°±ä¼šå‡ºç°ä¸¤ä¸ªç´¢å¼•èŠ‚ç‚¹ä¸­é—´æ•°æ®éå¸¸å¤šï¼Œç›¸å½“äºé€€åŒ–æˆäº†å•é“¾è¡¨ï¼ŒæŸ¥æ‰¾æ•ˆç‡ç›´æ¥å˜æˆ $O(n)$

![](https://cdn.jsdelivr.net/gh/Jstarfish/picBed/datastrucutre/skiplist-insert.png)



#### è·³è¡¨ç´¢å¼•åŠ¨æ€æ›´æ–°

æˆ‘ä»¬ä¸Šè¾¹å»ºç«‹ç´¢å¼•å±‚éƒ½æ˜¯ä¸‹å±‚èŠ‚ç‚¹ä¸ªæ•°çš„ 1/2ï¼Œæœ€é«˜å±‚ç´¢å¼•çš„èŠ‚ç‚¹æ•°å°±æ˜¯ 2 ä¸ªï¼Œä½†æ˜¯æˆ‘ä»¬éšæ„æ’å…¥æˆ–è€…åˆ é™¤ä¸€ä¸ªåŸæœ‰é“¾è¡¨çš„èŠ‚ç‚¹ï¼Œè¿™ä¸ªæ¯”ä¾‹å°±è‚¯å®šä¼šè¢«ç ´åã€‚

ä½œä¸ºä¸€ç§åŠ¨æ€æ•°æ®ç»“æ„ï¼Œæˆ‘ä»¬éœ€è¦æŸç§æ‰‹æ®µæ¥ç»´æŠ¤ç´¢å¼•ä¸åŸå§‹é“¾è¡¨å¤§å°ä¹‹é—´çš„å¹³è¡¡ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœé“¾è¡¨ä¸­ç»“ç‚¹å¤šäº†ï¼Œç´¢å¼•ç»“ç‚¹å°±ç›¸åº”åœ°å¢åŠ ä¸€äº›ï¼Œé¿å…å¤æ‚åº¦é€€åŒ–ã€‚

å¦‚æœé‡å»ºç´¢å¼•çš„è¯ï¼Œæ•ˆç‡å°±ä¸èƒ½ä¿è¯äº†ã€‚

> å¦‚æœä½ äº†è§£çº¢é»‘æ ‘ã€AVL æ ‘è¿™æ ·å¹³è¡¡äºŒå‰æ ‘ï¼Œä½ å°±çŸ¥é“å®ƒä»¬æ˜¯é€šè¿‡å·¦å³æ—‹çš„æ–¹å¼ä¿æŒå·¦å³å­æ ‘çš„å¤§å°å¹³è¡¡ï¼Œè€Œè·³è¡¨æ˜¯é€šè¿‡éšæœºå‡½æ•°æ¥ç»´æŠ¤å‰é¢æåˆ°çš„â€œå¹³è¡¡æ€§â€ã€‚

æ‰€ä»¥è·³è¡¨ï¼ˆskip listï¼‰ç´¢æ€§å°±ä¸å¼ºåˆ¶è¦æ±‚ `1:2` äº†ï¼Œä¸€ä¸ªèŠ‚ç‚¹è¦ä¸è¦è¢«ç´¢å¼•ï¼Œå»ºå‡ å±‚çš„ç´¢å¼•ï¼Œå°±éšæ„ç‚¹å§ï¼Œéƒ½åœ¨èŠ‚ç‚¹æ’å…¥æ—¶ç”±æŠ›ç¡¬å¸å†³å®šã€‚

æ¯”å¦‚æˆ‘ä»¬è¦æ’å…¥æ–°èŠ‚ç‚¹ Xï¼Œé‚£è¦ä¸è¦ä¸º X å‘ä¸Šå»ºç´¢å¼•å‘¢ï¼Œå°±æ˜¯æŠ›ç¡¬å¸å†³å®šçš„ï¼Œæ­£é¢çš„è¯å»ºç´¢å¼•ï¼Œå¦åˆ™å°±ä¸å»ºäº†ï¼Œå°±æ˜¯è¿™ä¹ˆéšæ„ï¼ˆå“ªå‡ å±‚å»ºç´¢å¼•åŒæ ·è¿™ä¹ˆéšæœºï¼‰ã€‚

![](https://cdn.jsdelivr.net/gh/Jstarfish/picBed/datastrucutre/20210626125654.gif)

å…¶å®æ˜¯å› ä¸ºæˆ‘ä»¬ä¸èƒ½é¢„æµ‹è·³è¡¨çš„æ·»åŠ å’Œåˆ é™¤æ“ä½œï¼Œå¾ˆéš¾ç”¨ä¸€ç§æœ‰æ•ˆçš„ç®—æ³•ä¿è¯ç´¢å¼•éƒ¨åˆ†å§‹ç»ˆå‡åŒ€ã€‚å­¦è¿‡æ¦‚ç‡è®ºçš„æˆ‘ä»¬éƒ½çŸ¥é“æŠ›ç¡¬å¸è™½ç„¶ä¸èƒ½è®©ç´¢å¼•ä½ç½®ç»å¯¹å‡åŒ€ï¼Œå½“æ•°é‡è¶³å¤Ÿå¤šçš„æ—¶å€™æœ€èµ·ç å¯ä»¥ä¿è¯å¤§ä½“ä¸Šç›¸å¯¹å‡åŒ€ã€‚

åˆ é™¤èŠ‚ç‚¹ç›¸å¯¹æ¥è¯´å°±å®¹æ˜“å¾ˆå¤šäº†ï¼Œåœ¨ç´¢å¼•å±‚æ‰¾åˆ°èŠ‚ç‚¹çš„è¯ï¼Œå°±é¡ºè—¤æ‘¸ç“œé€ä¸ªå¾€ä¸‹åˆ é™¤è¯¥ç´¢å¼•èŠ‚ç‚¹å’ŒåŸé“¾è¡¨ä¸Šçš„èŠ‚ç‚¹ï¼Œå¦‚æœå“ªä¸€å±‚ç´¢å¼•èŠ‚ç‚¹è¢«åˆ çš„å°±å‰© 1 ä¸ªèŠ‚ç‚¹çš„è¯ï¼Œç›´æ¥æŠŠè¿™ä¸€å±‚ææ‰å°±å¯ä»¥äº†ã€‚



å…¶å®è·³è¡¨çš„æ€æƒ³å¾ˆå®¹æ˜“ç†è§£ï¼Œå¯æ˜¯æ¶ä¸ä½å®æˆ˜

### è·³è¡¨çš„å®ç°

> https://leetcode-cn.com/problems/design-skiplist/

å·®ä¸å¤šäº†è§£äº†è·³è¡¨ï¼Œå…¶å®å°±æ˜¯åŠ äº†å‡ å±‚ç´¢å¼•çš„é“¾è¡¨ï¼Œä¸€å…±æœ‰ N å±‚ï¼Œä»¥ 0 ~ N-1 å±‚è¡¨ç¤ºï¼Œè®¾ç¬¬ 0 å±‚æ˜¯åŸé“¾è¡¨ï¼ŒæŠ½å–å…¶ä¸­éƒ¨åˆ†å…ƒç´ ï¼Œåœ¨ç¬¬ 1 å±‚å½¢æˆæ–°çš„é“¾è¡¨ï¼Œä¸Šä¸‹å±‚çš„ç›¸åŒå…ƒç´ ä¹‹é—´è¿èµ·æ¥ï¼›å†æŠ½å–ç¬¬ 1 å±‚éƒ¨åˆ†å…ƒç´ ï¼Œæ„æˆç¬¬ 2 å±‚ï¼Œä»¥æ­¤ç±»æ¨ã€‚



```java
package skiplist;

import java.util.Random;

/**
 * è·³è¡¨çš„ä¸€ç§å®ç°æ–¹æ³•ã€‚
 * è·³è¡¨ä¸­å­˜å‚¨çš„æ˜¯æ­£æ•´æ•°ï¼Œå¹¶ä¸”å­˜å‚¨çš„æ˜¯ä¸é‡å¤çš„ã€‚
 */
public class SkipList {

  private static final int MAX_LEVEL = 16;

  private static final float SKIPLIST_P = 0.5f;

  private int levelCount = 1;

  private Node head = new Node();  // å¸¦å¤´é“¾è¡¨

  private Random r = new Random();

  public Node find(int value) {
    Node p = head;
    for (int i = levelCount - 1; i >= 0; --i) {
      while (p.forwards[i] != null && p.forwards[i].data < value) {
        p = p.forwards[i];
      }
    }

    if (p.forwards[0] != null && p.forwards[0].data == value) {
      return p.forwards[0];
    } else {
      return null;
    }
  }

  public void insert(int value) {
    int level = randomLevel();
    Node newNode = new Node();
    newNode.data = value;
    newNode.maxLevel = level;
    Node update[] = new Node[level];
    for (int i = 0; i < level; ++i) {
      update[i] = head;
    }

    // record every level largest value which smaller than insert value in update[]
    Node p = head;
    for (int i = level - 1; i >= 0; --i) {
      while (p.forwards[i] != null && p.forwards[i].data < value) {
        p = p.forwards[i];
      }
      update[i] = p;// use update save node in search path
    }

    // in search path node next node become new node forwords(next)
    for (int i = 0; i < level; ++i) {
      newNode.forwards[i] = update[i].forwards[i];
      update[i].forwards[i] = newNode;
    }

    // update node hight
    if (levelCount < level) levelCount = level;
  }

  public void delete(int value) {
    Node[] update = new Node[levelCount];
    Node p = head;
    for (int i = levelCount - 1; i >= 0; --i) {
      while (p.forwards[i] != null && p.forwards[i].data < value) {
        p = p.forwards[i];
      }
      update[i] = p;
    }

    if (p.forwards[0] != null && p.forwards[0].data == value) {
      for (int i = levelCount - 1; i >= 0; --i) {
        if (update[i].forwards[i] != null && update[i].forwards[i].data == value) {
          update[i].forwards[i] = update[i].forwards[i].forwards[i];
        }
      }
    }
  }

 // ç†è®ºæ¥è®²ï¼Œä¸€çº§ç´¢å¼•ä¸­å…ƒç´ ä¸ªæ•°åº”è¯¥å åŸå§‹æ•°æ®çš„ 50%ï¼ŒäºŒçº§ç´¢å¼•ä¸­å…ƒç´ ä¸ªæ•°å  25%ï¼Œä¸‰çº§ç´¢å¼•12.5% ï¼Œä¸€ç›´åˆ°æœ€é¡¶å±‚ã€‚
  // å› ä¸ºè¿™é‡Œæ¯ä¸€å±‚çš„æ™‹å‡æ¦‚ç‡æ˜¯ 50%ã€‚å¯¹äºæ¯ä¸€ä¸ªæ–°æ’å…¥çš„èŠ‚ç‚¹ï¼Œéƒ½éœ€è¦è°ƒç”¨ randomLevel ç”Ÿæˆä¸€ä¸ªåˆç†çš„å±‚æ•°ã€‚
  // è¯¥ randomLevel æ–¹æ³•ä¼šéšæœºç”Ÿæˆ 1~MAX_LEVEL ä¹‹é—´çš„æ•°ï¼Œä¸” ï¼š
  //        50%çš„æ¦‚ç‡è¿”å› 1
  //        25%çš„æ¦‚ç‡è¿”å› 2
  //      12.5%çš„æ¦‚ç‡è¿”å› 3 ...
  private int randomLevel() {
    int level = 1;

    while (Math.random() < SKIPLIST_P && level < MAX_LEVEL)
      level += 1;
    return level;
  }

  public void printAll() {
    Node p = head;
    while (p.forwards[0] != null) {
      System.out.print(p.forwards[0] + " ");
      p = p.forwards[0];
    }
    System.out.println();
  }

  public class Node {
    private int data = -1;
    private Node forwards[] = new Node[MAX_LEVEL];
    private int maxLevel = 0;

    @Override
    public String toString() {
      StringBuilder builder = new StringBuilder();
      builder.append("{ data: ");
      builder.append(data);
      builder.append("; levels: ");
      builder.append(maxLevel);
      builder.append(" }");

      return builder.toString();
    }
  }

}
```



## äºŒã€Redis ä¸ºä»€ä¹ˆé€‰æ‹©è·³è¡¨ï¼Ÿ

ä¸ºä»€ä¹ˆ Redis è¦ç”¨è·³è¡¨æ¥å®ç°æœ‰åºé›†åˆï¼Œè€Œä¸æ˜¯çº¢é»‘æ ‘ï¼Ÿ

Redis ä¸­çš„æœ‰åºé›†åˆæ˜¯é€šè¿‡è·³è¡¨æ¥å®ç°çš„ï¼Œä¸¥æ ¼ç‚¹è®²ï¼Œå…¶å®è¿˜ç”¨åˆ°äº†æ•£åˆ—è¡¨ã€‚

å¦‚æœä½ å»æŸ¥çœ‹ Redis çš„å¼€å‘æ‰‹å†Œï¼Œå°±ä¼šå‘ç°ï¼ŒRedis ä¸­çš„æœ‰åºé›†åˆæ”¯æŒçš„æ ¸å¿ƒæ“ä½œä¸»è¦æœ‰ä¸‹é¢è¿™å‡ ä¸ªï¼š

- æ’å…¥ä¸€ä¸ªæ•°æ®ï¼›
- åˆ é™¤ä¸€ä¸ªæ•°æ®ï¼›
- æŸ¥æ‰¾ä¸€ä¸ªæ•°æ®ï¼›
- æŒ‰ç…§åŒºé—´æŸ¥æ‰¾æ•°æ®ï¼ˆæ¯”å¦‚æŸ¥æ‰¾å€¼åœ¨[100, 356]ä¹‹é—´çš„æ•°æ®ï¼‰ï¼›
- è¿­ä»£è¾“å‡ºæœ‰åºåºåˆ—ã€‚

å…¶ä¸­ï¼Œæ’å…¥ã€åˆ é™¤ã€æŸ¥æ‰¾ä»¥åŠè¿­ä»£è¾“å‡ºæœ‰åºåºåˆ—è¿™å‡ ä¸ªæ“ä½œï¼Œçº¢é»‘æ ‘ä¹Ÿå¯ä»¥å®Œæˆï¼Œæ—¶é—´å¤æ‚åº¦è·Ÿè·³è¡¨æ˜¯ä¸€æ ·çš„ã€‚ä½†æ˜¯ï¼ŒæŒ‰ç…§åŒºé—´æ¥æŸ¥æ‰¾æ•°æ®è¿™ä¸ªæ“ä½œï¼Œçº¢é»‘æ ‘çš„æ•ˆç‡æ²¡æœ‰è·³è¡¨é«˜ã€‚

å¯¹äºæŒ‰ç…§åŒºé—´æŸ¥æ‰¾æ•°æ®è¿™ä¸ªæ“ä½œï¼Œè·³è¡¨å¯ä»¥åšåˆ° $O(logn)$ çš„æ—¶é—´å¤æ‚åº¦å®šä½åŒºé—´çš„èµ·ç‚¹ï¼Œç„¶ååœ¨åŸå§‹é“¾è¡¨ä¸­é¡ºåºå¾€åéå†å°±å¯ä»¥äº†ã€‚è¿™æ ·åšéå¸¸é«˜æ•ˆã€‚

å½“ç„¶ï¼ŒRedis ä¹‹æ‰€ä»¥ç”¨è·³è¡¨æ¥å®ç°æœ‰åºé›†åˆï¼Œè¿˜æœ‰å…¶ä»–åŸå› ï¼Œæ¯”å¦‚ï¼Œè·³è¡¨æ›´å®¹æ˜“ä»£ç å®ç°ã€‚è™½ç„¶è·³è¡¨çš„å®ç°ä¹Ÿä¸ç®€å•ï¼Œä½†æ¯”èµ·çº¢é»‘æ ‘æ¥è¯´è¿˜æ˜¯å¥½æ‡‚ã€å¥½å†™å¤šäº†ï¼Œè€Œç®€å•å°±æ„å‘³ç€å¯è¯»æ€§å¥½ï¼Œä¸å®¹æ˜“å‡ºé”™ã€‚è¿˜æœ‰ï¼Œè·³è¡¨æ›´åŠ çµæ´»ï¼Œå®ƒå¯ä»¥é€šè¿‡æ”¹å˜ç´¢å¼•æ„å»ºç­–ç•¥ï¼Œæœ‰æ•ˆå¹³è¡¡æ‰§è¡Œæ•ˆç‡å’Œå†…å­˜æ¶ˆè€—ã€‚



> æœ‰åºé›†åˆçš„è‹±æ–‡å…¨ç§°æ˜æ˜æ˜¯**sorted sets**ï¼Œä¸ºå•¥å«zsetå‘¢ï¼Ÿ
>
> ediså®˜ç½‘ä¸Šæ²¡æœ‰è§£é‡Šï¼Œä½†æ˜¯åœ¨Githubä¸Šæœ‰äººå‘ä½œè€…æé—®äº†ã€‚ä½œè€…æ˜¯è¿™ä¹ˆå›ç­”çš„å“ˆå“ˆå“ˆ
>
> Hello. Z is as in XYZ, so the idea is, sets with another dimension: the
> order. Itâ€™s a far associationâ€¦ I know ğŸ˜ƒ
>
> åŸæ¥å‰é¢çš„Zä»£è¡¨çš„æ˜¯XYZä¸­çš„Zï¼Œæœ€åä¸€ä¸ªè‹±æ–‡å­—æ¯ï¼Œzsetæ˜¯åœ¨è¯´è¿™æ˜¯æ¯”setæœ‰æ›´å¤šä¸€ä¸ªç»´åº¦çš„set ğŸ˜¦
>
> æ˜¯ä¸æ²¡é“ç†ï¼Ÿ
>
> æ›´æ²¡é“ç†çš„æœ‰ä¸ªï¼ŒRedis é»˜è®¤ç«¯å£ 6379 ï¼Œå› ä¸ºä½œè€…å–œæ¬¢çš„ä¸€ä¸ªå«Merzçš„å¥³æ˜æ˜Ÿï¼Œå…¶åå­—åœ¨æ‰‹æœºä¸Šè¾“å…¥æ­£å¥½å¯¹åº”å·ç 6379ï¼Œç´¢æ€§å°±æŠŠRedisçš„é»˜è®¤ç«¯å£å«6379äº†â€¦





Redis çš„è·³è·ƒè¡¨å…±æœ‰ 64 å±‚ï¼Œå®¹çº³ 2^64 ä¸ªå…ƒç´ åº”è¯¥ä¸æˆé—®é¢˜ã€‚æ¯ä¸€ä¸ª kv å—å¯¹åº”çš„ç»“æ„å¦‚ä¸‹é¢çš„ä»£ç ä¸­çš„`zslnode`ç»“æ„ï¼Œkv header ä¹Ÿæ˜¯è¿™ä¸ªç»“æ„ï¼Œåªä¸è¿‡ value å­—æ®µæ˜¯ null å€¼â€”â€”æ— æ•ˆçš„ï¼Œscore æ˜¯ Double.MIN_VALUEï¼Œç”¨æ¥å«åº•çš„ã€‚kv ä¹‹é—´ä½¿ç”¨æŒ‡é’ˆä¸²èµ·æ¥å½¢æˆäº†åŒå‘é“¾è¡¨ç»“æ„ï¼Œå®ƒä»¬æ˜¯ **æœ‰åº** æ’åˆ—çš„ï¼Œä»å°åˆ°å¤§ã€‚ä¸åŒçš„ kv å±‚é«˜å¯èƒ½ä¸ä¸€æ ·ï¼Œå±‚æ•°è¶Šé«˜çš„ kv è¶Šå°‘ã€‚åŒä¸€å±‚çš„ kv ä¼šä½¿ç”¨æŒ‡é’ˆä¸²èµ·æ¥ã€‚æ¯ä¸€ä¸ªå±‚å…ƒç´ çš„éå†éƒ½æ˜¯ä» kv header å‡ºå‘ã€‚

```c
struct zslnode {
  string value;
  double score;
  zslnode*[] forwards;  // å¤šå±‚è¿æ¥æŒ‡é’ˆ
  zslnode* backward;  // å›æº¯æŒ‡é’ˆ
}

struct zsl {
  zslnode* header; // è·³è·ƒåˆ—è¡¨å¤´æŒ‡é’ˆ
  int maxLevel; // è·³è·ƒåˆ—è¡¨å½“å‰çš„æœ€é«˜å±‚
  map<string, zslnode*> ht; // hash ç»“æ„çš„æ‰€æœ‰é”®å€¼å¯¹
}
```



## æŸ¥æ‰¾è¿‡ç¨‹

è®¾æƒ³å¦‚æœè·³è·ƒåˆ—è¡¨åªæœ‰ä¸€å±‚ä¼šæ€æ ·ï¼Ÿæ’å…¥åˆ é™¤æ“ä½œéœ€è¦å®šä½åˆ°ç›¸åº”çš„ä½ç½®èŠ‚ç‚¹ (å®šä½åˆ°æœ€åä¸€ä¸ªæ¯”ã€Œæˆ‘ã€å°çš„å…ƒç´ ï¼Œä¹Ÿå°±æ˜¯ç¬¬ä¸€ä¸ªæ¯”ã€Œæˆ‘ã€å¤§çš„å…ƒç´ çš„å‰ä¸€ä¸ª)ï¼Œå®šä½çš„æ•ˆç‡è‚¯å®šæ¯”è¾ƒå·®ï¼Œå¤æ‚åº¦å°†ä¼šæ˜¯ O(n)ï¼Œå› ä¸ºéœ€è¦æŒ¨ä¸ªéå†ã€‚ä¹Ÿè®¸ä½ ä¼šæƒ³åˆ°äºŒåˆ†æŸ¥æ‰¾ï¼Œä½†æ˜¯äºŒåˆ†æŸ¥æ‰¾çš„ç»“æ„åªèƒ½æ˜¯æœ‰åºæ•°ç»„ã€‚è·³è·ƒåˆ—è¡¨æœ‰äº†å¤šå±‚ç»“æ„ä¹‹åï¼Œè¿™ä¸ªå®šä½çš„ç®—æ³•å¤æ‚åº¦å°†ä¼šé™åˆ° O(lg(n))ã€‚



![img](https://user-gold-cdn.xitu.io/2018/7/27/164dc52ae7e6444c?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)



å¦‚å›¾æ‰€ç¤ºï¼Œæˆ‘ä»¬è¦å®šä½åˆ°é‚£ä¸ªç´«è‰²çš„ kvï¼Œéœ€è¦ä» header çš„æœ€é«˜å±‚å¼€å§‹éå†æ‰¾åˆ°ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ (æœ€åä¸€ä¸ªæ¯”ã€Œæˆ‘ã€å°çš„å…ƒç´ )ï¼Œç„¶åä»è¿™ä¸ªèŠ‚ç‚¹å¼€å§‹é™ä¸€å±‚å†éå†æ‰¾åˆ°ç¬¬äºŒä¸ªèŠ‚ç‚¹ (æœ€åä¸€ä¸ªæ¯”ã€Œæˆ‘ã€å°çš„å…ƒç´ )ï¼Œç„¶åä¸€ç›´é™åˆ°æœ€åº•å±‚è¿›è¡Œéå†å°±æ‰¾åˆ°äº†æœŸæœ›çš„èŠ‚ç‚¹ (æœ€åº•å±‚çš„æœ€åä¸€ä¸ªæ¯”æˆ‘ã€Œå°ã€çš„å…ƒç´ )ã€‚

æˆ‘ä»¬å°†ä¸­é—´ç»è¿‡çš„ä¸€ç³»åˆ—èŠ‚ç‚¹ç§°ä¹‹ä¸ºã€Œæœç´¢è·¯å¾„ã€ï¼Œå®ƒæ˜¯ä»æœ€é«˜å±‚ä¸€ç›´åˆ°æœ€åº•å±‚çš„æ¯ä¸€å±‚æœ€åä¸€ä¸ªæ¯”ã€Œæˆ‘ã€å°çš„å…ƒç´ èŠ‚ç‚¹åˆ—è¡¨ã€‚

æœ‰äº†è¿™ä¸ªæœç´¢è·¯å¾„ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ’å…¥è¿™ä¸ªæ–°èŠ‚ç‚¹äº†ã€‚ä¸è¿‡è¿™ä¸ªæ’å…¥è¿‡ç¨‹ä¹Ÿä¸æ˜¯ç‰¹åˆ«ç®€å•ã€‚å› ä¸ºæ–°æ’å…¥çš„èŠ‚ç‚¹åˆ°åº•æœ‰å¤šå°‘å±‚ï¼Œå¾—æœ‰ä¸ªç®—æ³•æ¥åˆ†é…ä¸€ä¸‹ï¼Œè·³è·ƒåˆ—è¡¨ä½¿ç”¨çš„æ˜¯éšæœºç®—æ³•ã€‚

## éšæœºå±‚æ•°

å¯¹äºæ¯ä¸€ä¸ªæ–°æ’å…¥çš„èŠ‚ç‚¹ï¼Œéƒ½éœ€è¦è°ƒç”¨ä¸€ä¸ªéšæœºç®—æ³•ç»™å®ƒåˆ†é…ä¸€ä¸ªåˆç†çš„å±‚æ•°ã€‚ç›´è§‚ä¸ŠæœŸæœ›çš„ç›®æ ‡æ˜¯ 50% çš„ Level1ï¼Œ25% çš„ Level2ï¼Œ12.5% çš„ Level3ï¼Œä¸€ç›´åˆ°æœ€é¡¶å±‚`2^-63`ï¼Œå› ä¸ºè¿™é‡Œæ¯ä¸€å±‚çš„æ™‹å‡æ¦‚ç‡æ˜¯ 50%ã€‚

```
/* Returns a random level for the new skiplist node we are going to create.
 * The return value of this function is between 1 and ZSKIPLIST_MAXLEVEL
 * (both inclusive), with a powerlaw-alike distribution where higher
 * levels are less likely to be returned. */
int zslRandomLevel(void) {
    int level = 1;
    while ((random()&0xFFFF) < (ZSKIPLIST_P * 0xFFFF))
        level += 1;
    return (level<ZSKIPLIST_MAXLEVEL) ? level : ZSKIPLIST_MAXLEVEL;
}
```

ä¸è¿‡ Redis æ ‡å‡†æºç ä¸­çš„æ™‹å‡æ¦‚ç‡åªæœ‰ 25%ï¼Œä¹Ÿå°±æ˜¯ä»£ç ä¸­çš„ ZSKIPLIST_P çš„å€¼ã€‚æ‰€ä»¥å®˜æ–¹çš„è·³è·ƒåˆ—è¡¨æ›´åŠ çš„æ‰å¹³åŒ–ï¼Œå±‚é«˜ç›¸å¯¹è¾ƒä½ï¼Œåœ¨å•ä¸ªå±‚ä¸Šéœ€è¦éå†çš„èŠ‚ç‚¹æ•°é‡ä¼šç¨å¤šä¸€ç‚¹ã€‚

ä¹Ÿæ­£æ˜¯å› ä¸ºå±‚æ•°ä¸€èˆ¬ä¸é«˜ï¼Œæ‰€ä»¥éå†çš„æ—¶å€™ä»é¡¶å±‚å¼€å§‹å¾€ä¸‹éå†ä¼šéå¸¸æµªè´¹ã€‚è·³è·ƒåˆ—è¡¨ä¼šè®°å½•ä¸€ä¸‹å½“å‰çš„æœ€é«˜å±‚æ•°`maxLevel`ï¼Œéå†æ—¶ä»è¿™ä¸ª maxLevel å¼€å§‹éå†æ€§èƒ½å°±ä¼šæé«˜å¾ˆå¤šã€‚

## æ’å…¥è¿‡ç¨‹

ä¸‹é¢æ˜¯æ’å…¥è¿‡ç¨‹çš„æºç ï¼Œå®ƒç¨å¾®æœ‰ç‚¹é•¿ï¼Œä¸è¿‡æ•´ä½“çš„è¿‡ç¨‹è¿˜æ˜¯æ¯”è¾ƒæ¸…æ™°çš„ã€‚

```
/* Insert a new node in the skiplist. Assumes the element does not already
 * exist (up to the caller to enforce that). The skiplist takes ownership
 * of the passed SDS string 'ele'. */
zskiplistNode *zslInsert(zskiplist *zsl, double score, sds ele) {
    // å­˜å‚¨æœç´¢è·¯å¾„
    zskiplistNode *update[ZSKIPLIST_MAXLEVEL], *x;
    // å­˜å‚¨ç»è¿‡çš„èŠ‚ç‚¹è·¨åº¦
    unsigned int rank[ZSKIPLIST_MAXLEVEL];
    int i, level;

    serverAssert(!isnan(score));
    x = zsl->header;
    // é€æ­¥é™çº§å¯»æ‰¾ç›®æ ‡èŠ‚ç‚¹ï¼Œå¾—åˆ°ã€Œæœç´¢è·¯å¾„ã€
    for (i = zsl->level-1; i >= 0; i--) {
        /* store rank that is crossed to reach the insert position */
        rank[i] = i == (zsl->level-1) ? 0 : rank[i+1];
        // å¦‚æœscoreç›¸ç­‰ï¼Œè¿˜éœ€è¦æ¯”è¾ƒvalue
        while (x->level[i].forward &&
                (x->level[i].forward->score < score ||
                    (x->level[i].forward->score == score &&
                    sdscmp(x->level[i].forward->ele,ele) < 0)))
        {
            rank[i] += x->level[i].span;
            x = x->level[i].forward;
        }
        update[i] = x;
    }
    // æ­£å¼è¿›å…¥æ’å…¥è¿‡ç¨‹
    /* we assume the element is not already inside, since we allow duplicated
     * scores, reinserting the same element should never happen since the
     * caller of zslInsert() should test in the hash table if the element is
     * already inside or not. */
    // éšæœºä¸€ä¸ªå±‚æ•°
    level = zslRandomLevel();
    // å¡«å……è·¨åº¦
    if (level > zsl->level) {
        for (i = zsl->level; i < level; i++) {
            rank[i] = 0;
            update[i] = zsl->header;
            update[i]->level[i].span = zsl->length;
        }
        // æ›´æ–°è·³è·ƒåˆ—è¡¨çš„å±‚é«˜
        zsl->level = level;
    }
    // åˆ›å»ºæ–°èŠ‚ç‚¹
    x = zslCreateNode(level,score,ele);
    // é‡æ’ä¸€ä¸‹å‰å‘æŒ‡é’ˆ
    for (i = 0; i < level; i++) {
        x->level[i].forward = update[i]->level[i].forward;
        update[i]->level[i].forward = x;

        /* update span covered by update[i] as x is inserted here */
        x->level[i].span = update[i]->level[i].span - (rank[0] - rank[i]);
        update[i]->level[i].span = (rank[0] - rank[i]) + 1;
    }

    /* increment span for untouched levels */
    for (i = level; i < zsl->level; i++) {
        update[i]->level[i].span++;
    }
    // é‡æ’ä¸€ä¸‹åå‘æŒ‡é’ˆ
    x->backward = (update[0] == zsl->header) ? NULL : update[0];
    if (x->level[0].forward)
        x->level[0].forward->backward = x;
    else
        zsl->tail = x;
    zsl->length++;
    return x;
}
```

é¦–å…ˆæˆ‘ä»¬åœ¨æœç´¢åˆé€‚æ’å…¥ç‚¹çš„è¿‡ç¨‹ä¸­å°†ã€Œæœç´¢è·¯å¾„ã€æ‘¸å‡ºæ¥äº†ï¼Œç„¶åå°±å¯ä»¥å¼€å§‹åˆ›å»ºæ–°èŠ‚ç‚¹äº†ï¼Œåˆ›å»ºçš„æ—¶å€™éœ€è¦ç»™è¿™ä¸ªèŠ‚ç‚¹éšæœºåˆ†é…ä¸€ä¸ªå±‚æ•°ï¼Œå†å°†æœç´¢è·¯å¾„ä¸Šçš„èŠ‚ç‚¹å’Œè¿™ä¸ªæ–°èŠ‚ç‚¹é€šè¿‡å‰å‘åå‘æŒ‡é’ˆä¸²èµ·æ¥ã€‚å¦‚æœåˆ†é…çš„æ–°èŠ‚ç‚¹çš„é«˜åº¦é«˜äºå½“å‰è·³è·ƒåˆ—è¡¨çš„æœ€å¤§é«˜åº¦ï¼Œå°±éœ€è¦æ›´æ–°ä¸€ä¸‹è·³è·ƒåˆ—è¡¨çš„æœ€å¤§é«˜åº¦ã€‚

## åˆ é™¤è¿‡ç¨‹

åˆ é™¤è¿‡ç¨‹å’Œæ’å…¥è¿‡ç¨‹ç±»ä¼¼ï¼Œéƒ½éœ€å…ˆæŠŠè¿™ä¸ªã€Œæœç´¢è·¯å¾„ã€æ‰¾å‡ºæ¥ã€‚ç„¶åå¯¹äºæ¯ä¸ªå±‚çš„ç›¸å…³èŠ‚ç‚¹éƒ½é‡æ’ä¸€ä¸‹å‰å‘åå‘æŒ‡é’ˆå°±å¯ä»¥äº†ã€‚åŒæ—¶è¿˜è¦æ³¨æ„æ›´æ–°ä¸€ä¸‹æœ€é«˜å±‚æ•°`maxLevel`ã€‚

## æ›´æ–°è¿‡ç¨‹

å½“æˆ‘ä»¬è°ƒç”¨ zadd æ–¹æ³•æ—¶ï¼Œå¦‚æœå¯¹åº”çš„ value ä¸å­˜åœ¨ï¼Œé‚£å°±æ˜¯æ’å…¥è¿‡ç¨‹ã€‚å¦‚æœè¿™ä¸ª value å·²ç»å­˜åœ¨äº†ï¼Œåªæ˜¯è°ƒæ•´ä¸€ä¸‹ score çš„å€¼ï¼Œé‚£å°±éœ€è¦èµ°ä¸€ä¸ªæ›´æ–°çš„æµç¨‹ã€‚å‡è®¾è¿™ä¸ªæ–°çš„ score å€¼ä¸ä¼šå¸¦æ¥æ’åºä½ç½®ä¸Šçš„æ”¹å˜ï¼Œé‚£ä¹ˆå°±ä¸éœ€è¦è°ƒæ•´ä½ç½®ï¼Œç›´æ¥ä¿®æ”¹å…ƒç´ çš„ score å€¼å°±å¯ä»¥äº†ã€‚ä½†æ˜¯å¦‚æœæ’åºä½ç½®æ”¹å˜äº†ï¼Œé‚£å°±è¦è°ƒæ•´ä½ç½®ã€‚é‚£è¯¥å¦‚ä½•è°ƒæ•´ä½ç½®å‘¢ï¼Ÿ

```
/* Remove and re-insert when score changes. */
    if (score != curscore) {
        zskiplistNode *node;
        serverAssert(zslDelete(zs->zsl,curscore,ele,&node));
        znode = zslInsert(zs->zsl,score,node->ele);
        /* We reused the node->ele SDS string, free the node now
        * since zslInsert created a new one. */
        node->ele = NULL;
        zslFreeNode(node);
        /* Note that we did not removed the original element from
        * the hash table representing the sorted set, so we just
        * update the score. */
        dictGetVal(de) = &znode->score; /* Update score ptr. */
        *flags |= ZADD_UPDATED;
        }
    return 1;
```

ä¸€ä¸ªç®€å•çš„ç­–ç•¥å°±æ˜¯å…ˆåˆ é™¤è¿™ä¸ªå…ƒç´ ï¼Œå†æ’å…¥è¿™ä¸ªå…ƒç´ ï¼Œéœ€è¦ç»è¿‡ä¸¤æ¬¡è·¯å¾„æœç´¢ã€‚Redis å°±æ˜¯è¿™ä¹ˆå¹²çš„ã€‚ ä¸è¿‡ Redis é‡åˆ° score å€¼æ”¹å˜äº†å°±ç›´æ¥åˆ é™¤å†æ’å…¥ï¼Œä¸ä¼šå»åˆ¤æ–­ä½ç½®æ˜¯å¦éœ€è¦è°ƒæ•´ï¼Œä»è¿™ç‚¹çœ‹ï¼ŒRedis çš„ zadd çš„ä»£ç ä¼¼ä¹è¿˜æœ‰ä¼˜åŒ–ç©ºé—´ã€‚å…³äºè¿™ä¸€ç‚¹ï¼Œè¯»è€…ä»¬å¯ä»¥ç»§ç»­è®¨è®ºã€‚

## å¦‚æœ score å€¼éƒ½ä¸€æ ·å‘¢ï¼Ÿ

åœ¨ä¸€ä¸ªæç«¯çš„æƒ…å†µä¸‹ï¼Œzset ä¸­æ‰€æœ‰çš„ score å€¼éƒ½æ˜¯ä¸€æ ·çš„ï¼Œzset çš„æŸ¥æ‰¾æ€§èƒ½ä¼šé€€åŒ–ä¸º O(n) ä¹ˆï¼ŸRedis ä½œè€…è‡ªç„¶è€ƒè™‘åˆ°äº†è¿™ä¸€ç‚¹ï¼Œæ‰€ä»¥ zset çš„æ’åºå…ƒç´ ä¸åªçœ‹ score å€¼ï¼Œå¦‚æœ score å€¼ç›¸åŒè¿˜éœ€è¦å†æ¯”è¾ƒ value å€¼ (å­—ç¬¦ä¸²æ¯”è¾ƒ)ã€‚



## å…ƒç´ æ’åæ˜¯æ€ä¹ˆç®—å‡ºæ¥çš„ï¼Ÿ

å‰é¢æˆ‘ä»¬å•°å—¦äº†ä¸€å †ï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªé‡è¦çš„å±æ€§æ²¡æœ‰æåˆ°ï¼Œé‚£å°±æ˜¯ zset å¯ä»¥è·å–å…ƒç´ çš„æ’å rankã€‚é‚£è¿™ä¸ª rank æ˜¯å¦‚ä½•ç®—å‡ºæ¥çš„ï¼Ÿå¦‚æœä»…ä»…ä½¿ç”¨ä¸Šé¢çš„ç»“æ„ï¼Œrank æ˜¯ä¸èƒ½ç®—å‡ºæ¥çš„ã€‚Redis åœ¨ skiplist çš„ forward æŒ‡é’ˆä¸Šè¿›è¡Œäº†ä¼˜åŒ–ï¼Œç»™æ¯ä¸€ä¸ª forward æŒ‡é’ˆéƒ½å¢åŠ äº† span å±æ€§ï¼Œspan æ˜¯ã€Œè·¨åº¦ã€çš„æ„æ€ï¼Œè¡¨ç¤ºä»å½“å‰å±‚çš„å½“å‰èŠ‚ç‚¹æ²¿ç€ forward æŒ‡é’ˆè·³åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸­é—´è·³è¿‡å¤šå°‘ä¸ªèŠ‚ç‚¹ã€‚Redis åœ¨æ’å…¥åˆ é™¤æ“ä½œæ—¶ä¼šå°å¿ƒç¿¼ç¿¼åœ°æ›´æ–° span å€¼çš„å¤§å°ã€‚

```
struct zslforward {
  zslnode* item;
  long span;  // è·¨åº¦
}

struct zslnode {
  String value;
  double score;
  zslforward*[] forwards;  // å¤šå±‚è¿æ¥æŒ‡é’ˆ
  zslnode* backward;  // å›æº¯æŒ‡é’ˆ
}
```

è¿™æ ·å½“æˆ‘ä»¬è¦è®¡ç®—ä¸€ä¸ªå…ƒç´ çš„æ’åæ—¶ï¼Œåªéœ€è¦å°†ã€Œæœç´¢è·¯å¾„ã€ä¸Šçš„ç»è¿‡çš„æ‰€æœ‰èŠ‚ç‚¹çš„è·¨åº¦ span å€¼è¿›è¡Œå åŠ å°±å¯ä»¥ç®—å‡ºå…ƒç´ çš„æœ€ç»ˆ rank å€¼ã€‚





è¿˜è§è¿‡é¢è¯•é—®ï¼šMySQL çš„ Innodb ï¼Œä¸ºä»€ä¹ˆä¸ç”¨ skiplistï¼Œè€Œç”¨ B+ Tree ï¼Ÿ

å¦‚æœæ˜¯ç£ç›˜æ–‡ä»¶ï¼Œb+Tree ä¼šæ¯” skiplist å¥½å¾ˆå¤šã€‚ç£ç›˜æŸ¥è¯¢æ€§èƒ½æ¯”å†…å­˜å·®å¾ˆå¤šï¼Œæ‰€ä»¥å°½é‡å‡å°‘æŸ¥è¯¢çš„æ¬¡æ•°ã€‚
b+ tree æ¯ä¸ªèŠ‚ç‚¹æœ‰å¥½å¤šæ•°æ®ï¼Œæ¯æ¬¡æŸ¥è¯¢å¯ä»¥æŸ¥è¯¢ä¸€æ‰¹æ•°æ®åˆ°å†…å­˜ä¸­ã€‚b+ æ ‘çš„å±‚æ•°ä½ï¼Œå¯ä»¥å‡å°‘è®¿é—®ç£ç›˜çš„æ¬¡æ•°



## å°ç»“

1. å„ç§æœç´¢ç»“æ„æé«˜æ•ˆç‡çš„æ–¹å¼éƒ½æ˜¯é€šè¿‡ç©ºé—´æ¢æ—¶é—´å¾—åˆ°çš„ã€‚
2. è·³è¡¨æœ€ç»ˆå½¢æˆçš„ç»“æ„å’Œæœç´¢æ ‘å¾ˆç›¸ä¼¼ã€‚
3. è·³è¡¨é€šè¿‡éšæœºçš„æ–¹å¼æ¥å†³å®šæ–°æ’å…¥èŠ‚ç‚¹æ¥å†³å®šç´¢å¼•çš„å±‚æ•°ã€‚
4. è·³è¡¨æœç´¢çš„æ—¶é—´å¤æ‚åº¦æ˜¯ $O(logn)$ï¼Œæ’å…¥/åˆ é™¤ä¹Ÿæ˜¯ã€‚

æƒ³åˆ°å¿«æ’(quick sort)ä¸å…¶å®ƒæ’åºç®—æ³•ï¼ˆå¦‚å½’å¹¶æ’åº/å †æ’åºï¼‰è™½ç„¶æ—¶é—´å¤æ‚åº¦æ˜¯ä¸€æ ·çš„ï¼Œä½†å¤æ‚åº¦çš„å¸¸æ•°é¡¹è¾ƒå°ï¼›è·³è¡¨çš„åŸè®ºæ–‡ä¹Ÿè¯´è·³è¡¨èƒ½æä¾›ä¸€ä¸ªå¸¸æ•°é¡¹çš„é€Ÿåº¦æå‡ï¼Œå› æ­¤æƒ³ç€å¸¸æ•°é¡¹å°æ˜¯ä¸æ˜¯éšæœºç®—æ³•çš„ä¸€ä¸ªç‰¹ç‚¹ï¼Ÿè¿™ä¹Ÿå®ƒä»¬å¤§æ”¾å¼‚å½©çš„é‡è¦å› ç´ å§ã€‚



è·³è¡¨ä½¿ç”¨ç©ºé—´æ¢æ—¶é—´çš„è®¾è®¡æ€è·¯ï¼Œé€šè¿‡æ„å»ºå¤šçº§ç´¢å¼•æ¥æé«˜æŸ¥è¯¢çš„æ•ˆç‡ï¼Œå®ç°äº†åŸºäºé“¾è¡¨çš„â€œäºŒåˆ†æŸ¥æ‰¾â€ã€‚è·³è¡¨æ˜¯ä¸€ç§åŠ¨æ€æ•°æ®ç»“æ„ï¼Œæ”¯æŒå¿«é€Ÿåœ°æ’å…¥ã€åˆ é™¤ã€æŸ¥æ‰¾æ“ä½œï¼Œæ—¶é—´å¤æ‚åº¦éƒ½æ˜¯ O(logn)ã€‚



> æ¥æºï¼šhttps://lotabout.me/2018/skip-list/



![](https://i02piccdn.sogoucdn.com/06eb28fd58fa8840)

## å‚è€ƒ

- [ftp://ftp.cs.umd.edu/pub/skipLists/skiplists.pdf](ftp://ftp.cs.umd.edu/pub/skipLists/skiplists.pdf) åŸè®ºæ–‡
- https://ticki.github.io/blog/skip-lists-done-right/ skip list çš„ä¸€äº›å˜ç§ã€ä¼˜åŒ–
- https://eugene-eeo.github.io/blog/skip-lists.html skip list çš„ä¸€äº›ç›¸å…³å¤æ‚åº¦åˆ†æ
- http://cglab.ca/~morin/teaching/5408/refs/p90b.pdf skip list cookbookï¼Œç®—æ˜¯ skip list å„æ–¹é¢çš„æ±‡æ€»
- [ä¸€ä¸ªå¯ä»¥åœ¨æœ‰åºå…ƒç´ ä¸­å®ç°å¿«é€ŸæŸ¥è¯¢çš„æ•°æ®ç»“æ„](https://juejin.im/entry/59b0eed46fb9a0249471f357) åŒ…å« skip list çš„ C++ å®ç°
- [Rediså†…éƒ¨æ•°æ®ç»“æ„è¯¦è§£(6)â€”â€”skiplist](http://zhangtielei.com/posts/blog-redis-skiplist.html) å›¾æ–‡å¹¶èŒ‚è®²è§£ skip listï¼Œå¯ä¸æœ¬æ–‡äº¤å‰å¯¹ç…§
- https://www.youtube.com/watch?v=2g9OSRKJuzM MIT å…³äº skip list çš„è¯¾ç¨‹
- https://courses.csail.mit.edu/6.046/spring04/handouts/skiplists.pdf MIT è¯¾ç¨‹è®²ä¹‰