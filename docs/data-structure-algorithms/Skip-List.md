# è·³è¡¨

![](https://tva1.sinaimg.cn/large/008i3skNly1grm8yuyywxj30zk0qomyg.jpg)

> Redis æ˜¯æ€ä¹ˆæƒ³çš„ï¼šç”¨è·³è¡¨æ¥å®ç°æœ‰åºé›†åˆï¼Ÿ
>

å¹²è¿‡æœåŠ¡ç«¯å¼€å‘çš„åº”è¯¥éƒ½çŸ¥é“ Redis çš„ ZSet ä½¿ç”¨è·³è¡¨å®ç°çš„ï¼ˆå½“ç„¶è¿˜æœ‰å‹ç¼©åˆ—è¡¨ã€å“ˆå¸Œè¡¨ï¼‰ï¼Œæˆ‘å°±ä¸ä» 1990 å¹´çš„é‚£ä¸ªç¾å›½å¤§ä½¬ William Pugh å‘è¡¨çš„é‚£ç¯‡è®ºæ–‡å¼€å§‹äº†ï¼Œç›´æ¥å¼€è·³

![é©¬é‡Œå¥¥](https://i03piccdn.sogoucdn.com/bbdcce2d04b2bd83)

æ–‡ç« æ‹¢å…±ä¸¤éƒ¨åˆ†

- è·³è¡¨æ˜¯æ€ä¹ˆæçš„
- Redis æ˜¯æ€ä¹ˆæƒ³çš„



## ä¸€ã€è·³è¡¨

### è·³è¡¨çš„ç®€å†

![](https://cdn.jsdelivr.net/gh/Jstarfish/picBed/datastrucutre/skiplist-resume.png)

è·³è¡¨ï¼Œè‹±æ–‡åï¼šSkip List

çˆ¶äº²ï¼šä»è‹±æ–‡åå¯ä»¥çœ‹å‡ºæ¥ï¼Œå®ƒé¦–å…ˆæ˜¯ä¸ª Listï¼Œå®é™…ä¸Šï¼Œå®ƒæ˜¯åœ¨æœ‰åºé“¾è¡¨çš„åŸºç¡€ä¸Šå‘å±•èµ·æ¥çš„

ç«äº‰å¯¹æ‰‹ï¼šè·³è¡¨ï¼ˆskip listï¼‰å¯¹æ ‡çš„æ˜¯å¹³è¡¡æ ‘ï¼ˆAVL Treeï¼‰

ä¼˜ç‚¹ï¼šæ˜¯ä¸€ç§ æ’å…¥/åˆ é™¤/æœç´¢ éƒ½æ˜¯ $O(logn)$ çš„æ•°æ®ç»“æ„ã€‚å®ƒæœ€å¤§çš„ä¼˜åŠ¿æ˜¯åŸç†ç®€å•ã€å®¹æ˜“å®ç°ã€æ–¹ä¾¿æ‰©å±•ã€æ•ˆç‡æ›´é«˜



### è·³è¡¨çš„åŸºæœ¬æ€æƒ³

ä¸€å¦‚å¾€å¸¸ï¼Œé‡‡ç”¨å¾ªåºæ¸è¿›çš„æ‰‹æ³•å¸¦ä½ çª¥æ¢ William Pugh çš„å°å¿ƒæ€~

å‰æï¼šè·³è¡¨å¤„ç†çš„æ˜¯æœ‰åºçš„é“¾è¡¨ï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆçœ‹ä¸ªä¸èƒ½å†æ™®é€šäº†çš„æœ‰åºåˆ—è¡¨ï¼ˆä¸€èˆ¬æ˜¯åŒå‘é“¾è¡¨ï¼‰

![](https://cdn.jsdelivr.net/gh/Jstarfish/picBed/datastrucutre/linkedlist.png)

å¦‚æœæˆ‘ä»¬æƒ³æŸ¥æ‰¾æŸä¸ªæ•°ï¼Œåªèƒ½éå†é“¾è¡¨é€ä¸ªæ¯”å¯¹ï¼Œæ—¶é—´å¤æ‚åº¦ $O(n)$ï¼Œæ’å…¥å’Œåˆ é™¤æ“ä½œéƒ½ä¸€æ ·ã€‚

ä¸ºäº†æé«˜æŸ¥æ‰¾æ•ˆç‡ï¼Œæˆ‘ä»¬å¯¹é“¾è¡¨åšä¸ªâ€ç´¢å¼•â€œ

![](https://cdn.jsdelivr.net/gh/Jstarfish/picBed/datastrucutre/skip-index.png)

åƒè¿™æ ·ï¼Œæˆ‘ä»¬æ¯éš”ä¸€ä¸ªèŠ‚ç‚¹å–ä¸€ä¸ªæ•°æ®ä½œä¸ºç´¢å¼•èŠ‚ç‚¹ï¼ˆæˆ–è€…å¢åŠ ä¸€ä¸ªæŒ‡é’ˆï¼‰ï¼Œæ¯”å¦‚æˆ‘ä»¬è¦æ‰¾ 31 ç›´æ¥åœ¨ç´¢å¼•é“¾è¡¨å°±æ‰¾åˆ°äº†ï¼ˆéå† 3 æ¬¡ï¼‰ï¼Œå¦‚æœæ‰¾ 16 çš„è¯ï¼Œåœ¨éå†åˆ° 31çš„æ—¶å€™ï¼Œå‘ç°å¤§äºç›®æ ‡èŠ‚ç‚¹ï¼Œå°±è·³åˆ°ä¸‹ä¸€å±‚ï¼Œæ¥ç€éå†~ (è“çº¿è¡¨ç¤ºæœç´¢è·¯å¾„)

> æ©ï¼Œå¦‚æœä½ æ•°äº†ä¸‹éå†æ¬¡æ•°ï¼Œæ²¡é”™ï¼ŒåŠ ä¸åŠ ç´¢å¼•éƒ½æ˜¯ 4 æ¬¡éå†æ‰èƒ½æ‰¾åˆ° 16ï¼Œè¿™æ˜¯å› ä¸ºæ•°æ®é‡å¤ªå°‘ï¼Œ
>
> æ•°æ®é‡å¤šçš„è¯ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å¤šå»ºå‡ å±‚ç´¢å¼•ï¼Œå¦‚ä¸‹ 4 å±‚ç´¢å¼•ï¼Œæ•ˆæœå°±æ¯”è¾ƒæ˜æ˜¾äº†

![](https://cdn.jsdelivr.net/gh/Jstarfish/picBed/datastrucutre/skiplist.png)

æ¯åŠ ä¸€å±‚ç´¢å¼•ï¼Œæˆ‘ä»¬æœç´¢çš„æ—¶é—´å¤æ‚åº¦å°±é™ä¸ºåŸæ¥çš„ $O(n/2)$

åŠ äº†å‡ å±‚ç´¢å¼•ï¼ŒæŸ¥æ‰¾ä¸€ä¸ªèŠ‚ç‚¹éœ€è¦éå†çš„èŠ‚ç‚¹ä¸ªæ•°æ˜çº¿å‡å°‘äº†ï¼Œæ•ˆç‡æé«˜ä¸å°‘ï¼Œbingo~

æœ‰æ²¡æœ‰ä¼¼æ›¾ç›¸è¯†çš„æ„Ÿè§‰ï¼Œåƒä¸åƒäºŒåˆ†æŸ¥æ‰¾æˆ–è€…äºŒå‰æœç´¢æ ‘ï¼Œé€šè¿‡ç´¢å¼•æ¥è·³è¿‡å¤§é‡çš„èŠ‚ç‚¹ï¼Œä»è€Œæé«˜æœç´¢æ•ˆç‡ã€‚

è¿™æ ·çš„å¤šå±‚é“¾è¡¨ç»“æ„ï¼Œå°±æ˜¯ã€**è·³è¡¨**ã€äº†~~



**é‚£åˆ°åº•æé«˜äº†å¤šå°‘å‘¢ï¼Ÿ**

æ¨ç†ä¸€ç•ªï¼š

1. å¦‚æœä¸€ä¸ªé“¾è¡¨æœ‰ n ä¸ªç»“ç‚¹ï¼Œå¦‚æœæ¯ä¸¤ä¸ªç»“ç‚¹æŠ½å–å‡ºä¸€ä¸ªç»“ç‚¹å»ºç«‹ç´¢å¼•çš„è¯ï¼Œé‚£ä¹ˆç¬¬ä¸€çº§ç´¢å¼•çš„ç»“ç‚¹æ•°å¤§çº¦å°±æ˜¯ n/2ï¼Œç¬¬äºŒçº§ç´¢å¼•çš„ç»“ç‚¹æ•°å¤§çº¦ä¸º n/4ï¼Œä»¥æ­¤ç±»æ¨ç¬¬ m çº§ç´¢å¼•çš„èŠ‚ç‚¹æ•°å¤§çº¦ä¸º $n/(2^m)$ã€‚

2. å‡å¦‚ä¸€å…±æœ‰ m çº§ç´¢å¼•ï¼Œç¬¬ m çº§çš„ç»“ç‚¹æ•°ä¸ºä¸¤ä¸ªï¼Œé€šè¿‡ä¸Šè¾¹æˆ‘ä»¬æ‰¾åˆ°çš„è§„å¾‹ï¼Œé‚£ä¹ˆå¾—å‡º $n/(2^m)=2$ï¼Œä»è€Œæ±‚å¾— m=$log(n)$-1ã€‚å¦‚æœåŠ ä¸ŠåŸå§‹é“¾è¡¨ï¼Œé‚£ä¹ˆæ•´ä¸ªè·³è¡¨çš„é«˜åº¦å°±æ˜¯ $log(n)$ã€‚

3. æˆ‘ä»¬åœ¨æŸ¥è¯¢è·³è¡¨çš„æ—¶å€™ï¼Œå¦‚æœæ¯ä¸€å±‚éƒ½éœ€è¦éå† k ä¸ªç»“ç‚¹ï¼Œé‚£ä¹ˆæœ€ç»ˆçš„æ—¶é—´å¤æ‚åº¦å°±ä¸º $O(k*log(n))$ã€‚

4. é‚£è¿™ä¸ª k å€¼ä¸ºå¤šå°‘å‘¢ï¼ŒæŒ‰ç…§æˆ‘ä»¬æ¯ä¸¤ä¸ªç»“ç‚¹æå–ä¸€ä¸ªåŸºç‚¹å»ºç«‹ç´¢å¼•çš„æƒ…å†µï¼Œæˆ‘ä»¬æ¯ä¸€çº§æœ€å¤šéœ€è¦éå†ä¸¤ä¸ªèŠ‚ç‚¹ï¼Œæ‰€ä»¥ k=2ã€‚

   > ä¸ºä»€ä¹ˆæ¯ä¸€å±‚æœ€å¤šéå†ä¸¤ä¸ªç»“ç‚¹å‘¢ï¼Ÿ
   >
   > å› ä¸ºæˆ‘ä»¬æ˜¯æ¯ä¸¤ä¸ªèŠ‚ç‚¹æå–ä¸€ä¸ªèŠ‚ç‚¹å»ºç«‹ç´¢å¼•ï¼Œæœ€é«˜ä¸€çº§ç´¢å¼•åªæœ‰ä¸¤ä¸ªèŠ‚ç‚¹ï¼Œç„¶åä¸‹ä¸€å±‚ç´¢å¼•æ¯”ä¸Šä¸€å±‚ç´¢å¼•ä¸¤ä¸ªç»“ç‚¹ä¹‹é—´å¢åŠ äº†ä¸€ä¸ªç»“ç‚¹ï¼Œä¹Ÿå°±æ˜¯ä¸Šä¸€å±‚ç´¢å¼•ä¸¤ç»“ç‚¹çš„ä¸­å€¼ï¼Œçœ‹åˆ°è¿™é‡Œæ˜¯ä¸æ˜¯æƒ³èµ·äº†äºŒåˆ†æŸ¥æ‰¾ï¼Œæ¯æ¬¡æˆ‘ä»¬åªéœ€è¦åˆ¤æ–­è¦æ‰¾çš„å€¼åœ¨ä¸åœ¨å½“å‰èŠ‚ç‚¹å’Œä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¹‹é—´å°±å¯ä»¥äº†ã€‚
   >
   > ä¸ä¿¡ï¼Œä½ ç…§ç€ä¸‹å›¾æ¯”åˆ’æ¯”åˆ’ï¼Œçœ‹çœ‹åŒä¸€å±‚èƒ½ç”»å‡º 3 æ¡çº¿ä¸~~
   >
   > ![](https://cdn.jsdelivr.net/gh/Jstarfish/picBed/datastrucutre/skiplist-index-count.png)

5. æ—¢ç„¶çŸ¥é“äº†æ¯ä¸€å±‚æœ€å¤šéå†ä¸¤ä¸ªèŠ‚ç‚¹ï¼Œé‚£è·³è¡¨æŸ¥è¯¢æ•°æ®çš„æ—¶é—´å¤æ‚åº¦å°±æ˜¯ $O(2*log(n))$ï¼Œå¸¸æ•° 2 å¿½ç•¥ä¸è®¡ï¼Œå°±æ˜¯ $O(logn)$ äº†ã€‚



**ç©ºé—´æ¢æ—¶é—´**

è·³è¡¨çš„æ•ˆç‡æ¯”é“¾è¡¨é«˜äº†ï¼Œä½†æ˜¯è·³è¡¨éœ€è¦é¢å¤–å­˜å‚¨å¤šçº§ç´¢å¼•ï¼Œæ‰€ä»¥éœ€è¦æ›´å¤šçš„å†…å­˜ç©ºé—´ã€‚

è·³è¡¨çš„ç©ºé—´å¤æ‚åº¦åˆ†æå¹¶ä¸éš¾ï¼Œå¦‚æœä¸€ä¸ªé“¾è¡¨æœ‰ n ä¸ªèŠ‚ç‚¹ï¼Œæ¯ä¸¤ä¸ªèŠ‚ç‚¹æŠ½å–å‡ºä¸€ä¸ªèŠ‚ç‚¹å»ºç«‹ç´¢å¼•çš„è¯ï¼Œé‚£ä¹ˆç¬¬ä¸€çº§ç´¢å¼•çš„èŠ‚ç‚¹æ•°å¤§çº¦å°±æ˜¯ n/2ï¼Œç¬¬äºŒçº§ç´¢å¼•çš„èŠ‚ç‚¹æ•°å¤§çº¦ä¸º n/4ï¼Œä»¥æ­¤ç±»æ¨ç¬¬ m çº§ç´¢å¼•çš„èŠ‚ç‚¹æ•°å¤§çº¦ä¸º $n/(2^m)$ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºæ¥è¿™æ˜¯ä¸€ä¸ªç­‰æ¯”æ•°åˆ—ã€‚

è¿™å‡ çº§ç´¢å¼•çš„ç»“ç‚¹æ€»å’Œå°±æ˜¯ n/2+n/4+n/8â€¦+8+4+2=n-2ï¼Œæ‰€ä»¥è·³è¡¨çš„ç©ºé—´å¤æ‚åº¦ä¸º  $O(n)$ã€‚

> å®é™…ä¸Šï¼Œåœ¨è½¯ä»¶å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ä¸å¿…å¤ªåœ¨æ„ç´¢å¼•å ç”¨çš„é¢å¤–ç©ºé—´ã€‚åœ¨è®²æ•°æ®ç»“æ„å’Œç®—æ³•æ—¶ï¼Œæˆ‘ä»¬ä¹ æƒ¯æ€§åœ°æŠŠè¦å¤„ç†çš„æ•°æ®çœ‹æˆæ•´æ•°ï¼Œä½†æ˜¯åœ¨å®é™…çš„è½¯ä»¶å¼€å‘ä¸­ï¼ŒåŸå§‹é“¾è¡¨ä¸­å­˜å‚¨çš„æœ‰å¯èƒ½æ˜¯å¾ˆå¤§çš„å¯¹è±¡ï¼Œè€Œç´¢å¼•ç»“ç‚¹åªéœ€è¦å­˜å‚¨å…³é”®å€¼å’Œå‡ ä¸ªæŒ‡é’ˆï¼Œå¹¶ä¸éœ€è¦å­˜å‚¨å¯¹è±¡ï¼Œæ‰€ä»¥å½“å¯¹è±¡æ¯”ç´¢å¼•ç»“ç‚¹å¤§å¾ˆå¤šæ—¶ï¼Œé‚£ç´¢å¼•å ç”¨çš„é¢å¤–ç©ºé—´å°±å¯ä»¥å¿½ç•¥äº†ã€‚



#### æ’å…¥æ•°æ®

å…¶å®æ’å…¥æ•°æ®å’ŒæŸ¥æ‰¾ä¸€æ ·ï¼Œå…ˆæ‰¾åˆ°å…ƒç´ è¦æ’å…¥çš„ä½ç½®ï¼Œæ—¶é—´å¤æ‚åº¦ä¹Ÿæ˜¯ $O(logn)$ï¼Œä½†æœ‰ä¸ªé—®é¢˜å°±æ˜¯å¦‚æœä¸€ç›´å¾€åŸå§‹åˆ—è¡¨é‡ŒåŠ æ•°æ®ï¼Œä¸æ›´æ–°æˆ‘ä»¬çš„ç´¢å¼•å±‚ï¼Œæç«¯æƒ…å†µä¸‹å°±ä¼šå‡ºç°ä¸¤ä¸ªç´¢å¼•èŠ‚ç‚¹ä¸­é—´æ•°æ®éå¸¸å¤šï¼Œç›¸å½“äºé€€åŒ–æˆäº†å•é“¾è¡¨ï¼ŒæŸ¥æ‰¾æ•ˆç‡ç›´æ¥å˜æˆ $O(n)$

![](https://cdn.jsdelivr.net/gh/Jstarfish/picBed/datastrucutre/skiplist-insert.png)



#### è·³è¡¨ç´¢å¼•åŠ¨æ€æ›´æ–°

æˆ‘ä»¬ä¸Šè¾¹å»ºç«‹ç´¢å¼•å±‚éƒ½æ˜¯ä¸‹å±‚èŠ‚ç‚¹ä¸ªæ•°çš„ 1/2ï¼Œæœ€é«˜å±‚ç´¢å¼•çš„èŠ‚ç‚¹æ•°å°±æ˜¯ 2 ä¸ªï¼Œä½†æ˜¯æˆ‘ä»¬éšæ„æ’å…¥æˆ–è€…åˆ é™¤ä¸€ä¸ªåŸæœ‰é“¾è¡¨çš„èŠ‚ç‚¹ï¼Œè¿™ä¸ªæ¯”ä¾‹å°±è‚¯å®šä¼šè¢«ç ´åã€‚

ä½œä¸ºä¸€ç§åŠ¨æ€æ•°æ®ç»“æ„ï¼Œæˆ‘ä»¬éœ€è¦æŸç§æ‰‹æ®µæ¥ç»´æŠ¤ç´¢å¼•ä¸åŸå§‹é“¾è¡¨å¤§å°ä¹‹é—´çš„å¹³è¡¡ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœé“¾è¡¨ä¸­èŠ‚ç‚¹å¤šäº†ï¼Œç´¢å¼•èŠ‚ç‚¹å°±ç›¸åº”åœ°å¢åŠ ä¸€äº›ï¼Œé¿å…å¤æ‚åº¦é€€åŒ–ã€‚

å¦‚æœé‡å»ºç´¢å¼•çš„è¯ï¼Œæ•ˆç‡å°±ä¸èƒ½ä¿è¯äº†ã€‚

> å¦‚æœä½ äº†è§£çº¢é»‘æ ‘ã€AVL æ ‘è¿™æ ·å¹³è¡¡äºŒå‰æ ‘ï¼Œä½ å°±çŸ¥é“å®ƒä»¬æ˜¯é€šè¿‡å·¦å³æ—‹çš„æ–¹å¼ä¿æŒå·¦å³å­æ ‘çš„å¤§å°å¹³è¡¡ï¼Œè€Œè·³è¡¨æ˜¯é€šè¿‡éšæœºå‡½æ•°æ¥ç»´æŠ¤å‰é¢æåˆ°çš„â€œå¹³è¡¡æ€§â€ã€‚

æ‰€ä»¥è·³è¡¨ï¼ˆskip listï¼‰ç´¢æ€§å°±ä¸å¼ºåˆ¶è¦æ±‚ `1:2` äº†ï¼Œä¸€ä¸ªèŠ‚ç‚¹è¦ä¸è¦è¢«ç´¢å¼•ï¼Œå»ºå‡ å±‚çš„ç´¢å¼•ï¼Œå°±éšæ„ç‚¹å§ï¼Œéƒ½åœ¨èŠ‚ç‚¹æ’å…¥æ—¶ç”±æŠ›ç¡¬å¸å†³å®šã€‚

æ¯”å¦‚æˆ‘ä»¬è¦æ’å…¥æ–°èŠ‚ç‚¹ Xï¼Œé‚£è¦ä¸è¦ä¸º X å‘ä¸Šå»ºç´¢å¼•å‘¢ï¼Œå°±æ˜¯æŠ›ç¡¬å¸å†³å®šçš„ï¼Œæ­£é¢çš„è¯å»ºç´¢å¼•ï¼Œå¦åˆ™å°±ä¸å»ºäº†ï¼Œå°±æ˜¯è¿™ä¹ˆéšæ„ï¼ˆæ¯”å¦‚ä¸€ä¸ªèŠ‚ç‚¹éšæœºå‡ºçš„å±‚æ•°æ˜¯ 3ï¼Œé‚£å°±æŠŠå®ƒé“¾å…¥åˆ°ç¬¬1 å±‚åˆ°ç¬¬ 3 å±‚é“¾è¡¨ä¸­ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬é™¤äº†åŸé“¾è¡¨çš„ä¹‹å¤–å†å¾€ä¸Š 2 å±‚ç´¢å¼•éƒ½åŠ ä¸Šï¼‰ã€‚

![](https://cdn.jsdelivr.net/gh/Jstarfish/picBed/datastrucutre/20210626125654.gif)

å…¶å®æ˜¯å› ä¸ºæˆ‘ä»¬ä¸èƒ½é¢„æµ‹è·³è¡¨çš„æ·»åŠ å’Œåˆ é™¤æ“ä½œï¼Œå¾ˆéš¾ç”¨ä¸€ç§æœ‰æ•ˆçš„ç®—æ³•ä¿è¯ç´¢å¼•éƒ¨åˆ†å§‹ç»ˆå‡åŒ€ã€‚å­¦è¿‡æ¦‚ç‡è®ºçš„æˆ‘ä»¬éƒ½çŸ¥é“æŠ›ç¡¬å¸è™½ç„¶ä¸èƒ½è®©ç´¢å¼•ä½ç½®ç»å¯¹å‡åŒ€ï¼Œå½“æ•°é‡è¶³å¤Ÿå¤šçš„æ—¶å€™æœ€èµ·ç å¯ä»¥ä¿è¯å¤§ä½“ä¸Šç›¸å¯¹å‡åŒ€ã€‚

åˆ é™¤èŠ‚ç‚¹ç›¸å¯¹æ¥è¯´å°±å®¹æ˜“å¾ˆå¤šäº†ï¼Œåœ¨ç´¢å¼•å±‚æ‰¾åˆ°èŠ‚ç‚¹çš„è¯ï¼Œå°±é¡ºè—¤æ‘¸ç“œé€ä¸ªå¾€ä¸‹åˆ é™¤è¯¥ç´¢å¼•èŠ‚ç‚¹å’ŒåŸé“¾è¡¨ä¸Šçš„èŠ‚ç‚¹ï¼Œå¦‚æœå“ªä¸€å±‚ç´¢å¼•èŠ‚ç‚¹è¢«åˆ çš„å°±å‰© 1 ä¸ªèŠ‚ç‚¹çš„è¯ï¼Œç›´æ¥æŠŠè¿™ä¸€å±‚ææ‰å°±å¯ä»¥äº†ã€‚



å…¶å®è·³è¡¨çš„æ€æƒ³å¾ˆå®¹æ˜“ç†è§£ï¼Œå¯æ˜¯æ¶ä¸ä½å®æˆ˜ï¼Œæˆ‘ä»¬æ¥ç€çœ‹å®æˆ˜

### è·³è¡¨çš„å®ç°

å·®ä¸å¤šäº†è§£äº†è·³è¡¨ï¼Œå…¶å®å°±æ˜¯åŠ äº†å‡ å±‚ç´¢å¼•çš„é“¾è¡¨ï¼Œä¸€å…±æœ‰ N å±‚ï¼Œä»¥ 0 ~ N å±‚è¡¨ç¤ºï¼Œè®¾ç¬¬ 0 å±‚æ˜¯åŸé“¾è¡¨ï¼ŒæŠ½å–å…¶ä¸­éƒ¨åˆ†å…ƒç´ ï¼Œåœ¨ç¬¬ 1 å±‚å½¢æˆæ–°çš„é“¾è¡¨ï¼Œä¸Šä¸‹å±‚çš„ç›¸åŒå…ƒç´ ä¹‹é—´è¿èµ·æ¥ï¼›å†æŠ½å–ç¬¬ 1 å±‚éƒ¨åˆ†å…ƒç´ ï¼Œæ„æˆç¬¬ 2 å±‚ï¼Œä»¥æ­¤ç±»æ¨ã€‚

Leetcode çš„é¢˜ç›®ï¼šè®¾è®¡è·³è¡¨ï¼ˆhttps://leetcode-cn.com/problems/design-skiplist/ï¼‰

æ—¢ç„¶æ˜¯é“¾è¡¨ç»“æ„ï¼Œå…ˆæä¸ª Node

```java
class Node{
    Integer value; //èŠ‚ç‚¹å€¼
    Node[] next; // èŠ‚ç‚¹åœ¨ä¸åŒå±‚çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹

    public Node(Integer value,int size) { // ç”¨sizeè¡¨ç¤ºå½“å‰èŠ‚ç‚¹åœ¨è·³è¡¨ä¸­ç´¢å¼•å‡ å±‚
        this.value = value;
        this.next = new Node[size];
    }
}
```

å¢åˆ æ”¹æŸ¥æ¥ä¸€å¥—ï¼Œå…ˆçœ‹ä¸‹å¢åŠ èŠ‚ç‚¹ï¼Œä¸Šè¾¹æˆ‘ä»¬å·²ç»çŸ¥é“äº†ï¼Œæ–°å¢æ—¶å€™ä¼šéšæœºç”Ÿæˆä¸€ä¸ªå±‚æ•°ï¼Œçœ‹ä¸‹ç½‘ä¸Šå¤§ä½¬çš„è§£é‡Š

> æ‰§è¡Œæ’å…¥æ“ä½œæ—¶è®¡ç®—éšæœºæ•°çš„è¿‡ç¨‹ï¼Œæ˜¯ä¸€ä¸ªå¾ˆå…³é”®çš„è¿‡ç¨‹ï¼Œå®ƒå¯¹ skiplist çš„ç»Ÿè®¡ç‰¹æ€§æœ‰ç€å¾ˆé‡è¦çš„å½±å“ã€‚è¿™å¹¶ä¸æ˜¯ä¸€ä¸ªæ™®é€šçš„æœä»å‡åŒ€åˆ†å¸ƒçš„éšæœºæ•°ï¼Œå®ƒçš„è®¡ç®—è¿‡ç¨‹å¦‚ä¸‹ï¼š
>
> - é¦–å…ˆï¼Œæ¯ä¸ªèŠ‚ç‚¹è‚¯å®šéƒ½æœ‰ç¬¬ 1 å±‚æŒ‡é’ˆï¼ˆæ¯ä¸ªèŠ‚ç‚¹éƒ½åœ¨ç¬¬ 1 å±‚é“¾è¡¨é‡Œï¼‰ã€‚
> - å¦‚æœä¸€ä¸ªèŠ‚ç‚¹æœ‰ç¬¬ i å±‚(i>=1)æŒ‡é’ˆï¼ˆå³èŠ‚ç‚¹å·²ç»åœ¨ç¬¬ 1 å±‚åˆ°ç¬¬ i å±‚é“¾è¡¨ä¸­ï¼‰ï¼Œé‚£ä¹ˆå®ƒæœ‰ç¬¬(i+1)å±‚æŒ‡é’ˆçš„æ¦‚ç‡ä¸º pã€‚
> - èŠ‚ç‚¹æœ€å¤§çš„å±‚æ•°ä¸å…è®¸è¶…è¿‡ä¸€ä¸ªæœ€å¤§å€¼ï¼Œè®°ä¸º MaxLevelã€‚
>
> è¿™ä¸ªè®¡ç®—éšæœºå±‚æ•°çš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š
>
> ```java
> int randomLevel()
>     int level = 1;
>     while (Math.random()<p && level<MaxLevel){
>         level ++ ;
>     }
>     return level;
> ```
>
> `randomLevel()` åŒ…å«ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯ pï¼Œä¸€ä¸ªæ˜¯ MaxLevelã€‚åœ¨ Redis çš„ skiplist å®ç°ä¸­ï¼Œè¿™ä¸¤ä¸ªå‚æ•°çš„å–å€¼ä¸ºï¼š
>
> ```
> p = 1/4
> MaxLevel = 32(5.0ç‰ˆæœ¬ä»¥åæ˜¯64)
> ```

æ‰€ä»¥æˆ‘ä»¬å’Œ Redis ä¸€æ ·çš„è®¾ç½®

```java
/**
 * æœ€å¤§å±‚æ•°
 */
private static int DEFAULT_MAX_LEVEL = 32;

/**
 * éšæœºå±‚æ•°æ¦‚ç‡ï¼Œä¹Ÿå°±æ˜¯éšæœºå‡ºçš„å±‚æ•°ï¼Œåœ¨ ç¬¬1å±‚ä»¥ä¸Š(ä¸åŒ…æ‹¬ç¬¬ä¸€å±‚)çš„æ¦‚ç‡ï¼Œå±‚æ•°ä¸è¶…è¿‡maxLevelï¼Œå±‚æ•°çš„èµ·å§‹å·ä¸º1
 */
private static double DEFAULT_P_FACTOR = 0.25;

/**
 * å¤´èŠ‚ç‚¹
 */
Node head = new Node(null, DEFAULT_MAX_LEVEL); 

/**
 * è¡¨ç¤ºå½“å‰nodesçš„å®é™…å±‚æ•°ï¼Œå®ƒä»1å¼€å§‹
 */
int currentLevel = 1; 
```

#### å¢

æˆ‘è§‰å¾—æˆ‘å†™çš„æ³¨é‡Šè¿˜æŒºé€šä¿—æ˜“æ‡‚çš„ï¼ˆä»£ç å‚è€ƒäº† leetcode å’Œ ç‹äº‰è€å¸ˆçš„å®ç°ï¼‰

```java
public void add(int num) {
  int level = randomLevel();
  Node newNode = new Node(num,level);

  Node updateNode = head;

  // è®¡ç®—å‡ºå½“å‰num ç´¢å¼•çš„å®é™…å±‚æ•°ï¼Œä»è¯¥å±‚å¼€å§‹æ·»åŠ ç´¢å¼•ï¼Œé€æ­¥å‘ä¸‹
  for (int i = currentLevel-1; i>=0; i--) {
    //æ‰¾åˆ°æœ¬å±‚æœ€è¿‘ç¦»numæœ€è¿‘çš„èŠ‚ç‚¹(åˆšå¥½æ¯”å®ƒå°çš„èŠ‚ç‚¹)
    while ((updateNode.next[i])!=null && updateNode.next[i].value < num){
      updateNode = updateNode.next[i];
    }
    //æœ¬æ¬¡éšæœºçš„æœ€é«˜å±‚æ‰è®¾å€¼ï¼Œå¦‚æœæ˜¯æœ€åä¸€ä¸ªç›´æ¥æŒ‡å‘newNode,å¦åˆ™å°†newNode é“¾å…¥é“¾è¡¨
    if (i<level){
      if (updateNode.next[i]==null){
        updateNode.next[i] = newNode;
      }else{
        Node temp = updateNode.next[i];
        updateNode.next[i] = newNode;
        newNode.next[i] = temp;
      }
    }
  }
  //å¦‚æœéšæœºå‡ºæ¥çš„å±‚æ•°æ¯”å½“å‰çš„å±‚æ•°è¿˜å¤§ï¼Œé‚£ä¹ˆè¶…è¿‡currentLevelçš„head ç›´æ¥æŒ‡å‘newNode
  if (level > currentLevel){
    for (int i = currentLevel; i < level; i++) {
      head.next[i] = newNode;
    }
    //æ›´æ–°å±‚æ•°
    currentLevel = level;
  }
}
```

#### åˆ 

```java
public boolean erase(int num) {
  boolean flag = false;
  Node searchNode = head;
  //ä»æœ€é«˜å±‚å¼€å§‹éå†æ‰¾
  for (int i = currentLevel-1; i >=0; i--) {
    //å’Œæ–°å¢ä¸€æ ·ä¹Ÿéœ€è¦æ‰¾åˆ°ç¦»è¦åˆ é™¤èŠ‚ç‚¹æœ€è¿‘çš„è¾£ä¸ª
    while ((searchNode.next[i])!=null && searchNode.next[i].value < num){
      searchNode = searchNode.next[i];
    }
    //å¦‚æœæœ‰è¿™æ ·çš„æ•°å€¼
    if (searchNode.next[i]!=null && searchNode.next[i].value == num){
      //æ‰¾åˆ°è¯¥å±‚ä¸­è¯¥èŠ‚ç‚¹ï¼ŒæŠŠä¸‹ä¸€ä¸ªèŠ‚ç‚¹è¿‡æ¥ï¼Œå°±åˆ é™¤äº†
      searchNode.next[i] = searchNode.next[i].next[i];
      flag = true;
    }
  }
  return flag;
}
```

#### æŸ¥

```java
public Node search(int target) {
  Node searchNode = head;
  for (int i = currentLevel - 1; i >= 0; i--) {
    while ((head.next[i]) != null && searchNode.next[i].value < target) {
      searchNode = searchNode.next[i];
    }
  }
  if (searchNode.next[0] != null && searchNode.next[0].value == target) {
    return searchNode.next[0];
  } else {
    return null;
  }
}
```



## äºŒã€Redis ä¸ºä»€ä¹ˆé€‰æ‹©è·³è¡¨ï¼Ÿ

è·³è¡¨æœ¬è´¨ä¸Šä¹Ÿæ˜¯ä¸€ç§æŸ¥æ‰¾ç»“æ„ï¼Œæˆ‘ä»¬ç»å¸¸é‡åˆ°çš„æŸ¥æ‰¾é—®é¢˜æœ€å¸¸è§çš„å°±æ˜¯å“ˆå¸Œè¡¨ï¼Œè¿˜æœ‰å°±æ˜¯å„ç§å¹³è¡¡æ ‘ï¼Œè·³è¡¨åˆä¸å±äºè¿™ä¸¤å¤§é˜µè¥ï¼Œé‚£é—®é¢˜æ¥äº†ï¼š

ä¸ºä»€ä¹ˆ Redis è¦ç”¨è·³è¡¨æ¥å®ç°æœ‰åºé›†åˆï¼Œè€Œä¸æ˜¯å“ˆå¸Œè¡¨æˆ–è€…å¹³è¡¡æ ‘ï¼ˆAVLã€çº¢é»‘æ ‘ç­‰ï¼‰ï¼Ÿ

>  Redis ä¸­çš„æœ‰åºé›†åˆæ˜¯é€šè¿‡è·³è¡¨æ¥å®ç°çš„ï¼Œä¸¥æ ¼ç‚¹è®²ï¼Œå…¶å®è¿˜ç”¨åˆ°äº†å‹ç¼©åˆ—è¡¨ã€å“ˆå¸Œè¡¨ã€‚
>
> Redis æä¾›äº†ä¸¤ç§ç¼–ç çš„é€‰æ‹©ï¼Œæ ¹æ®æ•°æ®é‡çš„å¤šå°‘è¿›è¡Œå¯¹åº”çš„è½¬åŒ– ([æºç åœ°å€](https://github.com/redis/redis/blob/8f59f131e5c26680d21e825695ef24a4fd7b99b7/src/server.h) )
>
> - å½“æ•°æ®è¾ƒå°‘æ—¶ï¼ŒZSet æ˜¯ç”±ä¸€ä¸ª ziplist æ¥å®ç°çš„
>
> - å½“æ•°æ®å¤šçš„æ—¶å€™ï¼ŒZSet æ˜¯ç”±ä¸€ä¸ª dict + ä¸€ä¸ª skiplist æ¥å®ç°çš„ã€‚ç®€å•æ¥è®²ï¼Œdict ç”¨æ¥æŸ¥è¯¢æ•°æ®åˆ°åˆ†æ•°çš„å¯¹åº”å…³ç³»ï¼Œè€Œ skiplist ç”¨æ¥æ ¹æ®åˆ†æ•°æŸ¥è¯¢æ•°æ®ï¼ˆå¯èƒ½æ˜¯èŒƒå›´æŸ¥æ‰¾ï¼‰ã€‚
>
> ![](https://cdn.jsdelivr.net/gh/Jstarfish/picBed/redis/Blank%20diagram%20-%20Page%203.svg)
>
> Redis çš„è·³è·ƒè¡¨åšäº†äº›ä¿®æ”¹
>
> - å…è®¸æœ‰é‡å¤çš„åˆ†å€¼
> - å¯¹å…ƒç´ çš„æ¯”å¯¹ä¸ä»…è¦æ¯”å¯¹ä»–ä»¬çš„åˆ†å€¼ï¼Œè¿˜è¦æ¯”å¯¹ä»–ä»¬çš„å¯¹è±¡
> - æ¯ä¸ªè·³è·ƒè¡¨èŠ‚ç‚¹éƒ½å¸¦æœ‰ä¸€ä¸ªåé€€æŒ‡é’ˆï¼Œå®ƒå…è®¸ç¨‹åºåœ¨æ‰§è¡Œåƒ ZREVRANGE è¿™æ ·çš„å‘½ä»¤æ—¶ï¼Œä»è¡¨å°¾å‘è¡¨å¤´éå†è·³è·ƒè¡¨ã€‚

æˆ‘ä»¬å…ˆçœ‹ä¸‹ ZSet å¸¸ç”¨çš„ä¸€äº›å‘½ä»¤

| å‘½ä»¤          | æè¿°                                                         |
| ------------- | ------------------------------------------------------------ |
| **ZADD**      | å‘æœ‰åºé›†åˆæ·»åŠ ä¸€ä¸ªæˆ–å¤šä¸ªæˆå‘˜ï¼Œæˆ–è€…æ›´æ–°å·²å­˜åœ¨æˆå‘˜çš„åˆ†æ•°       |
| **ZCARD**     | è¿”å›æœ‰åºé›† key çš„åŸºæ•°                                        |
| ZREM          | ç§»é™¤æœ‰åºé›† key ä¸­çš„ä¸€ä¸ªæˆ–å¤šä¸ªæˆå‘˜ï¼Œä¸å­˜åœ¨çš„æˆå‘˜å°†è¢«å¿½ç•¥      |
| ZSCAN         | è¿­ä»£æœ‰åºé›†åˆä¸­çš„å…ƒç´ ï¼ˆåŒ…æ‹¬å…ƒç´ æˆå‘˜å’Œå…ƒç´ åˆ†å€¼ï¼‰               |
| **ZREVRANGE** | è¿”å›æœ‰åºé›† key ä¸­ï¼ŒæŒ‡å®šåŒºé—´å†…çš„æˆå‘˜ã€‚å…¶ä¸­æˆå‘˜çš„ä½ç½®æŒ‰ score å€¼é€’å‡(ä»å¤§åˆ°å°)æ¥æ’åˆ— |

ä¸»è¦æ“ä½œå°±æ˜¯å¢åˆ æŸ¥ä¸€ä¸ªæ•°æ®ï¼Œè¿­ä»£æ•°æ®ã€æŒ‰åŒºé—´æŸ¥æ•°æ®ï¼Œçœ‹ä¸‹åŸå› 

- å“ˆå¸Œè¡¨æ˜¯æ— åºçš„ï¼Œä¸”åªèƒ½æŸ¥æ‰¾å•ä¸ª keyï¼Œä¸é€‚å®œèŒƒå›´æŸ¥æ‰¾
- æ’å…¥ã€åˆ é™¤ã€æŸ¥æ‰¾ä»¥åŠè¿­ä»£è¾“å‡ºæœ‰åºåºåˆ—è¿™å‡ ä¸ªæ“ä½œï¼Œçº¢é»‘æ ‘ä¹Ÿå¯ä»¥å®Œæˆï¼Œæ—¶é—´å¤æ‚åº¦è·Ÿè·³è¡¨æ˜¯ä¸€æ ·çš„ã€‚ä½†æ˜¯ï¼ŒæŒ‰ç…§åŒºé—´æ¥æŸ¥æ‰¾æ•°æ®è¿™ä¸ªæ“ä½œï¼Œçº¢é»‘æ ‘çš„æ•ˆç‡æ²¡æœ‰è·³è¡¨é«˜ï¼ˆè·³è¡¨åªéœ€è¦å®šä½åŒºé—´çš„èµ·ç‚¹ï¼Œç„¶åéå†å°±è¡Œäº†ï¼‰
- Redis é€‰è·³è¡¨å®ç°æœ‰åºé›†åˆï¼Œè¿˜æœ‰å…¶ä»–å„ç§åŸå› ï¼Œæ¯”å¦‚ä»£ç å®ç°ç›¸å¯¹ç®€å•äº›ï¼Œä¸”æ›´åŠ çµæ´»ï¼Œå®ƒå¯ä»¥é€šè¿‡æ”¹å˜ç´¢å¼•æ„å»ºç­–ç•¥ï¼Œæœ‰æ•ˆå¹³è¡¡æ‰§è¡Œæ•ˆç‡å’Œå†…å­˜æ¶ˆè€—ã€‚



## æ‰¯ç‚¹åˆ«çš„ | è¿™åˆæ˜¯ä¸ºä»€ä¹ˆï¼Ÿ

> æœ‰åºé›†åˆçš„è‹±æ–‡å…¨ç§°æ˜æ˜æ˜¯**sorted sets**ï¼Œä¸ºå•¥å« zset å‘¢ï¼Ÿ
>
> Rediså®˜ç½‘ä¸Šæ²¡æœ‰è§£é‡Šï¼Œä½†æ˜¯åœ¨ Github ä¸Šæœ‰äººå‘ä½œè€…æé—®äº†ã€‚ä½œè€…æ˜¯è¿™ä¹ˆå›ç­”çš„å“ˆå“ˆå“ˆ
>
> Hello. Z is as in XYZ, so the idea is, sets with another dimension: the
> order. Itâ€™s a far associationâ€¦ I know ğŸ˜ƒ
>
> åŸæ¥å‰é¢çš„ Z ä»£è¡¨çš„æ˜¯ XYZ ä¸­çš„Zï¼Œæœ€åä¸€ä¸ªè‹±æ–‡å­—æ¯ï¼Œzset æ˜¯åœ¨è¯´è¿™æ˜¯æ¯” set æœ‰æ›´å¤šä¸€ä¸ªç»´åº¦çš„ set ğŸ˜¦
>
> æ˜¯ä¸æ²¡é“ç†ï¼Ÿ
>
> æ›´æ²¡é“ç†çš„è¿˜æœ‰ï¼ŒRedis é»˜è®¤ç«¯å£ 6379 ï¼Œå› ä¸ºä½œè€…å–œæ¬¢çš„ä¸€ä¸ªå« Merz çš„å¥³æ˜æ˜Ÿï¼Œå…¶åå­—åœ¨æ‰‹æœºä¸Šè¾“å…¥æ­£å¥½å¯¹åº”å·ç  6379ï¼Œç´¢æ€§å°±æŠŠ Redis çš„é»˜è®¤ç«¯å£å« 6379 äº†â€¦



## å°ç»“

è·³è¡¨ä½¿ç”¨ç©ºé—´æ¢æ—¶é—´çš„è®¾è®¡æ€è·¯ï¼Œé€šè¿‡æ„å»ºå¤šçº§ç´¢å¼•æ¥æé«˜æŸ¥è¯¢çš„æ•ˆç‡ï¼Œå®ç°äº†åŸºäºé“¾è¡¨çš„â€œäºŒåˆ†æŸ¥æ‰¾â€ã€‚

è·³è¡¨æ˜¯ä¸€ç§åŠ¨æ€æ•°æ®ç»“æ„ï¼Œæ”¯æŒå¿«é€Ÿåœ°æ’å…¥ã€åˆ é™¤ã€æŸ¥æ‰¾æ“ä½œï¼Œæ—¶é—´å¤æ‚åº¦éƒ½æ˜¯ $O(logn)$ã€‚

Redis çš„ zset æ˜¯ä¸€ä¸ªå¤åˆç»“æ„ï¼Œä¸€æ–¹é¢å®ƒéœ€è¦ä¸€ä¸ª hash ç»“æ„æ¥å­˜å‚¨ value å’Œ score çš„å¯¹åº”å…³ç³»ï¼Œå¦ä¸€æ–¹é¢éœ€è¦æä¾›æŒ‰ç…§ score æ¥æ’åºçš„åŠŸèƒ½ï¼Œè¿˜éœ€è¦èƒ½å¤ŸæŒ‡å®š score çš„èŒƒå›´æ¥è·å– value åˆ—è¡¨çš„åŠŸèƒ½

Redis ä¸­çš„æœ‰åºé›†åˆæ˜¯é€šè¿‡å‹ç¼©åˆ—è¡¨ã€å“ˆå¸Œè¡¨å’Œè·³è¡¨çš„ç»„åˆæ¥å®ç°çš„ï¼Œå½“æ•°æ®è¾ƒå°‘æ—¶ï¼ŒZSet æ˜¯ç”±ä¸€ä¸ª ziplist æ¥å®ç°çš„ã€‚å½“æ•°æ®å¤šçš„æ—¶å€™ï¼ŒZSet æ˜¯ç”±ä¸€ä¸ªdict + ä¸€ä¸ª skiplist æ¥å®ç°çš„

![](https://i02piccdn.sogoucdn.com/06eb28fd58fa8840)



åç»­ï¼šMySQL çš„ Innodb ï¼Œä¸ºä»€ä¹ˆä¸ç”¨ skiplistï¼Œè€Œç”¨ B+ Tree ï¼Ÿ



## å‚è€ƒ

- [ftp://ftp.cs.umd.edu/pub/skipLists/skiplists.pdf](ftp://ftp.cs.umd.edu/pub/skipLists/skiplists.pdf) åŸè®ºæ–‡
- [Rediså†…éƒ¨æ•°æ®ç»“æ„è¯¦è§£(6)â€”â€”skiplist](http://zhangtielei.com/posts/blog-redis-skiplist.html) å›¾æ–‡å¹¶èŒ‚è®²è§£ skip list
- https://leetcode-cn.com/problems/design-skiplist/
- https://lotabout.me/2018/skip-list/
- https://redisbook.readthedocs.io/en/latest/internal-datastruct/skiplist.html
- https://redisbook.readthedocs.io/en/latest/datatype/sorted_set.html#sorted-set-chapter