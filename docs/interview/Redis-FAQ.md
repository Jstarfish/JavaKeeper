---
title: Redis é¢è¯•ä¸“åœº
date: 2024-05-31
tags: 
 - Redis
 - Interview
categories: Interview
---

![](https://img.starfish.ink/redis/redis-faq-banner.png)

> **å¯¼è¯»ï¼š**ä¸ç®¡å“ªä¸ªæ¨¡æ¿çš„é¢è¯•é¢˜ï¼Œå…¶å®éƒ½æ˜¯åˆ†åŸç†å’Œå®è·µä¸¤éƒ¨åˆ†ã€‚æ‰€ä»¥ä¸¤æ–¹é¢éƒ½è¦å‡†å¤‡ã€‚
>
> æ¯”å¦‚ä½ ä»¬é¡¹ç›®æ˜¯æ€ä¹ˆç”¨ç¼“å­˜çš„ï¼ŒæœåŠ¡æ˜¯æ€ä¹ˆéƒ¨ç½²çš„ï¼Œä¸è¦åƒæœ‰äº›åŒå­¦è‡ªå·±é¡¹ç›®ä¸­çš„ Redis æ˜¯é›†ç¾¤éƒ¨ç½²è¿˜æ˜¯å“¨å…µéƒ½ä¸æ¸…æ¥šã€‚
>
> é¢è¯•æ˜¯éœ€è¦å‡†å¤‡çš„~

## ğŸ—ºï¸ çŸ¥è¯†å¯¼èˆª

### ğŸ·ï¸ æ ¸å¿ƒçŸ¥è¯†åˆ†ç±»

1. **ğŸ”‘ RedisåŸºç¡€æ¶æ„**ï¼šåŸºæœ¬æ¦‚å¿µã€çº¿ç¨‹æ¨¡å‹ã€I/Oå¤šè·¯å¤ç”¨ã€Reactoræ¨¡å¼ã€ä¸Memcachedå¯¹æ¯”
2. **ğŸ—‚ï¸ æ•°æ®ç»“æ„ä¸åº•å±‚å®ç°**ï¼šäº”ç§åŸºæœ¬ç±»å‹ã€SDSã€Hashå®ç°ã€è·³è¡¨ã€æ‰©å±•æ•°æ®ç±»å‹ã€ä½¿ç”¨åœºæ™¯
3. **ğŸ’¾ æŒä¹…åŒ–ä¸å†…å­˜ç®¡ç†**ï¼šRDB/AOFã€æ··åˆæŒä¹…åŒ–ã€è¿‡æœŸç­–ç•¥ã€æ·˜æ±°ç­–ç•¥ã€å†…å­˜æ¨¡å‹ã€Fork/COW
4. **ğŸ”— äº‹åŠ¡ä¸è„šæœ¬**ï¼šäº‹åŠ¡ç‰¹æ€§ã€WATCHæœºåˆ¶ã€Luaè„šæœ¬ã€åŸå­æ€§ä¿éšœ
5. **ğŸŒ é«˜å¯ç”¨ä¸åˆ†å¸ƒå¼**ï¼šä¸»ä»å¤åˆ¶ã€å“¨å…µæœºåˆ¶ã€Clusteré›†ç¾¤ã€åˆ†ç‰‡ç­–ç•¥ã€ä¸€è‡´æ€§ä¿éšœã€CAPæƒè¡¡
6. **ğŸš€ æ€§èƒ½ä¼˜åŒ–ä¸å¼‚å¸¸å¤„ç†**ï¼šç¼“å­˜ç­–ç•¥ã€å¤§Key/çƒ­Keyã€ç¼“å­˜ä¸‰å¤§é—®é¢˜ã€æ€§èƒ½è°ƒä¼˜ã€ç›‘æ§æŒ‡æ ‡
7. **ğŸ” åˆ†å¸ƒå¼é”ä¸å¹¶å‘æ§åˆ¶**ï¼šRedisåˆ†å¸ƒå¼é”ã€Redlockç®—æ³•ã€ç»­æœŸæœºåˆ¶ã€ä¸ZKå¯¹æ¯”ã€ä¹è§‚é”åº”ç”¨
8. **ğŸ“¨ æ¶ˆæ¯é˜Ÿåˆ—ä¸å¼‚æ­¥å¤„ç†**ï¼šList/Streamé˜Ÿåˆ—ã€Pub/Subã€å»¶æ—¶é˜Ÿåˆ—ã€å¼‚æ­¥æ¶ˆæ¯æœºåˆ¶
9. **ğŸ› ï¸ å®æˆ˜åº”ç”¨ä¸æœ€ä½³å®è·µ**ï¼šç®¡é“æŠ€æœ¯ã€UVç»Ÿè®¡ã€å®è·µæ¡ˆä¾‹ã€ä½¿ç”¨è¯¯åŒºã€ä¼˜åŒ–æŠ€å·§

### ğŸ”‘ é¢è¯•è¯æœ¯æ¨¡æ¿

| é—®é¢˜ç±»å‹ | å›ç­”æ¡†æ¶ | å…³é”®è¦ç‚¹ | æ·±å…¥æ‰©å±• |
| --- | --- | --- | --- |
| æœºåˆ¶åŸç† | èƒŒæ™¯â†’å®ç°â†’ç‰¹ç‚¹â†’é€‚ç”¨ | åº•å±‚æ•°æ®ç»“æ„/æµç¨‹å›¾ | ç‰ˆæœ¬å·®å¼‚ã€æºç ç»†èŠ‚ |
| æ¶æ„èƒ½åŠ› | æ¶æ„â†’ä¼˜ç¼ºç‚¹â†’æƒè¡¡ | CAPã€å»¶è¿Ÿã€å¯ç”¨æ€§ | å‚æ•°ä¸éƒ¨ç½²å»ºè®® |
| æ€§èƒ½ä¼˜åŒ– | ç—›ç‚¹â†’ç­–ç•¥â†’æ•°æ® | å‘½ä¸­ç‡ã€RT/QPS | å‹æµ‹ä¸ç›‘æ§æŒ‡æ ‡ |
| æ•…éšœæ²»ç† | ç°è±¡â†’å®šä½â†’ä¿®å¤ | å·¥å…·ä¸æŒ‡æ ‡ | é¢„é˜²ä¸æ¼”ç»ƒ |

## ä¸€ã€RedisåŸºç¡€æ¶æ„

### ğŸ¯ Redisæ˜¯ä»€ä¹ˆï¼Ÿ

Redisï¼š**REmote DIctionary Server**(è¿œç¨‹å­—å…¸æœåŠ¡å™¨)ã€‚

Redis æ˜¯ä¸€ä¸ªå…¨å¼€æºå…è´¹ï¼ˆBSDè®¸å¯ï¼‰çš„ï¼Œå†…å­˜ä¸­çš„æ•°æ®ç»“æ„å­˜å‚¨ç³»ç»Ÿï¼Œå®ƒå¯ä»¥ç”¨ä½œ**æ•°æ®åº“ã€ç¼“å­˜å’Œæ¶ˆæ¯ä¸­é—´ä»¶**ï¼Œ

å’Œ Memcached ç±»ä¼¼ï¼Œå®ƒæ”¯æŒå­˜å‚¨çš„ value ç±»å‹ç›¸å¯¹æ›´å¤šï¼ŒåŒ…æ‹¬**string(å­—ç¬¦ä¸²)ã€list(é“¾è¡¨)ã€set(é›†åˆ)ã€zset(sorted set --æœ‰åºé›†åˆ)å’Œhashï¼ˆå“ˆå¸Œç±»å‹ï¼‰ã€bitmapã€hyperloglogã€GeoHashã€streams**ã€‚è¿™äº›æ•°æ®ç±»å‹éƒ½æ”¯æŒpush/popã€add/removeåŠå–äº¤é›†å¹¶é›†å’Œå·®é›†åŠæ›´ä¸°å¯Œçš„æ“ä½œï¼Œè€Œä¸”è¿™äº›æ“ä½œéƒ½æ˜¯åŸå­æ€§çš„ã€‚

Redis å†…ç½®äº†å¤åˆ¶ï¼ˆReplicationï¼‰ï¼ŒLUAè„šæœ¬ï¼ˆLua scriptingï¼‰ï¼Œ LRUé©±åŠ¨äº‹ä»¶ï¼ˆLRU evictionï¼‰ï¼Œäº‹åŠ¡ï¼ˆTransactionsï¼‰ å’Œä¸åŒçº§åˆ«çš„ç£ç›˜æŒä¹…åŒ–ï¼ˆPersistenceï¼‰ï¼Œå¹¶é€šè¿‡ Redis å“¨å…µï¼ˆSentinelï¼‰å’Œè‡ªåŠ¨åˆ†åŒºï¼ˆClusterï¼‰æä¾›é«˜å¯ç”¨æ€§ï¼ˆHigh Availabilityï¼‰ã€‚

- æ€§èƒ½ä¼˜ç§€ï¼Œæ•°æ®åœ¨å†…å­˜ä¸­ï¼Œè¯»å†™é€Ÿåº¦éå¸¸å¿«ï¼Œæ”¯æŒå¹¶å‘10W QPS
- å•è¿›ç¨‹å•çº¿ç¨‹ï¼Œæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œé‡‡ç”¨IOå¤šè·¯å¤ç”¨æœºåˆ¶
- Redis æ•°æ®åº“å®Œå…¨åœ¨å†…å­˜ä¸­ï¼Œä½¿ç”¨ç£ç›˜ä»…ç”¨äºæŒä¹…æ€§
- ç›¸æ¯”è®¸å¤šé”®å€¼æ•°æ®å­˜å‚¨ï¼ŒRedis æ‹¥æœ‰ä¸€å¥—è¾ƒä¸ºä¸°å¯Œçš„æ•°æ®ç±»å‹
- æ“ä½œéƒ½æ˜¯**åŸå­æ€§**ï¼šæ‰€æœ‰ Redis æ“ä½œæ˜¯åŸå­çš„ï¼Œè¿™ä¿è¯äº†å¦‚æœä¸¤ä¸ªå®¢æˆ·ç«¯åŒæ—¶è®¿é—®çš„RedisæœåŠ¡å™¨å°†è·å¾—æ›´æ–°åçš„å€¼
- Redis å¯ä»¥å°†æ•°æ®å¤åˆ¶åˆ°ä»»æ„æ•°é‡çš„ä»æœåŠ¡å™¨ï¼ˆä¸»ä»å¤åˆ¶ï¼Œå“¨å…µï¼Œé«˜å¯ç”¨ï¼‰



### ğŸ¯ ä¸ºä»€ä¹ˆè¦ç”¨ç¼“å­˜ï¼Ÿä¸ºä»€ä¹ˆä½¿ç”¨ Redisï¼Ÿ

**æä¸€ä¸‹ç°åœ¨ Web åº”ç”¨çš„ç°çŠ¶**

åœ¨æ—¥å¸¸çš„ Web åº”ç”¨å¯¹æ•°æ®åº“çš„è®¿é—®ä¸­ï¼Œ**è¯»æ“ä½œçš„æ¬¡æ•°è¿œè¶…å†™æ“ä½œ**ï¼Œæ¯”ä¾‹å¤§æ¦‚åœ¨ **1:9** åˆ° **3:7**ï¼Œæ‰€ä»¥éœ€è¦è¯»çš„å¯èƒ½æ€§æ˜¯æ¯”å†™çš„å¯èƒ½å¤§å¾—å¤šçš„ã€‚å½“æˆ‘ä»¬ä½¿ç”¨ SQL è¯­å¥å»æ•°æ®åº“è¿›è¡Œè¯»å†™æ“ä½œæ—¶ï¼Œæ•°æ®åº“å°±ä¼š **å»ç£ç›˜æŠŠå¯¹åº”çš„æ•°æ®ç´¢å¼•å–å›æ¥**ï¼Œè¿™æ˜¯ä¸€ä¸ªç›¸å¯¹è¾ƒæ…¢çš„è¿‡ç¨‹ã€‚

**ä½¿ç”¨ Redis or ä½¿ç”¨ç¼“å­˜å¸¦æ¥çš„ä¼˜åŠ¿**

å¦‚æœæˆ‘ä»¬æŠŠæ•°æ®æ”¾åœ¨ Redis ä¸­ï¼Œä¹Ÿå°±æ˜¯ç›´æ¥æ”¾åœ¨å†…å­˜ä¹‹ä¸­ï¼Œè®©æœåŠ¡ç«¯ç›´æ¥å»è¯»å–å†…å­˜ä¸­çš„æ•°æ®ï¼Œé‚£ä¹ˆè¿™æ · **é€Ÿåº¦** æ˜æ˜¾å°±ä¼šå¿«ä¸Šä¸å°‘ *(é«˜æ€§èƒ½)*ï¼Œå¹¶ä¸”ä¼š **æå¤§å‡å°æ•°æ®åº“çš„å‹åŠ›** *(ç‰¹åˆ«æ˜¯åœ¨é«˜å¹¶å‘æƒ…å†µä¸‹)*ã€‚

**ä¹Ÿè¦æä¸€ä¸‹ä½¿ç”¨ç¼“å­˜çš„è€ƒè™‘**

ä½†æ˜¯ä½¿ç”¨å†…å­˜è¿›è¡Œæ•°æ®å­˜å‚¨å¼€é”€ä¹Ÿæ˜¯æ¯”è¾ƒå¤§çš„ï¼Œ**é™äºæˆæœ¬** çš„åŸå› ï¼Œä¸€èˆ¬æˆ‘ä»¬åªæ˜¯ä½¿ç”¨ Redis å­˜å‚¨ä¸€äº› **å¸¸ç”¨å’Œä¸»è¦çš„æ•°æ®**ï¼Œæ¯”å¦‚ç”¨æˆ·ç™»å½•çš„ä¿¡æ¯ç­‰ã€‚

ä¸€èˆ¬è€Œè¨€åœ¨ä½¿ç”¨ Redis è¿›è¡Œå­˜å‚¨çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦ä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢æ¥è€ƒè™‘ï¼š

- **ä¸šåŠ¡æ•°æ®å¸¸ç”¨å—ï¼Ÿå‘½ä¸­ç‡å¦‚ä½•ï¼Ÿ** å¦‚æœå‘½ä¸­ç‡å¾ˆä½ï¼Œå°±æ²¡æœ‰å¿…è¦å†™å…¥ç¼“å­˜ï¼›
- **è¯¥ä¸šåŠ¡æ•°æ®æ˜¯è¯»æ“ä½œå¤šï¼Œè¿˜æ˜¯å†™æ“ä½œå¤šï¼Ÿ** å¦‚æœå†™æ“ä½œå¤šï¼Œé¢‘ç¹éœ€è¦å†™å…¥æ•°æ®åº“ï¼Œä¹Ÿæ²¡æœ‰å¿…è¦ä½¿ç”¨ç¼“å­˜ï¼›
- **ä¸šåŠ¡æ•°æ®å¤§å°å¦‚ä½•ï¼Ÿ** å¦‚æœè¦å­˜å‚¨å‡ ç™¾å…†å­—èŠ‚çš„æ–‡ä»¶ï¼Œä¼šç»™ç¼“å­˜å¸¦æ¥å¾ˆå¤§çš„å‹åŠ›ï¼Œè¿™æ ·ä¹Ÿæ²¡æœ‰å¿…è¦ï¼›

åœ¨è€ƒè™‘äº†è¿™äº›é—®é¢˜ä¹‹åï¼Œå¦‚æœè§‰å¾—æœ‰å¿…è¦ä½¿ç”¨ç¼“å­˜ï¼Œé‚£ä¹ˆå°±ä½¿ç”¨å®ƒï¼



### ğŸ¯ ç”¨ç¼“å­˜ï¼Œè‚¯å®šæ˜¯å› ä¸ºä»–å¿«ï¼Œé‚£ Redis ä¸ºä»€ä¹ˆè¿™ä¹ˆå¿«ï¼Ÿ

Rediså¿«åœ¨â€œä¸‰ä»¶å¥—+ä¸¤å±‚ä¼˜åŒ–â€ï¼š

- ä¸‰ä»¶å¥—ï¼šå…¨å†…å­˜æ“ä½œï¼ˆé¿å…ç£ç›˜IOï¼‰ã€é«˜æ•ˆæ•°æ®ç»“æ„ï¼ˆå“ˆå¸Œè¡¨/è·³è¡¨/quicklist/listpackï¼‰ã€å•çº¿ç¨‹äº‹ä»¶é©±åŠ¨ï¼ˆæ— é”ã€æ— åˆ‡æ¢ï¼‰ã€‚

- ä¸¤å±‚ä¼˜åŒ–ï¼šI/Oå¤šè·¯å¤ç”¨ï¼ˆepoll/kqueueï¼‰é…åˆæµæ°´çº¿/æ‰¹å¤„ç†é™ä½ç³»ç»Ÿè°ƒç”¨ï¼›å·¥ç¨‹çº§ç»†èŠ‚ï¼ˆRESPåè®®ç®€å•ã€jemallocã€æ¸è¿›å¼rehashã€å¼‚æ­¥æŒä¹…åŒ–/åˆ é™¤ã€6.0èµ·I/Oçº¿ç¨‹åˆ†æµæ”¶å‘ï¼‰ã€‚

> - **çº¯å†…å­˜æ“ä½œ**ï¼šè¯»å–ä¸éœ€è¦è¿›è¡Œç£ç›˜ I/Oï¼Œæ‰€ä»¥æ¯”ä¼ ç»Ÿæ•°æ®åº“è¦å¿«ä¸Šä¸å°‘ï¼›*(ä½†ä¸è¦æœ‰è¯¯åŒºè¯´ç£ç›˜å°±ä¸€å®šæ…¢ï¼Œä¾‹å¦‚ Kafka å°±æ˜¯ä½¿ç”¨ç£ç›˜é¡ºåºè¯»å–ä½†ä»ç„¶è¾ƒå¿«)*
>
> - ç”¨ hash table ä½œä¸ºé”®ç©ºé—´ï¼ŒæŸ¥æ‰¾ä»»æ„çš„ key åªéœ€ $O(1)$
>
> - **å•çº¿ç¨‹ï¼Œæ— é”ç«äº‰**ï¼šå¤©ç”Ÿçš„é˜Ÿåˆ—æ¨¡å¼ï¼Œé¿å…äº†å› å¤šçº¿ç¨‹ç«äº‰è€Œå¯¼è‡´çš„ä¸Šä¸‹æ–‡åˆ‡æ¢å’ŒæŠ¢é”çš„å¼€é”€
>
> - äº‹ä»¶æœºåˆ¶ï¼ŒRedisæœåŠ¡å™¨å°†æ‰€æœ‰å¤„ç†çš„ä»»åŠ¡åˆ†ä¸ºä¸¤ç±»äº‹ä»¶ï¼Œä¸€ç±»æ˜¯é‡‡ç”¨ I/O å¤šè·¯å¤ç”¨å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚çš„ç½‘ç»œäº‹ä»¶ï¼›ä¸€ç±»æ˜¯å¤„ç†å®šæ—¶ä»»åŠ¡çš„æ—¶é—´äº‹ä»¶ï¼ŒåŒ…æ‹¬æ›´æ–°ç»Ÿè®¡ä¿¡æ¯ã€æ¸…ç†è¿‡æœŸé”®ã€æŒä¹…åŒ–ã€ä¸»ä»åŒæ­¥ç­‰ï¼›
>
>   - **å¤šè·¯ I/O å¤ç”¨æ¨¡å‹ï¼Œéé˜»å¡ I/O**ï¼šé‡‡ç”¨å¤šè·¯ I/O å¤ç”¨æŠ€æœ¯å¯ä»¥è®©å•ä¸ªçº¿ç¨‹é«˜æ•ˆçš„å¤„ç†å¤šä¸ªç½‘ç»œè¿æ¥è¯·æ±‚ï¼ˆå°½é‡å‡å°‘ç½‘ç»œ IO çš„æ—¶é—´æ¶ˆè€—ï¼‰ï¼›
>
>   - Redis åŸºäº Reactor æ¨¡å¼å¼€å‘äº†è‡ªå·±çš„ç½‘ç»œäº‹ä»¶å¤„ç†å™¨ï¼Œè¿™ä¸ªå¤„ç†å™¨è¢«ç§°ä¸ºæ–‡ä»¶äº‹ä»¶å¤„ç†å™¨ file event handlerã€‚ç”±äºè¿™ä¸ªæ–‡ä»¶äº‹ä»¶å¤„ç†å™¨æ˜¯å•çº¿ç¨‹çš„ï¼Œæ‰€ä»¥ Redis æ‰å«åšå•çº¿ç¨‹çš„æ¨¡å‹ï¼Œä½†æ˜¯å®ƒé‡‡ç”¨ IO å¤šè·¯å¤ç”¨æœºåˆ¶åŒæ—¶ç›‘å¬å¤šä¸ªSocketï¼Œå¹¶æ ¹æ®Socketä¸Šçš„äº‹ä»¶æ¥é€‰æ‹©å¯¹åº”çš„äº‹ä»¶å¤„ç†å™¨è¿›è¡Œå¤„ç†ã€‚
>
>   å¤šä¸ª Socket å¯èƒ½ä¼šäº§ç”Ÿä¸åŒçš„æ“ä½œï¼Œæ¯ä¸ªæ“ä½œå¯¹åº”ä¸åŒçš„æ–‡ä»¶äº‹ä»¶ï¼Œä½†æ˜¯IOå¤šè·¯å¤ç”¨ç¨‹åºä¼šç›‘å¬å¤šä¸ªSocketï¼Œå°†Socketäº§ç”Ÿçš„äº‹ä»¶æ”¾å…¥é˜Ÿåˆ—ä¸­æ’é˜Ÿï¼Œäº‹ä»¶åˆ†æ´¾å™¨æ¯æ¬¡ä»é˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ªäº‹ä»¶ï¼ŒæŠŠè¯¥äº‹ä»¶äº¤ç»™å¯¹åº”çš„äº‹ä»¶å¤„ç†å™¨è¿›è¡Œå¤„ç†ã€‚
>
>   Rediså®¢æˆ·ç«¯å¯¹æœåŠ¡ç«¯çš„æ¯æ¬¡è°ƒç”¨éƒ½ç»å†äº†å‘é€å‘½ä»¤ï¼Œæ‰§è¡Œå‘½ä»¤ï¼Œè¿”å›ç»“æœä¸‰ä¸ªè¿‡ç¨‹ã€‚å…¶ä¸­æ‰§è¡Œå‘½ä»¤é˜¶æ®µï¼Œç”±äºRedisæ˜¯å•çº¿ç¨‹æ¥å¤„ç†å‘½ä»¤çš„ï¼Œæ‰€æœ‰æ¯ä¸€æ¡åˆ°è¾¾æœåŠ¡ç«¯çš„å‘½ä»¤ä¸ä¼šç«‹åˆ»æ‰§è¡Œï¼Œæ‰€æœ‰çš„å‘½ä»¤éƒ½ä¼šè¿›å…¥ä¸€ä¸ªé˜Ÿåˆ—ä¸­ï¼Œç„¶åé€ä¸ªè¢«æ‰§è¡Œã€‚å¹¶ä¸”å¤šä¸ªå®¢æˆ·ç«¯å‘é€çš„å‘½ä»¤çš„æ‰§è¡Œé¡ºåºæ˜¯ä¸ç¡®å®šçš„ã€‚ä½†æ˜¯å¯ä»¥ç¡®å®šçš„æ˜¯ä¸ä¼šæœ‰ä¸¤æ¡å‘½ä»¤è¢«åŒæ—¶æ‰§è¡Œï¼Œä¸ä¼šäº§ç”Ÿå¹¶å‘é—®é¢˜ï¼Œè¿™å°±æ˜¯Redisçš„å•çº¿ç¨‹åŸºæœ¬æ¨¡å‹ã€‚
>
> - Redisç›´æ¥è‡ªå·±æ„å»ºäº†VM æœºåˆ¶ ï¼Œé¿å…è°ƒç”¨ç³»ç»Ÿå‡½æ•°çš„æ—¶å€™ï¼Œæµªè´¹æ—¶é—´å»ç§»åŠ¨å’Œè¯·æ±‚
>
> - **é«˜æ•ˆçš„æ•°æ®ç»“æ„ï¼ŒåŠ ä¸Šåº•å±‚åšäº†å¤§é‡ä¼˜åŒ–**ï¼šRedis å¯¹äºåº•å±‚çš„æ•°æ®ç»“æ„å’Œå†…å­˜å ç”¨åšäº†å¤§é‡çš„ä¼˜åŒ–ï¼Œä¾‹å¦‚ä¸åŒé•¿åº¦çš„å­—ç¬¦ä¸²ä½¿ç”¨ä¸åŒçš„ç»“æ„ä½“è¡¨ç¤ºï¼ŒHyperLogLog çš„å¯†é›†å‹å­˜å‚¨ç»“æ„ç­‰ç­‰..

ä½†æ˜¯å› ä¸º Redis ä¸åŒç‰ˆæœ¬çš„ç‰¹æ®Šæ€§ï¼Œæ‰€ä»¥å¯¹äº Redis çš„çº¿ç¨‹æ¨¡å‹è¦åˆ†ç‰ˆæœ¬æ¥çœ‹ã€‚

Redis 4.0 ç‰ˆæœ¬ä¹‹å‰ï¼Œä½¿ç”¨å•çº¿ç¨‹é€Ÿåº¦å¿«çš„åŸå› å°±æ˜¯å†…å­˜ã€æ•°æ®ç»“æ„ã€å•çº¿ç¨‹ã€IO å¤šè·¯å¤ç”¨ï¼›

Redis 4.0 ç‰ˆæœ¬ä¹‹åï¼ŒRedis æ·»åŠ äº†å¤šçº¿ç¨‹çš„æ”¯æŒï¼Œä½†è¿™æ—¶çš„å¤šçº¿ç¨‹ä¸»è¦ä½“ç°åœ¨å¤§æ•°æ®çš„å¼‚æ­¥åˆ é™¤åŠŸèƒ½ä¸Šï¼Œä¾‹å¦‚ unlink keyã€flushdb asyncã€flushall async ç­‰ã€‚

Redis 6.0 ç‰ˆæœ¬ä¹‹åï¼Œä¸ºäº†æ›´å¥½åœ°æé«˜ Redis çš„æ€§èƒ½ï¼Œæ–°å¢äº†å¤šçº¿ç¨‹ I/O çš„è¯»å†™å¹¶å‘èƒ½åŠ›ï¼Œä½†æ˜¯åœ¨é¢è¯•ä¸­ï¼Œèƒ½æŠŠ Redis 6.0 ä¸­çš„å¤šçº¿ç¨‹æ¨¡å‹å›ç­”ä¸Šæ¥çš„äººå¾ˆå°‘ï¼Œå¦‚æœä½ èƒ½åœ¨é¢è¯•ä¸­è¡¥å…… Redis 6.0 å¤šçº¿ç¨‹çš„åŸç†ï¼ŒåŠ¿å¿…ä¼šå¢åŠ é¢è¯•å®˜å¯¹ä½ çš„è®¤å¯ã€‚

ä½ å¯ä»¥åœ¨é¢è¯•ä¸­è¿™æ ·è¡¥å……ï¼š

è™½ç„¶ Redis ä¸€ç›´æ˜¯å•çº¿ç¨‹æ¨¡å‹ï¼Œä½†æ˜¯åœ¨ Redis 6.0 ç‰ˆæœ¬ä¹‹åï¼Œä¹Ÿé‡‡ç”¨äº†å¤šä¸ª I/O çº¿ç¨‹æ¥å¤„ç†ç½‘ç»œè¯·æ±‚ï¼Œè¿™æ˜¯å› ä¸ºéšç€ç½‘ç»œç¡¬ä»¶çš„æ€§èƒ½æå‡ï¼ŒRedis çš„æ€§èƒ½ç“¶é¢ˆæœ‰æ—¶ä¼šå‡ºç°åœ¨ç½‘ç»œ I/O çš„å¤„ç†ä¸Šï¼Œæ‰€ä»¥ä¸ºäº†æé«˜ç½‘ç»œè¯·æ±‚å¤„ç†çš„å¹¶è¡Œåº¦ï¼ŒRedis 6.0 å¯¹äºç½‘ç»œè¯·æ±‚é‡‡ç”¨å¤šçº¿ç¨‹æ¥å¤„ç†ã€‚ä½†æ˜¯å¯¹äºè¯»å†™å‘½ä»¤ï¼ŒRedis ä»ç„¶ä½¿ç”¨å•çº¿ç¨‹æ¥å¤„ç†ã€‚



### ğŸ¯ Redis å±äºå•çº¿ç¨‹è¿˜æ˜¯å¤šçº¿ç¨‹ï¼Ÿ

> Redis çš„ **æ ¸å¿ƒç½‘ç»œæ¨¡å‹ä¸å‘½ä»¤æ‰§è¡Œ** é‡‡ç”¨ **å•çº¿ç¨‹**ï¼ˆåŸºäº I/O å¤šè·¯å¤ç”¨ `epoll/kqueue`ï¼‰ï¼Œæ‰€ä»¥ä¸ä¼šå‡ºç°å¤šçº¿ç¨‹å¹¶å‘ä¿®æ”¹æ•°æ®çš„é—®é¢˜ã€‚
>
> **ä½†**ï¼šä» Redis 4.0 å¼€å§‹å¼•å…¥äº†ä¸€äº› **å¤šçº¿ç¨‹è¾…åŠ©åŠŸèƒ½**ï¼ˆæ¯”å¦‚å¼‚æ­¥åˆ é™¤ã€åå°æŒä¹…åŒ–ã€RDB/AOF é‡å†™ï¼‰ï¼Œåˆ° **Redis 6.0 æ‰æ­£å¼å¼•å…¥å¤šçº¿ç¨‹ I/O**ï¼Œç”¨äºå¤„ç†ç½‘ç»œæ•°æ®è¯»å†™ï¼Œå‡å°‘å•çº¿ç¨‹ç“¶é¢ˆã€‚

- çº¿ç¨‹æ¨¡å‹åˆ†ç‰ˆæœ¬

  - â‰¤4.0ï¼šä¸»çº¿ç¨‹å¤„ç†ç½‘ç»œ+å‘½ä»¤ï¼Œåå°æœ‰å°‘é‡BIOçº¿ç¨‹ï¼ˆfsyncã€close/unlinkï¼‰ï¼Œbgsave/aofé‡å†™é€šè¿‡ fork å­è¿›ç¨‹ã€‚

  - 4.xï¼šå¼•å…¥å¼‚æ­¥åˆ é™¤ï¼ˆUNLINKã€flush asyncï¼‰ï¼Œä½†å‘½ä»¤ä¸I/Oä»ç”±ä¸»çº¿ç¨‹ã€‚

  - â‰¥6.0ï¼šI/O å¤šçº¿ç¨‹ï¼ˆio-threadsï¼‰åˆ†æ‘Šâ€œè¯»å–è¯·æ±‚/å†™å›å“åº”â€çš„å¼€é”€ï¼›ä¸»çº¿ç¨‹è´Ÿè´£å‘½ä»¤è§£æä¸æ‰§è¡Œï¼Œä¿è¯ä¸€è‡´çš„å†…å­˜è®¿é—®æ¨¡å‹ã€‚

- Reactor æ¨¡å‹
  - å•ä¸ªäº‹ä»¶å¾ªç¯ï¼ˆfile events + time eventsï¼‰ï¼Œç”¨ epoll/kqueue ç­‰ I/O å¤šè·¯å¤ç”¨ç­‰å¾…å°±ç»ª FDï¼Œå›è°ƒé©±åŠ¨å¤„ç†ï¼›è¿™è®©â€œå•æ‰§è¡Œçº¿ç¨‹â€æ”¯æ’‘é«˜å¹¶å‘ã€‚

- ä¸ºä»€ä¹ˆå¿«ï¼ˆé¢è¯•å®˜é«˜é¢‘ç‚¹ï¼‰

  - å†…å­˜æ“ä½œ+ç´§å‡‘ç»“æ„ï¼ˆlistpack/skiplistï¼‰

  - å•çº¿ç¨‹é¿å…é”ç«äº‰ä¸ä¸Šä¸‹æ–‡åˆ‡æ¢

  - I/O å¤šè·¯å¤ç”¨å‡å°‘é˜»å¡

  - ç®€å•åè®®ï¼ˆRESPï¼‰+æ‰¹é‡/æµæ°´çº¿

- 6.0 I/O çº¿ç¨‹åŸç†ï¼ˆç­”å‡ºå°±åŠ åˆ†ï¼‰

  - è¯»å–è·¯å¾„ï¼šI/O çº¿ç¨‹æŠŠ socket æ•°æ®è¯»å…¥ client bufferï¼Œä¸»çº¿ç¨‹è§£æ+æ‰§è¡Œå‘½ä»¤ã€‚

  - å†™å›è·¯å¾„ï¼šä¸»çº¿ç¨‹ç”Ÿæˆå“åº”åï¼ŒI/O çº¿ç¨‹è´Ÿè´£æŠŠå¤§å“åº”å†™å›å®¢æˆ·ç«¯ï¼Œé™ä½ä¸»çº¿ç¨‹è¢«å¤§åŒ… write é˜»å¡ã€‚

  - é…ç½®è¦ç‚¹ï¼šio-threads Nï¼Œé»˜è®¤åªç”¨äºå†™ï¼›å¼€å¯è¯»ç”¨ io-threads-do-reads yesï¼ˆè¯»å¤šä¸”ç½‘ç»œç“¶é¢ˆæ˜æ˜¾æ—¶å†å¼€ï¼‰ã€‚çº¿ç¨‹ä¸æ˜¯è¶Šå¤šè¶Šå¥½ï¼Œå¸¸è§ 4ï½8ã€‚

- â€œä¸æ˜¯å…¨å•çº¿ç¨‹â€çš„è¡¥å……

  - åå°çº¿ç¨‹/å­è¿›ç¨‹ï¼šAOF fsyncã€RDB/AOF é‡å†™ï¼ˆfork+COWï¼‰ã€UNLINK/lazyfreeã€active defragã€å¤åˆ¶/é›†ç¾¤é€šä¿¡çº¿ç¨‹ç­‰ã€‚

  - è¿™äº›ä¸ä¸»æ‰§è¡Œçº¿ç¨‹è§£è€¦ï¼Œé™ä½ä¸»çº¿ç¨‹åœé¡¿ï¼Œä½† fork æ—¶è¦å…³æ³¨ COW å†…å­˜ä¸IOæŠ–åŠ¨ã€‚


  **ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ**

  å•çº¿ç¨‹ä¼˜åŠ¿ï¼š

    1. é¿å…é”ç«äº‰ï¼šæ— éœ€å¤æ‚çš„å¹¶å‘æ§åˆ¶
    2. ç®€åŒ–å®ç°ï¼šä»£ç é€»è¾‘æ¸…æ™°ï¼Œæ˜“äºç»´æŠ¤
    3. åŸå­æ€§ä¿è¯ï¼šæ‰€æœ‰æ“ä½œå¤©ç„¶åŸå­æ€§
    4. é«˜æ€§èƒ½ï¼šé…åˆI/Oå¤šè·¯å¤ç”¨ï¼Œå•çº¿ç¨‹ä¹Ÿèƒ½å¤„ç†é«˜å¹¶å‘

  å¤šçº¿ç¨‹è¡¥å……ï¼š

    1. I/Oç“¶é¢ˆä¼˜åŒ–ï¼šç½‘ç»œI/Oå¤„ç†èƒ½åŠ›æå‡
    2. åå°ä»»åŠ¡åˆ†ç¦»ï¼šé¿å…é˜»å¡ä¸»çº¿ç¨‹
    3. å……åˆ†åˆ©ç”¨å¤šæ ¸ï¼šåœ¨ä¸å½±å“æ ¸å¿ƒé€»è¾‘çš„å‰æä¸‹æå‡æ€§èƒ½

**è¯¯åŒºæ¾„æ¸…ï¼ˆé¢è¯•å®˜å¸¸æŒ–çš„å‘ï¼‰**

- â€œRedis å¤šçº¿ç¨‹äº†èƒ½å¹¶è¡Œæ‰§è¡Œå‘½ä»¤å—ï¼Ÿâ€ä¸èƒ½ï¼Œå‘½ä»¤ä»æ˜¯ä¸»çº¿ç¨‹ä¸²è¡Œæ‰§è¡Œï¼›I/O æ‰å¹¶å‘ã€‚

- â€œå¼€å¾ˆå¤š I/O çº¿ç¨‹å°±ä¸€å®šæ›´å¿«ï¼Ÿâ€ä¸ä¸€å®šï¼ŒCPU ç«äº‰ã€è°ƒåº¦ä¸ç¼“å­˜å¤±æ•ˆå¯èƒ½é€‚å¾—å…¶åï¼›å…ˆå®šä½ç“¶é¢ˆå†å¼€ã€‚

- â€œå•çº¿ç¨‹åƒä¸æ»¡å¤šæ ¸ï¼Ÿâ€ç”¨é›†ç¾¤/åˆ†ç‰‡æ¨ªå‘æ‰©å±•ï¼›æˆ–å¤šå®ä¾‹å¤šæ ¸äº²å’Œéƒ¨ç½²ã€‚



### ğŸ¯ Rediså¤šè·¯å¤ç”¨ï¼Ÿ

Redisçš„â€œå¤šè·¯å¤ç”¨â€æŒ‡ç”¨ä¸€ä¸ªäº‹ä»¶å¾ªç¯çº¿ç¨‹ï¼Œå€ŸåŠ©å†…æ ¸çš„ I/O å¤ç”¨æ¥å£ï¼ˆLinux ä¸Šä¸»è¦æ˜¯ epollï¼ŒBSD ä¸Šæ˜¯ kqueueï¼‰ï¼ŒåŒæ—¶ç›‘å¬æˆåƒä¸Šä¸‡ä¸ªå¥—æ¥å­—çš„å¯è¯»/å¯å†™äº‹ä»¶ã€‚å°±ç»ªæ‰å¤„ç†ï¼Œéé˜»å¡è¯»å†™ï¼Œé…åˆ Reactor æ¨¡å‹æŠŠç½‘ç»œ I/O çš„å¹¶å‘æ€§å’Œå‘½ä»¤æ‰§è¡Œçš„ä¸²è¡Œæ€§è§£è€¦ã€‚6.0 èµ·å¢åŠ äº† I/O çº¿ç¨‹åŠ é€Ÿâ€œæ”¶å‘æ•°æ®â€ï¼Œä½†â€œå‘½ä»¤è§£æä¸æ‰§è¡Œâ€ä»åœ¨ä¸»çº¿ç¨‹ï¼Œé¿å…å¹¶å‘å…±äº«æ•°æ®çš„å¤æ‚åº¦ã€‚

  ç®€å•æ¥è¯´ï¼š

  - å¤šè·¯ï¼šæŒ‡å¤šä¸ªTCPè¿æ¥ï¼ˆæˆ–å¤šä¸ªChannelï¼‰
  - å¤ç”¨ï¼šæŒ‡å¤ç”¨ä¸€ä¸ªæˆ–å°‘é‡çº¿ç¨‹
  - æ ¸å¿ƒï¼šç”¨ä¸€ä¸ªçº¿ç¨‹ç›‘è§†å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œä¸€æ—¦æŸä¸ªæè¿°ç¬¦å°±ç»ªå°±èƒ½è¿›è¡Œç›¸åº”çš„I/Oæ“ä½œ

ä»¥ä¸‹æ˜¯ Redis å¤šè·¯å¤ç”¨çš„å·¥ä½œåŸç†ï¼š

**1. å¤šè·¯å¤ç”¨ç®€ä»‹**

I/Oå¤šè·¯å¤ç”¨ï¼ŒI/Oå°±æ˜¯æŒ‡çš„æˆ‘ä»¬ç½‘ç»œI/Oï¼Œå¤šè·¯æŒ‡å¤šä¸ªTCPè¿æ¥(æˆ–å¤šä¸ªChannel)ï¼Œå¤ç”¨æŒ‡å¤ç”¨ä¸€ä¸ªæˆ–å°‘é‡çº¿ç¨‹ã€‚ä¸²èµ·æ¥ç†è§£å°±æ˜¯å¾ˆå¤šä¸ªç½‘ç»œI/Oå¤ç”¨ä¸€ä¸ªæˆ–å°‘é‡çš„çº¿ç¨‹æ¥å¤„ç†è¿™äº›è¿æ¥ã€‚

> å¤šè·¯å¤ç”¨æ˜¯ä¸€ç§ I/O å¤ç”¨æŠ€æœ¯ï¼Œå¯ä»¥è®©ä¸€ä¸ªçº¿ç¨‹ç›‘è§†å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼ˆFDï¼‰ï¼Œä¸€æ—¦æŸä¸ªæè¿°ç¬¦å‡†å¤‡å¥½è¿›è¡Œ I/O æ“ä½œï¼ˆå¦‚è¯»æˆ–å†™ï¼‰ï¼Œç¨‹åºå°±å¯ä»¥å¯¹å…¶è¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚è¿™æ ·å¯ä»¥æœ‰æ•ˆåœ°æé«˜ç³»ç»Ÿèµ„æºåˆ©ç”¨ç‡å’Œå¹¶å‘æ€§èƒ½ã€‚
>
> IO å¤šè·¯å¤ç”¨æ˜¯ Redis å¿«é€Ÿå“åº”ä¼—å¤šå®¢æˆ·ç«¯è¯·æ±‚çš„æ ¸å¿ƒæŠ€æœ¯ä¹‹ä¸€ã€‚IO å¤šè·¯å¤ç”¨å…è®¸ Redis åŒæ—¶ç›‘å¬å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼ˆé€šå¸¸æ˜¯ç½‘ç»œå¥—æ¥å­—ï¼‰ï¼Œå½“å…¶ä¸­ä»»ä½•ä¸€ä¸ªæè¿°ç¬¦å°±ç»ªï¼ˆå¯è¯»æˆ–å¯å†™ï¼‰æ—¶ï¼Œç¨‹åºå¯ä»¥è¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚è¿™æ ·å¯ä»¥åœ¨å•çº¿ç¨‹ä¸­é«˜æ•ˆå¤„ç†å¤§é‡å¹¶å‘è¿æ¥ã€‚

**2. Redis ä½¿ç”¨çš„å¤šè·¯å¤ç”¨æœºåˆ¶**

Redis æ ¹æ®ä¸åŒæ“ä½œç³»ç»Ÿï¼Œé€‰æ‹©æœ€åˆé€‚çš„å¤šè·¯å¤ç”¨æœºåˆ¶ï¼š

- åœ¨ Linux ç³»ç»Ÿä¸Šï¼Œä½¿ç”¨ `epoll`
- åœ¨ BSD ç³»ç»Ÿä¸Šï¼Œä½¿ç”¨ `kqueue`
- åœ¨ Solaris ä¸Šï¼Œä½¿ç”¨ `evport`
- åœ¨å…¶ä»–ä¸€äº›ç³»ç»Ÿä¸Šï¼Œä½¿ç”¨ `select`ï¼šæœ€å¤è€çš„ IO å¤šè·¯å¤ç”¨æŠ€æœ¯ï¼Œæ”¯æŒçš„æ–‡ä»¶æè¿°ç¬¦æ•°é‡æœ‰é™ã€‚

**3. å·¥ä½œæµç¨‹**

  RedisåŸºäºReactoræ¨¡å¼å®ç°äº†æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨(File Event Handler)ï¼Œè¿™ä¸ªå¤„ç†å™¨åŒ…å«4ä¸ªç»„æˆéƒ¨åˆ†ï¼š

    1. å¤šä¸ªå¥—æ¥å­—(Socket)ï¼šå®¢æˆ·ç«¯è¿æ¥
    2. I/Oå¤šè·¯å¤ç”¨ç¨‹åºï¼šç›‘å¬å¤šä¸ªå¥—æ¥å­—çš„äº‹ä»¶
    3. æ–‡ä»¶äº‹ä»¶åˆ†æ´¾å™¨ï¼šå°†å°±ç»ªçš„äº‹ä»¶åˆ†é…ç»™å¯¹åº”çš„å¤„ç†å™¨
    4. äº‹ä»¶å¤„ç†å™¨ï¼šå¤„ç†å…·ä½“çš„ä¸šåŠ¡é€»è¾‘

ä»¥ä¸‹æ˜¯ Redis ä½¿ç”¨å¤šè·¯å¤ç”¨çš„å·¥ä½œæµç¨‹ï¼š

```
  [å®¢æˆ·ç«¯1] â”€â”€â”
  [å®¢æˆ·ç«¯2] â”€â”€â”¼â”€â†’ [I/Oå¤šè·¯å¤ç”¨ç¨‹åº] â”€â”€â†’ [äº‹ä»¶åˆ†æ´¾å™¨] â”€â”€â†’ [äº‹ä»¶å¤„ç†å™¨]
  [å®¢æˆ·ç«¯3] â”€â”€â”˜     (epoll/select)        (å•çº¿ç¨‹é˜Ÿåˆ—)         (å‘½ä»¤æ‰§è¡Œ)
```

1. **åˆå§‹åŒ–äº‹ä»¶å¾ªç¯**ï¼š Redis åœ¨å¯åŠ¨æ—¶ä¼šåˆå§‹åŒ–ä¸€ä¸ªäº‹ä»¶å¾ªç¯ï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ªäº‹ä»¶è¡¨ï¼Œç”¨äºè®°å½•æ‰€æœ‰éœ€è¦ç›‘è§†çš„æ–‡ä»¶æè¿°ç¬¦åŠå…¶ç›¸å…³çš„äº‹ä»¶ï¼ˆå¦‚å¯è¯»ã€å¯å†™ï¼‰ã€‚
2. **æ³¨å†Œäº‹ä»¶**ï¼š å½“ Redis éœ€è¦ç›‘è§†æŸä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼ˆå¦‚æ–°å®¢æˆ·ç«¯è¿æ¥æˆ–ç°æœ‰å®¢æˆ·ç«¯çš„è¯»å†™æ“ä½œï¼‰æ—¶ï¼Œä¼šå°†è¯¥æè¿°ç¬¦åŠå…¶äº‹ä»¶ç±»å‹ï¼ˆå¦‚è¯»ã€å†™ï¼‰æ³¨å†Œåˆ°äº‹ä»¶è¡¨ä¸­ã€‚
3. **ç­‰å¾…äº‹ä»¶è§¦å‘**ï¼š Redis ä½¿ç”¨å¤šè·¯å¤ç”¨å‡½æ•°ï¼ˆå¦‚ `epoll_wait`ã€`kqueue` æˆ– `select`ï¼‰ç­‰å¾…æ³¨å†Œçš„æ–‡ä»¶æè¿°ç¬¦ä¸Šæœ‰äº‹ä»¶å‘ç”Ÿã€‚è¿™ä¸ªå‡½æ•°ä¼šé˜»å¡ï¼Œç›´åˆ°è‡³å°‘æœ‰ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦å‡†å¤‡å¥½è¿›è¡Œ I/O æ“ä½œã€‚
4. **å¤„ç†äº‹ä»¶**ï¼š ä¸€æ—¦å¤šè·¯å¤ç”¨å‡½æ•°è¿”å›ï¼ŒRedis ä¼šéå†è§¦å‘äº‹ä»¶çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå¹¶å¯¹å…¶è¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚è¿™å¯èƒ½åŒ…æ‹¬è¯»å–å®¢æˆ·ç«¯è¯·æ±‚ã€å‘å®¢æˆ·ç«¯å‘é€å“åº”ã€æ¥å—æ–°çš„è¿æ¥ç­‰ã€‚
5. **äº‹ä»¶å¤„ç†å®Œæ¯•åç»§ç»­ç­‰å¾…**ï¼š å¤„ç†å®Œæ‰€æœ‰è§¦å‘çš„äº‹ä»¶åï¼ŒRedis ä¼šå†æ¬¡è°ƒç”¨å¤šè·¯å¤ç”¨å‡½æ•°ï¼Œç»§ç»­ç­‰å¾…æ–°çš„äº‹ä»¶å‘ç”Ÿã€‚

**4. ä¼˜ç‚¹**

Redis ä½¿ç”¨å¤šè·¯å¤ç”¨çš„ä¼˜ç‚¹åŒ…æ‹¬ï¼š

- **é«˜æ•ˆæ€§**ï¼šå¯ä»¥é«˜æ•ˆåœ°ç›‘è§†å¤§é‡çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå¹¶ä¸”åªåœ¨æœ‰äº‹ä»¶å‘ç”Ÿæ—¶æ‰è¿›è¡Œå¤„ç†ï¼Œé¿å…äº†è½®è¯¢æ–¹å¼çš„é«˜å¼€é”€ã€‚
- **å•çº¿ç¨‹æ¨¡å‹**ï¼šé€šè¿‡å¤šè·¯å¤ç”¨ï¼ŒRedis èƒ½å¤Ÿåœ¨å•çº¿ç¨‹ä¸­é«˜æ•ˆåœ°å¤„ç†å¤§é‡çš„å¹¶å‘è¿æ¥ï¼Œç®€åŒ–äº†ç¼–ç¨‹æ¨¡å‹å’Œçº¿ç¨‹é—´åŒæ­¥é—®é¢˜ã€‚
- **è·¨å¹³å°æ€§**ï¼šRedis å°è£…äº†å¤šç§æ“ä½œç³»ç»Ÿçš„å¤šè·¯å¤ç”¨æœºåˆ¶ï¼Œä½¿å…¶å¯ä»¥åœ¨ä¸åŒå¹³å°ä¸Šé«˜æ•ˆè¿è¡Œã€‚



### ğŸ¯ ä¸ºä»€ä¹ˆæ—©æœŸç‰ˆæœ¬çš„ Redis é€‰æ‹©å•çº¿ç¨‹ï¼Ÿ

å®˜æ–¹FAQè¡¨ç¤ºï¼Œå› ä¸ºRedisæ˜¯åŸºäºå†…å­˜çš„æ“ä½œï¼ŒCPUä¸æ˜¯Redisçš„ç“¶é¢ˆï¼ŒRedis çš„ç“¶é¢ˆæœ€æœ‰å¯èƒ½æ˜¯æœºå™¨å†…å­˜çš„å¤§å°æˆ–è€…ç½‘ç»œå¸¦å®½ã€‚æ—¢ç„¶å•çº¿ç¨‹å®¹æ˜“å®ç°ï¼Œè€Œä¸” CPU ä¸ä¼šæˆä¸ºç“¶é¢ˆï¼Œé‚£å°±é¡ºç†æˆç« åœ°é‡‡ç”¨å•çº¿ç¨‹çš„æ–¹æ¡ˆäº†ï¼ˆæ¯•ç«Ÿé‡‡ç”¨å¤šçº¿ç¨‹ä¼šæœ‰å¾ˆå¤šéº»çƒ¦ï¼ï¼‰ã€‚

çœ‹åˆ°è¿™é‡Œï¼Œä½ å¯èƒ½ä¼šæ°”å“­ï¼æœ¬ä»¥ä¸ºä¼šæœ‰ä»€ä¹ˆé‡å¤§çš„æŠ€æœ¯è¦ç‚¹æ‰ä½¿å¾—Redisä½¿ç”¨å•çº¿ç¨‹å°±å¯ä»¥è¿™ä¹ˆå¿«ï¼Œæ²¡æƒ³åˆ°å°±æ˜¯ä¸€å¥å®˜æ–¹çœ‹ä¼¼ç³Šå¼„æˆ‘ä»¬çš„å›ç­”ï¼ä½†æ˜¯ï¼Œæˆ‘ä»¬å·²ç»å¯ä»¥å¾ˆæ¸…æ¥šçš„è§£é‡Šäº†ä¸ºä»€ä¹ˆ Redis è¿™ä¹ˆå¿«ï¼Œå¹¶ä¸”æ­£æ˜¯ç”±äºåœ¨å•çº¿ç¨‹æ¨¡å¼çš„æƒ…å†µä¸‹å·²ç»å¾ˆå¿«äº†ï¼Œå°±æ²¡æœ‰å¿…è¦åœ¨ä½¿ç”¨å¤šçº¿ç¨‹äº†ï¼

**ç®€å•æ€»ç»“ä¸€ä¸‹**

1. ä½¿ç”¨å•çº¿ç¨‹æ¨¡å‹èƒ½å¸¦æ¥æ›´å¥½çš„å¯ç»´æŠ¤æ€§ï¼Œæ–¹ä¾¿å¼€å‘å’Œè°ƒè¯•ï¼›
2. ä½¿ç”¨å•çº¿ç¨‹æ¨¡å‹ä¹Ÿèƒ½å¹¶å‘çš„å¤„ç†å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼›
3. Redis æœåŠ¡ä¸­è¿è¡Œçš„ç»å¤§å¤šæ•°æ“ä½œçš„æ€§èƒ½ç“¶é¢ˆéƒ½ä¸æ˜¯ CPUï¼›

è¿™é‡Œæˆ‘ä»¬ä¸€ç›´åœ¨å¼ºè°ƒçš„å•çº¿ç¨‹ï¼Œåªæ˜¯åœ¨å¤„ç†æˆ‘ä»¬çš„ç½‘ç»œè¯·æ±‚çš„æ—¶å€™åªæœ‰ä¸€ä¸ªçº¿ç¨‹æ¥å¤„ç†ï¼Œä¸€ä¸ªæ­£å¼çš„ Redis Server è¿è¡Œçš„æ—¶å€™è‚¯å®šæ˜¯ä¸æ­¢ä¸€ä¸ªçº¿ç¨‹çš„ï¼Œè¿™é‡Œéœ€è¦å¤§å®¶æ˜ç¡®çš„æ³¨æ„ä¸€ä¸‹ï¼ä¾‹å¦‚ Redis è¿›è¡ŒæŒä¹…åŒ–çš„æ—¶å€™ä¼šä»¥å­è¿›ç¨‹æˆ–è€…å­çº¿ç¨‹çš„æ–¹å¼æ‰§è¡Œï¼›

Redis é€‰æ‹©ä½¿ç”¨å•çº¿ç¨‹æ¨¡å‹å¤„ç†å®¢æˆ·ç«¯çš„è¯·æ±‚ä¸»è¦è¿˜æ˜¯å› ä¸º CPU ä¸æ˜¯ Redis æœåŠ¡å™¨çš„ç“¶é¢ˆï¼Œæ‰€ä»¥ä½¿ç”¨å¤šçº¿ç¨‹æ¨¡å‹å¸¦æ¥çš„æ€§èƒ½æå‡å¹¶ä¸èƒ½æŠµæ¶ˆå®ƒå¸¦æ¥çš„å¼€å‘æˆæœ¬å’Œç»´æŠ¤æˆæœ¬ï¼Œç³»ç»Ÿçš„æ€§èƒ½ç“¶é¢ˆä¹Ÿä¸»è¦åœ¨ç½‘ç»œ I/O æ“ä½œä¸Šï¼›

è€Œ Redis å¼•å…¥å¤šçº¿ç¨‹æ“ä½œä¹Ÿæ˜¯å‡ºäºæ€§èƒ½ä¸Šçš„è€ƒè™‘ï¼Œå¯¹äºä¸€äº›å¤§é”®å€¼å¯¹çš„åˆ é™¤æ“ä½œï¼Œé€šè¿‡å¤šçº¿ç¨‹éé˜»å¡åœ°é‡Šæ”¾å†…å­˜ç©ºé—´ä¹Ÿèƒ½å‡å°‘å¯¹ Redis ä¸»çº¿ç¨‹é˜»å¡çš„æ—¶é—´ï¼Œæé«˜æ‰§è¡Œçš„æ•ˆç‡ã€‚

åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹å¯ä»¥åˆ©ç”¨å¤šä¸ªçº¿ç¨‹ å¹¶å‘å¤„ç† IO ä»»åŠ¡ã€å‘½ä»¤è§£æå’Œæ•°æ®å›å†™ã€‚è¿™äº›çº¿ç¨‹ä¹Ÿè¢«å«åš IO çº¿ç¨‹ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå¤šçº¿ç¨‹æ¨¡å¼æ˜¯è¢«ç¦ç”¨äº†çš„ï¼Œéœ€è¦æ˜¾å¼åœ°å¼€å¯ã€‚

> æ¨èé˜…è¯»ï¼šhttps://draveness.me/whys-the-design-redis-single-thread/



### ğŸ¯ Redis å’Œ Memcached çš„åŒºåˆ«ï¼Ÿ

1. å­˜å‚¨æ–¹å¼ä¸Šï¼šmemcache ä¼šæŠŠæ•°æ®å…¨éƒ¨å­˜åœ¨å†…å­˜ä¹‹ä¸­ï¼Œæ–­ç”µåä¼šæŒ‚æ‰ï¼Œæ•°æ®ä¸èƒ½è¶…è¿‡å†…å­˜å¤§å°ã€‚redis æœ‰éƒ¨åˆ†æ•°æ®å­˜åœ¨ç¡¬ç›˜ä¸Šï¼Œè¿™æ ·èƒ½ä¿è¯æ•°æ®çš„æŒä¹…æ€§ã€‚
2. æ•°æ®æ”¯æŒç±»å‹ä¸Šï¼šmemcache å¯¹æ•°æ®ç±»å‹çš„æ”¯æŒç®€å•ï¼Œåªæ”¯æŒç®€å•çš„ key-valueï¼Œè€Œ redis æ”¯æŒäº”ç§æ•°æ®ç±»å‹ã€‚
3. ä½¿ç”¨åº•å±‚æ¨¡å‹ä¸åŒï¼šå®ƒä»¬ä¹‹é—´åº•å±‚å®ç°æ–¹å¼ä»¥åŠä¸å®¢æˆ·ç«¯ä¹‹é—´é€šä¿¡çš„åº”ç”¨åè®®ä¸ä¸€æ ·ã€‚redis ç›´æ¥è‡ªå·±æ„å»ºäº† VM æœºåˆ¶ï¼Œå› ä¸ºä¸€èˆ¬çš„ç³»ç»Ÿè°ƒç”¨ç³»ç»Ÿå‡½æ•°çš„è¯ï¼Œä¼šæµªè´¹ä¸€å®šçš„æ—¶é—´å»ç§»åŠ¨å’Œè¯·æ±‚ã€‚
4. value çš„å¤§å°ï¼šredis å¯ä»¥è¾¾åˆ° 512Mï¼Œè€Œ memcache åªæœ‰ 1Mã€‚



### ğŸ¯ key æœ€å¤§æ˜¯å¤šå°‘ ï¼Œå•ä¸ªå®ä¾‹æœ€å¤šæ”¯æŒå¤šå°‘ä¸ªkeyï¼Ÿ

Redis å¯¹é”®ï¼ˆkeyï¼‰çš„æœ€å¤§é•¿åº¦å’Œå•ä¸ªå®ä¾‹æœ€å¤šæ”¯æŒçš„é”®æ•°é‡æœ‰æ˜ç¡®çš„é™åˆ¶ã€‚ä¸‹é¢è¯¦ç»†è§£é‡Šè¿™äº›é™åˆ¶ï¼š

1. é”®ï¼ˆKeyï¼‰çš„æœ€å¤§é•¿åº¦

â€‹	Redis å¯¹æ¯ä¸ªé”®çš„æœ€å¤§é•¿åº¦æœ‰ä¸¥æ ¼çš„é™åˆ¶ã€‚æ ¹æ® Redis çš„å®˜æ–¹æ–‡æ¡£ï¼šé”®çš„æœ€å¤§é•¿åº¦ä¸º 512 MBï¼ˆ512 * 1024 * 1024 bytesï¼‰ã€‚

â€‹	è™½ç„¶ Redis å…è®¸éå¸¸é•¿çš„é”®ï¼Œä½†åœ¨å®é™…åº”ç”¨ä¸­å»ºè®®é¿å…ä½¿ç”¨è¿‡é•¿çš„é”®ï¼Œä»¥æé«˜å†…å­˜åˆ©ç”¨æ•ˆç‡å’Œæ“ä½œæ€§èƒ½ã€‚

2. å•ä¸ªå®ä¾‹æœ€å¤šæ”¯æŒçš„é”®æ•°é‡

   Redis æ˜¯ä¸€ä¸ªå†…å­˜æ•°æ®åº“ï¼Œç†è®ºä¸Šå®ƒå¯ä»¥å­˜å‚¨çš„é”®æ•°é‡æ²¡æœ‰ä¸¥æ ¼çš„ä¸Šé™ï¼Œå–å†³äºå¯ç”¨å†…å­˜å’Œç³»ç»Ÿçš„é™åˆ¶ã€‚ç„¶è€Œï¼Œå®é™…åº”ç”¨ä¸­å•ä¸ªå®ä¾‹çš„é”®æ•°é‡ä¼šå—åˆ°ä»¥ä¸‹å› ç´ çš„é™åˆ¶ï¼š

   - å†…å­˜é™åˆ¶

     Redis å­˜å‚¨çš„æ•°æ®éƒ½åœ¨å†…å­˜ä¸­ï¼Œå› æ­¤å¯ç”¨å†…å­˜æ˜¯å†³å®šå•ä¸ªå®ä¾‹èƒ½å­˜å‚¨å¤šå°‘é”®çš„ä¸»è¦å› ç´ ã€‚Redis å¯ä»¥ä½¿ç”¨çš„æœ€å¤§å†…å­˜é‡å–å†³äºæœºå™¨çš„ç‰©ç†å†…å­˜å’Œ Redis çš„é…ç½®ã€‚

     **é…ç½®æœ€å¤§å†…å­˜**ï¼šé€šè¿‡é…ç½® `maxmemory` å‚æ•°ï¼Œå¯ä»¥é™åˆ¶ Redis ä½¿ç”¨çš„æœ€å¤§å†…å­˜é‡ã€‚ä¾‹å¦‚ï¼Œåœ¨ redis.conf æ–‡ä»¶ä¸­è®¾ç½®ï¼š`maxmemory 4GB`

     è¿™å°†é™åˆ¶ Redis ä½¿ç”¨çš„æœ€å¤§å†…å­˜ä¸º 4 GBã€‚å½“è¾¾åˆ°è¿™ä¸ªé™åˆ¶æ—¶ï¼Œå¯ä»¥é€šè¿‡ `maxmemory-policy` å‚æ•°é…ç½®å†…å­˜æ·˜æ±°ç­–ç•¥ï¼Œå¦‚ LRUï¼ˆLeast Recently Usedï¼‰ã€LFUï¼ˆLeast Frequently Usedï¼‰ã€ALLKEYS-RANDOM ç­‰ã€‚

   - æ•°æ®ç»“æ„çš„å†…å­˜å¼€é”€

     ä¸åŒçš„æ•°æ®ç»“æ„ï¼ˆå¦‚å­—ç¬¦ä¸²ã€å“ˆå¸Œã€åˆ—è¡¨ã€é›†åˆã€æœ‰åºé›†åˆï¼‰åœ¨ Redis ä¸­çš„å†…å­˜å¼€é”€ä¸åŒã€‚æ¯ä¸ªé”®å€¼å¯¹çš„å­˜å‚¨ä¸ä»…åŒ…æ‹¬é”®å’Œå€¼çš„å®é™…å†…å®¹ï¼Œè¿˜åŒ…æ‹¬ Redis å†…éƒ¨ç»´æŠ¤çš„æ•°æ®ç»“æ„ï¼ˆå¦‚å“ˆå¸Œè¡¨èŠ‚ç‚¹ã€æŒ‡é’ˆç­‰ï¼‰çš„å¼€é”€ã€‚

Redis å†…éƒ¨å®ç°é™åˆ¶

è™½ç„¶ Redis æ²¡æœ‰æ˜ç¡®é™åˆ¶å•ä¸ªå®ä¾‹çš„æœ€å¤§é”®æ•°é‡ï¼Œä½† Redis çš„å“ˆå¸Œè¡¨å®ç°æœ‰é»˜è®¤çš„åˆå§‹å¤§å°å’Œæ‰©å±•ç­–ç•¥ï¼š

- **åˆå§‹å“ˆå¸Œè¡¨å¤§å°**ï¼šRedis é»˜è®¤åˆå§‹åŒ–çš„å“ˆå¸Œè¡¨å¤§å°è¾ƒå°ï¼Œä½†ä¼šæ ¹æ®é”®æ•°é‡è‡ªåŠ¨æ‰©å±•ã€‚

- **æ‰©å±•ç­–ç•¥**ï¼šRedis ä½¿ç”¨æ¸è¿›å¼ rehashing æ¥æ‰©å±•å“ˆå¸Œè¡¨ï¼Œä»¥å‡å°‘æ‰©å±•è¿‡ç¨‹ä¸­å¯¹æ€§èƒ½çš„å½±å“ã€‚

  

### ğŸ¯ ä¸ºä»€ä¹ˆ Redis ä¸å»ºè®® key å¤ªé•¿ï¼ŒåŸç†ï¼Ÿ

Redis çš„é”®ï¼ˆkeyï¼‰è®¾è®¡ä¸å»ºè®®å¤ªé•¿ï¼Œè¿™ä¸»è¦æ˜¯å‡ºäºä»¥ä¸‹å‡ ä¸ªæ–¹é¢çš„è€ƒè™‘ï¼š

1. **å†…å­˜ä½¿ç”¨æ•ˆç‡**ï¼š
   - Redis çš„é”®å’Œå€¼åœ¨å†…å­˜ä¸­æ˜¯æˆå¯¹å­˜å‚¨çš„ã€‚é”®è¿‡é•¿æ„å‘³ç€æ¯ä¸ªé”®å€¼å¯¹å ç”¨çš„å†…å­˜ç©ºé—´ä¼šå¢åŠ ï¼Œè¿™ä¼šé™ä½å†…å­˜çš„ä½¿ç”¨æ•ˆç‡ã€‚
   - è¾ƒé•¿çš„é”®åä¼šå¢åŠ å†…å­˜å ç”¨ï¼Œå› ä¸º Redis éœ€è¦ä¸ºæ¯ä¸ªé”®åˆ†é…é¢å¤–çš„å†…å­˜ç©ºé—´æ¥å­˜å‚¨é”®åã€‚
2. **æ€§èƒ½å½±å“**ï¼š
   - é”®çš„æŸ¥æ‰¾ã€å­˜å‚¨å’Œåˆ é™¤æ“ä½œéƒ½éœ€è¦å¯¹é”®åè¿›è¡Œå¤„ç†ã€‚é”®åè¾ƒé•¿ä¼šå¢åŠ è¿™äº›æ“ä½œçš„æ‰§è¡Œæ—¶é—´ï¼Œä»è€Œå½±å“æ€§èƒ½ã€‚
   - ç‰¹åˆ«æ˜¯å½“ä½¿ç”¨å…·æœ‰å‰ç¼€æˆ–æ¨¡å¼åŒ¹é…çš„é”®è¿›è¡Œæ“ä½œæ—¶ï¼Œå¦‚ `keys` å‘½ä»¤æˆ– `SCAN` å‘½ä»¤ï¼Œé•¿é”®åä¼šå¢åŠ å¤„ç†æ—¶é—´ï¼Œå½±å“æ€§èƒ½ã€‚
3. **ç½‘ç»œä¼ è¾“æ•ˆç‡**ï¼š
   - åœ¨å®¢æˆ·ç«¯ä¸ Redis æœåŠ¡å™¨ä¹‹é—´ä¼ è¾“æ•°æ®æ—¶ï¼Œé”®åä¹Ÿæ˜¯éœ€è¦ä¼ è¾“çš„ä¸€éƒ¨åˆ†ã€‚é”®åè¾ƒé•¿ä¼šå¢åŠ ç½‘ç»œä¼ è¾“çš„æ•°æ®é‡ï¼Œé™ä½ä¼ è¾“æ•ˆç‡ã€‚
4. **å¯è¯»æ€§å’Œç»´æŠ¤æ€§**ï¼š
   - è¾ƒçŸ­çš„é”®åé€šå¸¸æ›´æ˜“äºç†è§£å’Œç»´æŠ¤ã€‚é•¿é”®åå¯èƒ½ä¼šä½¿å¾—ä»£ç æ›´éš¾é˜…è¯»ï¼Œä¹Ÿæ›´å®¹æ˜“å‡ºé”™ã€‚
   - ä½¿ç”¨æœ‰æ„ä¹‰çš„çŸ­é”®åå¯ä»¥æé«˜ä»£ç çš„å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚
5. **æ•£åˆ—ç®—æ³•çš„å½±å“**ï¼š
   - Redis ä½¿ç”¨å“ˆå¸Œè¡¨æ¥å­˜å‚¨é”®å€¼å¯¹ï¼Œé•¿é”®ååœ¨å“ˆå¸Œç®—æ³•ä¸­å¯èƒ½ä¼šäº§ç”Ÿæ›´å¤šçš„å†²çªï¼Œè¿™ä¼šå¢åŠ å¤„ç†å“ˆå¸Œå†²çªçš„å¤æ‚æ€§ã€‚
6. **é™åˆ¶å’Œé…ç½®**ï¼š
   - Redis å¹¶æ²¡æœ‰ä¸¥æ ¼çš„é”®åé•¿åº¦é™åˆ¶ï¼Œä½†æ˜¯è¿‡é•¿çš„é”®åå¯èƒ½ä¼šå—åˆ°ç‰¹å®š Redis é…ç½®æˆ–å®¢æˆ·ç«¯åº“çš„é™åˆ¶ã€‚
7. **å‘½ä»¤è¡Œå’Œè„šæœ¬å¤„ç†**ï¼š
   - åœ¨ä½¿ç”¨å‘½ä»¤è¡Œå·¥å…·æˆ–ç¼–å†™è‡ªåŠ¨åŒ–è„šæœ¬æ—¶ï¼Œé•¿é”®åå¯èƒ½ä¼šä½¿å¾—å‘½ä»¤è¡Œå˜å¾—å¤æ‚ï¼Œå¢åŠ å‡ºé”™çš„é£é™©ã€‚

å› æ­¤ï¼Œä¸ºäº†ä¼˜åŒ–å†…å­˜ä½¿ç”¨ã€æé«˜æ€§èƒ½ã€ç®€åŒ–å¼€å‘å’Œç»´æŠ¤ï¼Œé€šå¸¸å»ºè®®è®¾è®¡é”®åæ—¶å°½é‡ç®€çŸ­ä¸”å…·æœ‰æè¿°æ€§ã€‚åœ¨å®é™…åº”ç”¨ä¸­ï¼Œå¯ä»¥æ ¹æ®ä¸šåŠ¡é€»è¾‘å’Œéœ€æ±‚æ¥è®¾è®¡åˆé€‚çš„é”®åé•¿åº¦ï¼Œä»¥å¹³è¡¡å¯è¯»æ€§å’Œæ€§èƒ½ã€‚



### ğŸ¯ æœ€åæ€»ç»“ä¸‹ Redis ä¼˜ç¼ºç‚¹

ä¼˜ç‚¹

- **è¯»å†™æ€§èƒ½ä¼˜å¼‚**ï¼Œ Redisèƒ½è¯»çš„é€Ÿåº¦æ˜¯ `110000` æ¬¡/sï¼Œå†™çš„é€Ÿåº¦æ˜¯ `81000` æ¬¡/sã€‚
- **æ”¯æŒæ•°æ®æŒä¹…åŒ–**ï¼Œæ”¯æŒ AOF å’Œ RDB ä¸¤ç§æŒä¹…åŒ–æ–¹å¼ã€‚
- **æ”¯æŒäº‹åŠ¡**ï¼ŒRedis çš„æ‰€æœ‰æ“ä½œéƒ½æ˜¯åŸå­æ€§çš„ï¼ŒåŒæ—¶ Redis è¿˜æ”¯æŒå¯¹å‡ ä¸ªæ“ä½œåˆå¹¶åçš„åŸå­æ€§æ‰§è¡Œã€‚
- **æ•°æ®ç»“æ„ä¸°å¯Œ**ï¼Œé™¤äº†æ”¯æŒ string ç±»å‹çš„ value å¤–è¿˜æ”¯æŒ hashã€setã€zsetã€list ç­‰æ•°æ®ç»“æ„ã€‚
- **æ”¯æŒä¸»ä»å¤åˆ¶**ï¼Œä¸»æœºä¼šè‡ªåŠ¨å°†æ•°æ®åŒæ­¥åˆ°ä»æœºï¼Œå¯ä»¥è¿›è¡Œè¯»å†™åˆ†ç¦»ã€‚

ç¼ºç‚¹

- æ•°æ®åº“ **å®¹é‡å—åˆ°ç‰©ç†å†…å­˜çš„é™åˆ¶**ï¼Œä¸èƒ½ç”¨ä½œæµ·é‡æ•°æ®çš„é«˜æ€§èƒ½è¯»å†™ï¼Œå› æ­¤ Redis é€‚åˆçš„åœºæ™¯ä¸»è¦å±€é™åœ¨è¾ƒå°æ•°æ®é‡çš„é«˜æ€§èƒ½æ“ä½œå’Œè¿ç®—ä¸Šã€‚
- Redis **ä¸å…·å¤‡è‡ªåŠ¨å®¹é”™å’Œæ¢å¤åŠŸèƒ½**ï¼Œä¸»æœºä»æœºçš„å®•æœºéƒ½ä¼šå¯¼è‡´å‰ç«¯éƒ¨åˆ†è¯»å†™è¯·æ±‚å¤±è´¥ï¼Œéœ€è¦ç­‰å¾…æœºå™¨é‡å¯æˆ–è€…æ‰‹åŠ¨åˆ‡æ¢å‰ç«¯çš„ IP æ‰èƒ½æ¢å¤ã€‚
- ä¸»æœºå®•æœºï¼Œå®•æœºå‰æœ‰éƒ¨åˆ†æ•°æ®æœªèƒ½åŠæ—¶åŒæ­¥åˆ°ä»æœºï¼Œåˆ‡æ¢ IP åè¿˜ä¼šå¼•å…¥æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ï¼Œé™ä½äº† **ç³»ç»Ÿçš„å¯ç”¨æ€§**ã€‚
- **Redis è¾ƒéš¾æ”¯æŒåœ¨çº¿æ‰©å®¹**ï¼Œåœ¨é›†ç¾¤å®¹é‡è¾¾åˆ°ä¸Šé™æ—¶åœ¨çº¿æ‰©å®¹ä¼šå˜å¾—å¾ˆå¤æ‚ã€‚ä¸ºé¿å…è¿™ä¸€é—®é¢˜ï¼Œè¿ç»´äººå‘˜åœ¨ç³»ç»Ÿä¸Šçº¿æ—¶å¿…é¡»ç¡®ä¿æœ‰è¶³å¤Ÿçš„ç©ºé—´ï¼Œè¿™å¯¹èµ„æºé€ æˆäº†å¾ˆå¤§çš„æµªè´¹ã€‚

------



## äºŒã€æ•°æ®ç»“æ„ä¸åº•å±‚å®ç°

### ğŸ¯ Redis éƒ½æ”¯æŒå“ªäº›æ•°æ®ç±»å‹

é¦–å…ˆåœ¨ Redis å†…éƒ¨ä¼šä½¿ç”¨ä¸€ä¸ª **RedisObject** å¯¹è±¡æ¥è¡¨ç¤ºæ‰€æœ‰çš„ `key` å’Œ `value`ï¼š

Redis æä¾›äº†äº”ç§åŸºæœ¬æ•°æ®ç±»å‹ï¼ŒStringã€Hashã€Listã€Setã€Zset(sorted setï¼šæœ‰åºé›†åˆ)

> Redis ä¸æ˜¯ç®€å•çš„é”®å€¼å­˜å‚¨ï¼Œå®ƒå®é™…ä¸Šæ˜¯ä¸€ä¸ªæ•°æ®ç»“æ„æœåŠ¡å™¨ï¼Œæ”¯æŒä¸åŒç±»å‹çš„å€¼ã€‚
>
> 1. Stringï¼ˆå­—ç¬¦ä¸²ï¼‰
>   - ç‰¹ç‚¹ï¼šäºŒè¿›åˆ¶å®‰å…¨ï¼Œæœ€å¤§512MB
>   - åº•å±‚å®ç°ï¼šSDSï¼ˆSimple Dynamic Stringï¼‰
>   - åº”ç”¨åœºæ™¯ï¼šç¼“å­˜ã€è®¡æ•°å™¨ã€åˆ†å¸ƒå¼é”ã€åºåˆ—åŒ–å¯¹è±¡å­˜å‚¨
>
>   2. Hashï¼ˆå“ˆå¸Œï¼‰
>   - ç‰¹ç‚¹ï¼šé”®å€¼å¯¹é›†åˆï¼Œç±»ä¼¼äºMap
>   - åº•å±‚å®ç°ï¼šziplistï¼ˆå°æ•°æ®é‡ï¼‰+ hashtableï¼ˆå¤§æ•°æ®é‡ï¼‰
>   - åº”ç”¨åœºæ™¯ï¼šç”¨æˆ·ä¿¡æ¯å­˜å‚¨ã€å¯¹è±¡ç¼“å­˜
>
>   3. Listï¼ˆåˆ—è¡¨ï¼‰
>   - ç‰¹ç‚¹ï¼šæœ‰åºå­—ç¬¦ä¸²åˆ—è¡¨ï¼Œæ”¯æŒåŒç«¯æ“ä½œ
>   - åº•å±‚å®ç°ï¼šquicklistï¼ˆziplist + linkedlist çš„æ··åˆç»“æ„ï¼‰
>   - åº”ç”¨åœºæ™¯ï¼šæ¶ˆæ¯é˜Ÿåˆ—ã€æ—¶é—´çº¿ã€æœ€æ–°åˆ—è¡¨
>
>   4. Setï¼ˆé›†åˆï¼‰
>   - ç‰¹ç‚¹ï¼šæ— åºã€å”¯ä¸€å…ƒç´ é›†åˆ
>   - åº•å±‚å®ç°ï¼šintsetï¼ˆæ•´æ•°ï¼‰+ hashtable
>   - åº”ç”¨åœºæ™¯ï¼šæ ‡ç­¾ç³»ç»Ÿã€å…±åŒå…³æ³¨ã€å»é‡
>
>   5. Zsetï¼ˆæœ‰åºé›†åˆï¼‰
>   - ç‰¹ç‚¹ï¼šæœ‰åºä¸”å”¯ä¸€ï¼Œæ¯ä¸ªæˆå‘˜å…³è”ä¸€ä¸ªscore
>   - åº•å±‚å®ç°ï¼šziplistï¼ˆå°æ•°æ®é‡ï¼‰+ skiplist + hashtable
>   - åº”ç”¨åœºæ™¯ï¼šæ’è¡Œæ¦œã€èŒƒå›´æŸ¥è¯¢ã€ä¼˜å…ˆçº§é˜Ÿåˆ—
>
> é™¤äº†æ”¯æŒæœ€ **åŸºç¡€çš„äº”ç§æ•°æ®ç±»å‹** å¤–ï¼Œè¿˜æ”¯æŒä¸€äº› **é«˜çº§æ•°æ®ç±»å‹**ï¼š
>
> 1. Bitmapï¼ˆä½å›¾ï¼‰
>
>      - æœ¬è´¨ï¼šåŸºäºStringçš„ä½æ“ä½œ
>
>      - åº”ç”¨ï¼šç”¨æˆ·ç­¾åˆ°ã€åœ¨çº¿çŠ¶æ€ã€æƒé™ç³»ç»Ÿã€å¸ƒéš†è¿‡æ»¤å™¨
>
>
>   2. HyperLogLogï¼ˆåŸºæ•°ç»Ÿè®¡ï¼‰
>
>        - ç‰¹ç‚¹ï¼šæ¦‚ç‡ç®—æ³•ï¼Œå›ºå®š12KBå†…å­˜ï¼Œ0.81%æ ‡å‡†è¯¯å·®
>
>        - åº”ç”¨ï¼šUVç»Ÿè®¡ã€å¤§æ•°æ®å»é‡è®¡æ•°
>
>   3. Geospatialï¼ˆåœ°ç†ç©ºé—´ï¼‰
>
>        - åº•å±‚ï¼šåŸºäºZsetï¼Œä½¿ç”¨Geohashç¼–ç 
>
>        - åº”ç”¨ï¼šLBSæœåŠ¡ã€é™„è¿‘çš„äººã€åœ°ç†å›´æ 
>
>   4. Streamsï¼ˆæµï¼‰
>
>        - ç‰¹ç‚¹ï¼šæŒä¹…åŒ–æ—¥å¿—ç»“æ„ï¼Œæ”¯æŒæ¶ˆè´¹è€…ç»„
>
>        - åº”ç”¨ï¼šæ¶ˆæ¯é˜Ÿåˆ—ã€äº‹ä»¶æº¯æºã€å®¡è®¡æ—¥å¿—
>
>   5. Bloom Filterï¼ˆå¸ƒéš†è¿‡æ»¤å™¨ï¼‰
>
>        - ç‰¹ç‚¹ï¼šæ¦‚ç‡å‹æ•°æ®ç»“æ„ï¼Œåˆ¤æ–­å­˜åœ¨æ€§
>
>        - åº”ç”¨ï¼šç¼“å­˜ç©¿é€é˜²æŠ¤ã€URLå»é‡ã€æ¨èç³»ç»Ÿ

ç”±äº Redis æ˜¯åŸºäºæ ‡å‡† C å†™çš„ï¼Œåªæœ‰æœ€åŸºç¡€çš„æ•°æ®ç±»å‹ï¼Œå› æ­¤ Redis ä¸ºäº†æ»¡è¶³å¯¹å¤–ä½¿ç”¨çš„ 5 ç§æ•°æ®ç±»å‹ï¼Œå¼€å‘äº†å±äºè‡ªå·±**ç‹¬æœ‰çš„ä¸€å¥—åŸºç¡€æ•°æ®ç»“æ„**ï¼Œä½¿ç”¨è¿™äº›æ•°æ®ç»“æ„æ¥å®ç°5ç§æ•°æ®ç±»å‹ã€‚

Redisåº•å±‚çš„æ•°æ®ç»“æ„åŒ…æ‹¬ï¼š**ç®€å•åŠ¨æ€æ•°ç»„SDSã€é“¾è¡¨ã€å­—å…¸ã€è·³è·ƒé“¾è¡¨ã€æ•´æ•°é›†åˆã€å‹ç¼©åˆ—è¡¨ã€å¯¹è±¡ã€‚**

Redis ä¸ºäº†å¹³è¡¡ç©ºé—´å’Œæ—¶é—´æ•ˆç‡ï¼Œé’ˆå¯¹ value çš„å…·ä½“ç±»å‹åœ¨åº•å±‚ä¼šé‡‡ç”¨ä¸åŒçš„æ•°æ®ç»“æ„æ¥å®ç°ï¼Œå…¶ä¸­å“ˆå¸Œè¡¨å’Œå‹ç¼©åˆ—è¡¨æ˜¯å¤ç”¨æ¯”è¾ƒå¤šçš„æ•°æ®ç»“æ„ï¼Œå¦‚ä¸‹å›¾å±•ç¤ºäº†å¯¹å¤–æ•°æ®ç±»å‹å’Œåº•å±‚æ•°æ®ç»“æ„ä¹‹é—´çš„æ˜ å°„å…³ç³»ï¼š

![](https://img.starfish.ink/redis/redis-data-types.png)

> æºç ä¸­ï¼Œ`redisObject`ï¼ˆæˆ– `robj`ï¼‰æ˜¯ Redis ç”¨äºè¡¨ç¤ºæ•°æ®å¯¹è±¡çš„æ ¸å¿ƒç»“æ„ã€‚æ¯ä¸€ä¸ª Redis æ•°æ®å¯¹è±¡ï¼Œæ— è®ºæ˜¯å­—ç¬¦ä¸²ã€åˆ—è¡¨ã€é›†åˆã€å“ˆå¸Œè¿˜æ˜¯æœ‰åºé›†åˆï¼Œéƒ½ä¼šè¢«å°è£…åœ¨ä¸€ä¸ª `redisObject` ç»“æ„ä½“ä¸­
>
> ```c
> //ç®€åŒ–ç‰ˆ
> typedef struct redisObject {
>     unsigned type:4;          // æ•°æ®ç±»å‹
>     unsigned encoding:4;      // å¯¹è±¡çš„ç¼–ç æ–¹å¼
>     unsigned lru:LRU_BITS;    // LRU æ—¶é—´ï¼Œç”¨äºå†…å­˜æ·˜æ±°ç­–ç•¥
>     int refcount;             // å¼•ç”¨è®¡æ•°
>     void *ptr;                // æŒ‡å‘å®é™…å­˜å‚¨æ•°æ®çš„æŒ‡é’ˆ
> } robj;
> ```
>
> `redisObject` **å„å­—æ®µè§£æ**
>
> - **type**ï¼šç”¨æ¥æ ‡è¯†å¯¹è±¡çš„æ•°æ®ç±»å‹ï¼ˆå¦‚å­—ç¬¦ä¸²ã€åˆ—è¡¨ã€é›†åˆç­‰ï¼‰ã€‚Redis æ”¯æŒçš„å‡ ç§æ ¸å¿ƒæ•°æ®ç±»å‹åœ¨æºç ä¸­å®šä¹‰ä¸ºå¸¸é‡ï¼Œä¾‹å¦‚ï¼š
>
>   ```c
>   #define OBJ_STRING 0  // å­—ç¬¦ä¸²
>   #define OBJ_LIST 1    // åˆ—è¡¨
>   #define OBJ_SET 2     // é›†åˆ
>   #define OBJ_ZSET 3    // æœ‰åºé›†åˆ
>   #define OBJ_HASH 4    // å“ˆå¸Œè¡¨
>   ```
>
> - **encoding**ï¼šç”¨æ¥æ ‡è¯†å¯¹è±¡çš„å…·ä½“ç¼–ç æ–¹å¼ï¼Œä¹Ÿå°±æ˜¯è¯¥å¯¹è±¡çš„åº•å±‚æ•°æ®ç»“æ„ï¼ˆå¦‚ `intset`, `ziplist`, `hashtable` ç­‰ï¼‰ã€‚å¸¸è§çš„ç¼–ç æ–¹å¼å¦‚ä¸‹ï¼š
>
>   ```c
>   #define OBJ_ENCODING_RAW 0         // æ™®é€šå­—ç¬¦ä¸²ç¼–ç 
>   #define OBJ_ENCODING_INT 1         // æ•´æ•°ç¼–ç 
>   #define OBJ_ENCODING_HT 2          // å“ˆå¸Œè¡¨ç¼–ç 
>   #define OBJ_ENCODING_ZIPMAP 3      // å‹ç¼©åœ°å›¾ç¼–ç ï¼ˆè€ç‰ˆæœ¬ Redisï¼‰
>   #define OBJ_ENCODING_LINKEDLIST 4  // é“¾è¡¨ç¼–ç ï¼ˆæ—§çš„åˆ—è¡¨ç¼–ç ï¼‰
>   #define OBJ_ENCODING_ZIPLIST 5     // å‹ç¼©åˆ—è¡¨ç¼–ç 
>   #define OBJ_ENCODING_INTSET 6      // æ•´æ•°é›†åˆç¼–ç 
>   #define OBJ_ENCODING_SKIPLIST 7    // è·³è¡¨ç¼–ç ï¼ˆç”¨äºæœ‰åºé›†åˆï¼‰
>   #define OBJ_ENCODING_QUICKLIST 8   // å¿«é€Ÿåˆ—è¡¨ç¼–ç ï¼ˆæ–°çš„åˆ—è¡¨ç¼–ç ï¼‰
>   ```
>
> - **lru**ï¼šç”¨äºè®°å½•è¯¥å¯¹è±¡çš„æœ€åè®¿é—®æ—¶é—´ï¼ŒRedis ä½¿ç”¨è¿™ä¸ªå­—æ®µæ¥å®ç°å†…å­˜æ·˜æ±°ç­–ç•¥ï¼ˆLRUï¼Œæœ€è¿‘æœ€å°‘ä½¿ç”¨ç®—æ³•ï¼‰ã€‚åœ¨æ–°çš„ Redis ç‰ˆæœ¬ä¸­ï¼Œå®ƒå¯èƒ½æ”¹ä¸º LRU æˆ– LFUï¼ˆé¢‘ç‡æ·˜æ±°ï¼‰ã€‚
>
> - **refcount**ï¼šå¯¹è±¡çš„å¼•ç”¨è®¡æ•°ã€‚Redis ä½¿ç”¨å¼•ç”¨è®¡æ•°æœºåˆ¶æ¥ç®¡ç†å¯¹è±¡çš„å†…å­˜ã€‚å¦‚æœä¸€ä¸ªå¯¹è±¡çš„å¼•ç”¨è®¡æ•°ä¸º 0ï¼Œåˆ™è¯¥å¯¹è±¡å¯ä»¥è¢«é‡Šæ”¾ã€‚
>
> - **ptr**ï¼šè¿™æ˜¯ä¸€ä¸ªé€šç”¨æŒ‡é’ˆï¼ŒæŒ‡å‘è¯¥å¯¹è±¡å®é™…å­˜å‚¨çš„æ•°æ®ã€‚æ ¹æ® `type` å’Œ `encoding` çš„ä¸åŒï¼Œ`ptr` æŒ‡å‘çš„ç»“æ„ä¹Ÿä¸åŒã€‚ä¾‹å¦‚ï¼š
>
>   - å¯¹äºå­—ç¬¦ä¸²å¯¹è±¡ï¼Œ`ptr` å¯èƒ½æŒ‡å‘çš„æ˜¯ä¸€ä¸ª `sds`ï¼ˆç®€å•åŠ¨æ€å­—ç¬¦ä¸²ï¼‰ã€‚
>   - å¯¹äºåˆ—è¡¨å¯¹è±¡ï¼Œ`ptr` å¯èƒ½æŒ‡å‘çš„æ˜¯ `quicklist`ã€‚
>   - å¯¹äºæœ‰åºé›†åˆå¯¹è±¡ï¼Œ`ptr` å¯èƒ½æŒ‡å‘çš„æ˜¯ `skiplist` æˆ– `ziplist`ã€‚

### ğŸ¯ é‚£ä½ èƒ½è¯´è¯´è¿™äº›æ•°æ®ç±»å‹çš„ä½¿ç”¨æŒ‡ä»¤å—ï¼Ÿ

Stringï¼šå°±æ˜¯åŸºæœ¬çš„ SETã€GETã€MSETã€MGETã€INCRã€DECR

Listï¼šLPUSHã€RPUSHã€LRANGEã€LINDEX

Hashï¼šHSETã€HMSETã€HSETNXã€HKEYSã€HVALS

Setï¼šSADDã€SCARDã€SDIFFã€SREM

SortSetï¼šZADDã€ZCARDã€ZCOUNTã€ZRANGE



### ğŸ¯ Redisçš„æ•°æ®ç»“æ„ï¼Œ å­—ç¬¦ä¸²ç”¨ä»€ä¹ˆå®ç°ï¼Ÿ

Redis ä¸­çš„å­—ç¬¦ä¸²æ•°æ®ç±»å‹å¹¶ä¸æ˜¯ç›´æ¥é€šè¿‡ C å­—ç¬¦ä¸²ï¼ˆä»¥ NULL ç»“å°¾çš„å­—ç¬¦æ•°ç»„ï¼‰æ¥å®ç°çš„ï¼Œè€Œæ˜¯ä½¿ç”¨äº†ä¸€ç§å«åš **SDS (Simple Dynamic String)** çš„æ•°æ®ç»“æ„æ¥å­˜å‚¨å­—ç¬¦ä¸²ã€‚SDS çš„ä¸»è¦ä¼˜åŠ¿åœ¨äºæ”¯æŒå¿«é€Ÿçš„å­—ç¬¦ä¸²æ“ä½œå’Œé«˜æ•ˆçš„å†…å­˜ç®¡ç†ã€‚

SDS ç»“æ„ä¸€èˆ¬åŒ…å«ä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š

- **len**ï¼šå½“å‰å­—ç¬¦ä¸²çš„é•¿åº¦ï¼ˆä¸åŒ…æ‹¬æœ«å°¾çš„ null å­—ç¬¦ï¼‰ã€‚è¿™ä½¿å¾— Redis ä¸éœ€è¦åœ¨æ¯æ¬¡æ“ä½œæ—¶éƒ½éå†æ•´ä¸ªå­—ç¬¦ä¸²æ¥è·å–å…¶é•¿åº¦ã€‚
- **alloc**ï¼šå½“å‰ä¸ºå­—ç¬¦ä¸²åˆ†é…çš„æ€»ç©ºé—´ï¼ˆåŒ…æ‹¬å­—ç¬¦ä¸²æ•°æ®å’Œé¢å¤–çš„å†…å­˜ç©ºé—´ï¼‰ã€‚ç”±äº Redis ä½¿ç”¨çš„æ˜¯åŠ¨æ€åˆ†é…å†…å­˜ï¼Œå› æ­¤å¯ä»¥é¿å…é¢‘ç¹çš„å†…å­˜åˆ†é…å’Œé‡Šæ”¾ã€‚
- **buf**ï¼šå®é™…çš„å­—ç¬¦ä¸²æ•°æ®éƒ¨åˆ†ï¼Œå­˜å‚¨å­—ç¬¦ä¸²çš„å­—ç¬¦æ•°ç»„ã€‚Redis é€šè¿‡è¿™ä¸ªåŒºåŸŸå­˜å‚¨å­—ç¬¦ä¸²çš„å†…å®¹ã€‚



### ğŸ¯ SDS å¦‚ä½•ä¿è¯äºŒè¿›åˆ¶å®‰å…¨ï¼Ÿ

Redis ä¸­çš„ `String` æ˜¯ **äºŒè¿›åˆ¶å®‰å…¨çš„**ï¼Œè¿™æ„å‘³ç€ Redis çš„ `String` å¯ä»¥å­˜å‚¨ä»»ä½•å½¢å¼çš„æ•°æ®ï¼Œä¸ä»…ä»…æ˜¯æ–‡æœ¬ï¼ˆå¦‚ JSONã€äºŒè¿›åˆ¶æ–‡ä»¶ã€å›¾åƒæ•°æ®ã€åºåˆ—åŒ–æ•°æ®ç­‰ï¼‰ã€‚è¿™ä¸€ç‚¹éå¸¸é‡è¦ï¼Œå› ä¸º Redis çš„ `String` ç±»å‹æ²¡æœ‰å¯¹æ•°æ®å†…å®¹çš„é™åˆ¶ï¼Œå¯ä»¥å®‰å…¨åœ°å­˜å‚¨äºŒè¿›åˆ¶æ•°æ®ã€‚

äºŒè¿›åˆ¶å®‰å…¨æ˜¯ä¸€ç§ä¸»è¦ç”¨äºå­—ç¬¦ä¸²æ“ä½œå‡½æ•°ç›¸å…³çš„è®¡ç®—æœºç¼–ç¨‹æœ¯è¯­ã€‚å…¶æè¿°çš„æ˜¯ï¼š**å°†è¾“å…¥ä½œä¸ºåŸå§‹çš„ã€æ— ä»»ä½•ç‰¹æ®Šæ ¼å¼æ„ä¹‰çš„æ•°æ®æµã€‚å¯¹äºæ¯ä¸ªå­—ç¬¦éƒ½å…¬å¹³å¯¹å¾…ï¼Œä¸ç‰¹æ®Šå¤„ç†æŸä¸€ä¸ªå­—ç¬¦**ã€‚

- **ä¸ä¾èµ–äº null å­—ç¬¦**ï¼šä¼ ç»Ÿçš„ C å­—ç¬¦ä¸²ä¾èµ–äº null å­—ç¬¦ï¼ˆ'\0'ï¼‰æ¥è¡¨ç¤ºå­—ç¬¦ä¸²çš„ç»“æŸï¼Œä½† Redis çš„ SDS ä¸ä¾èµ–äº null å­—ç¬¦æ¥ç¡®å®šå­—ç¬¦ä¸²çš„ç»“æŸä½ç½®ã€‚SDS å­˜å‚¨äº†å­—ç¬¦ä¸²çš„å®é™…é•¿åº¦ï¼ˆ`len` å­—æ®µï¼‰ï¼Œå› æ­¤å¯ä»¥æ­£ç¡®å¤„ç†åŒ…å« null å­—ç¬¦çš„äºŒè¿›åˆ¶æ•°æ®ã€‚
- **åŠ¨æ€æ‰©å±•**ï¼šSDS ä¼šæ ¹æ®éœ€è¦åŠ¨æ€åœ°æ‰©å±•å…¶å†…éƒ¨ç¼“å†²åŒºã€‚Redis ä¼šä½¿ç”¨ `alloc` å­—æ®µæ¥è®°å½•å·²åˆ†é…çš„å†…å­˜å¤§å°ã€‚å½“ä½ å‘ SDS ä¸­è¿½åŠ æ•°æ®æ—¶ï¼ŒRedis ä¼šç¡®ä¿åˆ†é…è¶³å¤Ÿçš„å†…å­˜ï¼Œè€Œä¸éœ€è¦æ‹…å¿ƒæ•°æ®çš„ç»ˆæ­¢ç¬¦ã€‚
- **ä¸éœ€è¦äºŒæ¬¡ç¼–ç **ï¼šäºŒè¿›åˆ¶æ•°æ®ç›´æ¥å­˜å‚¨åœ¨ SDS çš„ `buf` åŒºåŸŸå†…ï¼Œä¸éœ€è¦è¿›è¡Œä»»ä½•ç¼–ç æˆ–è½¬æ¢ã€‚å› æ­¤ï¼ŒRedis å¯ä»¥åŸæ ·å­˜å‚¨ä»»æ„äºŒè¿›åˆ¶æ•°æ®ã€‚

> åœ¨æ—©æœŸç‰ˆæœ¬çš„ Redisï¼ˆç‰¹åˆ«æ˜¯åœ¨ 2.x ç‰ˆæœ¬ä¸­ï¼‰ï¼Œ`SDS` æ•°æ®ç»“æ„åŒ…å«äº†ä¸€ä¸ª `free` å­—æ®µï¼Œå®ƒç”¨äºè¡¨ç¤ºå½“å‰å­—ç¬¦ä¸²ç¼“å†²åŒºä¸­æœªä½¿ç”¨çš„å†…å­˜é‡ã€‚
>
> ```C
> struct sdshdr {
>     int len;    // å½“å‰å­—ç¬¦ä¸²çš„é•¿åº¦
>     int free;   // bufæ•°ç»„ä¸­æœªä½¿ç”¨çš„å­—èŠ‚çš„æ•°é‡ï¼ˆå³é¢å¤–çš„åˆ†é…ç©ºé—´ï¼‰
>     char buf[]; // å­—ç¬¦ä¸²å†…å®¹
> };
> ```
>
> åœ¨ç°ä»£ Redisï¼ˆå³ Redis 3.x åŠä¹‹åçš„ç‰ˆæœ¬ï¼‰ä¸­ï¼Œ`SDS` çš„å®ç°å‘ç”Ÿäº†ä¸€äº›å˜åŒ–ï¼Œå°¤å…¶æ˜¯å»é™¤äº† `free` å­—æ®µã€‚
>
> ```C
> struct sdshdr {
>     int len;    // å½“å‰å­—ç¬¦ä¸²çš„é•¿åº¦
>     int alloc;  // åˆ†é…çš„å†…å­˜ç©ºé—´å¤§å°
>     unsigned char buf[];  // å­—ç¬¦ä¸²æ•°æ®
> };
> ```
>
> ç°åœ¨ Redis ä½¿ç”¨ `alloc` å­—æ®µæ¥è¡¨ç¤ºå·²åˆ†é…çš„å†…å­˜ç©ºé—´ï¼Œè€Œä¸å†ä½¿ç”¨ `free`ã€‚`alloc` å­˜å‚¨çš„æ˜¯å½“å‰ä¸ºå­—ç¬¦ä¸²åˆ†é…çš„å†…å­˜çš„æ€»å¤§å°ï¼Œè€Œ `len` è¡¨ç¤ºå·²ç”¨çš„éƒ¨åˆ†ã€‚
>
> ä¸ºä»€ä¹ˆç§»é™¤ `free` å­—æ®µï¼Ÿ
>
> - **æ›´ç®€æ´çš„å†…å­˜ç®¡ç†**ï¼š`alloc` å­—æ®µå¯ä»¥æ›´ç›´æ¥åœ°è¡¨ç¤ºå½“å‰åˆ†é…çš„å†…å­˜å¤§å°ï¼Œç®€åŒ–äº†å†…å­˜ç®¡ç†ã€‚
> - **æƒ°æ€§ç©ºé—´å›æ”¶**ï¼šRedis é‡‡ç”¨äº†æ‡’åŠ è½½å’Œç©ºé—´å›æ”¶æœºåˆ¶ï¼Œé€šè¿‡è¿™ç§æ–¹å¼é¿å…äº†é¢‘ç¹çš„å†…å­˜ç®¡ç†æ“ä½œã€‚



### ğŸ¯ Redis çš„ SDS å’Œ C ä¸­å­—ç¬¦ä¸²ç›¸æ¯”æœ‰ä»€ä¹ˆä¼˜åŠ¿ï¼Ÿ

C è¯­è¨€ä½¿ç”¨äº†ä¸€ä¸ªé•¿åº¦ä¸º `N+1` çš„å­—ç¬¦æ•°ç»„æ¥è¡¨ç¤ºé•¿åº¦ä¸º `N` çš„å­—ç¬¦ä¸²ï¼Œå¹¶ä¸”å­—ç¬¦æ•°ç»„æœ€åä¸€ä¸ªå…ƒç´ æ€»æ˜¯ `\0`ï¼Œè¿™ç§ç®€å•çš„å­—ç¬¦ä¸²è¡¨ç¤ºæ–¹å¼ **ä¸ç¬¦åˆ Redis å¯¹å­—ç¬¦ä¸²åœ¨å®‰å…¨æ€§ã€æ•ˆç‡ä»¥åŠåŠŸèƒ½æ–¹é¢çš„è¦æ±‚**ã€‚

å†æ¥è¯´ C è¯­è¨€å­—ç¬¦ä¸²çš„é—®é¢˜

è¿™æ ·ç®€å•çš„æ•°æ®ç»“æ„å¯èƒ½ä¼šé€ æˆä»¥ä¸‹ä¸€äº›é—®é¢˜ï¼š

- **è·å–å­—ç¬¦ä¸²é•¿åº¦ä¸º O(N) çº§åˆ«çš„æ“ä½œ** â†’ å› ä¸º C ä¸ä¿å­˜æ•°ç»„çš„é•¿åº¦ï¼Œæ¯æ¬¡éƒ½éœ€è¦éå†ä¸€éæ•´ä¸ªæ•°ç»„ï¼›
- ä¸èƒ½å¾ˆå¥½çš„æœç» **ç¼“å†²åŒºæº¢å‡º/å†…å­˜æ³„æ¼** çš„é—®é¢˜ â†’ è·Ÿä¸Šè¿°é—®é¢˜åŸå› ä¸€æ ·ï¼Œå¦‚æœæ‰§è¡Œæ‹¼æ¥ or ç¼©çŸ­å­—ç¬¦ä¸²çš„æ“ä½œï¼Œå¦‚æœæ“ä½œä¸å½“å°±å¾ˆå®¹æ˜“é€ æˆä¸Šè¿°é—®é¢˜ï¼›
- C å­—ç¬¦ä¸² **åªèƒ½ä¿å­˜æ–‡æœ¬æ•°æ®** â†’ å› ä¸º C è¯­è¨€ä¸­çš„å­—ç¬¦ä¸²å¿…é¡»ç¬¦åˆæŸç§ç¼–ç ï¼ˆæ¯”å¦‚ ASCIIï¼‰ï¼Œä¾‹å¦‚ä¸­é—´å‡ºç°çš„ `'\0'` å¯èƒ½ä¼šè¢«åˆ¤å®šä¸ºæå‰ç»“æŸçš„å­—ç¬¦ä¸²è€Œè¯†åˆ«ä¸äº†ï¼›

**Redis å¦‚ä½•è§£å†³çš„ | SDS çš„ä¼˜åŠ¿**

å¦‚æœå»çœ‹ Redis çš„æºç  `sds.h/sdshdr` æ–‡ä»¶ï¼Œä½ ä¼šçœ‹åˆ° SDS å®Œæ•´çš„å®ç°ç»†èŠ‚ï¼Œè¿™é‡Œç®€å•æ¥è¯´ä¸€ä¸‹ Redis å¦‚ä½•è§£å†³çš„ï¼š

1. **å¤šå¢åŠ  len è¡¨ç¤ºå½“å‰å­—ç¬¦ä¸²çš„é•¿åº¦**ï¼šè¿™æ ·å°±å¯ä»¥ç›´æ¥è·å–é•¿åº¦äº†ï¼Œå¤æ‚åº¦ $O(1)$ï¼›
2. **è‡ªåŠ¨æ‰©å±•ç©ºé—´**ï¼šå½“ SDS éœ€è¦å¯¹å­—ç¬¦ä¸²è¿›è¡Œä¿®æ”¹æ—¶ï¼Œé¦–å…ˆå€ŸåŠ©äº `len` å’Œ `alloc` æ£€æŸ¥ç©ºé—´æ˜¯å¦æ»¡è¶³ä¿®æ”¹æ‰€éœ€çš„è¦æ±‚ï¼Œå¦‚æœç©ºé—´ä¸å¤Ÿçš„è¯ï¼ŒSDS ä¼šè‡ªåŠ¨æ‰©å±•ç©ºé—´ï¼Œé¿å…äº†åƒ C å­—ç¬¦ä¸²æ“ä½œä¸­çš„è¦†ç›–æƒ…å†µï¼›
3. **æœ‰æ•ˆé™ä½å†…å­˜åˆ†é…æ¬¡æ•°**ï¼šC å­—ç¬¦ä¸²åœ¨æ¶‰åŠå¢åŠ æˆ–è€…æ¸…é™¤æ“ä½œæ—¶ä¼šæ”¹å˜åº•å±‚æ•°ç»„çš„å¤§å°é€ æˆé‡æ–°åˆ†é…ï¼ŒSDS ä½¿ç”¨äº† **ç©ºé—´é¢„åˆ†é…** å’Œ **æƒ°æ€§ç©ºé—´é‡Šæ”¾** æœºåˆ¶ï¼Œç®€å•ç†è§£å°±æ˜¯æ¯æ¬¡åœ¨æ‰©å±•æ—¶æ˜¯æˆå€çš„å¤šåˆ†é…çš„ï¼Œåœ¨ç¼©å®¹æ˜¯ä¹Ÿæ˜¯å…ˆç•™ç€å¹¶ä¸æ­£å¼å½’è¿˜ç»™ OSï¼›
4. **äºŒè¿›åˆ¶å®‰å…¨**ï¼šC è¯­è¨€å­—ç¬¦ä¸²åªèƒ½ä¿å­˜ `ascii` ç ï¼Œå¯¹äºå›¾ç‰‡ã€éŸ³é¢‘ç­‰ä¿¡æ¯æ— æ³•ä¿å­˜ï¼ŒSDS æ˜¯äºŒè¿›åˆ¶å®‰å…¨çš„ï¼Œå†™å…¥ä»€ä¹ˆè¯»å–å°±æ˜¯ä»€ä¹ˆï¼Œä¸åšä»»ä½•è¿‡æ»¤å’Œé™åˆ¶ï¼›



### ğŸ¯ SDSï¼Œæ•°å­—ç±»å‹çš„è‡ªå¢è‡ªå‡å¦‚ä½•å®ç°?

åœ¨ Redis ä¸­ï¼ŒSDSï¼ˆSimple Dynamic Stringï¼‰æ˜¯ä¸€ç§ç”¨äºå­˜å‚¨å­—ç¬¦ä¸²çš„åŠ¨æ€æ•°æ®ç»“æ„ï¼Œå®ƒè¢«è®¾è®¡ä¸ºäºŒè¿›åˆ¶å®‰å…¨ä¸”èƒ½å¤Ÿé«˜æ•ˆåœ°æ‰§è¡Œå­—ç¬¦ä¸²æ“ä½œã€‚ç„¶è€Œï¼ŒSDS ä¸»è¦ç”¨äºå­˜å‚¨å­—ç¬¦ä¸²æ•°æ®ï¼Œå¹¶ä¸ç›´æ¥ç”¨äºå­˜å‚¨æ•´æ•°å€¼ã€‚Redis ä½¿ç”¨ä¸€ä¸ªä¸“é—¨çš„æ•°æ®ç»“æ„æ¥å­˜å‚¨æ•´æ•°ç±»å‹çš„æ•°æ®ï¼Œè¿™é€šå¸¸æ˜¯ä¸€ä¸ªé•¿æ•´å‹ï¼ˆ`long`ï¼‰å˜é‡ã€‚

å¯¹äºæ•°å­—ç±»å‹çš„è‡ªå¢ï¼ˆINCRï¼‰å’Œè‡ªå‡ï¼ˆDECRï¼‰æ“ä½œï¼ŒRedis å¹¶ä¸æ˜¯é€šè¿‡ SDS å®ç°çš„ï¼Œè€Œæ˜¯é€šè¿‡ä»¥ä¸‹æ–¹å¼ï¼š

1. **å†…å­˜ä¸­çš„æ•´æ•°å€¼**ï¼šRedis çš„å­—ç¬¦ä¸²å¯¹è±¡å†…éƒ¨å¯èƒ½åŒ…å«ä¸€ä¸ªé•¿æ•´å‹ï¼ˆ`long`ï¼‰çš„å€¼ï¼Œå¦‚æœè¯¥å­—ç¬¦ä¸²å¯¹è±¡è¢«ç”¨ä½œè®¡æ•°å™¨ï¼ˆå³é€šè¿‡ INCR æˆ– DECR å‘½ä»¤æ“ä½œï¼‰ã€‚
2. **è‡ªå¢æ“ä½œï¼ˆINCRï¼‰**ï¼šå½“æ‰§è¡Œ INCR å‘½ä»¤æ—¶ï¼ŒRedis ä¼šè·å–å½“å‰é”®å¯¹åº”çš„æ•´æ•°å€¼ï¼Œå°†å…¶åŠ ä¸€ï¼Œç„¶åå°†æ–°çš„æ•´æ•°å€¼æ›´æ–°åˆ°å†…å­˜ä¸­çš„å­—ç¬¦ä¸²å¯¹è±¡ã€‚
3. **è‡ªå‡æ“ä½œï¼ˆDECRï¼‰**ï¼šç±»ä¼¼åœ°ï¼ŒDECR å‘½ä»¤ä¼šè·å–å½“å‰é”®å¯¹åº”çš„æ•´æ•°å€¼ï¼Œå°†å…¶å‡ä¸€ï¼Œå¹¶æ›´æ–°ã€‚
4. **èŒƒå›´æ£€æŸ¥**ï¼šåœ¨æ‰§è¡Œè‡ªå¢æˆ–è‡ªå‡æ“ä½œæ—¶ï¼Œå¦‚æœæ•´æ•°å€¼è¶…å‡ºäº† `long long` ç±»å‹çš„èŒƒå›´ï¼ŒRedis ä¼šå°†å€¼å›ç»•åˆ°è¯¥ç±»å‹çš„æœ€å°å€¼æˆ–æœ€å¤§å€¼ã€‚
5. **æŒä¹…åŒ–**ï¼šå¦‚æœå¯ç”¨äº†æŒä¹…åŒ–ï¼ŒRedis è¿˜ä¼šå°†è‡ªå¢æˆ–è‡ªå‡æ“ä½œçš„ç»“æœåŒæ­¥åˆ°ç£ç›˜ä¸Šçš„ RDB æ–‡ä»¶æˆ– AOF æ—¥å¿—ä¸­ã€‚
6. **äº‹åŠ¡å’ŒåŸå­æ€§**ï¼šè‡ªå¢å’Œè‡ªå‡æ“ä½œæ˜¯åŸå­æ€§çš„ï¼Œå³ä½¿åœ¨å¤šå®¢æˆ·ç«¯å¹¶å‘è®¿é—®çš„æƒ…å†µä¸‹ï¼Œæ¯ä¸ªæ“ä½œéƒ½èƒ½ä¿è¯æ­£ç¡®åœ°æ‰§è¡Œã€‚
7. **å†…å­˜ä¼˜åŒ–**ï¼šå½“å­—ç¬¦ä¸²å¯¹è±¡ä»…ç”¨ä½œè®¡æ•°å™¨æ—¶ï¼ŒRedis ä¼šä½¿ç”¨å†…å­˜æ•ˆç‡æ›´é«˜çš„å†…éƒ¨è¡¨ç¤ºæ¥å­˜å‚¨æ•´æ•°å€¼ã€‚
8. **ç¼–ç è½¬æ¢**ï¼šåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå¦‚æœå­—ç¬¦ä¸²å¯¹è±¡åŒæ—¶åŒ…å«æ–‡æœ¬å’Œæ•°å­—ï¼Œæˆ–è€…æ‰§è¡Œäº†æŸäº›æ“ä½œå¯¼è‡´å­—ç¬¦ä¸²å¯¹è±¡ä¸å†é€‚åˆä½œä¸ºæ•´æ•°å­˜å‚¨ï¼ŒRedis å¯èƒ½ä¼šåœ¨ SDS å’Œæ•´æ•°ä¹‹é—´è½¬æ¢ç¼–ç ã€‚
9. **ä½¿ç”¨åœºæ™¯**ï¼šè‡ªå¢å’Œè‡ªå‡æ“ä½œé€šå¸¸ç”¨äºå®ç°è®¡æ•°å™¨ã€é™åˆ¶é€Ÿç‡ã€ç”Ÿæˆå”¯ä¸€åºåˆ—å·ç­‰åœºæ™¯ã€‚

åœ¨ Redis ä¸­ï¼Œæ•°å­—ç±»å‹çš„è‡ªå¢è‡ªå‡æ“ä½œæ˜¯ç›´æ¥é’ˆå¯¹å†…å­˜ä¸­çš„æ•´æ•°å€¼è¿›è¡Œçš„ï¼Œè€Œä¸æ˜¯é€šè¿‡ SDS æ¥å®ç°ã€‚Redis çš„è®¾è®¡ç¡®ä¿äº†è¿™äº›æ“ä½œçš„æ•ˆç‡å’ŒåŸå­æ€§ï¼Œä½¿å…¶æˆä¸ºæ‰§è¡Œè¿™ç±»æ“ä½œçš„ç†æƒ³é€‰æ‹©ã€‚




### ğŸ¯ è¯´è¯´ List?

Redis åˆ—è¡¨æ˜¯ç®€å•çš„å­—ç¬¦ä¸²åˆ—è¡¨ï¼ŒæŒ‰ç…§æ’å…¥é¡ºåºæ’åºã€‚ä½ å¯ä»¥æ·»åŠ ä¸€ä¸ªå…ƒç´ åˆ°åˆ—è¡¨çš„å¤´éƒ¨ï¼ˆå·¦è¾¹ï¼‰æˆ–è€…å°¾éƒ¨ï¼ˆå³è¾¹ï¼‰ã€‚

- **æœ‰åºé›†åˆ**ï¼šæŒ‰æ’å…¥é¡ºåºæ’åºçš„å­—ç¬¦ä¸²é›†åˆï¼Œæ”¯æŒåŒå‘æ“ä½œ 

- **æ•°æ®ç»“æ„**ï¼šåŸºäºé“¾è¡¨å®ç°ï¼ˆç±»ä¼¼ Java LinkedListï¼‰ï¼Œå…·å¤‡ä»¥ä¸‹ç‰¹æ€§ï¼š

  - **é«˜æ•ˆæ’å…¥åˆ é™¤**ï¼šå¤´å°¾æ“ä½œ O(1) æ—¶é—´å¤æ‚åº¦

  - **ä½æ•ˆéšæœºè®¿é—®**ï¼šç´¢å¼•å®šä½ O(n) æ—¶é—´å¤æ‚åº¦

  - **å¤©ç„¶é˜Ÿåˆ—ç‰¹æ€§**ï¼šå¸¸ç”¨äºå¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—ã€æ¶ˆæ¯æµå¤„ç†ç­‰åœºæ™¯

- **åº•å±‚å®ç°æ¼”è¿›**

  é˜¶æ®µä¸€ï¼šåŒç¼–ç æ¨¡å¼ï¼ˆRedis 3.2 å‰ï¼‰

  åˆ›å»ºæ–°åˆ—è¡¨æ—¶ redis é»˜è®¤ä½¿ç”¨ redis_encoding_ziplist ç¼–ç ï¼Œ å½“ä»¥ä¸‹ä»»æ„ä¸€ä¸ªæ¡ä»¶è¢«æ»¡è¶³æ—¶ï¼Œ åˆ—è¡¨ä¼šè¢«è½¬æ¢æˆ redis_encoding_linkedlist ç¼–ç 

  1. **å‹ç¼©åˆ—è¡¨ï¼ˆziplistï¼‰**
     - **å†…å­˜ä¼˜åŒ–ç»“æ„**ï¼šè¿ç»­å†…å­˜å—å­˜å‚¨ï¼Œæ¯ä¸ªèŠ‚ç‚¹åŒ…å« â–¶ï¸ å‰é©±èŠ‚ç‚¹é•¿åº¦ï¼ˆprevlenï¼‰ â–¶ï¸ å½“å‰èŠ‚ç‚¹ç¼–ç ï¼ˆencodingï¼‰ â–¶ï¸ æ•°æ®å†…å®¹ï¼ˆcontentï¼‰
     - ä¼˜åŠ¿ï¼š
       - æ¶ˆé™¤æŒ‡é’ˆå†…å­˜å¼€é”€ï¼ˆæ¯”ä¼ ç»Ÿé“¾è¡¨èŠ‚çº¦ 50%+ å†…å­˜ï¼‰
       - CPUç¼“å­˜å‹å¥½ï¼ˆå±€éƒ¨æ€§åŸç†ï¼‰
     - **è§¦å‘æ¡ä»¶**ï¼ˆé»˜è®¤å€¼ï¼‰ï¼š `list-max-ziplist-entries 512`ï¼ˆå…ƒç´ æ•°é‡ï¼‰æˆ–  `list-max-ziplist-value 64`ï¼ˆå•ä¸ªå…ƒç´ å­—èŠ‚æ•°ï¼‰

  2. **åŒå‘é“¾è¡¨ï¼ˆlinkedlistï¼‰**

     - **ä¼ ç»Ÿç»“æ„**ï¼šåŒ…å« prev/next æŒ‡é’ˆçš„æ ‡å‡†åŒå‘é“¾è¡¨

     - ä¼˜åŠ¿ï¼š
       - è¶…å¤§å…ƒç´ æ“ä½œæ€§èƒ½ç¨³å®š
       - æ”¯æŒå¿«é€Ÿéå†

  é˜¶æ®µäºŒï¼šæ··åˆç»“æ„ï¼ˆRedis 3.2+ é»˜è®¤ï¼‰

  1. **å¿«é€Ÿåˆ—è¡¨ï¼ˆquicklistï¼‰** å¯ä»¥è®¤ä¸ºquickListï¼Œæ˜¯ ziplist å’Œ linkedlist äºŒè€…çš„ç»“åˆï¼›quickList å°†äºŒè€…çš„ä¼˜ç‚¹ç»“åˆèµ·æ¥ã€‚

     - å®ç°æ–¹å¼ï¼š
       - åŒå‘é“¾è¡¨èŠ‚ç‚¹å­˜å‚¨ ziplist ç‰‡æ®µï¼Œæ¯ä¸€ä¸ªèŠ‚ç‚¹æ˜¯ä¸€ä¸ªquicklistNodeï¼ŒåŒ…å«prevå’ŒnextæŒ‡é’ˆï¼Œæ¯ä¸€ä¸ªquicklistNode åŒ…å« ä¸€ä¸ªziplistï¼Œ*zp å‹ç¼©é“¾è¡¨é‡Œå­˜å‚¨é”®å€¼
       - å•ä¸ª ziplist ç‰‡æ®µå¤§å°é€šè¿‡ `list-max-ziplist-size` é…ç½®ï¼ˆé»˜è®¤ 8KBï¼‰

     - è®¾è®¡ä¼˜åŠ¿ï¼š
       - å†…å­˜åˆ©ç”¨ç‡æ¥è¿‘ ziplist
       - é¿å…è¶…å¤§ziplistçš„å®Œæ•´é‡åˆ†é…é—®é¢˜
       - é€šè¿‡æ§åˆ¶ç‰‡æ®µå¤§å°å¹³è¡¡å†…å­˜ç¢ç‰‡ä¸æ“ä½œæ•ˆç‡

> ##### å‹ç¼©åˆ—è¡¨ziplist
>
> å‹ç¼©åˆ—è¡¨ ziplist æ˜¯ä¸º Redis èŠ‚çº¦å†…å­˜è€Œå¼€å‘çš„ã€‚
> 
>Rediså®˜æ–¹å¯¹äºziplistçš„å®šä¹‰æ˜¯ï¼ˆå‡ºè‡ªziplist.cçš„æ–‡ä»¶å¤´éƒ¨æ³¨é‡Šï¼‰ï¼š
> 
>```text
> /* The ziplist is a specially encoded dually linked list that is designed
>  * to be very memory efficient. It stores both strings and integer values,
>  * where integers are encoded as actual integers instead of a series of
>  * characters. It allows push and pop operations on either side of the list
> * in O(1) time. However, because every operation requires a reallocation of
>  * the memory used by the ziplist, the actual complexity is related to the
> * amount of memory used by the ziplist.
>  *
> ```
> 
> ziplist æ˜¯ç”±ä¸€ç³»åˆ—ç‰¹æ®Šç¼–ç çš„å†…å­˜å—æ„æˆçš„åˆ—è¡¨(åƒå†…å­˜è¿ç»­çš„æ•°ç»„ï¼Œä½†æ¯ä¸ªå…ƒç´ é•¿åº¦ä¸åŒ)ï¼Œ ä¸€ä¸ª ziplist å¯ä»¥åŒ…å«å¤šä¸ªèŠ‚ç‚¹ï¼ˆentryï¼‰ã€‚
>ziplist å°†è¡¨ä¸­æ¯ä¸€é¡¹å­˜æ”¾åœ¨å‰åè¿ç»­çš„åœ°å€ç©ºé—´å†…ï¼Œæ¯ä¸€é¡¹å› å ç”¨çš„ç©ºé—´ä¸åŒï¼Œè€Œé‡‡ç”¨å˜é•¿ç¼–ç ã€‚
> 
>**ziplist æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„åŒå‘é“¾è¡¨**
> ç‰¹æ®Šä¹‹å¤„åœ¨äºï¼šæ²¡æœ‰ç»´æŠ¤åŒå‘æŒ‡é’ˆ:prev nextï¼›è€Œæ˜¯å­˜å‚¨ä¸Šä¸€ä¸ª entryçš„é•¿åº¦å’Œå½“å‰entryçš„é•¿åº¦ï¼Œé€šè¿‡é•¿åº¦æ¨ç®—ä¸‹ä¸€ä¸ªå…ƒç´ åœ¨ä»€ä¹ˆåœ°æ–¹ã€‚
>ç‰ºç‰²è¯»å–çš„æ€§èƒ½ï¼Œè·å¾—é«˜æ•ˆçš„å­˜å‚¨ç©ºé—´ï¼Œå› ä¸º(ç®€çŸ­å­—ç¬¦ä¸²çš„æƒ…å†µ)å­˜å‚¨æŒ‡é’ˆæ¯”å­˜å‚¨entryé•¿åº¦ æ›´è´¹å†…å­˜ã€‚è¿™æ˜¯å…¸å‹çš„â€œæ—¶é—´æ¢ç©ºé—´â€ã€‚



### ğŸ¯ å­—å…¸Hashæ˜¯å¦‚ä½•å®ç°çš„ï¼ŸRehash äº†è§£å—ï¼Ÿ

**Redis** ä¸­çš„å­—å…¸ç›¸å½“äº Java ä¸­çš„ **HashMap**ï¼Œå†…éƒ¨å®ç°ä¹Ÿå·®ä¸å¤šç±»ä¼¼ï¼Œéƒ½æ˜¯é€šè¿‡ **â€œæ•°ç»„ + é“¾è¡¨â€** çš„ **é“¾åœ°å€æ³•** æ¥è§£å†³éƒ¨åˆ†å“ˆå¸Œå†²çªï¼ŒåŒæ—¶è¿™æ ·çš„ç»“æ„ä¹Ÿå¸æ”¶äº†ä¸¤ç§ä¸åŒæ•°æ®ç»“æ„çš„ä¼˜ç‚¹ã€‚

Redis å­—å…¸ç”± **åµŒå¥—çš„ä¸‰å±‚ç»“æ„** æ„æˆï¼Œé‡‡ç”¨é“¾åœ°å€æ³•å¤„ç†å“ˆå¸Œå†²çªï¼š

```c
// å“ˆå¸Œè¡¨ç»“æ„
typedef struct dictht {
    dictEntry **table;       // äºŒç»´æ•°ç»„ï¼ˆå“ˆå¸Œæ¡¶ï¼‰
    unsigned long size;      // æ€»æ§½ä½æ•°ï¼ˆ2^n å¯¹é½ï¼‰
    unsigned long sizemask;  // æ§½ä½æ©ç ï¼ˆsize-1ï¼‰
    unsigned long used;      // å·²ç”¨æ§½ä½æ•°é‡
} dictht;

// å­—å…¸ç»“æ„
typedef struct dict {
    dictType *type;          // ç±»å‹ç‰¹å®šå‡½æ•°ï¼ˆå®ç°å¤šæ€ï¼‰
    void *privdata;          // ç§æœ‰æ•°æ®
    dictht ht[2];            // åŒå“ˆå¸Œè¡¨ï¼ˆç”¨äºæ¸è¿›å¼rehashï¼‰
    long rehashidx;          // rehashè¿›åº¦æ ‡è®°ï¼ˆ-1è¡¨ç¤ºæœªè¿›è¡Œï¼‰
} dict;

// å“ˆå¸ŒèŠ‚ç‚¹ç»“æ„
typedef struct dictEntry {
    void *key;               // é”®ï¼ˆSDSå­—ç¬¦ä¸²ï¼‰
    union {
        void *val;           // å€¼ï¼ˆRediså¯¹è±¡ï¼‰
        uint64_t u64;
        int64_t s64;
    } v;
    struct dictEntry *next;  // é“¾åœ°å€æ³•æŒ‡é’ˆ
} dictEntry;
```

å­—å…¸ç»“æ„å†…éƒ¨åŒ…å« **ä¸¤ä¸ª hashtable**ï¼Œé€šå¸¸æƒ…å†µä¸‹åªæœ‰ä¸€ä¸ª `hashtable` æœ‰å€¼ï¼Œä½†æ˜¯åœ¨å­—å…¸æ‰©å®¹ç¼©å®¹æ—¶ï¼Œéœ€è¦åˆ†é…æ–°çš„ `hashtable`ï¼Œç„¶åè¿›è¡Œ **æ¸è¿›å¼æ¬è¿** *(rehash)*ï¼Œè¿™æ—¶å€™ä¸¤ä¸ª `hashtable` åˆ†åˆ«å­˜å‚¨æ—§çš„å’Œæ–°çš„ `hashtable`ï¼Œå¾…æ¬è¿ç»“æŸåï¼Œæ—§çš„å°†è¢«åˆ é™¤ï¼Œæ–°çš„ `hashtable` å–è€Œä»£ä¹‹ã€‚

**æ‰©ç¼©å®¹çš„æ¡ä»¶**

æ­£å¸¸æƒ…å†µä¸‹ï¼Œå½“ hash è¡¨ä¸­ **å…ƒç´ çš„ä¸ªæ•°ç­‰äºç¬¬ä¸€ç»´æ•°ç»„ï¼ˆç¬¬ä¸€ä¸ªhashtableï¼‰çš„é•¿åº¦æ—¶**ï¼Œå°±ä¼šå¼€å§‹æ‰©å®¹ï¼Œæ‰©å®¹çš„æ–°æ•°ç»„æ˜¯ **åŸæ•°ç»„å¤§å°çš„ 2 å€**ã€‚ä¸è¿‡å¦‚æœ Redis æ­£åœ¨åš `bgsave(æŒä¹…åŒ–å‘½ä»¤)`ï¼Œä¸ºäº†å‡å°‘å†…å­˜è¿‡å¤šåˆ†ç¦»ï¼ŒRedis å°½é‡ä¸å»æ‰©å®¹ï¼Œä½†æ˜¯å¦‚æœ hash è¡¨éå¸¸æ»¡äº†ï¼Œ**è¾¾åˆ°äº†ç¬¬ä¸€ç»´æ•°ç»„é•¿åº¦çš„ 5 å€äº†**ï¼Œè¿™ä¸ªæ—¶å€™å°±ä¼š **å¼ºåˆ¶æ‰©å®¹**ã€‚

å½“ hash è¡¨å› ä¸ºå…ƒç´ é€æ¸è¢«åˆ é™¤å˜å¾—è¶Šæ¥è¶Šç¨€ç–æ—¶ï¼ŒRedis ä¼šå¯¹ hash è¡¨è¿›è¡Œç¼©å®¹æ¥å‡å°‘ hash è¡¨çš„ç¬¬ä¸€ç»´æ•°ç»„ç©ºé—´å ç”¨ã€‚æ‰€ç”¨çš„æ¡ä»¶æ˜¯ **å…ƒç´ ä¸ªæ•°ä½äºæ•°ç»„é•¿åº¦çš„ 10%**ï¼Œç¼©å®¹ä¸ä¼šè€ƒè™‘ Redis æ˜¯å¦åœ¨åš `bgsave`



### ğŸ¯ è¯´è¯´ Zset å§

**å®ƒç±»ä¼¼äº Java çš„ SortedSet å’Œ HashMap çš„ç»“åˆä½“**ï¼Œä¸€æ–¹é¢å®ƒæ˜¯ä¸€ä¸ª setï¼Œä¿è¯äº†å†…éƒ¨ value çš„å”¯ä¸€æ€§ï¼Œå¦ä¸€æ–¹é¢å®ƒå¯ä»¥ç»™æ¯ä¸ª value èµ‹äºˆä¸€ä¸ª scoreï¼Œä»£è¡¨è¿™ä¸ª value çš„æ’åºæƒé‡ã€‚å®ƒçš„å†…éƒ¨å®ç°ç”¨çš„æ˜¯ä¸€ç§å«åšã€Œè·³è·ƒåˆ—è¡¨ã€çš„æ•°æ®ç»“æ„ã€‚

Redis æ­£æ˜¯é€šè¿‡ score æ¥ä¸ºé›†åˆä¸­çš„æˆå‘˜è¿›è¡Œä»å°åˆ°å¤§çš„æ’åºã€‚Zset çš„æˆå‘˜æ˜¯å”¯ä¸€çš„ï¼Œä½† score å´å¯ä»¥é‡å¤ã€‚

Zseté‡‡ç”¨åŒé‡æ•°æ®ç»“æ„è®¾è®¡ï¼ŒåŒæ—¶ä½¿ç”¨ä¸¤ç§æ•°æ®ç»“æ„æ¥ä¼˜åŒ–ä¸åŒæ“ä½œï¼š

1. è·³è·ƒè¡¨ï¼ˆskiplistï¼‰- æ ¸å¿ƒæ’åºç»“æ„

2. å“ˆå¸Œè¡¨ï¼ˆdictï¼‰- å¿«é€ŸæŸ¥æ‰¾ç»“æ„

     - é”®ï¼šæˆå‘˜å¯¹è±¡ï¼ˆSDSå­—ç¬¦ä¸²ï¼‰

     - å€¼ï¼šå¯¹åº”çš„scoreå€¼

     - ä½œç”¨ï¼šå®ç°O(1)æ—¶é—´å¤æ‚åº¦çš„æˆå‘˜æŸ¥æ‰¾å’Œscoreè·å–

**æ ¸å¿ƒæ“ä½œå®ç°**

æŸ¥æ‰¾æ“ä½œ - O(log N)

    1. ä»æœ€é«˜å±‚å¼€å§‹ï¼Œæ°´å¹³å‘å³æŸ¥æ‰¾
    2. å¦‚æœä¸‹ä¸€èŠ‚ç‚¹score > ç›®æ ‡scoreï¼Œä¸‹é™ä¸€å±‚
    3. é‡å¤ç›´åˆ°æ‰¾åˆ°ç›®æ ‡æˆ–åˆ°è¾¾æœ€åº•å±‚

æ’å…¥æ“ä½œ - O(log N)

    1. ç¡®å®šæ’å…¥ä½ç½®ï¼ˆç±»ä¼¼æŸ¥æ‰¾è¿‡ç¨‹ï¼‰
    2. éšæœºç”Ÿæˆæ–°èŠ‚ç‚¹å±‚æ•°
    3. æ›´æ–°å„å±‚çš„å‰å‘æŒ‡é’ˆå’Œè·¨åº¦å€¼
    4. åŒæ—¶æ’å…¥å“ˆå¸Œè¡¨ï¼Œå»ºç«‹æˆå‘˜â†’scoreæ˜ å°„

èŒƒå›´æŸ¥è¯¢ - O(log N + M)

  ZRANGE/ZRANGEBYSCOREåˆ©ç”¨è·³è·ƒè¡¨çš„æœ‰åºæ€§ï¼š

    1. å®šä½èµ·å§‹ä½ç½® - O(log N)
    2. é¡ºåºéå†Mä¸ªç»“æœ - O(M)

**ç¼–ç ä¼˜åŒ–ç­–ç•¥**

  Redisæ ¹æ®æ•°æ®é‡å¤§å°é‡‡ç”¨ä¸åŒç¼–ç ï¼š

  ziplistç¼–ç ï¼ˆå°æ•°æ®é›†ï¼‰ï¼š

  - è§¦å‘æ¡ä»¶ï¼šzset-max-ziplist-entries â‰¤ 128 ä¸” zset-max-ziplist-value â‰¤ 64å­—èŠ‚
  - ä¼˜åŠ¿ï¼šå†…å­˜ç´§å‡‘ï¼Œç¼“å­˜å‹å¥½
  - åŠ£åŠ¿ï¼šæ’å…¥/åˆ é™¤ä¸ºO(N)

  skiplist+hashtableç¼–ç ï¼ˆå¤§æ•°æ®é›†ï¼‰ï¼š

  - æŸ¥æ‰¾æˆå‘˜ï¼šO(1) - é€šè¿‡hashtable
  - èŒƒå›´æ“ä½œï¼šO(log N) - é€šè¿‡skiplist
  - å†…å­˜å¼€é”€ï¼šåŒé‡å­˜å‚¨æˆå‘˜ä¿¡æ¯



### ğŸ¯ è·³è·ƒè¡¨æ˜¯å¦‚ä½•å®ç°çš„ï¼ŸåŸç†ï¼Ÿ

![](https://redisbook.readthedocs.io/en/latest/_images/skiplist.png)

Redis è·³è·ƒè¡¨é‡‡ç”¨ **æ¦‚ç‡å¹³è¡¡** çš„å¤šå±‚é“¾è¡¨ç»“æ„ï¼Œç”±ä¸‰ä¸ªå…³é”®ç»„ä»¶æ„æˆï¼š

1. è·³è·ƒè¡¨èŠ‚ç‚¹ç»“æ„ (zskiplistNode)

   ```c
   typedef struct zskiplistNode {
       sds ele;                            // æˆå‘˜å¯¹è±¡ï¼ˆSDSå­—ç¬¦ä¸²ï¼‰
       double score;                       // æ’åºåˆ†å€¼
       struct zskiplistNode *backward;     // åå‘æŒ‡é’ˆï¼ˆL0å±‚é€†å‘éå†ï¼‰
       struct zskiplistLevel {
           struct zskiplistNode *forward;  // å‰å‘æŒ‡é’ˆ
           unsigned long span;             // åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„è·¨åº¦ï¼ˆç”¨äºæ’åè®¡ç®—ï¼‰
       } level[];                          // æŸ”æ€§æ•°ç»„ï¼Œå±‚çº§é«˜åº¦éšæœºç”Ÿæˆï¼ˆ1~32ï¼‰
   } zskiplistNode;
   ```

2. è·³è·ƒè¡¨ç»“æ„ (zskiplist)

   ```c
   typedef struct zskiplist {
       struct zskiplistNode *header, *tail;  // å¤´å°¾èŠ‚ç‚¹ï¼ˆå¤´èŠ‚ç‚¹æœ‰32å±‚ï¼‰
       unsigned long length;                 // èŠ‚ç‚¹æ€»æ•°
       int level;                            // æœ€å¤§å±‚æ•°
   } zskiplist;
   ```

3. æœ‰åºé›†åˆç»“æ„ (zset)

   ```c
   typedef struct zset {
       dict *dict;          // å“ˆå¸Œè¡¨ï¼ˆå®ç° O(1) æŸ¥æ‰¾ï¼‰
       zskiplist *zsl;      // è·³è·ƒè¡¨ï¼ˆå®ç°èŒƒå›´æ“ä½œï¼‰
   } zset;
   ```

 **éšæœºå±‚æ•°ç”Ÿæˆç®—æ³•**

```c
int zslRandomLevel(void) {
    int level = 1;
    // Redis 5.0 ä½¿ç”¨ä½è¿ç®—ä¼˜åŒ–éšæœºç®—æ³•
    while ((random()&0xFFFF) < (ZSKIPLIST_P * 0xFFFF)) // ZSKIPLIST_P=0.25
        level += 1;
    return (level < ZSKIPLIST_MAXLEVEL) ? level : ZSKIPLIST_MAXLEVEL; // MAXLEVEL=32
}
```

- æ¦‚ç‡åˆ†å¸ƒï¼š
  - ç¬¬1å±‚ï¼š100%
  - ç¬¬2å±‚ï¼š25%
  - ç¬¬3å±‚ï¼š6.25% (0.25Â²)
  - ...ä»¥æ­¤ç±»æ¨
- **æ•°å­¦æœŸæœ›**ï¼šå¹³å‡å±‚æ•°ä¸º 1/(1-p) = 1.33 å±‚ï¼ˆp=0.25ï¼‰



### ğŸ¯ é™¤äº†5ç§åŸºæœ¬æ•°æ®ç±»å‹ï¼Œè¿˜çŸ¥é“å…¶ä»–æ•°æ®ç»“æ„ä¸ï¼Ÿ

**Bitmapsï¼ˆä½å›¾ï¼‰**

ä½å›¾ä¸æ˜¯å®é™…çš„æ•°æ®ç±»å‹ï¼Œè€Œæ˜¯åœ¨ String ç±»å‹ä¸Šå®šä¹‰çš„ä¸€ç»„é¢å‘ä½çš„æ“ä½œã€‚å¯ä»¥çœ‹ä½œæ˜¯ byte æ•°ç»„ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ™®é€šçš„ get/set ç›´æ¥è·å–å’Œè®¾ç½®æ•´ä¸ªä½å›¾çš„å†…å®¹ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ä½å›¾æ“ä½œ getbit/setbit ç­‰å°† byte æ•°ç»„çœ‹æˆã€Œä½æ•°ç»„ã€æ¥å¤„ç†ã€‚

- **æœ¬è´¨**ï¼šåŸºäº String ç±»å‹çš„æ‰©å±•ä½æ“ä½œï¼Œæœ€å¤§æ”¯æŒ 2^32 ä½ 

- **å†…å­˜æ¨¡å‹**ï¼šæ¯ä¸ª bit å¯¹åº”ä¸€ä¸ªåç§»é‡ï¼ˆoffsetï¼‰ï¼ŒäºŒè¿›åˆ¶å­˜å‚¨æ•ˆç‡æé«˜

- åº”ç”¨åœºæ™¯
  1. **å®æ—¶ç»Ÿè®¡**ï¼šDAU/MAU ç»Ÿè®¡ï¼ˆæ¯ä¸ªç”¨æˆ·å¯¹åº”1bitï¼‰
  2. **ç‰¹å¾æ ‡è®°**ï¼šç”¨æˆ·æƒé™ç³»ç»Ÿï¼ˆå¦‚ admin:1=æƒé™Aï¼Œadmin:2=æƒé™Bï¼‰
  3. **å¸ƒéš†è¿‡æ»¤å™¨**ï¼šé€šè¿‡å¤šä¸ªä½ç»„åˆå®ç°æ¦‚ç‡å‹å­˜åœ¨åˆ¤æ–­

**HyperLogLogï¼ˆåŸºæ•°ç»Ÿè®¡ï¼‰**

- **åŸç†**ï¼šåŸºäºæ¦‚ç‡ç®—æ³•ä¼°ç®—é›†åˆåŸºæ•°ï¼Œæ ‡å‡†è¯¯å·® 0.81% 
- **æ•°æ®ç»“æ„**ï¼š16384 ä¸ª 6bit å¯„å­˜å™¨ï¼ˆæ€»å ç”¨ 12KB å›ºå®šå†…å­˜ï¼‰

```redis
PFADD uv:page:123 user1 user2    # æ·»åŠ è®¿é—®ç”¨æˆ·
PFCOUNT uv:page:123              # è·å–UVä¼°ç®—å€¼
PFMERGE total_uv uv:page:*       # åˆå¹¶å¤šæ—¥UVæ•°æ®
```

- åº”ç”¨åœºæ™¯
  1. **æµé‡ç»Ÿè®¡**ï¼šç½‘ç«™ UV/å¹¿å‘Šæ›å…‰é‡
  2. **å»é‡åˆ†æ**ï¼šå¤§è§„æ¨¡æ•°æ®é›†è¿‘ä¼¼å»é‡
  3. **å®æ—¶å¤§å±**ï¼šå®æ—¶æ˜¾ç¤ºåƒä¸‡çº§ç”¨æˆ·é‡

**Geospatialï¼ˆåœ°ç†ç©ºé—´ï¼‰**

- **åº•å±‚ç»“æ„**ï¼šä½¿ç”¨ ZSET å­˜å‚¨ï¼Œscore ä¸º Geohash ç¼–ç å€¼
-  **ç¼–ç åŸç†**ï¼šå°†ç»çº¬åº¦è½¬æ¢ä¸º 52 ä½æ•´å‹ï¼ˆç²¾åº¦å¯è¾¾å˜ç±³çº§ï¼‰

```Redis
GEOADD cities 116.405285 39.904269 "åŒ—äº¬"  # æ·»åŠ åæ ‡
GEODIST cities åŒ—äº¬ ä¸Šæµ· km               # è®¡ç®—ä¸¤åœ°è·ç¦»
GEORADIUS cities 116 39 100 km WITHCOORD # åŠå¾„100kmå†…åŸå¸‚
```

- **åº”ç”¨åœºæ™¯**
  1. **LBSæœåŠ¡**ï¼šé™„è¿‘çš„äºº/å•†é“ºæœç´¢
  2. **è½¨è¿¹åˆ†æ**ï¼šç§»åŠ¨ç›®æ ‡ä½ç½®è¿½è¸ª
  3. **åŒºåŸŸç›‘æ§**ï¼šç”µå­å›´æ æŠ¥è­¦ç³»ç»Ÿ

**Streamsï¼ˆæµï¼‰**

- **æ•°æ®ç»“æ„**ï¼šæŒä¹…åŒ–æ¶ˆæ¯é“¾è¡¨ + æ¶ˆè´¹è€…ç»„ç®¡ç† 

- **æ ¸å¿ƒç»„ä»¶**ï¼š

  - `Message ID`ï¼šæ—¶é—´æˆ³-åºåˆ—å·ï¼ˆå¦‚ `1526569415636-0`ï¼‰

  - `Consumer Group`ï¼šæ”¯æŒæ¶ˆæ¯çš„è´Ÿè½½å‡è¡¡å’Œæ•…éšœè½¬ç§»

```Redis
XADD orders * product_id 1001      # æ·»åŠ è®¢å•äº‹ä»¶
XREAD COUNT 10 STREAMS orders $    # è¯»å–æœ€æ–°æ¶ˆæ¯
XGROUP CREATE orders group1 $      # åˆ›å»ºæ¶ˆè´¹è€…ç»„
```

**åº”ç”¨åœºæ™¯**

1. **æ¶ˆæ¯é˜Ÿåˆ—**ï¼šè®¢å•å¤„ç†/æ—¥å¿—æ”¶é›†
2. **äº‹ä»¶æº¯æº**ï¼šç”¨æˆ·è¡Œä¸ºè¿½è¸ª
3. **å®¡è®¡æ—¥å¿—**ï¼šæ“ä½œè®°å½•æ°¸ä¹…ä¿å­˜

**Bloom Filterï¼ˆå¸ƒéš†è¿‡æ»¤å™¨ï¼‰**

- **å®ç°æ–¹å¼**ï¼šé€šè¿‡å¤šä¸ª Bitmaps + å“ˆå¸Œå‡½æ•°å®ç° 

- **ç‰¹æ€§**ï¼š

  - åˆ¤æ–­å­˜åœ¨æ—¶å¯èƒ½æœ‰è¯¯æŠ¥ï¼ˆfalse positiveï¼‰

  - åˆ¤æ–­ä¸å­˜åœ¨æ—¶ç»å¯¹å‡†ç¡®

```Redis
BF.RESERVE user_filter 0.01 1000000 # åˆå§‹åŒ–è¿‡æ»¤å™¨ï¼ˆè¯¯å·®ç‡1%ï¼‰
BF.ADD user_filter 1001            # æ·»åŠ ç”¨æˆ·ID
BF.EXISTS user_filter 1001         # æ£€æŸ¥æ˜¯å¦å­˜åœ¨
```

- **åº”ç”¨åœºæ™¯**
  1. **ç¼“å­˜ç©¿é€é˜²æŠ¤**ï¼šæ‹¦æˆªéæ³•è¯·æ±‚
  2. **æ¨èå»é‡**ï¼šé¿å…é‡å¤æ¨èå†…å®¹
  3. **çˆ¬è™«URLåˆ¤é‡**ï¼šè¿‡æ»¤å·²æŠ“å–é“¾æ¥



### ğŸ¯ æ€ä¹ˆç»Ÿè®¡ä¸€äº¿ç”¨æˆ·çš„æ—¥æ´»ï¼Œhyperloglogæœ‰ä»€ä¹ˆç¼ºç‚¹ï¼Œbitmapä¸è¡Œä¹ˆ?

ç»Ÿè®¡ä¸€äº¿ç”¨æˆ·çš„æ—¥æ´»ï¼ˆDaily Active Users, DAUï¼‰æ—¶ï¼Œéœ€è¦ä¸€ä¸ªèƒ½å¤Ÿé«˜æ•ˆå¤„ç†å’Œå­˜å‚¨å¤§é‡æ•°æ®çš„æ–¹æ¡ˆã€‚ä»¥ä¸‹æ˜¯å‡ ç§é€‚ç”¨äºæ­¤ç±»åœºæ™¯çš„æ•°æ®ç»“æ„åŠå…¶ä¼˜ç¼ºç‚¹ï¼š

HyperLogLog æ˜¯ä¸€ç§ç”¨äºåŸºæ•°ç»Ÿè®¡çš„æ•°æ®ç»“æ„ï¼Œå®ƒæä¾›äº†ä¸€ä¸ªè¿‘ä¼¼çš„ã€ä¸ç²¾ç¡®çš„è§£å†³æ–¹æ¡ˆæ¥ä¼°ç®—é›†åˆä¸­å”¯ä¸€å…ƒç´ çš„æ•°é‡ã€‚

**ä¼˜ç‚¹**ï¼š

- **å†…å­˜æ•ˆç‡**ï¼šHyperLogLog æ¶ˆè€—çš„å†…å­˜å›ºå®šï¼Œä¸é›†åˆä¸­å…ƒç´ çš„æ•°é‡æ— å…³ï¼Œé€šå¸¸æ¯ä¸ª HyperLogLog å®ä¾‹åªéœ€è¦ 12.4KB å·¦å³ï¼Œæ— è®ºé›†åˆä¸­æœ‰å¤šå°‘å…ƒç´ ã€‚
- **æ€§èƒ½**ï¼šHyperLogLog å¯ä»¥å¿«é€Ÿå¤„ç†æ•°æ®ï¼Œå› ä¸ºå®ƒåªå­˜å‚¨å…ƒç´ çš„å“ˆå¸Œå€¼çš„ä¸€äº›ä½ä¿¡æ¯ã€‚

**ç¼ºç‚¹**ï¼š

- **è¿‘ä¼¼å€¼**ï¼šHyperLogLog æä¾›çš„æ˜¯è¿‘ä¼¼å€¼ï¼Œæ ‡å‡†è¯¯å·®å¤§çº¦ä¸º 0.81%ï¼Œè¿™æ„å‘³ç€å®é™…åŸºæ•°å¯èƒ½ä¸ä¼°ç®—å€¼æœ‰æ‰€åå·®ã€‚
- **æ›´æ–°é¢‘ç‡**ï¼šå¦‚æœæ•°æ®æ›´æ–°éå¸¸é¢‘ç¹ï¼ŒHyperLogLog å¯èƒ½éœ€è¦é¢‘ç¹åœ°è°ƒæ•´å…¶å†…éƒ¨æ•°æ®ç»“æ„ï¼Œè¿™å¯èƒ½ä¼šå½±å“æ€§èƒ½ã€‚

Bitmap æ˜¯å¦ä¸€ç§æ•°æ®ç»“æ„ï¼Œå®ƒä½¿ç”¨ä½æ•°ç»„æ¥è¡¨ç¤ºæ•°æ®ï¼Œæ¯ä¸ªä½å¯¹åº”ä¸€ä¸ªå…ƒç´ çš„çŠ¶æ€ï¼ˆä¾‹å¦‚ï¼Œç”¨æˆ·æ˜¯å¦æ´»è·ƒï¼‰ã€‚

**ä¼˜ç‚¹**ï¼š

- **ç²¾ç¡®è®¡æ•°**ï¼šBitmap æä¾›ç²¾ç¡®çš„è®¡æ•°ï¼Œæ²¡æœ‰ HyperLogLog çš„è¿‘ä¼¼è¯¯å·®ã€‚
- **ç®€å•ç›´è§‚**ï¼šBitmap çš„æ¦‚å¿µç®€å•ï¼Œæ˜“äºç†è§£å’Œå®ç°ã€‚

**ç¼ºç‚¹**ï¼š

- **å†…å­˜æ¶ˆè€—**ï¼šå¯¹äºä¸€äº¿ç”¨æˆ·ï¼ŒBitmap éœ€è¦å¤§çº¦ 100MBï¼ˆ1äº¿ä½ / 8ä½/å­—èŠ‚ Ã· 1024KB/MBï¼‰çš„å†…å­˜ï¼Œè¿™æ¯” HyperLogLog é«˜å¾—å¤šã€‚
- **æ‰©å±•æ€§é—®é¢˜**ï¼šéšç€ç”¨æˆ·æ•°é‡çš„å¢åŠ ï¼ŒBitmap æ‰€éœ€çš„å†…å­˜ä¹Ÿä¼šçº¿æ€§å¢é•¿ï¼Œè¿™å¯èƒ½åœ¨å¤§è§„æ¨¡æ•°æ®é›†ä¸Šé€ æˆé—®é¢˜ã€‚

**ç»¼åˆè€ƒè™‘**

- å¦‚æœå¯¹æ—¥æ´»ç”¨æˆ·æ•°çš„ç²¾ç¡®åº¦è¦æ±‚ä¸é«˜ï¼Œå¹¶ä¸”å¸Œæœ›æœ€å°åŒ–å†…å­˜ä½¿ç”¨ï¼ŒHyperLogLog æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ã€‚
- å¦‚æœéœ€è¦ç²¾ç¡®çš„æ—¥æ´»ç”¨æˆ·æ•°ï¼Œå¹¶ä¸”å¯ä»¥æ‰¿å—è¾ƒé«˜çš„å†…å­˜æ¶ˆè€—ï¼Œå¯ä»¥ä½¿ç”¨ Bitmapã€‚
- åœ¨å®é™…åº”ç”¨ä¸­ï¼Œå¯èƒ½è¿˜ä¼šè€ƒè™‘å…¶ä»–å› ç´ ï¼Œå¦‚æ•°æ®çš„æ›´æ–°é¢‘ç‡ã€ç³»ç»Ÿçš„æ‰©å±•æ€§ã€ç»´æŠ¤æˆæœ¬ç­‰ã€‚

å¯¹äºä¸€äº¿ç”¨æˆ·çš„æ—¥æ´»ç»Ÿè®¡ï¼Œå¦‚æœå¯¹ç²¾åº¦è¦æ±‚ä¸æ˜¯ç‰¹åˆ«é«˜ï¼ŒHyperLogLog æ˜¯ä¸€ä¸ªæ›´åˆé€‚çš„é€‰æ‹©ï¼Œå› ä¸ºå®ƒåœ¨å†…å­˜ä½¿ç”¨å’Œæ€§èƒ½æ–¹é¢å…·æœ‰ä¼˜åŠ¿ã€‚Bitmap è™½ç„¶å¯ä»¥æä¾›ç²¾ç¡®çš„ç»Ÿè®¡ï¼Œä½†å…¶å†…å­˜æ¶ˆè€—è¾ƒé«˜ï¼Œå¯èƒ½ä¸é€‚åˆå¤§è§„æ¨¡çš„ç”¨æˆ·ç»Ÿè®¡ã€‚



### ğŸ¯ è¿™äº›éƒ½ä¼šï¼Œé‚£ä½ èƒ½è¯´è¯´ Redis ä½¿ç”¨åœºæ™¯ä¸ï¼Œä½ ä»¬é¡¹ç›®ä¸­æ˜¯æ€ä¹ˆç”¨çš„ï¼Ÿ

åœ¨ Redis ä¸­ï¼Œå¸¸ç”¨çš„ 5 ç§æ•°æ®ç»“æ„å’Œåº”ç”¨åœºæ™¯å¦‚ä¸‹ï¼š

- **String**ï¼šç¼“å­˜ã€è®¡æ•°å™¨ã€åˆ†å¸ƒå¼é”ç­‰ã€‚
  - ä»€ä¹ˆæ˜¯è®¡æ•°å™¨ï¼Œå¦‚ç”µå•†ç½‘ç«™å•†å“çš„æµè§ˆé‡ã€è§†é¢‘ç½‘ç«™è§†é¢‘çš„æ’­æ”¾æ•°ç­‰ã€‚ä¸ºäº†ä¿è¯æ•°æ®å®æ—¶æ•ˆï¼Œæ¯æ¬¡æµè§ˆéƒ½å¾—+1ï¼Œå¹¶å‘é‡é«˜æ—¶å¦‚æœæ¯æ¬¡éƒ½è¯·æ±‚æ•°æ®åº“æ“ä½œæ— ç–‘ä¼šå¯¹æ•°æ®åº“æå‡ºæŒ‘æˆ˜ã€‚Redisæä¾›çš„incrå‘½ä»¤æ¥å®ç°è®¡æ•°å™¨åŠŸèƒ½ï¼Œå†…å­˜æ“ä½œï¼Œæ€§èƒ½éå¸¸å¥½ï¼Œéå¸¸é€‚ç”¨äºè¿™äº›è®¡æ•°åœºæ™¯ã€‚
  - åœ¨å¾ˆå¤šäº’è”ç½‘å…¬å¸ä¸­éƒ½ä½¿ç”¨äº†åˆ†å¸ƒå¼æŠ€æœ¯ï¼Œåˆ†å¸ƒå¼æŠ€æœ¯å¸¦æ¥çš„æŠ€æœ¯æŒ‘æˆ˜æ˜¯å¯¹åŒä¸€ä¸ªèµ„æºçš„å¹¶å‘è®¿é—®ï¼Œå¦‚å…¨å±€IDã€å‡åº“å­˜ã€ç§’æ€ç­‰åœºæ™¯ï¼Œå¹¶å‘é‡ä¸å¤§çš„åœºæ™¯å¯ä»¥ä½¿ç”¨æ•°æ®åº“çš„æ‚²è§‚é”ã€ä¹è§‚é”æ¥å®ç°ï¼Œä½†åœ¨å¹¶å‘é‡é«˜çš„åœºåˆä¸­ï¼Œåˆ©ç”¨æ•°æ®åº“é”æ¥æ§åˆ¶èµ„æºçš„å¹¶å‘è®¿é—®æ˜¯ä¸å¤ªç†æƒ³çš„ï¼Œå¤§å¤§å½±å“äº†æ•°æ®åº“çš„æ€§èƒ½ã€‚å¯ä»¥åˆ©ç”¨Redisçš„setnxåŠŸèƒ½æ¥ç¼–å†™åˆ†å¸ƒå¼çš„é”ï¼Œå¦‚æœè®¾ç½®è¿”å›1è¯´æ˜è·å–é”æˆåŠŸï¼Œå¦åˆ™è·å–é”å¤±è´¥ï¼Œå®é™…åº”ç”¨ä¸­è¦è€ƒè™‘çš„ç»†èŠ‚è¦æ›´å¤šã€‚

- **List**ï¼šé“¾è¡¨ã€é˜Ÿåˆ—ã€å¾®åšå…³æ³¨äººæ—¶é—´è½´åˆ—è¡¨ç­‰ã€‚
  - Redisåˆ—è¡¨ç»“æ„ï¼ŒLPUSHå¯ä»¥åœ¨åˆ—è¡¨å¤´éƒ¨æ’å…¥ä¸€ä¸ªå†…å®¹IDä½œä¸ºå…³é”®å­—ï¼ŒLTRIMå¯ç”¨æ¥é™åˆ¶åˆ—è¡¨çš„æ•°é‡ï¼Œè¿™æ ·åˆ—è¡¨æ°¸è¿œä¸ºNä¸ªIDï¼Œæ— éœ€æŸ¥è¯¢æœ€æ–°çš„åˆ—è¡¨ï¼Œç›´æ¥æ ¹æ®IDå»åˆ°å¯¹åº”çš„å†…å®¹é¡µå³å¯ã€‚
- **Hash**ï¼šç”¨æˆ·ä¿¡æ¯ã€Hash è¡¨ç­‰ã€‚
- **Set**ï¼š**ç¤¾äº¤ç½‘ç»œ**
  - ç‚¹èµã€è¸©ã€å…³æ³¨/è¢«å…³æ³¨ã€å…±åŒå¥½å‹ç­‰æ˜¯ç¤¾äº¤ç½‘ç«™çš„åŸºæœ¬åŠŸèƒ½ï¼Œç¤¾äº¤ç½‘ç«™çš„è®¿é—®é‡é€šå¸¸æ¥è¯´æ¯”è¾ƒå¤§ï¼Œè€Œä¸”ä¼ ç»Ÿçš„å…³ç³»æ•°æ®åº“ç±»å‹ä¸é€‚åˆå­˜å‚¨è¿™ç§ç±»å‹çš„æ•°æ®ï¼ŒRedisæä¾›çš„å“ˆå¸Œã€é›†åˆç­‰æ•°æ®ç»“æ„èƒ½å¾ˆæ–¹ä¾¿çš„çš„å®ç°è¿™äº›åŠŸèƒ½ã€‚
- **Zset**ï¼šè®¿é—®é‡æ’è¡Œæ¦œã€ç‚¹å‡»é‡æ’è¡Œæ¦œç­‰

è¿˜æœ‰ä¸€äº›ï¼Œæ¯”å¦‚ï¼š

- å–æœ€æ–°Nä¸ªæ•°æ®çš„æ“ä½œ

- éœ€è¦ç²¾ç¡®è®¾å®šè¿‡æœŸæ—¶é—´çš„åº”ç”¨

- Uniqæ“ä½œ,è·å–æŸæ®µæ—¶é—´æ‰€æœ‰æ•°æ®æ’é‡å€¼

- å®æ—¶ç³»ç»Ÿ,ååƒåœ¾ç³»ç»Ÿ

- Pub/Subæ„å»ºå®æ—¶æ¶ˆæ¯ç³»ç»Ÿ

- æ„å»ºé˜Ÿåˆ—ç³»ç»Ÿ

-  **åˆ†å¸ƒå¼ä¼šè¯**

  é›†ç¾¤æ¨¡å¼ä¸‹ï¼Œåœ¨åº”ç”¨ä¸å¤šçš„æƒ…å†µä¸‹ä¸€èˆ¬ä½¿ç”¨å®¹å™¨è‡ªå¸¦çš„sessionå¤åˆ¶åŠŸèƒ½å°±èƒ½æ»¡è¶³ï¼Œå½“åº”ç”¨å¢å¤šç›¸å¯¹å¤æ‚çš„ç³»ç»Ÿä¸­ï¼Œä¸€èˆ¬éƒ½ä¼šæ­å»ºä»¥Redisç­‰å†…å­˜æ•°æ®åº“ä¸ºä¸­å¿ƒçš„sessionæœåŠ¡ï¼Œsessionä¸å†ç”±å®¹å™¨ç®¡ç†ï¼Œè€Œæ˜¯ç”±sessionæœåŠ¡åŠå†…å­˜æ•°æ®åº“ç®¡ç†ã€‚

------



## ä¸‰ã€æŒä¹…åŒ–ä¸å†…å­˜ç®¡ç†

### ğŸ¯ ä½ å¯¹ Redis çš„æŒä¹…åŒ–æœºåˆ¶äº†è§£å—ï¼Ÿèƒ½è®²ä¸€ä¸‹å—ï¼Ÿ

> æˆ–è€…ä¸ä¼šè¿™ä¹ˆç›´ç™½çš„é—®ï¼Œè€Œæ˜¯é—® Redis æ˜¯å¦‚ä½•å®ç°æ•°æ®ä¸ä¸¢å¤±çš„?

Redis çš„æ•°æ®å…¨éƒ¨åœ¨å†…å­˜é‡Œï¼Œå¦‚æœçªç„¶å®•æœºï¼Œæ•°æ®å°±ä¼šå…¨éƒ¨ä¸¢å¤±ï¼Œå› æ­¤å¿…é¡»æœ‰ä¸€ç§æœºåˆ¶æ¥ä¿è¯ Redis çš„æ•°æ®ä¸ä¼šå› ä¸ºæ•…éšœè€Œä¸¢å¤±ï¼Œè¿™ç§æœºåˆ¶å°±æ˜¯ Redis çš„æŒä¹…åŒ–æœºåˆ¶ï¼Œå®ƒä¼šå°†å†…å­˜ä¸­çš„æ•°æ®åº“çŠ¶æ€ **ä¿å­˜åˆ°ç£ç›˜** ä¸­ã€‚

> å›ç­”æ€è·¯ï¼šå…ˆè¯´æ˜ Redis æœ‰å‡ ç§æŒä¹…åŒ–çš„æ–¹å¼ï¼Œç„¶ååˆ†æ AOF å’Œ RDB çš„åŸç†ä»¥åŠå­˜åœ¨çš„é—®é¢˜ï¼Œæœ€ååˆ†æä¸€ä¸‹ Redis 4.0 ç‰ˆæœ¬ä¹‹åçš„æŒä¹…åŒ–æœºåˆ¶ã€‚



### ğŸ¯ Redis æŒä¹…åŒ–çš„æ–¹å¼æœ‰å“ªå†™ï¼Ÿ

Redisçš„æŒä¹…åŒ–æœºåˆ¶ä¸»è¦æœ‰ä¸¤ç§ï¼šRDBå’ŒAOFï¼Œä»¥åŠä¸¤è€…çš„æ··åˆæ¨¡å¼ã€‚

1. **RDBï¼ˆRedis Databaseï¼‰**

- **åŸç†**ï¼šé€šè¿‡ç”Ÿæˆå†…å­˜æ•°æ®çš„**å¿«ç…§**ï¼ˆSnapshotï¼‰æŒä¹…åŒ–åˆ°ç£ç›˜ã€‚è§¦å‘æ–¹å¼åŒ…æ‹¬æ‰‹åŠ¨ï¼ˆ`SAVE`/`BGSAVE`ï¼‰å’Œè‡ªåŠ¨ï¼ˆé…ç½®`save`è§„åˆ™ï¼Œå¦‚`save 900 1`è¡¨ç¤º900ç§’å†…è‡³å°‘1æ¬¡ä¿®æ”¹åˆ™è§¦å‘ï¼‰ã€‚

  rdb é»˜è®¤ä¿å­˜çš„æ˜¯ **dump.rdb** æ–‡ä»¶

  **åœ¨æŒ‡å®šçš„æ—¶é—´é—´éš”å†…å°†å†…å­˜ä¸­çš„æ•°æ®é›†å¿«ç…§å†™å…¥ç£ç›˜**ï¼Œä¹Ÿå°±æ˜¯è¡Œè¯è®²çš„ Snapshot å¿«ç…§ï¼Œå®ƒæ¢å¤æ—¶æ˜¯å°†å¿«ç…§æ–‡ä»¶ç›´æ¥è¯»åˆ°å†…å­˜é‡Œã€‚

  Redisä¼šå•ç‹¬åˆ›å»ºï¼ˆforkï¼‰ä¸€ä¸ªå­è¿›ç¨‹æ¥è¿›è¡ŒæŒä¹…åŒ–ï¼Œä¼šå…ˆå°†æ•°æ®å†™å…¥åˆ°ä¸€ä¸ªä¸´æ—¶æ–‡ä»¶ä¸­ï¼Œå¾…æŒä¹…åŒ–è¿‡ç¨‹éƒ½ç»“æŸäº†ï¼Œå†ç”¨è¿™ä¸ªä¸´æ—¶æ–‡ä»¶æ›¿æ¢ä¸Šæ¬¡æŒä¹…åŒ–å¥½çš„æ–‡ä»¶ã€‚æ•´ä¸ªè¿‡ç¨‹ä¸­ï¼Œä¸»è¿›ç¨‹æ˜¯ä¸è¿›è¡Œä»»ä½• IO æ“ä½œçš„ï¼Œè¿™å°±ç¡®ä¿äº†æé«˜çš„æ€§èƒ½ï¼Œå¦‚æœéœ€è¦è¿›è¡Œå¤§è§„æ¨¡æ•°æ®çš„æ¢å¤ï¼Œä¸”å¯¹äºæ•°æ®æ¢å¤çš„å®Œæ•´æ€§ä¸æ˜¯éå¸¸æ•æ„Ÿï¼Œé‚£ RDB æ–¹å¼è¦æ¯” AOF æ–¹å¼æ›´åŠ çš„é«˜æ•ˆã€‚RDBçš„ç¼ºç‚¹æ˜¯æœ€åä¸€æ¬¡æŒä¹…åŒ–åçš„æ•°æ®å¯èƒ½ä¸¢å¤±ã€‚

  > What ? Redis ä¸æ˜¯å•è¿›ç¨‹çš„å—?

  Redis ä½¿ç”¨æ“ä½œç³»ç»Ÿçš„å¤šè¿›ç¨‹ COW(Copy On Write) æœºåˆ¶æ¥å®ç°å¿«ç…§æŒä¹…åŒ–ï¼Œ fork æ˜¯ç±»Unixæ“ä½œç³»ç»Ÿä¸Š**åˆ›å»ºè¿›ç¨‹**çš„ä¸»è¦æ–¹æ³•ã€‚COW(Copy On Write)æ˜¯è®¡ç®—æœºç¼–ç¨‹ä¸­ä½¿ç”¨çš„ä¸€ç§ä¼˜åŒ–ç­–ç•¥ã€‚

  fork çš„ä½œç”¨æ˜¯å¤åˆ¶ä¸€ä¸ªä¸å½“å‰è¿›ç¨‹ä¸€æ ·çš„è¿›ç¨‹ã€‚æ–°è¿›ç¨‹çš„æ‰€æœ‰æ•°æ®ï¼ˆå˜é‡ã€ç¯å¢ƒå˜é‡ã€ç¨‹åºè®¡æ•°å™¨ç­‰ï¼‰æ•°å€¼éƒ½å’ŒåŸè¿›ç¨‹ä¸€è‡´ï¼Œä½†æ˜¯æ˜¯ä¸€ä¸ªå…¨æ–°çš„è¿›ç¨‹ï¼Œå¹¶ä½œä¸ºåŸè¿›ç¨‹çš„å­è¿›ç¨‹ã€‚ å­è¿›ç¨‹è¯»å–æ•°æ®ï¼Œç„¶ååºåˆ—åŒ–å†™åˆ°ç£ç›˜ä¸­ã€‚

- ä¼˜ç‚¹ï¼š

  - **æ€§èƒ½é«˜**ï¼šé€šè¿‡`BGSAVE`åå°ç”Ÿæˆå¿«ç…§ï¼Œä¸å½±å“ä¸»è¿›ç¨‹ã€‚
  - **æ–‡ä»¶ç´§å‡‘**ï¼šäºŒè¿›åˆ¶æ ¼å¼ï¼Œé€‚åˆå¤‡ä»½ä¸ç¾éš¾æ¢å¤ã€‚
  - **å¿«é€Ÿé‡å¯**ï¼šåŠ è½½RDBæ–‡ä»¶æ¢å¤æ•°æ®æ¯”AOFæ›´å¿«ã€‚

- ç¼ºç‚¹ï¼š

  - **æ•°æ®ä¸¢å¤±é£é™©**ï¼šæœ€åä¸€æ¬¡å¿«ç…§åçš„ä¿®æ”¹å¯èƒ½ä¸¢å¤±ï¼ˆä¾èµ–é…ç½®çš„è§¦å‘é¢‘ç‡ï¼‰ã€‚
  - **å¤§å†…å­˜Forkå¼€é”€**ï¼šé¢‘ç¹å¿«ç…§æ—¶ï¼Œå†™æ—¶å¤åˆ¶ï¼ˆCopy-On-Writeï¼‰å¯èƒ½å¯¼è‡´å†…å­˜å ç”¨é™¡å¢ã€‚

2. **AOFï¼ˆAppend-Only Fileï¼‰**

- åŸç†ï¼šè®°å½•æ¯ä¸ªå†™æ“ä½œå‘½ä»¤ï¼ˆå¦‚ `SET`/`DEL`ï¼‰ï¼Œè¿½åŠ åˆ°æ–‡ä»¶æœ«å°¾ã€‚æ”¯æŒä¸‰ç§åŒæ­¥ç­–ç•¥ï¼š
  - **always**ï¼šæ¯ä¸ªå‘½ä»¤åŒæ­¥å†™å…¥ç£ç›˜ï¼ˆå®‰å…¨ï¼Œä½†æ€§èƒ½æœ€ä½ï¼‰ã€‚
  - **everysec**ï¼šæ¯ç§’æ‰¹é‡åŒæ­¥ï¼ˆé»˜è®¤ï¼Œæœ€å¤šä¸¢å¤±1ç§’æ•°æ®ï¼‰ã€‚
  - **no**ï¼šä¾èµ–æ“ä½œç³»ç»Ÿåˆ·ç›˜ï¼ˆæ€§èƒ½é«˜ï¼Œä½†ä¸¢å¤±æ•°æ®é£é™©æœ€å¤§ï¼‰ã€‚
- ä¼˜ç‚¹ï¼š
  - **æ•°æ®æ›´å®‰å…¨**ï¼šå¯é…ç½®ä¸ºç§’çº§/å‘½ä»¤çº§æŒä¹…åŒ–ã€‚
  - **å¯è¯»æ€§å¼º**ï¼šAOFæ–‡ä»¶ä¸ºæ–‡æœ¬æ ¼å¼ï¼Œä¾¿äºäººå·¥åˆ†æã€‚
- ç¼ºç‚¹ï¼š
  - **æ–‡ä»¶ä½“ç§¯å¤§**ï¼šé•¿æœŸè¿è¡Œåæ–‡ä»¶è†¨èƒ€ï¼Œéœ€å®šæœŸæ‰§è¡Œ`BGREWRITEAOF`é‡å†™å‹ç¼©ã€‚
  - **æ¢å¤é€Ÿåº¦æ…¢**ï¼šé‡æ”¾æ‰€æœ‰å‘½ä»¤æ¢å¤æ•°æ®ï¼Œæ¯”RDBè€—æ—¶ã€‚

3. **æ··åˆæŒä¹…åŒ–ï¼ˆRedis 4.0+ï¼‰**

- **åŸç†**ï¼šç»“åˆRDBå’ŒAOFï¼ŒAOFæ–‡ä»¶ç”±**RDBå¤´éƒ¨ï¼ˆå…¨é‡æ•°æ®ï¼‰ + AOFå°¾éƒ¨ï¼ˆå¢é‡å‘½ä»¤ï¼‰**ç»„æˆï¼Œé€šè¿‡é…ç½®`aof-use-rdb-preamble yes`å¯ç”¨ã€‚
- ä¼˜ç‚¹ï¼š
  - **å¿«é€Ÿæ¢å¤**ï¼šå…ˆåŠ è½½RDBå¿«ç…§ï¼Œå†é‡æ”¾å¢é‡å‘½ä»¤ï¼Œå…¼é¡¾é€Ÿåº¦ä¸æ•°æ®å®Œæ•´æ€§ã€‚
  - **æ–‡ä»¶æ›´å°**ï¼šç›¸æ¯”çº¯AOFï¼Œæ··åˆæ¨¡å¼æ–‡ä»¶ä½“ç§¯æ›´å°ã€‚

4. **é€‰å‹ä¸é…ç½®å»ºè®®**

- åœºæ™¯é€‰æ‹©ï¼š
  - **RDB**ï¼šå…è®¸åˆ†é’Ÿçº§æ•°æ®ä¸¢å¤±ï¼Œè¿½æ±‚é«˜æ€§èƒ½å¤‡ä»½ï¼ˆå¦‚ç¼“å­˜åœºæ™¯ï¼‰ã€‚
  - **AOF**ï¼šå¯¹æ•°æ®å®‰å…¨æ€§è¦æ±‚é«˜ï¼ˆå¦‚é‡‘èåœºæ™¯ï¼‰ã€‚
  - **æ··åˆæ¨¡å¼**ï¼šç»¼åˆä¸¤è€…ä¼˜åŠ¿ï¼Œæ¨èç”Ÿäº§ç¯å¢ƒä½¿ç”¨ã€‚
- æ³¨æ„äº‹é¡¹ï¼š
  - åŒæ—¶å¯ç”¨RDBå’ŒAOFæ—¶ï¼ŒRedisé‡å¯**ä¼˜å…ˆåŠ è½½AOF**æ–‡ä»¶ã€‚
  - ç›‘æ§`fork`è€—æ—¶åŠå†…å­˜å‹åŠ›ï¼Œé¿å…é¢‘ç¹å¿«ç…§å¯¼è‡´æ€§èƒ½æŠ–åŠ¨ã€‚

**æ€»ç»“**ï¼šç†è§£RDBå’ŒAOFçš„æœºåˆ¶ä¸æƒè¡¡ï¼Œç»“åˆä¸šåŠ¡éœ€æ±‚é€‰æ‹©æŒä¹…åŒ–ç­–ç•¥ï¼Œæ··åˆæ¨¡å¼é€šå¸¸æ˜¯å¹³è¡¡æ€§èƒ½ä¸å®‰å…¨æ€§çš„æœ€ä½³å®è·µã€‚



### ğŸ¯ RDB åšå¿«ç…§æ—¶ä¼šé˜»å¡çº¿ç¨‹å—ï¼Ÿ

å› ä¸º Redis çš„å•çº¿ç¨‹æ¨¡å‹å†³å®šäº†å®ƒæ‰€æœ‰æ“ä½œéƒ½è¦å°½é‡é¿å…é˜»å¡ä¸»çº¿ç¨‹ï¼Œæ‰€ä»¥å¯¹äº RDB å¿«ç…§ä¹Ÿä¸ä¾‹å¤–ï¼Œè¿™å…³ç³»åˆ°æ˜¯å¦ä¼šé™ä½ Redis çš„æ€§èƒ½ã€‚

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒRedis æä¾›äº†ä¸¤ä¸ªå‘½ä»¤æ¥ç”Ÿæˆ RDB å¿«ç…§æ–‡ä»¶ï¼Œåˆ†åˆ«æ˜¯ save å’Œ bgsaveã€‚save å‘½ä»¤åœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œä¼šå¯¼è‡´é˜»å¡ã€‚è€Œ bgsave å‘½ä»¤åˆ™ä¼šåˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹ï¼Œç”¨äºå†™å…¥ RDB æ–‡ä»¶çš„æ“ä½œï¼Œé¿å…äº†å¯¹ä¸»çº¿ç¨‹çš„é˜»å¡ï¼Œè¿™ä¹Ÿæ˜¯ Redis RDB çš„é»˜è®¤é…ç½®ã€‚



### ğŸ¯ RDB åšå¿«ç…§çš„æ—¶å€™æ•°æ®èƒ½ä¿®æ”¹å—ï¼Ÿ

Redisåˆ©ç”¨æ“ä½œç³»ç»Ÿçš„å†™æ—¶å¤åˆ¶æœºåˆ¶ï¼Œä½¿å¾—åœ¨RDBå¿«ç…§ç”Ÿæˆè¿‡ç¨‹ä¸­ï¼Œä¸»çº¿ç¨‹ä»ç„¶å¯ä»¥æ­£å¸¸å¤„ç†å†™æ“ä½œï¼š

> å®ƒåˆ©ç”¨äº† bgsave çš„å­è¿›ç¨‹ï¼Œå…·ä½“æ“ä½œå¦‚ä¸‹ï¼š
>
> å¦‚æœä¸»çº¿ç¨‹æ‰§è¡Œè¯»æ“ä½œï¼Œåˆ™ä¸»çº¿ç¨‹å’Œ bgsave å­è¿›ç¨‹äº’ç›¸ä¸å½±å“ï¼›
>
> å¦‚æœä¸»çº¿ç¨‹æ‰§è¡Œå†™æ“ä½œï¼Œåˆ™è¢«ä¿®æ”¹çš„æ•°æ®ä¼šå¤åˆ¶ä¸€ä»½å‰¯æœ¬ï¼Œç„¶å bgsave å­è¿›ç¨‹ä¼šæŠŠè¯¥å‰¯æœ¬æ•°æ®å†™å…¥ RDB æ–‡ä»¶ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œä¸»çº¿ç¨‹ä»ç„¶å¯ä»¥ç›´æ¥ä¿®æ”¹åŸæ¥çš„æ•°æ®ã€‚

```
  ä¸»è¿›ç¨‹ (Redisä¸»çº¿ç¨‹)     å­è¿›ç¨‹ (BGSAVE)
         |                      |
     å¤„ç†å†™è¯·æ±‚               è¯»å–å†…å­˜æ•°æ®
         |                      |
     ä¿®æ”¹æ•°æ®é¡µ              ç”ŸæˆRDBæ–‡ä»¶
         |                      |
     è§¦å‘COWå¤åˆ¶                 |
```

  å…·ä½“å·¥ä½œæµç¨‹

  1. BGSAVEæ‰§è¡Œæ—¶

       - Redisé€šè¿‡fork()åˆ›å»ºå­è¿›ç¨‹

       - å­è¿›ç¨‹ç»§æ‰¿çˆ¶è¿›ç¨‹çš„å†…å­˜ç©ºé—´ï¼ˆå…±äº«ç‰©ç†å†…å­˜ï¼‰

       - å­è¿›ç¨‹å¼€å§‹éå†å†…å­˜æ•°æ®ç”ŸæˆRDBå¿«ç…§

  2. è¯»æ“ä½œå¤„ç†

       - ä¸»çº¿ç¨‹æ‰§è¡Œè¯»æ“ä½œï¼šä¸å½±å“å¿«ç…§ç”Ÿæˆ

       - å­è¿›ç¨‹è¯»å–æ•°æ®ï¼šç›´æ¥è®¿é—®å…±äº«å†…å­˜

       - ä¸¤è€…äº’ä¸å¹²æ‰°ï¼Œæ€§èƒ½è‰¯å¥½

  3. å†™æ“ä½œå¤„ç†ï¼ˆCOWæœºåˆ¶æ ¸å¿ƒï¼‰

       å†™æ“ä½œå‘ç”Ÿæ—¶ï¼š

         - ä¸»çº¿ç¨‹è¦ä¿®æ”¹æŸä¸ªæ•°æ®é¡µ

         - æ“ä½œç³»ç»Ÿæ£€æµ‹åˆ°å†™å…¥æ“ä½œ

         - å¤åˆ¶è¯¥æ•°æ®é¡µåˆ°æ–°çš„ç‰©ç†åœ°å€

         - ä¸»çº¿ç¨‹åœ¨æ–°é¡µé¢ä¸Šæ‰§è¡Œå†™æ“ä½œ

         - å­è¿›ç¨‹ç»§ç»­è®¿é—®åŸå§‹é¡µé¢æ•°æ®



### ğŸ¯ AOF æ—¥å¿—æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ

é€šå¸¸æƒ…å†µä¸‹ï¼Œå…³ç³»å‹æ•°æ®åº“ï¼ˆå¦‚ MySQLï¼‰çš„æ—¥å¿—éƒ½æ˜¯â€œå†™å‰æ—¥å¿—â€ï¼ˆWrite Ahead Log, WALï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨å®é™…å†™æ•°æ®ä¹‹å‰ï¼Œå…ˆæŠŠä¿®æ”¹çš„æ•°æ®è®°åˆ°æ—¥å¿—æ–‡ä»¶ä¸­ï¼Œä»¥ä¾¿å½“å‡ºç°æ•…éšœæ—¶è¿›è¡Œæ¢å¤ï¼Œæ¯”å¦‚ MySQL çš„ redo logï¼ˆé‡åšæ—¥å¿—ï¼‰ï¼Œè®°å½•çš„å°±æ˜¯ä¿®æ”¹åçš„æ•°æ®ã€‚

è€Œ AOF é‡Œè®°å½•çš„æ˜¯ Redis æ”¶åˆ°çš„æ¯ä¸€æ¡å‘½ä»¤ï¼Œè¿™äº›å‘½ä»¤æ˜¯ä»¥æ–‡æœ¬å½¢å¼ä¿å­˜çš„ï¼Œä¸åŒçš„æ˜¯ï¼ŒRedis çš„ AOF æ—¥å¿—çš„è®°å½•é¡ºåºä¸ä¼ ç»Ÿå…³ç³»å‹æ•°æ®åº“æ­£å¥½ç›¸åï¼Œå®ƒæ˜¯å†™åæ—¥å¿—ï¼Œâ€œå†™åâ€æ˜¯æŒ‡ Redis è¦å…ˆæ‰§è¡Œå‘½ä»¤ï¼ŒæŠŠæ•°æ®å†™å…¥å†…å­˜ï¼Œç„¶åå†è®°å½•æ—¥å¿—åˆ°æ–‡ä»¶ã€‚

é‚£ä¹ˆé¢è¯•çš„è€ƒå¯Ÿç‚¹æ¥äº†ï¼šReids ä¸ºä»€ä¹ˆå…ˆæ‰§è¡Œå‘½ä»¤ï¼Œåœ¨æŠŠæ•°æ®å†™å…¥æ—¥å¿—å‘¢ï¼Ÿä¸ºäº†æ–¹ä¾¿ä½ ç†è§£ï¼Œæˆ‘æ•´ç†äº†å…³é”®çš„è®°å¿†ç‚¹ï¼š

- å› ä¸º ï¼ŒRedis åœ¨å†™å…¥æ—¥å¿—ä¹‹å‰ï¼Œä¸å¯¹å‘½ä»¤è¿›è¡Œè¯­æ³•æ£€æŸ¥ï¼›

- æ‰€ä»¥ï¼Œåªè®°å½•æ‰§è¡ŒæˆåŠŸçš„å‘½ä»¤ï¼Œé¿å…äº†å‡ºç°è®°å½•é”™è¯¯å‘½ä»¤çš„æƒ…å†µï¼›

- å¹¶ä¸”ï¼Œåœ¨å‘½ä»¤æ‰§è¡Œå®Œä¹‹åå†è®°å½•ï¼Œä¸ä¼šé˜»å¡å½“å‰çš„å†™æ“ä½œã€‚

å½“ç„¶ï¼Œè¿™æ ·åšä¹Ÿä¼šå¸¦æ¥é£é™©ï¼ˆè¿™ä¸€ç‚¹ä½ ä¹Ÿè¦åœ¨é¢è¯•ä¸­ç»™å‡ºè§£é‡Šï¼‰ã€‚

- æ•°æ®å¯èƒ½ä¼šä¸¢å¤±ï¼š å¦‚æœ Redis åˆšæ‰§è¡Œå®Œå‘½ä»¤ï¼Œæ­¤æ—¶å‘ç”Ÿæ•…éšœå®•æœºï¼Œä¼šå¯¼è‡´è¿™æ¡å‘½ä»¤å­˜åœ¨ä¸¢å¤±çš„é£é™©ã€‚

- å¯èƒ½é˜»å¡å…¶ä»–æ“ä½œï¼š è™½ç„¶ AOF æ˜¯å†™åæ—¥å¿—ï¼Œé¿å…é˜»å¡å½“å‰å‘½ä»¤çš„æ‰§è¡Œï¼Œä½†å› ä¸º AOF æ—¥å¿—ä¹Ÿæ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œæ‰€ä»¥å½“ Redis æŠŠæ—¥å¿—æ–‡ä»¶å†™å…¥ç£ç›˜çš„æ—¶å€™ï¼Œè¿˜æ˜¯ä¼šé˜»å¡åç»­çš„æ“ä½œæ— æ³•æ‰§è¡Œã€‚



### ğŸ¯ AOF å¦‚æœæ–‡ä»¶è¶Šæ¥æ„ˆå¤§ æ€ä¹ˆåŠï¼Ÿ

**rewriteï¼ˆAOF é‡å†™ï¼‰**

- æ˜¯ä»€ä¹ˆï¼šAOFé‡‡ç”¨æ–‡ä»¶è¿½åŠ æ–¹å¼ï¼Œæ–‡ä»¶ä¼šè¶Šæ¥è¶Šå¤§ä¸ºé¿å…å‡ºç°æ­¤ç§æƒ…å†µï¼Œæ–°å¢äº†é‡å†™æœºåˆ¶ï¼Œå½“ AOF æ–‡ä»¶çš„å¤§å°è¶…è¿‡æ‰€è®¾å®šçš„é˜ˆå€¼æ—¶ï¼ŒRediså°±ä¼šå¯åŠ¨ AOF æ–‡ä»¶çš„å†…å®¹å‹ç¼©ï¼Œåªä¿ç•™å¯ä»¥æ¢å¤æ•°æ®çš„æœ€å°æŒ‡ä»¤é›†ï¼Œå¯ä»¥ä½¿ç”¨å‘½ä»¤ `bgrewriteaof`ï¼Œè¿™ä¸ªæ“ä½œç›¸å½“äºå¯¹ AOFæ–‡ä»¶â€œç˜¦èº«â€ã€‚
- é‡å†™åŸç†ï¼šAOF æ–‡ä»¶æŒç»­å¢é•¿è€Œè¿‡å¤§æ—¶ï¼Œä¼š fork å‡ºä¸€æ¡æ–°è¿›ç¨‹æ¥å°†æ–‡ä»¶é‡å†™(ä¹Ÿæ˜¯å…ˆå†™ä¸´æ—¶æ–‡ä»¶æœ€åå†rename)ï¼Œéå†æ–°è¿›ç¨‹çš„å†…å­˜ä¸­æ•°æ®ï¼Œæ¯æ¡è®°å½•æœ‰ä¸€æ¡çš„ Set è¯­å¥ã€‚é‡å†™ aof æ–‡ä»¶çš„æ“ä½œï¼Œå¹¶æ²¡æœ‰è¯»å–æ—§çš„aofæ–‡ä»¶ï¼Œè€Œæ˜¯å°†æ•´ä¸ªå†…å­˜ä¸­çš„æ•°æ®åº“å†…å®¹ç”¨å‘½ä»¤çš„æ–¹å¼é‡å†™äº†ä¸€ä¸ªæ–°çš„ aof æ–‡ä»¶ï¼Œè¿™ç‚¹å’Œå¿«ç…§æœ‰ç‚¹ç±»ä¼¼
- è§¦å‘æœºåˆ¶ï¼šRedis ä¼šè®°å½•ä¸Šæ¬¡é‡å†™æ—¶çš„ AOF å¤§å°ï¼Œé»˜è®¤é…ç½®æ˜¯å½“ AOF æ–‡ä»¶å¤§å°æ˜¯ä¸Šæ¬¡ rewrite åå¤§å°çš„ä¸€å€ä¸”æ–‡ä»¶å¤§äº64M æ—¶è§¦å‘



### ğŸ¯ fork è€—æ—¶é—®é¢˜å®šä½

**Forkæ“ä½œ**

å½“RedisåšRDBæˆ–AOFé‡å†™æ—¶ï¼Œä¸€ä¸ªå¿…ä¸å¯å°‘çš„æ“ä½œå°±æ˜¯æ‰§è¡Œforkæ“ä½œåˆ›å»ºå­è¿›ç¨‹ï¼Œå¯¹äºå¤§å¤šæ•°æ“ä½œç³»ç»Ÿæ¥è¯´forkæ˜¯ä¸ªé‡é‡çº§æ“ä½œ

è™½ç„¶forkåˆ›å»ºçš„å­è¿›ç¨‹ä¸éœ€è¦æ‹·è´çˆ¶è¿›ç¨‹çš„ç‰©ç†å†…å­˜ç©ºé—´ï¼Œä½†æ˜¯ä¼šå¤åˆ¶çˆ¶è¿›ç¨‹çš„ç©ºé—´å†…å­˜é¡µè¡¨ã€‚ä¾‹å¦‚å¯¹äº10GBçš„Redisè¿›ç¨‹ï¼Œéœ€è¦å¤åˆ¶å¤§çº¦20MBçš„å†…å­˜é¡µè¡¨ï¼Œå› æ­¤fork æ“ä½œè€—æ—¶è·Ÿè¿›ç¨‹æ€»å†…å­˜é‡æ¯æ¯ç›¸å…³ï¼Œå¦‚æœä½¿ç”¨è™šæ‹ŸåŒ–æŠ€æœ¯ï¼Œç‰¹åˆ«æ˜¯Xenè™šæ‹Ÿ æœºï¼Œforkæ“ä½œä¼šæ›´è€—æ—¶

- åœ¨åš RDB æˆ– AOF é‡å†™æ—¶, fork æ˜¯å¿…ä¸å¯å°‘çš„
- å¯¹äºå¤§å¤šæ•°æ“ä½œç³»ç»Ÿæ¥è¯´, fork æ˜¯ä¸ªé‡é‡çº§é”™è¯¯
- fork ä¼šå¤åˆ¶ç¬¦è¿›ç¨‹çš„ç©ºé—´å†…å­˜é¡µè¡¨
- å¦‚æœä½¿ç”¨è™šæ‹ŸåŒ–æŠ€æœ¯, ç‰¹åˆ«æ˜¯ Xen è™šæ‹Ÿæœº, fork æ“ä½œä¼šæ›´è€—æ—¶

**fork è€—æ—¶é—®é¢˜å®šä½**:

- é«˜æµé‡çš„ Redis å®ä¾‹ ops å¯è¾¾5ä¸‡ä»¥ä¸Š
- æ­£å¸¸æƒ…å†µ fork è€—æ—¶åº”è¯¥æ˜¯æ¯ GB æ¶ˆè€— 20ms å·¦å³
- å¯ä»¥ç”¨ info stats å‘½ä»¤æŸ¥çœ‹ latest_fork_usec æŒ‡æ ‡, è·å–æœ€è¿‘ä¸€æ¬¡ fork æ“ä½œè€—æ—¶, å•ä½å¾®ç§’

**å¦‚ä½•æ”¹å–„ fork æ“ä½œçš„è€—æ—¶**:

- ä¼˜å…ˆä½¿ç”¨ç‰©ç†æœºæˆ–è€…é«˜æ•ˆæ”¯æŒ fork æ“ä½œçš„è™šæ‹ŸåŒ–æŠ€æœ¯, é¿å…ä½¿ç”¨ Xen
- æ§åˆ¶ Redis å®ä¾‹æœ€å¤§å¯ç”¨å†…å­˜, fork è€—æ—¶è·Ÿå†…å­˜é‡æˆæ­£æ¯”, çº¿ä¸Šå»ºè®®æ¯ä¸ª Redis å®ä¾‹å†…å­˜æ§åˆ¶åœ¨ 10GB ä»¥å†…
- åˆç†é…ç½® Linux å†…å­˜åˆ†é…ç­–ç•¥, é¿å…ç‰©ç†å†…å­˜ä¸è¶³å¯¼è‡´ fork å¤±è´¥
- é™ä½ fork æ“ä½œçš„é¢‘ç‡, å¦‚é€‚åº¦æ”¾å®½ AOF è‡ªåŠ¨è§¦å‘æ—¶æœº, é¿å…ä¸å¿…è¦çš„å…¨é‡å¤åˆ¶ç­‰



### ğŸ¯ ä¸¤ç§æŒä¹…åŒ–æ–¹å¼å¦‚ä½•é€‰æ‹©ï¼Ÿ

- RDB æŒä¹…åŒ–æ–¹å¼èƒ½å¤Ÿåœ¨æŒ‡å®šçš„æ—¶é—´é—´éš”èƒ½å¯¹ä½ çš„æ•°æ®è¿›è¡Œå¿«ç…§å­˜å‚¨ï¼Œå¯åŠ¨å¿«ã€æ–‡ä»¶å°ï¼Œä½†ä¼šä¸¢â€œå¿«ç…§å‘¨æœŸå†…â€çš„æ•°æ®ã€‚
- AOF æŒä¹…åŒ–æ–¹å¼è®°å½•æ¯æ¬¡å¯¹æœåŠ¡å™¨å†™çš„æ“ä½œ,å½“æœåŠ¡å™¨é‡å¯çš„æ—¶å€™ä¼šé‡æ–°æ‰§è¡Œè¿™äº›å‘½ä»¤æ¥æ¢å¤åŸå§‹çš„æ•°æ®ï¼ŒAOFå‘½ä»¤ä»¥ redis åè®®è¿½åŠ ä¿å­˜æ¯æ¬¡å†™çš„æ“ä½œåˆ°æ–‡ä»¶æœ«å°¾ã€‚Redisè¿˜èƒ½å¯¹AOFæ–‡ä»¶è¿›è¡Œåå°é‡å†™ï¼ˆ**bgrewriteaof**ï¼‰,ä½¿å¾— AOF æ–‡ä»¶çš„ä½“ç§¯ä¸è‡³äºè¿‡å¤§
- åªåšç¼“å­˜ï¼šå¦‚æœä½ åªå¸Œæœ›ä½ çš„æ•°æ®åœ¨æœåŠ¡å™¨è¿è¡Œçš„æ—¶å€™å­˜åœ¨,ä½ ä¹Ÿå¯ä»¥ä¸ä½¿ç”¨ä»»ä½•æŒä¹…åŒ–æ–¹å¼ã€‚
- åŒæ—¶å¼€å¯ä¸¤ç§æŒä¹…åŒ–æ–¹å¼
  - åœ¨è¿™ç§æƒ…å†µä¸‹,å½“ redis é‡å¯çš„æ—¶å€™ä¼šä¼˜å…ˆè½½å…¥ AOF æ–‡ä»¶æ¥æ¢å¤åŸå§‹çš„æ•°æ®,å› ä¸ºåœ¨é€šå¸¸æƒ…å†µä¸‹ AOF æ–‡ä»¶ä¿å­˜çš„æ•°æ®é›†è¦æ¯” RDB æ–‡ä»¶ä¿å­˜çš„æ•°æ®é›†è¦å®Œæ•´ã€‚
  - RDB çš„æ•°æ®ä¸å®æ—¶ï¼ŒåŒæ—¶ä½¿ç”¨ä¸¤è€…æ—¶æœåŠ¡å™¨é‡å¯ä¹Ÿåªä¼šæ‰¾ AOF æ–‡ä»¶ã€‚é‚£è¦ä¸è¦åªä½¿ç”¨AOF å‘¢ï¼Ÿå»ºè®®ä¸è¦ï¼Œå› ä¸º RDB æ›´é€‚åˆç”¨äºå¤‡ä»½æ•°æ®åº“(AOF åœ¨ä¸æ–­å˜åŒ–ä¸å¥½å¤‡ä»½)ï¼Œå¿«é€Ÿé‡å¯ï¼Œè€Œä¸”ä¸ä¼šæœ‰ AOF å¯èƒ½æ½œåœ¨çš„bugï¼Œç•™ç€ä½œä¸ºä¸€ä¸ªä¸‡ä¸€çš„æ‰‹æ®µã€‚

Redis4.0 ä¹‹åæœ‰äº†æ··åˆæŒä¹…åŒ–çš„åŠŸèƒ½ï¼Œå°† bgsave çš„å…¨é‡ å’Œ aof çš„å¢é‡åšäº†èåˆå¤„ç†ï¼Œè¿™æ ·æ—¢ä¿è¯äº†æ¢å¤çš„æ•ˆç‡åˆå…¼é¡¾äº†æ•°æ®çš„å®‰å…¨æ€§ã€‚bgsave çš„ åŸç†ï¼Œfork å’Œ cow, fork æ˜¯æŒ‡ redis é€šè¿‡åˆ›å»ºå­è¿›ç¨‹æ¥è¿›è¡Œ bgsave æ“ä½œï¼Œcow æŒ‡çš„æ˜¯ copy on writeï¼Œå­è¿›ç¨‹åˆ›å»ºåï¼Œçˆ¶å­è¿›ç¨‹å…±äº«æ•°æ®æ®µï¼Œçˆ¶è¿›ç¨‹ç»§ç»­æä¾›è¯»å†™æœåŠ¡ï¼Œå†™è„çš„é¡µé¢æ•°æ® ä¼šé€æ¸å’Œå­è¿›ç¨‹åˆ†ç¦»å¼€æ¥ã€‚



### ğŸ¯ Redis è¿‡æœŸé”®çš„åˆ é™¤ç­–ç•¥ï¼Ÿ

å…ˆæŠ›å¼€ Redis æƒ³ä¸€ä¸‹å‡ ç§å¯èƒ½çš„åˆ é™¤ç­–ç•¥ï¼š

1. **å®šæ—¶åˆ é™¤**ï¼šåœ¨è®¾ç½®é”®çš„è¿‡æœŸæ—¶é—´çš„åŒæ—¶ï¼Œåˆ›å»ºä¸€ä¸ªå®šæ—¶å™¨ timer. è®©å®šæ—¶å™¨åœ¨é”®çš„è¿‡æœŸæ—¶é—´æ¥ä¸´æ—¶ï¼Œç«‹å³æ‰§è¡Œå¯¹é”®çš„åˆ é™¤æ“ä½œã€‚
2. **æƒ°æ€§åˆ é™¤**ï¼šæ”¾ä»»é”®è¿‡æœŸä¸ç®¡ï¼Œä½†æ˜¯æ¯æ¬¡ä»é”®ç©ºé—´ä¸­è·å–é”®æ—¶ï¼Œéƒ½æ£€æŸ¥å–å¾—çš„é”®æ˜¯å¦è¿‡æœŸï¼Œå¦‚æœè¿‡æœŸçš„è¯ï¼Œå°±åˆ é™¤è¯¥é”®;å¦‚æœæ²¡æœ‰è¿‡æœŸï¼Œå°±è¿”å›è¯¥é”®ã€‚
3. **å®šæœŸåˆ é™¤**ï¼šæ¯éš”ä¸€æ®µæ—¶é—´ç¨‹åºå°±å¯¹æ•°æ®åº“è¿›è¡Œä¸€æ¬¡æ£€æŸ¥ï¼Œåˆ é™¤é‡Œé¢çš„è¿‡æœŸé”®ã€‚è‡³äºè¦åˆ é™¤å¤šå°‘è¿‡æœŸé”®ï¼Œä»¥åŠè¦æ£€æŸ¥å¤šå°‘ä¸ªæ•°æ®åº“ï¼Œåˆ™ç”±ç®—æ³•å†³å®šã€‚
4. **å»¶è¿Ÿé˜Ÿåˆ—**ï¼šä¹Ÿå°±æ˜¯æŠŠå¯¹è±¡æ”¾åˆ°ä¸€ä¸ªå»¶è¿Ÿé˜Ÿåˆ—é‡Œé¢ã€‚å½“ä»é˜Ÿåˆ—é‡Œå–å‡ºè¿™ä¸ªå¯¹è±¡çš„æ—¶å€™ï¼Œå°±è¯´æ˜å®ƒå·²ç»è¿‡æœŸäº†ï¼Œè¿™æ—¶å€™å°±å¯ä»¥åˆ é™¤ã€‚

åœ¨ä¸Šè¿°çš„å‡ ç§ç­–ç•¥ä¸­å®šæ—¶åˆ é™¤å’Œå®šæœŸåˆ é™¤å±äºä¸åŒæ—¶é—´ç²’åº¦çš„ **ä¸»åŠ¨åˆ é™¤**ï¼Œæƒ°æ€§åˆ é™¤å±äº **è¢«åŠ¨åˆ é™¤**ã€‚

**å››ç§ç­–ç•¥éƒ½æœ‰å„è‡ªçš„ä¼˜ç¼ºç‚¹**

1. å®šæ—¶åˆ é™¤å¯¹å†…å­˜ä½¿ç”¨ç‡æœ‰ä¼˜åŠ¿ï¼Œä½†æ˜¯å¯¹ CPU ä¸å‹å¥½ï¼›
2. æƒ°æ€§åˆ é™¤å¯¹å†…å­˜ä¸å‹å¥½ï¼Œå¦‚æœæŸäº›é”®å€¼å¯¹ä¸€ç›´ä¸è¢«ä½¿ç”¨ï¼Œé‚£ä¹ˆä¼šé€ æˆä¸€å®šé‡çš„å†…å­˜æµªè´¹ï¼›
3. å»¶è¿Ÿåˆ é™¤ï¼Œé˜Ÿåˆ—æœ¬çœå°±æœ‰å¼€é”€
4. å®šæœŸåˆ é™¤ï¼Œæ—¶é—´ä¸å‡†ç¡®ï¼Œæ€§èƒ½æŸè€—ä¸å¯æ§ï¼Œå¦‚æœè§¦å‘åˆ é™¤çš„æ—¶å€™ï¼Œå¾ˆå¤šå·²ç»è¿‡æœŸäº†ï¼Œé‚£ä¹ˆå½“æœŸå®šæ—¶åˆ é™¤å°±å¾ˆè€—æ—¶ï¼›

**Redis ä¸­çš„å®ç°**

Redis è¿‡æœŸé”®çš„åˆ é™¤ç­–ç•¥æœ‰ä¸‰ç§ä¸»è¦æ–¹æ³•ï¼š**å®šæœŸåˆ é™¤**ï¼ˆScheduled Deletionï¼‰ã€**æƒ°æ€§åˆ é™¤**ï¼ˆLazy Deletionï¼‰å’Œ**ä¸»åŠ¨åˆ é™¤**ï¼ˆActive Deletionï¼‰ã€‚è¿™äº›ç­–ç•¥ç»“åˆä½¿ç”¨ï¼Œä»¥ç¡®ä¿åœ¨æ€§èƒ½å’Œå†…å­˜ä¹‹é—´å–å¾—å¹³è¡¡ã€‚

**1. å®šæœŸåˆ é™¤ï¼ˆScheduled Deletionï¼‰**

Redis å®šæœŸæ£€æŸ¥é”®çš„è¿‡æœŸæ—¶é—´å¹¶åˆ é™¤è¿‡æœŸé”®ã€‚è¿™ä¸ªè¿‡ç¨‹æ˜¯é€šè¿‡ Redis çš„åå°ä»»åŠ¡è¿›è¡Œçš„ï¼Œæ¯éš”ä¸€æ®µæ—¶é—´ä¼šéšæœºæ£€æŸ¥ä¸€éƒ¨åˆ†é”®ï¼Œåˆ é™¤å…¶ä¸­å·²è¿‡æœŸçš„é”®ã€‚

- **å®ç°æ–¹å¼**ï¼šé»˜è®¤æƒ…å†µä¸‹ï¼ŒRedis æ¯éš” 100 æ¯«ç§’è¿è¡Œä¸€æ¬¡è¿‡æœŸæ‰«æä»»åŠ¡ï¼Œæ£€æŸ¥è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„é”®ï¼Œå¹¶åˆ é™¤è¿‡æœŸçš„é”®ã€‚
- **ä¼˜ç‚¹**ï¼šåˆ†æ‘Šäº†åˆ é™¤æ“ä½œçš„å¼€é”€ï¼Œé¿å…äº†é›†ä¸­åˆ é™¤å¤§é‡é”®å¯¼è‡´çš„æ€§èƒ½é—®é¢˜ã€‚
- **ç¼ºç‚¹**ï¼šä¸èƒ½ä¿è¯è¿‡æœŸé”®åœ¨è¿‡æœŸåç«‹å³è¢«åˆ é™¤ï¼Œå¯èƒ½ä¼šå­˜åœ¨ä¸€æ®µæ—¶é—´çš„æ»ç•™ã€‚

**2. æƒ°æ€§åˆ é™¤ï¼ˆLazy Deletionï¼‰**

å½“å®¢æˆ·ç«¯è®¿é—®æŸä¸ªé”®æ—¶ï¼ŒRedis ä¼šæ£€æŸ¥è¯¥é”®æ˜¯å¦è¿‡æœŸï¼Œå¦‚æœè¿‡æœŸåˆ™ç«‹å³åˆ é™¤ã€‚

`expireIfNeeded` çš„ä½œç”¨æ˜¯ï¼Œ å¦‚æœè¾“å…¥é”®å·²ç»è¿‡æœŸçš„è¯ï¼Œ é‚£ä¹ˆå°†é”®ã€é”®çš„å€¼ã€é”®ä¿å­˜åœ¨ `expires` å­—å…¸ä¸­çš„è¿‡æœŸæ—¶é—´éƒ½åˆ é™¤æ‰ã€‚

- **å®ç°æ–¹å¼**ï¼šæ¯æ¬¡è®¿é—®é”®æ—¶ï¼Œéƒ½ä¼šè¿›è¡Œè¿‡æœŸæ—¶é—´æ£€æŸ¥ï¼Œè‹¥é”®å·²è¿‡æœŸåˆ™åˆ é™¤è¯¥é”®å¹¶è¿”å›ç©ºç»“æœã€‚
- **ä¼˜ç‚¹**ï¼šç¡®ä¿è®¿é—®æ—¶ä¸€å®šä¸ä¼šè¿”å›å·²è¿‡æœŸçš„é”®ï¼Œåˆ é™¤æ“ä½œä¸é”®çš„è®¿é—®ç›¸ç»“åˆï¼Œä¸é¢å¤–æ¶ˆè€— CPU èµ„æºã€‚
- **ç¼ºç‚¹**ï¼šå¦‚æœæŸäº›è¿‡æœŸé”®é•¿æ—¶é—´ä¸è¢«è®¿é—®ï¼Œå®ƒä»¬å°†ç»§ç»­å ç”¨å†…å­˜ï¼Œç›´åˆ°è¢«å®šæœŸåˆ é™¤ä»»åŠ¡æˆ–å…¶ä»–æ–¹å¼åˆ é™¤ã€‚

**3. ä¸»åŠ¨åˆ é™¤ï¼ˆActive Deletionï¼‰**

å½“ Redis å†…å­˜ä¸è¶³æ—¶ï¼Œä¼šä¸»åŠ¨æ‰«æå¹¶åˆ é™¤è¿‡æœŸé”®ï¼Œä»¥é‡Šæ”¾å†…å­˜ã€‚

- **å®ç°æ–¹å¼**ï¼šRedis é…ç½®äº†å†…å­˜æ·˜æ±°ç­–ç•¥ï¼ˆå¦‚ `volatile-lru`ã€`allkeys-lru` ç­‰ï¼‰ï¼Œå½“å†…å­˜è¾¾åˆ°é™åˆ¶æ—¶ï¼ŒRedis ä¼šé€šè¿‡åˆ é™¤è¿‡æœŸé”®æ¥é‡Šæ”¾å†…å­˜ã€‚
- **ä¼˜ç‚¹**ï¼šç¡®ä¿åœ¨å†…å­˜ä¸è¶³æ—¶èƒ½å¤ŸåŠæ—¶é‡Šæ”¾å†…å­˜ï¼Œé¿å…ç³»ç»Ÿå› å†…å­˜ä¸è¶³å´©æºƒã€‚
- **ç¼ºç‚¹**ï¼šè¿™ç§æ–¹å¼é€šå¸¸ä½œä¸ºå†…å­˜æ·˜æ±°ç­–ç•¥çš„ä¸€éƒ¨åˆ†ï¼Œä¸å•ç‹¬ä½¿ç”¨ã€‚

> åœ¨ Redis çš„ 3.2 ç‰ˆæœ¬ä¹‹å‰ï¼Œå¦‚æœè¯»ä»åº“çš„è¯ï¼Œæ˜¯æœ‰å¯èƒ½è¯»å–åˆ°å·²ç»è¿‡æœŸçš„keyã€‚åæ¥åœ¨ 3.2 ç‰ˆæœ¬ä¹‹åè¿™ä¸ª Bug å°±è¢«ä¿®å¤äº†ã€‚ä¸è¿‡ä»åº“ä¸Šçš„æ‡’æƒ°åˆ é™¤ç‰¹æ€§å’Œä¸»åº“ä¸ä¸€æ ·ã€‚ä¸»åº“ä¸Šçš„æ‡’æƒ°åˆ é™¤æ˜¯åœ¨å‘ç° key å·²ç»è¿‡æœŸä¹‹åï¼Œå°±ç›´æ¥åˆ é™¤äº†ã€‚ä½†æ˜¯åœ¨ä»åº“ä¸Šï¼Œå³ä¾¿ key å·²ç»è¿‡æœŸäº†ï¼Œå®ƒä¹Ÿä¸ä¼šåˆ é™¤ï¼Œåªæ˜¯ä¼šç»™ä½ è¿”å›ä¸€ä¸ª NULL å€¼ã€‚



### ğŸ¯ Redis çš„æ·˜æ±°ç­–ç•¥æœ‰å“ªäº›ï¼Ÿ

**Redis æœ‰å…«ç§æ·˜æ±°ç­–ç•¥**

ä¸ºäº†ä¿è¯ Redis çš„å®‰å…¨ç¨³å®šè¿è¡Œï¼Œè®¾ç½®äº†ä¸€ä¸ª `max-memory` çš„é˜ˆå€¼ï¼Œé‚£ä¹ˆå½“å†…å­˜ç”¨é‡åˆ°è¾¾é˜ˆå€¼ï¼Œæ–°å†™å…¥çš„é”®å€¼å¯¹æ— æ³•å†™å…¥ï¼Œæ­¤æ—¶å°±éœ€è¦å†…å­˜æ·˜æ±°æœºåˆ¶ï¼Œåœ¨ Redis çš„é…ç½®ä¸­æœ‰å‡ ç§æ·˜æ±°ç­–ç•¥å¯ä»¥é€‰æ‹©ï¼Œè¯¦ç»†å¦‚ä¸‹ï¼š

| ç­–ç•¥            | æè¿°                                                         |
| --------------- | ------------------------------------------------------------ |
| volatile-lru    | ä»å·²è®¾ç½®è¿‡æœŸæ—¶é—´çš„ KV é›†ä¸­ä¼˜å…ˆå¯¹æœ€è¿‘æœ€å°‘ä½¿ç”¨(less recently used)çš„æ•°æ®æ·˜æ±° |
| volitile-ttl    | ä»å·²è®¾ç½®è¿‡æœŸæ—¶é—´çš„ KV é›†ä¸­ä¼˜å…ˆå¯¹å‰©ä½™æ—¶é—´çŸ­(time to live)çš„æ•°æ®æ·˜æ±° |
| volitile-random | ä»å·²è®¾ç½®è¿‡æœŸæ—¶é—´çš„ KV é›†ä¸­éšæœºé€‰æ‹©æ•°æ®æ·˜æ±°                   |
| allkeys-lru     | ä»æ‰€æœ‰ KV é›†ä¸­ä¼˜å…ˆå¯¹æœ€è¿‘æœ€å°‘ä½¿ç”¨(less recently used)çš„æ•°æ®æ·˜æ±° |
| allKeys-random  | ä»æ‰€æœ‰ KV é›†ä¸­éšæœºé€‰æ‹©æ•°æ®æ·˜æ±°                               |
| noeviction      | ä¸æ·˜æ±°ç­–ç•¥ï¼Œè‹¥è¶…è¿‡æœ€å¤§å†…å­˜ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯                     |

**4.0 ç‰ˆæœ¬åå¢åŠ ä»¥ä¸‹ä¸¤ç§**

- volatile-lfuï¼šä»å·²è®¾ç½®è¿‡æœŸæ—¶é—´çš„æ•°æ®é›†(server.db[i].expires)ä¸­æŒ‘é€‰æœ€ä¸ç»å¸¸ä½¿ç”¨çš„æ•°æ®æ·˜æ±°
- allkeys-lfuï¼šå½“å†…å­˜ä¸è¶³ä»¥å®¹çº³æ–°å†™å…¥æ•°æ®æ—¶ï¼Œåœ¨é”®ç©ºé—´ä¸­ï¼Œç§»é™¤æœ€ä¸ç»å¸¸ä½¿ç”¨çš„ key



### ğŸ¯ ä¸€ç»„æ›¾ç»æ˜¯çƒ­ç‚¹æ•°æ®ï¼Œåé¢ä¸æ˜¯äº†ï¼Œå¯¹äºlruå’Œlfuå¤„ç†æ—¶ä¼šæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

> **LRUï¼ˆLeast Recently Usedï¼‰**ï¼šåŸºäº**æ—¶é—´ç»´åº¦**ï¼Œæ·˜æ±°æœ€ä¹…æœªè¢«è®¿é—®çš„æ•°æ®ã€‚
>
> **LFUï¼ˆLeast Frequently Usedï¼‰**ï¼šåŸºäº**é¢‘ç‡ç»´åº¦**ï¼Œæ·˜æ±°ä¸€å®šæ—¶æœŸå†…è®¿é—®æ¬¡æ•°æœ€å°‘çš„æ•°æ®ã€‚

**æ›¾ç»æ˜¯çƒ­ç‚¹æ•°æ®ï¼Œåæ¥ä¸å†æ˜¯çƒ­ç‚¹ï¼Œå¯¹äº LRU å’Œ LFU çš„å¤„ç†åŒºåˆ«**

- **å¯¹äº LRU ç­–ç•¥**ï¼š
  - **è¡Œä¸º**ï¼šå½“ä¸€ç»„æ•°æ®æ›¾ç»æ˜¯çƒ­ç‚¹ï¼Œè¢«é¢‘ç¹è®¿é—®ï¼Œå…¶æœ€è¿‘è®¿é—®æ—¶é—´ä¼šè¢«æ›´æ–°ä¸ºæœ€æ–°å€¼ã€‚ç„¶è€Œï¼Œå½“å®ƒä»¬ä¸å†è¢«è®¿é—®æ—¶ï¼Œéšç€æ—¶é—´æ¨ç§»ï¼Œå…¶æ—¶é—´æˆ³ä¼šé€æ¸å˜æ—§ã€‚
  - **æ·˜æ±°æœºåˆ¶**ï¼šå½“éœ€è¦æ·˜æ±°æ•°æ®æ—¶ï¼ŒLRU ä¼šé€‰æ‹©é‚£äº›æœ€è¿‘æœ€å°‘è¢«è®¿é—®çš„é”®ï¼Œå³æ—¶é—´æˆ³æœ€æ—©çš„é”®ã€‚å› æ­¤ï¼Œè¿™äº›æ›¾ç»çš„çƒ­ç‚¹æ•°æ®ä¼šå› ä¸ºé•¿æ—¶é—´æœªè¢«è®¿é—®è€Œè¢«ä¼˜å…ˆæ·˜æ±°ã€‚
  - **æ•ˆæœ**ï¼šLRU èƒ½å¤Ÿè¾ƒå¿«åœ°æ¸…é™¤ä¸å†è¢«ä½¿ç”¨çš„æ—§çƒ­ç‚¹æ•°æ®ï¼Œä¸ºæ–°çš„æ•°æ®è…¾å‡ºç©ºé—´ã€‚
- **å¯¹äº LFU ç­–ç•¥**ï¼š
  - **è¡Œä¸º**ï¼šæ›¾ç»æ˜¯çƒ­ç‚¹çš„æ•°æ®ï¼Œå…¶è®¿é—®è®¡æ•°å™¨è¾ƒé«˜ï¼Œå³ä½¿ä¹‹åä¸å†è¢«è®¿é—®ï¼Œå…¶è®¡æ•°å€¼ä»ç„¶ä¿æŒåœ¨é«˜ä½ã€‚
  - **æ·˜æ±°æœºåˆ¶**ï¼šLFU ä¼šé€‰æ‹©è®¿é—®é¢‘ç‡æœ€ä½çš„é”®è¿›è¡Œæ·˜æ±°ã€‚ç”±äºæ—§çƒ­ç‚¹æ•°æ®çš„è®¡æ•°å™¨è¾ƒé«˜ï¼Œå®ƒä»¬ä¸ä¼šè¢«ç«‹å³æ·˜æ±°ã€‚
  - **è¡°å‡æœºåˆ¶**ï¼šRedis ä¸ºäº†é¿å…æ—§çƒ­ç‚¹æ•°æ®é•¿æœŸå ç”¨å†…å­˜ï¼Œå¼•å…¥äº†è®¡æ•°å™¨è¡°å‡æœºåˆ¶ã€‚è®¡æ•°å™¨ä¼šéšç€æ—¶é—´é€æ¸é™ä½ï¼Œå¦‚æœé”®é•¿æ—¶é—´æœªè¢«è®¿é—®ï¼Œè®¡æ•°å™¨ä¼šå‡å°ï¼Œæœ€ç»ˆå¯èƒ½è¢«æ·˜æ±°ã€‚
  - **æ•ˆæœ**ï¼šLFU ä¼šæ›´é•¿æ—¶é—´åœ°ä¿ç•™æ›¾ç»çš„çƒ­ç‚¹æ•°æ®ï¼Œå³ä½¿å®ƒä»¬è¿‘æœŸæœªè¢«è®¿é—®ã€‚è¿™åœ¨ä¸€å®šç¨‹åº¦ä¸Šä¿æŠ¤äº†å†å²ä¸Šé‡è¦çš„æ•°æ®ï¼Œä½†ä¹Ÿå¯èƒ½å¯¼è‡´æ—§æ•°æ®å ç”¨å†…å­˜ç©ºé—´ã€‚



### ğŸ¯ Redis å†…å­˜æ»¡äº†æ€ä¹ˆåŠ

1. å¢åŠ å†…å­˜ï¼›
2. ä½¿ç”¨å†…å­˜æ·˜æ±°ç­–ç•¥ï¼ˆredisè®¾ç½®é…ç½®æ–‡ä»¶çš„***maxmemory**å‚æ•°ï¼Œå¯ä»¥æ§åˆ¶å…¶æœ€å¤§å¯ç”¨å†…å­˜å¤§å°ï¼Œå¯ä»¥é€šè¿‡é…ç½® **maxmemory-policy** è®¾ç½®æ·˜æ±°ç­–ç•¥ï¼‰
3. å‹ç¼©æ•°æ®
4. é›†ç¾¤



### ğŸ¯ Redis çº¿ç¨‹æ¨¡å‹

Redis çš„çº¿ç¨‹æ¨¡å‹æ˜¯å•çº¿ç¨‹äº‹ä»¶é©±åŠ¨æ¨¡å‹ï¼Œè¿™æ„å‘³ç€å®ƒåœ¨å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚æ—¶ä½¿ç”¨å•ä¸ªçº¿ç¨‹ã€‚ç„¶è€Œï¼ŒRedis ä½¿ç”¨ I/O å¤šè·¯å¤ç”¨æŠ€æœ¯æ¥é«˜æ•ˆåœ°ç®¡ç†å¤šä¸ªå®¢æˆ·ç«¯è¿æ¥ã€‚ä»¥ä¸‹æ˜¯ Redis çº¿ç¨‹æ¨¡å‹çš„ä¸»è¦ç‰¹ç‚¹å’Œå·¥ä½œåŸç†ï¼š

**å•çº¿ç¨‹æ¨¡å‹**

1. **å•çº¿ç¨‹æ¶æ„**ï¼š
   - Redis ä¸»è¦ä½¿ç”¨å•ä¸ªçº¿ç¨‹æ¥å¤„ç†æ‰€æœ‰å®¢æˆ·ç«¯è¯·æ±‚ï¼ŒåŒ…æ‹¬è¯»å†™æ“ä½œå’Œå‘½ä»¤æ‰§è¡Œã€‚è¿™ä½¿å¾— Redis çš„å®ç°ç›¸å¯¹ç®€å•ä¸”é«˜æ•ˆï¼Œå› ä¸ºä¸éœ€è¦å¤„ç†å¤šçº¿ç¨‹å¹¶å‘é—®é¢˜ï¼Œå¦‚é”ç«äº‰å’Œçº¿ç¨‹åŒæ­¥ã€‚
2. **I/O å¤šè·¯å¤ç”¨**ï¼š
   - Redis ä½¿ç”¨ I/O å¤šè·¯å¤ç”¨ï¼ˆI/O multiplexingï¼‰æŠ€æœ¯ï¼Œé€šè¿‡ `epoll`ï¼ˆLinuxï¼‰ã€`kqueue`ï¼ˆBSDï¼‰æˆ– `select` ç­‰ç³»ç»Ÿè°ƒç”¨æ¥åŒæ—¶å¤„ç†å¤šä¸ªå®¢æˆ·ç«¯è¿æ¥ã€‚I/O å¤šè·¯å¤ç”¨å…è®¸ Redis åœ¨ä¸€ä¸ªçº¿ç¨‹å†…åŒæ—¶å¤„ç†å¤§é‡è¿æ¥è€Œä¸ä¼šé˜»å¡ã€‚
   - I/O å¤šè·¯å¤ç”¨æœºåˆ¶ä½¿å¾— Redis å¯ä»¥åœ¨ä¸€ä¸ªäº‹ä»¶å¾ªç¯ä¸­å¤„ç†å¤šä¸ªå¥—æ¥å­—çš„ I/O äº‹ä»¶ï¼Œä»è€Œæé«˜å¹¶å‘å¤„ç†èƒ½åŠ›ã€‚

**äº‹ä»¶é©±åŠ¨æ¨¡å‹**

Redis ä½¿ç”¨äº‹ä»¶é©±åŠ¨æ¨¡å‹ï¼ˆEvent-Driven Modelï¼‰ï¼Œåœ¨ä¸»çº¿ç¨‹çš„äº‹ä»¶å¾ªç¯ä¸­æ‰§è¡Œå„ç§äº‹ä»¶ï¼ŒåŒ…æ‹¬ç½‘ç»œäº‹ä»¶å’Œå®šæ—¶äº‹ä»¶ã€‚äº‹ä»¶é©±åŠ¨æ¨¡å‹ç¡®ä¿ Redis å¯ä»¥é«˜æ•ˆåœ°å¤„ç†å¤§é‡å¹¶å‘è¯·æ±‚ã€‚

1. **äº‹ä»¶å¾ªç¯**ï¼š
   - Redis çš„äº‹ä»¶å¾ªç¯ä¸æ–­åœ°æ£€æŸ¥ç½‘ç»œäº‹ä»¶ï¼ˆå¦‚å®¢æˆ·ç«¯è¿æ¥å’Œæ•°æ®ä¼ è¾“ï¼‰å’Œå®šæ—¶äº‹ä»¶ï¼ˆå¦‚é”®è¿‡æœŸæ£€æŸ¥ï¼‰ã€‚å½“äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œè°ƒç”¨ç›¸åº”çš„äº‹ä»¶å¤„ç†å‡½æ•°è¿›è¡Œå¤„ç†ã€‚
2. **äº‹ä»¶å¤„ç†å™¨**ï¼š
   - Redis å°†ç½‘ç»œ I/O æ“ä½œå’Œå‘½ä»¤æ‰§è¡Œåˆ†æˆä¸åŒçš„äº‹ä»¶å¤„ç†å™¨ã€‚ç½‘ç»œ I/O å¤„ç†å™¨è´Ÿè´£æ¥å—å®¢æˆ·ç«¯è¿æ¥ã€è¯»å–è¯·æ±‚å’Œå‘é€å“åº”ï¼Œå‘½ä»¤å¤„ç†å™¨è´Ÿè´£æ‰§è¡Œå…·ä½“çš„ Redis å‘½ä»¤ã€‚

**å¤šçº¿ç¨‹ I/O æ¨¡å¼**

è™½ç„¶ Redis æœ¬è´¨ä¸Šæ˜¯å•çº¿ç¨‹æ¨¡å‹ï¼Œä½†åœ¨ 6.0 ç‰ˆæœ¬å¼€å§‹å¼•å…¥äº†æœ‰é™çš„å¤šçº¿ç¨‹æ”¯æŒï¼Œç”¨äºå¤„ç† I/O æ“ä½œã€‚é€šè¿‡å¯ç”¨ I/O çº¿ç¨‹ï¼Œå¯ä»¥åœ¨å¤„ç†ç½‘ç»œ I/O æ—¶åˆ©ç”¨å¤šæ ¸ CPUï¼Œä»è€Œæé«˜æ€§èƒ½ã€‚

1. I/O çº¿ç¨‹

   - Redis 6.0 åŠæ›´é«˜ç‰ˆæœ¬å¯ä»¥é…ç½®å¤šä¸ª I/O çº¿ç¨‹ç”¨äºè¯»å–å’Œå¤„ç†å®¢æˆ·ç«¯è¯·æ±‚ï¼Œä½†å‘½ä»¤æ‰§è¡Œä»ç„¶åœ¨ä¸»çº¿ç¨‹ä¸­è¿›è¡Œã€‚è¿™æ ·å¯ä»¥å‡å°‘ I/O æ“ä½œå¯¹ä¸»çº¿ç¨‹çš„é˜»å¡ï¼Œæé«˜æ•´ä½“ååé‡ã€‚

2. é…ç½®ç¤ºä¾‹ï¼š åœ¨ `redis.conf`ä¸­å¯ç”¨å’Œé…ç½® I/O çº¿ç¨‹ï¼š

   ```shel
   io-threads-do-reads yes
   io-threads 4  # é…ç½® I/O çº¿ç¨‹æ•°
   ```

> Redis åŸºäº Reactor æ¨¡å¼å¼€å‘äº†ç½‘ç»œäº‹ä»¶å¤„ç†å™¨ï¼Œè¿™ä¸ªå¤„ç†å™¨è¢«ç§°ä¸ºæ–‡ä»¶äº‹ä»¶å¤„ç†å™¨ï¼ˆfile event handlerï¼‰ã€‚å®ƒçš„ç»„æˆç»“æ„ä¸º4éƒ¨åˆ†ï¼šå¤šä¸ªå¥—æ¥å­—ã€IOå¤šè·¯å¤ç”¨ç¨‹åºã€æ–‡ä»¶äº‹ä»¶åˆ†æ´¾å™¨ã€äº‹ä»¶å¤„ç†å™¨ã€‚å› ä¸ºæ–‡ä»¶äº‹ä»¶åˆ†æ´¾å™¨é˜Ÿåˆ—çš„æ¶ˆè´¹æ˜¯å•çº¿ç¨‹çš„ï¼Œæ‰€ä»¥ Redis æ‰å«å•çº¿ç¨‹æ¨¡å‹ã€‚
>
> æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨ä½¿ç”¨ I/O å¤šè·¯å¤ç”¨ï¼ˆmultiplexingï¼‰ç¨‹åºæ¥åŒæ—¶ç›‘å¬å¤šä¸ªå¥—æ¥å­—ï¼Œå¹¶æ ¹æ®å¥—æ¥å­—ç›®å‰æ‰§è¡Œçš„ä»»åŠ¡æ¥ä¸ºå¥—æ¥å­—å…³è”ä¸åŒçš„äº‹ä»¶å¤„ç†å™¨ã€‚
>
> å½“è¢«ç›‘å¬çš„å¥—æ¥å­—å‡†å¤‡å¥½æ‰§è¡Œè¿æ¥åº”ç­”ï¼ˆacceptï¼‰ã€è¯»å–ï¼ˆreadï¼‰ã€å†™å…¥ï¼ˆwriteï¼‰ã€å…³é—­ï¼ˆcloseï¼‰ç­‰æ“ä½œæ—¶ï¼Œ ä¸æ“ä½œç›¸å¯¹åº”çš„æ–‡ä»¶äº‹ä»¶å°±ä¼šäº§ç”Ÿï¼Œè¿™æ—¶æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨å°±ä¼šè°ƒç”¨å¥—æ¥å­—ä¹‹å‰å…³è”å¥½çš„äº‹ä»¶å¤„ç†å™¨æ¥å¤„ç†è¿™äº›äº‹ä»¶ã€‚
>
> è™½ç„¶æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨ä»¥å•çº¿ç¨‹æ–¹å¼è¿è¡Œï¼Œ ä½†é€šè¿‡ä½¿ç”¨ I/O å¤šè·¯å¤ç”¨ç¨‹åºæ¥ç›‘å¬å¤šä¸ªå¥—æ¥å­—ï¼Œæ–‡ä»¶äº‹ä»¶å¤„ç†å™¨æ—¢å®ç°äº†é«˜æ€§èƒ½çš„ç½‘ç»œé€šä¿¡æ¨¡å‹ï¼Œ åˆå¯ä»¥å¾ˆå¥½åœ°ä¸ redis æœåŠ¡å™¨ä¸­å…¶ä»–åŒæ ·ä»¥å•çº¿ç¨‹æ–¹å¼è¿è¡Œçš„æ¨¡å—è¿›è¡Œå¯¹æ¥ï¼Œ è¿™ä¿æŒäº† Redis å†…éƒ¨å•çº¿ç¨‹è®¾è®¡çš„ç®€å•æ€§ã€‚



### ğŸ¯ ä»€ä¹ˆæ˜¯ Reactor æ¨¡å¼ï¼Ÿ

**Reactor æ¨¡å¼**æ˜¯ä¸€ç§åŸºäºäº‹ä»¶é©±åŠ¨çš„è®¾è®¡æ¨¡å¼ï¼Œå¹¿æ³›åº”ç”¨äºé«˜æ€§èƒ½ç½‘ç»œæœåŠ¡å¼€å‘ä¸­ï¼Œä¾‹å¦‚ Redisã€Netty å’Œ Java çš„ NIO ç¼–ç¨‹ä¸­ã€‚å®ƒé€šè¿‡éé˜»å¡ IO å’Œäº‹ä»¶å¾ªç¯çš„æ–¹å¼é«˜æ•ˆåœ°å¤„ç†å¹¶å‘è¯·æ±‚ï¼Œé¿å…äº†çº¿ç¨‹é˜»å¡å’Œèµ„æºæµªè´¹é—®é¢˜ã€‚Redis çš„é«˜æ€§èƒ½åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šä¾èµ–äºè¿™ç§æ¨¡å¼ã€‚

**Reactor æ¨¡å¼çš„åŸºæœ¬åŸç†**

Reactor æ¨¡å¼å°†åº”ç”¨ç¨‹åºçš„è¯·æ±‚å¤„ç†åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªå…³é”®è§’è‰²ï¼š

1. **Reactor (äº‹ä»¶åˆ†å‘å™¨)**ï¼š
   - è´Ÿè´£ç›‘å¬äº‹ä»¶å¹¶å°†å…¶åˆ†å‘ç»™ç›¸åº”çš„äº‹ä»¶å¤„ç†å™¨ã€‚
   - Reactor è¿è¡Œåœ¨å•çº¿ç¨‹æˆ–å¤šçº¿ç¨‹ä¸Šï¼Œé›†ä¸­ç®¡ç† IO æ“ä½œã€‚
2. **äº‹ä»¶æº (èµ„æºæä¾›è€…)**ï¼šäº‹ä»¶æºæ˜¯äº§ç”Ÿ IO äº‹ä»¶çš„å®ä½“ï¼Œä¾‹å¦‚ç½‘ç»œè¿æ¥ã€æ–‡ä»¶æè¿°ç¬¦ç­‰ã€‚
3. **äº‹ä»¶å¤„ç†å™¨ (Handlers)**ï¼šè´Ÿè´£å…·ä½“çš„äº‹ä»¶å¤„ç†é€»è¾‘ï¼Œä¾‹å¦‚è¯»å–æ•°æ®ã€å¤„ç†ä¸šåŠ¡é€»è¾‘ã€å†™å›æ•°æ®ç­‰ã€‚
4. **Demultiplexer (IO å¤šè·¯å¤ç”¨å™¨)**ï¼šä½¿ç”¨æ“ä½œç³»ç»Ÿæä¾›çš„ IO å¤šè·¯å¤ç”¨æœºåˆ¶ï¼ˆå¦‚ `select`ã€`poll` æˆ– `epoll`ï¼‰ç›‘å¬å¤šä¸ª IO é€šé“ï¼Œå°†å‡†å¤‡å¥½çš„äº‹ä»¶ä¼ é€’ç»™ Reactorã€‚

**Reactor æ¨¡å¼çš„å·¥ä½œæµç¨‹**

1. **äº‹ä»¶ç›‘å¬**ï¼šReactor ä½¿ç”¨å¤šè·¯å¤ç”¨å™¨ä¸æ–­ç›‘å¬ IO äº‹ä»¶ï¼Œå¦‚è¯»äº‹ä»¶ã€å†™äº‹ä»¶æˆ–è¿æ¥äº‹ä»¶ã€‚
2. **äº‹ä»¶åˆ†å‘**ï¼šå½“æœ‰äº‹ä»¶å‘ç”Ÿæ—¶ï¼ŒReactor ä»å¤šè·¯å¤ç”¨å™¨è·å–äº‹ä»¶ï¼Œå¹¶å°†å…¶åˆ†å‘ç»™å¯¹åº”çš„äº‹ä»¶å¤„ç†å™¨ã€‚
3. **äº‹ä»¶å¤„ç†**ï¼šäº‹ä»¶å¤„ç†å™¨æ ¹æ®äº‹ä»¶ç±»å‹æ‰§è¡Œç›¸åº”çš„æ“ä½œï¼ˆå¦‚è¯»å–æ•°æ®ã€ä¸šåŠ¡å¤„ç†ã€å†™å›æ•°æ®ç­‰ï¼‰ã€‚

**Redis ä¸­çš„ Reactor æ¨¡å¼**

Redis æ˜¯ä¸€ä¸ªåŸºäºäº‹ä»¶é©±åŠ¨æ¨¡å‹çš„é«˜æ€§èƒ½å†…å­˜æ•°æ®åº“ï¼Œå•çº¿ç¨‹æ¨¡å‹çš„é«˜æ•ˆè¿è½¬å¾ˆå¤§ç¨‹åº¦ä¸Šå½’åŠŸäº Reactor æ¨¡å¼ã€‚

**Redis çš„å·¥ä½œæµç¨‹ï¼š**

1. **å•çº¿ç¨‹äº‹ä»¶å¾ªç¯**ï¼šRedis ä½¿ç”¨å•çº¿ç¨‹æ¥å¤„ç†æ‰€æœ‰å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œé€šè¿‡ IO å¤šè·¯å¤ç”¨æœºåˆ¶ï¼ˆå¦‚ `epoll`ï¼‰ç›‘å¬å¤šä¸ªè¿æ¥ä¸Šçš„ IO äº‹ä»¶ã€‚
2. **äº‹ä»¶åˆ†å‘**ï¼šå½“æŸä¸ªè¿æ¥ä¸Šæœ‰äº‹ä»¶å‘ç”Ÿï¼ˆå¦‚å¯è¯»ã€å¯å†™ï¼‰ï¼Œäº‹ä»¶è¢«åˆ†å‘ç»™å¯¹åº”çš„å¤„ç†å™¨ã€‚
3. **äº‹ä»¶å¤„ç†**ï¼šRedis çš„äº‹ä»¶å¤„ç†å™¨åŒ…æ‹¬ï¼š
   - **æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨**ï¼šè´Ÿè´£å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚ã€ç½‘ç»œ IO æ“ä½œã€‚
   - **æ—¶é—´äº‹ä»¶å¤„ç†å™¨**ï¼šå¤„ç†å®šæ—¶ä»»åŠ¡ï¼Œä¾‹å¦‚æŒä¹…åŒ–ã€æ¸…ç†è¿‡æœŸé”®ç­‰ã€‚

**Redis çš„äº‹ä»¶æ¨¡å‹ç»†èŠ‚ï¼š**

- Redis çš„äº‹ä»¶æ¨¡å‹å®ç°åŸºäº `ae.c` æ–‡ä»¶ï¼ˆAsync Eventï¼‰ã€‚
- å®ƒé€šè¿‡ **æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨**ï¼ˆå¤„ç†ç½‘ç»œ IOï¼‰å’Œ **æ—¶é—´äº‹ä»¶å¤„ç†å™¨**ï¼ˆå¤„ç†å®šæ—¶ä»»åŠ¡ï¼‰ååŒå·¥ä½œã€‚
- **æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨**åˆ©ç”¨æ“ä½œç³»ç»Ÿçš„ IO å¤šè·¯å¤ç”¨æœºåˆ¶ç›‘å¬å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œå•çº¿ç¨‹æ¨¡å‹é¿å…äº†å¤šçº¿ç¨‹å¸¦æ¥çš„å¤æ‚æ€§ï¼ˆå¦‚çº¿ç¨‹åŒæ­¥é—®é¢˜ï¼‰ã€‚



### ğŸ¯ Redis å†…å­˜æ¨¡å‹

Redis å†…å­˜ä¸»è¦å¯ä»¥åˆ†ä¸ºï¼šæ•°æ®éƒ¨åˆ†ã€Redisè¿›ç¨‹æœ¬èº«ã€ç¼“å†²åŒºå†…å­˜ã€å†…å­˜ç¢ç‰‡è¿™å››ä¸ªéƒ¨åˆ†ã€‚Redis é»˜è®¤é€šè¿‡jemalloc æ¥åˆ†é…å†…å­˜ã€‚

- **æ•°æ®å†…å­˜**ï¼šæ•°æ®å†…å­˜ç”¨æ¥å­˜å‚¨ Redis çš„é”®å€¼å¯¹ã€æ…¢æŸ¥è¯¢æ—¥å¿—ç­‰ï¼Œæ˜¯ä¸»è¦å ç”¨å†…å­˜çš„éƒ¨åˆ†ï¼Œè¿™éƒ¨åˆ†å†…å­˜ä¼šç»Ÿè®¡åœ¨used_memoryä¸­

- **Redisè¿›ç¨‹å†…å­˜**ï¼šRedisè¿›ç¨‹æœ¬èº«ä¹Ÿä¼šå ç”¨ä¸€éƒ¨åˆ†å†…å­˜ï¼Œè¿™éƒ¨åˆ†å†…å­˜ä¸æ˜¯jemallocåˆ†é…ï¼Œä¸ä¼šç»Ÿè®¡åœ¨used_memoryä¸­ã€‚æ‰§è¡ŒRDBå’ŒAOFæ—¶åˆ›å»ºçš„å­è¿›ç¨‹ä¹Ÿä¼šå ç”¨å†…å­˜ï¼Œä½†ä¹Ÿä¸ä¼šç»Ÿè®¡åœ¨used_memoryä¸­ã€‚

- **ç¼“å†²å†…å­˜**ï¼ˆåŠ¨æ€ç®¡ç†ï¼‰ï¼š

  - å®¢æˆ·ç«¯ç¼“å†²åŒºï¼šå­˜å‚¨å®¢æˆ·ç«¯è¿æ¥çš„è¾“å…¥/è¾“å‡ºæ•°æ®ï¼Œé€šè¿‡ `client-output-buffer-limit` é™åˆ¶å¤§å°ï¼Œé˜²æ­¢æº¢å‡ºã€‚
  - å¤åˆ¶ç§¯å‹ç¼“å†²åŒºï¼šç”¨äºä¸»ä»å¤åˆ¶çš„å¢é‡åŒæ­¥ï¼ˆ`PSYNC`ï¼‰ï¼Œå¤§å°ç”± `repl-backlog-size` é…ç½®ï¼Œé»˜è®¤ 1MBã€‚
  - AOFç¼“å†²åŒºï¼šæš‚å­˜æœ€è¿‘å†™å…¥çš„å‘½ä»¤ï¼ŒæŒä¹…åŒ–æ—¶åŒæ­¥åˆ°ç£ç›˜ã€‚

  **åˆ†é…æ–¹å¼**ï¼šç”± `jemalloc` åˆ†é…ï¼Œè®¡å…¥ `used_memory` 

- **å†…å­˜ç¢ç‰‡**ï¼š

  - æ¥æºï¼šé¢‘ç¹çš„é”®å€¼å¢åˆ åŠ jemalloc å†…å­˜å—åˆ†é…ç­–ç•¥å¯¼è‡´æœªå®Œå…¨åˆ©ç”¨çš„å†…å­˜ç©ºé—´ã€‚
  - ç›‘æ§æŒ‡æ ‡ï¼š
    - ç¢ç‰‡ç‡ï¼š`mem_fragmentation_ratio = used_memory_rss / used_memory`ï¼Œå¥åº·å€¼çº¦ 1.03ï¼ˆjemallocï¼‰ã€‚
    - è‹¥ç¢ç‰‡ç‡ >1.5ï¼Œéœ€è€ƒè™‘ä¼˜åŒ–ï¼›>2 å¯èƒ½è§¦å‘æ€§èƒ½é—®é¢˜ã€‚
  - ä¼˜åŒ–æ‰‹æ®µï¼š
    - é‡å¯é‡æ’ï¼šå®‰å…¨é‡å¯åé€šè¿‡ RDB/AOF æ¢å¤æ•°æ®ï¼Œå†…å­˜é‡æ–°åˆ†é…ä»¥å‡å°‘ç¢ç‰‡ã€‚
    - **è‡ªåŠ¨ç¢ç‰‡æ•´ç†ï¼ˆRedis 4.0+ï¼‰**ï¼šå¼€å¯ `activedefrag`ï¼Œæ ¹æ®é˜ˆå€¼åŠ¨æ€æ•´ç†ç¢ç‰‡

------



## å››ã€äº‹åŠ¡ä¸è„šæœ¬

### ğŸ¯ Redisäº‹åŠ¡ï¼Ÿ

**Redisäº‹åŠ¡æ˜¯é€šè¿‡`MULTI`ã€`EXEC`ã€`WATCH`ç­‰å‘½ä»¤å®ç°çš„ä¸€ç§æ‰¹é‡æ“ä½œæœºåˆ¶**ï¼Œå®ƒçš„æ ¸å¿ƒç‰¹ç‚¹æ˜¯**å°†å¤šä¸ªå‘½ä»¤æ‰“åŒ…æˆä¸€ä¸ªåŸå­åŒ–æ“ä½œåºåˆ—**ï¼Œä¿è¯ä»¥ä¸‹ç‰¹æ€§ï¼š

1. **äº‹åŠ¡çš„ä¸‰å¤§æ ¸å¿ƒå‘½ä»¤**

   - **`MULTI`**ï¼šæ ‡è®°äº‹åŠ¡å¼€å§‹ï¼Œåç»­æ‰€æœ‰å‘½ä»¤ä¼šè¢«æ”¾å…¥é˜Ÿåˆ—ç¼“å­˜ï¼Œè¿”å›`QUEUED`è¡¨ç¤ºå‘½ä»¤å·²å…¥é˜Ÿï¼Œå®ƒæ€»æ˜¯è¿”å› OKã€‚

   - **`EXEC`**ï¼šè§¦å‘äº‹åŠ¡æ‰§è¡Œï¼ŒæŒ‰é¡ºåºæ‰§è¡Œé˜Ÿåˆ—ä¸­çš„æ‰€æœ‰å‘½ä»¤ï¼Œè¿”å›æ‰€æœ‰å‘½ä»¤çš„ç»“æœã€‚

   - **`DISCARD`**ï¼šå–æ¶ˆäº‹åŠ¡ï¼Œæ¸…ç©ºå‘½ä»¤é˜Ÿåˆ—ï¼Œæ”¾å¼ƒäº‹åŠ¡æ‰§è¡Œã€‚

2. **äº‹åŠ¡çš„å››å¤§ç‰¹æ€§**

   - åŸå­æ€§ï¼ˆPartialï¼‰ï¼š
     - è‹¥äº‹åŠ¡ä¸­æŸæ¡å‘½ä»¤**è¯­æ³•é”™è¯¯**ï¼ˆå¦‚å‘½ä»¤ä¸å­˜åœ¨ï¼‰ï¼Œæ•´ä¸ªäº‹åŠ¡åœ¨`EXEC`æ—¶ä¼šè¢«æ‹’ç»æ‰§è¡Œã€‚
     - è‹¥å‘½ä»¤**è¿è¡Œæ—¶é”™è¯¯**ï¼ˆå¦‚å¯¹å­—ç¬¦ä¸²æ‰§è¡Œ`INCR`ï¼‰ï¼Œé”™è¯¯å‘½ä»¤ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œ**ä½†å…¶ä»–å‘½ä»¤ä»ä¼šæ‰§è¡Œ**ï¼ˆä¸æ”¯æŒå›æ»šï¼‰ã€‚

   - **éš”ç¦»æ€§**ï¼šäº‹åŠ¡æ‰§è¡ŒæœŸé—´ä¸ä¼šè¢«å…¶ä»–å®¢æˆ·ç«¯å‘½ä»¤æ‰“æ–­ï¼ˆä¸²è¡ŒåŒ–æ‰§è¡Œï¼‰ã€‚

   - **ä¸€è‡´æ€§**ï¼šäº‹åŠ¡å®Œæˆåï¼Œæ•°æ®ç¬¦åˆRedisçš„æ ¡éªŒè§„åˆ™ï¼ˆå¦‚æ•°æ®ç±»å‹çº¦æŸï¼‰ã€‚

   - **æŒä¹…æ€§**ï¼šå–å†³äºRedisçš„æŒä¹…åŒ–é…ç½®ï¼ˆä¸RDB/AOFç›¸å…³ï¼‰ã€‚

3. **`WATCH`å‘½ä»¤ä¸ä¹è§‚é”**

   - **ä½œç”¨**ï¼šç›‘æ§ä¸€ä¸ªæˆ–å¤šä¸ªKeyï¼Œè‹¥åœ¨äº‹åŠ¡æäº¤å‰ï¼ˆ`EXEC`æ‰§è¡Œå‰ï¼‰è¿™äº›Keyçš„å€¼è¢«å…¶ä»–å®¢æˆ·ç«¯ä¿®æ”¹ï¼Œåˆ™å½“å‰äº‹åŠ¡ä¼šè¢«**ä¸»åŠ¨æ”¾å¼ƒ**ï¼ˆè¿”å›`nil`ï¼‰ã€‚

   - **æœ¬è´¨**ï¼šåŸºäº`CAS`ï¼ˆCompare And Swapï¼‰çš„ä¹è§‚é”æœºåˆ¶ï¼Œè§£å†³å¹¶å‘å†²çªé—®é¢˜ã€‚

   - ç¤ºä¾‹ï¼š

     ```Shell
     WATCH balance      # ç›‘å¬balanceé”®
     MULTI
     DECRBY balance 100
     INCRBY debt 100
     EXEC              # è‹¥balanceè¢«å…¶ä»–å®¢æˆ·ç«¯ä¿®æ”¹ï¼Œæ­¤å¤„è¿”å›nil
     ```

4. **ä¸å…³ç³»å‹æ•°æ®åº“äº‹åŠ¡çš„å·®å¼‚**

   - **ä¸æ”¯æŒå›æ»šï¼ˆRollbackï¼‰**ï¼šRedis è®¾è®¡å“²å­¦å¼ºè°ƒç®€å•é«˜æ•ˆï¼Œå¼€å‘è€…éœ€è‡ªè¡Œå¤„ç†é”™è¯¯é€»è¾‘ã€‚

   - **æ— éš”ç¦»çº§åˆ«æ¦‚å¿µ**ï¼šæ‰€æœ‰å‘½ä»¤ä¸²è¡Œæ‰§è¡Œï¼Œå¤©ç„¶éš”ç¦»ã€‚

   - **æ‰¹é‡æ‰§è¡Œè€ŒéåŸå­æ€§ä¿è¯**ï¼šæ›´é€‚ç”¨äºæ‰¹é‡æ“ä½œåœºæ™¯ï¼Œè€Œéå¼ºä¸€è‡´äº‹åŠ¡ã€‚

5. **é€‚ç”¨åœºæ™¯**

   - **æ‰¹é‡æ“ä½œ**ï¼šä¾‹å¦‚æ‰¹é‡æ›´æ–°ç”¨æˆ·çŠ¶æ€ã€‚

   - **ç®€å•ä¸€è‡´æ€§æ§åˆ¶**ï¼šé…åˆ`WATCH`å®ç°ä½™é¢æ‰£å‡ã€åº“å­˜æŠ¢è´­ç­‰åœºæ™¯ã€‚

   - **éå¼ºäº‹åŠ¡éœ€æ±‚**ï¼šå®¹å¿éƒ¨åˆ†å¤±è´¥ï¼ˆå¦‚æ—¥å¿—è®°å½•ï¼‰ã€‚



### ğŸ¯ Redisäº‹åŠ¡çš„ä¸‰ä¸ªé˜¶æ®µã€ä¸‰ç‰¹æ€§

**ä¸‰é˜¶æ®µ**

1. å¼€å¯ï¼šä»¥MULTIå¼€å§‹ä¸€ä¸ªäº‹åŠ¡

2. å…¥é˜Ÿï¼šå°†å¤šä¸ªå‘½ä»¤å…¥é˜Ÿåˆ°äº‹åŠ¡ä¸­ï¼Œæ¥åˆ°è¿™äº›å‘½ä»¤å¹¶ä¸ä¼šç«‹å³æ‰§è¡Œï¼Œè€Œæ˜¯æ”¾åˆ°ç­‰å¾…æ‰§è¡Œçš„äº‹åŠ¡é˜Ÿåˆ—é‡Œé¢

3. æ‰§è¡Œï¼šç”±EXECå‘½ä»¤è§¦å‘äº‹åŠ¡

**ä¸‰ç‰¹æ€§**

1. å•ç‹¬çš„éš”ç¦»æ“ä½œï¼šäº‹åŠ¡ä¸­çš„æ‰€æœ‰å‘½ä»¤éƒ½ä¼šåºåˆ—åŒ–ã€æŒ‰é¡ºåºåœ°æ‰§è¡Œã€‚äº‹åŠ¡åœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œä¸ä¼šè¢«å…¶ä»–å®¢æˆ·ç«¯å‘é€æ¥çš„å‘½ä»¤è¯·æ±‚æ‰€æ‰“æ–­ã€‚

2. **æ²¡æœ‰éš”ç¦»çº§åˆ«çš„æ¦‚å¿µ**ï¼šé˜Ÿåˆ—ä¸­çš„å‘½ä»¤æ²¡æœ‰æäº¤ä¹‹å‰éƒ½ä¸ä¼šå®é™…çš„è¢«æ‰§è¡Œï¼Œå› ä¸ºäº‹åŠ¡æäº¤å‰ä»»ä½•æŒ‡ä»¤éƒ½ä¸ä¼šè¢«å®é™…æ‰§è¡Œï¼Œä¹Ÿå°±ä¸å­˜åœ¨â€äº‹åŠ¡å†…çš„æŸ¥è¯¢è¦çœ‹åˆ°äº‹åŠ¡é‡Œçš„æ›´æ–°ï¼Œåœ¨äº‹åŠ¡å¤–æŸ¥è¯¢ä¸èƒ½çœ‹åˆ°â€è¿™ä¸ªè®©äººä¸‡åˆ†å¤´ç—›çš„é—®é¢˜

3. ä¸ä¿è¯åŸå­æ€§ï¼šredisåŒä¸€ä¸ªäº‹åŠ¡ä¸­å¦‚æœæœ‰ä¸€æ¡å‘½ä»¤æ‰§è¡Œå¤±è´¥ï¼Œå…¶åçš„å‘½ä»¤ä»ç„¶ä¼šè¢«æ‰§è¡Œï¼Œæ²¡æœ‰å›æ»š



### ğŸ¯ Redisäº‹åŠ¡æ”¯æŒéš”ç¦»æ€§å—ï¼Ÿ

Redis æ˜¯å•è¿›ç¨‹ç¨‹åºï¼Œå¹¶ä¸”å®ƒä¿è¯åœ¨æ‰§è¡Œäº‹åŠ¡æ—¶ï¼Œä¸ä¼šå¯¹äº‹åŠ¡è¿›è¡Œä¸­æ–­ï¼Œäº‹åŠ¡å¯ä»¥è¿è¡Œç›´åˆ°æ‰§è¡Œå®Œæ‰€æœ‰äº‹åŠ¡é˜Ÿåˆ—ä¸­çš„å‘½ä»¤ä¸ºæ­¢ã€‚å› æ­¤ï¼Œ**Redis çš„äº‹åŠ¡æ˜¯æ€»æ˜¯å¸¦æœ‰éš”ç¦»æ€§çš„**ã€‚



### ğŸ¯ Redisäº‹åŠ¡ä¿è¯åŸå­æ€§å—ï¼Œæ”¯æŒå›æ»šå—ï¼Ÿ

Redisä¸­ï¼Œå•æ¡å‘½ä»¤æ˜¯åŸå­æ€§æ‰§è¡Œçš„ï¼Œä½†**äº‹åŠ¡ä¸ä¿è¯åŸå­æ€§ï¼Œä¸”æ²¡æœ‰å›æ»š**ã€‚äº‹åŠ¡ä¸­ä»»æ„å‘½ä»¤æ‰§è¡Œå¤±è´¥ï¼Œå…¶ä½™çš„å‘½ä»¤ä»ä¼šè¢«æ‰§è¡Œã€‚

1. **å¦‚æœåœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­çš„å‘½ä»¤å‡ºç°é”™è¯¯ï¼Œé‚£ä¹ˆæ‰€æœ‰çš„å‘½ä»¤éƒ½ä¸ä¼šæ‰§è¡Œ**ï¼›
2. **å¦‚æœåœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­å‡ºç°è¿è¡Œé”™è¯¯ï¼Œé‚£ä¹ˆæ­£ç¡®çš„å‘½ä»¤ä¼šè¢«æ‰§è¡Œ**ã€‚

------



## äº”ã€é«˜å¯ç”¨ä¸åˆ†å¸ƒå¼

> Rediså•èŠ‚ç‚¹å­˜åœ¨å•ç‚¹æ•…éšœé—®é¢˜ï¼Œä¸ºäº†è§£å†³å•ç‚¹é—®é¢˜ï¼Œä¸€èˆ¬éƒ½éœ€è¦å¯¹Redisé…ç½®ä»èŠ‚ç‚¹ï¼Œç„¶åä½¿ç”¨å“¨å…µæ¥ç›‘å¬ä¸»èŠ‚ç‚¹çš„å­˜æ´»çŠ¶æ€ï¼Œå¦‚æœä¸»èŠ‚ç‚¹æŒ‚æ‰ï¼Œä»èŠ‚ç‚¹èƒ½ç»§ç»­æä¾›ç¼“å­˜åŠŸèƒ½

### ğŸ¯ ä¸»ä»åŒæ­¥äº†è§£å—ï¼Ÿ

**ä¸»ä»å¤åˆ¶**ï¼Œæ˜¯æŒ‡å°†ä¸€å° Redis æœåŠ¡å™¨çš„æ•°æ®ï¼Œå¤åˆ¶åˆ°å…¶ä»–çš„ Redis æœåŠ¡å™¨ã€‚å‰è€…ç§°ä¸º **ä¸»èŠ‚ç‚¹(master)**ï¼Œåè€…ç§°ä¸º **ä»èŠ‚ç‚¹(slave)**ã€‚ä¸”æ•°æ®çš„å¤åˆ¶æ˜¯ **å•å‘** çš„ï¼Œåªèƒ½ç”±ä¸»èŠ‚ç‚¹åˆ°ä»èŠ‚ç‚¹ã€‚Redis ä¸»ä»å¤åˆ¶æ”¯æŒ **ä¸»ä»åŒæ­¥** å’Œ **ä»ä»åŒæ­¥** ä¸¤ç§ï¼Œåè€…æ˜¯ Redis åç»­ç‰ˆæœ¬æ–°å¢çš„åŠŸèƒ½ï¼Œä»¥å‡è½»ä¸»èŠ‚ç‚¹çš„åŒæ­¥è´Ÿæ‹…ã€‚

**ä¸»ä»å¤åˆ¶ä¸»è¦çš„ä½œç”¨**

- **æ•°æ®å†—ä½™ï¼š** ä¸»ä»å¤åˆ¶å®ç°äº†æ•°æ®çš„çƒ­å¤‡ä»½ï¼Œæ˜¯æŒä¹…åŒ–ä¹‹å¤–çš„ä¸€ç§æ•°æ®å†—ä½™æ–¹å¼ã€‚
- **æ•…éšœæ¢å¤ï¼š** å½“ä¸»èŠ‚ç‚¹å‡ºç°é—®é¢˜æ—¶ï¼Œå¯ä»¥ç”±ä»èŠ‚ç‚¹æä¾›æœåŠ¡ï¼Œå®ç°å¿«é€Ÿçš„æ•…éšœæ¢å¤ *(å®é™…ä¸Šæ˜¯ä¸€ç§æœåŠ¡çš„å†—ä½™)*ã€‚
- **è´Ÿè½½å‡è¡¡ï¼š** åœ¨ä¸»ä»å¤åˆ¶çš„åŸºç¡€ä¸Šï¼Œé…åˆè¯»å†™åˆ†ç¦»ï¼Œå¯ä»¥ç”±ä¸»èŠ‚ç‚¹æä¾›å†™æœåŠ¡ï¼Œç”±ä»èŠ‚ç‚¹æä¾›è¯»æœåŠ¡ *ï¼ˆå³å†™ Redis æ•°æ®æ—¶åº”ç”¨è¿æ¥ä¸»èŠ‚ç‚¹ï¼Œè¯» Redis æ•°æ®æ—¶åº”ç”¨è¿æ¥ä»èŠ‚ç‚¹ï¼‰*ï¼Œåˆ†æ‹…æœåŠ¡å™¨è´Ÿè½½ã€‚å°¤å…¶æ˜¯åœ¨å†™å°‘è¯»å¤šçš„åœºæ™¯ä¸‹ï¼Œé€šè¿‡å¤šä¸ªä»èŠ‚ç‚¹åˆ†æ‹…è¯»è´Ÿè½½ï¼Œå¯ä»¥å¤§å¤§æé«˜ Redis æœåŠ¡å™¨çš„å¹¶å‘é‡ã€‚
- **é«˜å¯ç”¨åŸºçŸ³ï¼š** é™¤äº†ä¸Šè¿°ä½œç”¨ä»¥å¤–ï¼Œä¸»ä»å¤åˆ¶è¿˜æ˜¯å“¨å…µå’Œé›†ç¾¤èƒ½å¤Ÿå®æ–½çš„ **åŸºç¡€**ï¼Œå› æ­¤è¯´ä¸»ä»å¤åˆ¶æ˜¯ Redis é«˜å¯ç”¨çš„åŸºç¡€ã€‚

**å®ç°åŸç†**

![redis-replicaof](https://img.starfish.ink/redis/redis-replicaof.png)

ä¸ºäº†èŠ‚çœç¯‡å¹…ï¼Œä¸»è¦çš„æ­¥éª¤éƒ½ **æµ“ç¼©** åœ¨äº†ä¸Šå›¾ä¸­ï¼Œå…¶å®ä¹Ÿå¯ä»¥ **ç®€åŒ–æˆä¸‰ä¸ªé˜¶æ®µï¼šå‡†å¤‡é˜¶æ®µ-æ•°æ®åŒæ­¥é˜¶æ®µ-å‘½ä»¤ä¼ æ’­é˜¶æ®µ**ã€‚

> redis2.8 ä¹‹å‰ä½¿ç”¨`sync[runId][offset]`åŒæ­¥å‘½ä»¤ï¼Œredis2.8 ä¹‹åä½¿ç”¨`psync[runId][offset]`å‘½ä»¤ã€‚ä¸¤è€…ä¸åŒåœ¨äºï¼Œsync å‘½ä»¤ä»…æ”¯æŒå…¨é‡å¤åˆ¶è¿‡ç¨‹ï¼Œpsync æ”¯æŒå…¨é‡å’Œéƒ¨åˆ†å¤åˆ¶
>
> **åŒæ­¥åŸç†ä¸æµç¨‹**
>
> ä¸»ä»å¤åˆ¶åˆ†ä¸ºä¸‰é˜¶æ®µï¼Œä»¥Redis 2.8ä¸ºåˆ†ç•Œç‚¹ï¼Œä¼˜åŒ–äº†åŒæ­¥æ•ˆç‡ï¼š
>
> **é˜¶æ®µä¸€ï¼šå»ºç«‹è¿æ¥ï¼ˆå‡†å¤‡é˜¶æ®µï¼‰**
>
> 1. ä»èŠ‚ç‚¹æ‰§è¡Œ`REPLICAOF <master_ip> <master_port>`ï¼Œå‘ä¸»èŠ‚ç‚¹å‘èµ·è¿æ¥è¯·æ±‚ã€‚
> 2. ä¸»èŠ‚ç‚¹éªŒè¯åå»ºç«‹Socketè¿æ¥ï¼Œå‡†å¤‡æ•°æ®åŒæ­¥ã€‚
>
> ##### **é˜¶æ®µäºŒï¼šæ•°æ®åŒæ­¥ï¼ˆå…¨é‡/å¢é‡ï¼‰**
>
> - å…¨é‡åŒæ­¥ï¼ˆé¦–æ¬¡æˆ–è½åè¿‡å¤šæ—¶è§¦å‘ï¼‰ï¼š
>   1. ä¸»èŠ‚ç‚¹æ‰§è¡Œ`BGSAVE`ç”Ÿæˆ**RDBå¿«ç…§**ï¼ŒåŒæ—¶ç¼“å­˜æœŸé—´çš„å†™å‘½ä»¤è‡³**å¤åˆ¶ç¼“å†²åŒº**ã€‚
>   2. ä¼ è¾“RDBæ–‡ä»¶ç»™ä»èŠ‚ç‚¹ï¼Œä»èŠ‚ç‚¹æ¸…ç©ºæ—§æ•°æ®å¹¶åŠ è½½å¿«ç…§ã€‚
>   3. ä¸»èŠ‚ç‚¹å‘é€ç¼“å†²åŒºä¸­çš„å¢é‡å‘½ä»¤ï¼Œä»èŠ‚ç‚¹æ‰§è¡Œä»¥ä¿æŒæ•°æ®æœ€æ–°ã€‚
> - å¢é‡åŒæ­¥ï¼ˆæ–­çº¿é‡è¿ä¸”æ¡ä»¶æ»¡è¶³æ—¶è§¦å‘ï¼‰ï¼š
>   1. ä»èŠ‚ç‚¹é€šè¿‡`psync`å‘½ä»¤ä¸ŠæŠ¥è‡ªèº«çš„`runID`ï¼ˆä¸»èŠ‚ç‚¹å”¯ä¸€æ ‡è¯†ï¼‰å’Œ`offset`ï¼ˆå¤åˆ¶åç§»é‡ï¼‰ã€‚
>   2. ä¸»èŠ‚ç‚¹æ£€æŸ¥ `offset`æ˜¯å¦åœ¨å¤åˆ¶ç¼“å†²åŒºå†…ï¼š
>      - è‹¥å­˜åœ¨ï¼Œå‘é€ç¼“å†²åŒºä¸­ä»`offset`ä¹‹åçš„å¢é‡å‘½ä»¤ï¼ˆéƒ¨åˆ†åŒæ­¥ï¼‰ã€‚
>      - è‹¥ä¸å­˜åœ¨ï¼Œè§¦å‘å…¨é‡åŒæ­¥ã€‚
>
> ##### **é˜¶æ®µä¸‰ï¼šå‘½ä»¤ä¼ æ’­ï¼ˆæŒç»­åŒæ­¥ï¼‰**
>
> - ä¸»èŠ‚ç‚¹æ¯æ‰§è¡Œä¸€ä¸ªå†™å‘½ä»¤ï¼Œä¼šå¼‚æ­¥å‘é€ç»™æ‰€æœ‰ä»èŠ‚ç‚¹ï¼Œä»èŠ‚ç‚¹é‡æ”¾å‘½ä»¤ä»¥ä¿æŒæ•°æ®ä¸€è‡´æ€§ã€‚

**å…³é”®æœºåˆ¶ä¸ä¼˜åŒ–**

- å¤åˆ¶ç¼“å†²åŒºï¼ˆRepl Backlog Bufferï¼‰ï¼šç¯å½¢ç¼“å†²åŒºè®°å½•ä¸»èŠ‚ç‚¹æœ€è¿‘çš„å†™å‘½ä»¤ï¼Œé»˜è®¤å¤§å°1MBï¼ˆå¯é…ç½®ï¼‰ã€‚è‹¥ä»èŠ‚ç‚¹è½åæ•°æ®è¶…å‡ºç¼“å†²åŒºèŒƒå›´ï¼Œéœ€è§¦å‘å…¨é‡åŒæ­¥ã€‚
- å¿ƒè·³æ£€æµ‹ï¼šä¸»ä»èŠ‚ç‚¹å®šæœŸäº’å‘å¿ƒè·³ï¼ˆ`REPLCONF ACK`ï¼‰ï¼Œæ£€æµ‹è¿æ¥çŠ¶æ€ä¸å»¶è¿Ÿï¼Œè¶…æ—¶åˆ™è§¦å‘é‡åŒæ­¥ã€‚

**æ³¨æ„äº‹é¡¹**

- **æ•°æ®å»¶è¿Ÿ**ï¼šä¸»ä»åŒæ­¥æ˜¯å¼‚æ­¥çš„ï¼Œä»èŠ‚ç‚¹æ•°æ®å¯èƒ½å­˜åœ¨çŸ­æš‚å»¶è¿Ÿï¼Œå¼ºä¸€è‡´æ€§åœºæ™¯éœ€è°¨æ…ã€‚
- å…¨é‡åŒæ­¥é£é™©ï¼š
  - ä¸»èŠ‚ç‚¹ç”ŸæˆRDBæ—¶ä¼šForkå­è¿›ç¨‹ï¼Œå¤§å†…å­˜å®ä¾‹å¯èƒ½å¯¼è‡´çŸ­æš‚é˜»å¡ã€‚
  - ç½‘ç»œå¸¦å®½å ç”¨é«˜ï¼Œéœ€é¿å…é¢‘ç¹å…¨é‡åŒæ­¥ï¼ˆå¦‚åˆç†é…ç½®`repl-backlog-size`ï¼‰ã€‚
- è¯»å†™åˆ†ç¦»é™·é˜±ï¼š
  - ä»èŠ‚ç‚¹é»˜è®¤å¯èƒ½è¿”å›è¿‡æœŸæ•°æ®ï¼ˆéœ€å¼€å¯`replica-serve-stale-data no`é…ç½®ï¼‰ã€‚
  - è¯»è´Ÿè½½éœ€å‡è¡¡åˆ°å¤šä¸ªä»èŠ‚ç‚¹ï¼Œé¿å…å•ç‚¹è¿‡è½½ã€‚



### ğŸ¯ ä¸»ä»å¤åˆ¶ä¼šå­˜åœ¨å“ªäº›é—®é¢˜å‘¢ï¼Ÿ

Redisä¸»ä»å¤åˆ¶è™½ç„¶æä¾›äº†æ•°æ®å†—ä½™å’Œè¯»å†™åˆ†ç¦»çš„èƒ½åŠ›ï¼Œä½†åœ¨å®é™…ä½¿ç”¨ä¸­ä»å­˜åœ¨ä»¥ä¸‹å‡ ä¸ªå…¸å‹é—®é¢˜ï¼Œéœ€è¦ç‰¹åˆ«å…³æ³¨ï¼š

1. **æ•°æ®ä¸ä¸€è‡´æ€§ï¼ˆæœ€ç»ˆä¸€è‡´æ€§ï¼‰**
   - å¼‚æ­¥å¤åˆ¶å»¶è¿Ÿï¼šä¸»ä»åŒæ­¥æ˜¯å¼‚æ­¥çš„ï¼Œä¸»èŠ‚ç‚¹å†™å…¥æˆåŠŸåç«‹å³è¿”å›å®¢æˆ·ç«¯ï¼Œæ•°æ®åŒæ­¥åˆ°ä»èŠ‚ç‚¹å­˜åœ¨å»¶è¿Ÿï¼ˆé€šå¸¸æ¯«ç§’çº§ï¼Œä½†ç½‘ç»œæ³¢åŠ¨æ—¶å¯èƒ½ç§’çº§ï¼‰ã€‚
     - **é—®é¢˜åœºæ™¯**ï¼šè‹¥å®¢æˆ·ç«¯ä»ä»èŠ‚ç‚¹è¯»å–åˆšå†™å…¥ä¸»èŠ‚ç‚¹çš„æ•°æ®ï¼Œå¯èƒ½è¯»åˆ°æ—§å€¼ï¼ˆå¦‚ç”µå•†åº“å­˜æ‰£å‡åç«‹åˆ»æŸ¥è¯¢ï¼‰ã€‚
     - ç¼“è§£æ–¹æ¡ˆï¼š
       - å¯¹ä¸€è‡´æ€§è¦æ±‚é«˜çš„è¯»æ“ä½œå¼ºåˆ¶èµ°ä¸»èŠ‚ç‚¹ï¼ˆé€šè¿‡ä»£ç æ§åˆ¶ï¼‰ã€‚
       - ä½¿ç”¨`WAIT`å‘½ä»¤ï¼ˆRedis 3.0+ï¼‰é˜»å¡ç›´åˆ°æ•°æ®åŒæ­¥åˆ°æŒ‡å®šæ•°é‡çš„ä»èŠ‚ç‚¹ï¼ˆç‰ºç‰²æ€§èƒ½æ¢å–å¼ºä¸€è‡´æ€§ï¼‰ã€‚

2. **ä¸»èŠ‚ç‚¹æ€§èƒ½å‹åŠ›**
   - å…¨é‡åŒæ­¥èµ„æºæ¶ˆè€—ï¼š
     - **Forké˜»å¡**ï¼šä¸»èŠ‚ç‚¹æ‰§è¡Œ`BGSAVE`ç”ŸæˆRDBå¿«ç…§æ—¶ï¼Œè‹¥æ•°æ®é‡å¤§ï¼ŒForkå­è¿›ç¨‹å¯èƒ½çŸ­æš‚é˜»å¡ä¸»çº¿ç¨‹ï¼ˆå°¤å…¶å†…å­˜è¶…è¿‡10GBæ—¶ï¼‰ã€‚
     - **ç½‘ç»œå¸¦å®½å ç”¨**ï¼šå…¨é‡åŒæ­¥ä¼ è¾“RDBæ–‡ä»¶ä¼šå ç”¨å¤§é‡å¸¦å®½ï¼Œå°¤å…¶ä»èŠ‚ç‚¹æ•°é‡å¤šæˆ–è·¨æœºæˆ¿åŒæ­¥æ—¶ã€‚
     - ä¼˜åŒ–æ‰‹æ®µï¼š
       - é¿å…é¢‘ç¹å…¨é‡åŒæ­¥ï¼ˆåˆç†é…ç½®`repl-backlog-size`ç¼“å†²åŒºå¤§å°ï¼‰ã€‚
       - ä½¿ç”¨**ä»èŠ‚ç‚¹çº§è”å¤åˆ¶**ï¼ˆä»èŠ‚ç‚¹ä½œä¸ºå…¶ä»–ä»èŠ‚ç‚¹çš„ä¸»èŠ‚ç‚¹ï¼‰ï¼Œåˆ†æ•£ä¸»èŠ‚ç‚¹å‹åŠ›ã€‚

3. **å¤åˆ¶ä¸­æ–­ä¸æ•°æ®ä¸¢å¤±é£é™©**
   - å¤åˆ¶ç¼“å†²åŒºæº¢å‡ºï¼š
     - ä¸»èŠ‚ç‚¹çš„**å¤åˆ¶ç¼“å†²åŒº**ï¼ˆRepl Backlog Bufferï¼‰æ˜¯å›ºå®šå¤§å°çš„ç¯å½¢é˜Ÿåˆ—ï¼Œè‹¥ä»èŠ‚ç‚¹æ–­å¼€æ—¶é—´è¿‡é•¿ï¼Œç¼“å†²åŒºè¢«æ–°æ•°æ®è¦†ç›–ï¼Œé‡è¿åéœ€è§¦å‘å…¨é‡åŒæ­¥ã€‚
     - **é£é™©**ï¼šå…¨é‡åŒæ­¥æœŸé—´ä¸»èŠ‚ç‚¹çš„æ–°å†™æ“ä½œå¯èƒ½ä¸¢å¤±ï¼ˆç¼“å†²åŒºæº¢å‡ºåæœªåŒæ­¥çš„æ•°æ®ï¼‰ã€‚
     - **é…ç½®å»ºè®®**ï¼šå¢å¤§`repl-backlog-size`ï¼ˆå¦‚512MBï¼‰å¹¶ç›‘æ§`master_repl_offset`ä¸ä»èŠ‚ç‚¹åç§»é‡å·®è·ã€‚

4. **ä»èŠ‚ç‚¹æ•°æ®è¿‡æœŸé—®é¢˜**
   - è¿‡æœŸé”®åŒæ­¥ç¼ºé™·ï¼š
     - Redisçš„è¿‡æœŸé”®åˆ é™¤ä¾èµ–ä¸»èŠ‚ç‚¹å®šæ—¶æ‰«æï¼ˆæƒ°æ€§+å®šæœŸï¼‰ï¼Œä»èŠ‚ç‚¹ä¸ä¼šä¸»åŠ¨åˆ é™¤è¿‡æœŸé”®ï¼Œè€Œæ˜¯ç­‰å¾…ä¸»èŠ‚ç‚¹åŒæ­¥`DEL`å‘½ä»¤ã€‚
     - **é—®é¢˜è¡¨ç°**ï¼šä»èŠ‚ç‚¹å¯èƒ½è¿”å›å·²é€»è¾‘è¿‡æœŸä½†æœªæ”¶åˆ°`DEL`å‘½ä»¤çš„æ•°æ®ã€‚
     - **è§£å†³æ–¹æ¡ˆ**ï¼šRedis 3.2+åå¼€å¯`replica-serve-stale-data no`é…ç½®ï¼Œä»èŠ‚ç‚¹åœ¨æœªå®ŒæˆåŒæ­¥æ—¶ä¸å“åº”è¯»è¯·æ±‚ã€‚

5. **æ•…éšœåˆ‡æ¢å¤æ‚åº¦**
   - æ‰‹åŠ¨æ•…éšœè½¬ç§»ï¼šåŸç”Ÿä¸»ä»å¤åˆ¶ä¸æä¾›è‡ªåŠ¨æ•…éšœè½¬ç§»èƒ½åŠ›ï¼Œä¸»èŠ‚ç‚¹å®•æœºåéœ€äººå·¥ä»‹å…¥åˆ‡æ¢ä»èŠ‚ç‚¹ä¸ºä¸»èŠ‚ç‚¹ï¼Œå¯¼è‡´æœåŠ¡ä¸­æ–­ã€‚
     - **ä¾èµ–ç»„ä»¶**ï¼šéœ€é…åˆ**Redis Sentinel**ï¼ˆå“¨å…µï¼‰æˆ–**Cluster**å®ç°è‡ªåŠ¨æ•…éšœè½¬ç§»ã€‚

6. **è„‘è£‚é—®é¢˜ï¼ˆSplit-Brainï¼‰**
   - åœºæ™¯ï¼šç½‘ç»œåˆ†åŒºå¯¼è‡´ä¸»èŠ‚ç‚¹ä¸éƒ¨åˆ†ä»èŠ‚ç‚¹å¤±è”ï¼Œå“¨å…µå¯èƒ½é€‰ä¸¾å‡ºæ–°ä¸»èŠ‚ç‚¹ï¼Œå½¢æˆä¸¤ä¸ªä¸»èŠ‚ç‚¹åŒæ—¶å†™å…¥ã€‚
     - **æ•°æ®å†²çª**ï¼šç½‘ç»œæ¢å¤åï¼Œæ—§ä¸»èŠ‚ç‚¹ä½œä¸ºä»èŠ‚ç‚¹åŒæ­¥æ–°ä¸»èŠ‚ç‚¹æ•°æ®ï¼Œå…¶é—´çš„å†™æ“ä½œä¼šä¸¢å¤±ã€‚
     - è§„é¿æªæ–½ï¼š
       - é…ç½®`min-replicas-to-write`ï¼šä¸»èŠ‚ç‚¹éœ€è‡³å°‘å­˜åœ¨Nä¸ªä»èŠ‚ç‚¹æ‰å…è®¸å†™å…¥ã€‚
       - è®¾ç½®å“¨å…µçš„`quorum`å‚æ•°å’Œ`down-after-milliseconds`ï¼Œå‡å°‘è¯¯åˆ¤ã€‚

> ä¸»ä»å¤åˆ¶æ˜¯Redisé«˜å¯ç”¨çš„åŸºç¡€ï¼Œä½†ä½¿ç”¨æ—¶éœ€è­¦æƒ•å¼‚æ­¥å¤åˆ¶å¯¼è‡´çš„æ•°æ®ä¸ä¸€è‡´ã€å…¨é‡åŒæ­¥æ€§èƒ½å¼€é”€ã€ç¼“å†²åŒºæº¢å‡ºé£é™©ç­‰é—®é¢˜ã€‚ç”Ÿäº§ç¯å¢ƒä¸­å»ºè®®ï¼š
>
> 1. **ç›‘æ§åŒæ­¥å»¶è¿Ÿ**ï¼ˆ`master_repl_offset`ä¸ä»èŠ‚ç‚¹åç§»é‡å·®å€¼ï¼‰ã€‚
> 2. **åˆç†é…ç½®ç¼“å†²åŒºå¤§å°ä¸å¿ƒè·³å‚æ•°**ã€‚
> 3. **ç»“åˆå“¨å…µæˆ–é›†ç¾¤**å®ç°è‡ªåŠ¨æ•…éšœè½¬ç§»ã€‚
> 4. **é¿å…å•ä¸»èŠ‚ç‚¹æŒ‚è½½è¿‡å¤šä»èŠ‚ç‚¹**ï¼ˆå»ºè®®çº§è”å¤åˆ¶åˆ†æ•£å‹åŠ›ï¼‰ã€‚



### ğŸ¯ Redisè¯»å†™åˆ†ç¦»çš„åœºæ™¯ä¸‹,æ€ä¹ˆä¿è¯ä»æ•°æ®åº“è¯»åˆ°æœ€æ–°çš„æ•°æ®?

åœ¨ Redis è¯»å†™åˆ†ç¦»åœºæ™¯ä¸‹ï¼Œä¿è¯ä»åº“è¯»åˆ°æœ€æ–°æ•°æ®æ˜¯ä¸€ä¸ªå…¸å‹çš„ **æ•°æ®ä¸€è‡´æ€§** é—®é¢˜ã€‚ä»¥ä¸‹æ˜¯ç»“åˆ Redis ç‰¹æ€§ã€é…ç½®ä¼˜åŒ–å’Œä¸šåŠ¡é€»è¾‘è®¾è®¡çš„å®è·µæ–¹æ¡ˆï¼š

1. **å¼ºåˆ¶è¯»ä¸»åº“ï¼ˆæœ€ç›´æ¥æ–¹æ¡ˆï¼‰**

   - **åŸç†**ï¼šå°†éœ€è¦å¼ºä¸€è‡´æ€§çš„è¯»è¯·æ±‚ç›´æ¥å‘ç»™ä¸»åº“ï¼Œç»•è¿‡ä»åº“ã€‚

   - å®ç°æ–¹å¼ï¼š
     - **ä»£ç æ ‡è®°**ï¼šåœ¨ä¸šåŠ¡ä»£ç ä¸­åŒºåˆ†å…³é”®è¯·æ±‚ï¼ˆå¦‚æ”¯ä»˜çŠ¶æ€ã€åº“å­˜æŸ¥è¯¢ï¼‰ï¼Œæ˜¾å¼æŒ‡å®šè¿æ¥ä¸»åº“ã€‚
     - **ä¸­é—´ä»¶è·¯ç”±**ï¼šé€šè¿‡ä»£ç†ï¼ˆå¦‚ ProxySQLï¼‰æˆ–å®¢æˆ·ç«¯åˆ†ç‰‡åº“ï¼ˆå¦‚ Lettuceï¼‰è‡ªåŠ¨è·¯ç”±å¼ºä¸€è‡´æ€§è¯»è¯·æ±‚åˆ°ä¸»åº“ã€‚

   - **ä¼˜ç‚¹**ï¼šé›¶å»¶è¿Ÿï¼Œå¼ºä¸€è‡´æ€§ã€‚

   - **ç¼ºç‚¹**ï¼šä¸»åº“å‹åŠ›å¢åŠ ï¼Œè¿èƒŒè¯»å†™åˆ†ç¦»åˆè¡·ï¼Œé€‚åˆä½é¢‘å…³é”®æ“ä½œã€‚

2. **åˆ©ç”¨ `WAIT` å‘½ä»¤ï¼ˆåŒæ­¥å¤åˆ¶ï¼‰**

   - åŸç†ï¼šå†™æ“ä½œåé€šè¿‡ `WAIT` å‘½ä»¤é˜»å¡å®¢æˆ·ç«¯ï¼Œç›´åˆ°æ•°æ®åŒæ­¥åˆ°æŒ‡å®šæ•°é‡çš„ä»åº“ã€‚

     ```Bash
     SET key value
     WAIT <num_replicas> <timeout_ms>  # ç¤ºä¾‹ï¼šWAIT 1 1000ï¼ˆç­‰å¾…1ä¸ªä»åº“ç¡®è®¤ï¼Œè¶…æ—¶1ç§’ï¼‰
     ```

   - **é€‚ç”¨åœºæ™¯**ï¼šå†™åéœ€ç«‹å³è¯»å–æœ€æ–°æ•°æ®çš„åœºæ™¯ï¼ˆå¦‚ç”¨æˆ·æ³¨å†Œåç«‹åˆ»æŸ¥è¯¢ä¿¡æ¯ï¼‰ã€‚

   - æ³¨æ„äº‹é¡¹ï¼š
     - å¢åŠ å†™æ“ä½œçš„å»¶è¿Ÿï¼ˆä¾èµ–ç½‘ç»œå’Œä»åº“å¤„ç†é€Ÿåº¦ï¼‰ã€‚
     - ä¸ä¿è¯æ‰€æœ‰ä»åº“åŒæ­¥æˆåŠŸï¼ˆä»…ç­‰å¾…æŒ‡å®šæ•°é‡ï¼‰ã€‚

3. **ç›‘æ§ä¸»ä»åç§»é‡ï¼ˆåŠ¨æ€åˆ‡æ¢è¯»åº“ï¼‰**

   - åŸç†ï¼šé€šè¿‡ç›‘æ§ä¸»ä»èŠ‚ç‚¹çš„ `repl_offset`ï¼ˆå¤åˆ¶åç§»é‡ï¼‰ï¼Œä»…åœ¨ä»åº“åç§»é‡â‰¥ä¸»åº“æ—¶å…è®¸è¯»è¯·æ±‚ã€‚

     ```Bash
     # ä¸»åº“å¤åˆ¶åç§»é‡
     INFO replication | grep master_repl_offset
     # ä»åº“å¤åˆ¶åç§»é‡
     INFO replication | grep slave_repl_offset
     ```

   - å®ç°æ–¹å¼ï¼š
     1. å®¢æˆ·ç«¯æˆ–ä¸­é—´ä»¶å®šæœŸè·å–ä¸»ä»åç§»é‡ã€‚
     2. è‹¥ä»åº“å»¶è¿Ÿè¶…è¿‡é˜ˆå€¼ï¼ˆå¦‚ 10msï¼‰ï¼Œä¸´æ—¶å°†è¯»è¯·æ±‚åˆ‡æ¢è‡³ä¸»åº“ã€‚

   - **ä¼˜ç‚¹**ï¼šå¹³è¡¡ä¸€è‡´æ€§ä¸æ€§èƒ½ã€‚

   - **ç¼ºç‚¹**ï¼šå®ç°å¤æ‚åº¦é«˜ï¼Œéœ€ç»´æŠ¤åç§»é‡ç›‘æ§é€»è¾‘ã€‚

4. **æ— ç£ç›˜åŒ–å¤åˆ¶ï¼ˆDiskless Replicationï¼‰**

   - åŸç†ï¼šRedis 4.0+ æ”¯æŒ `repl-diskless-sync yes` é…ç½®ï¼Œä¸»èŠ‚ç‚¹ç›´æ¥é€šè¿‡ Socket ä¼ è¾“ RDB å¿«ç…§åˆ°ä»èŠ‚ç‚¹å†…å­˜ï¼Œè·³è¿‡ç£ç›˜ IOã€‚

     ```Bash
     # ä¸»èŠ‚ç‚¹é…ç½®
     repl-diskless-sync yes
     repl-diskless-sync-delay 5  # å»¶è¿Ÿ5ç§’ç­‰å¾…æ›´å¤šä»åº“è¿æ¥
     ```

   - **ä¼˜ç‚¹**ï¼šå‡å°‘å…¨é‡åŒæ­¥æ—¶çš„ç£ç›˜ IO å»¶è¿Ÿï¼ŒåŠ é€Ÿæ•°æ®åŒæ­¥ã€‚

   - ç¼ºç‚¹ï¼š
     - ä»…ä¼˜åŒ–å…¨é‡åŒæ­¥ï¼Œå¢é‡åŒæ­¥ä»ä¾èµ–ç½‘ç»œä¼ è¾“ã€‚
     - ä¸»èŠ‚ç‚¹å†…å­˜å‹åŠ›å¢å¤§ï¼ˆéœ€åŒæ—¶å¤„ç†ä¼ è¾“å’Œå†™æ“ä½œï¼‰ã€‚

5. **ä¸šåŠ¡é€»è¾‘è¡¥å¿ï¼ˆæœ€ç»ˆä¸€è‡´æ€§å…œåº•ï¼‰**

   - åŸç†ï¼šé€šè¿‡ä¸šåŠ¡ä»£ç è¡¥å¿ä»åº“å»¶è¿Ÿï¼Œä¾‹å¦‚ï¼š
     - **ç‰ˆæœ¬å·æ ¡éªŒ**ï¼šå†™å…¥æ—¶è®°å½•æ•°æ®ç‰ˆæœ¬å·ï¼Œè¯»å–æ—¶æ ¡éªŒä»åº“ç‰ˆæœ¬æ˜¯å¦åŒ¹é…ã€‚
     - **äºŒæ¬¡ç¡®è®¤**ï¼šå…ˆè¯»ä»åº“ï¼Œè‹¥æ•°æ®ä¸ä¸€è‡´åˆ™é‡è¯•è¯»ä¸»åº“ã€‚

   - ç¤ºä¾‹ï¼š

     ```Python
     def read_with_retry(key):
         value = read_from_slave(key)
         if value != expected_version:
             value = read_from_master(key)
         return value
     ```

   - **é€‚ç”¨åœºæ™¯**ï¼šå¯¹ä¸€è‡´æ€§è¦æ±‚é«˜ä½†å…è®¸å°‘é‡é‡è¯•çš„ä¸šåŠ¡ï¼ˆå¦‚åº“å­˜æ‰£å‡ï¼‰ã€‚

| **æ–¹æ¡ˆ**           | **ä¸€è‡´æ€§** | **æ€§èƒ½å½±å“** | **å®ç°å¤æ‚åº¦** | **é€‚ç”¨åœºæ™¯**               |
| ------------------ | ---------- | ------------ | -------------- | -------------------------- |
| å¼ºåˆ¶è¯»ä¸»åº“         | å¼ºä¸€è‡´æ€§   | é«˜           | ä½             | ä½é¢‘å…³é”®æ“ä½œï¼ˆå¦‚æ”¯ä»˜çŠ¶æ€ï¼‰ |
| `WAIT` å‘½ä»¤        | å¼ºä¸€è‡´æ€§   | ä¸­           | ä¸­             | å†™åç«‹å³è¯»ï¼ˆå¦‚æ³¨å†Œä¿¡æ¯ï¼‰   |
| ç›‘æ§åç§»é‡åŠ¨æ€åˆ‡æ¢ | æœ€ç»ˆä¸€è‡´æ€§ | ä½           | é«˜             | é«˜ååé‡ä¸šåŠ¡ï¼ˆå¦‚å•†å“åˆ—è¡¨ï¼‰ |
| æ— ç£ç›˜åŒ–å¤åˆ¶       | ä¼˜åŒ–åŒæ­¥   | ä½           | ä¸­             | å…¨é‡åŒæ­¥é¢‘ç¹åœºæ™¯           |
| ä¸šåŠ¡é€»è¾‘è¡¥å¿       | æœ€ç»ˆä¸€è‡´æ€§ | ä¸­           | é«˜             | å…è®¸é‡è¯•çš„ä¸šåŠ¡ï¼ˆå¦‚åº“å­˜ï¼‰   |

**æ³¨æ„äº‹é¡¹**ï¼š

- Redis ä¸»ä»å¤åˆ¶æ˜¯ AP ç³»ç»Ÿï¼ˆCAP å®šç†ï¼‰ï¼Œæ— æ³•åšåˆ°å®Œå…¨å¼ºä¸€è‡´ï¼Œéœ€ç»“åˆä¸šåŠ¡å®¹å¿åº¦è®¾è®¡ã€‚
- å¯¹ä¸€è‡´æ€§è¦æ±‚æé«˜çš„åœºæ™¯ï¼ˆå¦‚é‡‘èäº¤æ˜“ï¼‰ï¼Œå»ºè®®å¼•å…¥å¤–éƒ¨æ•°æ®åº“ï¼ˆå¦‚ MySQLï¼‰å…œåº•ã€‚



### ğŸ¯ ä»€ä¹ˆæ˜¯å“¨å…µï¼Ÿ

![](https://img.starfish.ink/redis/redis-sentinel.png)

*ä¸Šå›¾* å±•ç¤ºäº†ä¸€ä¸ªå…¸å‹çš„å“¨å…µæ¶æ„å›¾ï¼Œå®ƒç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼Œå“¨å…µèŠ‚ç‚¹å’Œæ•°æ®èŠ‚ç‚¹ï¼š

- **å“¨å…µèŠ‚ç‚¹ï¼š** å“¨å…µç³»ç»Ÿç”±ä¸€ä¸ªæˆ–å¤šä¸ªå“¨å…µèŠ‚ç‚¹ç»„æˆï¼Œ**å“¨å…µèŠ‚ç‚¹æ˜¯ç‰¹æ®Šçš„ Redis èŠ‚ç‚¹ï¼Œä¸å­˜å‚¨æ•°æ®**ï¼›
- **æ•°æ®èŠ‚ç‚¹ï¼š** ä¸»èŠ‚ç‚¹å’Œä»èŠ‚ç‚¹éƒ½æ˜¯æ•°æ®èŠ‚ç‚¹ï¼›

**å“¨å…µçš„ä»‹ç»**

sentinelï¼Œä¸­æ–‡åæ˜¯å“¨å…µã€‚å“¨å…µæ˜¯ redis é›†ç¾¤æœºæ„ä¸­éå¸¸é‡è¦çš„ä¸€ä¸ªç»„ä»¶ï¼Œä¸»è¦æœ‰ä»¥ä¸‹åŠŸèƒ½ï¼š

1. é›†ç¾¤ç›‘æ§ï¼šè´Ÿè´£ç›‘æ§ redis master å’Œ slave è¿›ç¨‹æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚
2. æ¶ˆæ¯é€šçŸ¥ï¼šå¦‚æœæŸä¸ª redis å®ä¾‹æœ‰æ•…éšœï¼Œé‚£ä¹ˆå“¨å…µè´Ÿè´£å‘é€æ¶ˆæ¯ä½œä¸ºæŠ¥è­¦é€šçŸ¥ç»™ç®¡ç†å‘˜ã€‚
3. æ•…éšœè½¬ç§»ï¼šå¦‚æœ master node æŒ‚æ‰äº†ï¼Œä¼šè‡ªåŠ¨è½¬ç§»åˆ° slave node ä¸Šã€‚
4. é…ç½®ä¸­å¿ƒï¼šå¦‚æœæ•…éšœè½¬ç§»å‘ç”Ÿäº†ï¼Œé€šçŸ¥ client å®¢æˆ·ç«¯æ–°çš„ master åœ°å€ã€‚

å“¨å…µç”¨äºå®ç° redis é›†ç¾¤çš„é«˜å¯ç”¨ï¼Œæœ¬èº«ä¹Ÿæ˜¯åˆ†å¸ƒå¼çš„ï¼Œä½œä¸ºä¸€ä¸ªå“¨å…µé›†ç¾¤å»è¿è¡Œï¼Œäº’ç›¸ååŒå·¥ä½œã€‚

**å“¨å…µçš„æ ¸å¿ƒçŸ¥è¯†**

1. å“¨å…µè‡³å°‘éœ€è¦ 3 ä¸ªå®ä¾‹ï¼Œæ¥ä¿è¯è‡ªå·±çš„å¥å£®æ€§ã€‚
2. å“¨å…µ + redis ä¸»ä»çš„éƒ¨ç½²æ¶æ„ï¼Œæ˜¯ä¸ä¿è¯æ•°æ®é›¶ä¸¢å¤±çš„ï¼Œåªèƒ½ä¿è¯ redis é›†ç¾¤çš„é«˜å¯ç”¨æ€§ã€‚
3. å¯¹äºå“¨å…µ + redis ä¸»ä»è¿™ç§å¤æ‚çš„éƒ¨ç½²æ¶æ„ï¼Œå°½é‡åœ¨æµ‹è¯•ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒï¼Œéƒ½è¿›è¡Œå……è¶³çš„æµ‹è¯•å’Œæ¼”ç»ƒã€‚



### ğŸ¯ è¯´ä¸‹å“¨å…µçš„å·¥ä½œåŸç†ï¼Ÿ

1. **ç›‘æ§æœºåˆ¶ï¼šå¥åº·æ£€æŸ¥ä¸çŠ¶æ€åˆ¤å®š**

   - **å‘¨æœŸæ€§å¿ƒè·³æ£€æµ‹**ï¼š
     - æ¯ä¸ªå“¨å…µä»¥**æ¯ç§’1æ¬¡**çš„é¢‘ç‡å‘æ‰€æœ‰ä¸»èŠ‚ç‚¹ã€ä»èŠ‚ç‚¹ã€å…¶ä»–å“¨å…µèŠ‚ç‚¹å‘é€`PING`å‘½ä»¤ã€‚
     - **å“åº”è¶…æ—¶åˆ¤å®š**ï¼šè‹¥æŸèŠ‚ç‚¹åœ¨`down-after-milliseconds`ï¼ˆé»˜è®¤30ç§’ï¼‰å†…æœªå“åº”ï¼Œå“¨å…µå°†å…¶æ ‡è®°ä¸º**ä¸»è§‚ä¸‹çº¿ï¼ˆSDOWNï¼‰**ã€‚

   - **å®¢è§‚ä¸‹çº¿ï¼ˆODOWNï¼‰æŠ•ç¥¨**ï¼š
     - å½“å“¨å…µåˆ¤å®šä¸»èŠ‚ç‚¹ä¸»è§‚ä¸‹çº¿åï¼Œå‘å…¶ä»–å“¨å…µå‘é€`SENTINEL is-master-down-by-addr`å‘½ä»¤å‘èµ·æŠ•ç¥¨ã€‚
     - è‹¥**è¶…è¿‡åŠæ•°å“¨å…µ**åŒæ„ä¸»èŠ‚ç‚¹ä¸å¯ç”¨ï¼Œåˆ™ä¸»èŠ‚ç‚¹è¢«æ ‡è®°ä¸º**å®¢è§‚ä¸‹çº¿ï¼ˆODOWNï¼‰**ï¼Œè§¦å‘æ•…éšœè½¬ç§»æµç¨‹ã€‚

2. **é¢†å¯¼è€…é€‰ä¸¾ï¼šRaftå…±è¯†ç®—æ³•é€‚é…**
   - ä¸»èŠ‚ç‚¹è¢«æ ‡è®°ä¸ºå®¢è§‚ä¸‹çº¿åï¼Œæ‰€æœ‰å“¨å…µèŠ‚ç‚¹é€šè¿‡**Raft-likeç®—æ³•**é€‰ä¸¾é¢†å¯¼è€…ï¼ˆLeaderï¼‰ã€‚
   - é€‰ä¸¾è§„åˆ™ï¼š
     - æ¯ä¸ªå“¨å…µåœ¨**epochï¼ˆä»»æœŸï¼‰**å†…åªèƒ½æŠ•ä¸€ç¥¨ã€‚
     - è·å¾—**åŠæ•°ä»¥ä¸ŠæŠ•ç¥¨**çš„å“¨å…µæˆä¸ºLeaderï¼Œè´Ÿè´£æ‰§è¡Œæ•…éšœè½¬ç§»ã€‚
     - è‹¥é€‰ä¸¾å¤±è´¥ï¼Œç­‰å¾…éšæœºæ—¶é—´åé‡æ–°å‘èµ·é€‰ä¸¾ï¼ˆé¿å…æ´»é”ï¼‰ã€‚

3. **æ•…éšœè½¬ç§»ï¼šæ–°ä¸»èŠ‚ç‚¹é€‰æ‹©ä¸åˆ‡æ¢**
   - **ç­›é€‰å€™é€‰ä»èŠ‚ç‚¹**ï¼š
     - æ’é™¤å·²ä¸‹çº¿æˆ–å»¶è¿Ÿè¿‡é«˜çš„ä»èŠ‚ç‚¹ã€‚
     - æŒ‰ä¼˜å…ˆçº§é€‰æ‹©ï¼ˆ`slave-priority`é…ç½®ï¼Œå€¼è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ï¼‰ã€‚
     - è‹¥ä¼˜å…ˆçº§ç›¸åŒï¼Œé€‰æ‹©**å¤åˆ¶åç§»é‡ï¼ˆrepl_offsetï¼‰æœ€å¤§**çš„ä»èŠ‚ç‚¹ï¼ˆæ•°æ®æœ€æ–°ï¼‰ã€‚
     - è‹¥ä»ç›¸åŒï¼Œé€‰æ‹©**è¿è¡ŒIDï¼ˆrun IDï¼‰è¾ƒå°**çš„ä»èŠ‚ç‚¹ã€‚
   
   - **æå‡æ–°ä¸»èŠ‚ç‚¹**ï¼š
   
     - å‘ç›®æ ‡ä»èŠ‚ç‚¹å‘é€`SLAVEOF NO ONE`å‘½ä»¤ï¼Œä½¿å…¶æˆä¸ºä¸»èŠ‚ç‚¹ã€‚
   
     - ç­‰å¾…æ–°ä¸»èŠ‚ç‚¹æ™‹å‡å®Œæˆï¼ˆç¡®è®¤å…¶å¯å†™ä¸”æ•°æ®å®Œæ•´ï¼‰ã€‚
   
   - **é‡é…ç½®ä»èŠ‚ç‚¹**ï¼š
     - å‘æ‰€æœ‰å…¶ä»–ä»èŠ‚ç‚¹å‘é€`SLAVEOF <new_master_ip> <new_master_port>`ï¼ŒæŒ‡å‘æ–°ä¸»èŠ‚ç‚¹ã€‚
     - å¼‚æ­¥æ›´æ–°æ—§ä¸»èŠ‚ç‚¹ï¼ˆè‹¥æ¢å¤ï¼‰ä¸ºä»èŠ‚ç‚¹ï¼ŒæŒ‡å‘æ–°ä¸»èŠ‚ç‚¹ã€‚
   
4. **é€šçŸ¥ä¸å®¢æˆ·ç«¯é‡å®šå‘**

   - **å‘å¸ƒè®¢é˜…é€šçŸ¥**ï¼š
     - å“¨å…µé€šè¿‡`__sentinel__:hello`é¢‘é“å‘å¸ƒä¸»èŠ‚ç‚¹å˜æ›´äº‹ä»¶ã€‚
     - è®¢é˜…è¯¥é¢‘é“çš„å®¢æˆ·ç«¯å¯å®æ—¶æ„ŸçŸ¥æ–°ä¸»èŠ‚ç‚¹åœ°å€ã€‚

   - **å®¢æˆ·ç«¯æœåŠ¡å‘ç°**ï¼š
     - å®¢æˆ·ç«¯é€šè¿‡å“¨å…µAPIï¼ˆå¦‚`SENTINEL get-master-addr-by-name <master_name>`ï¼‰è·å–å½“å‰ä¸»èŠ‚ç‚¹åœ°å€ã€‚
     - æ”¯æŒè‡ªåŠ¨é‡è¿çš„å®¢æˆ·ç«¯åº“ï¼ˆå¦‚Jedisã€Lettuceï¼‰å†…ç½®æ•…éšœè½¬ç§»å¤„ç†é€»è¾‘ã€‚

**æ ¸å¿ƒé…ç½®å‚æ•°**

| å‚æ•°                      | é»˜è®¤å€¼   | ä½œç”¨                                 |
| ------------------------- | -------- | ------------------------------------ |
| `down-after-milliseconds` | 30000ms  | ä¸»è§‚ä¸‹çº¿åˆ¤å®šæ—¶é—´                     |
| `quorum`                  | 2        | è§¦å‘å®¢è§‚ä¸‹çº¿æ‰€éœ€æœ€å°‘å“¨å…µæŠ•ç¥¨æ•°       |
| `parallel-syncs`          | 1        | æ•…éšœè½¬ç§»ååŒæ—¶å‘æ–°ä¸»åŒæ­¥çš„ä»èŠ‚ç‚¹æ•°é‡ |
| `failover-timeout`        | 180000ms | æ•…éšœè½¬ç§»è¶…æ—¶æ—¶é—´                     |

![](https://mmbiz.qpic.cn/mmbiz_png/iaIdQfEric9TzlTcnXg26t1Dia266foajMicV4uRLib3FmS9KibcSMycB36MwicA3GTygLnQTl3VkAGb8mPE47pLzcz0g/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)



### ğŸ¯ å“¨å…µæ¨¡å¼ä¸‹æ–°çš„ä¸»æœåŠ¡å™¨æ˜¯æ€æ ·è¢«æŒ‘é€‰å‡ºæ¥çš„ï¼Ÿ

**æ•…éšœè½¬ç§»æ“ä½œçš„ç¬¬ä¸€æ­¥** è¦åšçš„å°±æ˜¯åœ¨å·²ä¸‹çº¿ä¸»æœåŠ¡å™¨å±ä¸‹çš„æ‰€æœ‰ä»æœåŠ¡å™¨ä¸­ï¼ŒæŒ‘é€‰å‡ºä¸€ä¸ªçŠ¶æ€è‰¯å¥½ã€æ•°æ®å®Œæ•´çš„ä»æœåŠ¡å™¨ï¼Œç„¶åå‘è¿™ä¸ªä»æœåŠ¡å™¨å‘é€ `slaveof no one` å‘½ä»¤ï¼Œå°†è¿™ä¸ªä»æœåŠ¡å™¨è½¬æ¢ä¸ºä¸»æœåŠ¡å™¨ã€‚ä½†æ˜¯è¿™ä¸ªä»æœåŠ¡å™¨æ˜¯æ€ä¹ˆæ ·è¢«æŒ‘é€‰å‡ºæ¥çš„å‘¢ï¼Ÿ

ç®€å•æ¥è¯´ Sentinel ä½¿ç”¨ä»¥ä¸‹è§„åˆ™æ¥é€‰æ‹©æ–°çš„ä¸»æœåŠ¡å™¨ï¼š

1. åœ¨å¤±æ•ˆä¸»æœåŠ¡å™¨å±ä¸‹çš„ä»æœåŠ¡å™¨å½“ä¸­ï¼Œ é‚£äº›è¢«æ ‡è®°ä¸ºä¸»è§‚ä¸‹çº¿ã€å·²æ–­çº¿ã€æˆ–è€…æœ€åä¸€æ¬¡å›å¤ PING å‘½ä»¤çš„æ—¶é—´å¤§äºäº”ç§’é’Ÿçš„ä»æœåŠ¡å™¨éƒ½ä¼šè¢« **æ·˜æ±°**ã€‚
2. åœ¨å¤±æ•ˆä¸»æœåŠ¡å™¨å±ä¸‹çš„ä»æœåŠ¡å™¨å½“ä¸­ï¼Œ é‚£äº›ä¸å¤±æ•ˆä¸»æœåŠ¡å™¨è¿æ¥æ–­å¼€çš„æ—¶é•¿è¶…è¿‡ down-after é€‰é¡¹æŒ‡å®šçš„æ—¶é•¿åå€çš„ä»æœåŠ¡å™¨éƒ½ä¼šè¢« **æ·˜æ±°**ã€‚
3. åœ¨ **ç»å†äº†ä»¥ä¸Šä¸¤è½®æ·˜æ±°ä¹‹å** å‰©ä¸‹æ¥çš„ä»æœåŠ¡å™¨ä¸­ï¼Œ æˆ‘ä»¬é€‰å‡º **å¤åˆ¶åç§»é‡ï¼ˆreplication offsetï¼‰æœ€å¤§** çš„é‚£ä¸ª **ä»æœåŠ¡å™¨** ä½œä¸ºæ–°çš„ä¸»æœåŠ¡å™¨ï¼›å¦‚æœå¤åˆ¶åç§»é‡ä¸å¯ç”¨ï¼Œæˆ–è€…ä»æœåŠ¡å™¨çš„å¤åˆ¶åç§»é‡ç›¸åŒï¼Œé‚£ä¹ˆ **å¸¦æœ‰æœ€å°è¿è¡Œ ID** çš„é‚£ä¸ªä»æœåŠ¡å™¨æˆä¸ºæ–°çš„ä¸»æœåŠ¡å™¨ã€‚



Redis Sentinel ç€çœ¼äºé«˜å¯ç”¨ï¼Œåœ¨ master å®•æœºæ—¶ä¼šè‡ªåŠ¨å°† slave æå‡ä¸º masterï¼Œç»§ç»­æä¾›æœåŠ¡ã€‚

Redis Cluster ç€çœ¼äºæ‰©å±•æ€§ï¼Œåœ¨å•ä¸ª redis å†…å­˜ä¸è¶³æ—¶ï¼Œä½¿ç”¨ Cluster è¿›è¡Œåˆ†ç‰‡å­˜å‚¨ã€‚

### ğŸ¯ Redis é›†ç¾¤ä½¿ç”¨è¿‡å—ï¼ŸåŸç†ï¼Ÿ

![Redis Cluster Architecture](https://img.starfish.ink/redis/redis-cluster-architecture.webp)

*ä¸Šå›¾* å±•ç¤ºäº† **Redis Cluster** å…¸å‹çš„æ¶æ„å›¾ï¼Œé›†ç¾¤ä¸­çš„æ¯ä¸€ä¸ª Redis èŠ‚ç‚¹éƒ½ **äº’ç›¸ä¸¤ä¸¤ç›¸è¿**ï¼Œå®¢æˆ·ç«¯ä»»æ„ **ç›´è¿** åˆ°é›†ç¾¤ä¸­çš„ **ä»»æ„ä¸€å°**ï¼Œå°±å¯ä»¥å¯¹å…¶ä»– Redis èŠ‚ç‚¹è¿›è¡Œ **è¯»å†™** çš„æ“ä½œã€‚



### ğŸ¯ Redisé›†ç¾¤ï¼ˆClusterï¼‰å·¥ä½œåŸç†ä¸æ ¸å¿ƒæœºåˆ¶

> Redis Cluster é€šè¿‡ **æ§½ä½åˆ†ç‰‡æœºåˆ¶ï¼ˆ16384 æ§½ï¼‰** æ¥åˆ†å¸ƒå­˜å‚¨æ•°æ®ï¼Œæ¯ä¸ª key æ ¹æ® CRC16 å“ˆå¸Œè½åˆ°å¯¹åº”çš„æ§½ä½ã€‚
>  é›†ç¾¤ç”±å¤šä¸ª Master èŠ‚ç‚¹ç»„æˆï¼Œæ¯ä¸ª Master è´Ÿè´£ä¸€éƒ¨åˆ†æ§½ä½ï¼Œå¹¶é€šè¿‡ Replica èŠ‚ç‚¹åšé«˜å¯ç”¨å¤‡ä»½ã€‚
>  èŠ‚ç‚¹ä¹‹é—´é€šè¿‡ **Gossip åè®®**ç»´æŠ¤é›†ç¾¤çŠ¶æ€ï¼Œå®¢æˆ·ç«¯è®¿é—®æ—¶é€šè¿‡ **é‡å®šå‘æœºåˆ¶ï¼ˆMOVED/ASKï¼‰** æ‰¾åˆ°ç›®æ ‡èŠ‚ç‚¹ã€‚
>  å½“æŸä¸ª Master æ•…éšœæ—¶ï¼Œé›†ç¾¤ä¼šé€šè¿‡æŠ•ç¥¨æœºåˆ¶æŠŠå…¶ Replica æå‡ä¸ºæ–°çš„ Masterï¼Œå®ç°è‡ªåŠ¨æ•…éšœè½¬ç§»ã€‚

1. **æ•°æ®åˆ†ç‰‡ï¼šè™šæ‹Ÿå“ˆå¸Œæ§½ï¼ˆVirtual Hash Slotï¼‰**

   - **åˆ†ç‰‡åŸç†**ï¼š
     - æ•´ä¸ªé›†ç¾¤åˆ’åˆ†ä¸º **16384ä¸ªå“ˆå¸Œæ§½**ï¼ˆå›ºå®šå€¼ï¼‰ï¼Œæ¯ä¸ªé”®é€šè¿‡`CRC16(key) % 16384`è®¡ç®—æ‰€å±æ§½ä½ã€‚
     - æ§½ä½å‡åŒ€åˆ†é…åˆ°æ‰€æœ‰ä¸»èŠ‚ç‚¹ï¼ˆä¾‹å¦‚ï¼š3ä¸»èŠ‚ç‚¹æ—¶ï¼Œæ¯ä¸ªä¸»èŠ‚ç‚¹è´Ÿè´£çº¦5461ä¸ªæ§½ï¼‰ã€‚
     - **æ§½ä½åˆ†é…å¯è§æ€§**ï¼šæ¯ä¸ªèŠ‚ç‚¹ç»´æŠ¤æ§½ä½æ˜ å°„è¡¨ï¼Œå®¢æˆ·ç«¯é¦–æ¬¡è¿æ¥æ—¶è·å–å¹¶ç¼“å­˜ã€‚

   - **åŠ¨æ€æ‰©ç¼©å®¹**ï¼š
     - **æ·»åŠ èŠ‚ç‚¹**ï¼šé€šè¿‡`CLUSTER ADDSLOTS`åˆ†é…ç©ºæ§½ï¼Œæˆ–è¿ç§»å…¶ä»–èŠ‚ç‚¹çš„æ§½è‡³æ–°èŠ‚ç‚¹ã€‚
     - **ç§»é™¤èŠ‚ç‚¹**ï¼šè¿ç§»æ§½è‡³å…¶ä»–èŠ‚ç‚¹åä¸‹çº¿ã€‚
     - **æ•°æ®è¿ç§»**ï¼šä½¿ç”¨`CLUSTER SETSLOT <slot> MIGRATING <node_id>`å’Œ`CLUSTER SETSLOT <slot> IMPORTING <node_id>`å‘½ä»¤å®ç°æ§½ä½è¿ç§»ã€‚

2. **é«˜å¯ç”¨ï¼šä¸»ä»å¤åˆ¶ä¸æ•…éšœè½¬ç§»**

   - **ä¸»ä»æ¶æ„**ï¼š
     - æ¯ä¸ªä¸»èŠ‚ç‚¹å¯¹åº”1ä¸ªæˆ–å¤šä¸ªä»èŠ‚ç‚¹ï¼ˆæ¨èè‡³å°‘1ä»ï¼‰ã€‚
     - ä»èŠ‚ç‚¹å¤åˆ¶ä¸»èŠ‚ç‚¹æ•°æ®ï¼Œå¹¶åœ¨ä¸»èŠ‚ç‚¹æ•…éšœæ—¶é€šè¿‡é€‰ä¸¾æ™‹å‡ä¸ºæ–°ä¸»ã€‚

   - **æ•…éšœæ£€æµ‹ä¸æ¢å¤**ï¼š
     - **èŠ‚ç‚¹é—´å¿ƒè·³**ï¼šèŠ‚ç‚¹é—´é€šè¿‡Gossipåè®®å®šæœŸäº¤æ¢PING/PONGæ¶ˆæ¯ã€‚
     - **æ•…éšœåˆ¤å®š**ï¼šè‹¥æŸä¸»èŠ‚ç‚¹è¢«å¤šæ•°ä¸»èŠ‚ç‚¹åˆ¤å®šä¸ºä¸å¯è¾¾ï¼ˆè¶…è¿‡`cluster-node-timeout`ï¼‰ï¼Œè§¦å‘æ•…éšœè½¬ç§»ã€‚
     - **è‡ªåŠ¨é€‰ä¸¾**ï¼šä»èŠ‚ç‚¹åŸºäº`slave-priority`ã€å¤åˆ¶åç§»é‡ç­‰æ¡ä»¶è‡ªåŠ¨é€‰ä¸¾æ–°ä¸»ã€‚

3. **è¯·æ±‚è·¯ç”±ä¸é‡å®šå‘**

   - **å®¢æˆ·ç«¯ç›´è¿**ï¼š

     - å®¢æˆ·ç«¯å¯è¿æ¥ä»»æ„èŠ‚ç‚¹ï¼ŒèŠ‚ç‚¹æ ¹æ®é”®çš„æ§½ä½è¿”å›æ­£ç¡®æ•°æ®æˆ–é‡å®šå‘æŒ‡ä»¤ã€‚

     - MOVEDé‡å®šå‘ï¼šå½“é”®ä¸å±äºå½“å‰èŠ‚ç‚¹æ—¶ï¼Œè¿”å› `MOVED <slot> <target_ip:port>` å‘ŠçŸ¥æ­£ç¡®èŠ‚ç‚¹ã€‚

       ```Bash
       # ç¤ºä¾‹ï¼šæ“ä½œä¸å±äºå½“å‰èŠ‚ç‚¹çš„é”®
       127.0.0.1:6379> GET user:1001
       -MOVED 1234 192.168.1.2:6380
       ```

     - **ASKé‡å®šå‘**ï¼šåœ¨æ§½è¿ç§»è¿‡ç¨‹ä¸­ï¼Œè‹¥æ•°æ®æœªå®Œå…¨è¿ç§»ï¼Œè¿”å›`ASK <slot> <target_ip:port>`ä¸´æ—¶é‡å®šå‘ã€‚

     - æˆç†Ÿå®¢æˆ·ç«¯ï¼ˆå¦‚Lettuceã€Jedisï¼‰ç¼“å­˜æ§½ä½æ˜ å°„è¡¨ï¼Œç›´æ¥è·¯ç”±è¯·æ±‚åˆ°æ­£ç¡®èŠ‚ç‚¹ï¼Œå‡å°‘é‡å®šå‘ã€‚

4. **èŠ‚ç‚¹é€šä¿¡ï¼šGossipåè®®**

   - **ä¿¡æ¯äº¤æ¢**ï¼š
     - èŠ‚ç‚¹é—´å‘¨æœŸæ€§ï¼ˆé»˜è®¤æ¯ç§’10æ¬¡ï¼‰éšæœºé€‰æ‹©èŠ‚ç‚¹å‘é€PINGæ¶ˆæ¯ï¼Œæºå¸¦å…¶ä»–èŠ‚ç‚¹çŠ¶æ€ä¿¡æ¯ã€‚
     - æ¥æ”¶èŠ‚ç‚¹å›åº”PONGæ¶ˆæ¯ï¼Œæ›´æ–°æœ¬åœ°é›†ç¾¤çŠ¶æ€è§†å›¾ã€‚

   - **é›†ç¾¤çŠ¶æ€åŒæ­¥**ï¼š
     - æ¯ä¸ªèŠ‚ç‚¹ç»´æŠ¤é›†ç¾¤å…ƒæ•°æ®ï¼ˆèŠ‚ç‚¹åˆ—è¡¨ã€æ§½ä½åˆ†é…ã€ä¸»ä»å…³ç³»ç­‰ï¼‰ã€‚
     - æ–°èŠ‚ç‚¹åŠ å…¥æ—¶ï¼Œé€šè¿‡ç§å­èŠ‚ç‚¹ï¼ˆé…ç½®çš„åˆå§‹èŠ‚ç‚¹ï¼‰åŒæ­¥å…¨é‡é›†ç¾¤çŠ¶æ€ã€‚



### ğŸ¯ ä¸ºä»€ä¹ˆé€‰æ‹©16384ä¸ªæ§½ï¼Ÿ

  - 2^14 = 16384ï¼Œä¾¿äºä½è¿ç®—ä¼˜åŒ–
  - å¿ƒè·³åŒ…å¤§å°æ§åˆ¶ï¼šæ§½ä½ä¿¡æ¯ç”¨bitmapä¼ è¾“ï¼Œ16384ä½ = 2KB
  - é›†ç¾¤è§„æ¨¡è€ƒé‡ï¼šæ”¯æŒæœ€å¤š1000ä¸ªèŠ‚ç‚¹çš„åˆç†ä¸Šé™



### ğŸ¯ Redis Clusteræ ¸å¿ƒä¼˜åŠ¿ | é›†ç¾¤çš„ä¸»è¦ä½œç”¨

1. **çº¿æ€§æ‰©å±•æ€§**ï¼šæ•°æ®åˆ†åŒº *(æˆ–ç§°æ•°æ®åˆ†ç‰‡)* æ˜¯é›†ç¾¤æœ€æ ¸å¿ƒçš„åŠŸèƒ½ã€‚é›†ç¾¤å°†æ•°æ®åˆ†æ•£åˆ°å¤šä¸ªèŠ‚ç‚¹ï¼Œ**ä¸€æ–¹é¢** çªç ´äº† Redis å•æœºå†…å­˜å¤§å°çš„é™åˆ¶ï¼Œ**å­˜å‚¨å®¹é‡å¤§å¤§å¢åŠ **ï¼›**å¦ä¸€æ–¹é¢** æ¯ä¸ªä¸»èŠ‚ç‚¹éƒ½å¯ä»¥å¯¹å¤–æä¾›è¯»æœåŠ¡å’Œå†™æœåŠ¡ï¼Œ**å¤§å¤§æé«˜äº†é›†ç¾¤çš„å“åº”èƒ½åŠ›**
2. **é«˜å¯ç”¨æ€§**ï¼šå†…ç½®ä¸»ä»å¤åˆ¶ä¸è‡ªåŠ¨æ•…éšœè½¬ç§»ï¼Œæ— éœ€ä¾èµ–å“¨å…µã€‚
3. **å»ä¸­å¿ƒåŒ–æ¶æ„**ï¼šæ— å•ç‚¹æ•…éšœï¼ŒèŠ‚ç‚¹å¹³ç­‰ï¼ˆé™¤ä¸»ä»è§’è‰²å·®å¼‚ï¼‰ã€‚
4. **å®¢æˆ·ç«¯é€æ˜è·¯ç”±**ï¼šæ™ºèƒ½å®¢æˆ·ç«¯è‡ªåŠ¨å¤„ç†é‡å®šå‘ï¼Œä¸šåŠ¡æ— æ„ŸçŸ¥ã€‚



### ğŸ¯ é›†ç¾¤ä¸­æ•°æ®å¦‚ä½•åˆ†åŒºï¼Ÿ

Redisé›†ç¾¤é‡‡ç”¨**å¸¦æœ‰è™šæ‹ŸèŠ‚ç‚¹çš„å“ˆå¸Œæ§½ï¼ˆHash Slotï¼‰åˆ†åŒºæ–¹æ¡ˆ**ï¼Œåœ¨æ•°æ®åˆ†å¸ƒã€æ‰©å±•æ€§å’Œå®¹é”™æ€§ä¹‹é—´å–å¾—äº†é«˜æ•ˆå¹³è¡¡ã€‚ä»¥ä¸‹æ˜¯æ ¸å¿ƒåŸç†ä¸å®ç°ç»†èŠ‚ï¼š

1. **è™šæ‹Ÿå“ˆå¸Œæ§½çš„æ ¸å¿ƒè®¾è®¡**

   - **å›ºå®šæ§½ä½æ•°é‡**ï¼šé¢„åˆ†é…16384ä¸ªè™šæ‹Ÿæ§½ï¼ˆSlotï¼‰ï¼Œç¼–å·0-16383ï¼Œ**æ§½ä½æ€»æ•°å›ºå®šä¸å˜**ã€‚

   - åŠ¨æ€æ§½ä½æ˜ å°„ï¼šæ¯ä¸ªä¸»èŠ‚ç‚¹è´Ÿè´£ç®¡ç†ä¸€éƒ¨åˆ†æ§½ä½ï¼Œæ§½ä½ä¸èŠ‚ç‚¹çš„æ˜ å°„å…³ç³»å¯åŠ¨æ€è°ƒæ•´ã€‚

     ```Bash
     # æ‰‹åŠ¨åˆ†é…æ§½ä½ç»™èŠ‚ç‚¹ï¼ˆç¤ºä¾‹ï¼šå°†æ§½0-5000åˆ†é…ç»™èŠ‚ç‚¹Aï¼‰
     CLUSTER ADDSLOTS {0..5000}
     ```

- æ•°æ®è·¯ç”±è§„åˆ™ï¼š
  - é”®é€šè¿‡`CRC16(key) % 16384`è®¡ç®—æ‰€å±æ§½ä½ã€‚
  - å®¢æˆ·ç«¯æ ¹æ®æ§½ä½æ˜ å°„è¡¨ç›´æ¥è®¿é—®ç›®æ ‡èŠ‚ç‚¹ï¼Œæˆ–é€šè¿‡`MOVED`/`ASK`é‡å®šå‘è·å–æœ€æ–°è·¯ç”±ã€‚

2. **å¯¹æ¯”ä¸‰ç§åˆ†åŒºæ–¹æ¡ˆçš„ä¼˜åŠ¿**

| **æ–¹æ¡ˆ**             | **ä¼˜ç‚¹**             | **ç¼ºç‚¹**                     | Redisé›†ç¾¤çš„é€‰æ‹©åŸå›           |
| -------------------- | -------------------- | ---------------------------- | ---------------------------- |
| **å“ˆå¸Œå–ä½™ï¼ˆ%ï¼‰**    | å®ç°ç®€å•             | æ‰©ç¼©å®¹æ—¶æ•°æ®å…¨é‡è¿ç§»ï¼Œæˆæœ¬é«˜ | ä¸é‡‡ç”¨                       |
| **ä¸€è‡´æ€§å“ˆå¸Œ**       | æ‰©ç¼©å®¹ä»…å½±å“ç›¸é‚»èŠ‚ç‚¹ | èŠ‚ç‚¹å°‘æ—¶æ•°æ®å€¾æ–œä¸¥é‡         | æ”¹è¿›åé‡‡ç”¨ï¼ˆå¼•å…¥è™šæ‹Ÿæ§½ï¼‰     |
| **è™šæ‹Ÿæ§½ä¸€è‡´æ€§å“ˆå¸Œ** | æ•°æ®å‡åŒ€ã€æ‰©ç¼©å®¹æ•æ· | éœ€ç»´æŠ¤æ§½ä½æ˜ å°„å…³ç³»           | é‡‡ç”¨ï¼Œå¹³è¡¡æ‰©å±•æ€§ä¸ç®¡ç†å¤æ‚åº¦ |

3. **æ‰©ç¼©å®¹ä¸æ•°æ®è¿ç§»æµç¨‹**

   - **æ‰©å®¹**ï¼š

     - æ–°èŠ‚ç‚¹åŠ å…¥é›†ç¾¤ï¼Œåˆå§‹ä¸è´Ÿè´£ä»»ä½•æ§½ã€‚
     - ä»ç°æœ‰èŠ‚ç‚¹è¿ç§»éƒ¨åˆ†æ§½è‡³æ–°èŠ‚ç‚¹ï¼ˆå¦‚å‡åŒ€åˆ†é…ï¼‰ã€‚
     - æ›´æ–°é›†ç¾¤å…ƒæ•°æ®ï¼Œå¹¿æ’­æ–°æ§½ä½åˆ†é…ã€‚

     ```Bash
     # å°†æ§½1000ä»èŠ‚ç‚¹Aè¿ç§»åˆ°æ–°èŠ‚ç‚¹B
     CLUSTER SETSLOT 1000 IMPORTING B-node-id  # ç›®æ ‡èŠ‚ç‚¹æ‰§è¡Œ
     CLUSTER SETSLOT 1000 MIGRATING A-node-id  # æºèŠ‚ç‚¹æ‰§è¡Œ
     # è¿ç§»æ•°æ®åï¼Œæœ€ç»ˆè®¾ç½®æ§½å½’å±
     CLUSTER SETSLOT 1000 NODE B-node-id
     ```

   - **ç¼©å®¹**ï¼š

     - å°†å¾…ç§»é™¤èŠ‚ç‚¹çš„æ§½è¿ç§»è‡³å…¶ä»–èŠ‚ç‚¹ã€‚

     - èŠ‚ç‚¹æ— æ§½åï¼Œæ‰§è¡Œ`CLUSTER FORGET`ä»é›†ç¾¤ç§»é™¤ã€‚

4. **æ•°æ®å‡è¡¡ä¸æ•…éšœè½¬ç§»**

   - **è‡ªåŠ¨å‡è¡¡**ï¼šé€šè¿‡`redis-cli --cluster rebalance`å‘½ä»¤è§¦å‘æ§½ä½å‡è¡¡åˆ†é…ï¼Œç¡®ä¿å„èŠ‚ç‚¹è´Ÿè½½å‡åŒ€ã€‚

   - æ•…éšœæ¢å¤ï¼š
     - ä¸»èŠ‚ç‚¹å®•æœºæ—¶ï¼Œå…¶ä»èŠ‚ç‚¹é€šè¿‡é€‰ä¸¾æ™‹å‡ä¸ºæ–°ä¸»ï¼Œæ¥ç®¡æ§½ä½ã€‚
     - é›†ç¾¤è‡ªåŠ¨æ›´æ–°æ§½ä½æ˜ å°„ï¼Œå®¢æˆ·ç«¯é€šè¿‡é‡å®šå‘æ— ç¼åˆ‡æ¢ã€‚

5. **å®¢æˆ·ç«¯è·¯ç”±ä¼˜åŒ–**

   - **æ™ºèƒ½ç¼“å­˜**ï¼šå®¢æˆ·ç«¯é¦–æ¬¡è¿æ¥é›†ç¾¤æ—¶è·å–æ§½ä½æ˜ å°„è¡¨ï¼Œæœ¬åœ°ç¼“å­˜ä»¥å‡å°‘é‡å®šå‘æ¬¡æ•°ã€‚

   - MOVEDé‡å®šå‘ï¼š

     ```Bash
     # å®¢æˆ·ç«¯è®¿é—®é”™è¯¯èŠ‚ç‚¹æ—¶çš„å“åº”
     127.0.0.1:6379> GET user:101
     -MOVED 9252 192.168.1.2:6380  # æ§½9252å½“å‰ç”±192.168.1.2:6380ç®¡ç†
     ```

   - **ASKé‡å®šå‘**ï¼šåœ¨æ§½è¿ç§»è¿‡ç¨‹ä¸­ï¼Œè‹¥æ•°æ®å°šæœªå®Œå…¨è¿ç§»ï¼Œä¸´æ—¶é‡å®šå‘å®¢æˆ·ç«¯åˆ°ç›®æ ‡èŠ‚ç‚¹ã€‚

**æ€»ç»“**ï¼šRedisé›†ç¾¤é€šè¿‡è™šæ‹Ÿæ§½æœºåˆ¶å°†æ•°æ®è§£è€¦äºç‰©ç†èŠ‚ç‚¹ï¼Œå®ç°é«˜æ•ˆçš„åŠ¨æ€æ‰©ç¼©å®¹ä¸è´Ÿè½½å‡è¡¡ã€‚ç›¸æ¯”ä¼ ç»Ÿå“ˆå¸Œå–ä½™å’Œä¸€è‡´æ€§å“ˆå¸Œæ–¹æ¡ˆï¼Œè™šæ‹Ÿæ§½é¿å…äº†å¤§è§„æ¨¡æ•°æ®è¿ç§»å’Œæ•°æ®å€¾æ–œé—®é¢˜ï¼Œæˆä¸ºæ”¯æ’‘é«˜å¯ç”¨ã€é«˜æ€§èƒ½åˆ†å¸ƒå¼RedisæœåŠ¡çš„æ ¸å¿ƒåŸºç¡€ã€‚

> #### ä¸€è‡´æ€§å“ˆå¸Œåˆ†åŒº
>
> ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•å°† **æ•´ä¸ªå“ˆå¸Œå€¼ç©ºé—´** ç»„ç»‡æˆä¸€ä¸ªè™šæ‹Ÿçš„åœ†ç¯ï¼ŒèŒƒå›´æ˜¯ *[0 - 2^32 - 1]*ï¼Œå¯¹äºæ¯ä¸€ä¸ªæ•°æ®ï¼Œæ ¹æ® `key` è®¡ç®— hash å€¼ï¼Œç¡®æ•°æ®åœ¨ç¯ä¸Šçš„ä½ç½®ï¼Œç„¶åä»æ­¤ä½ç½®æ²¿é¡ºæ—¶é’ˆè¡Œèµ°ï¼Œæ‰¾åˆ°çš„ç¬¬ä¸€å°æœåŠ¡å™¨å°±æ˜¯å…¶åº”è¯¥æ˜ å°„åˆ°çš„æœåŠ¡å™¨ï¼š
>
> ä¸å“ˆå¸Œå–ä½™åˆ†åŒºç›¸æ¯”ï¼Œä¸€è‡´æ€§å“ˆå¸Œåˆ†åŒºå°† **å¢å‡èŠ‚ç‚¹çš„å½±å“é™åˆ¶åœ¨ç›¸é‚»èŠ‚ç‚¹**ã€‚ä»¥ä¸Šå›¾ä¸ºä¾‹ï¼Œå¦‚æœåœ¨ `node1` å’Œ `node2` ä¹‹é—´å¢åŠ  `node5`ï¼Œåˆ™åªæœ‰ `node2` ä¸­çš„ä¸€éƒ¨åˆ†æ•°æ®ä¼šè¿ç§»åˆ° `node5`ï¼›å¦‚æœå»æ‰ `node2`ï¼Œåˆ™åŸ `node2` ä¸­çš„æ•°æ®åªä¼šè¿ç§»åˆ° `node4` ä¸­ï¼Œåªæœ‰ `node4` ä¼šå—å½±å“ã€‚
>
> ä¸€è‡´æ€§å“ˆå¸Œåˆ†åŒºçš„ä¸»è¦é—®é¢˜åœ¨äºï¼Œå½“ **èŠ‚ç‚¹æ•°é‡è¾ƒå°‘** æ—¶ï¼Œå¢åŠ æˆ–åˆ å‡èŠ‚ç‚¹ï¼Œ**å¯¹å•ä¸ªèŠ‚ç‚¹çš„å½±å“å¯èƒ½å¾ˆå¤§**ï¼Œé€ æˆæ•°æ®çš„ä¸¥é‡ä¸å¹³è¡¡ã€‚è¿˜æ˜¯ä»¥ä¸Šå›¾ä¸ºä¾‹ï¼Œå¦‚æœå»æ‰ `node2`ï¼Œ`node4` ä¸­çš„æ•°æ®ç”±æ€»æ•°æ®çš„ `1/4` å·¦å³å˜ä¸º `1/2` å·¦å³ï¼Œä¸å…¶ä»–èŠ‚ç‚¹ç›¸æ¯”è´Ÿè½½è¿‡é«˜ã€‚
>
> #### å¸¦æœ‰è™šæ‹ŸèŠ‚ç‚¹çš„ä¸€è‡´æ€§å“ˆå¸Œåˆ†åŒº
>
> è¯¥æ–¹æ¡ˆåœ¨ **ä¸€è‡´æ€§å“ˆå¸Œåˆ†åŒºçš„åŸºç¡€ä¸Š**ï¼Œå¼•å…¥äº† **è™šæ‹ŸèŠ‚ç‚¹** çš„æ¦‚å¿µã€‚Redis é›†ç¾¤ä½¿ç”¨çš„ä¾¿æ˜¯è¯¥æ–¹æ¡ˆï¼Œå…¶ä¸­çš„è™šæ‹ŸèŠ‚ç‚¹ç§°ä¸º **æ§½ï¼ˆslotï¼‰**ã€‚æ§½æ˜¯ä»‹äºæ•°æ®å’Œå®é™…èŠ‚ç‚¹ä¹‹é—´çš„è™šæ‹Ÿæ¦‚å¿µï¼Œæ¯ä¸ªå®é™…èŠ‚ç‚¹åŒ…å«ä¸€å®šæ•°é‡çš„æ§½ï¼Œæ¯ä¸ªæ§½åŒ…å«å“ˆå¸Œå€¼åœ¨ä¸€å®šèŒƒå›´å†…çš„æ•°æ®ã€‚
>
> åœ¨ä½¿ç”¨äº†æ§½çš„ä¸€è‡´æ€§å“ˆå¸Œåˆ†åŒºä¸­ï¼Œ**æ§½æ˜¯æ•°æ®ç®¡ç†å’Œè¿ç§»çš„åŸºæœ¬å•ä½**ã€‚æ§½ **è§£è€¦** äº† **æ•°æ®å’Œå®é™…èŠ‚ç‚¹** ä¹‹é—´çš„å…³ç³»ï¼Œå¢åŠ æˆ–åˆ é™¤èŠ‚ç‚¹å¯¹ç³»ç»Ÿçš„å½±å“å¾ˆå°ã€‚ä»ä»¥ä¸Šå›¾ä¸ºä¾‹ï¼Œç³»ç»Ÿä¸­æœ‰ `4` ä¸ªå®é™…èŠ‚ç‚¹ï¼Œå‡è®¾ä¸ºå…¶åˆ†é… `16` ä¸ªæ§½(0-15)ï¼›
>
> - æ§½ 0-3 ä½äº node1ï¼›4-7 ä½äº node2ï¼›ä»¥æ­¤ç±»æ¨â€¦.
>
> å¦‚æœæ­¤æ—¶åˆ é™¤ `node2`ï¼Œåªéœ€è¦å°†æ§½ 4-7 é‡æ–°åˆ†é…å³å¯ï¼Œä¾‹å¦‚æ§½ 4-5 åˆ†é…ç»™ `node1`ï¼Œæ§½ 6 åˆ†é…ç»™ `node3`ï¼Œæ§½ 7 åˆ†é…ç»™ `node4`ï¼›å¯ä»¥çœ‹å‡ºåˆ é™¤ `node2` åï¼Œæ•°æ®åœ¨å…¶ä»–èŠ‚ç‚¹çš„åˆ†å¸ƒä»ç„¶è¾ƒä¸ºå‡è¡¡ã€‚
>



### ğŸ¯ èŠ‚ç‚¹ä¹‹é—´çš„é€šä¿¡æœºåˆ¶äº†è§£å—ï¼Ÿ

é›†ç¾¤çš„å»ºç«‹ç¦»ä¸å¼€èŠ‚ç‚¹ä¹‹é—´çš„é€šä¿¡ï¼Œå‡å¦‚æˆ‘ä»¬å¯åŠ¨å…­ä¸ªé›†ç¾¤èŠ‚ç‚¹ä¹‹åé€šè¿‡ `redis-cli` å‘½ä»¤å¸®åŠ©æˆ‘ä»¬æ­å»ºèµ·æ¥äº†é›†ç¾¤ï¼Œå®é™…ä¸ŠèƒŒåæ¯ä¸ªé›†ç¾¤ä¹‹é—´çš„ä¸¤ä¸¤è¿æ¥æ˜¯é€šè¿‡äº† `CLUSTER MEET` å‘½ä»¤å‘é€ `MEET` æ¶ˆæ¯å®Œæˆçš„ï¼Œä¸‹é¢æˆ‘ä»¬å±•å¼€è¯¦ç»†è¯´è¯´ã€‚

**ä¸¤ä¸ªç«¯å£**

åœ¨ **å“¨å…µç³»ç»Ÿ** ä¸­ï¼ŒèŠ‚ç‚¹åˆ†ä¸º **æ•°æ®èŠ‚ç‚¹** å’Œ **å“¨å…µèŠ‚ç‚¹**ï¼šå‰è€…å­˜å‚¨æ•°æ®ï¼Œåè€…å®ç°é¢å¤–çš„æ§åˆ¶åŠŸèƒ½ã€‚åœ¨ **é›†ç¾¤** ä¸­ï¼Œæ²¡æœ‰æ•°æ®èŠ‚ç‚¹ä¸éæ•°æ®èŠ‚ç‚¹ä¹‹åˆ†ï¼š**æ‰€æœ‰çš„èŠ‚ç‚¹éƒ½å­˜å‚¨æ•°æ®ï¼Œä¹Ÿéƒ½å‚ä¸é›†ç¾¤çŠ¶æ€çš„ç»´æŠ¤**ã€‚ä¸ºæ­¤ï¼Œé›†ç¾¤ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹ï¼Œéƒ½æä¾›äº†ä¸¤ä¸ª TCP ç«¯å£ï¼š

- **æ™®é€šç«¯å£ï¼š** å³æˆ‘ä»¬åœ¨å‰é¢æŒ‡å®šçš„ç«¯å£ *(7000ç­‰)*ã€‚æ™®é€šç«¯å£ä¸»è¦ç”¨äºä¸ºå®¢æˆ·ç«¯æä¾›æœåŠ¡ *ï¼ˆä¸å•æœºèŠ‚ç‚¹ç±»ä¼¼ï¼‰*ï¼›ä½†åœ¨èŠ‚ç‚¹é—´æ•°æ®è¿ç§»æ—¶ä¹Ÿä¼šä½¿ç”¨ã€‚
- **é›†ç¾¤ç«¯å£ï¼š** ç«¯å£å·æ˜¯æ™®é€šç«¯å£ + 10000 *ï¼ˆ10000æ˜¯å›ºå®šå€¼ï¼Œæ— æ³•æ”¹å˜ï¼‰*ï¼Œå¦‚ `7000` èŠ‚ç‚¹çš„é›†ç¾¤ç«¯å£ä¸º `17000`ã€‚**é›†ç¾¤ç«¯å£åªç”¨äºèŠ‚ç‚¹ä¹‹é—´çš„é€šä¿¡**ï¼Œå¦‚æ­å»ºé›†ç¾¤ã€å¢å‡èŠ‚ç‚¹ã€æ•…éšœè½¬ç§»ç­‰æ“ä½œæ—¶èŠ‚ç‚¹é—´çš„é€šä¿¡ï¼›ä¸è¦ä½¿ç”¨å®¢æˆ·ç«¯è¿æ¥é›†ç¾¤æ¥å£ã€‚ä¸ºäº†ä¿è¯é›†ç¾¤å¯ä»¥æ­£å¸¸å·¥ä½œï¼Œåœ¨é…ç½®é˜²ç«å¢™æ—¶ï¼Œè¦åŒæ—¶å¼€å¯æ™®é€šç«¯å£å’Œé›†ç¾¤ç«¯å£ã€‚

**Gossip åè®®**

èŠ‚ç‚¹é—´é€šä¿¡ï¼ŒæŒ‰ç…§é€šä¿¡åè®®å¯ä»¥åˆ†ä¸ºå‡ ç§ç±»å‹ï¼šå•å¯¹å•ã€å¹¿æ’­ã€Gossip åè®®ç­‰ã€‚é‡ç‚¹æ˜¯å¹¿æ’­å’Œ Gossip çš„å¯¹æ¯”ã€‚

- å¹¿æ’­æ˜¯æŒ‡å‘é›†ç¾¤å†…æ‰€æœ‰èŠ‚ç‚¹å‘é€æ¶ˆæ¯ã€‚**ä¼˜ç‚¹** æ˜¯é›†ç¾¤çš„æ”¶æ•›é€Ÿåº¦å¿«(é›†ç¾¤æ”¶æ•›æ˜¯æŒ‡é›†ç¾¤å†…æ‰€æœ‰èŠ‚ç‚¹è·å¾—çš„é›†ç¾¤ä¿¡æ¯æ˜¯ä¸€è‡´çš„)ï¼Œ**ç¼ºç‚¹** æ˜¯æ¯æ¡æ¶ˆæ¯éƒ½è¦å‘é€ç»™æ‰€æœ‰èŠ‚ç‚¹ï¼ŒCPUã€å¸¦å®½ç­‰æ¶ˆè€—è¾ƒå¤§ã€‚
- Gossip åè®®çš„ç‰¹ç‚¹æ˜¯ï¼šåœ¨èŠ‚ç‚¹æ•°é‡æœ‰é™çš„ç½‘ç»œä¸­ï¼Œ**æ¯ä¸ªèŠ‚ç‚¹éƒ½ â€œéšæœºâ€ çš„ä¸éƒ¨åˆ†èŠ‚ç‚¹é€šä¿¡** ï¼ˆå¹¶ä¸æ˜¯çœŸæ­£çš„éšæœºï¼Œè€Œæ˜¯æ ¹æ®ç‰¹å®šçš„è§„åˆ™é€‰æ‹©é€šä¿¡çš„èŠ‚ç‚¹ï¼‰ï¼Œç»è¿‡ä¸€ç•ªæ‚ä¹±æ— ç« çš„é€šä¿¡ï¼Œæ¯ä¸ªèŠ‚ç‚¹çš„çŠ¶æ€å¾ˆå¿«ä¼šè¾¾åˆ°ä¸€è‡´ã€‚Gossip åè®®çš„ **ä¼˜ç‚¹**æœ‰è´Ÿè½½ (æ¯”å¹¿æ’­) ä½ã€å»ä¸­å¿ƒåŒ–ã€å®¹é”™æ€§é«˜ *(å› ä¸ºé€šä¿¡æœ‰å†—ä½™)* ç­‰ï¼›**ç¼ºç‚¹** ä¸»è¦æ˜¯é›†ç¾¤çš„æ”¶æ•›é€Ÿåº¦æ…¢ã€‚

**æ¶ˆæ¯ç±»å‹**

é›†ç¾¤ä¸­çš„èŠ‚ç‚¹é‡‡ç”¨ **å›ºå®šé¢‘ç‡ï¼ˆæ¯ç§’10æ¬¡ï¼‰** çš„ **å®šæ—¶ä»»åŠ¡** è¿›è¡Œé€šä¿¡ç›¸å…³çš„å·¥ä½œï¼šåˆ¤æ–­æ˜¯å¦éœ€è¦å‘é€æ¶ˆæ¯åŠæ¶ˆæ¯ç±»å‹ã€ç¡®å®šæ¥æ”¶èŠ‚ç‚¹ã€å‘é€æ¶ˆæ¯ç­‰ã€‚å¦‚æœé›†ç¾¤çŠ¶æ€å‘ç”Ÿäº†å˜åŒ–ï¼Œå¦‚å¢å‡èŠ‚ç‚¹ã€æ§½çŠ¶æ€å˜æ›´ï¼Œé€šè¿‡èŠ‚ç‚¹é—´çš„é€šä¿¡ï¼Œæ‰€æœ‰èŠ‚ç‚¹ä¼šå¾ˆå¿«å¾—çŸ¥æ•´ä¸ªé›†ç¾¤çš„çŠ¶æ€ï¼Œä½¿é›†ç¾¤æ”¶æ•›ã€‚

èŠ‚ç‚¹é—´å‘é€çš„æ¶ˆæ¯ä¸»è¦åˆ†ä¸º `5` ç§ï¼š`meet æ¶ˆæ¯`ã€`ping æ¶ˆæ¯`ã€`pong æ¶ˆæ¯`ã€`fail æ¶ˆæ¯`ã€`publish æ¶ˆæ¯`ã€‚ä¸åŒçš„æ¶ˆæ¯ç±»å‹ï¼Œé€šä¿¡åè®®ã€å‘é€çš„é¢‘ç‡å’Œæ—¶æœºã€æ¥æ”¶èŠ‚ç‚¹çš„é€‰æ‹©ç­‰æ˜¯ä¸åŒçš„ï¼š

- **MEET æ¶ˆæ¯ï¼š** åœ¨èŠ‚ç‚¹æ¡æ‰‹é˜¶æ®µï¼Œå½“èŠ‚ç‚¹æ”¶åˆ°å®¢æˆ·ç«¯çš„ `CLUSTER MEET` å‘½ä»¤æ—¶ï¼Œä¼šå‘æ–°åŠ å…¥çš„èŠ‚ç‚¹å‘é€ `MEET` æ¶ˆæ¯ï¼Œè¯·æ±‚æ–°èŠ‚ç‚¹åŠ å…¥åˆ°å½“å‰é›†ç¾¤ï¼›æ–°èŠ‚ç‚¹æ”¶åˆ° MEET æ¶ˆæ¯åä¼šå›å¤ä¸€ä¸ª `PONG` æ¶ˆæ¯ã€‚
- **PING æ¶ˆæ¯ï¼š** é›†ç¾¤é‡Œæ¯ä¸ªèŠ‚ç‚¹æ¯ç§’é’Ÿä¼šé€‰æ‹©éƒ¨åˆ†èŠ‚ç‚¹å‘é€ `PING` æ¶ˆæ¯ï¼Œæ¥æ”¶è€…æ”¶åˆ°æ¶ˆæ¯åä¼šå›å¤ä¸€ä¸ª `PONG` æ¶ˆæ¯ã€‚**PING æ¶ˆæ¯çš„å†…å®¹æ˜¯è‡ªèº«èŠ‚ç‚¹å’Œéƒ¨åˆ†å…¶ä»–èŠ‚ç‚¹çš„çŠ¶æ€ä¿¡æ¯**ï¼Œä½œç”¨æ˜¯å½¼æ­¤äº¤æ¢ä¿¡æ¯ï¼Œä»¥åŠæ£€æµ‹èŠ‚ç‚¹æ˜¯å¦åœ¨çº¿ã€‚`PING` æ¶ˆæ¯ä½¿ç”¨ Gossip åè®®å‘é€ï¼Œæ¥æ”¶èŠ‚ç‚¹çš„é€‰æ‹©å…¼é¡¾äº†æ”¶æ•›é€Ÿåº¦å’Œå¸¦å®½æˆæœ¬ï¼Œ**å…·ä½“è§„åˆ™å¦‚ä¸‹**ï¼š(1)éšæœºæ‰¾ 5 ä¸ªèŠ‚ç‚¹ï¼Œåœ¨å…¶ä¸­é€‰æ‹©æœ€ä¹…æ²¡æœ‰é€šä¿¡çš„ 1 ä¸ªèŠ‚ç‚¹ï¼›(2)æ‰«æèŠ‚ç‚¹åˆ—è¡¨ï¼Œé€‰æ‹©æœ€è¿‘ä¸€æ¬¡æ”¶åˆ° `PONG` æ¶ˆæ¯æ—¶é—´å¤§äº `cluster_node_timeout / 2` çš„æ‰€æœ‰èŠ‚ç‚¹ï¼Œé˜²æ­¢è¿™äº›èŠ‚ç‚¹é•¿æ—¶é—´æœªæ›´æ–°ã€‚
- **PONGæ¶ˆæ¯ï¼š** `PONG` æ¶ˆæ¯å°è£…äº†è‡ªèº«çŠ¶æ€æ•°æ®ã€‚å¯ä»¥åˆ†ä¸ºä¸¤ç§ï¼š**ç¬¬ä¸€ç§** æ˜¯åœ¨æ¥åˆ° `MEET/PING` æ¶ˆæ¯åå›å¤çš„ `PONG` æ¶ˆæ¯ï¼›**ç¬¬äºŒç§** æ˜¯æŒ‡èŠ‚ç‚¹å‘é›†ç¾¤å¹¿æ’­ `PONG` æ¶ˆæ¯ï¼Œè¿™æ ·å…¶ä»–èŠ‚ç‚¹å¯ä»¥è·çŸ¥è¯¥èŠ‚ç‚¹çš„æœ€æ–°ä¿¡æ¯ï¼Œä¾‹å¦‚æ•…éšœæ¢å¤åæ–°çš„ä¸»èŠ‚ç‚¹ä¼šå¹¿æ’­ `PONG` æ¶ˆæ¯ã€‚
- **FAIL æ¶ˆæ¯ï¼š** å½“ä¸€ä¸ªä¸»èŠ‚ç‚¹åˆ¤æ–­å¦ä¸€ä¸ªä¸»èŠ‚ç‚¹è¿›å…¥ `FAIL` çŠ¶æ€æ—¶ï¼Œä¼šå‘é›†ç¾¤å¹¿æ’­è¿™ä¸€ `FAIL` æ¶ˆæ¯ï¼›æ¥æ”¶èŠ‚ç‚¹ä¼šå°†è¿™ä¸€ `FAIL` æ¶ˆæ¯ä¿å­˜èµ·æ¥ï¼Œä¾¿äºåç»­çš„åˆ¤æ–­ã€‚
- **PUBLISH æ¶ˆæ¯ï¼š** èŠ‚ç‚¹æ”¶åˆ° `PUBLISH` å‘½ä»¤åï¼Œä¼šå…ˆæ‰§è¡Œè¯¥å‘½ä»¤ï¼Œç„¶åå‘é›†ç¾¤å¹¿æ’­è¿™ä¸€æ¶ˆæ¯ï¼Œæ¥æ”¶èŠ‚ç‚¹ä¹Ÿä¼šæ‰§è¡Œè¯¥ `PUBLISH` å‘½ä»¤ã€‚



### ğŸ¯ é›†ç¾¤æ•°æ®å¦‚ä½•å­˜å‚¨çš„æœ‰äº†è§£å—ï¼Ÿ

èŠ‚ç‚¹éœ€è¦ä¸“é—¨çš„æ•°æ®ç»“æ„æ¥å­˜å‚¨é›†ç¾¤çš„çŠ¶æ€ã€‚æ‰€è°“é›†ç¾¤çš„çŠ¶æ€ï¼Œæ˜¯ä¸€ä¸ªæ¯”è¾ƒå¤§çš„æ¦‚å¿µï¼ŒåŒ…æ‹¬ï¼šé›†ç¾¤æ˜¯å¦å¤„äºä¸Šçº¿çŠ¶æ€ã€é›†ç¾¤ä¸­æœ‰å“ªäº›èŠ‚ç‚¹ã€èŠ‚ç‚¹æ˜¯å¦å¯è¾¾ã€èŠ‚ç‚¹çš„ä¸»ä»çŠ¶æ€ã€æ§½çš„åˆ†å¸ƒâ€¦â€¦

èŠ‚ç‚¹ä¸ºäº†å­˜å‚¨é›†ç¾¤çŠ¶æ€è€Œæä¾›çš„æ•°æ®ç»“æ„ä¸­ï¼Œæœ€å…³é”®çš„æ˜¯ `clusterNode` å’Œ `clusterState` ç»“æ„ï¼šå‰è€…è®°å½•äº†ä¸€ä¸ªèŠ‚ç‚¹çš„çŠ¶æ€ï¼Œåè€…è®°å½•äº†é›†ç¾¤ä½œä¸ºä¸€ä¸ªæ•´ä½“çš„çŠ¶æ€ã€‚

**clusterNode ç»“æ„**

`clusterNode` ç»“æ„ä¿å­˜äº† **ä¸€ä¸ªèŠ‚ç‚¹çš„å½“å‰çŠ¶æ€**ï¼ŒåŒ…æ‹¬åˆ›å»ºæ—¶é—´ã€èŠ‚ç‚¹ idã€ip å’Œç«¯å£å·ç­‰ã€‚æ¯ä¸ªèŠ‚ç‚¹éƒ½ä¼šç”¨ä¸€ä¸ª `clusterNode` ç»“æ„è®°å½•è‡ªå·±çš„çŠ¶æ€ï¼Œå¹¶ä¸ºé›†ç¾¤å†…æ‰€æœ‰å…¶ä»–èŠ‚ç‚¹éƒ½åˆ›å»ºä¸€ä¸ª `clusterNode` ç»“æ„æ¥è®°å½•èŠ‚ç‚¹çŠ¶æ€ã€‚

ä¸‹é¢åˆ—ä¸¾äº† `clusterNode` çš„éƒ¨åˆ†å­—æ®µï¼Œå¹¶è¯´æ˜äº†å­—æ®µçš„å«ä¹‰å’Œä½œç”¨ï¼š

```c
typedef struct clusterNode {
    //èŠ‚ç‚¹åˆ›å»ºæ—¶é—´
    mstime_t ctime;
    //èŠ‚ç‚¹id
    char name[REDIS_CLUSTER_NAMELEN];
    //èŠ‚ç‚¹çš„ipå’Œç«¯å£å·
    char ip[REDIS_IP_STR_LEN];
    int port;
    //èŠ‚ç‚¹æ ‡è¯†ï¼šæ•´å‹ï¼Œæ¯ä¸ªbitéƒ½ä»£è¡¨äº†ä¸åŒçŠ¶æ€ï¼Œå¦‚èŠ‚ç‚¹çš„ä¸»ä»çŠ¶æ€ã€æ˜¯å¦åœ¨çº¿ã€æ˜¯å¦åœ¨æ¡æ‰‹ç­‰
    int flags;
    //é…ç½®çºªå…ƒï¼šæ•…éšœè½¬ç§»æ—¶èµ·ä½œç”¨ï¼Œç±»ä¼¼äºå“¨å…µçš„é…ç½®çºªå…ƒ
    uint64_t configEpoch;
    //æ§½åœ¨è¯¥èŠ‚ç‚¹ä¸­çš„åˆ†å¸ƒï¼šå ç”¨16384/8ä¸ªå­—èŠ‚ï¼Œ16384ä¸ªæ¯”ç‰¹ï¼›æ¯ä¸ªæ¯”ç‰¹å¯¹åº”ä¸€ä¸ªæ§½ï¼šæ¯”ç‰¹å€¼ä¸º1ï¼Œåˆ™è¯¥æ¯”ç‰¹å¯¹åº”çš„æ§½åœ¨èŠ‚ç‚¹ä¸­ï¼›æ¯”ç‰¹å€¼ä¸º0ï¼Œåˆ™è¯¥æ¯”ç‰¹å¯¹åº”çš„æ§½ä¸åœ¨èŠ‚ç‚¹ä¸­
    unsigned char slots[16384/8];
    //èŠ‚ç‚¹ä¸­æ§½çš„æ•°é‡
    int numslots;
    â€¦â€¦â€¦â€¦
} clusterNode;
```

é™¤äº†ä¸Šè¿°å­—æ®µï¼Œ`clusterNode` è¿˜åŒ…å«èŠ‚ç‚¹è¿æ¥ã€ä¸»ä»å¤åˆ¶ã€æ•…éšœå‘ç°å’Œè½¬ç§»éœ€è¦çš„ä¿¡æ¯ç­‰ã€‚

**clusterState ç»“æ„**

`clusterState` ç»“æ„ä¿å­˜äº†åœ¨å½“å‰èŠ‚ç‚¹è§†è§’ä¸‹ï¼Œé›†ç¾¤æ‰€å¤„çš„çŠ¶æ€ã€‚ä¸»è¦å­—æ®µåŒ…æ‹¬ï¼š

```c
typedef struct clusterState {
    //è‡ªèº«èŠ‚ç‚¹
    clusterNode *myself;
    //é…ç½®çºªå…ƒ
    uint64_t currentEpoch;
    //é›†ç¾¤çŠ¶æ€ï¼šåœ¨çº¿è¿˜æ˜¯ä¸‹çº¿
    int state;
    //é›†ç¾¤ä¸­è‡³å°‘åŒ…å«ä¸€ä¸ªæ§½çš„èŠ‚ç‚¹æ•°é‡
    int size;
    //å“ˆå¸Œè¡¨ï¼ŒèŠ‚ç‚¹åç§°->clusterNodeèŠ‚ç‚¹æŒ‡é’ˆ
    dict *nodes;
    //æ§½åˆ†å¸ƒä¿¡æ¯ï¼šæ•°ç»„çš„æ¯ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€ä¸ªæŒ‡å‘clusterNodeç»“æ„çš„æŒ‡é’ˆï¼›å¦‚æœæ§½è¿˜æ²¡æœ‰åˆ†é…ç»™ä»»ä½•èŠ‚ç‚¹ï¼Œåˆ™ä¸ºNULL
    clusterNode *slots[16384];
    â€¦â€¦â€¦â€¦
} clusterState;
```

é™¤æ­¤ä¹‹å¤–ï¼Œ`clusterState` è¿˜åŒ…æ‹¬æ•…éšœè½¬ç§»ã€æ§½è¿ç§»ç­‰éœ€è¦çš„ä¿¡æ¯ã€‚



### ğŸ¯ Redisé›†ç¾¤æœ€å¤§èŠ‚ç‚¹ä¸ªæ•°æ˜¯å¤šå°‘ï¼Ÿ

16384



### ğŸ¯ Redisé›†ç¾¤ä¼šæœ‰å†™æ“ä½œä¸¢å¤±å—ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ

Rediså¹¶ä¸èƒ½ä¿è¯æ•°æ®çš„å¼ºä¸€è‡´æ€§ï¼Œè¿™æ„å‘³è¿™åœ¨å®é™…ä¸­é›†ç¾¤åœ¨ç‰¹å®šçš„æ¡ä»¶ä¸‹å¯èƒ½ä¼šä¸¢å¤±å†™æ“ä½œã€‚



### ğŸ¯ Redisé›†ç¾¤ä¹‹é—´æ˜¯å¦‚ä½•å¤åˆ¶çš„ï¼Ÿ

Redisé›†ç¾¤ä½¿ç”¨å¼‚æ­¥å¤åˆ¶æœºåˆ¶åœ¨ä¸»ä»èŠ‚ç‚¹ä¹‹é—´è¿›è¡Œæ•°æ®å¤åˆ¶ã€‚ä»¥ä¸‹æ˜¯Redisé›†ç¾¤å¤åˆ¶çš„å…³é”®ç‚¹å’Œå·¥ä½œåŸç†ï¼š

**ä¸»ä»å¤åˆ¶**

1. **ä¸»èŠ‚ç‚¹ï¼ˆMasterï¼‰å’Œä»èŠ‚ç‚¹ï¼ˆSlaveï¼‰**ï¼š
   - æ¯ä¸ªä¸»èŠ‚ç‚¹è´Ÿè´£å¤„ç†ç‰¹å®šçš„æ§½ï¼ˆslotsï¼‰èŒƒå›´ï¼Œå¹¶å¯ä»¥æœ‰å¤šä¸ªä»èŠ‚ç‚¹ã€‚
   - ä»èŠ‚ç‚¹é€šè¿‡å¤åˆ¶ä¸»èŠ‚ç‚¹çš„æ•°æ®æ¥ä¿æŒåŒæ­¥ï¼Œå¹¶åœ¨ä¸»èŠ‚ç‚¹ä¸å¯ç”¨æ—¶è‡ªåŠ¨æå‡ä¸ºæ–°çš„ä¸»èŠ‚ç‚¹ã€‚
2. **å¼‚æ­¥å¤åˆ¶**ï¼š
   - ä¸»èŠ‚ç‚¹ä¼šå°†å†™æ“ä½œå‘½ä»¤å¼‚æ­¥å‘é€ç»™ä»èŠ‚ç‚¹ï¼Œä»èŠ‚ç‚¹å¼‚æ­¥æ¥æ”¶å¹¶æ‰§è¡Œè¿™äº›å‘½ä»¤ã€‚
   - ç”±äºæ˜¯å¼‚æ­¥å¤åˆ¶ï¼Œä¸»èŠ‚ç‚¹ä¸ä¼šç­‰å¾…ä»èŠ‚ç‚¹ç¡®è®¤å†™æ“ä½œå·²ç»å®Œæˆï¼Œè¿™æé«˜äº†æ€§èƒ½ï¼Œä½†ä¹Ÿå¯èƒ½å¯¼è‡´æ•°æ®åœ¨çŸ­æ—¶é—´å†…ä¸ä¸€è‡´ã€‚

**å¤åˆ¶è¿‡ç¨‹**

1. **åˆæ¬¡åŒæ­¥ï¼ˆInitial Synchronizationï¼‰**ï¼š
   - å½“ä¸€ä¸ªä»èŠ‚ç‚¹ç¬¬ä¸€æ¬¡è¿æ¥åˆ°ä¸»èŠ‚ç‚¹æ—¶ï¼Œä¼šè¿›è¡Œå…¨é‡å¤åˆ¶ã€‚
   - ä¸»èŠ‚ç‚¹ä¼šç”Ÿæˆä¸€ä¸ª RDB å¿«ç…§æ–‡ä»¶ï¼Œå¹¶å°†å…¶å‘é€ç»™ä»èŠ‚ç‚¹ã€‚
   - åœ¨ RDB æ–‡ä»¶ä¼ è¾“è¿‡ç¨‹ä¸­ï¼Œä¸»èŠ‚ç‚¹ä¼šå°†æ–°çš„å†™æ“ä½œå‘½ä»¤å­˜å‚¨åœ¨ç¼“å†²åŒºä¸­ã€‚
   - RDB æ–‡ä»¶ä¼ è¾“å®Œæˆåï¼Œä¸»èŠ‚ç‚¹ä¼šå°†ç¼“å†²åŒºä¸­çš„å†™æ“ä½œå‘½ä»¤å‘é€ç»™ä»èŠ‚ç‚¹ï¼Œä»èŠ‚ç‚¹æ‰§è¡Œè¿™äº›å‘½ä»¤ä»¥å®Œæˆæ•°æ®åŒæ­¥ã€‚
2. **å¢é‡åŒæ­¥ï¼ˆIncremental Synchronizationï¼‰**ï¼š
   - åœ¨åˆæ¬¡åŒæ­¥ä¹‹åï¼Œä¸»èŠ‚ç‚¹åªä¼šå°†æ–°çš„å†™æ“ä½œå‘½ä»¤å‘é€ç»™ä»èŠ‚ç‚¹ï¼Œä»èŠ‚ç‚¹æ¥æ”¶å¹¶æ‰§è¡Œè¿™äº›å‘½ä»¤ã€‚

**æ•…éšœè½¬ç§»**

1. **æ•…éšœæ£€æµ‹**ï¼š
   - å½“ä¸»èŠ‚ç‚¹ä¸å¯ç”¨æ—¶ï¼Œä»èŠ‚ç‚¹å¯ä»¥é€šè¿‡é€‰ä¸¾ç®—æ³•é€‰ä¸¾ä¸€ä¸ªæ–°çš„ä¸»èŠ‚ç‚¹ã€‚
   - å“¨å…µï¼ˆSentinelï¼‰æˆ– Redis Cluster æœ¬èº«çš„æœºåˆ¶å¯ä»¥å®ç°è‡ªåŠ¨æ•…éšœè½¬ç§»ã€‚
2. **æ•°æ®ä¸€è‡´æ€§**ï¼š
   - Redis ä½¿ç”¨â€œæœ€ç»ˆä¸€è‡´æ€§â€æ¨¡å‹ï¼Œè™½ç„¶å¤åˆ¶æ˜¯å¼‚æ­¥çš„ï¼Œä½†æœ€ç»ˆæ‰€æœ‰èŠ‚ç‚¹çš„æ•°æ®ä¼šä¸€è‡´ã€‚

**é›†ç¾¤é€šä¿¡åè®®**

1. **Gossip åè®®**ï¼š
   - Redis Cluster èŠ‚ç‚¹ä¹‹é—´ä½¿ç”¨ Gossip åè®®è¿›è¡Œé€šä¿¡ï¼Œä»¥ä¼ æ’­èŠ‚ç‚¹çŠ¶æ€å’Œæ§½åˆ†é…ä¿¡æ¯ã€‚
   - æ¯ä¸ªèŠ‚ç‚¹ä¼šå®šæœŸå‘å…¶ä»–èŠ‚ç‚¹å‘é€æ¶ˆæ¯ï¼Œä»¥åˆ†äº«è‡ªèº«çš„çŠ¶æ€å’Œæ¥æ”¶åˆ°çš„å…¶ä»–èŠ‚ç‚¹çš„çŠ¶æ€ä¿¡æ¯ã€‚
2. **å¤åˆ¶åç§»é‡å’Œ ACK**ï¼š
   - ä¸»èŠ‚ç‚¹ä¼šç»´æŠ¤ä¸€ä¸ªå…¨å±€å¤åˆ¶åç§»é‡ï¼Œå¹¶å°†å…¶å‘é€ç»™ä»èŠ‚ç‚¹ã€‚
   - ä»èŠ‚ç‚¹ä¼šå®šæœŸå‘ä¸»èŠ‚ç‚¹å‘é€ ACK æ¶ˆæ¯ï¼Œå‘ŠçŸ¥ä¸»èŠ‚ç‚¹å®ƒä»¬å·²ç»æ¥æ”¶åˆ°çš„æ•°æ®åç§»é‡ã€‚



### ğŸ¯ Redisæ˜¯å•çº¿ç¨‹çš„ï¼Œå¦‚ä½•æé«˜å¤šæ ¸CPUçš„åˆ©ç”¨ç‡ï¼Ÿ

Redis æ˜¯å•çº¿ç¨‹çš„ï¼Œæ„å‘³ç€å…¶æ ¸å¿ƒåŠŸèƒ½ï¼ˆå¦‚å¤„ç†å‘½ä»¤è¯·æ±‚ã€æ•°æ®å­˜å‚¨å’Œæ£€ç´¢ç­‰ï¼‰ä¸»è¦åœ¨å•ä¸ªçº¿ç¨‹ä¸­æ‰§è¡Œã€‚å°½ç®¡å¦‚æ­¤ï¼ŒRedis è¿˜æ˜¯æœ‰ä¸€äº›æ–¹æ³•å¯ä»¥æé«˜åœ¨å¤šæ ¸ CPU ç³»ç»Ÿä¸Šçš„åˆ©ç”¨ç‡ï¼š

1. **ä½¿ç”¨å¤šä¸ª Redis å®ä¾‹**ï¼š
   - å¯ä»¥åœ¨åŒä¸€ä¸ªæœåŠ¡å™¨ä¸Šè¿è¡Œå¤šä¸ª Redis å®ä¾‹ï¼Œæ¯ä¸ªå®ä¾‹ç»‘å®šåˆ°ä¸åŒçš„ CPU æ ¸å¿ƒä¸Šã€‚è¿™ç§æ–¹æ³•å¯ä»¥ä½¿å¾—æ¯ä¸ªæ ¸å¿ƒè¿è¡Œä¸€ä¸ª Redis å®ä¾‹ï¼Œä»è€Œæé«˜ CPU çš„åˆ©ç”¨ç‡ã€‚
2. **åˆ†ç‰‡ï¼ˆShardingï¼‰**ï¼š
   - é€šè¿‡åˆ†ç‰‡å°†æ•°æ®åˆ†å¸ƒåˆ°å¤šä¸ª Redis å®ä¾‹ï¼Œæ¯ä¸ªå®ä¾‹å¯ä»¥è¿è¡Œåœ¨ä¸åŒçš„æœåŠ¡å™¨æˆ–åŒä¸€æœåŠ¡å™¨çš„ä¸åŒæ ¸å¿ƒä¸Šã€‚
3. **Redis é›†ç¾¤**ï¼š
   - ä½¿ç”¨ Redis é›†ç¾¤å¯ä»¥å°†æ•°æ®è‡ªåŠ¨åˆ†åŒºåˆ°å¤šä¸ªèŠ‚ç‚¹ä¸Šã€‚æ¯ä¸ªèŠ‚ç‚¹å¯ä»¥ç‹¬ç«‹è¿è¡Œåœ¨ä¸åŒçš„ CPU æ ¸å¿ƒä¸Šã€‚
4. **åå°ä»»åŠ¡**ï¼š
   - Redis çš„ä¸€äº›ä»»åŠ¡ï¼Œå¦‚æŒä¹…åŒ–ï¼ˆRDB å¿«ç…§å’Œ AOF æ—¥å¿—å†™å…¥ï¼‰ã€è¿‡æœŸé”®çš„æ¸…ç†ç­‰ï¼Œå¯ä»¥åœ¨åå°çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œä¸é˜»å¡ä¸»çº¿ç¨‹ã€‚
5. **ä½¿ç”¨å¤šçº¿ç¨‹ I/O**ï¼š
   - ä» Redis 6.0 å¼€å§‹ï¼Œå¼•å…¥äº†å¤šçº¿ç¨‹ I/O æ¥æé«˜ç½‘ç»œé€šä¿¡çš„æ•ˆç‡ã€‚è™½ç„¶æ ¸å¿ƒå‘½ä»¤å¤„ç†ä»ç„¶æ˜¯å•çº¿ç¨‹çš„ï¼Œä½†å¤šçº¿ç¨‹ I/O å¯ä»¥æ˜¾è‘—æé«˜ç½‘ç»œæ•°æ®çš„è¯»å†™é€Ÿåº¦ã€‚



### ğŸ¯ ä¸ºä»€ä¹ˆè¦åšRedisåˆ†åŒºï¼Ÿ

åˆ†åŒºå¯ä»¥è®©Redisç®¡ç†æ›´å¤§çš„å†…å­˜ï¼ŒRediså°†å¯ä»¥ä½¿ç”¨æ‰€æœ‰æœºå™¨çš„å†…å­˜ã€‚å¦‚æœæ²¡æœ‰åˆ†åŒºï¼Œä½ æœ€å¤šåªèƒ½ä½¿ç”¨ä¸€å°æœºå™¨çš„å†…å­˜ã€‚åˆ†åŒºä½¿Redisçš„è®¡ç®—èƒ½åŠ›é€šè¿‡ç®€å•åœ°å¢åŠ è®¡ç®—æœºå¾—åˆ°æˆå€æå‡ï¼ŒRedisçš„ç½‘ç»œå¸¦å®½ä¹Ÿä¼šéšç€è®¡ç®—æœºå’Œç½‘å¡çš„å¢åŠ è€Œæˆå€å¢é•¿ã€‚



### ğŸ¯ æœ‰å“ªäº›Redisåˆ†åŒºå®ç°æ–¹æ¡ˆï¼Ÿ

1. å®¢æˆ·ç«¯åˆ†åŒºï¼šå®¢æˆ·ç«¯é€šè¿‡å“ˆå¸Œç®—æ³•ï¼ˆå¦‚å“ˆå¸Œå–æ¨¡ã€ä¸€è‡´æ€§å“ˆå¸Œï¼‰è®¡ç®—æ•°æ®çš„å­˜å‚¨èŠ‚ç‚¹ï¼Œç›´æ¥ä¸ç›®æ ‡èŠ‚ç‚¹é€šä¿¡ï¼Œæ— éœ€ä¸­é—´ä»£ç†ã€‚

2. **æœåŠ¡ç«¯åˆ†åŒº**ï¼š

   - Redis è‡ªèº«æä¾›åˆ†åŒºèƒ½åŠ›ï¼ŒèŠ‚ç‚¹é€šè¿‡é›†ç¾¤åè®®ï¼ˆå¦‚ Redis Clusterï¼‰è‡ªåŠ¨ç®¡ç†æ•°æ®åˆ†å¸ƒï¼Œå®¢æˆ·ç«¯åªéœ€è¿æ¥ä»»æ„èŠ‚ç‚¹ï¼Œç”±é›†ç¾¤è·¯ç”±è¯·æ±‚åˆ°ç›®æ ‡èŠ‚ç‚¹ã€‚
   - **åŸºäºä»£ç†çš„æœåŠ¡ç«¯åˆ†åŒºï¼ˆå¦‚ Codisï¼‰**ï¼šé€šè¿‡ä¸­é—´ä»¶ï¼ˆå¦‚ Codis Proxyï¼‰æ¥æ”¶å®¢æˆ·ç«¯è¯·æ±‚ï¼Œä»£ç†å±‚ç»´æŠ¤æ§½ä½ä¸èŠ‚ç‚¹çš„æ˜ å°„å…³ç³»ï¼Œå¹¶è·¯ç”±è¯·æ±‚ã€‚

3. **ä»£ç†å±‚åˆ†åŒº**ï¼šé€šè¿‡ç‹¬ç«‹çš„ä»£ç†æœåŠ¡ï¼ˆå¦‚ Twemproxyã€Codisã€Redis Cluster Proxyï¼‰å®ç°åˆ†åŒºé€»è¾‘ï¼Œå®¢æˆ·ç«¯åªéœ€è¿æ¥ä»£ç†ï¼Œç”±ä»£ç†è½¬å‘è¯·æ±‚åˆ°åç«¯ Redis èŠ‚ç‚¹ã€‚

   

### ğŸ¯ Redisåˆ†åŒºæœ‰ä»€ä¹ˆç¼ºç‚¹ï¼Ÿ

1. æ¶‰åŠå¤šä¸ªkeyçš„æ“ä½œé€šå¸¸ä¸ä¼šè¢«æ”¯æŒã€‚ä¾‹å¦‚ä½ ä¸èƒ½å¯¹ä¸¤ä¸ªé›†åˆæ±‚äº¤é›†ï¼Œå› ä¸ºä»–ä»¬å¯èƒ½è¢«å­˜å‚¨åˆ°ä¸åŒçš„Rediså®ä¾‹ï¼ˆå®é™…ä¸Šè¿™ç§æƒ…å†µä¹Ÿæœ‰åŠæ³•ï¼Œä½†æ˜¯ä¸èƒ½ç›´æ¥ä½¿ç”¨äº¤é›†æŒ‡ä»¤ï¼‰ã€‚

2. åŒæ—¶æ“ä½œå¤šä¸ªkey,åˆ™ä¸èƒ½ä½¿ç”¨Redisäº‹åŠ¡.

3. åˆ†åŒºä½¿ç”¨çš„ç²’åº¦æ˜¯keyï¼Œä¸èƒ½ä½¿ç”¨ä¸€ä¸ªéå¸¸é•¿çš„æ’åºkeyå­˜å‚¨ä¸€ä¸ªæ•°æ®é›†

4. å½“ä½¿ç”¨åˆ†åŒºçš„æ—¶å€™ï¼Œæ•°æ®å¤„ç†ä¼šéå¸¸å¤æ‚ï¼Œä¾‹å¦‚ä¸ºäº†å¤‡ä»½ä½ å¿…é¡»ä»ä¸åŒçš„Rediså®ä¾‹å’Œä¸»æœºåŒæ—¶æ”¶é›†RDB / AOFæ–‡ä»¶ã€‚

5. åˆ†åŒºæ—¶åŠ¨æ€æ‰©å®¹æˆ–ç¼©å®¹å¯èƒ½éå¸¸å¤æ‚ã€‚Redisé›†ç¾¤åœ¨è¿è¡Œæ—¶å¢åŠ æˆ–è€…åˆ é™¤RedisèŠ‚ç‚¹ï¼Œèƒ½åšåˆ°æœ€å¤§ç¨‹åº¦å¯¹ç”¨æˆ·é€æ˜åœ°æ•°æ®å†å¹³è¡¡ï¼Œä½†å…¶ä»–ä¸€äº›å®¢æˆ·ç«¯åˆ†åŒºæˆ–è€…ä»£ç†åˆ†åŒºæ–¹æ³•åˆ™ä¸æ”¯æŒè¿™ç§ç‰¹æ€§ã€‚ç„¶è€Œï¼Œæœ‰ä¸€ç§é¢„åˆ†ç‰‡çš„æŠ€æœ¯ä¹Ÿå¯ä»¥è¾ƒå¥½çš„è§£å†³è¿™ä¸ªé—®é¢˜ã€‚



### ğŸ¯ Redis çš„é«˜å¯ç”¨

Redisçš„é«˜å¯ç”¨ï¼Œä¸»è¦é€šè¿‡ä¸»ä»å¤åˆ¶æœºåˆ¶ä»¥åŠSentinelé›†ç¾¤æ¥å®ç°ã€‚

1. ä¸»ä»å¤åˆ¶ åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼Œé¦–å…ˆï¼Œå½“ä»æœåŠ¡å™¨å‘èµ·SYNCå‘½ä»¤åï¼Œä¸»æœåŠ¡å™¨ä¼šç”Ÿæˆæœ€æ–°çš„RDBæ–‡ä»¶å‘é€ç»™ä»æœåŠ¡å™¨ï¼Œå¹¶ä½¿ç”¨ä¸€ä¸ªç¼“å†²åŒºæ¥è®°å½•ä»æ­¤åˆ»å¼€å§‹ä¸»æœåŠ¡å™¨æ‰§è¡Œçš„æ‰€æœ‰å†™å‘½ä»¤ï¼›å¾…RDBæ–‡ä»¶ä¼ è¾“å®Œä¹‹åï¼Œå†å°†è¯¥ç¼“å†²åŒºçš„æ•°æ®å†å‘é€ç»™ä»æœåŠ¡å™¨ï¼Œè¿™æ ·å°±å®Œæˆäº†å¤åˆ¶ã€‚æ—§çš„Redisç‰ˆæœ¬æœ‰ä¸ªç¼ºé™·æ˜¯ï¼Œå¦‚æœåœ¨ç¬¬äºŒä¸ªé˜¶æ®µå‘ç”Ÿå¤±è´¥ï¼Œéœ€è¦ä»ç¬¬ä¸€ä¸ªé˜¶æ®µé‡æ–°å¼€å§‹åŒæ­¥ï¼Œè€Œè¿™ä¸ªé˜¶æ®µçš„æ“ä½œä¼šæ¶ˆè€—å¤§é‡çš„CPUã€å†…å­˜å’Œç£ç›˜I/Oä»¥åŠç½‘ç»œå¸¦å®½èµ„æºï¼Œå¤ªè¿‡è€—è´¹èµ„æºã€‚æ‰€ä»¥ä»2.8ç‰ˆæœ¬å¼€å§‹ï¼Œå®ç°äº†éƒ¨åˆ†é‡åŒæ­¥ï¼Œé€šè¿‡ä¸»ä»æœåŠ¡å™¨å„ç»´æŠ¤ä¸€ä¸ªå¤åˆ¶åç§»é‡æ¥å®ç°ã€‚
2. Sentinel ç”±ä¸€ä¸ªæˆ–å¤šä¸ªSentinelå®ä¾‹ç»„æˆçš„å“¨å…µç³»ç»Ÿï¼Œå¯ä»¥ç›‘è§†ä»»æ„å¤šä¸ªä¸»ä»æœåŠ¡å™¨ï¼Œå¹¶å®ŒæˆFailoverçš„æ“ä½œã€‚Sentinalå…¶å®æ˜¯ä¸€ä¸ªè¿è¡Œåœ¨ç‰¹æ®Šæ¨¡å¼ä¸‹çš„RedisæœåŠ¡å™¨ï¼Œè¿è¡ŒæœŸé—´ï¼Œä¼šä¸å„æœåŠ¡å™¨å»ºç«‹ç½‘ç»œè¿æ¥ï¼Œä»¥æ£€æµ‹æœåŠ¡å™¨çš„çŠ¶æ€ï¼›åŒæ—¶ä¼šä¸å…¶å®ƒSentinelæœåŠ¡å™¨åˆ›å»ºè¿æ¥ï¼Œå®Œæˆä¿¡æ¯äº¤æ¢ï¼Œæ¯”å¦‚å‘ç°æŸä¸ªä¸»æœåŠ¡å™¨å¿ƒè·³å¼‚å¸¸æ—¶ï¼Œä¼šäº’ç›¸è¯¢é—®å¿ƒè·³ç»“æœï¼Œå½“è¶…è¿‡ä¸€å®šæ•°é‡æ—¶å³å¯åˆ¤å®šä¸ºå®¢è§‚ä¸‹çº¿ï¼›ä¸€æ—¦ä¸»æœåŠ¡å™¨è¢«åˆ¤å®šä¸ºå®¢è§‚ä¸‹çº¿çŠ¶æ€ï¼Œé‚£ä¹ˆSentinelé›†ç¾¤ä¼šé€šè¿‡raftåè®®é€‰ä¸¾ï¼Œé€‰å‡ºä¸€ä¸ªLeaderæ¥æ‰§è¡ŒFailoverã€‚
3. Failover ä¸€èˆ¬æ¥è¯´ï¼Œä¼šå…ˆé€‰å‡ºä¼˜å…ˆçº§æœ€é«˜çš„ä»æœåŠ¡å™¨ï¼Œç„¶åå†ä»ä¸­é€‰å‡ºå¤åˆ¶åç§»é‡æœ€å¤§çš„å®ä¾‹ï¼Œä½œä¸ºæ–°çš„ä¸»æœåŠ¡å™¨ï¼›æœ€åå°†å…¶å®ƒä»å’Œæ—§çš„ä¸»éƒ½åˆ‡æ¢ä¸ºæ–°ä¸»çš„ä»ã€‚

å½“ä»æœåŠ¡å™¨æœ‰2ä¸ªæˆ–è€…å¤šä¸ªæ—¶ï¼ŒRedisçš„ä¸»ä»æ¶æ„å¯ä»¥æœ‰ä¸¤ç§å½¢å¼ã€‚ä¸€ç§æ˜¯ï¼Œæ‰€æœ‰çš„ä»æœåŠ¡å™¨ç›´æ¥æŒ‚åœ¨ä¸»æœåŠ¡å™¨ä¸Šï¼Œè¿™ç§æ¨¡å¼çš„ä¼˜ç‚¹æ˜¯ï¼Œæ‰€æœ‰ä»æœåŠ¡å™¨å¤åˆ¶çš„å»¶è¿Ÿç›¸å¯¹è¾ƒä½ï¼Œè€Œç¼ºç‚¹åœ¨äºåŠ å¤§äº†ä¸»æœåŠ¡å™¨çš„å¤åˆ¶å‹åŠ›ï¼›å¦ä¸€ç§å½¢å¼ï¼Œæ˜¯é‡‡ç”¨çº§è”çš„æ–¹å¼ï¼ŒS1ä»Må¤åˆ¶ï¼ŒS2ä»S1å¤åˆ¶ï¼Œä»¥æ­¤ç±»æ¨ï¼Œè¿™ç§æ¨¡å¼çš„ä¼˜ç‚¹æ˜¯ï¼Œå°†ä¸»æœåŠ¡å™¨çš„å¤åˆ¶å‹åŠ›åˆ†æ‘Šåˆ°å¤šä¸ªæœåŠ¡å™¨ä¸Šï¼Œè€Œç¼ºç‚¹åœ¨äºè¶Šå¤„äºçº§è”ä¸‹æ¸¸çš„ä»å®ä¾‹ï¼Œå¤åˆ¶å»¶è¿Ÿå°±è¶Šå¤§ã€‚

ä»ä¸»ä»å¤åˆ¶æ¨¡å¼å¯ä»¥çœ‹å‡ºï¼ŒRedisçš„æ•°æ®åªèƒ½ä¿è¯æœ€ç»ˆä¸€è‡´ï¼Œä¸èƒ½ä¿è¯å¼ºä¸€è‡´æ€§ã€‚



### ğŸ¯ CAP ç†è®ºå¯¹ Redis é€‰å‹çš„å½±å“ï¼Ÿ

- CAP è½åˆ° Redis çš„é€‰å‹ï¼šå•æœºä¸è°ˆ CAPï¼›ä¸€æ—¦ä¸»ä»/å“¨å…µ/Clusterï¼Œå°±æ˜¯â€œåœ¨ç½‘ç»œåˆ†åŒºæ—¶è¦åœ¨ C å’Œ A ä¹‹é—´å–èˆâ€ã€‚Redis é»˜è®¤å APï¼ˆé«˜å¯ç”¨+åˆ†åŒºå®¹é”™ï¼Œç‰ºç‰²å¼ºä¸€è‡´ï¼‰ï¼Œé€šè¿‡å‚æ•°å¯å¾€ C ä¾§æ‹‰ï¼Œä½†ä¼šæ‰å¯ç”¨æ€§å’Œæ—¶å»¶ã€‚

- é¢è¯•å…³é”®è¯ï¼šå¼‚æ­¥å¤åˆ¶ï¼ˆæœ€ç»ˆä¸€è‡´/å¯èƒ½ä¸¢å†™ï¼‰ã€WAIT åŠåŒæ­¥ã€min-replicas-to-writeã€cluster-require-full-coverageã€åªè¯»ä»/å¼ºè¯»ä¸»ã€å¹‚ç­‰ä¸è¡¥å¿ã€‚

**åˆ†åœºæ™¯æ€ä¹ˆé€‰ï¼ˆç›´ç»™å¯è½åœ°ç»“è®ºï¼‰**

- å•æœºï¼ˆéåˆ†å¸ƒå¼ï¼‰ï¼šä¸æ¶‰åŠ CAPã€‚å¼ºä¸€è‡´=å¼ºå¯ç”¨ä¸å¯ç”¨ï¼Ÿå•ç‚¹æ•…éšœAå·®ã€‚é€‚åˆç¼“å­˜/éå…³é”®å†™ã€‚

- ä¸»ä» + å“¨å…µï¼š

  - é»˜è®¤ APï¼šå¤åˆ¶å¼‚æ­¥ï¼Œä¸»æŒ‚+é€‰ä¸»å¯èƒ½ä¸¢æœ€è¿‘å†™ï¼›è¯»ä»ä¸ºæœ€ç»ˆä¸€è‡´ã€‚

  - å¾€ C æ‹‰çš„æ‰‹æ®µï¼š

    - åªè¯»ä¸»ï¼ˆå¼ºè¯»ï¼‰ï¼Œä»åªåšè¯»ç¼“å­˜/éå…³é”®è¯»ï¼›

    - å†™å WAIT N T è¦æ±‚ N ä¸ªå‰¯æœ¬ ackï¼ˆåŠåŒæ­¥ï¼‰ï¼Œæå‡ Cï¼Œç‰ºç‰² A å’Œæ—¶å»¶ï¼›

    - min-replicas-to-write + min-replicas-max-lagï¼Œå‰¯æœ¬ä¸è¶³æˆ–è½åå¤§æ—¶æ‹’å†™ï¼Œä¿ C é™ Aã€‚

- Redis Clusterï¼š

  - CAP å¯è°ƒï¼š

    - cluster-require-full-coverage yesï¼ˆå Cï¼‰ï¼šæœ‰æ§½ä¸å¯ç”¨æ—¶è¿”å› CLUSTERDOWNï¼Œç‰ºç‰² Aï¼›

    - è®¾ noï¼ˆå Aï¼‰ï¼šå¯æœåŠ¡å‰©ä½™æ§½ï¼Œæ•´ä½“å¯ç”¨ä½†ä¸€è‡´æ€§/å®Œæ•´è¦†ç›–é™ä½ï¼›

    - cluster-allow-reads-when-down yes è¿›ä¸€æ­¥å Aï¼ˆè¯»ä¹Ÿæ”¾å¼€ï¼‰ã€‚

  - å¤åˆ¶ä»å¼‚æ­¥ï¼Œfailover ä»å¯èƒ½ä¸¢æœ€è¿‘å†™ï¼›è·¨æ§½å¤šé”®äº‹åŠ¡ä¸å¼ºä¸€è‡´ä¸ä¿è¯ã€‚

- è·¨æœºæˆ¿/å¤šæ´»ï¼š

  - å…¸å‹é€‰ APï¼ˆæœ€ç»ˆä¸€è‡´ï¼‰ï¼šä¸šåŠ¡ä¾§å¹‚ç­‰/è¡¥å¿/å¯¹è´¦ï¼›æˆ–ç”¨ Redis Enterprise Active-Activeï¼ˆCRDTï¼‰åšå†²çªæ”¶æ•›ã€‚

  - è¦å¼ºä¸€è‡´å»ºè®®ç”¨ Raft/etcd/DBï¼Œè€Œä¸æ˜¯æŠŠ Redis ç¡¬æ‹—æˆ CPã€‚

**æ ¸å¿ƒå–èˆä¸å‚æ•°**

- æå‡ä¸€è‡´æ€§ï¼ˆå‘ C é æ‹¢ï¼‰ï¼š

  - å†™å WAIT N Tï¼›å¼ºè¯»ä¸»ï¼›ç¦è¯»ä»ï¼›min-replicas-to-writeã€min-replicas-max-lagï¼›

  - Cluster å¼€ cluster-require-full-coverage yesï¼›

  - ä»£ä»·ï¼šæ›´é«˜ RTã€æ›´ä½å¯ç”¨æ€§ï¼ˆåˆ†åŒº/å‰¯æœ¬ä¸è¶³æ—¶æ‹’å†™/æŠ¥é”™ï¼‰ã€‚

- æå‡å¯ç”¨ï¼ˆå‘ A é æ‹¢ï¼‰ï¼š

  - å…è®¸è¯»ä»ï¼›Cluster è®¾ full-coverage noã€allow-reads-when-down yesï¼›

  - ä»£ä»·ï¼šè¯»åˆ°æ—§å€¼/å†™ä¸¢å¤±çª—å£æ‰©å¤§ï¼Œé å¹‚ç­‰ä¸è¡¥å¿å…œåº•ã€‚

**å…¸å‹åº”ç”¨å»ºè®®**

- ç¼“å­˜/ä¼šè¯/æ’è¡Œæ¦œï¼šé€‰ APï¼Œæ¥å—æœ€ç»ˆä¸€è‡´ï¼›TTL+é€»è¾‘è¿‡æœŸ+å¹‚ç­‰åˆ·æ–°ã€‚

- è´­ç‰©è½¦/åº“å­˜å±•ç¤ºï¼šè¯»ä»å¯æ¥å—ï¼Œå†™èµ°ä¸»ï¼Œå¿…è¦æ—¶ WAIT 1 å®¹é”™ã€‚

- è®¢å•/æ‰£æ¬¾/è´¦åŠ¡ï¼šRedis ä¸åšçœŸæºï¼Œè½åº“ä¸ºå‡†ï¼›è‹¥å¿…é¡»ç”¨ï¼Œå¼ºè¯»ä¸»+WAIT+å¹‚ç­‰ä¸å¯¹è´¦ï¼Œæˆ–ç›´æ¥ç”¨ CP ç³»ç»Ÿã€‚

**æ•…éšœä¸é˜²å¾¡**

- ä¸»ä»å¼‚æ­¥å¤åˆ¶å¯¼è‡´â€œä¸»æŒ‚+å›åˆ‡ä¸¢å†™â€ï¼šé™ä½ down-after-millisecondsã€è®¾ç½® min-replicas-to-writeã€å…³é”®å†™ç”¨ WAITã€‚

- Cluster æ§½ç¼ºå¤±æŠ¥é”™ä¸å¯ç”¨æ€§ï¼šæŒ‰ä¸šåŠ¡å†³å®š full-coverageï¼Œå¼ºä¸€è‡´ä¼˜å…ˆå°±å®å¯æŠ¥é”™ä¸è„å†™ã€‚

ä¸€å¥è¯æ€»ç»“ï¼šRedis åˆ†å¸ƒå¼å½¢æ€ä¸‹å¤©ç”Ÿæ›´å APï¼›èƒ½é€šè¿‡ WAITã€å‰¯æœ¬æ»åé˜ˆå€¼ã€Cluster è¦†ç›–ç­–ç•¥æŠŠâ€œC/Aæ—‹é’®â€å¾€ä»»ä¸€ä¾§æ‹§ï¼Œä½†ä»£ä»·æ˜¯æ—¶å»¶æˆ–å¯ç”¨æ€§ã€‚å¼ºä¸€è‡´äº¤æ˜“åœºæ™¯æ…ç”¨ Redis åšä¸»å­˜ã€‚



### ğŸ¯ Redisçš„æ‰©å±•æ€§

è¯»æ‰©å±•ï¼ŒåŸºäºä¸»ä»æ¶æ„ï¼Œå¯ä»¥å¾ˆå¥½çš„å¹³è¡Œæ‰©å±•è¯»çš„èƒ½åŠ›ã€‚å†™æ‰©å±•ï¼Œä¸»è¦å—é™äºä¸»æœåŠ¡å™¨çš„ç¡¬ä»¶èµ„æºçš„é™åˆ¶ï¼Œä¸€æ˜¯å•ä¸ªå®ä¾‹å†…å­˜å®¹é‡å—é™ï¼ŒäºŒæ˜¯ä¸€ä¸ªå®ä¾‹åªä½¿ç”¨åˆ°CPUä¸€ä¸ªæ ¸ã€‚ä¸‹é¢è®¨è®ºåŸºäºå¤šå¥—ä¸»ä»æ¶æ„Rediså®ä¾‹çš„é›†ç¾¤å®ç°ï¼Œç›®å‰ä¸»è¦æœ‰ä»¥ä¸‹å‡ ç§æ–¹æ¡ˆï¼š

1. å®¢æˆ·ç«¯åˆ†ç‰‡ å®ç°æ–¹æ¡ˆï¼Œä¸šåŠ¡è¿›ç¨‹é€šè¿‡å¯¹keyè¿›è¡Œhashæ¥åˆ†ç‰‡ï¼Œç”¨Sentinelåšfailoverã€‚ä¼˜ç‚¹ï¼šè¿ç»´ç®€å•ï¼Œæ¯ä¸ªå®ä¾‹ç‹¬ç«‹éƒ¨ç½²ï¼›å¯ä½¿ç”¨luaè„šæœ¬ï¼Œä¸šåŠ¡è¿›ç¨‹æ‰§è¡Œçš„keyå‡hashåˆ°åŒä¸€ä¸ªåˆ†ç‰‡å³å¯ï¼›ç¼ºç‚¹ï¼šä¸€æ—¦é‡æ–°åˆ†ç‰‡ï¼Œç”±äºæ•°æ®æ— æ³•è‡ªåŠ¨è¿ç§»ï¼Œéƒ¨åˆ†æ•°æ®éœ€è¦å›æºï¼›
2. Redisé›†ç¾¤ æ˜¯å®˜æ–¹æä¾›çš„åˆ†å¸ƒå¼æ•°æ®åº“æ–¹æ¡ˆï¼Œé€šè¿‡åˆ†ç‰‡å®ç°æ•°æ®å…±äº«ï¼Œå¹¶æä¾›å¤åˆ¶å’Œfailoverã€‚æŒ‰ç…§16384ä¸ªæ§½ä½è¿›è¡Œåˆ†ç‰‡ï¼Œä¸”å®ä¾‹ä¹‹é—´å…±äº«åˆ†ç‰‡è§†å›¾ã€‚ä¼˜ç‚¹ï¼šå½“å‘ç”Ÿé‡æ–°åˆ†ç‰‡æ—¶ï¼Œæ•°æ®å¯ä»¥è‡ªåŠ¨è¿ç§»ï¼›ç¼ºç‚¹ï¼šå®¢æˆ·ç«¯éœ€è¦å‡çº§åˆ°æ”¯æŒé›†ç¾¤åè®®çš„ç‰ˆæœ¬ï¼›å®¢æˆ·ç«¯éœ€è¦æ„ŸçŸ¥åˆ†ç‰‡å®ä¾‹ï¼Œæœ€åçš„æƒ…å†µï¼Œæ¯ä¸ªkeyéœ€è¦ä¸€æ¬¡é‡å®šå‘ï¼›ä¸æ”¯æŒluaè„šæœ¬ï¼›ä¸æ”¯æŒpipelineï¼›
3. Codis æ˜¯ç”±è±Œè±†èšå›¢é˜Ÿå¼€æºçš„ä¸€æ¬¾åˆ†å¸ƒå¼ç»„ä»¶ï¼Œå®ƒå°†åˆ†å¸ƒå¼çš„é€»è¾‘ä»Redisé›†ç¾¤å‰¥ç¦»å‡ºæ¥ï¼Œäº¤ç”±å‡ ä¸ªç»„ä»¶æ¥å®Œæˆï¼Œä¸æ•°æ®çš„è¯»å†™è§£è€¦ã€‚Codis proxyè´Ÿè´£åˆ†ç‰‡å’Œèšåˆï¼Œdashboardä½œä¸ºç®¡ç†åå°ï¼Œzookeeperåšé…ç½®ç®¡ç†ï¼ŒSentinelåšfailoverã€‚ä¼˜ç‚¹ï¼šåº•å±‚é€æ˜ï¼Œå®¢æˆ·ç«¯å…¼å®¹æ€§å¥½ï¼›é‡æ–°åˆ†ç‰‡æ—¶ï¼Œæ•°æ®å¯è‡ªåŠ¨è¿ç§»ï¼›æ”¯æŒpipelineï¼›æ”¯æŒluaè„šæœ¬ï¼Œä¸šåŠ¡è¿›ç¨‹ä¿è¯æ‰§è¡Œçš„keyå‡hashåˆ°åŒä¸€ä¸ªåˆ†ç‰‡å³å¯ï¼›ç¼ºç‚¹ï¼šè¿ç»´è¾ƒä¸ºå¤æ‚ï¼›å¼•å…¥äº†ä¸­é—´å±‚ï¼›



------

## å…­ã€æ€§èƒ½ä¼˜åŒ–ä¸å¼‚å¸¸å¤„ç†

### ğŸ¯ Rediså¸¸è§æ€§èƒ½é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆï¼Ÿ

Redis çš„å¸¸è§æ€§èƒ½é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆåŒ…æ‹¬ä½†ä¸é™äºä»¥ä¸‹å‡ ç‚¹ï¼š

1. **å†…å­˜é—®é¢˜**ï¼š
   - **é—®é¢˜**ï¼šå†…å­˜ä¸è¶³æˆ–å†…å­˜ç¢ç‰‡å¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚
   - **è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨ `MEMORY USAGE` å‘½ä»¤ç›‘æ§å†…å­˜ä½¿ç”¨æƒ…å†µï¼Œä¼˜åŒ–æ•°æ®ç»“æ„ï¼Œåˆç†é…ç½® `maxmemory` å¹¶é€‰æ‹©åˆé€‚çš„å†…å­˜æ·˜æ±°ç­–ç•¥ã€‚
2. **é«˜å¹¶å‘ä¸‹çš„å“åº”å»¶è¿Ÿ**ï¼š
   - **é—®é¢˜**ï¼šåœ¨é«˜å¹¶å‘è®¿é—®æ—¶ï¼Œå“åº”æ—¶é—´å˜é•¿ã€‚
   - **è§£å†³æ–¹æ¡ˆ**ï¼šä¼˜åŒ–å‘½ä»¤ä½¿ç”¨ï¼Œé¿å…ä½¿ç”¨è€—æ—¶çš„å‘½ä»¤ï¼Œä½¿ç”¨ Pipelining æŠ€æœ¯æ‰¹é‡æ‰§è¡Œå‘½ä»¤ï¼Œè€ƒè™‘ä½¿ç”¨ Redis é›†ç¾¤è¿›è¡Œè´Ÿè½½å‡è¡¡ã€‚
3. **æ…¢æŸ¥è¯¢**ï¼š
   - **é—®é¢˜**ï¼šæ‰§è¡Œæ…¢æŸ¥è¯¢å¯¼è‡´é˜»å¡ã€‚
   - **è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨ `slowlog` å‘½ä»¤æ‰¾å‡ºå¹¶ä¼˜åŒ–æ…¢æŸ¥è¯¢ï¼Œç¡®ä¿å•æ¬¡æ“ä½œå°½å¯èƒ½å¿«é€Ÿã€‚
4. **ä¸»ä»å¤åˆ¶å»¶è¿Ÿ**ï¼š
   - **é—®é¢˜**ï¼šä¸»ä»å¤åˆ¶å»¶è¿Ÿå½±å“æ•°æ®çš„å®æ—¶æ€§ã€‚
   - **è§£å†³æ–¹æ¡ˆ**ï¼šä¼˜åŒ–ç½‘ç»œæ¡ä»¶ï¼Œå‡çº§ç¡¬ä»¶ï¼Œä½¿ç”¨æ›´é«˜æ•ˆçš„å¤åˆ¶åè®®å¦‚ PSYNCï¼Œè€ƒè™‘ä½¿ç”¨æ— ç£ç›˜åŒ–å¤åˆ¶å‡å°‘å»¶è¿Ÿã€‚
5. **æŒä¹…åŒ–æ€§èƒ½é—®é¢˜**ï¼š
   - **é—®é¢˜**ï¼šRDB å’Œ AOF æŒä¹…åŒ–å½±å“æ€§èƒ½ã€‚
   - **è§£å†³æ–¹æ¡ˆ**ï¼šåˆç†é…ç½®æŒä¹…åŒ–ç­–ç•¥ï¼Œå¦‚ AOF åˆ·ç›˜ç­–ç•¥ `everysec`ï¼Œæˆ–ä½¿ç”¨ RDB-AOF æ··åˆæŒä¹…åŒ–ã€‚
6. **çƒ­ Key é—®é¢˜**ï¼š
   - **é—®é¢˜**ï¼šæŸäº›é”®è¢«é¢‘ç¹è®¿é—®ï¼Œæˆä¸ºçƒ­ç‚¹ï¼Œå¯èƒ½å¯¼è‡´å•ä¸ªå®ä¾‹è´Ÿè½½è¿‡é«˜ã€‚
   - **è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨æœ¬åœ°ç¼“å­˜å‡è½» Redis è´Ÿæ‹…ï¼Œæˆ–åœ¨å¤šä¸ªå®ä¾‹é—´åˆ†æ•£çƒ­ç‚¹æ•°æ®ã€‚
7. **æ•°æ®ç»“æ„é€‰æ‹©**ï¼š
   - **é—®é¢˜**ï¼šä½¿ç”¨ä¸åˆé€‚çš„æ•°æ®ç»“æ„å¯¼è‡´æ€§èƒ½é—®é¢˜ã€‚
   - **è§£å†³æ–¹æ¡ˆ**ï¼šæ ¹æ®æ•°æ®ç±»å‹å’Œæ“ä½œéœ€æ±‚é€‰æ‹©åˆé€‚çš„æ•°æ®ç»“æ„ï¼Œä¾‹å¦‚ä½¿ç”¨ intset ä»£æ›¿æ™®é€šåˆ—è¡¨å­˜å‚¨æ•´æ•°åˆ—è¡¨ã€‚
8. **è¿æ¥æ•°è¿‡å¤š**ï¼š
   - **é—®é¢˜**ï¼šå¤§é‡å®¢æˆ·ç«¯è¿æ¥å¯èƒ½ä¼šå¯¼è‡´èµ„æºè€—å°½ã€‚
   - **è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨è¿æ¥æ± ã€é™åˆ¶æœ€å¤§å®¢æˆ·ç«¯è¿æ¥æ•°ã€ä¼˜åŒ–å®¢æˆ·ç«¯è¿æ¥ç®¡ç†ã€‚
9. **å•çº¿ç¨‹é˜»å¡**ï¼š
   - **é—®é¢˜**ï¼šç”±äºå•çº¿ç¨‹æ¨¡å‹ï¼Œé˜»å¡æ“ä½œä¼šå½±å“æ€§èƒ½ã€‚
   - **è§£å†³æ–¹æ¡ˆ**ï¼šé¿å…ä½¿ç”¨è€—æ—¶çš„å•ä¸ªå‘½ä»¤ï¼Œå¦‚ `KEYS`ã€`FLUSHALL`ã€`FLUSHDB` ç­‰ï¼Œä½¿ç”¨ `SCAN` æ›¿ä»£ã€‚
10. **ç‰ˆæœ¬é—®é¢˜**ï¼š
    - **é—®é¢˜**ï¼šä½¿ç”¨è¿‡æ—¶çš„ Redis ç‰ˆæœ¬å¯èƒ½ä¼šå¯¼è‡´æ€§èƒ½é—®é¢˜ã€‚
    - **è§£å†³æ–¹æ¡ˆ**ï¼šå‡çº§åˆ°æœ€æ–°ç¨³å®šç‰ˆæœ¬çš„ Redisï¼Œä»¥åˆ©ç”¨æ€§èƒ½æ”¹è¿›å’Œæ–°ç‰¹æ€§ã€‚
11. **ç›‘æ§å’Œå‘Šè­¦**ï¼š
    - **é—®é¢˜**ï¼šç¼ºä¹ç›‘æ§å’Œå‘Šè­¦å¯èƒ½å¯¼è‡´æ€§èƒ½é—®é¢˜è¢«å¿½è§†ã€‚
    - **è§£å†³æ–¹æ¡ˆ**ï¼šå®æ–½ Redis ç›‘æ§ç­–ç•¥ï¼Œä½¿ç”¨å·¥å…·å¦‚ Redis `INFO` å‘½ä»¤ã€`redis-cli` å·¥å…·ç­‰è¿›è¡Œæ€§èƒ½ç›‘æ§å’Œè°ƒä¼˜ã€‚

é’ˆå¯¹ Redis çš„æ€§èƒ½é—®é¢˜ï¼Œè§£å†³æ–¹æ¡ˆé€šå¸¸éœ€è¦æ ¹æ®å…·ä½“çš„ä¸šåŠ¡åœºæ™¯å’Œéœ€æ±‚æ¥å®šåˆ¶ã€‚åœ¨è®¾è®¡å’Œæ„å»ºåº”ç”¨æ—¶ï¼Œåº”è€ƒè™‘åˆ° Redis çš„ç‰¹ç‚¹ï¼Œåˆç†ä½¿ç”¨å…¶æä¾›çš„å„ç§åŠŸèƒ½å’Œå‘½ä»¤ï¼Œä»¥ç¡®ä¿ç³»ç»Ÿçš„é«˜æ€§èƒ½å’Œç¨³å®šæ€§



### ğŸ¯ å¦‚ä½•ä¿è¯ç¼“å­˜ä¸æ•°æ®åº“åŒå†™æ—¶çš„æ•°æ®ä¸€è‡´æ€§ï¼Ÿ

> åœ¨ç¼“å­˜ä¸æ•°æ®åº“åŒå†™æ—¶ï¼Œä¸€è‡´æ€§é—®é¢˜ä¸»è¦å‡ºåœ¨å†™æ“ä½œçš„å¹¶å‘é¡ºåºä¸Šã€‚
>  å®é™…ä¸Šï¼Œæœ€å¸¸è§çš„æ–¹æ¡ˆæ˜¯ **Cache Aside æ¨¡å¼**ï¼šæ›´æ–°æ•°æ®åº“ååˆ é™¤ç¼“å­˜ï¼Œè€Œä¸æ˜¯æ›´æ–°ç¼“å­˜ï¼Œè¿™æ ·èƒ½ä¿è¯ç¼“å­˜ä¸€å®šä¼šä»æ•°æ®åº“å›æºåˆ°æœ€æ–°å€¼ã€‚
>  ä¸ºäº†è¿›ä¸€æ­¥æå‡ä¸€è‡´æ€§ï¼Œå¯ä»¥ç”¨ **å»¶è¿ŸåŒåˆ ç­–ç•¥**ï¼Œæˆ–è€…ç”¨ **æ¶ˆæ¯é˜Ÿåˆ—ã€è®¢é˜… binlog** æ¥ä¿è¯æœ€ç»ˆä¸€è‡´æ€§ã€‚
>  ä¸åŒä¸šåŠ¡åœºæ™¯ä¼šæœ‰ä¸åŒé€‰æ‹©ï¼šå¯¹ä¸€è‡´æ€§è¦æ±‚ç‰¹åˆ«é«˜çš„ï¼Œå¯ä»¥è€ƒè™‘å¼•å…¥ MQ æˆ– Canalï¼›è€Œå¤§éƒ¨åˆ†äº’è”ç½‘åœºæ™¯ä¸‹ï¼Œåˆ é™¤ç¼“å­˜ + å»¶è¿ŸåŒåˆ å°±è¶³å¤Ÿäº†ã€‚

**ğŸ“Š ç¼“å­˜ä¸€è‡´æ€§æ–¹æ¡ˆå¯¹æ¯”**

| æ¨¡å¼                                      | æ ¸å¿ƒæµç¨‹                                                    | ä¸€è‡´æ€§                     | ä¼˜ç‚¹                                    | ç¼ºç‚¹                                             | é€‚ç”¨åœºæ™¯                                   |
| ----------------------------------------- | ----------------------------------------------------------- | -------------------------- | --------------------------------------- | ------------------------------------------------ | ------------------------------------------ |
| **Cache Aside**ï¼ˆæ—è·¯ç¼“å­˜ï¼Œæœ€å¸¸ç”¨ âœ…ï¼‰     | è¯»ï¼šç¼“å­˜ miss â†’ æŸ¥ DB â†’ å›å¡«ç¼“å­˜ï¼›å†™ï¼šå…ˆæ›´æ–° DBï¼Œå†åˆ é™¤ç¼“å­˜ | æœ€ç»ˆä¸€è‡´ï¼ˆå¯èƒ½çŸ­æš‚ä¸ä¸€è‡´ï¼‰ | ç®€å•ã€çµæ´»ã€ä¸šç•Œå¹¿æ³›ä½¿ç”¨                | å†™åå¯èƒ½æœ‰çŸ­æš‚è„è¯»ï¼›é«˜å¹¶å‘ä¸‹å¯èƒ½ç¼“å­˜å›å¡«æ—§å€¼     | ç”µå•†è¯¦æƒ…é¡µã€å•†å“åº“å­˜ã€ç”¨æˆ·ä¿¡æ¯ï¼ˆè¯»å¤šå†™å°‘ï¼‰ |
| **Read/Write Through**ï¼ˆè¯»å†™ç©¿é€ï¼‰        | è¯»ï¼šç¼“å­˜ miss ç”±ç¼“å­˜åŠ è½½ DBï¼›å†™ï¼šå†™ç¼“å­˜ï¼Œç”±ç¼“å­˜å†™ DB        | å¼ºä¸€è‡´ï¼ˆç”±ç¼“å­˜ä»£ç† DBï¼‰    | åº”ç”¨åªä¾èµ–ç¼“å­˜ï¼Œä¸ç›´æ¥è®¿é—® DBï¼Œé€»è¾‘æ¸…æ™° | å®ç°å¤æ‚ï¼Œç¼“å­˜éœ€æ”¯æŒä»£ç†æ•°æ®åº“å†™ï¼ˆRedis ä¸å¸¸ç”¨ï¼‰ | ä¸€äº›åˆ†å¸ƒå¼ KV ç³»ç»Ÿï¼ˆMemcached+proxyï¼‰      |
| **Write Behind / Write Back**ï¼ˆå†™åç¼“å­˜ï¼‰ | å†™ï¼šåªå†™ç¼“å­˜ï¼Œå¼‚æ­¥åˆ· DBï¼›è¯»ï¼šåªè¯»ç¼“å­˜                       | å¼±ä¸€è‡´ï¼ˆDB å»¶è¿Ÿæ›´æ–°ï¼‰      | å†™æ€§èƒ½æé«˜ï¼Œæ”¯æŒæ‰¹é‡å¼‚æ­¥è½åº“            | æ•°æ®åº“å¯èƒ½è½åï¼Œå®•æœºå¯èƒ½ä¸¢æ•°æ®                   | è®¡æ•°å™¨ã€æ—¥å¿—ã€éå¼ºä¸€è‡´æ€§ä¸šåŠ¡               |
| **å»¶è¿ŸåŒåˆ ç­–ç•¥**ï¼ˆCache Aside ä¼˜åŒ–ï¼‰      | æ›´æ–° DB â†’ åˆ é™¤ç¼“å­˜ â†’ å»¶è¿Ÿä¸€æ®µæ—¶é—´åå†åˆ ç¼“å­˜                 | æ›´å¼ºçš„æœ€ç»ˆä¸€è‡´æ€§           | è§£å†³ç¼“å­˜å›å¡«è„æ•°æ®é—®é¢˜                  | éœ€è¦è®¾ç½®åˆç†å»¶è¿Ÿæ—¶é—´ï¼Œå¢åŠ å¤æ‚åº¦                 | é«˜å¹¶å‘åœºæ™¯ä¸‹çš„ Cache Aside åŠ å¼ºç‰ˆ          |
| **MQ å¼‚æ­¥åˆ é™¤ç¼“å­˜**                       | æ›´æ–° DB â†’ å‘ MQ æ¶ˆæ¯ â†’ æ¶ˆè´¹è€…åˆ é™¤ç¼“å­˜                       | é«˜ä¸€è‡´æ€§ï¼ˆä¾èµ– MQï¼‰        | å‰Šå³°å¡«è°·ï¼Œä¿è¯ä¸€è‡´æ€§                    | ä¾èµ– MQï¼Œç³»ç»Ÿå¤æ‚åº¦é«˜                            | é«˜å¹¶å‘æ ¸å¿ƒä¸šåŠ¡ï¼ˆè®¢å•ã€æ”¯ä»˜ï¼‰               |
| **è®¢é˜… Binlogï¼ˆå¦‚ Canalï¼‰**               | DB æ›´æ–° â†’ Binlog â†’ æ¶ˆè´¹å¹¶åˆ é™¤/æ›´æ–°ç¼“å­˜                      | å‡†å®æ—¶ä¸€è‡´æ€§               | æ— éœ€ä¾µå…¥åº”ç”¨ï¼Œè§£è€¦å¥½                    | å»¶è¿Ÿä¾èµ– Binlog æ¶ˆè´¹é€Ÿåº¦                         | ç”µå•†è®¢å•ã€é‡‘èäº¤æ˜“ç­‰å¼ºä¸€è‡´åœºæ™¯             |

> 1. **æ²¡æœ‰é“¶å¼¹æ–¹æ¡ˆ**ï¼šä¸€è‡´æ€§æ–¹æ¡ˆéœ€å¹³è¡¡ä¸šåŠ¡éœ€æ±‚ï¼ˆå¦‚å»¶è¿Ÿå®¹å¿åº¦ã€ååé‡ï¼‰ä¸æŠ€æœ¯æˆæœ¬ï¼ˆå¦‚å¼•å…¥åˆ†å¸ƒå¼é”å¯èƒ½å¢åŠ ç³»ç»Ÿå¤æ‚åº¦ï¼‰ã€‚
> 2. **ç›‘æ§ä¸è¡¥å¿**ï¼š
>    - å¢åŠ ç¼“å­˜ä¸æ•°æ®åº“çš„å¯¹è´¦ç›‘æ§ï¼ˆå¦‚å®šæ—¶ä»»åŠ¡å¯¹æ¯”å…³é”®æ•°æ®ï¼Œæˆ–é€šè¿‡ Canal çš„å¢é‡è®¢é˜…åšå®æ—¶æ ¡éªŒï¼‰ã€‚
>    - å¯¹äºä¸ä¸€è‡´æ•°æ®ï¼Œé€šè¿‡äººå·¥ä»‹å…¥æˆ–è‡ªåŠ¨ä»»åŠ¡ï¼ˆå¦‚ Redis Lua è„šæœ¬æ‰¹é‡ä¿®å¤ï¼‰è¿›è¡Œè¡¥å¿ã€‚



### ğŸ¯ ä½¿ç”¨ç¼“å­˜ä¼šå‡ºç°ä»€ä¹ˆé—®é¢˜ï¼Ÿ

#### ç¼“å­˜é›ªå´©

<mark>ç¼“å­˜é›ªå´©æ˜¯æŒ‡ç¼“å­˜åŒä¸€æ—¶é—´å¤§é¢ç§¯çš„å¤±æ•ˆ</mark>ï¼Œæ‰€ä»¥ï¼Œåé¢çš„è¯·æ±‚éƒ½ä¼šè½åˆ°æ•°æ®åº“ä¸Šï¼Œé€ æˆæ•°æ®åº“çŸ­æ—¶é—´å†…æ‰¿å—å¤§é‡è¯·æ±‚è€Œå´©æ‰ã€‚

**è§£å†³æ–¹æ¡ˆ**

1. ç¼“å­˜æ•°æ®çš„è¿‡æœŸæ—¶é—´è®¾ç½®éšæœºï¼Œé˜²æ­¢åŒä¸€æ—¶é—´å¤§é‡æ•°æ®è¿‡æœŸç°è±¡å‘ç”Ÿã€‚

   > è¿™ä¸ªéšæœºæ—¶é—´ä¹Ÿæ˜¯æœ‰è®²ç©¶çš„ï¼Œæˆ‘ä»¬å‡è®¾è¿‡æœŸæ—¶é—´æ˜¯ 10 åˆ†é’Ÿï¼Œé‚£è¦åœ¨è¿™ä¸ªåŸºç¡€ä¸ŠåŠ ä¸€ä¸ª 0-210å·¦å³ç§’çš„â€œåç§»é‡â€éƒ½å¯ä»¥çš„ï¼Œè¿™ä¸ªåç§»é‡è¦è·Ÿè¿‡æœŸæ—¶é—´æˆæ­£æ¯”ï¼Œä¸èƒ½è¿‡ä½æˆ–è€…è¿‡é«˜

2. ä¸€èˆ¬å¹¶å‘é‡ä¸æ˜¯ç‰¹åˆ«å¤šçš„æ—¶å€™ï¼Œä½¿ç”¨æœ€å¤šçš„è§£å†³æ–¹æ¡ˆæ˜¯åŠ é”æ’é˜Ÿ(keyä¸Šé”ï¼Œå…¶ä»–çº¿ç¨‹ä¸èƒ½è®¿é—®ï¼Œå‡è®¾åœ¨é«˜å¹¶å‘ä¸‹ï¼Œç¼“å­˜é‡å»ºæœŸé—´keyæ˜¯é”ç€çš„ï¼Œè¿™æ˜¯è¿‡æ¥1000ä¸ªè¯·æ±‚999ä¸ªéƒ½åœ¨é˜»å¡çš„ã€‚åŒæ ·ä¼šå¯¼è‡´ç”¨æˆ·ç­‰å¾…è¶…æ—¶ï¼Œè¿™æ˜¯ä¸ªæ²»æ ‡ä¸æ²»æœ¬çš„æ–¹æ³•ï¼)ã€‚

3. ç»™æ¯ä¸€ä¸ªç¼“å­˜æ•°æ®å¢åŠ ç›¸åº”çš„ç¼“å­˜æ ‡è®°ï¼Œè®°å½•ç¼“å­˜çš„æ˜¯å¦å¤±æ•ˆï¼Œå¦‚æœç¼“å­˜æ ‡è®°å¤±æ•ˆï¼Œåˆ™æ›´æ–°æ•°æ®ç¼“å­˜ã€‚

4. è®¾ç½®çƒ­ç‚¹æ•°æ®é™æ€åŒ–ï¼ŒæŠŠè®¿é—®é‡è¾ƒå¤§çš„æ•°æ®åšé™æ€åŒ–å¤„ç†ï¼Œå‡å°‘æ•°æ®åº“çš„è®¿é—®ã€‚

#### ç¼“å­˜ç©¿é€

<mark>ç¼“å­˜ç©¿é€æ˜¯æŒ‡ç¼“å­˜å’Œæ•°æ®åº“ä¸­éƒ½æ²¡æœ‰çš„æ•°æ®</mark>ï¼Œå¯¼è‡´æ‰€æœ‰çš„è¯·æ±‚éƒ½è½åˆ°æ•°æ®åº“ä¸Šï¼Œé€ æˆæ•°æ®åº“çŸ­æ—¶é—´å†…æ‰¿å—å¤§é‡è¯·æ±‚è€Œå´©æ‰ã€‚

**è§£å†³æ–¹æ¡ˆ**

1. æ¥å£å±‚å¢åŠ æ ¡éªŒï¼Œå¦‚ç”¨æˆ·é‰´æƒæ ¡éªŒï¼ŒidåšåŸºç¡€æ ¡éªŒï¼Œid<=0 çš„ç›´æ¥æ‹¦æˆªï¼›

2. **å›å†™ç‰¹æ®Šå€¼**ï¼šä»ç¼“å­˜å–ä¸åˆ°çš„æ•°æ®ï¼Œåœ¨æ•°æ®åº“ä¸­ä¹Ÿæ²¡æœ‰å–åˆ°ï¼Œè¿™æ—¶ä¹Ÿå¯ä»¥å°† key-value å¯¹å†™ä¸º key-nullï¼Œç¼“å­˜æœ‰æ•ˆæ—¶é—´å¯ä»¥è®¾ç½®çŸ­ç‚¹ï¼Œå¦‚ 30 ç§’ï¼ˆè®¾ç½®å¤ªé•¿ä¼šå¯¼è‡´æ­£å¸¸æƒ…å†µä¹Ÿæ²¡æ³•ä½¿ç”¨ï¼‰ã€‚è¿™æ ·å¯ä»¥é˜²æ­¢æ”»å‡»ç”¨æˆ·åå¤ç”¨åŒä¸€ä¸ªidæš´åŠ›æ”»å‡»

   > å¦‚æœæ”»å‡»è€…æ¯æ¬¡éƒ½ç”¨ä¸åŒçš„ä¸”éƒ½ä¸å­˜åœ¨çš„ key æ¥è¯·æ±‚æ•°æ®ï¼Œé‚£ä¹ˆè¿™ç§æªæ–½æ¯«æ—  æ•ˆæœã€‚å¹¶ä¸”ï¼Œå› ä¸ºè¦å›å†™ç‰¹æ®Šå€¼ï¼Œé‚£ä¹ˆè¿™äº›ä¸å­˜åœ¨çš„ key éƒ½ä¼šæœ‰ç‰¹æ®Šå€¼ï¼Œæµªè´¹ äº† Redis çš„å†…å­˜ã€‚è¿™å¯èƒ½ä¼šè¿›ä¸€æ­¥å¼•èµ·å¦å¤–ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯ Redis åœ¨å†…å­˜ä¸ è¶³ï¼Œæ‰§è¡Œæ·˜æ±°çš„æ—¶å€™ï¼ŒæŠŠå…¶ä»–æœ‰ç”¨çš„æ•°æ®æ·˜æ±°æ‰ã€‚

3. é‡‡ç”¨å¸ƒéš†è¿‡æ»¤å™¨ï¼Œå°†æ‰€æœ‰å¯èƒ½å­˜åœ¨çš„æ•°æ®å“ˆå¸Œåˆ°ä¸€ä¸ªè¶³å¤Ÿå¤§çš„ bitmap ä¸­ï¼Œä¸€ä¸ªä¸€å®šä¸å­˜åœ¨çš„æ•°æ®ä¼šè¢«è¿™ä¸ª bitmap æ‹¦æˆªæ‰ï¼Œä»è€Œé¿å…äº†å¯¹åº•å±‚å­˜å‚¨ç³»ç»Ÿçš„æŸ¥è¯¢å‹åŠ›ã€‚

   > ä½†æ˜¯å¸ƒéš†è¿‡æ»¤å™¨æœ¬èº«å­˜åœ¨å‡é˜³æ€§çš„é—®é¢˜ï¼Œæ‰€ä»¥å½“æ”»å‡»è€…è¯·æ±‚ä¸€ä¸ªä¸å­˜åœ¨çš„ key çš„æ—¶å€™ï¼Œå¸ƒéš†è¿‡æ»¤å™¨å¯èƒ½ä¼šè¿”å›æ•°æ®å­˜åœ¨çš„å‡é˜³æ€§å“åº”ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¸šåŠ¡ ä»£ç ä¾æ—§ä¼šå»æŸ¥è¯¢ç¼“å­˜å’Œæ•°æ®åº“ã€‚ä¸è¿‡è¿™ä¸ªä¸éœ€è¦æ‹…å¿ƒï¼Œå› ä¸ºå‡é˜³æ€§çš„æ¦‚ç‡æ˜¯ å¾ˆä½çš„ã€‚å‡å¦‚è¯´å‡é˜³æ€§æ¦‚ç‡æ˜¯ä¸‡åˆ†ä¹‹ä¸€ï¼Œé‚£ä¹ˆå°±ç®—æ”»å‡»çš„å¹¶å‘æœ‰ç™¾ä¸‡ï¼Œä¹Ÿåªæœ‰ 100 ä¸ªæŸ¥è¯¢è¯·æ±‚ä¼šè½åˆ°æ•°æ®åº“ä¸Šï¼Œè¿™ä¸€ç‚¹æŸ¥è¯¢è¯·æ±‚å°±æ˜¯æ¯›æ¯›é›¨äº†ã€‚

#### ç¼“å­˜å‡»ç©¿

> æŸæ˜æ˜Ÿç›´æ’­æ—¶ï¼Œç²‰ä¸åå¤åˆ·æ–°å…¶ä¸»é¡µå¯¼è‡´ç¼“å­˜å‡»ç©¿ï¼Œæ•°æ®åº“å‹åŠ›æ¿€å¢ï¼Œå¦‚ä½•è®¾è®¡å¤šçº§é˜²æŠ¤ç­–ç•¥ï¼Ÿ

<mark>ç¼“å­˜å‡»ç©¿æ˜¯æŒ‡ç¼“å­˜ä¸­æ²¡æœ‰ä½†æ•°æ®åº“ä¸­æœ‰çš„æ•°æ®</mark>ï¼ˆä¸€èˆ¬æ˜¯ç¼“å­˜æ—¶é—´åˆ°æœŸï¼‰ï¼Œè¿™æ—¶ç”±äºå¹¶å‘ç”¨æˆ·ç‰¹åˆ«å¤šï¼ŒåŒæ—¶è¯»ç¼“å­˜æ²¡è¯»åˆ°æ•°æ®ï¼ŒåˆåŒæ—¶å»æ•°æ®åº“å»å–æ•°æ®ï¼Œå¼•èµ·æ•°æ®åº“å‹åŠ›ç¬é—´å¢å¤§ï¼Œé€ æˆè¿‡å¤§å‹åŠ›ã€‚

ç¼“å­˜å‡»ç©¿æ˜¯æŒ‡ä¸€ä¸ª Key éå¸¸çƒ­ç‚¹ï¼Œåœ¨ä¸åœåœ°æ‰›ç€å¤§é‡çš„è¯·æ±‚ï¼Œå¤§å¹¶å‘é›†ä¸­å¯¹è¿™ä¸€ä¸ªç‚¹è¿›è¡Œè®¿é—®ï¼Œå½“è¿™ä¸ª Key åœ¨å¤±æ•ˆçš„ç¬é—´ï¼ŒæŒç»­çš„å¤§å¹¶å‘ç›´æ¥è½åˆ°äº†æ•°æ®åº“ä¸Šï¼Œå°±åœ¨è¿™ä¸ª Key çš„ç‚¹ä¸Šå‡»ç©¿äº†ç¼“å­˜

> **å’Œç¼“å­˜é›ªå´©ä¸åŒçš„æ˜¯ï¼Œç¼“å­˜å‡»ç©¿æŒ‡å¹¶å‘æŸ¥åŒä¸€æ¡æ•°æ®ï¼Œç¼“å­˜é›ªå´©æ˜¯ä¸åŒæ•°æ®éƒ½è¿‡æœŸäº†ï¼Œå¾ˆå¤šæ•°æ®éƒ½æŸ¥ä¸åˆ°ä»è€ŒæŸ¥æ•°æ®åº“ã€‚**

**è§£å†³æ–¹æ¡ˆ**

1. çƒ­ç‚¹æ•°æ®æ°¸è¿œä¸è¿‡æœŸï¼šç‰©ç†ä¸è¿‡æœŸï¼Œä½†é€»è¾‘è¿‡æœŸ(åå°å¼‚æ­¥çº¿ç¨‹å»åˆ·æ–°)

2. ä½¿ç”¨äº’æ–¥é”ï¼šå½“ç¼“å­˜å¤±æ•ˆæ—¶ï¼Œä¸ç«‹å³å» load dbï¼Œå…ˆä½¿ç”¨å¦‚ Redis çš„ setnx å»è®¾ç½®ä¸€ä¸ªäº’æ–¥é”ï¼Œå½“æ“ä½œæˆåŠŸè¿”å›æ—¶å†è¿›è¡Œ load db çš„æ“ä½œå¹¶å›è®¾ç¼“å­˜ï¼Œå¦åˆ™é‡è¯• get ç¼“å­˜çš„æ–¹æ³•

#### ç¼“å­˜é¢„çƒ­

ç¼“å­˜é¢„çƒ­å°±æ˜¯ç³»ç»Ÿä¸Šçº¿åï¼Œå°†ç›¸å…³çš„ç¼“å­˜æ•°æ®ç›´æ¥åŠ è½½åˆ°ç¼“å­˜ç³»ç»Ÿã€‚è¿™æ ·å°±å¯ä»¥é¿å…åœ¨ç”¨æˆ·è¯·æ±‚çš„æ—¶å€™ï¼Œå…ˆæŸ¥è¯¢æ•°æ®åº“ï¼Œç„¶åå†å°†æ•°æ®ç¼“å­˜çš„é—®é¢˜ï¼ç”¨æˆ·ç›´æ¥æŸ¥è¯¢äº‹å…ˆè¢«é¢„çƒ­çš„ç¼“å­˜æ•°æ®ï¼

**è§£å†³æ–¹æ¡ˆ**

1. ç›´æ¥å†™ä¸ªç¼“å­˜åˆ·æ–°é¡µé¢ï¼Œä¸Šçº¿æ—¶æ‰‹å·¥æ“ä½œä¸€ä¸‹ï¼›

2. æ•°æ®é‡ä¸å¤§ï¼Œå¯ä»¥åœ¨é¡¹ç›®å¯åŠ¨çš„æ—¶å€™è‡ªåŠ¨è¿›è¡ŒåŠ è½½ï¼›

3. å®šæ—¶åˆ·æ–°ç¼“å­˜ï¼›

#### ç¼“å­˜é™çº§

å½“è®¿é—®é‡å‰§å¢ã€æœåŠ¡å‡ºç°é—®é¢˜ï¼ˆå¦‚å“åº”æ—¶é—´æ…¢æˆ–ä¸å“åº”ï¼‰æˆ–éæ ¸å¿ƒæœåŠ¡å½±å“åˆ°æ ¸å¿ƒæµç¨‹çš„æ€§èƒ½æ—¶ï¼Œä»ç„¶éœ€è¦ä¿è¯æœåŠ¡è¿˜æ˜¯å¯ç”¨çš„ï¼Œå³ä½¿æ˜¯æœ‰æŸæœåŠ¡ã€‚ç³»ç»Ÿå¯ä»¥æ ¹æ®ä¸€äº›å…³é”®æ•°æ®è¿›è¡Œè‡ªåŠ¨é™çº§ï¼Œä¹Ÿå¯ä»¥é…ç½®å¼€å…³å®ç°äººå·¥é™çº§ã€‚

**ç¼“å­˜é™çº§çš„æœ€ç»ˆç›®çš„æ˜¯ä¿è¯æ ¸å¿ƒæœåŠ¡å¯ç”¨ï¼Œå³ä½¿æ˜¯æœ‰æŸçš„ã€‚è€Œä¸”æœ‰äº›æœåŠ¡æ˜¯æ— æ³•é™çº§çš„ï¼ˆå¦‚åŠ å…¥è´­ç‰©è½¦ã€ç»“ç®—ï¼‰ã€‚**

åœ¨è¿›è¡Œé™çº§ä¹‹å‰è¦å¯¹ç³»ç»Ÿè¿›è¡Œæ¢³ç†ï¼Œçœ‹çœ‹ç³»ç»Ÿæ˜¯ä¸æ˜¯å¯ä»¥ä¸¢å’ä¿å¸…ï¼›ä»è€Œæ¢³ç†å‡ºå“ªäº›å¿…é¡»èª“æ­»ä¿æŠ¤ï¼Œå“ªäº›å¯é™çº§ï¼›æ¯”å¦‚å¯ä»¥å‚è€ƒæ—¥å¿—çº§åˆ«è®¾ç½®é¢„æ¡ˆï¼š

1. ä¸€èˆ¬ï¼šæ¯”å¦‚æœ‰äº›æœåŠ¡å¶å°”å› ä¸ºç½‘ç»œæŠ–åŠ¨æˆ–è€…æœåŠ¡æ­£åœ¨ä¸Šçº¿è€Œè¶…æ—¶ï¼Œå¯ä»¥è‡ªåŠ¨é™çº§ï¼›

2. è­¦å‘Šï¼šæœ‰äº›æœåŠ¡åœ¨ä¸€æ®µæ—¶é—´å†…æˆåŠŸç‡æœ‰æ³¢åŠ¨ï¼ˆå¦‚åœ¨95~100%ä¹‹é—´ï¼‰ï¼Œå¯ä»¥è‡ªåŠ¨é™çº§æˆ–äººå·¥é™çº§ï¼Œå¹¶å‘é€å‘Šè­¦ï¼›

3. é”™è¯¯ï¼šæ¯”å¦‚å¯ç”¨ç‡ä½äº90%ï¼Œæˆ–è€…æ•°æ®åº“è¿æ¥æ± è¢«æ‰“çˆ†äº†ï¼Œæˆ–è€…è®¿é—®é‡çªç„¶çŒ›å¢åˆ°ç³»ç»Ÿèƒ½æ‰¿å—çš„æœ€å¤§é˜€å€¼ï¼Œæ­¤æ—¶å¯ä»¥æ ¹æ®æƒ…å†µè‡ªåŠ¨é™çº§æˆ–è€…äººå·¥é™çº§ï¼›

4. ä¸¥é‡é”™è¯¯ï¼šæ¯”å¦‚å› ä¸ºç‰¹æ®ŠåŸå› æ•°æ®é”™è¯¯äº†ï¼Œæ­¤æ—¶éœ€è¦ç´§æ€¥äººå·¥é™çº§ã€‚

æœåŠ¡é™çº§çš„ç›®çš„ï¼Œæ˜¯ä¸ºäº†é˜²æ­¢ Redis æœåŠ¡æ•…éšœï¼Œå¯¼è‡´æ•°æ®åº“è·Ÿç€ä¸€èµ·å‘ç”Ÿé›ªå´©é—®é¢˜ã€‚å› æ­¤ï¼Œå¯¹äºä¸é‡è¦çš„ç¼“å­˜æ•°æ®ï¼Œå¯ä»¥é‡‡å–æœåŠ¡é™çº§ç­–ç•¥ï¼Œä¾‹å¦‚ä¸€ä¸ªæ¯”è¾ƒå¸¸è§çš„åšæ³•å°±æ˜¯ï¼ŒRediså‡ºç°é—®é¢˜ï¼Œä¸å»æ•°æ®åº“æŸ¥è¯¢ï¼Œè€Œæ˜¯ç›´æ¥è¿”å›é»˜è®¤å€¼ç»™ç”¨æˆ·ã€‚

#### ç¼“å­˜çƒ­ç‚¹ key

ç¼“å­˜ä¸­çš„ä¸€ä¸ª Key(æ¯”å¦‚ä¸€ä¸ªä¿ƒé”€å•†å“)ï¼Œåœ¨æŸä¸ªæ—¶é—´ç‚¹è¿‡æœŸçš„æ—¶å€™ï¼Œæ°å¥½åœ¨è¿™ä¸ªæ—¶é—´ç‚¹å¯¹è¿™ä¸ª Key æœ‰å¤§é‡çš„å¹¶å‘è¯·æ±‚è¿‡æ¥ï¼Œè¿™äº›è¯·æ±‚å‘ç°ç¼“å­˜è¿‡æœŸä¸€èˆ¬éƒ½ä¼šä»åç«¯ DB åŠ è½½æ•°æ®å¹¶å›è®¾åˆ°ç¼“å­˜ï¼Œè¿™ä¸ªæ—¶å€™å¤§å¹¶å‘çš„è¯·æ±‚å¯èƒ½ä¼šç¬é—´æŠŠåç«¯ DB å‹å®ã€‚

**è§£å†³æ–¹æ¡ˆ**

1. å¯¹ç¼“å­˜æŸ¥è¯¢åŠ é”ï¼Œå¦‚æœ KEY ä¸å­˜åœ¨ï¼Œå°±åŠ é”ï¼Œç„¶åæŸ¥ DB å…¥ç¼“å­˜ï¼Œç„¶åè§£é”ï¼›
2. å…¶ä»–è¿›ç¨‹å¦‚æœå‘ç°æœ‰é”å°±ç­‰å¾…ï¼Œç„¶åç­‰è§£é”åè¿”å›æ•°æ®æˆ–è€…è¿›å…¥ DB æŸ¥è¯¢



### ğŸ¯ Redis å¤§ key å’Œ çƒ­ Key é—®é¢˜

> - å¤§ Keyï¼šå•ä¸ª Key çš„å€¼æˆ–é›†åˆç‰¹åˆ«å¤§ï¼Œå¯¼è‡´â€œåˆ é™¤/è¿‡æœŸ/è¿ç§»/å¤‡ä»½/è®¿é—®â€éƒ½é˜»å¡ï¼Œå¸¸è§æ˜¯ä¸€ä¸ª Hash/List/ZSet é‡Œå¡äº†å‡ ä¸‡åˆ°å‡ ç™¾ä¸‡å…ƒç´ ã€‚
>
> - çƒ­ Keyï¼šå°‘æ•° Key è¢«é«˜é¢‘è¯»å†™ï¼Œé€ æˆå•èŠ‚ç‚¹/å•çº¿ç¨‹ç“¶é¢ˆï¼Œé›†ç¾¤å‡ºç°æ§½ä½å€¾æ–œã€‚
>
> - æˆ‘çš„åšæ³•ï¼šå…ˆâ€œè¯†åˆ«â€å†â€œæ²»ç†â€ã€‚å¤§ KeyæŒ‰â€œæ‹†/åˆ /æ¬/å‹ç¼©â€å¤„ç†ï¼›çƒ­ KeyæŒ‰â€œå¤šçº§ç¼“å­˜/è¯·æ±‚åˆå¹¶/è¯»å†™åˆ†æ•£/é€»è¾‘è¿‡æœŸ/å‰¯æœ¬è¯»â€ç»„åˆæ‹³ã€‚æ²»ç†ç›®æ ‡æ˜¯â€œé™ä½å• Key çš„å¤§å°ä¸çƒ­ç‚¹åº¦â€ï¼ŒæŠŠè´Ÿè½½æ‘Šå¹³ã€‚

Redis çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœæœªèƒ½åŠæ—¶å‘ç°å¹¶å¤„ç† Big keysï¼ˆä¸‹æ–‡ç§°ä¸ºâ€œå¤§Keyâ€ï¼‰ä¸ Hotkeysï¼ˆä¸‹æ–‡ç§°ä¸ºâ€œçƒ­Keyâ€ï¼‰ï¼Œå¯èƒ½ä¼šå¯¼è‡´æœåŠ¡æ€§èƒ½ä¸‹é™ã€ç”¨æˆ·ä½“éªŒå˜å·®ï¼Œç”šè‡³å¼•å‘å¤§é¢ç§¯æ•…éšœ

#### ä¸€ã€å¤§Key

é€šå¸¸ä»¥Keyçš„å¤§å°å’ŒKeyä¸­æˆå‘˜çš„æ•°é‡æ¥ç»¼åˆåˆ¤å®šï¼Œä¾‹å¦‚ï¼š

1. **æ•°æ®é‡è¿‡å¤§**ï¼šå•ä¸ª Key çš„ Value è¿‡å¤§ï¼ˆå¦‚ String ç±»å‹ Key å€¼è¶…è¿‡ 5MBï¼‰ã€‚
2. **æˆå‘˜æ•°è¿‡å¤š**ï¼šé›†åˆç±»å‹ Key çš„æˆå‘˜æ•°é‡è¿‡å¤šï¼ˆå¦‚ Hash/ZSet æˆå‘˜æ•°è¶…è¿‡ 1 ä¸‡ï¼‰ã€‚
3. **æˆå‘˜æ€»å¤§å°è¿‡å¤§**ï¼šé›†åˆç±»å‹ Key çš„æ€»å¤§å°è¿‡å¤§ï¼ˆå¦‚ Hash æˆå‘˜æ€»å¤§å°è¶…è¿‡ 100MBï¼‰ã€‚

##### å¼•å‘çš„é—®é¢˜

- **è¯»å†™æ€§èƒ½åŠ£åŒ–**ï¼šæ“ä½œå¤§ Key æ—¶è€—æ—¶å¢åŠ ï¼Œé˜»å¡å…¶ä»–è¯·æ±‚ã€‚
- **å†…å­˜å‹åŠ›**ï¼šè§¦å‘å†…å­˜æ·˜æ±°ç­–ç•¥ï¼ˆLRU/LFUï¼‰ï¼Œå¯¼è‡´é‡è¦æ•°æ®è¢«é€å‡ºï¼Œç”šè‡³ OOMã€‚
- **é›†ç¾¤åˆ†ç‰‡ä¸å‡**ï¼šå•ä¸ªåˆ†ç‰‡å†…å­˜æˆ–å¸¦å®½ä½¿ç”¨ç‡è¿œé«˜äºå…¶ä»–èŠ‚ç‚¹ï¼Œç ´åè´Ÿè½½å‡è¡¡ã€‚
- **åˆ é™¤é˜»å¡**ï¼šåˆ é™¤å¤§ Key å¯èƒ½å¯¼è‡´ä¸»çº¿ç¨‹é˜»å¡ï¼ˆå¦‚åˆ é™¤ç™¾ä¸‡æˆå‘˜çš„ Hashï¼‰ã€‚

##### åŸå› 

- åœ¨ä¸é€‚ç”¨çš„åœºæ™¯ä¸‹ä½¿ç”¨Redisï¼Œæ˜“é€ æˆKeyçš„valueè¿‡å¤§ï¼Œå¦‚ä½¿ç”¨Stringç±»å‹çš„Keyå­˜æ”¾å¤§ä½“ç§¯äºŒè¿›åˆ¶æ–‡ä»¶å‹æ•°æ®ï¼›
- ä¸šåŠ¡ä¸Šçº¿å‰è§„åˆ’è®¾è®¡ä¸è¶³ï¼Œæ²¡æœ‰å¯¹Keyä¸­çš„æˆå‘˜è¿›è¡Œåˆç†çš„æ‹†åˆ†ï¼Œé€ æˆä¸ªåˆ«Keyä¸­çš„æˆå‘˜æ•°é‡è¿‡å¤šï¼›
- æœªå®šæœŸæ¸…ç†æ— æ•ˆæ•°æ®ï¼Œé€ æˆå¦‚HASHç±»å‹Keyä¸­çš„æˆå‘˜æŒç»­ä¸æ–­åœ°å¢åŠ ï¼›
- ä½¿ç”¨LISTç±»å‹Keyçš„ä¸šåŠ¡æ¶ˆè´¹ä¾§å‘ç”Ÿä»£ç æ•…éšœï¼Œé€ æˆå¯¹åº”Keyçš„æˆå‘˜åªå¢ä¸å‡ã€‚

##### **å¦‚ä½•è¯†åˆ«**

- çº¿ä¸Šå®‰å…¨æ–¹å¼ï¼šredis-cli --bigkeysï¼ˆæŠ½æ ·ï¼‰ï¼Œæˆ–ç”¨ SCAN + MEMORY USAGE keyã€TYPE/HLEN/LLEN/ZCARDç»Ÿè®¡ã€‚

- â€œåˆ é™¤æ…¢/è¿‡æœŸå¡é¡¿/è¿ç§»é˜»å¡/CPUé£™é«˜â€é€šå¸¸æ˜¯ä¿¡å·ã€‚æ³¨æ„ DEL å¤§ Key ä¼šé˜»å¡ä¸»çº¿ç¨‹ã€‚

##### å¤§ Keyæ€ä¹ˆæ²»ç†ï¼ˆæ€è·¯ä¸è½åœ°ï¼‰

- æ‹†åˆ†ï¼ˆé¦–é€‰ï¼‰ï¼š

  - å¤§ JSON åˆ‡åˆ†ä¸ºå¤šä¸ªå­ Keyï¼›å¤§é›†åˆæŒ‰åˆ†ç‰‡/æ—¶é—´çª—å£/ä¸šåŠ¡ç»´åº¦æ‹†ï¼Œæ§åˆ¶æ¯ç‰‡å…ƒç´ æ•°ï¼ˆå»ºè®®<1ä¸‡ï¼‰ã€‚

  - é›†ç¾¤ä¸‹ç”¨â€œå“ˆå¸Œæ ‡ç­¾â€æŠŠåˆ†ç‰‡å‡åŒ€è½åˆ°å¤šä¸ª slotï¼Œä¾‹å¦‚ user:{123}:feed:0..Nã€‚

- åˆ é™¤ä¸è¿‡æœŸï¼š

  - ç”¨ UNLINKï¼ˆå¼‚æ­¥åˆ é™¤ï¼‰ä»£æ›¿ DELï¼Œé¿å…ä¸»çº¿ç¨‹é˜»å¡ï¼›æˆ–å¯¹é›†åˆç”¨ HSCAN/SSCAN/ZSCAN åˆ†æ‰¹åˆ ã€‚

    ```bash
      UNLINK big_key            # å¼‚æ­¥é‡Šæ”¾å†…å­˜
      HSCAN h 0 COUNT 1000 ...  # æ‰¹é‡HDEL
    ```

- å‹ç¼©ä¸ç»“æ„é€‰æ‹©ï¼š

  - æ–‡æœ¬ç”¨ Snappy/LZ4 å‹ç¼©ï¼ˆæƒè¡¡ CPUï¼‰ï¼›å¤§ Hash é€‚åº¦åˆ†è£‚ï¼›åˆç†è®¾ç½® listpack/quicklist é˜ˆå€¼ï¼Œå¼€å¯ activedefragã€‚

- è¿ç»´é…ç½®å»ºè®®ï¼š

  - lazyfree-lazy-eviction yesã€lazyfree-lazy-expire yesã€lazyfree-lazy-server-del yesã€activedefrag yesã€‚



#### äºŒã€çƒ­Key

çƒ­ Key çš„ç‰¹å¾æ˜¯**è®¿é—®é¢‘ç‡æ˜¾è‘—é«˜äºå…¶ä»– Key**ï¼Œè¡¨ç°ä¸ºï¼š

1. **QPS å€¾æ–œ**ï¼šå•ä¸ª Key çš„ QPS å æ€» QPS çš„ 70% ä»¥ä¸Šï¼ˆå¦‚æ€» QPS 1 ä¸‡ï¼ŒæŸ Key å  7 åƒï¼‰ã€‚
2. **å¸¦å®½é›†ä¸­**ï¼šå¯¹å¤§é›†åˆ Key é«˜é¢‘è¯»å–ï¼ˆå¦‚é¢‘ç¹è°ƒç”¨ `HGETALL`ï¼‰ã€‚
3. **CPU å ç”¨é«˜**ï¼šå¯¹å¤æ‚ç»“æ„ Key é«˜é¢‘æ“ä½œï¼ˆå¦‚å¤§é‡ `ZRANGE` æ“ä½œæ¶ˆè€— CPUï¼‰ã€‚

##### å¼•å‘çš„é—®é¢˜

- **èµ„æºäº‰æŠ¢**ï¼šCPU/å¸¦å®½è¢«çƒ­ Key ç‹¬å ï¼Œå…¶ä»–è¯·æ±‚æ’é˜Ÿç”šè‡³è¶…æ—¶ã€‚
- **ç¼“å­˜å‡»ç©¿**ï¼šçƒ­ Key å¤±æ•ˆç¬é—´ï¼Œå¤§é‡è¯·æ±‚ç›´æ¥ç©¿é€åˆ°æ•°æ®åº“ï¼Œå¼•å‘é›ªå´©ã€‚
- **åˆ†ç‰‡çƒ­ç‚¹**ï¼šé›†ç¾¤æ¨¡å¼ä¸‹å•ä¸ªåˆ†ç‰‡è´Ÿè½½è¿‡é«˜ï¼Œå¯¼è‡´æ•´ä½“æœåŠ¡ä¸å¯ç”¨ã€‚

##### å…¸å‹åŸå› 

- **çªå‘æµé‡**ï¼šçƒ­ç‚¹æ–°é—»ã€ç§’æ€æ´»åŠ¨ã€ç›´æ’­é—´åˆ·å±ç­‰åœºæ™¯ã€‚
- **è®¾è®¡ä¸åˆç†**ï¼šå…¨å±€é…ç½® Keyï¼ˆå¦‚ç³»ç»Ÿå¼€å…³ï¼‰è¢«é«˜é¢‘è¯»å–ã€‚
- **ç¼“å­˜ç­–ç•¥ç¼ºå¤±**ï¼šæœªå¯¹çƒ­ Key è¿›è¡Œå¤šçº§ç¼“å­˜æˆ–è´Ÿè½½åˆ†æ•£ã€‚

**å¦‚ä½•è¯†åˆ«**

- redis-cli --hotkeysï¼ˆåŸºäº LFU é¢‘æ¬¡ï¼Œéœ€è¦é…ç½® LFU ç­–ç•¥ï¼‰ï¼›

- ä¸šåŠ¡ä¾§åŸ‹ç‚¹ç»Ÿè®¡å‘½ä¸­åˆ†å¸ƒï¼ˆTop N Keyï¼‰ï¼›

- Redis Exporter è§‚æµ‹â€œå‘½ä¸­ç‡/å›æº/å•èŠ‚ç‚¹ QPS/slot å€¾æ–œâ€ã€‚

##### çƒ­ Keyæ€ä¹ˆæ²»ç†ï¼ˆæ€è·¯ä¸è½åœ°ï¼‰

- è¯»ä¼˜åŒ–ï¼ˆä¼˜å…ˆï¼‰ï¼š

  - æœ¬åœ° L1 ç¼“å­˜ï¼ˆCaffeineï¼‰+ Redis L2ï¼Œå¤šçº§ç¼“å­˜ï¼›çƒ­ç‚¹ Key é€»è¾‘è¿‡æœŸï¼Œè¿”å›æ—§å€¼å¼‚æ­¥åˆ·æ–°ï¼Œé¿å…å‡»ç©¿ã€‚

  - å•é£ï¼ˆè¯·æ±‚åˆå¹¶ï¼‰ï¼šå¯¹åŒä¸€ Key çš„ miss å›æºåªå…è®¸ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œï¼Œå…¶å®ƒç­‰å¾…ã€‚

- åˆ†æ•£çƒ­ç‚¹ï¼š

  - è¯»æ‰©æ•£ï¼ˆå¤åˆ¶ Nä»½ï¼‰ï¼šå°†åŒä¸€å€¼å†™å…¥k#0..k#N-1å¤šä¸ª Keyï¼Œè¯»ä¾§éšæœºæŒ‘ä¸€ä»½ï¼›ä¸€è‡´æ€§é çŸ­ TTLæˆ–ç‰ˆæœ¬å·ã€‚

    ```java
      // å†™ï¼šN ä»½å¤åˆ¶
      for (int i=0;i<N;i++) redis.setex(k+"#"+i,val,ttl);
      // è¯»ï¼šéšæœº
      val = redis.get(k+"#"+ThreadLocalRandom.current().nextInt(N));
    ```

- å†™åˆ†ç‰‡ï¼ˆè®¡æ•°ç±»ï¼‰ï¼šæŠŠå†™æ‰“æ•£åˆ°å¤šä¸ªåˆ†ç‰‡ï¼Œè¯»æ—¶æ±‚å’Œæˆ–å¼‚æ­¥èšåˆã€‚

- é›†ç¾¤æ§½ä½æ§åˆ¶ï¼šç”¨ {} ä¿è¯ç›¸å…³ Key åˆ†å¸ƒå‡è¡¡ï¼Œé¿å…æŸæ§½èšé›†è¶…çƒ­ç‚¹ã€‚

- å‰¯æœ¬è¯»ï¼ˆé€‚åˆè¯»å¤šå†™å°‘ï¼‰ï¼šæ‰“å¼€ replica-readï¼Œä»ä»èŠ‚ç‚¹åˆ†æ‹…è¯»ï¼›æ¥å—å¤åˆ¶å»¶è¿Ÿå¸¦æ¥çš„æœ€ç»ˆä¸€è‡´çª—å£ã€‚

- é˜²å‡»ç©¿/é›ªå´©/ç©¿é€ï¼šç©ºå€¼ç¼“å­˜çŸ­ TTLã€å¸ƒéš†è¿‡æ»¤å™¨ã€TTL åŠ éšæœºæŠ–åŠ¨ã€çƒ­ç‚¹ Key åŠ å°ç²’åº¦äº’æ–¥é”ã€‚



### ğŸ¯ æ‰¾å‡ºå¤§ Key å’Œ çƒ­ Key å¹¶è§£å†³?

Redisæä¾›å¤šç§æ–¹æ¡ˆå¸®åŠ©æ‚¨è½»æ¾æ‰¾å‡ºå¤§Keyä¸çƒ­Keyã€‚

- å®æ—¶ Top Key ç»Ÿè®¡
- é€šè¿‡ redis-cli çš„ bigkeys å’Œ hotkeys å‚æ•°æŸ¥æ‰¾ `redis-cli -h 127.0.0.1 -p 6379 --bigkeys`
- é€šè¿‡å†…ç½®å‘½ä»¤å¯¹ç›®æ ‡ key åˆ†æï¼ˆæ¯”å¦‚ String ç±»å‹ï¼Œé€šè¿‡ STRLEN æŸ¥çœ‹å­—èŠ‚æ•°ï¼‰
- ä¸šåŠ¡å±‚å®šä½ key (å¯¹ä¸šåŠ¡å±‚åŠ è®¿é—®è®°å½•å¹¶å¼‚æ­¥æ±‡æ€»åˆ†æ)
- é€šè¿‡ `MONITOR` å‘½ä»¤æ‰¾å‡ºçƒ­ Key



### ğŸ¯ ä¼˜åŒ–å¤§ Key å’Œ çƒ­ Key ï¼Ÿ

**å¤§ Key å¤„ç†æ–¹æ¡ˆ**

1. **æ‹†åˆ† Key**ï¼š
   - **æ¨ªå‘æ‹†åˆ†**ï¼šå°†å¤§ Key æŒ‰è§„åˆ™æ‹†åˆ†ä¸ºå¤šä¸ªå­ Keyã€‚ ç¤ºä¾‹ï¼š`user_1001_profile` â†’ `user_1001_profile_part1`ã€`user_1001_profile_part2`ã€‚
   - **çºµå‘æ‹†åˆ†**ï¼šå¯¹é›†åˆç±»å‹ Key æŒ‰æˆå‘˜åˆ†ç»„å­˜å‚¨ã€‚ ç¤ºä¾‹ï¼šå°†ç™¾ä¸‡æˆå‘˜çš„ ZSet æ‹†åˆ†ä¸ºå¤šä¸ª ZSetï¼ŒæŒ‰æ—¶é—´èŒƒå›´åˆ†ç‰‡ã€‚
2. **ä¼˜åŒ–æ•°æ®ç»“æ„**ï¼š
   - ç”¨ `HyperLogLog` æ›¿ä»£å¤§ Set åšåŸºæ•°ç»Ÿè®¡ã€‚
   - ç”¨å¸ƒéš†è¿‡æ»¤å™¨æ›¿ä»£å¤§ String åšå­˜åœ¨æ€§åˆ¤æ–­ã€‚
3. **æ•°æ®å½’æ¡£ä¸æ¸…ç†**ï¼š
   - å¯¹å¤§ Key è®¾ç½® TTLï¼Œå®šæœŸæ¸…ç†è¿‡æœŸæ•°æ®ã€‚
   - ä½¿ç”¨ `SCAN` å‘½ä»¤æ¸è¿›å¼åˆ é™¤å¤§ Keyï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹ã€‚
4. **é›†ç¾¤åˆ†ç‰‡**ï¼š
   - ä½¿ç”¨ Redis Cluster è‡ªåŠ¨åˆ†ç‰‡ï¼Œåˆ†æ•£å¤§ Key å­˜å‚¨å‹åŠ›ã€‚
   - é€šè¿‡ Hash Tag ç¡®ä¿ç›¸å…³ Key åˆ†é…åˆ°åŒä¸€åˆ†ç‰‡ã€‚

**çƒ­ Key å¤„ç†æ–¹æ¡ˆ**

1. **æœ¬åœ°ç¼“å­˜ï¼ˆå®¢æˆ·ç«¯ç¼“å­˜ï¼‰**ï¼š
   - åœ¨å®¢æˆ·ç«¯æˆ–ä»£ç†å±‚ï¼ˆå¦‚ Nginxï¼‰ç¼“å­˜çƒ­ Key æ•°æ®ï¼Œå‡å°‘ Redis è®¿é—®é‡ã€‚
   - è®¾ç½®åˆç†çš„æœ¬åœ°ç¼“å­˜è¿‡æœŸæ—¶é—´ï¼ˆå¦‚ 100msï¼‰ï¼Œé¿å…æ•°æ®ä¸ä¸€è‡´ã€‚
2. **å¤šå‰¯æœ¬åˆ†æ•£è¯»å‹åŠ›**ï¼š
   - åœ¨é›†ç¾¤ä¸­ä¸ºçƒ­ Key åˆ›å»ºå¤šä¸ªå‰¯æœ¬ï¼ˆå¦‚ `hot_key_v1`ã€`hot_key_v2`ï¼‰ï¼Œé€šè¿‡éšæœºè®¿é—®åˆ†æ•£æµé‡ã€‚
   - ä½¿ç”¨ Lua è„šæœ¬å®ç°åŸå­åŒ–å¤šå‰¯æœ¬æ›´æ–°ã€‚
3. **é™æµä¸ç†”æ–­**ï¼š
   - ç›‘æ§çƒ­ Key QPSï¼Œè¶…å‡ºé˜ˆå€¼æ—¶è§¦å‘é™æµï¼ˆå¦‚ä»¤ç‰Œæ¡¶ç®—æ³•ï¼‰ã€‚
   - ç†”æ–­æœºåˆ¶ï¼šçƒ­ Key è®¿é—®å¼‚å¸¸æ—¶ï¼Œæš‚æ—¶æ‹’ç»è¯·æ±‚å¹¶è¿”å›é»˜è®¤å€¼ã€‚
4. **äºŒçº§ç¼“å­˜æ¶æ„**ï¼š
   - çƒ­ Key æ•°æ®åŒæ—¶å†™å…¥ Redis å’Œæœ¬åœ°ç¼“å­˜ï¼ˆå¦‚ Caffeineï¼‰ã€‚
   - ä½¿ç”¨å‘å¸ƒè®¢é˜…æœºåˆ¶ï¼ˆPub/Subï¼‰ä¿è¯å¤šçº§ç¼“å­˜ä¸€è‡´æ€§ã€‚

------



## ä¸ƒã€åˆ†å¸ƒå¼é”ä¸å¹¶å‘æ§åˆ¶

### ğŸ¯ Redis å®ç°åˆ†å¸ƒå¼é”

é»˜è®¤æŒ‡å®šå¤§å®¶ç”¨çš„æ˜¯ Redis 2.6.12 åŠæ›´é«˜çš„ç‰ˆæœ¬ï¼Œå°±ä¸å†å»è®² `setnx`ã€`expire` è¿™ç§äº†ï¼Œç›´æ¥ `set` å‘½ä»¤åŠ é”

```shell
set key value[expiration EX seconds|PX milliseconds] [NX|XX]
```

> *SET* å‘½ä»¤çš„è¡Œä¸ºå¯ä»¥é€šè¿‡ä¸€ç³»åˆ—å‚æ•°æ¥ä¿®æ”¹
>
> - `EX second` ï¼šè®¾ç½®é”®çš„è¿‡æœŸæ—¶é—´ä¸º `second` ç§’ã€‚ `SET key value EX second` æ•ˆæœç­‰åŒäº `SETEX key second value` ã€‚
> - `PX millisecond` ï¼šè®¾ç½®é”®çš„è¿‡æœŸæ—¶é—´ä¸º `millisecond` æ¯«ç§’ã€‚ `SET key value PX millisecond` æ•ˆæœç­‰åŒäº `PSETEX key millisecond value` ã€‚
> - `NX` ï¼šåªåœ¨é”®ä¸å­˜åœ¨æ—¶ï¼Œæ‰å¯¹é”®è¿›è¡Œè®¾ç½®æ“ä½œã€‚ `SET key value NX` æ•ˆæœç­‰åŒäº `SETNX key value` ã€‚
> - `XX` ï¼šåªåœ¨é”®å·²ç»å­˜åœ¨æ—¶ï¼Œæ‰å¯¹é”®è¿›è¡Œè®¾ç½®æ“ä½œã€‚

```sh
SET resource_name my_random_value NX PX 30000
```

è¿™æ¡æŒ‡ä»¤çš„æ„æ€ï¼šå½“ keyâ€”â€”resource_name ä¸å­˜åœ¨æ—¶åˆ›å»ºè¿™æ ·çš„ keyï¼Œè®¾å€¼ä¸º my_random_valueï¼Œå¹¶è®¾ç½®è¿‡æœŸæ—¶é—´ 30000 æ¯«ç§’ã€‚

åˆ«çœ‹è¿™å¹²äº†ä¸¤ä»¶äº‹ï¼Œå› ä¸º Redis æ˜¯å•çº¿ç¨‹çš„ï¼Œè¿™ä¸€æ¡æŒ‡ä»¤ä¸ä¼šè¢«æ‰“æ–­ï¼Œæ‰€ä»¥æ˜¯åŸå­æ€§çš„æ“ä½œã€‚

Redis å®ç°åˆ†å¸ƒå¼é”çš„ä¸»è¦æ­¥éª¤ï¼š

1. æŒ‡å®šä¸€ä¸ª key ä½œä¸ºé”æ ‡è®°ï¼Œå­˜å…¥ Redis ä¸­ï¼ŒæŒ‡å®šä¸€ä¸ª **å”¯ä¸€çš„æ ‡è¯†** ä½œä¸º valueã€‚
2. å½“ key ä¸å­˜åœ¨æ—¶æ‰èƒ½è®¾ç½®å€¼ï¼Œç¡®ä¿åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªå®¢æˆ·ç«¯è¿›ç¨‹è·å¾—é”ï¼Œæ»¡è¶³ **äº’æ–¥æ€§** ç‰¹æ€§ã€‚
3. è®¾ç½®ä¸€ä¸ªè¿‡æœŸæ—¶é—´ï¼Œé˜²æ­¢å› ç³»ç»Ÿå¼‚å¸¸å¯¼è‡´æ²¡èƒ½åˆ é™¤è¿™ä¸ª keyï¼Œæ»¡è¶³ **é˜²æ­»é”** ç‰¹æ€§ã€‚
4. å½“å¤„ç†å®Œä¸šåŠ¡ä¹‹åéœ€è¦æ¸…é™¤è¿™ä¸ª key æ¥é‡Šæ”¾é”ï¼Œæ¸…é™¤ key æ—¶éœ€è¦æ ¡éªŒ value å€¼ï¼Œéœ€è¦æ»¡è¶³ **è§£é“ƒè¿˜é¡»ç³»é“ƒäºº** ã€‚

è®¾ç½®ä¸€ä¸ªéšæœºå€¼çš„æ„æ€æ˜¯åœ¨è§£é”æ—¶å€™åˆ¤æ–­ key çš„å€¼å’Œæˆ‘ä»¬å­˜å‚¨çš„éšæœºæ•°æ˜¯ä¸æ˜¯ä¸€æ ·ï¼Œä¸€æ ·çš„è¯ï¼Œæ‰æ˜¯è‡ªå·±çš„é”ï¼Œç›´æ¥ `del` è§£é”å°±è¡Œã€‚

å½“ç„¶è¿™ä¸ªä¸¤ä¸ªæ“ä½œè¦ä¿è¯åŸå­æ€§ï¼Œæ‰€ä»¥ Redis ç»™å‡ºäº†ä¸€æ®µ lua è„šæœ¬ï¼ˆRedis æœåŠ¡å™¨ä¼šå•çº¿ç¨‹åŸå­æ€§æ‰§è¡Œ lua è„šæœ¬ï¼Œä¿è¯ lua è„šæœ¬åœ¨å¤„ç†çš„è¿‡ç¨‹ä¸­ä¸ä¼šè¢«ä»»æ„å…¶å®ƒè¯·æ±‚æ‰“æ–­ã€‚ï¼‰ï¼š

```lua
if redis.call("get",KEYS[1]) == ARGV[1] then
    return redis.call("del",KEYS[1])
else
    return 0
end
```



### ğŸ¯ ä¸Šè¿° Redis åˆ†å¸ƒå¼é”çš„ç¼ºç‚¹

1. **å•ç‚¹æ•…éšœ**ï¼šå¦‚æœ Redis æœåŠ¡å™¨å‡ºç°æ•…éšœï¼Œæ•´ä¸ªåˆ†å¸ƒå¼é”æœåŠ¡å°†ä¸å¯ç”¨ã€‚å°½ç®¡å¯ä»¥é€šè¿‡ Redis é›†ç¾¤æˆ–å“¨å…µæ¨¡å¼æé«˜å¯ç”¨æ€§ï¼Œä½†è¿™äº›æ–¹æ³•ä¼šå¢åŠ ç³»ç»Ÿçš„å¤æ‚æ€§ã€‚

2. **é”å¤±æ•ˆé—®é¢˜**ï¼šç”±äºç½‘ç»œå»¶è¿Ÿæˆ– Redis æœåŠ¡å™¨è´Ÿè½½é«˜ç­‰åŸå› ï¼Œè®¾ç½®çš„é”å¯èƒ½ä¼šåœ¨é¢„æœŸçš„æ—¶é—´ä¹‹å‰å¤±æ•ˆã€‚å¦‚æœé”å¤±æ•ˆæ—¶é—´è¿‡çŸ­ï¼Œä¸šåŠ¡é€»è¾‘å¯èƒ½è¿˜æœªå®Œæˆå°±ä¼šå¤±å»é”ï¼Œå¯¼è‡´æ•°æ®ä¸ä¸€è‡´ã€‚

3. **æ—¶é’Ÿæ¼‚ç§»**ï¼šRedis åˆ†å¸ƒå¼é”ä¾èµ–äºç³»ç»Ÿæ—¶é—´ã€‚å¦‚æœå¤šä¸ªèŠ‚ç‚¹çš„ç³»ç»Ÿæ—¶é—´ä¸åŒæ­¥ï¼Œå¯èƒ½ä¼šå¯¼è‡´é”çš„æ—¶é—´è®¡ç®—é”™è¯¯ï¼Œè¿›è€Œå¼•å‘é”çš„ç«äº‰å’Œæ•°æ®ä¸€è‡´æ€§é—®é¢˜ã€‚

4. **ä¸å¯é‡å…¥æ€§**ï¼šRedis åˆ†å¸ƒå¼é”é€šå¸¸æ˜¯ä¸å¯é‡å…¥çš„ï¼Œè¿™æ„å‘³ç€ä¸€ä¸ªæŒæœ‰é”çš„çº¿ç¨‹ä¸èƒ½å†æ¬¡è·å¾—åŒä¸€ä¸ªé”ã€‚å¦‚æœä¸šåŠ¡é€»è¾‘ä¸­å­˜åœ¨é‡å…¥éœ€æ±‚ï¼Œéœ€è¦é¢å¤–çš„è®¾è®¡æ¥å¤„ç†ã€‚ ã€å¯ä»¥è€ƒè™‘ä½¿ç”¨ Redisson ç­‰å·¥å…·ï¼Œå®ƒä»¬æä¾›äº†å¯é‡å…¥é”çš„å°è£…ã€‘

5. **åŸå­æ€§å’Œä¸€è‡´æ€§**

   å°½ç®¡ä½¿ç”¨ `SET NX PX` å‘½ä»¤å¯ä»¥å®ç°é”çš„åŸºæœ¬åŸå­æ€§ï¼Œä½†åœ¨å¤„ç†é”çš„é‡Šæ”¾ã€ç»­ç§Ÿç­‰å¤æ‚åœºæ™¯æ—¶ï¼Œéœ€è¦å°å¿ƒå¤„ç†åŸå­æ€§å’Œä¸€è‡´æ€§ã€‚ä¾‹å¦‚ï¼Œåœ¨é‡Šæ”¾é”æ—¶ï¼Œå¦‚æœé‡Šæ”¾é”çš„å®¢æˆ·ç«¯åœ¨åˆ é™¤é”ä¹‹å‰å´©æºƒï¼Œå¯èƒ½ä¼šå¯¼è‡´é”æ— æ³•æ­£ç¡®é‡Šæ”¾ã€‚

6. **é”è¶…æ—¶å’Œä¸šåŠ¡æ—¶é—´ä¸åŒ¹é…**

   è®¾ç½®çš„é”è¶…æ—¶æ—¶é—´å¯èƒ½å’Œä¸šåŠ¡å®é™…æ‰§è¡Œæ—¶é—´ä¸åŒ¹é…ï¼Œç‰¹åˆ«æ˜¯åœ¨ä¸šåŠ¡æ‰§è¡Œæ—¶é—´ä¸å¯é¢„æœŸçš„æƒ…å†µä¸‹ã€‚è¿‡çŸ­çš„é”è¶…æ—¶æ—¶é—´å¯èƒ½å¯¼è‡´é”åœ¨ä¸šåŠ¡æœªå®Œæˆæ—¶è¢«å…¶ä»–èŠ‚ç‚¹è·å–ï¼Œè¿‡é•¿çš„é”è¶…æ—¶æ—¶é—´åˆ™å¯èƒ½é™ä½ç³»ç»Ÿå¹¶å‘æ€§ã€‚

7. **ä¸»ä»å¤åˆ¶é—®é¢˜**ï¼šåœ¨ Redis ä¸»ä»å¤åˆ¶æ¨¡å¼ä¸‹ï¼Œå¦‚æœä¸»èŠ‚ç‚¹å®•æœºï¼Œä»èŠ‚ç‚¹è¢«æå‡ä¸ºæ–°çš„ä¸»èŠ‚ç‚¹ï¼Œå¯èƒ½ä¼šå¯¼è‡´é”ä¸¢å¤±ï¼Œä»è€Œäº§ç”Ÿå¹¶å‘é—®é¢˜
8. å®¢æˆ·ç«¯å®ç°å¤æ‚ï¼šå®ç°ä¸€ä¸ªå¥å£®çš„åˆ†å¸ƒå¼é”éœ€è¦å¤„ç†å¾ˆå¤šç»†èŠ‚é—®é¢˜ï¼Œå¦‚é”çš„ç»­ç§Ÿã€é”çš„è¿‡æœŸç­‰ï¼Œè¿™äº›ä¼šå¢åŠ å®¢æˆ·ç«¯çš„å®ç°å¤æ‚åº¦ã€‚å°½ç®¡æœ‰ä¸€äº›æˆç†Ÿçš„åº“ï¼ˆå¦‚ Redissonï¼‰å¯ä»¥å¸®åŠ©ç®€åŒ–è¿™äº›æ“ä½œï¼Œä½†ä¾ç„¶éœ€è¦è°¨æ…ä½¿ç”¨å’Œé…ç½®ã€‚

8. æ€§èƒ½å¼€é”€ï¼šè™½ç„¶ Redis çš„æ€§èƒ½å¾ˆé«˜ï¼Œä½†é¢‘ç¹çš„é”æ“ä½œï¼ˆè·å–ã€ç»­ç§Ÿã€é‡Šæ”¾ç­‰ï¼‰ä¼šå¯¹ Redis æœåŠ¡å™¨é€ æˆä¸€å®šçš„å‹åŠ›ï¼Œç‰¹åˆ«æ˜¯åœ¨é«˜å¹¶å‘ç¯å¢ƒä¸‹ã€‚



### ğŸ¯ Rediså®ç°åˆ†å¸ƒå¼é”ï¼Œè¿˜æœ‰å…¶ä»–æ–¹å¼ä¹ˆï¼Œzookeeperæ€ä¹ˆå®ç°ï¼Œå„æœ‰ä»€ä¹ˆæœ‰ç¼ºç‚¹ï¼Œä½ ä»¬ä¸ºä»€ä¹ˆç”¨rediså®ç°

> åˆ†å¸ƒå¼é”å¸¸è§æœ‰ä¸‰ç§å®ç°ï¼šåŸºäº **Redisã€Zookeeper å’Œæ•°æ®åº“**ã€‚
>  Redis åŸºäº `SETNX` å®ç°ï¼Œæ€§èƒ½é«˜ï¼Œé€‚åˆé«˜å¹¶å‘ï¼Œä½†éœ€è¦è€ƒè™‘è¿‡æœŸç»­æœŸå’Œä¸»ä»åŒæ­¥å¸¦æ¥çš„é”ä¸¢å¤±é—®é¢˜ï¼›
>  Zookeeper åŸºäºä¸´æ—¶é¡ºåºèŠ‚ç‚¹å’Œ Watch æœºåˆ¶ï¼Œå¯é æ€§å’Œå…¬å¹³æ€§å¥½ï¼Œä½† QPS ä¸é«˜ï¼Œé€‚åˆå¼ºä¸€è‡´æ€§åœºæ™¯ï¼›
>  æ•°æ®åº“åŸºäºå”¯ä¸€ç´¢å¼•æˆ–è¡Œé”ï¼Œç®€å•ä½†æ€§èƒ½å·®ï¼Œå®¹æ˜“é€ æˆæ­»é”ã€‚
>
> æˆ‘ä»¬é¡¹ç›®é‡Œç”¨çš„æ˜¯ **Redis å®ç°åˆ†å¸ƒå¼é”**ï¼Œä¸»è¦åŸå› æ˜¯ç³»ç»Ÿå¯¹æ€§èƒ½è¦æ±‚æé«˜ï¼ˆQPS åä¸‡çº§ï¼‰ï¼ŒRedis é”çš„å»¶è¿Ÿæ›´ä½ï¼Œè€Œä¸” Redisson å·²ç»å¸®æˆ‘ä»¬å°è£…äº†ç»­æœŸå’Œå¯é‡å…¥æœºåˆ¶ï¼Œå¼€å‘å’Œç»´æŠ¤æˆæœ¬ä½ã€‚

| å®ç°æ–¹å¼      | åŸç†                        | ä¼˜ç‚¹                 | ç¼ºç‚¹                     | é€‚ç”¨åœºæ™¯                     |
| ------------- | --------------------------- | -------------------- | ------------------------ | ---------------------------- |
| **Redis**     | SETNX/RedLockï¼Œè¿‡æœŸæ—¶é—´æ§åˆ¶ | é«˜æ€§èƒ½ï¼Œç®€å•ï¼Œç”Ÿæ€å¥½ | é”ä¸¢å¤±é£é™©ï¼Œéœ€è¦ç»­æœŸæœºåˆ¶ | é«˜å¹¶å‘ã€å¯¹æ€§èƒ½æ•æ„Ÿ           |
| **Zookeeper** | ä¸´æ—¶é¡ºåºèŠ‚ç‚¹ + Watch æœºåˆ¶   | å¼ºä¸€è‡´ï¼Œå…¬å¹³æ€§å¥½     | QPS è¾ƒä½ï¼Œä¾èµ– zk é›†ç¾¤   | é‡‘èã€ç”µå•†ä¸‹å•ç­‰ä¸€è‡´æ€§è¦æ±‚é«˜ |
| **æ•°æ®åº“**    | å”¯ä¸€ç´¢å¼• / è¡Œé”             | ç®€å•æ˜“å®ç°           | æ€§èƒ½å·®ï¼Œå®¹æ˜“æ­»é”         | å°è§„æ¨¡ç³»ç»Ÿï¼Œä¸´æ—¶ä½¿ç”¨         |

**1. Redis å®ç°**

- **åŸç†**ï¼šåˆ©ç”¨ `SETNX key value EX expire`ï¼ˆæˆ– Redisson çš„ `lock`ï¼‰ï¼Œä¿è¯åªæœ‰ä¸€ä¸ªå®¢æˆ·ç«¯èƒ½æˆåŠŸå†™å…¥ï¼Œæ‹¿åˆ°é”ã€‚è§£é”æ—¶ `DEL key`ï¼Œç»“åˆ Lua è„šæœ¬ä¿è¯åŸå­æ€§ã€‚
- **ä¼˜åŒ–**ï¼šRedLock ç®—æ³•ï¼ˆå¤šèŠ‚ç‚¹åŠ é”ï¼‰ï¼Œé¿å…å•ç‚¹ Redis æ•…éšœã€‚

âœ… ä¼˜ç‚¹ï¼š

- æ€§èƒ½é«˜ï¼Œé€‚åˆé«˜å¹¶å‘åœºæ™¯
- å®ç°ç®€å•ï¼Œç”Ÿæ€æˆç†Ÿï¼ˆRedissonï¼‰

âŒ ç¼ºç‚¹ï¼š

- éœ€è¦è€ƒè™‘é”è¿‡æœŸã€è‡ªåŠ¨ç»­æœŸï¼ˆçœ‹é—¨ç‹—ï¼‰
- å•èŠ‚ç‚¹ Redis æŒ‚æ‰ä¼šæœ‰é£é™©ï¼Œä¸»ä»å¼‚æ­¥å¯èƒ½å¯¼è‡´é”ä¸¢å¤±

**2. Zookeeper å®ç°**

- **åŸç†**ï¼šåŸºäº **ä¸´æ—¶é¡ºåºèŠ‚ç‚¹ + Watch æœºåˆ¶**
  - å®¢æˆ·ç«¯åœ¨ `/lock` ä¸‹åˆ›å»º **ä¸´æ—¶é¡ºåºèŠ‚ç‚¹**
  - åºå·æœ€å°çš„å®¢æˆ·ç«¯è·å¾—é”
  - å…¶ä»–å®¢æˆ·ç«¯ç›‘å¬å‰ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå‰ä¸€ä¸ªèŠ‚ç‚¹é‡Šæ”¾æ—¶è¢«å”¤é†’
- **å…¬å¹³é”**ï¼šä¸¥æ ¼ FIFO é¡ºåº

âœ… ä¼˜ç‚¹ï¼š

- å¤©ç„¶ä¿è¯é”çš„å¯é æ€§ï¼ˆä¼šè¯æ–­å¼€ï¼Œä¸´æ—¶èŠ‚ç‚¹è‡ªåŠ¨åˆ é™¤ï¼‰
- å…¬å¹³æ€§å¥½ï¼ˆæŒ‰é¡ºåºæ’é˜Ÿï¼‰

âŒ ç¼ºç‚¹ï¼š

- Zookeeper æ˜¯ CP æ¨¡å‹ï¼Œæ€§èƒ½ä¸å¦‚ Redisï¼ˆQPS ä¸‡çº§ vs Redis åä¸‡çº§ä»¥ä¸Šï¼‰
- ä¾èµ– ZooKeeper é›†ç¾¤ï¼Œè¿ç»´æˆæœ¬é«˜

**3. æ•°æ®åº“å®ç°**

- **æ–¹å¼ 1**ï¼šåŸºäºå”¯ä¸€ç´¢å¼•ï¼Œæ¯”å¦‚ `insert into lock_table (lock_key) values ('xxx')`ï¼Œå¤±è´¥è¯´æ˜å·²è¢«å ç”¨
- **æ–¹å¼ 2**ï¼šåŸºäº `select ... for update` è¡Œé”

âœ… ä¼˜ç‚¹ï¼š

- æ˜“äºç†è§£ï¼Œç›´æ¥åˆ©ç”¨æ•°æ®åº“
- æ— éœ€é¢å¤–ç»„ä»¶

âŒ ç¼ºç‚¹ï¼š

- æ€§èƒ½å·®ï¼Œä¸é€‚åˆé«˜å¹¶å‘
- é”è¶…æ—¶ã€æ­»é”å¤„ç†å¤æ‚



### ğŸ¯ åˆ†å¸ƒå¼Redisæ˜¯å‰æœŸåšè¿˜æ˜¯åæœŸè§„æ¨¡ä¸Šæ¥äº†å†åšå¥½ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ

æ—¢ç„¶Redisæ˜¯å¦‚æ­¤çš„è½»é‡ï¼ˆå•å®ä¾‹åªä½¿ç”¨1Må†…å­˜ï¼‰ï¼Œä¸ºé˜²æ­¢ä»¥åçš„æ‰©å®¹ï¼Œæœ€å¥½çš„åŠæ³•å°±æ˜¯ä¸€å¼€å§‹å°±å¯åŠ¨è¾ƒå¤šå®ä¾‹ã€‚å³ä¾¿ä½ åªæœ‰ä¸€å°æœåŠ¡å™¨ï¼Œä½ ä¹Ÿå¯ä»¥ä¸€å¼€å§‹å°±è®©Redisä»¥åˆ†å¸ƒå¼çš„æ–¹å¼è¿è¡Œï¼Œä½¿ç”¨åˆ†åŒºï¼Œåœ¨åŒä¸€å°æœåŠ¡å™¨ä¸Šå¯åŠ¨å¤šä¸ªå®ä¾‹ã€‚

ä¸€å¼€å§‹å°±å¤šè®¾ç½®å‡ ä¸ªRediså®ä¾‹ï¼Œä¾‹å¦‚32æˆ–è€…64ä¸ªå®ä¾‹ï¼Œå¯¹å¤§å¤šæ•°ç”¨æˆ·æ¥è¯´è¿™æ“ä½œèµ·æ¥å¯èƒ½æ¯”è¾ƒéº»çƒ¦ï¼Œä½†æ˜¯ä»é•¿ä¹…æ¥çœ‹åšè¿™ç‚¹ç‰ºç‰²æ˜¯å€¼å¾—çš„ã€‚

è¿™æ ·çš„è¯ï¼Œå½“ä½ çš„æ•°æ®ä¸æ–­å¢é•¿ï¼Œéœ€è¦æ›´å¤šçš„RedisæœåŠ¡å™¨æ—¶ï¼Œä½ éœ€è¦åšçš„å°±æ˜¯ä»…ä»…å°†Rediså®ä¾‹ä»ä¸€å°æœåŠ¡è¿ç§»åˆ°å¦å¤–ä¸€å°æœåŠ¡å™¨è€Œå·²ï¼ˆè€Œä¸ç”¨è€ƒè™‘é‡æ–°åˆ†åŒºçš„é—®é¢˜ï¼‰ã€‚ä¸€æ—¦ä½ æ·»åŠ äº†å¦ä¸€å°æœåŠ¡å™¨ï¼Œä½ éœ€è¦å°†ä½ ä¸€åŠçš„Rediså®ä¾‹ä»ç¬¬ä¸€å°æœºå™¨è¿ç§»åˆ°ç¬¬äºŒå°æœºå™¨ã€‚



### ğŸ¯ Redisåˆ†å¸ƒå¼é”æœ‰ä»€ä¹ˆé—®é¢˜ æ€ä¹ˆè§£å†³ï¼Ÿ

> Redis åˆ†å¸ƒå¼é”è™½ç„¶ç®€å•é«˜æ•ˆï¼Œä½†æœ‰å‡ ä¸ªé—®é¢˜ï¼š
>
> 1. é”å¯èƒ½å› ä¸º TTL åˆ°æœŸè€Œè¢«è¯¯é‡Šæ”¾ï¼›
> 2. é”ä¸å¯é‡å…¥ï¼›
> 3. ä¸»ä»å»¶è¿Ÿå¯èƒ½å¯¼è‡´é”ä¸¢å¤±ï¼›
> 4. é”è¿‡æœŸæ—¶é—´ä¸å¥½æ§åˆ¶ã€‚
>
> å¸¸è§çš„ä¼˜åŒ–æ–¹æ³•æœ‰ï¼š
>
> - ä½¿ç”¨å”¯ä¸€æ ‡è¯† + Lua è„šæœ¬ä¿è¯å®‰å…¨é‡Šæ”¾ï¼›
> - çœ‹é—¨ç‹—æœºåˆ¶è‡ªåŠ¨ç»­æœŸï¼Œè§£å†³è¶…æ—¶é—®é¢˜ï¼›
> - æ”¯æŒå¯é‡å…¥é”ï¼›
> - å¤šèŠ‚ç‚¹åŠ é”ï¼ˆRedLockï¼‰æå‡å®¹é”™æ€§ï¼›
> - å¦‚æœå¯¹ä¸€è‡´æ€§è¦æ±‚æé«˜ï¼Œå¯ä»¥ç”¨ ZooKeeper æˆ– etcdã€‚
>
> ç»¼ä¸Šï¼ŒRedis åˆ†å¸ƒå¼é”é€‚åˆé«˜æ€§èƒ½ä½†å¯¹ä¸€è‡´æ€§å®¹å¿åº¦è¾ƒé«˜çš„ä¸šåŠ¡ï¼Œè€Œé‡‘èçº§åˆ«çš„å¼ºä¸€è‡´æ€§åˆ†å¸ƒå¼é”æ›´å»ºè®®ç”¨ ZooKeeperã€‚

| **é—®é¢˜**         | **è¯´æ˜**                                                     | **è§£å†³æ€è·¯**                                                 |
| ---------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| é”è¿‡æœŸå¯¼è‡´è¯¯é‡Šæ”¾ | A çº¿ç¨‹é”è¿˜æ²¡æ‰§è¡Œå®Œï¼Œé” TTL åˆ°æœŸé‡Šæ”¾ï¼ŒB è·å–é” â†’ A æ‰§è¡Œå®Œé‡Šæ”¾æ—¶è¯¯åˆ äº† B çš„é” | ä½¿ç”¨ **å”¯ä¸€æ ‡è¯†ï¼ˆUUID/çº¿ç¨‹IDï¼‰+ Lua è„šæœ¬**ï¼Œä¿è¯åªåˆ é™¤è‡ªå·±çš„é” |
| ä¸å¯é‡å…¥         | åŒä¸€çº¿ç¨‹é‡å¤è·å–é”æ—¶ä¼šæ­»é”                                   | ä½¿ç”¨ **å¯é‡å…¥é”**ï¼Œåœ¨ value ä¸­å­˜å‚¨çº¿ç¨‹ ID å’Œé‡å…¥è®¡æ•°         |
| é”è¶…æ—¶ä¸å¯æ§     | ä¸šåŠ¡æ‰§è¡Œæ—¶é—´å¯èƒ½æ¯” TTL é•¿ï¼Œå¯¼è‡´é”è¿‡æœŸ                        | **çœ‹é—¨ç‹—æœºåˆ¶**ï¼ˆå®šæ—¶ç»­æœŸï¼‰ï¼Œå¦‚ Redisson é»˜è®¤ 30sï¼Œ10s è‡ªåŠ¨ç»­æœŸ |
| ä¸»ä»å¤åˆ¶å»¶è¿Ÿ     | ä¸»èŠ‚ç‚¹åŠ é”åå®•æœºï¼Œæ•°æ®è¿˜æ²¡åŒæ­¥åˆ°ä»èŠ‚ç‚¹ â†’ é”ä¸¢å¤±              | **RedLock ç®—æ³•**ï¼šåœ¨å¤šä¸ªç‹¬ç«‹ Redis èŠ‚ç‚¹åŠ é”ï¼Œè¶…è¿‡åŠæ•°æˆåŠŸç®—æˆåŠŸ |
| å•ç‚¹é—®é¢˜         | å• Redis èŠ‚ç‚¹å®•æœº â†’ é”å…¨ä¸¢å¤±                                 | Redis **é›†ç¾¤éƒ¨ç½²** æˆ– ä½¿ç”¨ **ZooKeeper/etcd** è¿™ç±» CP ç³»ç»Ÿä¿è¯ä¸€è‡´æ€§ |



### ğŸ¯ Redisåˆ†å¸ƒå¼é”ï¼Œè¿‡æœŸæ—¶é—´æ€ä¹ˆå®šçš„?

**é”è¿‡æœŸæ—¶é—´çš„è®¾å®š**

1. **è®¾å®šåŸåˆ™**
   - **ç»éªŒå€¼æ³•**ï¼šåŸºäºä¸šåŠ¡é€»è¾‘çš„å¹³å‡è€—æ—¶è®¾å®šï¼Œæ¨è `TTL = å¹³å‡è€—æ—¶ Ã— 2~3`ï¼ˆå¦‚å¹³å‡è€—æ—¶ 5s â†’ TTL=15sï¼‰ã€‚
   - **åŠ¨æ€è°ƒæ•´**ï¼šç»“åˆå†å²æ•°æ®ç›‘æ§åŠ¨æ€è°ƒæ•´ï¼ˆå¦‚ Prometheus ç»Ÿè®¡ P99 è€—æ—¶ï¼‰ã€‚
   - **å…œåº•ç­–ç•¥**ï¼šå¿…é¡»è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œé¿å…æ­»é”ï¼ˆå³ä½¿ä¸šåŠ¡å´©æºƒï¼Œé”ä¹Ÿèƒ½è‡ªåŠ¨é‡Šæ”¾ï¼‰ã€‚

2. **æç«¯åœºæ™¯ä¼˜åŒ–**

   - **è‡ªåŠ¨ç»­æœŸï¼ˆWatchdogï¼‰**ï¼š å®¢æˆ·ç«¯å¯åŠ¨åå°çº¿ç¨‹ï¼Œå®šæœŸï¼ˆå¦‚ `TTL/3`ï¼‰é‡ç½®é”è¿‡æœŸæ—¶é—´ã€‚ **ç¤ºä¾‹**ï¼šRedisson çš„ `lockWatchdogTimeout` é»˜è®¤ 30sï¼Œæ¯ 10s ç»­æœŸã€‚

     > **ç»­æœŸæœºåˆ¶å®ç°**
     >
     > 1. **å¼€å¯ä¸€ä¸ªå®šæ—¶ä»»åŠ¡**ï¼šåœ¨è·å–é”åï¼Œå¼€å¯ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œæ¯éš”ä¸€å®šæ—¶é—´ï¼ˆå¦‚è¿‡æœŸæ—¶é—´çš„ä¸€åŠï¼‰å»¶é•¿é”çš„è¿‡æœŸæ—¶é—´ã€‚
     >
     > 2. **åˆ¤æ–­é”çš„æŒæœ‰è€…**ï¼šåœ¨ç»­æœŸæ—¶ï¼Œç¡®ä¿å½“å‰ç»­æœŸæ“ä½œä»ç„¶æ˜¯ç”±é”çš„æŒæœ‰è€…æ‰§è¡Œï¼Œä»¥é˜²æ­¢é”è¯¯ç»­æœŸã€‚
     >
     >    ```java
     >    public class RedisLockWithRenewal {
     >                      
     >        private static final String LOCK_KEY = "my_lock";
     >        private static final String LOCK_VALUE = "unique_value";
     >        private static final int EXPIRE_TIME = 7; // è¿‡æœŸæ—¶é—´ä¸º7ç§’
     >                      
     >        public boolean acquireLock(Jedis jedis) {
     >            String result = jedis.set(LOCK_KEY, LOCK_VALUE, "NX", "EX", EXPIRE_TIME);
     >            return "OK".equals(result);
     >        }
     >                      
     >        public void releaseLock(Jedis jedis) {
     >            if (LOCK_VALUE.equals(jedis.get(LOCK_KEY))) {
     >                jedis.del(LOCK_KEY);
     >            }
     >        }
     >                      
     >        public void renewLock(Jedis jedis) {
     >            Timer timer = new Timer();
     >            timer.schedule(new TimerTask() {
     >                @Override
     >                public void run() {
     >                    if (LOCK_VALUE.equals(jedis.get(LOCK_KEY))) {
     >                        jedis.expire(LOCK_KEY, EXPIRE_TIME);
     >                        System.out.println("Lock renewed.");
     >                    } else {
     >                        timer.cancel();
     >                    }
     >                }
     >            }, EXPIRE_TIME * 500, EXPIRE_TIME * 500); // æ¯ 3.5 ç§’ç»­æœŸä¸€æ¬¡
     >        }
     >                      
     >        public static void main(String[] args) {
     >            Jedis jedis = new Jedis("localhost", 6379);
     >            RedisLockWithRenewal lock = new RedisLockWithRenewal();
     >                      
     >            if (lock.acquireLock(jedis)) {
     >                lock.renewLock(jedis);
     >                try {
     >                    // ä¸šåŠ¡é€»è¾‘
     >                    System.out.println("Lock acquired, performing business logic...");
     >                    Thread.sleep(15000); // æ¨¡æ‹Ÿé•¿æ—¶é—´ä¸šåŠ¡æ‰§è¡Œ
     >                } catch (InterruptedException e) {
     >                    e.printStackTrace();
     >                } finally {
     >                    lock.releaseLock(jedis);
     >                    System.out.println("Lock released.");
     >                }
     >            } else {
     >                System.out.println("Failed to acquire lock.");
     >            }
     >        }
     >    }
     >                      
     >    ```
     >
     > **æ³¨æ„äº‹é¡¹**
     >
     > - **é”çš„å”¯ä¸€æ€§**ï¼šç¡®ä¿é”çš„å€¼æ˜¯å”¯ä¸€çš„ï¼Œå¯ä»¥ä½¿ç”¨ UUID æˆ–ä¸šåŠ¡å”¯ä¸€æ ‡è¯†ç¬¦ã€‚
     > - **åŸå­æ€§æ“ä½œ**ï¼šä½¿ç”¨ Redis çš„ Lua è„šæœ¬ä¿è¯é”çš„è·å–å’Œç»­æœŸæ“ä½œçš„åŸå­æ€§ï¼Œä»¥é˜²æ­¢ç«æ€æ¡ä»¶ã€‚

   - **Fencing Token**ï¼š é”æœåŠ¡è¿”å›å•è°ƒé€’å¢ Tokenï¼Œä¸šåŠ¡æ“ä½œæ—¶æ ¡éªŒ Token çš„æ—¶æ•ˆæ€§ï¼ˆå¦‚ ZooKeeper çš„ zxidï¼‰ã€‚



### ğŸ¯ å¦‚æœä¸€ä¸ªä¸šåŠ¡æ‰§è¡Œæ—¶é—´æ¯”è¾ƒé•¿ï¼Œé”è¿‡æœŸäº†æ€ä¹ˆåŠ?

1. **é”è‡ªåŠ¨ç»­æœŸæœºåˆ¶**

   ```java
   // Redisson è‡ªåŠ¨ç»­æœŸç¤ºä¾‹
   RLock lock = redisson.getLock("order_lock");
   lock.lock(); // é»˜è®¤å¯åŠ¨çœ‹é—¨ç‹—çº¿ç¨‹è‡ªåŠ¨ç»­æœŸ
   try {
       // é•¿è€—æ—¶ä¸šåŠ¡ï¼ˆå¦‚ 60s çš„è®¢å•å¤„ç†ï¼‰
   } finally {
       lock.unlock();
   }
   ```

   - **ä¼˜åŠ¿**ï¼šæ— éœ€æ‰‹åŠ¨ç®¡ç† TTLï¼Œé”åœ¨ä¸šåŠ¡å®Œæˆå‰æŒç»­æœ‰æ•ˆã€‚

   - **é™åˆ¶**ï¼šéœ€ç¡®ä¿å®¢æˆ·ç«¯è¿›ç¨‹å­˜æ´»ï¼ˆè‹¥å®¢æˆ·ç«¯å®•æœºï¼Œçœ‹é—¨ç‹—çº¿ç¨‹ç»ˆæ­¢ï¼Œé”ä»ä¼šè¶…æ—¶é‡Šæ”¾ï¼‰ã€‚

2. **åˆ†æ®µé”ä¸é”é™çº§**

   - åˆ†æ®µé”ï¼šå°†å¤§ä»»åŠ¡æ‹†åˆ†ä¸ºå¤šä¸ªå­ä»»åŠ¡ï¼Œæ¯ä¸ªå­ä»»åŠ¡å•ç‹¬åŠ é”ã€‚

     ```Java
     for (int i = 0; i < segments; i++) {
         RLock segmentLock = redisson.getLock("order_lock_" + i);
         segmentLock.lock();
         try {
             // å¤„ç†å­ä»»åŠ¡
         } finally {
             segmentLock.unlock();
         }
     }
     ```

   - é”é™çº§ï¼šå†™é”é‡Šæ”¾å‰è·å–è¯»é”ï¼Œé¿å…é”å®Œå…¨è¿‡æœŸåæ•°æ®ä¸ä¸€è‡´ã€‚

     ```Java
     RReadWriteLock rwLock = redisson.getReadWriteLock("data_lock");
     rwLock.writeLock().lock();
     try {
         // å†™æ“ä½œ
         rwLock.readLock().lock(); // é™çº§ä¸ºè¯»é”
     } finally {
         rwLock.writeLock().unlock();
     }
     // åç»­ç»§ç»­æŒæœ‰è¯»é”
     ```

3. **ä¸šåŠ¡è¶…æ—¶ç†”æ–­**ï¼šç›‘æ§ä¸šåŠ¡è€—æ—¶ï¼šè‹¥ä¸šåŠ¡æ‰§è¡Œè¶…è¿‡é˜ˆå€¼ï¼ˆå¦‚ TTL çš„ 80%ï¼‰ï¼Œè§¦å‘ç†”æ–­å¹¶å›æ»šã€‚

   ```Java
   try {
       Future<?> future = executor.submit(() -> processOrder());
       future.get(ttl * 0.8, TimeUnit.MILLISECONDS); // è®¾ç½®è¶…æ—¶ç­‰å¾…
   } catch (TimeoutException e) {
       future.cancel(true); // ä¸­æ–­ä¸šåŠ¡çº¿ç¨‹
       rollback(); // äº‹åŠ¡å›æ»š
   }
   ```



### ğŸ¯ è‡ªåŠ¨ç»­æœŸæ€ä¹ˆåš?

è‡ªåŠ¨ç»­æœŸå°±æ˜¯â€œçŸ­ç§Ÿçº¦ + å¿ƒè·³ç»­æœŸâ€ã€‚åŠ é”ç”¨çŸ­ TTLï¼ˆå¦‚10â€“30sï¼‰ï¼Œåå°èµ·ä¸€ä¸ªå¿ƒè·³çº¿ç¨‹æ¯ TTL/3 åˆ·æ–°ä¸€æ¬¡è¿‡æœŸæ—¶é—´ï¼Œç›´åˆ°ä»»åŠ¡å®Œæˆæˆ–è¶…è¿‡æœ€å¤§ç§ŸæœŸå°±åœæ­¢ã€‚ç»­æœŸå¿…é¡»æ ¡éªŒâ€œåªæœ‰é”æŒæœ‰è€…æ‰èƒ½ç»­â€ï¼Œç”¨ token + Lua åŸå­æ ¡éªŒã€‚å†é…åˆæœ€å¤§ç§ŸæœŸä¸æ …æ ä»¤ç‰Œï¼Œé˜²â€œé”è¿‡æœŸåæ—§æŒæœ‰è€…ç»§ç»­å†™â€ã€‚

**æ–¹æ¡ˆæ ¸å¿ƒ**

- åˆå§‹ç§Ÿçº¦ï¼šSET key token NX PX=leaseMs è·é”ã€‚

- å¿ƒè·³ç»­æœŸï¼šæ¯ lease/3 å®šæ—¶ç»­æœŸï¼Œç»­åˆ° leaseMsã€‚

- æ ¡éªŒæŒæœ‰è€…ï¼šç»­æœŸå‰å…ˆæ ¡éªŒ key å†…çš„ token æ˜¯å¦è¿˜æ˜¯æˆ‘ã€‚

- æœ€å¤§ç§ŸæœŸï¼šåˆ°è¾¾ä¸Šé™å¼ºåˆ¶åœæ­¢ç»­æœŸï¼ˆé¿å…æ— é™é”ï¼‰ã€‚

- é€€å‡ºæ—¶æœºï¼šä»»åŠ¡ç»“æŸ/ç»­æœŸå¤±è´¥/ä¸å†æŒæœ‰é”/è¶…è¿‡ä¸Šé™ã€‚

**å…³é”®å®ç°ï¼ˆç®€åŒ–ï¼‰**

- è·å–é”

  ```java
  String token = UUID.randomUUID().toString();
  boolean ok = redis.set(key, token, NX, PX, leaseMs);
  if (!ok) return false;
  startRenewal(key, token, leaseMs, maxLeaseMs);
  ```

- ç»­æœŸçº¿ç¨‹ï¼ˆå»ºè®®ç”¨ ScheduledExecutorServiceï¼Œé—´éš” = leaseMs/3ï¼ŒåŠ å…¥éšæœºæŠ–åŠ¨ï¼‰

  ```java
  void startRenewal(String key, String token, long leaseMs, long maxLeaseMs) {
    long begin = System.currentTimeMillis();
    ScheduledFuture<?> future = scheduler.scheduleAtFixedRate(() -> {
      if (System.currentTimeMillis() - begin > maxLeaseMs) { cancel(); return; }
      try {
        Long updated = (Long) jedis.eval(
          "if redis.call('GET', KEYS[1]) == ARGV[1] then " +
          "  return redis.call('PEXPIRE', KEYS[1], ARGV[2]) " +
          "else return 0 end",
          Collections.singletonList(key),
          Arrays.asList(token, String.valueOf(leaseMs))
        );
        if (updated == 0L) { cancel(); } // ä¸å†æŒæœ‰é”
      } catch (Exception e) { /* è®°å½•å¹¶é‡è¯• */ }
    }, leaseMs/3, leaseMs/3, TimeUnit.MILLISECONDS);
    // ä¿å­˜ future, åœ¨ä¸šåŠ¡å®Œæˆæˆ–å¼‚å¸¸æ—¶ cancel
  }
  ```

- é‡Šæ”¾é”ï¼ˆåªå…è®¸æŒæœ‰è€…é‡Šæ”¾ï¼‰

  ```lua
  -- KEYS[1]=lockKey, ARGV[1]=token
  if redis.call('GET', KEYS[1]) == ARGV[1] then
    return redis.call('DEL', KEYS[1])
  else
    return 0
  end
  ```

**Redissonæ€ä¹ˆé…ï¼ˆç°æˆçš„çœ‹é—¨ç‹—ï¼‰**

- Redissonè‡ªå¸¦è‡ªåŠ¨ç»­æœŸï¼ˆwatchdogï¼Œé»˜è®¤30sï¼Œç»­æœŸæ¯10sï¼‰

- é…ç½®è¦ç‚¹ï¼šlockWatchdogTimeout=30_000ï¼ŒçŸ­ä»»åŠ¡å¯ç›´æ¥è®¾ç½® leaseTime å…³é—­çœ‹é—¨ç‹—ï¼›é•¿ä»»åŠ¡èµ°çœ‹é—¨ç‹—æ›´ç¨³ã€‚

- æ€è·¯ä¸ä¸Šé¢ä¸€è‡´ï¼šæ‹¿åˆ°é”â†’çœ‹é—¨ç‹—ç»­æœŸâ†’ä¸šåŠ¡å®Œæˆå unlockã€‚



### ğŸ¯ æ€ä¹ˆä¿è¯é‡Šæ”¾é”çš„ä¸€ä¸ªåŸå­æ€§ï¼Ÿ

1. **Lua è„šæœ¬å®ç°åŸå­æ“ä½œ**

   ```lua
   -- è§£é”è„šæœ¬ï¼šæ ¡éªŒ Value åŒ¹é…ååˆ é™¤ Key
   if redis.call("GET", KEYS[1]) == ARGV[1] then
       return redis.call("DEL", KEYS[1])
   else
       return 0
   end
   ```

   - ä¼˜åŠ¿ï¼š
     - é¿å…éåŸå­æ“ä½œï¼ˆå…ˆ `GET` å `DEL`ï¼‰å¯¼è‡´è¯¯åˆ å…¶ä»–å®¢æˆ·ç«¯çš„é”ã€‚
     - Redis å•çº¿ç¨‹æ‰§è¡Œ Lua è„šæœ¬ï¼Œå¤©ç„¶åŸå­æ€§ã€‚

2. **è¯¯åˆ é”çš„é˜²å¾¡**

   - å”¯ä¸€ Value è®¾è®¡ï¼šä½¿ç”¨ UUID + çº¿ç¨‹ID ä½œä¸º Valueï¼Œç¡®ä¿é”å½’å±å¯éªŒè¯ã€‚

     ```Java
     String lockValue = UUID.randomUUID() + ":" + Thread.currentThread().getId();
     ```



### ğŸ¯ ç”¨Rediså®ç°åˆ†å¸ƒå¼é”ï¼Œä¸»ä»åˆ‡æ¢å¯¼è‡´é”å¤±æ•ˆï¼Œå¦‚ä½•è§£å†³ï¼Ÿ

**æ ¸å¿ƒåŸå› **ï¼š Redis ä¸»ä»å¤åˆ¶æ˜¯**å¼‚æ­¥**çš„ï¼Œä¸»èŠ‚ç‚¹å®•æœºæ—¶å¯èƒ½æœªå°†é”ä¿¡æ¯åŒæ­¥åˆ°ä»èŠ‚ç‚¹ï¼Œå¯¼è‡´æ–°ä¸»èŠ‚ç‚¹ä¸¢å¤±é”ï¼Œå¼•å‘å¹¶å‘é£é™©ã€‚

**è§£å†³æ–¹æ¡ˆ**

1. **Redlock ç®—æ³•ï¼ˆå¤šèŠ‚ç‚¹å¤šæ•°æ´¾ï¼‰**
   - **åŸç†**ï¼šå‘å¤šä¸ªç‹¬ç«‹ Redis èŠ‚ç‚¹åŒæ—¶åŠ é”ï¼Œåªæœ‰ **åŠæ•°ä»¥ä¸ŠèŠ‚ç‚¹æˆåŠŸ** ä¸”æ€»è€—æ—¶ < TTL æ‰ç®—åŠ é”æˆåŠŸã€‚
   
   - **ä¼˜ç‚¹**ï¼šå®¹é”™æ€§å¼ºï¼Œé¿å…å•ç‚¹æ•…éšœã€‚
   
   - **ç¼ºç‚¹**ï¼šéƒ¨ç½²å¤æ‚ï¼Œæ€§èƒ½å¼€é”€å¤§ã€‚
   
   - **é€‚ç”¨åœºæ™¯**ï¼šå¯¹ä¸€è‡´æ€§è¦æ±‚é«˜çš„é‡‘èçº§åœºæ™¯ã€‚
   
2. **Redisson çœ‹é—¨ç‹—æœºåˆ¶ï¼ˆè‡ªåŠ¨ç»­æœŸï¼‰**

   - **åŸç†**ï¼šåŠ é”åå¯åŠ¨åå°çº¿ç¨‹å®šæœŸåˆ·æ–°é”è¿‡æœŸæ—¶é—´ï¼Œé¿å…ä¸šåŠ¡æ‰§è¡ŒæœŸé—´é”å¤±æ•ˆã€‚

   - **ä¼˜ç‚¹**ï¼šç®€åŒ–å¼€å‘ï¼Œæ”¯æŒè‡ªåŠ¨ç»­æœŸå’Œå¯é‡å…¥ã€‚

   - **ç¼ºç‚¹**ï¼šæ— æ³•å®Œå…¨é¿å…ä¸»ä»åˆ‡æ¢é—®é¢˜ã€‚

   - **é€‚ç”¨åœºæ™¯**ï¼šé«˜å¹¶å‘ã€ä½å»¶è¿Ÿåœºæ™¯ï¼ˆå¦‚ç§’æ€ã€è®¢å•ç³»ç»Ÿï¼‰ã€‚

3. **é…ç½®ä¼˜åŒ–ï¼ˆä¸»ä»åŒæ­¥ä¿éšœï¼‰**

   - **åŸç†**ï¼šè®¾ç½® `min-slaves-to-write 1` å’Œ `min-slaves-max-lag 10`ï¼Œç¡®ä¿ä¸»èŠ‚ç‚¹è‡³å°‘æœ‰ä¸€ä¸ªä»èŠ‚ç‚¹åŒæ­¥æ•°æ®ã€‚

   - **ä¼˜ç‚¹**ï¼šå‡å°‘é”ä¸¢å¤±é£é™©ã€‚

   - **ç¼ºç‚¹**ï¼šæ€§èƒ½ä¸‹é™ï¼Œéœ€åˆç†é…ç½®å‚æ•°ã€‚

   - **é€‚ç”¨åœºæ™¯**ï¼šå•èŠ‚ç‚¹éƒ¨ç½²ï¼Œå¯¹ä¸€è‡´æ€§è¦æ±‚ä¸­ç­‰çš„åœºæ™¯ã€‚

4. **é™çº§ Zookeeper åˆ†å¸ƒå¼é”ï¼ˆå¼ºä¸€è‡´ï¼‰**

   - **åŸç†**ï¼šåŸºäº Zookeeper çš„ä¸´æ—¶é¡ºåºèŠ‚ç‚¹å’Œ Watcher æœºåˆ¶å®ç°åˆ†å¸ƒå¼é”ã€‚

   - **ä¼˜ç‚¹**ï¼šå¼ºä¸€è‡´æ€§ï¼Œé”è‡ªåŠ¨é‡Šæ”¾ã€‚

   - **ç¼ºç‚¹**ï¼šæ€§èƒ½ä½ï¼Œè¿ç»´å¤æ‚ã€‚

   - **é€‚ç”¨åœºæ™¯**ï¼šé‡‘èäº¤æ˜“ã€æ”¯ä»˜ç­‰å¼ºä¸€è‡´è¦æ±‚çš„åœºæ™¯ã€‚

 â€œæ ¹æ®ä¸šåŠ¡ä¸€è‡´æ€§è¦æ±‚å’Œæ€§èƒ½éœ€æ±‚ï¼Œé€‰æ‹© Redlock ä¿éšœå®¹é”™ï¼ŒRedisson ç®€åŒ–å®ç°ï¼Œæˆ–é™çº§ Zookeeper å¼ºä¸€è‡´æ–¹æ¡ˆã€‚â€



### ğŸ¯ è®²è®²RedLockç®—æ³• ?

> RedLock æ˜¯ Redis ä½œè€…æå‡ºçš„ä¸€ç§åˆ†å¸ƒå¼é”ç®—æ³•ï¼Œå®ƒé€šè¿‡åœ¨å¤šä¸ª Redis èŠ‚ç‚¹ä¸Šå¹¶è¡ŒåŠ é”ï¼Œå¹¶ä¸”åªè¦è¶…è¿‡åŠæ•°èŠ‚ç‚¹æˆåŠŸï¼Œå°±è®¤ä¸ºè·å–åˆ°é”ã€‚è¿™æ ·å¯ä»¥åœ¨éƒ¨åˆ†èŠ‚ç‚¹å®•æœºçš„æƒ…å†µä¸‹ä»ç„¶ä¿è¯é”çš„å¯ç”¨æ€§ã€‚
>
> ä½† RedLock çš„äº‰è®®ä¹Ÿå¾ˆå¤§ï¼Œå› ä¸ºå®ƒä¾èµ–æ—¶é’Ÿå’Œç½‘ç»œå‡è®¾ï¼Œåœ¨æç«¯æƒ…å†µä¸‹ä»å¯èƒ½å‡ºç°é”çš„å®‰å…¨æ€§é—®é¢˜ã€‚æ‰€ä»¥åœ¨ç”Ÿäº§ä¸­ï¼Œå¦‚æœå¯¹ä¸€è‡´æ€§è¦æ±‚éå¸¸é«˜ï¼Œå¤§å®¶ä¸€èˆ¬ä¼šé€‰ç”¨ ZooKeeper æˆ– etcd çš„åˆ†å¸ƒå¼é”ï¼Œè€Œ Redis é”æ›´é€‚åˆå¯¹æ€§èƒ½æ•æ„Ÿã€å…è®¸å¼±ä¸€è‡´æ€§çš„åœºæ™¯ã€‚

- **æ¦‚å¿µ**ï¼šRedLock æ˜¯ Redis çš„ä½œè€… Salvatore Sanfilippoï¼ˆantirezï¼‰æå‡ºçš„ä¸€ç§åˆ†å¸ƒå¼é”ç®—æ³•ï¼Œç”¨äºåœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­å®ç°å®‰å…¨å¯é çš„é”å®šæœºåˆ¶ï¼Œè§£å†³äº†å•ä¸ª Redis å®ä¾‹é”åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å­˜åœ¨çš„å¯é æ€§é—®é¢˜ã€‚
- ç®—æ³•åŸç†ï¼š
  - **å¤šèŠ‚ç‚¹ç‹¬ç«‹**ï¼šå‡è®¾æœ‰ N ä¸ªå®Œå…¨ç‹¬ç«‹çš„ Redis master èŠ‚ç‚¹ï¼Œè¿™äº›èŠ‚ç‚¹ä¹‹é—´ä¸å­˜åœ¨ä¸»ä»å¤åˆ¶æˆ–å…¶ä»–é›†ç¾¤åè°ƒæœºåˆ¶ï¼Œç¡®ä¿åœ¨æœ€è‹›åˆ»çš„ç¯å¢ƒä¸‹ä¹Ÿèƒ½æ­£å¸¸å·¥ä½œã€‚
  - **è·å–æ—¶é—´æˆ³**ï¼šå®¢æˆ·ç«¯é¦–å…ˆè·å–å½“å‰æ—¶é—´æˆ³ï¼Œå•ä½ä¸ºæ¯«ç§’ï¼Œä½œä¸ºæ•´ä¸ªæ“ä½œçš„èµ·å§‹æ—¶é—´ã€‚
  - **é€ä¸ªè¯·æ±‚é”**ï¼šå®¢æˆ·ç«¯è½®æµä½¿ç”¨ç›¸åŒçš„ key å’Œå…·æœ‰å”¯ä¸€æ€§çš„ valueï¼ˆå¦‚ UUIDï¼‰åœ¨ N ä¸ª Redis èŠ‚ç‚¹ä¸Šè¯·æ±‚é”ï¼Œæ¯ä¸ªè¯·æ±‚éƒ½è®¾ç½®ä¸€ä¸ªè¿œå°äºé”é‡Šæ”¾æ—¶é—´çš„è¶…æ—¶æ—¶é—´ï¼Œé¿å…åœ¨æŸä¸ªå®•æ‰çš„èŠ‚ç‚¹ä¸Šé˜»å¡è¿‡é•¿æ—¶é—´ã€‚
  - **åˆ¤æ–­é”è·å–æƒ…å†µ**ï¼šå®¢æˆ·ç«¯è·å–æ‰€æœ‰èŠ‚ç‚¹é”åï¼Œè®¡ç®—è·å–é”çš„æ€»æ—¶é—´ï¼Œå³å½“å‰æ—¶é—´å‡å»èµ·å§‹æ—¶é—´ã€‚å½“ä¸”ä»…å½“ä»å¤§å¤šæ•°ï¼ˆN/2 + 1 ä¸ªï¼‰Redis èŠ‚ç‚¹éƒ½å–åˆ°é”ï¼Œå¹¶ä¸”æ€»æ—¶é—´å°äºé”çš„å¤±æ•ˆæ—¶é—´æ—¶ï¼Œæ‰è®¤ä¸ºè·å–é”æˆåŠŸã€‚
  - **è®¡ç®—æœ‰æ•ˆæ—¶é—´**ï¼šå¦‚æœè·å–é”æˆåŠŸï¼Œé”çš„çœŸæ­£æœ‰æ•ˆæ—¶é—´æ˜¯è®¾ç½®çš„é”æ€»è¶…æ—¶æ—¶é—´ï¼ˆTTLï¼‰å‡å»è·å–é”çš„æ€»æ—¶é—´ï¼Œå†å‡å»æ—¶é’Ÿæ¼‚ç§»æ—¶é—´ï¼ˆé€šå¸¸å¯å¿½ç•¥ä¸è®¡ï¼‰ã€‚
  - **é‡Šæ”¾é”**ï¼šå¦‚æœé”è·å–å¤±è´¥ï¼Œæ— è®ºåŸå› æ˜¯è·å–æˆåŠŸçš„é”æ•°é‡ä¸è¶³è¿˜æ˜¯æ€»æ¶ˆè€—æ—¶é—´è¶…è¿‡é”é‡Šæ”¾æ—¶é—´ï¼Œå®¢æˆ·ç«¯éƒ½ä¼šåˆ°æ¯ä¸ª master èŠ‚ç‚¹ä¸Šé‡Šæ”¾é”ï¼ŒåŒ…æ‹¬é‚£äº›æ²¡æœ‰è·å–é”æˆåŠŸçš„èŠ‚ç‚¹ã€‚
- ä¼˜ç‚¹ï¼š
  - **é«˜å¯é æ€§**ï¼šé€šè¿‡å¤šä¸ªç‹¬ç«‹èŠ‚ç‚¹æ¥è·å–é”ï¼Œå³ä½¿éƒ¨åˆ†èŠ‚ç‚¹å‡ºç°æ•…éšœï¼Œåªè¦å¤§å¤šæ•°èŠ‚ç‚¹æ­£å¸¸å·¥ä½œï¼Œå°±èƒ½ä¿è¯é”çš„å®‰å…¨æ€§å’Œå¯ç”¨æ€§ï¼Œæœ‰æ•ˆé˜²æ­¢å•ç‚¹æ•…éšœã€‚
  - **æ»¡è¶³åˆ†å¸ƒå¼é”ç‰¹æ€§**ï¼šèƒ½æ»¡è¶³äº’æ–¥æ€§ã€é˜²æ­»é”ã€æŒé”äººè§£é”ç­‰åˆ†å¸ƒå¼é”çš„åŸºæœ¬ç‰¹æ€§ï¼Œé€‚ç”¨äºå„ç§éœ€è¦åˆ†å¸ƒå¼é”çš„åœºæ™¯ã€‚
- ç¼ºç‚¹ï¼š
  - **å¯¹æ—¶é’ŸåŒæ­¥è¦æ±‚é«˜**ï¼šæ‰€æœ‰ Redis æœåŠ¡å™¨çš„æ—¶é’Ÿå¿…é¡»åŒæ­¥ï¼Œå¦åˆ™å¯èƒ½ç”±äºæ—¶é’Ÿæ¼‚ç§»å¯¼è‡´é”çš„æœ‰æ•ˆæ—¶é—´è®¡ç®—é”™è¯¯ï¼Œä»è€Œå¼•å‘é—®é¢˜ã€‚
  - **æ€§èƒ½å¼€é”€**ï¼šéœ€è¦ä¸å¤šä¸ª Redis èŠ‚ç‚¹è¿›è¡Œé€šä¿¡æ¥è·å–å’Œé‡Šæ”¾é”ï¼Œç›¸æ¯”å•èŠ‚ç‚¹åˆ†å¸ƒå¼é”ï¼Œæ€§èƒ½ä¸Šæœ‰ä¸€å®šçš„å¼€é”€ã€‚
  - **ç½‘ç»œåˆ†åŒºé—®é¢˜**ï¼šåœ¨ç½‘ç»œåˆ†åŒºçš„æƒ…å†µä¸‹ï¼Œå¯èƒ½ä¼šå‡ºç°ä¸åŒåˆ†åŒºçš„èŠ‚ç‚¹å¯¹é”çš„çŠ¶æ€åˆ¤æ–­ä¸ä¸€è‡´ï¼Œå¯¼è‡´é”çš„å®‰å…¨æ€§æ— æ³•ä¿è¯ã€‚

Redlock ç®—æ³•çš„æ³¨æ„äº‹é¡¹ï¼š

- **å¤šæ•°èŠ‚ç‚¹**ï¼šå®¢æˆ·ç«¯å¿…é¡»è‡³å°‘åœ¨å¤§å¤šæ•° Redis å®ä¾‹ä¸ŠæˆåŠŸè·å–é”ï¼Œæ‰èƒ½è®¤ä¸ºè·å¾—äº†åˆ†å¸ƒå¼é”ã€‚
- **æ—¶é’ŸåŒæ­¥**ï¼šæ‰€æœ‰ Redis æœåŠ¡å™¨çš„æ—¶é’Ÿå¿…é¡»åŒæ­¥ï¼Œä»¥é¿å…ç”±äºæ—¶é’Ÿæ¼‚ç§»å¯¼è‡´çš„é—®é¢˜ã€‚
- **ç½‘ç»œåˆ†åŒº**ï¼šåœ¨ç½‘ç»œåˆ†åŒºçš„æƒ…å†µä¸‹ï¼ŒRedlock ç®—æ³•å¯èƒ½æ— æ³•ä¿è¯é”çš„å®‰å…¨ã€‚
- **é”è¶…æ—¶**ï¼šå®¢æˆ·ç«¯å¿…é¡»è®¾ç½®åˆç†çš„é”è¶…æ—¶æ—¶é—´ï¼Œä»¥é¿å…æ­»é”ã€‚
- **é‡è¯•æœºåˆ¶**ï¼šå®¢æˆ·ç«¯éœ€è¦å®ç°é‡è¯•æœºåˆ¶ï¼Œå¹¶åœ¨é‡è¯•æ—¶ç­‰å¾…éšæœºæ—¶é—´ï¼Œä»¥é¿å…å¤šä¸ªå®¢æˆ·ç«¯åŒæ—¶é‡è¯•å¯¼è‡´çš„ç«äº‰æ¡ä»¶ã€‚

------



## å…«ã€æ¶ˆæ¯é˜Ÿåˆ—ä¸å¼‚æ­¥å¤„ç†

### ğŸ¯ ä»€ä¹ˆæ˜¯ Redis æ¶ˆæ¯é˜Ÿåˆ—ï¼Ÿæœ‰å“ªäº›å®ç°æ–¹å¼ï¼Ÿ

Redis æ¶ˆæ¯é˜Ÿåˆ—åˆ©ç”¨ Redis çš„æ•°æ®ç»“æ„ï¼ˆå¦‚ listã€streamï¼‰å®ç°ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹ã€‚å®ç°æ–¹å¼åŒ…æ‹¬ï¼š

- åŸºäº `list` çš„ `LPUSH` å’Œ `RPOP`ï¼ˆç®€å•é˜Ÿåˆ—ï¼‰ã€‚
- åŸºäº `pub/sub` çš„å‘å¸ƒè®¢é˜…æ¨¡å¼ï¼ˆå®æ—¶é€šçŸ¥ï¼‰ã€‚
- åŸºäº `stream` çš„æ¶ˆæ¯æµåŠŸèƒ½ï¼ˆé«˜æ•ˆã€å¯é çš„é˜Ÿåˆ—ï¼‰ã€‚

### ğŸ¯ Redis çš„ `pub/sub` æœºåˆ¶çš„åŸç†æ˜¯ä»€ä¹ˆï¼Ÿä¼˜ç¼ºç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ

åŸç†ï¼š`pub/sub` æ˜¯ä¸€ç§å¹¿æ’­æœºåˆ¶ï¼Œå‘å¸ƒè€…å°†æ¶ˆæ¯å‘é€åˆ°æŒ‡å®šçš„é¢‘é“ï¼Œè®¢é˜…è€…æ¥æ”¶é¢‘é“ä¸­çš„æ¶ˆæ¯ã€‚

ä¼˜ç‚¹ï¼šå®æ—¶æ€§å¼ºï¼Œè½»é‡çº§å®ç°ç®€å•ã€‚

ç¼ºç‚¹ï¼š

- ä¸ä¿è¯æ¶ˆæ¯æŒä¹…åŒ–ã€‚
- æ— æ³•ä¿è¯è®¢é˜…è€…ä¸€å®šèƒ½æ”¶åˆ°æ¶ˆæ¯ï¼ˆç¦»çº¿è®¢é˜…æ— æ•ˆï¼‰ã€‚
- ä¸èƒ½å®ç°å¤æ‚çš„æ¶ˆè´¹åˆ†ç»„éœ€æ±‚ã€‚

### ğŸ¯ Redis Stream æ˜¯ä»€ä¹ˆï¼Ÿä¸ä¼ ç»Ÿé˜Ÿåˆ—æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

Redis Stream æ˜¯ Redis 5.0 å¼•å…¥çš„æ—¥å¿—å‹æ•°æ®ç»“æ„ï¼Œæ”¯æŒæ¶ˆè´¹åˆ†ç»„å’ŒæŒä¹…åŒ–ã€‚

ä¼˜åŠ¿ï¼š

- æ¶ˆæ¯æŒä¹…åŒ–ï¼Œä¿è¯æ¶ˆæ¯å¯é æ€§ã€‚
- æ”¯æŒæ¶ˆè´¹åˆ†ç»„ï¼ˆç±»ä¼¼ Kafka çš„æ¶ˆè´¹æ¨¡å‹ï¼‰ã€‚
- å¯è®°å½•æ¶ˆè´¹åç§»é‡ï¼Œé€‚ç”¨äºå¤æ‚çš„æ¶ˆæ¯é˜Ÿåˆ—åœºæ™¯ã€‚

### ğŸ¯ å¦‚ä½•ç”¨ Redis å®ç°ä¸€ä¸ªå»¶æ—¶é˜Ÿåˆ—ï¼Ÿ

- ä½¿ç”¨ zsetï¼ˆæœ‰åºé›†åˆï¼‰ï¼š
  - å°†ä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´ä½œä¸ºåˆ†å€¼ `score`ï¼Œä»»åŠ¡å†…å®¹ä½œä¸ºæˆå‘˜ `member`ã€‚
  - å®šæœŸæ‰«æ `zset`ï¼Œå–å‡ºåˆ†å€¼å°äºå½“å‰æ—¶é—´çš„ä»»åŠ¡æ‰§è¡Œã€‚

**ç¤ºä¾‹ä¼ªä»£ç ï¼š**

```plaintext
ZADD delay_queue <timestamp> <task>
ZREMRANGEBYSCORE delay_queue -inf <current_time> -> æ‰§è¡Œå¹¶åˆ é™¤åˆ°æœŸä»»åŠ¡
```

### ğŸ¯ Redis æ¶ˆæ¯é˜Ÿåˆ—çš„ç“¶é¢ˆåœ¨å“ªï¼Ÿå¦‚ä½•ä¼˜åŒ–ï¼Ÿ

- ç“¶é¢ˆï¼š
  - å•çº¿ç¨‹å¤„ç†æ¨¡å‹ä¸‹ï¼Œé˜Ÿåˆ—å†™å…¥å’Œè¯»å–çš„é«˜å¹¶å‘å¯èƒ½å¯¼è‡´æ€§èƒ½ç“¶é¢ˆã€‚
  - æ•°æ®é‡å¤§æ—¶ï¼Œå†…å­˜æ¶ˆè€—è¿‡é«˜ã€‚
- ä¼˜åŒ–ï¼š
  - ä½¿ç”¨ Redis Cluster åˆ†ç‰‡å­˜å‚¨é˜Ÿåˆ—ã€‚
  - è°ƒæ•´å†…å­˜ç­–ç•¥æˆ–æ·˜æ±°ç­–ç•¥ï¼ˆå¦‚ `noeviction`ï¼‰ã€‚

### ğŸ¯ ä½¿ç”¨Redisåšè¿‡å¼‚æ­¥é˜Ÿåˆ—å—ï¼Œæ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ

ä½¿ç”¨ list ç±»å‹ä¿å­˜æ•°æ®ä¿¡æ¯ï¼Œrpush ç”Ÿäº§æ¶ˆæ¯ï¼Œlpop æ¶ˆè´¹æ¶ˆæ¯ï¼Œå½“ lpop æ²¡æœ‰æ¶ˆæ¯æ—¶ï¼Œå¯ä»¥ sleep ä¸€æ®µæ—¶é—´ï¼Œç„¶åå†æ£€æŸ¥æœ‰æ²¡æœ‰ä¿¡æ¯ï¼Œå¦‚æœä¸æƒ³ sleep çš„è¯ï¼Œå¯ä»¥ä½¿ç”¨ blpopï¼Œåœ¨æ²¡æœ‰ä¿¡æ¯çš„æ—¶å€™ï¼Œä¼šä¸€ç›´é˜»å¡ï¼Œç›´åˆ°ä¿¡æ¯çš„åˆ°æ¥ã€‚redis å¯ä»¥é€šè¿‡ pub/sub ä¸»é¢˜è®¢é˜…æ¨¡å¼å®ç°ä¸€ä¸ªç”Ÿäº§è€…ï¼Œå¤šä¸ªæ¶ˆè´¹è€…ï¼Œå½“ç„¶ä¹Ÿå­˜åœ¨ä¸€å®šçš„ç¼ºç‚¹ï¼Œå½“æ¶ˆè´¹è€…ä¸‹çº¿æ—¶ï¼Œç”Ÿäº§çš„æ¶ˆæ¯ä¼šä¸¢å¤±ã€‚

### ğŸ¯ Rediså¦‚ä½•å®ç°å»¶æ—¶é˜Ÿåˆ—

ä½¿ç”¨ Redis ä½œä¸ºå»¶æ—¶é˜Ÿåˆ—çš„å®ç°æ–¹æ³•æœ‰å¾ˆå¤šï¼Œå…¶ä¸­ä¸€ç§å¸¸è§çš„æ–¹å¼æ˜¯ä½¿ç”¨ Redis çš„æœ‰åºé›†åˆï¼ˆSorted Setï¼‰ã€‚æœ‰åºé›†åˆé€šè¿‡æˆå‘˜çš„åˆ†æ•°è¿›è¡Œæ’åºï¼Œéå¸¸é€‚åˆå®ç°å»¶æ—¶é˜Ÿåˆ—åŠŸèƒ½ã€‚

**å®ç°æ­¥éª¤**

1. **æ·»åŠ ä»»åŠ¡åˆ°å»¶æ—¶é˜Ÿåˆ—**ï¼š å°†ä»»åŠ¡æ·»åŠ åˆ° Redis æœ‰åºé›†åˆä¸­ï¼Œä½¿ç”¨ä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´ä½œä¸ºåˆ†æ•°ã€‚æ‰§è¡Œæ—¶é—´å¯ä»¥ä½¿ç”¨ Unix æ—¶é—´æˆ³è¡¨ç¤ºã€‚
2. **è½®è¯¢æ£€æŸ¥å’Œæ‰§è¡Œä»»åŠ¡**ï¼š ä½¿ç”¨ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼ˆå¦‚æ¯ç§’è¿è¡Œä¸€æ¬¡ï¼‰æ¥è½®è¯¢æ£€æŸ¥æœ‰åºé›†åˆä¸­æ˜¯å¦æœ‰éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡ã€‚å½“ä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´å°äºç­‰äºå½“å‰æ—¶é—´æ—¶ï¼Œæ‰§è¡Œè¯¥ä»»åŠ¡å¹¶å°†å…¶ä»é›†åˆä¸­ç§»é™¤ã€‚

> ä½¿ç”¨ sortedsetï¼Œä½¿ç”¨æ—¶é—´æˆ³åš scoreï¼Œæ¶ˆæ¯å†…å®¹ä½œä¸º keyï¼Œè°ƒç”¨ zadd æ¥ç”Ÿäº§æ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…ä½¿ç”¨ zrangbyscore è·å– n ç§’ä¹‹å‰çš„æ•°æ®åšè½®è¯¢å¤„ç†ã€‚

------

## ä¹ã€å®æˆ˜åº”ç”¨ä¸æœ€ä½³å®è·µ

### ğŸ¯ Redisä¹è§‚é”çš„åº”ç”¨åœºæ™¯ï¼Œä¸¾ä¾‹è¯´æ˜?

Redis ä¹è§‚é”æ˜¯ä¸€ç§ç”¨äºå¹¶å‘æ§åˆ¶çš„æœºåˆ¶ï¼Œä¸»è¦ç”¨äºåœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ç¡®ä¿æ•°æ®ä¸€è‡´æ€§ã€‚ä¸æ‚²è§‚é”ä¸åŒï¼Œä¹è§‚é”å‡è®¾å¤§éƒ¨åˆ†æƒ…å†µä¸‹æ•°æ®ç«äº‰ä¸ä¼šå‘ç”Ÿï¼Œå› æ­¤ä¸ä¼šåƒæ‚²è§‚é”é‚£æ ·é˜»å¡å…¶ä»–æ“ä½œã€‚ä¹è§‚é”é€šè¿‡æ£€æŸ¥æ•°æ®çš„ç‰ˆæœ¬å·æˆ–å…¶ä»–æ ‡è¯†ç¬¦ï¼Œåœ¨æ›´æ–°æ•°æ®æ—¶ç¡®ä¿æ•°æ®æ²¡æœ‰è¢«å…¶ä»–äº‹åŠ¡ä¿®æ”¹ã€‚

Redis çš„ä¹è§‚é”å¯ä»¥é€šè¿‡äº‹åŠ¡ä¸­çš„ **`WATCH`** å‘½ä»¤å®ç°ã€ä¹Ÿå¯ä»¥åŸºäºç±»ä¼¼ CASï¼ˆCompare and Swapï¼‰ çš„æœºåˆ¶ï¼ŒæŠŠ GETã€SET æ”¾å…¥ lua è„šæœ¬ä¸­æ‰§è¡Œã€‚

```lua
-- KEYS[1] = key åç§°
-- ARGV[1] = æœŸæœ›çš„æ—§å€¼
-- ARGV[2] = è¦è®¾ç½®çš„æ–°å€¼

local current = redis.call('GET', KEYS[1])
if current == ARGV[1] then
    return redis.call('SET', KEYS[1], ARGV[2])
else
    return nil  -- è¡¨ç¤ºå¤±è´¥
end
```

æ¯”å¦‚**åº“å­˜æ‰£å‡ï¼ˆç”µå•†ç§’æ€åœºæ™¯ï¼‰**ã€**è®¡æ•°å™¨æ›´æ–°ï¼ˆç½‘ç«™è®¿é—®ç»Ÿè®¡ï¼‰**ã€**é…ç½®çƒ­æ›´æ–°ï¼ˆåˆ†å¸ƒå¼æœåŠ¡é…ç½®åŒæ­¥ï¼‰**ç­‰

**ä¹è§‚é”åº”ç”¨åœºæ™¯**

ä¹è§‚é”åœ¨éœ€è¦é«˜å¹¶å‘ã€é«˜æ€§èƒ½å’Œæ•°æ®ä¸€è‡´æ€§çš„åº”ç”¨åœºæ™¯ä¸­éå¸¸æœ‰ç”¨ã€‚ä»¥ä¸‹æ˜¯å‡ ä¸ªå…¸å‹çš„åº”ç”¨åœºæ™¯ï¼š

1. **åº“å­˜ç®¡ç†**ï¼š
   - åœ¨ç”µå•†å¹³å°ä¸­ï¼Œå•†å“åº“å­˜æ•°é‡çš„æ›´æ–°å°±æ˜¯ä¸€ä¸ªå…¸å‹çš„ä¹è§‚é”åº”ç”¨åœºæ™¯ã€‚å½“ç”¨æˆ·ä¸‹å•æ—¶ï¼Œç³»ç»Ÿé¦–å…ˆè¯»å–åº“å­˜æ•°é‡ï¼Œç„¶åå°è¯•å‡å»ç›¸åº”çš„æ•°é‡ã€‚è¿™ä¸ªè¿‡ç¨‹å¯ä»¥é€šè¿‡`WATCH`å‘½ä»¤å’Œäº‹åŠ¡ä¸­çš„`MULTI`/`EXEC`å‘½ä»¤æ¥å®ç°ã€‚å¦‚æœåº“å­˜æ•°é‡åœ¨è¯»å–å’Œæ›´æ–°ä¹‹é—´è¢«å…¶ä»–äº‹åŠ¡ä¿®æ”¹äº†ï¼Œäº‹åŠ¡å°†å¤±è´¥ï¼Œç”¨æˆ·ä¼šè¢«æç¤ºåº“å­˜ä¸è¶³ã€‚
2. **è®¢å•å·ç”Ÿæˆ**ï¼š
   - åœ¨éœ€è¦ç”Ÿæˆå”¯ä¸€è®¢å•å·çš„ç³»ç»Ÿä¸­ï¼Œå¯ä»¥ä½¿ç”¨Redisçš„åŸå­è‡ªå¢æ“ä½œ`INCR`æˆ–`INCRBY`ã€‚ä¹è§‚é”å‡è®¾åœ¨ç”Ÿæˆè®¢å•å·çš„è¿‡ç¨‹ä¸­ä¸å¤ªå¯èƒ½å‡ºç°å†²çªï¼Œå³ä½¿å‡ºç°ï¼Œä¹Ÿå¯ä»¥é€šè¿‡é‡è¯•æœºåˆ¶è§£å†³ã€‚
3. **ç§’æ€æ´»åŠ¨**ï¼š
   - ç§’æ€æ´»åŠ¨é€šå¸¸åœ¨æçŸ­çš„æ—¶é—´å†…æœ‰å¤§é‡ç”¨æˆ·å°è¯•è´­ä¹°åŒä¸€å•†å“ã€‚ä½¿ç”¨ä¹è§‚é”ï¼Œç³»ç»Ÿå¯ä»¥å…ˆæ£€æŸ¥åº“å­˜æ•°é‡ï¼Œç„¶åå°è¯•æ›´æ–°ã€‚å¦‚æœåº“å­˜ä¸è¶³ï¼Œå¯ä»¥å¿«é€Ÿè¿”å›å¤±è´¥ä¿¡æ¯ï¼Œè€Œä¸éœ€è¦é”ä½åº“å­˜èµ„æºã€‚
4. **åˆ†å¸ƒå¼åºåˆ—å·ç”Ÿæˆ**ï¼š
   - åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ç”Ÿæˆå…¨å±€å”¯ä¸€çš„åºåˆ—å·æ—¶ï¼Œå¯ä»¥ä½¿ç”¨Redisçš„ä¹è§‚é”ç‰¹æ€§ã€‚é€šè¿‡`INCR`å‘½ä»¤ï¼Œä¸åŒçš„æœåŠ¡å®ä¾‹å¯ä»¥å¹¶å‘åœ°ç”Ÿæˆå”¯ä¸€çš„åºåˆ—å·ï¼Œè€Œä¸éœ€è¦å¤æ‚çš„åè°ƒæœºåˆ¶ã€‚
5. **æŠ•ç¥¨æˆ–ç‚¹èµåŠŸèƒ½**ï¼š
   - åœ¨ç¤¾äº¤åª’ä½“åº”ç”¨ä¸­ï¼Œç”¨æˆ·çš„ç‚¹èµæ“ä½œå¯ä»¥é€šè¿‡Redisçš„ä¹è§‚é”æ¥å®ç°ã€‚ç³»ç»Ÿé¦–å…ˆè¯»å–å½“å‰çš„ç‚¹èµæ•°ï¼Œç„¶åå°†å…¶åŠ ä¸€ã€‚å¦‚æœåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ç‚¹èµæ•°è¢«å…¶ä»–ç”¨æˆ·æ›´æ–°äº†ï¼Œå½“å‰æ“ä½œå¯ä»¥é‡è¯•æˆ–å¿½ç•¥ï¼Œå› ä¸ºç‚¹èµæ•°çš„æœ€ç»ˆä¸€è‡´æ€§é€šå¸¸æ¯”å®æ—¶ä¸€è‡´æ€§æ›´é‡è¦ã€‚
6. **ç¼“å­˜æ•°æ®çš„å¹¶å‘æ›´æ–°**ï¼š
   - å½“å¤šä¸ªæœåŠ¡å®ä¾‹éœ€è¦æ›´æ–°åŒä¸€ä¸ªç¼“å­˜æ•°æ®æ—¶ï¼Œå¯ä»¥ä½¿ç”¨Redisä¹è§‚é”æ¥é¿å…æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ã€‚æ¯ä¸ªå®ä¾‹åœ¨æ›´æ–°å‰å…ˆè¯»å–å½“å‰ç‰ˆæœ¬å·ï¼Œç„¶åå°è¯•æ›´æ–°æ•°æ®å’Œç‰ˆæœ¬å·ã€‚å¦‚æœç‰ˆæœ¬å·åœ¨æ›´æ–°è¿‡ç¨‹ä¸­å‘ç”Ÿå˜åŒ–ï¼Œè¯´æ˜æœ‰å…¶ä»–å®ä¾‹å·²ç»æ›´æ–°äº†æ•°æ®ï¼Œå½“å‰æ“ä½œå¯ä»¥æ”¾å¼ƒæˆ–é‡è¯•ã€‚
7. **åˆ†å¸ƒå¼é”**ï¼š
   - è™½ç„¶Redisä¹Ÿå¸¸ç”¨äºå®ç°åˆ†å¸ƒå¼é”ï¼Œä½†åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå¯ä»¥ä½¿ç”¨ä¹è§‚é”çš„æ–¹å¼æ¥å®ç°ä¸€ç§æ›´è½»é‡çº§çš„åˆ†å¸ƒå¼é”ã€‚ä¾‹å¦‚ï¼Œä½¿ç”¨`SETNX`å‘½ä»¤è®¾ç½®ä¸€ä¸ªé”®ï¼Œå¦‚æœæ“ä½œæˆåŠŸï¼Œåˆ™è·å¾—é”ï¼›å¦‚æœå¤±è´¥ï¼Œåˆ™è¡¨ç¤ºé”è¢«å…¶ä»–è¿›ç¨‹æŒæœ‰ã€‚



### ğŸ¯ Redis è¿‡æœŸæ—¶é—´ä¼˜åŒ–ï¼Ÿå¦‚ä½•ç¡®å®šè¿‡æœŸæ—¶é—´ï¼Ÿ

Redis çš„è¿‡æœŸæ—¶é—´ä¼˜åŒ–ä¸»è¦è€ƒè™‘ä¸‰ä¸ªæ–¹é¢ï¼š

1. **é¿å…é›ªå´©**ï¼šè¿‡æœŸæ—¶é—´è¦åŠ éšæœºå› å­ï¼Œé¿å…å¤§æ‰¹é‡ key åŒæ—¶å¤±æ•ˆï¼›
2. **åˆ†åœºæ™¯è®¾å®š TTL**ï¼šå®æ—¶æ€§è¦æ±‚é«˜çš„æ•°æ®è¿‡æœŸæ—¶é—´çŸ­ï¼Œç¨³å®šæ€§é«˜çš„æ•°æ®è¿‡æœŸæ—¶é—´é•¿ï¼Œçƒ­ç‚¹æ•°æ®ç”šè‡³å¯ä»¥ç”¨é€»è¾‘è¿‡æœŸæ¥æ§åˆ¶ï¼›
3. **æ›´æ–°ç­–ç•¥**ï¼šéƒ¨åˆ†æ ¸å¿ƒæ•°æ®å¯ä»¥ä¸ä¾èµ– TTLï¼Œè€Œæ˜¯ç”±ä¸šåŠ¡é€»è¾‘æ¥ä¸»åŠ¨æ›´æ–°ï¼Œä¿è¯æ•°æ®å¯ç”¨æ€§ã€‚

è¿‡æœŸæ—¶é—´çš„ç¡®å®šæ²¡æœ‰å›ºå®šæ ‡å‡†ï¼Œä¸€èˆ¬å–å†³äº**ä¸šåŠ¡èƒ½å®¹å¿çš„æ•°æ®å»¶è¿Ÿ**å’Œ**æ•°æ®åº“èƒ½æ‰¿å—çš„å›æºå‹åŠ›**ã€‚



### ğŸ¯ Redisæ€ä¹ˆç¡®è®¤å‘½ä¸­ç‡?

è¦ç¡®è®¤ Redis çš„ç¼“å­˜å‘½ä¸­ç‡ï¼Œå¯ä»¥ä½¿ç”¨ Redis æä¾›çš„ç»Ÿè®¡ä¿¡æ¯æ¥è¿›è¡Œåˆ†æã€‚Redis æä¾›äº†ä¸€ä¸ªå‘½ä»¤ `INFO`ï¼Œè¯¥å‘½ä»¤ä¼šè¿”å› Redis æœåŠ¡å™¨çš„å„ç§ç»Ÿè®¡å’ŒçŠ¶æ€ä¿¡æ¯ï¼Œå…¶ä¸­åŒ…æ‹¬ä¸ç¼“å­˜å‘½ä¸­ç‡ç›¸å…³çš„ä¸¤ä¸ªå…³é”®æŒ‡æ ‡ï¼š`keyspace_hits` å’Œ `keyspace_misses`ã€‚

ä½¿ç”¨ `INFO stats` å‘½ä»¤è·å–ç»Ÿè®¡ä¿¡æ¯ï¼Œå¯ä»¥çœ‹åˆ°è¿™ä¸¤ä¸ªæŒ‡æ ‡

```sh
> info stats
# Stats
total_connections_received:6119693
total_commands_processed:346700954
instantaneous_ops_per_sec:84
total_net_input_bytes:95242250343
total_net_output_bytes:74348467113
...
keyspace_hits:8337999
keyspace_misses:910002
```

$ \text{å‘½ä¸­ç‡} = \frac{\text{keyspace\_hits}}{\text{keyspace\_hits} + \text{keyspace\_misses}} $

å…¶ä¸­ï¼š

- `keyspace_hits`ï¼šç¼“å­˜å‘½ä¸­çš„æ¬¡æ•°
- `keyspace_misses`ï¼šç¼“å­˜æœªå‘½ä¸­çš„æ¬¡æ•°



### ğŸ¯ ä½¿ç”¨Redisåšè¿‡å¼‚æ­¥é˜Ÿåˆ—å—ï¼Œæ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ

ä½¿ç”¨ list ç±»å‹ä¿å­˜æ•°æ®ä¿¡æ¯ï¼Œrpush ç”Ÿäº§æ¶ˆæ¯ï¼Œlpop æ¶ˆè´¹æ¶ˆæ¯ï¼Œå½“ lpop æ²¡æœ‰æ¶ˆæ¯æ—¶ï¼Œå¯ä»¥ sleep ä¸€æ®µæ—¶é—´ï¼Œç„¶åå†æ£€æŸ¥æœ‰æ²¡æœ‰ä¿¡æ¯ï¼Œå¦‚æœä¸æƒ³ sleep çš„è¯ï¼Œå¯ä»¥ä½¿ç”¨ blpopï¼Œåœ¨æ²¡æœ‰ä¿¡æ¯çš„æ—¶å€™ï¼Œä¼šä¸€ç›´é˜»å¡ï¼Œç›´åˆ°ä¿¡æ¯çš„åˆ°æ¥ã€‚redis å¯ä»¥é€šè¿‡ pub/sub ä¸»é¢˜è®¢é˜…æ¨¡å¼å®ç°ä¸€ä¸ªç”Ÿäº§è€…ï¼Œå¤šä¸ªæ¶ˆè´¹è€…ï¼Œå½“ç„¶ä¹Ÿå­˜åœ¨ä¸€å®šçš„ç¼ºç‚¹ï¼Œå½“æ¶ˆè´¹è€…ä¸‹çº¿æ—¶ï¼Œç”Ÿäº§çš„æ¶ˆæ¯ä¼šä¸¢å¤±ã€‚



### ğŸ¯ Rediså¦‚ä½•å®ç°å»¶æ—¶é˜Ÿåˆ—

ä½¿ç”¨ Redis ä½œä¸ºå»¶æ—¶é˜Ÿåˆ—çš„å®ç°æ–¹æ³•æœ‰å¾ˆå¤šï¼Œå…¶ä¸­ä¸€ç§å¸¸è§çš„æ–¹å¼æ˜¯ä½¿ç”¨ Redis çš„æœ‰åºé›†åˆï¼ˆSorted Setï¼‰ã€‚æœ‰åºé›†åˆé€šè¿‡æˆå‘˜çš„åˆ†æ•°è¿›è¡Œæ’åºï¼Œéå¸¸é€‚åˆå®ç°å»¶æ—¶é˜Ÿåˆ—åŠŸèƒ½ã€‚

**å®ç°æ­¥éª¤**

1. **æ·»åŠ ä»»åŠ¡åˆ°å»¶æ—¶é˜Ÿåˆ—**ï¼š å°†ä»»åŠ¡æ·»åŠ åˆ° Redis æœ‰åºé›†åˆä¸­ï¼Œä½¿ç”¨ä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´ä½œä¸ºåˆ†æ•°ã€‚æ‰§è¡Œæ—¶é—´å¯ä»¥ä½¿ç”¨ Unix æ—¶é—´æˆ³è¡¨ç¤ºã€‚
2. **è½®è¯¢æ£€æŸ¥å’Œæ‰§è¡Œä»»åŠ¡**ï¼š ä½¿ç”¨ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼ˆå¦‚æ¯ç§’è¿è¡Œä¸€æ¬¡ï¼‰æ¥è½®è¯¢æ£€æŸ¥æœ‰åºé›†åˆä¸­æ˜¯å¦æœ‰éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡ã€‚å½“ä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´å°äºç­‰äºå½“å‰æ—¶é—´æ—¶ï¼Œæ‰§è¡Œè¯¥ä»»åŠ¡å¹¶å°†å…¶ä»é›†åˆä¸­ç§»é™¤ã€‚

> ä½¿ç”¨ sortedsetï¼Œä½¿ç”¨æ—¶é—´æˆ³åš scoreï¼Œæ¶ˆæ¯å†…å®¹ä½œä¸º keyï¼Œè°ƒç”¨ zadd æ¥ç”Ÿäº§æ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…ä½¿ç”¨ zrangbyscore è·å– n ç§’ä¹‹å‰çš„æ•°æ®åšè½®è¯¢å¤„ç†ã€‚



### ğŸ¯ Rediså¦‚ä½•åšå†…å­˜ä¼˜åŒ–ï¼Ÿ

å°½å¯èƒ½ä½¿ç”¨æ•£åˆ—è¡¨ï¼ˆhashesï¼‰ï¼Œæ•£åˆ—è¡¨ï¼ˆæ˜¯è¯´æ•£åˆ—è¡¨é‡Œé¢å­˜å‚¨çš„æ•°å°‘ï¼‰ä½¿ç”¨çš„å†…å­˜éå¸¸å°ï¼Œæ‰€ä»¥ä½ åº”è¯¥å°½å¯èƒ½çš„å°†ä½ çš„æ•°æ®æ¨¡å‹æŠ½è±¡åˆ°ä¸€ä¸ªæ•£åˆ—è¡¨é‡Œé¢ã€‚æ¯”å¦‚ä½ çš„webç³»ç»Ÿä¸­æœ‰ä¸€ä¸ªç”¨æˆ·å¯¹è±¡ï¼Œä¸è¦ä¸ºè¿™ä¸ªç”¨æˆ·çš„åç§°ï¼Œå§“æ°ï¼Œé‚®ç®±ï¼Œå¯†ç è®¾ç½®å•ç‹¬çš„keyï¼Œè€Œæ˜¯åº”è¯¥æŠŠè¿™ä¸ªç”¨æˆ·çš„æ‰€æœ‰ä¿¡æ¯å­˜å‚¨åˆ°ä¸€å¼ æ•£åˆ—è¡¨é‡Œé¢ã€‚



### ğŸ¯ Redis ä½¿ç”¨è¯¯åŒºï¼Ÿ

Redisæœ€å¤§çš„é—®é¢˜ä¸æ˜¯â€œä¸ä¼šç”¨â€ï¼Œè€Œæ˜¯â€œç”¨å¾—åƒå†…å­˜ç‰ˆMySQLâ€ã€‚çº¿ä¸Šå¸¸è§å‘é›†ä¸­åœ¨ï¼šå¤§Key/çƒ­Keyã€é˜»å¡å‘½ä»¤ã€è¿‡æœŸé£æš´ã€æŒä¹…åŒ–/é›†ç¾¤è¯¯è§£ã€åˆ†å¸ƒå¼é”è¯¯ç”¨ã€å†…å­˜æ·˜æ±°ä¸åˆ é™¤æ–¹å¼ã€ä»¥åŠç¼ºä¹å¯è§‚æµ‹æ€§ã€‚åšæ³•ä¸Šéµå¾ªï¼šå°Key+åˆ†ç‰‡ã€æ—è·¯ç¼“å­˜+é™æµã€TTLæŠ–åŠ¨+é€»è¾‘è¿‡æœŸã€UNLINK/SCANã€AOF everysec+RDBã€åªå…è®¸æŒæœ‰è€…è§£é”+ç»­æœŸã€Cluster key-tagã€ä»¥åŠæŒ‡æ ‡å‘Šè­¦ã€‚

**é”®è¿‡å¤§**

Redisçš„keyæ˜¯stringç±»å‹ï¼Œæœ€å¤§å¯ä»¥æ˜¯512MBï¼Œé‚£ä¹ˆå®é™…ä¸­æ˜¯ä¸æ˜¯ä¹Ÿå¯ä»¥è¿™æ ·ç”¨å‘¢ï¼Ÿç­”æ¡ˆæ˜¯å¦å®šçš„ï¼Œrediså°†keyä¿å­˜åœ¨ä¸€ä¸ªå…¨å±€çš„hashtableï¼Œå¦‚æœkeyè¿‡å¤§ï¼Œä¸€æ˜¯å ç”¨è¿‡å¤šçš„å†…å­˜ï¼ŒäºŒæ˜¯è®¡ç®—hashå’Œå­—ç¬¦ä¸²æ¯”è¾ƒéƒ½ä¼šæ›´è€—æ—¶ï¼›ä¸€èˆ¬å»ºè®®keyçš„å¤§å°ä¸è¶…è¿‡2kBã€‚

**Big key**

æˆ–è€…è¯´æ˜¯big valueï¼Œè¿™ä¼šå¯¼è‡´åˆ é™¤keyçš„æ“ä½œæ¯”è¾ƒè€—æ—¶ï¼Œä¼šé˜»å¡ä¸»çº¿ç¨‹ã€‚æ¯”å¦‚æœ‰äº›åŒå­¦å–œæ¬¢ç”¨é›†åˆç±»çš„å¯¹è±¡ï¼ŒåŠ¨è¾„ä¸Šç™¾ä¸‡çš„å…ƒç´ ã€‚å¯¹äºè¿™ç±»è¶…å¤§é›†åˆï¼Œä¸€èˆ¬æœ‰ä¸¤ç§ä¼˜åŒ–æ–¹æ¡ˆï¼Œä¸€æ˜¯é‡‡å–åˆ†ç‰‡çš„æ–¹å¼ï¼Œå°†æ¯ä¸ªé›†åˆåˆ†ç‰‡æ§åˆ¶åœ¨è¾ƒå°çš„èŒƒå›´å†…ï¼Œæ¯”å¦‚å°äº1000ä¸ªå…ƒç´ ï¼›äºŒæ˜¯èµ·ä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡ï¼Œå¯¹é›†åˆä¸­çš„å…ƒç´ åˆ†æ‰¹è¿›è¡Œè€åŒ–ã€‚

**å…¨é›†åˆæ‰«æ**

æ¯”å¦‚åœ¨ä¸šåŠ¡ä»£ç ä½¿ç”¨äº†keys*ï¼Œhgetallï¼Œzrange(0, -1)ç­‰è¿”å›é›†åˆä¸­æ‰€æœ‰å…ƒç´ ï¼Œè¿™äº›éƒ½å±äºé˜»å¡æ“ä½œï¼Œä¸€èˆ¬è€ƒè™‘ç”¨scanï¼Œhscanç­‰è¿­ä»£æ“ä½œä»£æ›¿ã€‚

**å•ä¸ªå®ä¾‹å†…å­˜è¿‡å¤§**

å†…å­˜è¿‡å¤§æœ‰ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿä¸Šæ–‡ä¸­åœ¨è®²åˆ°æŒä¹…åŒ–çš„æ—¶å€™å…¶å®æœ‰è¯´åˆ°ï¼Œæ— è®ºæ˜¯ç”ŸæˆRDBæ–‡ä»¶ï¼Œè¿˜æ˜¯AOFé‡å†™ï¼Œéƒ½æ˜¯è¦å¯¹æ•´ä¸ªå®ä¾‹çš„å†…å­˜æ•°æ®è¿›è¡Œæ‰«æï¼Œéå¸¸æ¶ˆè€—CPUå’Œç£ç›˜èµ„æºï¼›å½“ä½¿ç”¨Backgroudæ–¹å¼åˆ›å»ºå­è¿›ç¨‹æ—¶ä¹Ÿä¼šæ¶‰åŠåˆ°å†…å­˜ç©ºé—´çš„æ‹·è´ï¼Œå³ä¾¿ä½¿ç”¨äº†COWæœºåˆ¶ï¼Œä¹Ÿä¼šå ç”¨ç›¸å½“çš„å†…å­˜å¼€é”€ã€‚å¦å¤–ï¼Œåœ¨ä¸»ä»å¤åˆ¶çš„ç¬¬ä¸€é˜¶æ®µï¼Œsaveã€ä¼ è¾“å’ŒåŠ è½½RDBæ–‡ä»¶çš„å¼€é”€ï¼Œä¹Ÿä¼šéšç€RDBæ–‡ä»¶çš„å˜å¤§è€Œå˜å¤§ã€‚å½“å•ä¸ªå®ä¾‹è¾¾åˆ°ç“¶é¢ˆæ—¶ï¼Œæ›´å¥½çš„è§£å†³æ–¹æ¡ˆåº”è¯¥æ˜¯é‡‡ç”¨é›†ç¾¤æ–¹æ¡ˆã€‚

**å¤§é‡keyåŒæ—¶è¿‡æœŸ**

redisåˆ é™¤è¿‡æœŸé”®é‡‡ç”¨äº†æƒ°æ€§åˆ é™¤å’Œå®šæœŸåˆ é™¤ç›¸ç»“åˆçš„ç­–ç•¥ï¼Œæƒ°æ€§åˆ é™¤åˆ™æ˜¯åœ¨æ¯æ¬¡GET/SETæ“ä½œæ—¶å»åˆ ï¼Œå®šæœŸåˆ é™¤ï¼Œåˆ™æ˜¯åœ¨æ—¶é—´äº‹ä»¶ä¸­ï¼Œä»æ•´ä¸ªkeyç©ºé—´éšæœºå–æ ·ï¼Œç›´åˆ°è¿‡æœŸé”®æ¯”ç‡å°äº25%ï¼Œå¦‚æœåŒæ—¶æœ‰å¤§é‡keyè¿‡æœŸçš„è¯ï¼Œæå¯èƒ½å¯¼è‡´ä¸»çº¿ç¨‹é˜»å¡ã€‚ä¸€èˆ¬å¯ä»¥é€šè¿‡åšæ•£åˆ—æ¥ä¼˜åŒ–å¤„ç†ã€‚



### ğŸ¯ Redis ä¸­çš„ç®¡é“æœ‰ä»€ä¹ˆç”¨?

Redis ä¸­çš„ç®¡é“ï¼ˆPipeliningï¼‰æ˜¯ä¸€ç§ä¼˜åŒ–æŠ€æœ¯ï¼Œå…è®¸å®¢æˆ·ç«¯åœ¨ä¸€æ¬¡ç½‘ç»œå¾€è¿”ä¸­å‘é€å¤šä¸ªå‘½ä»¤ï¼Œè€Œä¸æ˜¯æ¯ä¸ªå‘½ä»¤å‘é€ä¸€æ¬¡ã€‚è¿™ç§æ–¹æ³•å‡å°‘äº†ç½‘ç»œå»¶è¿Ÿï¼Œæé«˜äº†ååé‡å’Œæ€§èƒ½ã€‚

**ç®¡é“çš„å·¥ä½œåŸç†**

åœ¨ä½¿ç”¨ç®¡é“æ—¶ï¼Œå®¢æˆ·ç«¯ä¼šå°†ä¸€ç³»åˆ—å‘½ä»¤æ‰“åŒ…ï¼Œç„¶åä¸€æ¬¡æ€§å‘é€ç»™ Redis æœåŠ¡å™¨ã€‚æœåŠ¡å™¨æ‰§è¡Œè¿™äº›å‘½ä»¤åï¼Œå°†ç»“æœä¸€æ¬¡æ€§è¿”å›ç»™å®¢æˆ·ç«¯ã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯å‡å°‘äº†å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´çš„ç½‘ç»œå¾€è¿”æ¬¡æ•°ï¼Œä»è€Œæé«˜äº†æ€§èƒ½ã€‚

```python
import redis

# åˆ›å»º Redis è¿æ¥
r = redis.Redis(host='localhost', port=6379, db=0)

# åˆ›å»ºç®¡é“å¯¹è±¡
pipe = r.pipeline()

# æ‰¹é‡æ·»åŠ å‘½ä»¤åˆ°ç®¡é“
pipe.set('key1', 'value1')
pipe.set('key2', 'value2')
pipe.get('key1')
pipe.get('key2')

# æ‰§è¡Œç®¡é“ä¸­çš„æ‰€æœ‰å‘½ä»¤
results = pipe.execute()

# æ‰“å°ç»“æœ
for result in results:
    print(result)
```

**ç®¡é“çš„ä¼˜ç‚¹**

1. **å‡å°‘ç½‘ç»œå»¶è¿Ÿ**ï¼šé€šè¿‡ä¸€æ¬¡æ€§å‘é€å¤šä¸ªå‘½ä»¤ï¼Œå‡å°‘äº†å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´çš„ç½‘ç»œå¾€è¿”æ¬¡æ•°ï¼Œä»è€Œå‡å°‘äº†ç½‘ç»œå»¶è¿Ÿã€‚
2. **æé«˜ååé‡**ï¼šç”±äºå‡å°‘äº†æ¯ä¸ªå‘½ä»¤çš„ç½‘ç»œå¼€é”€ï¼ŒæœåŠ¡å™¨å¯ä»¥æ›´å¿«åœ°å¤„ç†æ›´å¤šçš„å‘½ä»¤ï¼Œä»è€Œæé«˜äº†ç³»ç»Ÿçš„ååé‡ã€‚
3. **åŸå­æ€§æ“ä½œ**ï¼šç®¡é“ä¸­çš„æ‰€æœ‰å‘½ä»¤æ˜¯æŒ‰é¡ºåºæ‰§è¡Œçš„ï¼Œä½†å®ƒä»¬ä¹‹é—´ä¸æ˜¯åŸå­æ“ä½œã€‚å¦‚æœéœ€è¦åŸå­æ€§ï¼Œå¯ä»¥ä½¿ç”¨äº‹åŠ¡ï¼ˆMULTI/EXECï¼‰ã€‚

**ç®¡é“çš„é™åˆ¶**

1. **éåŸå­æ€§**ï¼šç®¡é“ä¸­çš„å‘½ä»¤ä¸æ˜¯åŸå­æ“ä½œï¼Œå¦‚æœéœ€è¦åŸå­æ€§ï¼Œéœ€è¦ä½¿ç”¨äº‹åŠ¡ã€‚
2. **é”™è¯¯å¤„ç†**ï¼šç®¡é“æ‰§è¡Œä¸­ï¼Œå¦‚æœæŸä¸ªå‘½ä»¤å‡ºé”™ï¼ŒRedis æœåŠ¡å™¨ä¸ä¼šç«‹å³è¿”å›é”™è¯¯ï¼Œè€Œæ˜¯ç»§ç»­æ‰§è¡Œå‰©ä½™çš„å‘½ä»¤ã€‚å®¢æˆ·ç«¯åœ¨æ¥æ”¶åˆ°ç»“æœæ—¶ï¼Œéœ€è¦æ£€æŸ¥æ¯ä¸ªå‘½ä»¤çš„æ‰§è¡Œç»“æœã€‚

**é«˜çº§ç”¨æ³•**

1. **äº‹åŠ¡ä¸­çš„ç®¡é“**ï¼š ç®¡é“å¯ä»¥ä¸äº‹åŠ¡ä¸€èµ·ä½¿ç”¨ï¼Œç¡®ä¿ä¸€ç»„å‘½ä»¤åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ä¸è¢«å…¶ä»–å‘½ä»¤æ‰“æ–­ã€‚

   ```python
   pipe = r.pipeline(transaction=True)
   ```

2. **æ‰¹é‡æ“ä½œ**ï¼š å¯¹äºéœ€è¦æ‰¹é‡æ“ä½œçš„å¤§é‡æ•°æ®ï¼Œç®¡é“éå¸¸é€‚ç”¨ã€‚ä¾‹å¦‚ï¼Œæ‰¹é‡æ’å…¥æ•°æ®æˆ–æ‰¹é‡è·å–æ•°æ®ã€‚



### ğŸ¯ ä½¿ç”¨Redisç»Ÿè®¡ç½‘ç«™çš„UVï¼Œåº”è¯¥æ€ä¹ˆåšï¼Ÿ

ä½¿ç”¨ Redis ç»Ÿè®¡ç½‘ç«™çš„ UVï¼ˆUnique Visitorsï¼Œç‹¬ç«‹è®¿å®¢ï¼‰å¯ä»¥é€šè¿‡ HyperLogLog æˆ– Set æ•°æ®ç»“æ„æ¥å®ç°ã€‚ä»¥ä¸‹æ˜¯ä¸¤ç§æ–¹æ³•çš„å…·ä½“å®ç°æ–¹å¼ï¼š

**æ–¹æ³•ä¸€ï¼šä½¿ç”¨ HyperLogLog ç»Ÿè®¡ UV**

HyperLogLog æ˜¯ä¸€ç§åŸºäºæ¦‚ç‡çš„æ•°æ®ç»“æ„ï¼Œé€‚ç”¨äºå¤§è§„æ¨¡å»é‡è®¡æ•°ã€‚å®ƒä½¿ç”¨å°‘é‡å†…å­˜å°±èƒ½æä¾›é«˜å‡†ç¡®ç‡çš„å»é‡è®¡æ•°ã€‚

**å®ç°æ­¥éª¤**

1. **è®°å½•è®¿é—®**ï¼š æ¯å½“æœ‰ç”¨æˆ·è®¿é—®ç½‘ç«™æ—¶ï¼Œå°†ç”¨æˆ·çš„å”¯ä¸€æ ‡è¯†ï¼ˆä¾‹å¦‚ IP åœ°å€æˆ–ç”¨æˆ· IDï¼‰æ·»åŠ åˆ° HyperLogLog ä¸­ã€‚
2. **è·å– UV**ï¼š ä½¿ç”¨ `PFCOUNT` å‘½ä»¤è·å– HyperLogLog çš„åŸºæ•°ï¼ˆå³ç‹¬ç«‹è®¿å®¢æ•°ï¼‰ã€‚

**ç¤ºä¾‹ä»£ç **

```python
import redis

# åˆ›å»º Redis è¿æ¥
r = redis.Redis(host='localhost', port=6379, db=0)

def record_visit(user_id):
    r.pfadd('site_uv', user_id)

def get_uv():
    return r.pfcount('site_uv')

# ç¤ºä¾‹ï¼šè®°å½•ç”¨æˆ·è®¿é—®
record_visit('user_123')
record_visit('user_456')

# è·å– UV
print(f"Unique Visitors: {get_uv()}")
```

**æ–¹æ³•äºŒï¼šä½¿ç”¨ Set ç»Ÿè®¡ UV**

Set æ˜¯ä¸€ç§é›†åˆæ•°æ®ç»“æ„ï¼Œé€‚ç”¨äºç²¾ç¡®å»é‡è®¡æ•°ã€‚è™½ç„¶ Set çš„å†…å­˜å ç”¨æ¯” HyperLogLog å¤§ï¼Œä½†å®ƒèƒ½ç²¾ç¡®ç»Ÿè®¡ç‹¬ç«‹è®¿å®¢æ•°ã€‚

**å®ç°æ­¥éª¤**

1. **è®°å½•è®¿é—®**ï¼š æ¯å½“æœ‰ç”¨æˆ·è®¿é—®ç½‘ç«™æ—¶ï¼Œå°†ç”¨æˆ·çš„å”¯ä¸€æ ‡è¯†æ·»åŠ åˆ° Set ä¸­ã€‚
2. **è·å– UV**ï¼š ä½¿ç”¨ `SCARD` å‘½ä»¤è·å– Set çš„åŸºæ•°ã€‚

**ç¤ºä¾‹ä»£ç **

```python
import redis

# åˆ›å»º Redis è¿æ¥
r = redis.Redis(host='localhost', port=6379, db=0)

def record_visit(user_id):
    r.sadd('site_uv_set', user_id)

def get_uv():
    return r.scard('site_uv_set')

# ç¤ºä¾‹ï¼šè®°å½•ç”¨æˆ·è®¿é—®
record_visit('user_123')
record_visit('user_456')

# è·å– UV
print(f"Unique Visitors: {get_uv()}")
```

**æ–¹æ³•é€‰æ‹©**

- **HyperLogLog**ï¼šé€‚ç”¨äºå¤§é‡æ•°æ®ä¸”å¯¹å†…å­˜ä½¿ç”¨æ•æ„Ÿçš„åœºæ™¯ã€‚å®ƒä½¿ç”¨å›ºå®šå¤§å°çš„å†…å­˜ï¼ˆçº¦ 12 KBï¼‰ï¼Œä½†ç»Ÿè®¡ç»“æœæœ‰ä¸€å®šè¯¯å·®ï¼ˆè¯¯å·®ç‡çº¦ 0.81%ï¼‰ã€‚
- **Set**ï¼šé€‚ç”¨äºéœ€è¦ç²¾ç¡®ç»Ÿè®¡ç»“æœçš„åœºæ™¯ã€‚å®ƒèƒ½ç²¾ç¡®å»é‡è®¡æ•°ï¼Œä½†å†…å­˜ä½¿ç”¨éšç€æ•°æ®é‡å¢åŠ è€Œå¢åŠ ã€‚



### ğŸ¯ å‡å¦‚ Redis é‡Œé¢æœ‰ **1** äº¿ä¸ª keyï¼Œå…¶ä¸­æœ‰ 10w ä¸ª key æ˜¯ä»¥æŸä¸ªå›ºå®šçš„å·²çŸ¥çš„å‰ç¼€å¼€å¤´çš„ï¼Œå¦‚ä½•å°†å®ƒä»¬å…¨éƒ¨æ‰¾å‡ºæ¥?

ä½¿ç”¨ keys æŒ‡ä»¤å¯ä»¥æ‰«å‡ºæŒ‡å®šæ¨¡å¼çš„ key åˆ—è¡¨ã€‚

å¯¹æ–¹æ¥ç€è¿½é—®:å¦‚æœè¿™ä¸ª redis æ­£åœ¨ç»™çº¿ä¸Šçš„ä¸šåŠ¡æä¾›æœåŠ¡ï¼Œé‚£ä½¿ç”¨ keys æŒ‡ä»¤ä¼šæœ‰ä»€ä¹ˆé—®é¢˜?

è¿™ä¸ªæ—¶å€™ä½ è¦å›ç­” redis å…³é”®çš„ä¸€ä¸ªç‰¹æ€§ï¼šredis çš„å•çº¿ç¨‹çš„ã€‚keys æŒ‡ä»¤ä¼šå¯¼è‡´çº¿ç¨‹é˜»å¡ä¸€æ®µæ—¶é—´ï¼Œçº¿ä¸ŠæœåŠ¡ä¼šåœé¡¿ï¼Œç›´åˆ°æŒ‡ä»¤æ‰§è¡Œå®Œæ¯•ï¼ŒæœåŠ¡æ‰èƒ½æ¢å¤ã€‚è¿™ä¸ªæ—¶å€™å¯ä»¥ä½¿ç”¨ scan æŒ‡ ä»¤ï¼Œscan æŒ‡ä»¤å¯ä»¥æ— é˜»å¡çš„æå–å‡ºæŒ‡å®šæ¨¡å¼çš„ key åˆ—è¡¨ï¼Œä½†æ˜¯ä¼šæœ‰ä¸€å®šçš„é‡å¤æ¦‚ç‡ï¼Œåœ¨å®¢æˆ·ç«¯åšä¸€æ¬¡å»é‡å°±å¯ä»¥äº†ï¼Œä½†æ˜¯æ•´ä½“æ‰€èŠ±è´¹çš„æ—¶é—´ä¼šæ¯”ç›´æ¥ç”¨ keys æŒ‡ä»¤é•¿ã€‚



## References

- https://juejin.im/post/6844904017387077640

- https://www.wmyskxz.com/2020/03/25/dong-yi-dian-python-xi-lie-kuai-su-ru-men-1/#toc-heading-22

- https://mp.weixin.qq.com/s/f9N13fnyTtnu2D5sKZiu9w

- https://blog.csdn.net/ThinkWon/article/details/103522351/

