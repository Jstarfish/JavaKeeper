2ä¸‡å­—é•¿æ–‡åŒ…æ•™åŒ…ä¼š JVM å†…å­˜ç»“æ„   ä¿å§†çº§å­¦ä¹ æ–‡

> JVM = Japanese Vedio's Man
>
> æœ€è¿‘é¢è¯•äº†å‡ ä¸ªå€™é€‰äººï¼Œç®€å†ä¸Šå†™çš„ç†Ÿæ‚‰ JVMï¼ŒåªçŸ¥é“å †å†…å­˜ã€æ ˆå†…å­˜ï¼Œå°±æ•¢è¯´ç†Ÿæ‚‰äº†
>
> å¸¦ç€é—®é¢˜ï¼Œå°¤å…¶æ˜¯é¢è¯•é—®é¢˜çš„å­¦ä¹ æ‰æ˜¯æœ€é«˜æ•ˆçš„ã€‚åŠ æ²¹ï¼Œå¥¥åˆ©ç»™ï¼
>
> ç‚¹èµ+æ”¶è— å°±å­¦ä¼šç³»åˆ—ï¼Œæ–‡ç« æ”¶å½•åœ¨ GitHub [JavaKeeper](https://github.com/Jstarfish/JavaKeeper) ï¼ŒNçº¿äº’è”ç½‘å¼€å‘å¿…å¤‡æŠ€èƒ½å…µå™¨è°±

## ç›´å‡»é¢è¯•

- ä¸¾ä¾‹æ ˆæº¢å‡ºçš„æƒ…å†µï¼Ÿ
- è°ƒæ•´æ ˆå¤§å°ï¼Œå°±èƒ½ä¿å­˜ä¸å‡ºç°æº¢å‡ºå—ï¼Ÿ
- åˆ†é…çš„æ ˆå†…å­˜è¶Šå¤§è¶Šå¥½å—ï¼Ÿ
- åƒåœ¾å›æ”¶æ˜¯å¦ä¼šæ¶‰åŠåˆ°è™šæ‹Ÿæœºæ ˆï¼Ÿ
- æ–¹æ³•ä¸­å®šä¹‰çš„å±€éƒ¨å˜é‡æ˜¯å¦çº¿ç¨‹å®‰å…¨ï¼Ÿ

------



# è¿è¡Œæ—¶æ•°æ®åŒº

Java è™šæ‹Ÿæœºå®šä¹‰äº†åœ¨è¿è¡ŒæœŸé—´ä½¿ç”¨çš„å„ç§è¿è¡Œæ—¶æ•°æ®åŒºåŸŸ

å†…å­˜æ˜¯éå¸¸é‡è¦çš„ç³»ç»Ÿèµ„æºï¼Œæ˜¯ç¡¬ç›˜å’ŒCPUçš„ä¸­é—´ä»“åº“åŠæ¡¥æ¢ï¼Œæ‰¿è½½ç€æ“ä½œç³»ç»Ÿå’Œåº”ç”¨ç¨‹åºçš„å®æ—¶è¿è¡Œã€‚JVM å†…å­˜å¸ƒå±€è§„å®šäº† Java åœ¨è¿è¡Œè¿‡ç¨‹ä¸­å†…å­˜ç”³è¯·ã€åˆ†é…ã€ç®¡ç†çš„ç­–ç•¥ï¼Œä¿è¯äº† JVM çš„é«˜æ•ˆç¨³å®šè¿è¡Œã€‚ä¸åŒçš„ JVM å¯¹äºå†…å­˜çš„åˆ’åˆ†æ–¹å¼å’Œç®¡ç†æœºåˆ¶å­˜åœ¨ç€éƒ¨åˆ†å·®å¼‚ã€‚

ä¸‹å›¾æ˜¯ JVM æ•´ä½“æ¶æ„

![jvm-framework](https://tva1.sinaimg.cn/large/0082zybply1gc6fz21n8kj30u00wpn5v.jpg)

Java è™šæ‹Ÿæœºå®šä¹‰äº†è‹¥å¹²ç§ç¨‹åºè¿è¡ŒæœŸé—´ä¼šä½¿ç”¨åˆ°çš„è¿è¡Œæ—¶æ•°æ®åŒºï¼Œå…¶ä¸­æœ‰ä¸€äº›ä¼šéšç€è™šæ‹Ÿæœºå¯åŠ¨è€Œåˆ›å»ºï¼Œéšç€è™šæ‹Ÿæœºé€€å‡ºè€Œé”€æ¯ã€‚å¦å¤–ä¸€äº›åˆ™æ˜¯ä¸çº¿ç¨‹ä¸€ä¸€å¯¹åº”çš„ï¼Œè¿™äº›ä¸çº¿ç¨‹ä¸€ä¸€å¯¹åº”çš„æ•°æ®åŒºåŸŸä¼šéšç€çº¿ç¨‹å¼€å§‹å’Œç»“æŸè€Œåˆ›å»ºå’Œé”€æ¯ã€‚

- çº¿ç¨‹ç§æœ‰ï¼šç¨‹åºè®¡æ•°å™¨ã€æ ˆã€æœ¬åœ°æ ˆ
- çº¿ç¨‹å…±äº«ï¼šå †ã€å †å¤–å†…å­˜ï¼ˆæ°¸ä¹…ä»£æˆ–å…ƒç©ºé—´ã€ä»£ç ç¼“å­˜ï¼‰



> ä¸‹é¢æˆ‘ä»¬å°±æ¥ä¸€ä¸€è§£æ¯’ä¸‹è¿™äº›å†…å­˜åŒºåŸŸï¼Œå…ˆä»æœ€ç®€å•çš„å…¥æ‰‹

## ä¸€ã€ç¨‹åºè®¡æ•°å™¨

ç¨‹åºè®¡æ•°å¯„å­˜å™¨ï¼ˆ**Program Counter Register**ï¼‰ï¼ŒRegister çš„å‘½åæºäº CPU çš„å¯„å­˜å™¨ï¼Œå¯„å­˜å™¨å­˜å‚¨æŒ‡ä»¤ç›¸å…³çš„çº¿ç¨‹ä¿¡æ¯ï¼ŒCPU åªæœ‰æŠŠæ•°æ®è£…è½½åˆ°å¯„å­˜å™¨æ‰èƒ½å¤Ÿè¿è¡Œã€‚

è¿™é‡Œï¼Œå¹¶éæ˜¯å¹¿ä¹‰ä¸Šæ‰€æŒ‡çš„ç‰©ç†å¯„å­˜å™¨ï¼Œå«ç¨‹åºè®¡æ•°å™¨ï¼ˆæˆ–PCè®¡æ•°å™¨æˆ–æŒ‡ä»¤è®¡æ•°å™¨ï¼‰ä¼šæ›´åŠ è´´åˆ‡ï¼Œå¹¶ä¸”ä¹Ÿä¸å®¹æ˜“å¼•èµ·ä¸€äº›ä¸å¿…è¦çš„è¯¯ä¼šã€‚**JVMä¸­çš„PCå¯„å­˜å™¨æ˜¯å¯¹ç‰©ç†PCå¯„å­˜å™¨çš„ä¸€ç§æŠ½è±¡æ¨¡æ‹Ÿ**ã€‚

ç¨‹åºè®¡æ•°å™¨æ˜¯ä¸€å—è¾ƒå°çš„å†…å­˜ç©ºé—´ï¼Œå¯ä»¥çœ‹ä½œæ˜¯å½“å‰çº¿ç¨‹æ‰€æ‰§è¡Œçš„å­—èŠ‚ç çš„**è¡Œå·æŒ‡ç¤ºå™¨**ã€‚



### 1.1 ä½œç”¨

PCå¯„å­˜å™¨ç”¨æ¥å­˜å‚¨æŒ‡å‘ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ï¼Œå³å°†è¦æ‰§è¡Œçš„æŒ‡ä»¤ä»£ç ã€‚ç”±æ‰§è¡Œå¼•æ“è¯»å–ä¸‹ä¸€æ¡æŒ‡ä»¤ã€‚

![jvm-pc-counter](https://tva1.sinaimg.cn/large/0082zybply1gc5kmznm1sj31m50u0wph.jpg)

ï¼ˆåˆ†æï¼šè¿›å…¥classæ–‡ä»¶æ‰€åœ¨ç›®å½•ï¼Œæ‰§è¡Œ`javap -v xx.class`åè§£æï¼ˆæˆ–è€…é€šè¿‡IDEAæ’ä»¶`Jclasslib`ç›´æ¥æŸ¥çœ‹ï¼Œä¸Šå›¾ï¼‰ï¼Œå¯ä»¥çœ‹åˆ°å½“å‰ç±»å¯¹åº”çš„CodeåŒºï¼ˆæ±‡ç¼–æŒ‡ä»¤ï¼‰ã€æœ¬åœ°å˜é‡è¡¨ã€å¼‚å¸¸è¡¨å’Œä»£ç è¡Œåç§»é‡æ˜ å°„è¡¨ã€å¸¸é‡æ± ç­‰ä¿¡æ¯ã€‚ï¼‰



### 1.2 æ¦‚è¿°

- å®ƒæ˜¯ä¸€å—å¾ˆå°çš„å†…å­˜ç©ºé—´ï¼Œå‡ ä¹å¯ä»¥å¿½ç•¥ä¸è®¡ã€‚ä¹Ÿæ˜¯è¿è¡Œé€Ÿåº¦æœ€å¿«çš„å­˜å‚¨åŒºåŸŸ
- åœ¨ JVM è§„èŒƒä¸­ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰å®ƒè‡ªå·±çš„ç¨‹åºè®¡æ•°å™¨ï¼Œæ˜¯çº¿ç¨‹ç§æœ‰çš„ï¼Œç”Ÿå‘½å‘¨æœŸä¸çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸä¸€è‡´
- ä»»ä½•æ—¶é—´ä¸€ä¸ªçº¿ç¨‹éƒ½åªæœ‰ä¸€ä¸ªæ–¹æ³•åœ¨æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„**å½“å‰æ–¹æ³•**ã€‚å¦‚æœå½“å‰çº¿ç¨‹æ­£åœ¨æ‰§è¡Œçš„æ˜¯ Java æ–¹æ³•ï¼Œç¨‹åºè®¡æ•°å™¨è®°å½•çš„æ˜¯ JVM å­—èŠ‚ç æŒ‡ä»¤åœ°å€ï¼Œå¦‚æœæ˜¯æ‰§è¡Œ natice æ–¹æ³•ï¼Œåˆ™æ˜¯æœªæŒ‡å®šå€¼ï¼ˆundefinedï¼‰
- å®ƒæ˜¯ç¨‹åºæ§åˆ¶æµçš„æŒ‡ç¤ºå™¨ï¼Œåˆ†æ”¯ã€å¾ªç¯ã€è·³è½¬ã€å¼‚å¸¸å¤„ç†ã€çº¿ç¨‹æ¢å¤ç­‰åŸºç¡€åŠŸèƒ½éƒ½éœ€è¦ä¾èµ–è¿™ä¸ªè®¡æ•°å™¨æ¥å®Œæˆ
- å­—èŠ‚ç è§£é‡Šå™¨å·¥ä½œæ—¶å°±æ˜¯é€šè¿‡æ”¹å˜è¿™ä¸ªè®¡æ•°å™¨çš„å€¼æ¥é€‰å–ä¸‹ä¸€æ¡éœ€è¦æ‰§è¡Œçš„å­—èŠ‚ç æŒ‡ä»¤
- å®ƒæ˜¯å”¯ä¸€ä¸€ä¸ªåœ¨ JVM è§„èŒƒä¸­æ²¡æœ‰è§„å®šä»»ä½• `OutOfMemoryError` æƒ…å†µçš„åŒºåŸŸ



> ğŸ‘¨â€ğŸ’»ï¼šä½¿ç”¨PCå¯„å­˜å™¨å­˜å‚¨å­—èŠ‚ç æŒ‡ä»¤åœ°å€æœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿä¸ºä»€ä¹ˆä½¿ç”¨PCå¯„å­˜å™¨è®°å½•å½“å‰çº¿ç¨‹çš„æ‰§è¡Œåœ°å€å‘¢ï¼Ÿ
>
> ğŸ™‹â€â™‚ï¸ï¼šå› ä¸ºCPUéœ€è¦ä¸åœçš„åˆ‡æ¢å„ä¸ªçº¿ç¨‹ï¼Œè¿™æ—¶å€™åˆ‡æ¢å›æ¥ä»¥åï¼Œå°±å¾—çŸ¥é“æ¥ç€ä»å“ªå¼€å§‹ç»§ç»­æ‰§è¡Œã€‚JVMçš„å­—èŠ‚ç è§£é‡Šå™¨å°±éœ€è¦é€šè¿‡æ”¹å˜PCå¯„å­˜å™¨çš„å€¼æ¥æ˜ç¡®ä¸‹ä¸€æ¡åº”è¯¥æ‰§è¡Œä»€ä¹ˆæ ·çš„å­—èŠ‚ç æŒ‡ä»¤ã€‚	

> ğŸ§‘â€ğŸ’»ï¼šPCå¯„å­˜å™¨ä¸ºä»€ä¹ˆä¼šè¢«è®¾å®šä¸ºçº¿ç¨‹ç§æœ‰çš„ï¼Ÿ
>
> ğŸ™‹â€â™‚ï¸ï¼šå¤šçº¿ç¨‹åœ¨ä¸€ä¸ªç‰¹å®šçš„æ—¶é—´æ®µå†…åªä¼šæ‰§è¡Œå…¶ä¸­æŸä¸€ä¸ªçº¿ç¨‹æ–¹æ³•ï¼ŒCPUä¼šä¸åœçš„åšä»»åŠ¡åˆ‡æ¢ï¼Œè¿™æ ·å¿…ç„¶ä¼šå¯¼è‡´ç»å¸¸ä¸­æ–­æˆ–æ¢å¤ã€‚ä¸ºäº†èƒ½å¤Ÿå‡†ç¡®çš„è®°å½•å„ä¸ªçº¿ç¨‹æ­£åœ¨æ‰§è¡Œçš„å½“å‰å­—èŠ‚ç æŒ‡ä»¤åœ°å€ï¼Œæ‰€ä»¥ä¸ºæ¯ä¸ªçº¿ç¨‹éƒ½åˆ†é…äº†ä¸€ä¸ªPCå¯„å­˜å™¨ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½ç‹¬ç«‹è®¡ç®—ï¼Œä¸ä¼šäº’ç›¸å½±å“ã€‚

------



## äºŒã€è™šæ‹Ÿæœºæ ˆ

### æ¦‚è¿°

Java è™šæ‹Ÿæœºæ ˆ(Java Virtual Machine Stacks)ï¼Œæ—©æœŸä¹Ÿå« Java æ ˆã€‚æ¯ä¸ªçº¿ç¨‹åœ¨åˆ›å»ºçš„æ—¶å€™éƒ½ä¼šåˆ›å»ºä¸€ä¸ªè™šæ‹Ÿæœºæ ˆï¼Œå…¶å†…éƒ¨ä¿å­˜ä¸€ä¸ªä¸ªçš„æ ˆå¸§(Stack Frameï¼‰ï¼Œå¯¹åº”ç€ä¸€æ¬¡æ¬¡ Java æ–¹æ³•è°ƒç”¨ï¼Œæ˜¯çº¿ç¨‹ç§æœ‰çš„ï¼Œç”Ÿå‘½å‘¨æœŸå’Œçº¿ç¨‹ä¸€è‡´ã€‚

ä½œç”¨ï¼šä¸»ç®¡ Java ç¨‹åºçš„è¿è¡Œï¼Œå®ƒä¿å­˜æ–¹æ³•çš„å±€éƒ¨å˜é‡ã€éƒ¨åˆ†ç»“æœï¼Œå¹¶å‚ä¸æ–¹æ³•çš„è°ƒç”¨å’Œè¿”å›ã€‚

### ç‰¹ç‚¹

- æ ˆæ˜¯ä¸€ç§å¿«é€Ÿæœ‰æ•ˆçš„åˆ†é…å­˜å‚¨æ–¹å¼ï¼Œè®¿é—®é€Ÿåº¦ä»…æ¬¡äºç¨‹åºè®¡æ•°å™¨
- JVM ç›´æ¥å¯¹è™šæ‹Ÿæœºæ ˆçš„æ“ä½œåªæœ‰ä¸¤ä¸ªï¼šæ¯ä¸ªæ–¹æ³•æ‰§è¡Œï¼Œä¼´éšç€**å…¥æ ˆ**ï¼ˆè¿›æ ˆ/å‹æ ˆï¼‰ï¼Œæ–¹æ³•æ‰§è¡Œç»“æŸ**å‡ºæ ˆ**
- æ ˆä¸å­˜åœ¨åƒåœ¾å›æ”¶é—®é¢˜

### æ ˆä¸­å¯èƒ½å‡ºç°çš„å¼‚å¸¸

Java è™šæ‹Ÿæœºè§„èŒƒå…è®¸ **Javaè™šæ‹Ÿæœºæ ˆçš„å¤§å°æ˜¯åŠ¨æ€çš„æˆ–è€…æ˜¯å›ºå®šä¸å˜çš„**

- å¦‚æœé‡‡ç”¨å›ºå®šå¤§å°çš„ Java è™šæ‹Ÿæœºæ ˆï¼Œé‚£æ¯ä¸ªçº¿ç¨‹çš„ Java è™šæ‹Ÿæœºæ ˆå®¹é‡å¯ä»¥åœ¨çº¿ç¨‹åˆ›å»ºçš„æ—¶å€™ç‹¬ç«‹é€‰å®šã€‚å¦‚æœçº¿ç¨‹è¯·æ±‚åˆ†é…çš„æ ˆå®¹é‡è¶…è¿‡ Java è™šæ‹Ÿæœºæ ˆå…è®¸çš„æœ€å¤§å®¹é‡ï¼ŒJava è™šæ‹Ÿæœºå°†ä¼šæŠ›å‡ºä¸€ä¸ª **StackOverflowError** å¼‚å¸¸
- å¦‚æœ Java è™šæ‹Ÿæœºæ ˆå¯ä»¥åŠ¨æ€æ‰©å±•ï¼Œå¹¶ä¸”åœ¨å°è¯•æ‰©å±•çš„æ—¶å€™æ— æ³•ç”³è¯·åˆ°è¶³å¤Ÿçš„å†…å­˜ï¼Œæˆ–è€…åœ¨åˆ›å»ºæ–°çš„çº¿ç¨‹æ—¶æ²¡æœ‰è¶³å¤Ÿçš„å†…å­˜å»åˆ›å»ºå¯¹åº”çš„è™šæ‹Ÿæœºæ ˆï¼Œé‚£ Java è™šæ‹Ÿæœºå°†ä¼šæŠ›å‡ºä¸€ä¸ª**OutOfMemoryError**å¼‚å¸¸



å¯ä»¥é€šè¿‡å‚æ•°`-Xss`æ¥è®¾ç½®çº¿ç¨‹çš„æœ€å¤§æ ˆç©ºé—´ï¼Œæ ˆçš„å¤§å°ç›´æ¥å†³å®šäº†å‡½æ•°è°ƒç”¨çš„æœ€å¤§å¯è¾¾æ·±åº¦ã€‚

å®˜æ–¹æä¾›çš„å‚è€ƒå·¥å…·ï¼Œå¯æŸ¥ä¸€äº›å‚æ•°å’Œæ“ä½œï¼šhttps://docs.oracle.com/javase/8/docs/technotes/tools/windows/java.html#BGBCIEFC

### æ ˆçš„å­˜å‚¨å•ä½

æ ˆä¸­å­˜å‚¨ä»€ä¹ˆï¼Ÿ

- æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„æ ˆï¼Œæ ˆä¸­çš„æ•°æ®éƒ½æ˜¯ä»¥**æ ˆå¸§ï¼ˆStack Frameï¼‰çš„æ ¼å¼å­˜åœ¨**
- åœ¨è¿™ä¸ªçº¿ç¨‹ä¸Šæ­£åœ¨æ‰§è¡Œçš„æ¯ä¸ªæ–¹æ³•éƒ½å„è‡ªæœ‰å¯¹åº”çš„ä¸€ä¸ªæ ˆå¸§
- æ ˆå¸§æ˜¯ä¸€ä¸ªå†…å­˜åŒºå—ï¼Œæ˜¯ä¸€ä¸ªæ•°æ®é›†ï¼Œç»´ç³»ç€æ–¹æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­çš„å„ç§æ•°æ®ä¿¡æ¯

### æ ˆè¿è¡ŒåŸç†

- JVM ç›´æ¥å¯¹ Java æ ˆçš„æ“ä½œåªæœ‰ä¸¤ä¸ªï¼Œå¯¹æ ˆå¸§çš„**å‹æ ˆ**å’Œ**å‡ºæ ˆ**ï¼Œéµå¾ªâ€œå…ˆè¿›åå‡º/åè¿›å…ˆå‡ºâ€åŸåˆ™

- åœ¨ä¸€æ¡æ´»åŠ¨çº¿ç¨‹ä¸­ï¼Œä¸€ä¸ªæ—¶é—´ç‚¹ä¸Šï¼Œåªä¼šæœ‰ä¸€ä¸ªæ´»åŠ¨çš„æ ˆå¸§ã€‚å³åªæœ‰å½“å‰æ­£åœ¨æ‰§è¡Œçš„æ–¹æ³•çš„æ ˆå¸§ï¼ˆ**æ ˆé¡¶æ ˆå¸§**ï¼‰æ˜¯æœ‰æ•ˆçš„ï¼Œè¿™ä¸ªæ ˆå¸§è¢«ç§°ä¸º**å½“å‰æ ˆå¸§**ï¼ˆCurrent Frameï¼‰ï¼Œä¸å½“å‰æ ˆå¸§å¯¹åº”çš„æ–¹æ³•å°±æ˜¯å½“å‰æ–¹æ³•ï¼ˆCurrent Methodï¼‰ï¼Œå®šä¹‰è¿™ä¸ªæ–¹æ³•çš„ç±»å°±æ˜¯**å½“å‰ç±»**ï¼ˆCurrent Classï¼‰

- æ‰§è¡Œå¼•æ“è¿è¡Œçš„æ‰€æœ‰å­—èŠ‚ç æŒ‡ä»¤åªé’ˆå¯¹å½“å‰æ ˆå¸§è¿›è¡Œæ“ä½œ

- å¦‚æœåœ¨è¯¥æ–¹æ³•ä¸­è°ƒç”¨äº†å…¶ä»–æ–¹æ³•ï¼Œå¯¹åº”çš„æ–°çš„æ ˆå¸§ä¼šè¢«åˆ›å»ºå‡ºæ¥ï¼Œæ”¾åœ¨æ ˆçš„é¡¶ç«¯ï¼Œç§°ä¸ºæ–°çš„å½“å‰æ ˆå¸§

- ä¸åŒçº¿ç¨‹ä¸­æ‰€åŒ…å«çš„æ ˆå¸§æ˜¯ä¸å…è®¸å­˜åœ¨ç›¸äº’å¼•ç”¨çš„ï¼Œå³ä¸å¯èƒ½åœ¨ä¸€ä¸ªæ ˆå¸§ä¸­å¼•ç”¨å¦å¤–ä¸€ä¸ªçº¿ç¨‹çš„æ ˆå¸§
- å¦‚æœå½“å‰æ–¹æ³•è°ƒç”¨äº†å…¶ä»–æ–¹æ³•ï¼Œæ–¹æ³•è¿”å›ä¹‹é™…ï¼Œå½“å‰æ ˆå¸§ä¼šä¼ å›æ­¤æ–¹æ³•çš„æ‰§è¡Œç»“æœç»™å‰ä¸€ä¸ªæ ˆå¸§ï¼Œæ¥ç€ï¼Œè™šæ‹Ÿæœºä¼šä¸¢å¼ƒå½“å‰æ ˆå¸§ï¼Œä½¿å¾—å‰ä¸€ä¸ªæ ˆå¸§é‡æ–°æˆä¸ºå½“å‰æ ˆå¸§
- Java æ–¹æ³•æœ‰ä¸¤ç§è¿”å›å‡½æ•°çš„æ–¹å¼ï¼Œ**ä¸€ç§æ˜¯æ­£å¸¸çš„å‡½æ•°è¿”å›ï¼Œä½¿ç”¨returnæŒ‡ä»¤ï¼Œå¦ä¸€ç§æ˜¯æŠ›å‡ºå¼‚å¸¸ï¼Œä¸ç®¡ç”¨å“ªç§æ–¹å¼ï¼Œéƒ½ä¼šå¯¼è‡´æ ˆå¸§è¢«å¼¹å‡º**

IDEA åœ¨ debug æ—¶å€™ï¼Œå¯ä»¥åœ¨ debug çª—å£çœ‹åˆ° Frames ä¸­å„ç§æ–¹æ³•çš„å‹æ ˆå’Œå‡ºæ ˆæƒ…å†µ

![](https://tva1.sinaimg.cn/large/0082zybply1gc9lezaxrbj319v0u0k4w.jpg)

### æ ˆå¸§çš„å†…éƒ¨ç»“æ„

æ¯ä¸ª**æ ˆå¸§ï¼ˆStack Frameï¼‰**ä¸­å­˜å‚¨ç€ï¼š

- å±€éƒ¨å˜é‡è¡¨ï¼ˆLocal Variablesï¼‰
- æ“ä½œæ•°æ ˆï¼ˆOperand Stackï¼‰(æˆ–ç§°ä¸ºè¡¨è¾¾å¼æ ˆ)
- åŠ¨æ€é“¾æ¥ï¼ˆDynamic Linkingï¼‰ï¼šæŒ‡å‘è¿è¡Œæ—¶å¸¸é‡æ± çš„æ–¹æ³•å¼•ç”¨
- æ–¹æ³•è¿”å›åœ°å€ï¼ˆReturn Addressï¼‰ï¼šæ–¹æ³•æ­£å¸¸é€€å‡ºæˆ–å¼‚å¸¸é€€å‡ºçš„åœ°å€
- ä¸€äº›é™„åŠ ä¿¡æ¯

![jvm-stack-frame](https://tva1.sinaimg.cn/large/0082zybply1gc8tjehg8bj318m0lbtbu.jpg)

ç»§ç»­æ·±æŠ›æ ˆå¸§ä¸­çš„äº”éƒ¨åˆ†~~

#### 1. å±€éƒ¨å˜é‡è¡¨

- å±€éƒ¨å˜é‡è¡¨ä¹Ÿè¢«ç§°ä¸ºå±€éƒ¨å˜é‡æ•°ç»„æˆ–è€…æœ¬åœ°å˜é‡è¡¨
- æ˜¯ä¸€ç»„å˜é‡å€¼å­˜å‚¨ç©ºé—´ï¼Œ**ä¸»è¦ç”¨äºå­˜å‚¨æ–¹æ³•å‚æ•°å’Œå®šä¹‰åœ¨æ–¹æ³•ä½“å†…çš„å±€éƒ¨å˜é‡**ï¼ŒåŒ…æ‹¬ç¼–è¯‘å™¨å¯çŸ¥çš„å„ç§ Java è™šæ‹Ÿæœº**åŸºæœ¬æ•°æ®ç±»å‹**ï¼ˆbooleanã€byteã€charã€shortã€intã€floatã€longã€doubleï¼‰ã€**å¯¹è±¡å¼•ç”¨**ï¼ˆreferenceç±»å‹ï¼Œå®ƒå¹¶ä¸ç­‰åŒäºå¯¹è±¡æœ¬èº«ï¼Œå¯èƒ½æ˜¯ä¸€ä¸ªæŒ‡å‘å¯¹è±¡èµ·å§‹åœ°å€çš„å¼•ç”¨æŒ‡é’ˆï¼Œä¹Ÿå¯èƒ½æ˜¯æŒ‡å‘ä¸€ä¸ªä»£è¡¨å¯¹è±¡çš„å¥æŸ„æˆ–å…¶ä»–ä¸æ­¤ç›¸å…³çš„ä½ç½®ï¼‰å’Œ returnAddress ç±»å‹ï¼ˆæŒ‡å‘äº†ä¸€æ¡å­—èŠ‚ç æŒ‡ä»¤çš„åœ°å€ï¼Œå·²è¢«å¼‚å¸¸è¡¨å–ä»£ï¼‰
- ç”±äºå±€éƒ¨å˜é‡è¡¨æ˜¯å»ºç«‹åœ¨çº¿ç¨‹çš„æ ˆä¸Šï¼Œæ˜¯çº¿ç¨‹çš„ç§æœ‰æ•°æ®ï¼Œå› æ­¤**ä¸å­˜åœ¨æ•°æ®å®‰å…¨é—®é¢˜**
- **å±€éƒ¨å˜é‡è¡¨æ‰€éœ€è¦çš„å®¹é‡å¤§å°æ˜¯ç¼–è¯‘å™¨ç¡®å®šä¸‹æ¥çš„**ï¼Œå¹¶ä¿å­˜åœ¨æ–¹æ³•çš„ Code å±æ€§çš„`maximum local variables`æ•°æ®é¡¹ä¸­ã€‚åœ¨æ–¹æ³•è¿è¡ŒæœŸé—´æ˜¯ä¸ä¼šæ”¹å˜å±€éƒ¨å˜é‡è¡¨çš„å¤§å°çš„
- æ–¹æ³•åµŒå¥—è°ƒç”¨çš„æ¬¡æ•°ç”±æ ˆçš„å¤§å°å†³å®šã€‚ä¸€èˆ¬æ¥è¯´ï¼Œ**æ ˆè¶Šå¤§ï¼Œæ–¹æ³•åµŒå¥—è°ƒç”¨æ¬¡æ•°è¶Šå¤š**ã€‚å¯¹ä¸€ä¸ªå‡½æ•°è€Œè¨€ï¼Œå®ƒçš„å‚æ•°å’Œå±€éƒ¨å˜é‡è¶Šå¤šï¼Œä½¿å¾—å±€éƒ¨å˜é‡è¡¨è†¨èƒ€ï¼Œå®ƒçš„æ ˆå¸§å°±è¶Šå¤§ï¼Œä»¥æ»¡è¶³æ–¹æ³•è°ƒç”¨æ‰€éœ€ä¼ é€’çš„ä¿¡æ¯å¢å¤§çš„éœ€æ±‚ã€‚è¿›è€Œå‡½æ•°è°ƒç”¨å°±ä¼šå ç”¨æ›´å¤šçš„æ ˆç©ºé—´ï¼Œå¯¼è‡´å…¶åµŒå¥—è°ƒç”¨æ¬¡æ•°å°±ä¼šå‡å°‘ã€‚
- **å±€éƒ¨å˜é‡è¡¨ä¸­çš„å˜é‡åªåœ¨å½“å‰æ–¹æ³•è°ƒç”¨ä¸­æœ‰æ•ˆ**ã€‚åœ¨æ–¹æ³•æ‰§è¡Œæ—¶ï¼Œè™šæ‹Ÿæœºé€šè¿‡ä½¿ç”¨å±€éƒ¨å˜é‡è¡¨å®Œæˆå‚æ•°å€¼åˆ°å‚æ•°å˜é‡åˆ—è¡¨çš„ä¼ é€’è¿‡ç¨‹ã€‚å½“æ–¹æ³•è°ƒç”¨ç»“æŸåï¼Œéšç€æ–¹æ³•æ ˆå¸§çš„é”€æ¯ï¼Œå±€éƒ¨å˜é‡è¡¨ä¹Ÿä¼šéšä¹‹é”€æ¯ã€‚
- å‚æ•°å€¼çš„å­˜æ”¾æ€»æ˜¯åœ¨å±€éƒ¨å˜é‡æ•°ç»„çš„ index0 å¼€å§‹ï¼Œåˆ°æ•°ç»„é•¿åº¦ -1 çš„ç´¢å¼•ç»“æŸ

##### æ§½ Slot

- å±€éƒ¨å˜é‡è¡¨æœ€åŸºæœ¬çš„å­˜å‚¨å•å…ƒæ˜¯Slotï¼ˆå˜é‡æ§½ï¼‰
- å±€éƒ¨å˜é‡è¡¨ä¸­å­˜æ”¾ç¼–è¯‘å™¨å°±å¯çŸ¥çš„å„ç§åŸºæœ¬æ•°æ®ç±»å‹ï¼ˆ8ç§ï¼‰ï¼Œå¼•ç”¨ç±»å‹ï¼ˆreferenceï¼‰ï¼ŒreturnAddressç±»å‹çš„å˜é‡
- åœ¨å±€éƒ¨å˜é‡è¡¨ä¸­ï¼Œ32ä½ä»¥å†…çš„ç±»å‹åªå ç”¨ä¸€ä¸ªSlot(åŒ…æ‹¬returnAddressç±»å‹)ï¼Œ64ä½çš„ç±»å‹ï¼ˆlongå’Œdoubleï¼‰å ç”¨ä¸¤ä¸ªè¿ç»­çš„ Slot
  - byteã€shortã€char åœ¨å­˜å‚¨å‰è¢«è½¬æ¢ä¸ºintï¼Œbooleanä¹Ÿè¢«è½¬æ¢ä¸ºintï¼Œ0 è¡¨ç¤º falseï¼Œé 0 è¡¨ç¤º true
  - long å’Œ double åˆ™å æ®ä¸¤ä¸ª Slot
- JVM ä¼šä¸ºå±€éƒ¨å˜é‡è¡¨ä¸­çš„æ¯ä¸€ä¸ª Slot éƒ½åˆ†é…ä¸€ä¸ªè®¿é—®ç´¢å¼•ï¼Œé€šè¿‡è¿™ä¸ªç´¢å¼•å³å¯æˆåŠŸè®¿é—®åˆ°å±€éƒ¨å˜é‡è¡¨ä¸­æŒ‡å®šçš„å±€éƒ¨å˜é‡å€¼ï¼Œç´¢å¼•å€¼çš„èŒƒå›´ä» 0 å¼€å§‹åˆ°å±€éƒ¨å˜é‡è¡¨æœ€å¤§çš„ Slot æ•°é‡



- å½“ä¸€ä¸ªå®ä¾‹æ–¹æ³•è¢«è°ƒç”¨çš„æ—¶å€™ï¼Œå®ƒçš„æ–¹æ³•å‚æ•°å’Œæ–¹æ³•ä½“å†…éƒ¨å®šä¹‰çš„å±€éƒ¨å˜é‡å°†ä¼š**æŒ‰ç…§é¡ºåºè¢«å¤åˆ¶**åˆ°å±€éƒ¨å˜é‡è¡¨ä¸­çš„æ¯ä¸€ä¸ª Slot ä¸Š
- **å¦‚æœéœ€è¦è®¿é—®å±€éƒ¨å˜é‡è¡¨ä¸­ä¸€ä¸ª64bitçš„å±€éƒ¨å˜é‡å€¼æ—¶ï¼Œåªéœ€è¦ä½¿ç”¨å‰ä¸€ä¸ªç´¢å¼•å³å¯**ã€‚ï¼ˆæ¯”å¦‚ï¼šè®¿é—®longæˆ–doubleç±»å‹å˜é‡ï¼Œä¸å…è®¸é‡‡ç”¨ä»»ä½•æ–¹å¼å•ç‹¬è®¿é—®å…¶ä¸­çš„æŸä¸€ä¸ª Slotï¼‰
- å¦‚æœå½“å‰å¸§æ˜¯ç”±æ„é€ æ–¹æ³•æˆ–å®ä¾‹æ–¹æ³•åˆ›å»ºçš„ï¼Œé‚£ä¹ˆè¯¥å¯¹è±¡å¼•ç”¨ this å°†ä¼šå­˜æ”¾åœ¨ index ä¸º 0 çš„ Slot å¤„ï¼Œå…¶ä½™çš„å‚æ•°æŒ‰ç…§å‚æ•°è¡¨é¡ºåºç»§ç»­æ’åˆ—ï¼ˆè¿™é‡Œå°±å¼•å‡ºä¸€ä¸ªé—®é¢˜ï¼šé™æ€æ–¹æ³•ä¸­ä¸ºä»€ä¹ˆä¸å¯ä»¥å¼•ç”¨ thisï¼Œå°±æ˜¯å› ä¸ºthis å˜é‡ä¸å­˜åœ¨äºå½“å‰æ–¹æ³•çš„å±€éƒ¨å˜é‡è¡¨ä¸­ï¼‰
- **æ ˆå¸§ä¸­çš„å±€éƒ¨å˜é‡è¡¨ä¸­çš„æ§½ä½æ˜¯å¯ä»¥é‡ç”¨çš„**ï¼Œå¦‚æœä¸€ä¸ªå±€éƒ¨å˜é‡è¿‡äº†å…¶ä½œç”¨åŸŸï¼Œé‚£ä¹ˆåœ¨å…¶ä½œç”¨åŸŸä¹‹åç”³æ˜çš„æ–°çš„å±€éƒ¨å˜é‡å°±å¾ˆæœ‰å¯èƒ½ä¼šå¤ç”¨è¿‡æœŸå±€éƒ¨å˜é‡çš„æ§½ä½ï¼Œä»è€Œ**è¾¾åˆ°èŠ‚çœèµ„æºçš„ç›®çš„**ã€‚ï¼ˆä¸‹å›¾ä¸­ï¼Œthisã€aã€bã€c ç†è®ºä¸Šåº”è¯¥æœ‰ 4 ä¸ªå˜é‡ï¼Œcå¤ç”¨äº† b çš„æ§½ï¼‰

![](https://tva1.sinaimg.cn/large/0082zybply1gc9s12g5wlj31li0owdm9.jpg)

- åœ¨æ ˆå¸§ä¸­ï¼Œä¸æ€§èƒ½è°ƒä¼˜å…³ç³»æœ€ä¸ºå¯†åˆ‡çš„å°±æ˜¯å±€éƒ¨å˜é‡è¡¨ã€‚åœ¨æ–¹æ³•æ‰§è¡Œæ—¶ï¼Œè™šæ‹Ÿæœºä½¿ç”¨å±€éƒ¨å˜é‡è¡¨å®Œæˆæ–¹æ³•çš„ä¼ é€’
- å±€éƒ¨å˜é‡è¡¨ä¸­çš„å˜é‡ä¹Ÿæ˜¯é‡è¦çš„åƒåœ¾å›æ”¶æ ¹èŠ‚ç‚¹ï¼Œåªè¦è¢«å±€éƒ¨å˜é‡è¡¨ä¸­ç›´æ¥æˆ–é—´æ¥å¼•ç”¨çš„å¯¹è±¡éƒ½ä¸ä¼šè¢«å›æ”¶



#### 2. æ“ä½œæ•°æ ˆ

- æ¯ä¸ªç‹¬ç«‹çš„æ ˆå¸§ä¸­é™¤äº†åŒ…å«å±€éƒ¨å˜é‡è¡¨ä¹‹å¤–ï¼Œè¿˜åŒ…å«ä¸€ä¸ª**åè¿›å…ˆå‡º**ï¼ˆLast-In-First-Outï¼‰çš„æ“ä½œæ•°æ ˆï¼Œä¹Ÿå¯ä»¥ç§°ä¸º**è¡¨è¾¾å¼æ ˆ**ï¼ˆExpression Stackï¼‰ï¼Œæ“ä½œæ ˆ

- **æ“ä½œæ•°æ ˆï¼Œåœ¨æ–¹æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œæ ¹æ®å­—èŠ‚ç æŒ‡ä»¤ï¼Œå¾€æ“ä½œæ•°æ ˆä¸­å†™å…¥æ•°æ®æˆ–æå–æ•°æ®ï¼Œå³å…¥æ ˆï¼ˆpushï¼‰ã€å‡ºæ ˆï¼ˆpopï¼‰**
- æŸäº›å­—èŠ‚ç æŒ‡ä»¤å°†å€¼å‹å…¥æ“ä½œæ•°æ ˆï¼Œå…¶ä½™çš„å­—èŠ‚ç æŒ‡ä»¤å°†æ“ä½œæ•°å–å‡ºæ ˆã€‚ä½¿ç”¨å®ƒä»¬åå†æŠŠç»“æœå‹å…¥æ ˆã€‚æ¯”å¦‚ï¼Œæ‰§è¡Œå¤åˆ¶ã€äº¤æ¢ã€æ±‚å’Œç­‰æ“ä½œ
  

##### æ¦‚è¿°

- æ“ä½œæ•°æ ˆï¼Œ**ä¸»è¦ç”¨äºä¿å­˜è®¡ç®—è¿‡ç¨‹çš„ä¸­é—´ç»“æœï¼ŒåŒæ—¶ä½œä¸ºè®¡ç®—è¿‡ç¨‹ä¸­å˜é‡ä¸´æ—¶çš„å­˜å‚¨ç©ºé—´**
- æ“ä½œæ•°æ ˆå°±æ˜¯ JVM æ‰§è¡Œå¼•æ“çš„ä¸€ä¸ªå·¥ä½œåŒºï¼Œå½“ä¸€ä¸ªæ–¹æ³•åˆšå¼€å§‹æ‰§è¡Œçš„æ—¶å€™ï¼Œä¸€ä¸ªæ–°çš„æ ˆå¸§ä¹Ÿä¼šéšä¹‹è¢«åˆ›å»ºå‡ºæ¥ï¼Œ**æ­¤æ—¶è¿™ä¸ªæ–¹æ³•çš„æ“ä½œæ•°æ ˆæ˜¯ç©ºçš„**
- æ¯ä¸€ä¸ªæ“ä½œæ•°æ ˆéƒ½ä¼šæ‹¥æœ‰ä¸€ä¸ªæ˜ç¡®çš„æ ˆæ·±åº¦ç”¨äºå­˜å‚¨æ•°å€¼ï¼Œå…¶æ‰€éœ€çš„æœ€å¤§æ·±åº¦åœ¨ç¼–è¯‘æœŸå°±å®šä¹‰å¥½äº†ï¼Œä¿å­˜åœ¨æ–¹æ³•çš„ Code å±æ€§çš„ `max_stack` æ•°æ®é¡¹ä¸­
- æ ˆä¸­çš„ä»»ä½•ä¸€ä¸ªå…ƒç´ éƒ½å¯ä»¥æ˜¯ä»»æ„çš„ Java æ•°æ®ç±»å‹
  - 32bit çš„ç±»å‹å ç”¨ä¸€ä¸ªæ ˆå•ä½æ·±åº¦
  - 64bit çš„ç±»å‹å ç”¨ä¸¤ä¸ªæ ˆå•ä½æ·±åº¦
- æ“ä½œæ•°æ ˆå¹¶éé‡‡ç”¨è®¿é—®ç´¢å¼•çš„æ–¹å¼æ¥è¿›è¡Œæ•°æ®è®¿é—®çš„ï¼Œè€Œæ˜¯åªèƒ½é€šè¿‡æ ‡å‡†çš„å…¥æ ˆå’Œå‡ºæ ˆæ“ä½œæ¥å®Œæˆä¸€æ¬¡æ•°æ®è®¿é—®
- **å¦‚æœè¢«è°ƒç”¨çš„æ–¹æ³•å¸¦æœ‰è¿”å›å€¼çš„è¯ï¼Œå…¶è¿”å›å€¼å°†ä¼šè¢«å‹å…¥å½“å‰æ ˆå¸§çš„æ“ä½œæ•°æ ˆä¸­**ï¼Œå¹¶æ›´æ–°PCå¯„å­˜å™¨ä¸­ä¸‹ä¸€æ¡éœ€è¦æ‰§è¡Œçš„å­—èŠ‚ç æŒ‡ä»¤
- æ“ä½œæ•°æ ˆä¸­å…ƒç´ çš„æ•°æ®ç±»å‹å¿…é¡»ä¸å­—èŠ‚ç æŒ‡ä»¤çš„åºåˆ—ä¸¥æ ¼åŒ¹é…ï¼Œè¿™ç”±ç¼–è¯‘å™¨åœ¨ç¼–è¯‘æœŸé—´è¿›è¡ŒéªŒè¯ï¼ŒåŒæ—¶åœ¨ç±»åŠ è½½è¿‡ç¨‹ä¸­çš„ç±»æ£€éªŒé˜¶æ®µçš„æ•°æ®æµåˆ†æé˜¶æ®µè¦å†æ¬¡éªŒè¯
- å¦å¤–ï¼Œæˆ‘ä»¬è¯´**Javaè™šæ‹Ÿæœºçš„è§£é‡Šå¼•æ“æ˜¯åŸºäºæ ˆçš„æ‰§è¡Œå¼•æ“**ï¼Œå…¶ä¸­çš„æ ˆæŒ‡çš„å°±æ˜¯æ“ä½œæ•°æ ˆ

##### ä»£ç è¿½è¸ª



##### æ ˆé¡¶ç¼“å­˜ï¼ˆTop-of-stack-Cashingï¼‰

å‰é¢æè¿‡ï¼ŒåŸºäºæ ˆå¼æ¶æ„çš„è™šæ‹Ÿæœºæ‰€ä½¿ç”¨çš„é›¶åœ°å€æŒ‡ä»¤æ›´åŠ ç´§å‡‘ï¼Œä½†å®Œæˆä¸€é¡¹æ“ä½œçš„æ—¶å€™å¿…ç„¶éœ€è¦ä½¿ç”¨æ›´å¤šçš„å…¥æ ˆå’Œå‡ºæ ˆæŒ‡ä»¤ï¼Œè¿™åŒæ—¶ä¹Ÿå°±æ„å‘³ç€å°†éœ€è¦æ›´å¤šçš„æŒ‡ä»¤åˆ†æ´¾ï¼ˆinstruction dispatchï¼‰æ¬¡æ•°å’Œå†…å­˜è¯»/å†™æ¬¡æ•°

ç”±äºæ“ä½œæ•°æ˜¯å­˜å‚¨åœ¨å†…å­˜ä¸­çš„ï¼Œå› æ­¤é¢‘ç¹çš„æ‰§è¡Œå†…å­˜è¯»/å†™æ“ä½œå¿…ç„¶ä¼šå½±å“æ‰§è¡Œé€Ÿåº¦ã€‚ä¸ºä¾‹è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒHotSpot JVMè®¾è®¡è€…ä»¬æå‡ºäº†æ ˆé¡¶ç¼“å­˜æŠ€æœ¯ï¼Œ**å°†æ ˆé¡¶å…ƒç´ å…¨éƒ¨ç¼“å­˜åœ¨ç‰©ç†CPUçš„å¯„å­˜å™¨ä¸­ï¼Œä»¥æ­¤é™ä½å¯¹å†…å­˜çš„è¯»/å†™æ¬¡æ•°ï¼Œæå‡æ‰§è¡Œå¼•æ“çš„æ‰§è¡Œæ•ˆç‡**

#### 3. åŠ¨æ€é“¾æ¥ï¼ˆæˆ–æŒ‡å‘è¿è¡Œæ—¶å¸¸é‡æ± çš„æ–¹æ³•å¼•ç”¨ï¼‰

- **æ¯ä¸€ä¸ªæ ˆå¸§å†…éƒ¨éƒ½åŒ…å«ä¸€ä¸ªæŒ‡å‘è¿è¡Œæ—¶å¸¸é‡æ± ä¸­è¯¥æ ˆå¸§æ‰€å±æ–¹æ³•çš„å¼•ç”¨**ã€‚åŒ…å«è¿™ä¸ªå¼•ç”¨çš„ç›®çš„å°±æ˜¯ä¸ºäº†æ”¯æŒå½“å‰æ–¹æ³•çš„ä»£ç èƒ½å¤Ÿå®ç°åŠ¨æ€é“¾æ¥(Dynamic Linking)ã€‚
- åœ¨ Java æºæ–‡ä»¶è¢«ç¼–è¯‘åˆ°å­—èŠ‚ç æ–‡ä»¶ä¸­æ—¶ï¼Œæ‰€æœ‰çš„å˜é‡å’Œæ–¹æ³•å¼•ç”¨éƒ½ä½œä¸ºç¬¦å·å¼•ç”¨ï¼ˆSymbolic Referenceï¼‰ä¿å­˜åœ¨ Class æ–‡ä»¶çš„å¸¸é‡æ± ä¸­ã€‚æ¯”å¦‚ï¼šæè¿°ä¸€ä¸ªæ–¹æ³•è°ƒç”¨äº†å¦å¤–çš„å…¶ä»–æ–¹æ³•æ—¶ï¼Œå°±æ˜¯é€šè¿‡å¸¸é‡æ± ä¸­æŒ‡å‘æ–¹æ³•çš„ç¬¦å·å¼•ç”¨æ¥è¡¨ç¤ºçš„ï¼Œé‚£ä¹ˆ**åŠ¨æ€é“¾æ¥çš„ä½œç”¨å°±æ˜¯ä¸ºäº†å°†è¿™äº›ç¬¦å·å¼•ç”¨è½¬æ¢ä¸ºè°ƒç”¨æ–¹æ³•çš„ç›´æ¥å¼•ç”¨**

![jvm-dynamic-linking](https://tva1.sinaimg.cn/large/0082zybply1gca4k4gndgj31d20o2td0.jpg)

##### æ–¹æ³•çš„è°ƒç”¨

åœ¨ JVM ä¸­ï¼Œå°†ç¬¦å·å¼•ç”¨è½¬æ¢ä¸ºè°ƒç”¨æ–¹æ³•çš„ç›´æ¥å¼•ç”¨ä¸æ–¹æ³•çš„ç»‘å®šæœºåˆ¶æœ‰å…³

- é™æ€é“¾æ¥ï¼šå½“ä¸€ä¸ªå­—èŠ‚ç æ–‡ä»¶è¢«è£…è½½è¿› JVM å†…éƒ¨æ—¶ï¼Œå¦‚æœè¢«è°ƒç”¨çš„**ç›®æ ‡æ–¹æ³•åœ¨ç¼–è¯‘æœŸå¯çŸ¥**ï¼Œä¸”è¿è¡ŒæœŸä¿æŒä¸å˜æ—¶ã€‚è¿™ç§æƒ…å†µä¸‹å°†è°ƒç”¨æ–¹æ³•çš„ç¬¦å·å¼•ç”¨è½¬æ¢ä¸ºç›´æ¥å¼•ç”¨çš„è¿‡ç¨‹ç§°ä¹‹ä¸ºé™æ€é“¾æ¥
- åŠ¨æ€é“¾æ¥ï¼šå¦‚æœè¢«è°ƒç”¨çš„æ–¹æ³•åœ¨ç¼–è¯‘æœŸæ— æ³•è¢«ç¡®å®šä¸‹æ¥ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåªèƒ½åœ¨ç¨‹åºè¿è¡ŒæœŸå°†è°ƒç”¨æ–¹æ³•çš„ç¬¦å·å¼•ç”¨è½¬æ¢ä¸ºç›´æ¥å¼•ç”¨ï¼Œç”±äºè¿™ç§å¼•ç”¨è½¬æ¢è¿‡ç¨‹å…·å¤‡åŠ¨æ€æ€§ï¼Œå› æ­¤ä¹Ÿå°±è¢«ç§°ä¹‹ä¸ºåŠ¨æ€é“¾æ¥

å¯¹åº”çš„æ–¹æ³•çš„ç»‘å®šæœºåˆ¶ä¸ºï¼šæ—©æœŸç»‘å®šï¼ˆEarly Bindingï¼‰å’Œæ™šæœŸç»‘å®šï¼ˆLate Bindingï¼‰ã€‚**ç»‘å®šæ˜¯ä¸€ä¸ªå­—æ®µã€æ–¹æ³•æˆ–è€…ç±»åœ¨ç¬¦å·å¼•ç”¨è¢«æ›¿æ¢ä¸ºç›´æ¥å¼•ç”¨çš„è¿‡ç¨‹ï¼Œè¿™ä»…ä»…å‘ç”Ÿä¸€æ¬¡**ã€‚

- æ—©æœŸç»‘å®šï¼š**æ—©æœŸç»‘å®šå°±æ˜¯æŒ‡è¢«è°ƒç”¨çš„ç›®æ ‡æ–¹æ³•å¦‚æœåœ¨ç¼–è¯‘æœŸå¯çŸ¥ï¼Œä¸”è¿è¡ŒæœŸä¿æŒä¸å˜æ—¶**ï¼Œå³å¯å°†è¿™ä¸ªæ–¹æ³•ä¸æ‰€å±çš„ç±»å‹è¿›è¡Œç»‘å®šï¼Œè¿™æ ·ä¸€æ¥ï¼Œç”±äºæ˜ç¡®äº†è¢«è°ƒç”¨çš„ç›®æ ‡æ–¹æ³•ç©¶ç«Ÿæ˜¯å“ªä¸€ä¸ªï¼Œå› æ­¤ä¹Ÿå°±å¯ä»¥ä½¿ç”¨é™æ€é“¾æ¥çš„æ–¹å¼å°†ç¬¦å·å¼•ç”¨è½¬æ¢ä¸ºç›´æ¥å¼•ç”¨ã€‚
- æ™šæœŸç»‘å®šï¼šå¦‚æœè¢«è°ƒç”¨çš„æ–¹æ³•åœ¨ç¼–è¯‘å™¨æ— æ³•è¢«ç¡®å®šä¸‹æ¥ï¼Œåªèƒ½å¤Ÿåœ¨ç¨‹åºè¿è¡ŒæœŸæ ¹æ®å®é™…çš„ç±»å‹ç»‘å®šç›¸å…³çš„æ–¹æ³•ï¼Œè¿™ç§ç»‘å®šæ–¹å¼å°±è¢«ç§°ä¸ºæ™šæœŸç»‘å®šã€‚

##### è™šæ–¹æ³•å’Œéè™šæ–¹æ³•

- å¦‚æœæ–¹æ³•åœ¨ç¼–è¯‘å™¨å°±ç¡®å®šäº†å…·ä½“çš„è°ƒç”¨ç‰ˆæœ¬ï¼Œè¿™ä¸ªç‰ˆæœ¬åœ¨è¿è¡Œæ—¶æ˜¯ä¸å¯å˜çš„ã€‚è¿™æ ·çš„æ–¹æ³•ç§°ä¸ºéè™šæ–¹æ³•
- é™æ€æ–¹æ³•ã€ç§æœ‰æ–¹æ³•ã€finalæ–¹æ³•ã€å®ä¾‹æ„é€ å™¨ã€çˆ¶ç±»æ–¹æ³•éƒ½æ˜¯éè™šæ–¹æ³•
- å…¶ä»–æ–¹æ³•ç§°ä¸ºè™šæ–¹æ³•

##### è™šæ–¹æ³•è¡¨

åœ¨é¢å‘å¯¹è±¡ç¼–ç¨‹ä¸­ï¼Œä¼šé¢‘ç¹çš„ä½¿ç”¨åˆ°åŠ¨æ€åˆ†æ´¾ï¼Œå¦‚æœæ¯æ¬¡åŠ¨æ€åˆ†æ´¾éƒ½è¦é‡æ–°åœ¨ç±»çš„æ–¹æ³•å…ƒæ•°æ®ä¸­æœç´¢åˆé€‚çš„ç›®æ ‡æœ‰å¯èƒ½ä¼šå½±å“åˆ°æ‰§è¡Œæ•ˆç‡ã€‚ä¸ºäº†æé«˜æ€§èƒ½ï¼ŒJVM é‡‡ç”¨åœ¨ç±»çš„æ–¹æ³•åŒºå»ºç«‹ä¸€ä¸ªè™šæ–¹æ³•è¡¨ï¼ˆvirtual method tableï¼‰ï¼Œä½¿ç”¨ç´¢å¼•è¡¨æ¥ä»£æ›¿æŸ¥æ‰¾ã€‚éè™šæ–¹æ³•ä¸ä¼šå‡ºç°åœ¨è¡¨ä¸­ã€‚

æ¯ä¸ªç±»ä¸­éƒ½æœ‰ä¸€ä¸ªè™šæ–¹æ³•è¡¨ï¼Œè¡¨ä¸­å­˜æ”¾ç€å„ä¸ªæ–¹æ³•çš„å®é™…å…¥å£ã€‚

è™šæ–¹æ³•è¡¨ä¼šåœ¨ç±»åŠ è½½çš„è¿æ¥é˜¶æ®µè¢«åˆ›å»ºå¹¶å¼€å§‹åˆå§‹åŒ–ï¼Œç±»çš„å˜é‡åˆå§‹å€¼å‡†å¤‡å®Œæˆä¹‹åï¼ŒJVM ä¼šæŠŠè¯¥ç±»çš„æ–¹æ³•è¡¨ä¹Ÿåˆå§‹åŒ–å®Œæ¯•ã€‚



#### 4. æ–¹æ³•è¿”å›åœ°å€ï¼ˆreturn addressï¼‰

- å­˜æ”¾è°ƒç”¨è¯¥æ–¹æ³•çš„ PC å¯„å­˜å™¨çš„å€¼
- ä¸€ä¸ªæ–¹æ³•çš„ç»“æŸï¼Œæœ‰ä¸¤ç§æ–¹å¼
  - æ­£å¸¸æ‰§è¡Œå®Œæˆ
  - å‡ºç°æœªå¤„ç†çš„å¼‚å¸¸ï¼Œéæ­£å¸¸é€€å‡º
- æ— è®ºé€šè¿‡å“ªç§æ–¹å¼é€€å‡ºï¼Œåœ¨æ–¹æ³•é€€å‡ºåéƒ½è¿”å›åˆ°è¯¥æ–¹æ³•è¢«è°ƒç”¨çš„ä½ç½®ã€‚æ–¹æ³•æ­£å¸¸é€€å‡ºæ—¶ï¼Œè°ƒç”¨è€…çš„ PC è®¡æ•°å™¨çš„å€¼ä½œä¸ºè¿”å›åœ°å€ï¼Œå³è°ƒç”¨è¯¥æ–¹æ³•çš„æŒ‡ä»¤çš„ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ã€‚è€Œé€šè¿‡å¼‚å¸¸é€€å‡ºçš„ï¼Œè¿”å›åœ°å€æ˜¯è¦é€šè¿‡å¼‚å¸¸è¡¨æ¥ç¡®å®šçš„ï¼Œæ ˆå¸§ä¸­ä¸€èˆ¬ä¸ä¼šä¿å­˜è¿™éƒ¨åˆ†ä¿¡æ¯

å½“ä¸€ä¸ªæ–¹æ³•å¼€å§‹æ‰§è¡Œåï¼Œåªæœ‰ä¸¤ç§æ–¹å¼å¯ä»¥é€€å‡ºè¿™ä¸ªæ–¹æ³•ï¼š

1. æ‰§è¡Œå¼•æ“é‡åˆ°ä»»æ„ä¸€ä¸ªæ–¹æ³•è¿”å›çš„å­—èŠ‚ç æŒ‡ä»¤ï¼Œä¼šæœ‰è¿”å›å€¼ä¼ é€’ç»™ä¸Šå±‚çš„æ–¹æ³•è°ƒç”¨è€…ï¼Œç®€ç§°**æ­£å¸¸å®Œæˆå‡ºå£**

   ä¸€ä¸ªæ–¹æ³•çš„æ­£å¸¸è°ƒç”¨å®Œæˆä¹‹åç©¶ç«Ÿéœ€è¦ä½¿ç”¨å“ªä¸€ä¸ªè¿”å›æŒ‡ä»¤è¿˜éœ€è¦æ ¹æ®æ–¹æ³•è¿”å›å€¼çš„å®é™…æ•°æ®ç±»å‹è€Œå®š

   åœ¨å­—èŠ‚ç æŒ‡ä»¤ä¸­ï¼Œè¿”å›æŒ‡ä»¤åŒ…å« ireturn(å½“è¿”å›å€¼æ˜¯booleanã€byteã€charã€shortå’Œintç±»å‹æ—¶ä½¿ç”¨)ã€lreturnã€freturnã€dreturnä»¥åŠareturnï¼Œå¦å¤–è¿˜æœ‰ä¸€ä¸ª return æŒ‡ä»¤ä¾›å£°æ˜ä¸º void çš„æ–¹æ³•ã€å®ä¾‹åˆå§‹åŒ–æ–¹æ³•ã€ç±»å’Œæ¥å£çš„åˆå§‹åŒ–æ–¹æ³•ä½¿ç”¨ã€‚

2. åœ¨æ–¹æ³•æ‰§è¡Œçš„è¿‡ç¨‹ä¸­é‡åˆ°äº†å¼‚å¸¸ï¼Œå¹¶ä¸”è¿™ä¸ªå¼‚å¸¸æ²¡æœ‰åœ¨æ–¹æ³•å†…è¿›è¡Œå¤„ç†ï¼Œä¹Ÿå°±æ˜¯åªè¦åœ¨æœ¬æ–¹æ³•çš„å¼‚å¸¸è¡¨ä¸­æ²¡æœ‰æœç´¢åˆ°åŒ¹é…çš„å¼‚å¸¸å¤„ç†å™¨ï¼Œå°±ä¼šå¯¼è‡´æ–¹æ³•é€€å‡ºã€‚ç®€ç§°**å¼‚å¸¸å®Œæˆå‡ºå£**

   æ–¹æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­æŠ›å‡ºå¼‚å¸¸æ—¶çš„å¼‚å¸¸å¤„ç†ï¼Œå­˜å‚¨åœ¨ä¸€ä¸ªå¼‚å¸¸å¤„ç†è¡¨ï¼Œæ–¹ä¾¿åœ¨å‘ç”Ÿå¼‚å¸¸çš„æ—¶å€™æ‰¾åˆ°å¤„ç†å¼‚å¸¸çš„ä»£ç ã€‚

æœ¬è´¨ä¸Šï¼Œ**æ–¹æ³•çš„é€€å‡ºå°±æ˜¯å½“å‰æ ˆå¸§å‡ºæ ˆçš„è¿‡ç¨‹**ã€‚æ­¤æ—¶ï¼Œéœ€è¦æ¢å¤ä¸Šå±‚æ–¹æ³•çš„å±€éƒ¨å˜é‡è¡¨ã€æ“ä½œæ•°æ ˆã€å°†è¿”å›å€¼å‹å…¥è°ƒç”¨è€…æ ˆå¸§çš„æ“ä½œæ•°æ ˆã€è®¾ç½®PCå¯„å­˜å™¨å€¼ç­‰ï¼Œè®©è°ƒç”¨è€…æ–¹æ³•ç»§ç»­æ‰§è¡Œä¸‹å»

æ­£å¸¸å®Œæˆå‡ºå£å’Œå¼‚å¸¸å®Œæˆå‡ºå£çš„åŒºåˆ«åœ¨äºï¼š**é€šè¿‡å¼‚å¸¸å®Œæˆå‡ºå£é€€å‡ºçš„ä¸ä¼šç»™ä»–çš„ä¸Šå±‚è°ƒç”¨è€…äº§ç”Ÿä»»ä½•çš„è¿”å›å€¼**



#### 5. é™„åŠ ä¿¡æ¯

æ ˆå¸§ä¸­è¿˜å…è®¸æºå¸¦ä¸ Java è™šæ‹Ÿæœºå®ç°ç›¸å…³çš„ä¸€äº›é™„åŠ ä¿¡æ¯ã€‚ä¾‹å¦‚ï¼Œå¯¹ç¨‹åºè°ƒè¯•æä¾›æ”¯æŒçš„ä¿¡æ¯ï¼Œä½†è¿™äº›ä¿¡æ¯å–å†³äºå…·ä½“çš„è™šæ‹Ÿæœºå®ç°ã€‚

------



## ä¸‰ã€æœ¬åœ°æ–¹æ³•æ ˆ

### æœ¬åœ°æ–¹æ³•æ¥å£

ç®€å•çš„è®²ï¼Œä¸€ä¸ª Native Method å°±æ˜¯ä¸€ä¸ª Java è°ƒç”¨é Java ä»£ç çš„æ¥å£ã€‚æˆ‘ä»¬çŸ¥é“çš„ Unsafe ç±»å°±æœ‰å¾ˆå¤šæœ¬åœ°æ–¹æ³•ã€‚

> ä¸ºä»€ä¹ˆè¦ä½¿ç”¨æœ¬åœ°æ–¹æ³•ï¼ˆNative Methodï¼‰?

Java ä½¿ç”¨èµ·æ¥éå¸¸æ–¹ä¾¿ï¼Œç„¶è€Œæœ‰äº›å±‚æ¬¡çš„ä»»åŠ¡ç”¨ Java å®ç°èµ·æ¥ä¹Ÿä¸å®¹æ˜“ï¼Œæˆ–è€…æˆ‘ä»¬å¯¹ç¨‹åºçš„æ•ˆç‡å¾ˆåœ¨æ„æ—¶ï¼Œé—®é¢˜å°±æ¥äº†

- ä¸ Java ç¯å¢ƒå¤–äº¤äº’ï¼šæœ‰æ—¶ Java åº”ç”¨éœ€è¦ä¸ Java å¤–é¢çš„ç¯å¢ƒäº¤äº’ï¼Œè¿™å°±æ˜¯æœ¬åœ°æ–¹æ³•å­˜åœ¨çš„åŸå› ã€‚
- ä¸æ“ä½œç³»ç»Ÿäº¤äº’ï¼šJVM æ”¯æŒ Java è¯­è¨€æœ¬èº«å’Œè¿è¡Œæ—¶åº“ï¼Œä½†æ˜¯æœ‰æ—¶ä»éœ€è¦ä¾èµ–ä¸€äº›åº•å±‚ç³»ç»Ÿçš„æ”¯æŒã€‚é€šè¿‡æœ¬åœ°æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°ç”¨ Java ä¸å®ç°äº† jre çš„åº•å±‚ç³»ç»Ÿäº¤äº’ï¼Œ JVM çš„ä¸€äº›éƒ¨åˆ†å°±æ˜¯ C è¯­è¨€å†™çš„ã€‚
- Sun's Javaï¼šSunçš„è§£é‡Šå™¨å°±æ˜¯Cå®ç°çš„ï¼Œè¿™ä½¿å¾—å®ƒèƒ½åƒä¸€äº›æ™®é€šçš„Cä¸€æ ·ä¸å¤–éƒ¨äº¤äº’ã€‚jreå¤§éƒ¨åˆ†éƒ½æ˜¯ç”¨ Java å®ç°çš„ï¼Œå®ƒä¹Ÿé€šè¿‡ä¸€äº›æœ¬åœ°æ–¹æ³•ä¸å¤–ç•Œäº¤äº’ã€‚æ¯”å¦‚ï¼Œç±» `java.lang.Thread` çš„ `setPriority()` çš„æ–¹æ³•æ˜¯ç”¨Java å®ç°çš„ï¼Œä½†å®ƒå®ç°è°ƒç”¨çš„æ˜¯è¯¥ç±»çš„æœ¬åœ°æ–¹æ³• `setPrioruty()`ï¼Œè¯¥æ–¹æ³•æ˜¯Cå®ç°çš„ï¼Œå¹¶è¢«æ¤å…¥ JVM å†…éƒ¨ã€‚

### æœ¬åœ°æ–¹æ³•æ ˆï¼ˆNative Method Stackï¼‰

- Java è™šæ‹Ÿæœºæ ˆç”¨äºç®¡ç† Java æ–¹æ³•çš„è°ƒç”¨ï¼Œè€Œæœ¬åœ°æ–¹æ³•æ ˆç”¨äºç®¡ç†æœ¬åœ°æ–¹æ³•çš„è°ƒç”¨
- æœ¬åœ°æ–¹æ³•æ ˆä¹Ÿæ˜¯çº¿ç¨‹ç§æœ‰çš„
- å…è®¸çº¿ç¨‹å›ºå®šæˆ–è€…å¯åŠ¨æ€æ‰©å±•çš„å†…å­˜å¤§å°
  - å¦‚æœçº¿ç¨‹è¯·æ±‚åˆ†é…çš„æ ˆå®¹é‡è¶…è¿‡æœ¬åœ°æ–¹æ³•æ ˆå…è®¸çš„æœ€å¤§å®¹é‡ï¼ŒJavaè™šæ‹Ÿæœºå°†ä¼šæŠ›å‡ºä¸€ä¸ª `StackOverflowError` å¼‚å¸¸
  - å¦‚æœæœ¬åœ°æ–¹æ³•æ ˆå¯ä»¥åŠ¨æ€æ‰©å±•ï¼Œå¹¶ä¸”åœ¨å°è¯•æ‰©å±•çš„æ—¶å€™æ— æ³•ç”³è¯·åˆ°è¶³å¤Ÿçš„å†…å­˜ï¼Œæˆ–è€…åœ¨åˆ›å»ºæ–°çš„çº¿ç¨‹æ—¶æ²¡æœ‰è¶³å¤Ÿçš„å†…å­˜å»åˆ›å»ºå¯¹åº”çš„æœ¬åœ°æ–¹æ³•æ ˆï¼Œé‚£ä¹ˆ Javaè™šæ‹Ÿæœºå°†ä¼šæŠ›å‡ºä¸€ä¸ª`OutofMemoryError`å¼‚å¸¸
- æœ¬åœ°æ–¹æ³•æ˜¯ä½¿ç”¨Cè¯­è¨€å®ç°çš„
- å®ƒçš„å…·ä½“åšæ³•æ˜¯ `Mative Method Stack` ä¸­ç™»è®°nativeæ–¹æ³•ï¼Œåœ¨ `Execution Engine` æ‰§è¡Œæ—¶åŠ è½½æœ¬åœ°æ–¹æ³•åº“
- å½“æŸä¸ªçº¿ç¨‹è°ƒç”¨ä¸€ä¸ªæœ¬åœ°æ–¹æ³•æ—¶ï¼Œå®ƒå°±è¿›å…¥äº†ä¸€ä¸ªå…¨æ–°çš„å¹¶ä¸”ä¸å†å—è™šæ‹Ÿæœºé™åˆ¶çš„ä¸–ç•Œã€‚å®ƒå’Œè™šæ‹Ÿæœºæ‹¥æœ‰åŒæ ·çš„æƒé™ã€‚
  - æœ¬åœ°æ–¹æ³•å¯ä»¥é€šè¿‡æœ¬åœ°æ–¹æ³•æ¥å£æ¥è®¿é—®è™šæ‹Ÿæœºå†…éƒ¨çš„è¿è¡Œæ—¶æ•°æ®åŒº
  - å®ƒç”šè‡³å¯ä»¥ç›´æ¥ä½¿ç”¨æœ¬åœ°å¤„ç†å™¨ä¸­çš„å¯„å­˜å™¨
  - ç›´æ¥ä»æœ¬åœ°å†…å­˜çš„å †ä¸­åˆ†é…ä»»æ„æ•°é‡çš„å†…å­˜
- å¹¶ä¸æ˜¯æ‰€æœ‰ JVM éƒ½æ”¯æŒæœ¬åœ°æ–¹æ³•ã€‚å› ä¸º Java è™šæ‹Ÿæœºè§„èŒƒå¹¶æ²¡æœ‰æ˜ç¡®è¦æ±‚æœ¬åœ°æ–¹æ³•æ ˆçš„ä½¿ç”¨è¯­è¨€ã€å…·ä½“å®ç°æ–¹å¼ã€æ•°æ®ç»“æ„ç­‰ã€‚å¦‚æœ JVM äº§å“ä¸æ‰“ç®—æ”¯æŒ native æ–¹æ³•ï¼Œä¹Ÿå¯ä»¥æ— éœ€å®ç°æœ¬åœ°æ–¹æ³•æ ˆ
- åœ¨ Hotspot JVM ä¸­ï¼Œç›´æ¥å°†æœ¬åœ°æ–¹æ ˆå’Œè™šæ‹Ÿæœºæ ˆåˆäºŒä¸ºä¸€

------





> **æ ˆæ˜¯è¿è¡Œæ—¶çš„å•ä½ï¼Œè€Œå †æ˜¯å­˜å‚¨çš„å•ä½**ã€‚
>
> æ ˆè§£å†³ç¨‹åºçš„è¿è¡Œé—®é¢˜ï¼Œå³ç¨‹åºå¦‚ä½•æ‰§è¡Œï¼Œæˆ–è€…è¯´å¦‚ä½•å¤„ç†æ•°æ®ã€‚å †è§£å†³çš„æ˜¯æ•°æ®å­˜å‚¨çš„é—®é¢˜ï¼Œå³æ•°æ®æ€ä¹ˆæ”¾ã€æ”¾åœ¨å“ªã€‚



## å››ã€å †å†…å­˜

å¯¹äºå¤§å¤šæ•°åº”ç”¨ï¼ŒJava å †æ˜¯ Java è™šæ‹Ÿæœºç®¡ç†çš„å†…å­˜ä¸­æœ€å¤§çš„ä¸€å—ï¼Œè¢«æ‰€æœ‰çº¿ç¨‹å…±äº«ã€‚æ­¤å†…å­˜åŒºåŸŸçš„å”¯ä¸€ç›®çš„å°±æ˜¯å­˜æ”¾å¯¹è±¡å®ä¾‹ï¼Œå‡ ä¹æ‰€æœ‰çš„å¯¹è±¡å®ä¾‹ä»¥åŠæ•°æ®éƒ½åœ¨è¿™é‡Œåˆ†é…å†…å­˜ã€‚

ä¸ºäº†è¿›è¡Œé«˜æ•ˆçš„åƒåœ¾å›æ”¶ï¼Œè™šæ‹ŸæœºæŠŠå †å†…å­˜é€»è¾‘ä¸Šåˆ’åˆ†æˆä¸‰å—åŒºåŸŸï¼š

- æ–°ç”Ÿå¸¦ï¼ˆå¹´è½»ä»£ï¼‰ï¼šæ–°å¯¹è±¡å’Œæ²¡è¾¾åˆ°ä¸€å®šå¹´é¾„çš„å¯¹è±¡éƒ½åœ¨å¹´è½»ä»£ 

- è€å¹´ä»£ï¼ˆå…»è€åŒºï¼‰ï¼šè¢«é•¿æ—¶é—´ä½¿ç”¨çš„å¯¹è±¡ï¼Œè€å¹´ä»£çš„å†…å­˜ç©ºé—´åº”è¯¥è¦æ¯”å¹´è½»ä»£æ›´å¤§ 

- å…ƒç©ºé—´ï¼ˆJDK1.8ä¹‹å‰å«æ°¸ä¹…ä»£ï¼‰ï¼šåƒä¸€äº›æ–¹æ³•ä¸­çš„æ“ä½œä¸´æ—¶å¯¹è±¡ç­‰ï¼ŒJDK1.8ä¹‹å‰æ˜¯å ç”¨JVMå†…å­˜ï¼ŒJDK1.8ä¹‹åç›´æ¥ä½¿ç”¨ç‰©ç†å†…å­˜ï¼ˆè™½ç„¶ Java è™šæ‹Ÿæœºè§„èŒƒæŠŠæ–¹æ³•åŒºæè¿°ä¸ºå †çš„ä¸€ä¸ªé€»è¾‘éƒ¨åˆ†ï¼Œä½†æ˜¯å®ƒå´æœ‰ä¸€ä¸ªåˆ«åå« Non-Heapï¼ˆéå †ï¼‰ï¼Œç›®çš„åº”è¯¥æ˜¯ä¸ Java å †åŒºåˆ†å¼€ï¼‰

![](https://tva1.sinaimg.cn/large/00831rSTly1gdbr7ek6pfj30ci0560t4.jpg)

Java è™šæ‹Ÿæœºè§„èŒƒè§„å®šï¼ŒJava å †å¯ä»¥æ˜¯å¤„äºç‰©ç†ä¸Šä¸è¿ç»­çš„å†…å­˜ç©ºé—´ä¸­ï¼Œåªè¦é€»è¾‘ä¸Šæ˜¯è¿ç»­çš„å³å¯ï¼Œåƒç£ç›˜ç©ºé—´ä¸€æ ·ã€‚å®ç°æ—¶ï¼Œæ—¢å¯ä»¥æ˜¯å›ºå®šå¤§å°ï¼Œä¹Ÿå¯ä»¥æ˜¯å¯æ‰©å±•çš„ï¼Œä¸»æµè™šæ‹Ÿæœºéƒ½æ˜¯å¯æ‰©å±•çš„ï¼ˆé€šè¿‡ `-Xmx` å’Œ `-Xms` æ§åˆ¶ï¼‰ï¼Œå¦‚æœå †ä¸­æ²¡æœ‰å®Œæˆå®ä¾‹åˆ†é…ï¼Œå¹¶ä¸”å †æ— æ³•å†æ‰©å±•æ—¶ï¼Œå°±ä¼šæŠ›å‡º `OutOfMemoryError` å¼‚å¸¸ã€‚



### 4.1 å¹´è½»ä»£ (Young Generation)

å¹´è½»ä»£æ˜¯æ‰€æœ‰æ–°å¯¹è±¡åˆ›å»ºçš„åœ°æ–¹ã€‚å½“å¡«å……å¹´è½»ä»£æ—¶ï¼Œæ‰§è¡Œåƒåœ¾æ”¶é›†ã€‚è¿™ç§åƒåœ¾æ”¶é›†ç§°ä¸º**Minor GC**ã€‚å¹´è½»ä¸€ä»£è¢«åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†â€”â€”ä¼Šç”¸å›­ï¼ˆ**Eden Memory**ï¼‰å’Œä¸¤ä¸ªå¹¸å­˜åŒºï¼ˆ**Survivor Memory**ï¼‰ï¼Œé»˜è®¤æ¯”ä¾‹æ˜¯8:1:1

- å¤§å¤šæ•°æ–°åˆ›å»ºçš„å¯¹è±¡éƒ½ä½äº Eden å†…å­˜ç©ºé—´ä¸­
- å½“ Eden ç©ºé—´è¢«å¯¹è±¡å¡«å……æ—¶ï¼Œæ‰§è¡Œ**Minor GC**ï¼Œå¹¶å°†æ‰€æœ‰å¹¸å­˜è€…å¯¹è±¡ç§»åŠ¨åˆ°ä¸€ä¸ªå¹¸å­˜è€…ç©ºé—´ä¸­
- Minor GC æ£€æŸ¥å¹¸å­˜è€…å¯¹è±¡ï¼Œå¹¶å°†å®ƒä»¬ç§»åŠ¨åˆ°å¦ä¸€ä¸ªå¹¸å­˜è€…ç©ºé—´ã€‚æ‰€ä»¥æ¯æ¬¡ï¼Œä¸€ä¸ªå¹¸å­˜è€…ç©ºé—´æ€»æ˜¯ç©ºçš„
- ç»è¿‡å¤šæ¬¡ GC å¾ªç¯åå­˜æ´»ä¸‹æ¥çš„å¯¹è±¡è¢«ç§»åŠ¨åˆ°è€å¹´ä»£ã€‚é€šå¸¸ï¼Œè¿™æ˜¯é€šè¿‡è®¾ç½®å¹´è½»ä¸€ä»£å¯¹è±¡çš„å¹´é¾„é˜ˆå€¼æ¥å®ç°çš„ï¼Œç„¶åä»–ä»¬æ‰æœ‰èµ„æ ¼æå‡åˆ°è€ä¸€ä»£

### 4.2 è€å¹´ä»£(Old Generation)

æ—§çš„ä¸€ä»£å†…å­˜åŒ…å«é‚£äº›ç»è¿‡è®¸å¤šè½®å°å‹GCåä»ç„¶å­˜æ´»çš„å¯¹è±¡ã€‚é€šå¸¸ï¼Œåƒåœ¾æ”¶é›†æ˜¯åœ¨è€å¹´ä»£å†…å­˜æ»¡æ—¶æ‰§è¡Œçš„ã€‚è€å¹´ä»£åƒåœ¾æ”¶é›†ç§°ä¸ºä¸»GCï¼Œé€šå¸¸éœ€è¦æ›´é•¿çš„æ—¶é—´ã€‚

![](https://tva1.sinaimg.cn/large/007S8ZIlly1gfwrsfft4hj31kw0u0q69.jpg)

### å¯¹è±¡çš„åˆ†é…è¿‡ç¨‹

ä¸ºå¯¹è±¡åˆ†é…å†…å­˜æ˜¯ä¸€ä»¶éå¸¸ä¸¥è°¨å’Œå¤æ‚çš„ä»»åŠ¡ï¼ŒJVM çš„è®¾è®¡è€…ä»¬ä¸ä»…éœ€è¦è€ƒè™‘å†…å­˜å¦‚ä½•åˆ†é…ã€åœ¨å“ªé‡Œåˆ†é…ç­‰é—®é¢˜ï¼Œå¹¶ä¸”ç”±äºå†…å­˜åˆ†é…ç®—æ³•å’Œå†…å­˜å›æ”¶ç®—æ³•å¯†åˆ‡ç›¸å…³ï¼Œæ‰€ä»¥è¿˜éœ€è¦è€ƒè™‘ GC æ‰§è¡Œå®Œå†…å­˜å›æ”¶åæ˜¯å¦ä¼šåœ¨å†…å­˜ç©ºé—´ä¸­äº§ç”Ÿå†…å­˜ç¢ç‰‡ã€‚

1. new çš„å¯¹è±¡å…ˆæ”¾åœ¨ä¼Šç”¸å›­åŒºï¼Œæ­¤åŒºæœ‰å¤§å°é™åˆ¶
2. å½“ä¼Šç”¸å›­çš„ç©ºé—´å¡«æ»¡æ—¶ï¼Œç¨‹åºåˆéœ€è¦åˆ›å»ºå¯¹è±¡ï¼ŒJVM çš„åƒåœ¾å›æ”¶å™¨å°†å¯¹ä¼Šç”¸å›­åŒºè¿›è¡Œåƒåœ¾å›æ”¶ï¼ˆMinor GCï¼‰ï¼Œå°†ä¼Šç”¸å›­åŒºä¸­çš„ä¸å†è¢«å…¶ä»–å¯¹è±¡æ‰€å¼•ç”¨çš„å¯¹è±¡è¿›è¡Œé”€æ¯ã€‚å†åŠ è½½æ–°çš„å¯¹è±¡æ”¾åˆ°ä¼Šç”¸å›­åŒº
3. ç„¶åå°†ä¼Šç”¸å›­ä¸­çš„å‰©ä½™å¯¹è±¡ç§»åŠ¨åˆ°å¹¸å­˜è€… 0 åŒº
4. å¦‚æœå†æ¬¡è§¦å‘åƒåœ¾å›æ”¶ï¼Œæ­¤æ—¶ä¼šé‡æ–°æ”¾å›å¹¸å­˜è€… 0 åŒºï¼Œæ¥ç€å†å»å¹¸å­˜è€… 1 åŒº
5. ä»€ä¹ˆæ—¶å€™æ‰ä¼šå»å…»è€åŒºå‘¢ï¼Ÿ é»˜è®¤æ˜¯ 15 æ¬¡å›æ”¶æ ‡è®°
6. 

![](/Users/starfish/Desktop/æˆªå±2020-06-16ä¸Šåˆ9.44.10.png)





### å¯¹è±¡çš„åˆ›å»º

è¯­è¨€å±‚é¢ï¼Œåˆ›å»ºå¯¹è±¡ï¼ˆå…‹éš†ã€ååºåˆ—åŒ–ï¼‰é€šå¸¸ä»…ä»…æ˜¯ä¸€ä¸ªnewå…³é”®å­—è€Œå·²ï¼Œä½†JVMé‡åˆ°ä¸€æ¡ new æŒ‡ä»¤æ—¶ï¼Œé¦–å…ˆ



### å¯¹è±¡çš„å†…å­˜å¸ƒå±€

åœ¨ HotSpot è™šæ‹Ÿæœºä¸­ï¼Œå¯¹è±¡åœ¨å†…å­˜ä¸­å­˜å‚¨çš„å¸ƒå±€å¯ä»¥åˆ†ä¸º 3 å—åŒºåŸŸï¼šå¯¹è±¡å¤´ï¼ˆHeaderï¼‰ã€å®ä¾‹æ•°æ®ï¼ˆInstance Dataï¼‰å’Œå¯¹é½å¡«å……ï¼ˆPaddingï¼‰ã€‚

![img](https://tva1.sinaimg.cn/large/00831rSTly1gdbsqxskuaj317i0rugom.jpg)

#### å¯¹è±¡å¤´

- **Mark Word**ï¼šç”¨äºå­˜å‚¨å¯¹è±¡è‡ªèº«çš„è¿è¡Œæ—¶æ•°æ®ï¼Œå­˜å‚¨äº†å¯¹è±¡çš„hashCodeã€GCä¿¡æ¯ã€é”ä¿¡æ¯ä¸‰éƒ¨åˆ†ã€‚å¦‚å“ˆå¸Œç ã€GCåˆ†ä»£å¹´é¾„ã€é”çŠ¶æ€æ ‡å¿—ã€çº¿ç¨‹æŒæœ‰çš„é”ã€åå‘çº¿ç¨‹IDã€åå‘æ—¶é—´æˆ³ç­‰ï¼Œè¿™éƒ¨åˆ†æ•°æ®çš„é•¿åº¦åœ¨32ä½å’Œ64ä½çš„è™šæ‹Ÿæœºï¼ˆæœªå¼€å¯å‹ç¼©æŒ‡é’ˆï¼‰ä¸­åˆ†åˆ«ä¸º 32bit å’Œ 64bit
- **Class Pointer**ï¼šç±»å‹æŒ‡é’ˆï¼Œç”¨æ¥æŒ‡å‘å¯¹è±¡å¯¹åº”çš„Classå¯¹è±¡ï¼ˆå…¶å¯¹åº”çš„å…ƒæ•°æ®å¯¹è±¡ï¼‰çš„å†…å­˜åœ°å€ï¼Œå³å¯¹è±¡æŒ‡å‘å®ƒçš„ç±»å…ƒæ•°æ®çš„æŒ‡é’ˆï¼Œè™šæ‹Ÿæœºé€šè¿‡è¿™ä¸ªæŒ‡é’ˆæ¥ç¡®å®šè¿™ä¸ªå¯¹è±¡æ˜¯å“ªä¸ªç±»çš„å®ä¾‹ã€‚åœ¨32ä½ç³»ç»Ÿå 4å­—èŠ‚ï¼Œåœ¨64ä½ç³»ç»Ÿä¸­å 8å­—èŠ‚ï¼›
- **Length**ï¼šå¦‚æœæ˜¯æ•°ç»„å¯¹è±¡ï¼Œè¿˜æœ‰ä¸€ä¸ªä¿å­˜æ•°ç»„é•¿åº¦çš„ç©ºé—´ï¼Œå 4ä¸ªå­—èŠ‚ï¼›

#### å¯¹è±¡å®ä¾‹æ•°æ®

å¯¹è±¡å®ä¾‹æ•°æ®åŒ…æ‹¬äº†å¯¹è±¡çš„æ‰€æœ‰æˆå‘˜å˜é‡ï¼Œå…¶å¤§å°ç”±å„ä¸ªæˆå‘˜å˜é‡çš„å¤§å°å†³å®šï¼Œæ¯”å¦‚ï¼šbyteå’Œbooleanæ˜¯1ä¸ªå­—èŠ‚ï¼Œshortå’Œcharæ˜¯2ä¸ªå­—èŠ‚ï¼Œintå’Œfloatæ˜¯4ä¸ªå­—èŠ‚ï¼Œlongå’Œdoubleæ˜¯8ä¸ªå­—èŠ‚ï¼Œreferenceæ˜¯4ä¸ªå­—èŠ‚ï¼ˆ64ä½ç³»ç»Ÿä¸­æ˜¯8ä¸ªå­—èŠ‚ï¼‰ã€‚

| Primitive Type | Memory Required(bytes) |
| -------------- | ---------------------- |
| boolean        | 1                      |
| byte           | 1                      |
| short          | 2                      |
| char           | 2                      |
| int            | 4                      |
| float          | 4                      |
| long           | 8                      |
| double         | 8                      |

å¯¹äºreferenceç±»å‹æ¥è¯´ï¼Œåœ¨32ä½ç³»ç»Ÿä¸Šå ç”¨4bytes, åœ¨64ä½ç³»ç»Ÿä¸Šå ç”¨8bytesã€‚

#### å¯¹é½å¡«å……

å¹¶ä¸æ˜¯å¿…ç„¶å­˜åœ¨çš„ï¼Œä¹Ÿæ²¡æœ‰ç‰¹åˆ«å«ä¹‰ï¼Œä»…ä»…èµ·åˆ°å ä½ç¬¦çš„ä½œç”¨ã€‚Javaå¯¹è±¡å ç”¨ç©ºé—´æ˜¯8å­—èŠ‚å¯¹é½çš„ï¼Œå³æ‰€æœ‰Javaå¯¹è±¡å ç”¨bytesæ•°å¿…é¡»æ˜¯8çš„å€æ•°ã€‚



### å¯¹è±¡çš„è®¿é—®å®šä½

Javaç¨‹åºéœ€è¦é€šè¿‡æ ˆä¸Šçš„å¼•ç”¨æ•°æ®æ¥æ“ä½œå †ä¸Šçš„å…·ä½“å¯¹è±¡ã€‚å¯¹è±¡çš„è®¿é—®æ–¹å¼å–å†³äºè™šæ‹Ÿæœºå®ç°ï¼Œç›®å‰ä¸»æµçš„è®¿é—®æ–¹å¼æœ‰**ä½¿ç”¨å¥æŸ„**å’Œ**ç›´æ¥æŒ‡é’ˆ**ä¸¤ç§ã€‚

å¥æŸ„ï¼Œå¯ä»¥ç†è§£ä¸ºæŒ‡å‘æŒ‡é’ˆçš„æŒ‡é’ˆï¼Œç»´æŠ¤æŒ‡å‘å¯¹è±¡çš„æŒ‡é’ˆå˜åŒ–ï¼Œè€Œå¯¹è±¡çš„å¥æŸ„æœ¬èº«ä¸å‘ç”Ÿå˜åŒ–ï¼›æŒ‡é’ˆï¼ŒæŒ‡å‘å¯¹è±¡ï¼Œä»£è¡¨å¯¹è±¡çš„å†…å­˜åœ°å€ã€‚

#### ä½¿ç”¨å¥æŸ„

Javaå †ä¸­åˆ’åˆ†å‡ºä¸€å—å†…å­˜æ¥ä½œä¸ºå¥æŸ„æ± ï¼Œå¼•ç”¨ä¸­å­˜å‚¨å¯¹è±¡çš„å¥æŸ„åœ°å€ï¼Œè€Œå¥æŸ„ä¸­åŒ…å«äº†å¯¹è±¡å®ä¾‹æ•°æ®ä¸ç±»å‹æ•°æ®å„è‡ªçš„å…·ä½“åœ°å€ä¿¡æ¯ã€‚

![img](https://img-blog.csdn.net/20160505130804767)

ä¼˜åŠ¿ï¼šå¼•ç”¨ä¸­å­˜å‚¨çš„æ˜¯ç¨³å®šçš„å¥æŸ„åœ°å€ï¼Œåœ¨å¯¹è±¡è¢«ç§»åŠ¨(åƒåœ¾æ”¶é›†æ—¶ç§»åŠ¨å¯¹è±¡æ˜¯éå¸¸æ™®éçš„è¡Œä¸º)æ—¶åªä¼šæ”¹å˜å¥æŸ„ä¸­çš„å®ä¾‹æ•°æ®æŒ‡é’ˆï¼Œè€Œå¼•ç”¨æœ¬èº«ä¸éœ€è¦ä¿®æ”¹ã€‚

#### ç›´æ¥æŒ‡é’ˆ

å¦‚æœä½¿ç”¨ç›´æ¥æŒ‡é’ˆè®¿é—®ï¼Œé‚£ä¹ˆJavaå †å¯¹è±¡çš„å¸ƒå±€ä¸­å°±å¿…é¡»è€ƒè™‘å¦‚ä½•æ”¾ç½®è®¿é—®ç±»å‹æ•°æ®çš„ç›¸å…³ä¿¡æ¯ï¼Œè€Œå¼•ç”¨ä¸­å­˜å‚¨çš„ç›´æ¥å°±æ˜¯å¯¹è±¡åœ°å€ã€‚HotSpot å°±æ˜¯ä½¿ç”¨ç›´æ¥æŒ‡é’ˆçš„æ–¹å¼è¿›è¡Œå¯¹è±¡è®¿é—®çš„ã€‚

![img](https://img-blog.csdn.net/20160505130823283)

ä¼˜åŠ¿ï¼šé€Ÿåº¦æ›´å¿«ï¼ŒèŠ‚çœäº†ä¸€æ¬¡æŒ‡é’ˆå®šä½çš„æ—¶é—´å¼€é”€ã€‚ç”±äºå¯¹è±¡çš„è®¿é—®åœ¨Javaä¸­éå¸¸é¢‘ç¹ï¼Œå› æ­¤è¿™ç±»å¼€é”€ç§¯å°‘æˆå¤šåä¹Ÿæ˜¯éå¸¸å¯è§‚çš„æ‰§è¡Œæˆæœ¬ã€‚ï¼ˆä¾‹å¦‚HotSpotï¼‰


### å¯¹è±¡åœ¨å †ä¸­çš„ç”Ÿå‘½å‘¨æœŸ

1. åœ¨JVMå†…å­˜æ¨¡å‹çš„å †ä¸­ï¼Œå †è¢«åˆ’åˆ†ä¸ºæ–°ç”Ÿä»£å’Œè€å¹´ä»£
   - æ–°ç”Ÿä»£åˆè¢«è¿›ä¸€æ­¥åˆ’åˆ†ä¸º**EdenåŒº**å’Œ**SurvivoråŒº**ï¼ŒSurvivoråŒºç”±**From Survivor**å’Œ**To Survivor**ç»„æˆ
2. å½“åˆ›å»ºä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œå¯¹è±¡ä¼šè¢«ä¼˜å…ˆåˆ†é…åˆ°æ–°ç”Ÿä»£çš„EdenåŒº
   - æ­¤æ—¶JVMä¼šç»™å¯¹è±¡å®šä¹‰ä¸€ä¸ª**å¯¹è±¡å¹´è½»è®¡æ•°å™¨**ï¼ˆ`-XX:MaxTenuringThreshold`ï¼‰
3. å½“Edenç©ºé—´ä¸è¶³æ—¶ï¼ŒJVMå°†æ‰§è¡Œæ–°ç”Ÿä»£çš„åƒåœ¾å›æ”¶ï¼ˆMinor GCï¼‰
   - JVMä¼šæŠŠå­˜æ´»çš„å¯¹è±¡è½¬ç§»åˆ°Survivorä¸­ï¼Œå¹¶ä¸”å¯¹è±¡å¹´é¾„+1
   - å¯¹è±¡åœ¨Survivorä¸­åŒæ ·ä¹Ÿä¼šç»å†Minor GCï¼Œæ¯ç»å†ä¸€æ¬¡Minor GCï¼Œå¯¹è±¡å¹´é¾„éƒ½ä¼š+1
4. å¦‚æœåˆ†é…çš„å¯¹è±¡è¶…è¿‡äº†`-XX:PetenureSizeThreshold`ï¼Œå¯¹è±¡ä¼š**ç›´æ¥è¢«åˆ†é…åˆ°è€å¹´ä»£**

### æŸ¥çœ‹JVMå †å†…å­˜åˆ†é…

1. åœ¨é»˜è®¤ä¸é…ç½®JVMå †å†…å­˜å¤§å°çš„æƒ…å†µä¸‹ï¼ŒJVMæ ¹æ®é»˜è®¤å€¼æ¥é…ç½®å½“å‰å†…å­˜å¤§å°
2. åœ¨JDK 1.7ä¸­ï¼Œé»˜è®¤æƒ…å†µä¸‹æ–°ç”Ÿä»£å’Œè€å¹´ä»£çš„æ¯”ä¾‹æ˜¯1:2ï¼Œå¯ä»¥é€šè¿‡`â€“XX:NewRatio`æ¥é…ç½®
   - æ–°ç”Ÿä»£ä¸­çš„**Eden**:**From Survivor**:**To Survivor**çš„æ¯”ä¾‹æ˜¯**8:1:1**ï¼Œå¯ä»¥é€šè¿‡`-XX:SurvivorRatio`æ¥é…ç½®
3. è‹¥åœ¨JDK 1.7ä¸­å¼€å¯äº† `-XX:+UseAdaptiveSizePolicy`ï¼ŒJVMä¼šåŠ¨æ€è°ƒæ•´JVMå †ä¸­å„ä¸ªåŒºåŸŸçš„å¤§å°ä»¥åŠè¿›å…¥è€å¹´ä»£çš„å¹´é¾„
   - æ­¤æ—¶`â€“XX:NewRatio`å’Œ`-XX:SurvivorRatio`å°†ä¼šå¤±æ•ˆï¼Œè€ŒJDK 1.8æ˜¯é»˜è®¤å¼€å¯`-XX:+UseAdaptiveSizePolicy`
   - åœ¨JDK 1.8ä¸­ï¼Œ**ä¸è¦éšæ„å…³é—­**`-XX:+UseAdaptiveSizePolicy`ï¼Œé™¤éå¯¹å †å†…å­˜çš„åˆ’åˆ†æœ‰æ˜ç¡®çš„è§„åˆ’
   - æ¯æ¬¡GCåéƒ½ä¼šé‡æ–°è®¡ç®—Edenã€From Survivorã€To Survivorçš„å¤§å°
     - è®¡ç®—ä¾æ®æ˜¯**GCè¿‡ç¨‹**ä¸­ç»Ÿè®¡çš„**GCæ—¶é—´**ã€**ååé‡**ã€**å†…å­˜å ç”¨é‡**

```
$ java -XX:+PrintFlagsFinal -version | grep HeapSize
    uintx ErgoHeapSizeLimit                         = 0               {product}
    uintx HeapSizePerGCThread                       = 87241520        {product}
    uintx InitialHeapSize                          := 261304192       {product}
    uintx LargePageHeapSizeThreshold                = 134217728       {product}
    uintx MaxHeapSize                              := 4181721088      {product}
java version "1.7.0_67"
Java(TM) SE Runtime Environment (build 1.7.0_67-b01)
Java HotSpot(TM) 64-Bit Server VM (build 24.65-b04, mixed mode)
```

```
$ jmap -heap 10773
Attaching to process ID 10773, please wait...
Debugger attached successfully.
Server compiler detected.
JVM version is 24.65-b04

using thread-local object allocation.
Garbage-First (G1) GC with 12 thread(s)

Heap Configuration:
   MinHeapFreeRatio = 40
   MaxHeapFreeRatio = 70
   MaxHeapSize      = 268435456 (256.0MB)
   NewSize          = 1363144 (1.2999954223632812MB)
   MaxNewSize       = 17592186044415 MB
   OldSize          = 5452592 (5.1999969482421875MB)
   NewRatio         = 2
   SurvivorRatio    = 8
   PermSize         = 134217728 (128.0MB)
   MaxPermSize      = 134217728 (128.0MB)
   G1HeapRegionSize = 4194304 (4.0MB)

Heap Usage:
G1 Heap:
   regions  = 64
   capacity = 268435456 (256.0MB)
   used     = 89813712 (85.65303039550781MB)
   free     = 178621744 (170.3469696044922MB)
   33.45821499824524% used
G1 Young Generation:
Eden Space:
   regions  = 11
   capacity = 163577856 (156.0MB)
   used     = 46137344 (44.0MB)
   free     = 117440512 (112.0MB)
   28.205128205128204% used
Survivor Space:
   regions  = 1
   capacity = 4194304 (4.0MB)
   used     = 4194304 (4.0MB)
   free     = 0 (0.0MB)
   100.0% used
G1 Old Generation:
   regions  = 11
   capacity = 100663296 (96.0MB)
   used     = 39482064 (37.65303039550781MB)
   free     = 61181232 (58.34696960449219MB)
   39.221906661987305% used
Perm Generation:
   capacity = 134217728 (128.0MB)
   used     = 41068592 (39.16606140136719MB)
   free     = 93149136 (88.83393859863281MB)
   30.598485469818115% used

16298 interned Strings occupying 1462984 bytes.
```



### Minor GCã€Major GCã€Full GC

jvm åœ¨è¿›è¡Œ GC æ—¶ï¼Œå¹¶éæ¯æ¬¡éƒ½å¯¹ä¸Šé¢ä¸‰ä¸ªå†…å­˜ï¼ˆæ–°ç”Ÿä»£ã€è€å¹´ä»£ï¼›æ–¹æ³•åŒºï¼‰åŒºåŸŸä¸€èµ·å›æ”¶çš„ï¼Œå¤§éƒ¨åˆ†æ—¶å€™å›æ”¶çš„éƒ½æ˜¯æŒ‡æ–°ç”Ÿä»£ã€‚

é’ˆå¯¹ HotSpot VM çš„å®ç°ï¼Œå®ƒé‡Œé¢çš„ GC æŒ‰ç…§å›æ”¶åŒºåŸŸåˆåˆ†ä¸ºä¸¤å¤§ç±»ï¼šéƒ¨åˆ†æ”¶é›†ï¼ˆPartial GCï¼‰ï¼Œæ•´å †æ”¶é›†ï¼ˆFull  GCï¼‰

- éƒ¨åˆ†æ”¶é›†ï¼šä¸æ˜¯å®Œæ•´æ”¶é›†æ•´ä¸ª Java å †çš„åƒåœ¾æ”¶é›†ã€‚å…¶ä¸­åˆåˆ†ä¸ºï¼š
  - æ–°ç”Ÿä»£æ”¶é›†ï¼ˆMinor GC/Young GCï¼‰:åªæ˜¯æ–°ç”Ÿä»£çš„åƒåœ¾æ”¶é›†
  - è€å¹´ä»£æ”¶é›†ï¼ˆMajor GC/Old GCï¼‰ï¼šåªæ˜¯è€å¹´ä»£çš„åƒåœ¾æ”¶é›†
    - ç›®å‰ï¼Œåªæœ‰ CMS GC ä¼šæœ‰å•ç‹¬æ”¶é›†è€å¹´ä»£çš„è¡Œä¸º
    - å¾ˆå¤šæ—¶å€™ Major GC ä¼šå’Œ Full GC  æ··åˆä½¿ç”¨ï¼Œéœ€è¦å…·ä½“åˆ†è¾¨æ˜¯è€å¹´ä»£å›æ”¶è¿˜æ˜¯æ•´å †å›æ”¶
  - æ··åˆæ”¶é›†ï¼ˆMixed GCï¼‰ï¼šæ”¶é›†æ•´ä¸ªæ–°ç”Ÿä»£ä»¥åŠéƒ¨åˆ†è€å¹´ä»£çš„åƒåœ¾æ”¶é›†
    - ç›®å‰åªæœ‰ G1 GC ä¼šæœ‰è¿™ç§è¡Œä¸º
  - æ•´å †æ”¶é›†ï¼ˆFull GCï¼‰ï¼šæ”¶é›†æ•´ä¸ª Java å †å’Œæ–¹æ³•åŒºçš„åƒåœ¾



#### æœ€ç®€å•çš„åˆ†ä»£å¼ GCç­–ç•¥çš„è§¦å‘æ¡ä»¶

å¹´è½»ä»£ GC(Minor GC)è§¦å‘æœºåˆ¶ï¼š

- å½“å¹´è½»ä»£ç©ºé—´ä¸è¶³æ—¶ï¼Œå°±ä¼šè§¦å‘ Minor GCï¼Œè¿™é‡Œçš„å¹´è½»ä»£æ»¡æŒ‡çš„æ˜¯ Eden åŒºæ»¡ï¼ŒSurvicor æ»¡ä¸ä¼šå¼•å‘ GC
- å› ä¸º Java å¯¹è±¡å¤§å¤šéƒ½å…·å¤‡æœç”Ÿå¤•ç­çš„ç‰¹æ€§ï¼Œæ‰€ä»¥ Minor GC  éå¸¸é¢‘ç¹ï¼Œä¸€èˆ¬å›æ”¶é€Ÿåº¦ä¹Ÿè¾ƒå¿«
- Minor GC  ä¼šå¼•å‘ STWï¼Œæš‚åœå…¶ä»–ç”¨æˆ·çº¿ç¨‹ï¼Œç­‰åƒåœ¾å›æ”¶ç»“æŸï¼Œç”¨æˆ·çº¿ç¨‹æ‰æ¢å¤è¿è¡Œ

è€å¹´ä»£ GC(Major GC/Full GC)è§¦å‘æœºåˆ¶ï¼š

- æŒ‡å‘ç”Ÿåœ¨è€å¹´ä»£çš„ GCï¼Œå¯¹è±¡ä»è€å¹´ä»£æ¶ˆå¤±æ—¶ï¼Œæˆ‘ä»¬è¯´ Major GC  æˆ– Full GC å‘ç”Ÿäº†
- å‡ºç°äº† Major GCï¼Œç»å¸¸ä¼šä¼´éšè‡³å°‘ä¸€æ¬¡çš„ Minor GCï¼ˆä¹Ÿä¸æ˜¯ç»å¯¹çš„ï¼Œåœ¨ Parallel Scavenge æ”¶é›†å™¨çš„æ‰‹æœºç­–ç•¥é‡Œå°±æœ‰ç›´æ¥è¿›è¡Œ Major GC çš„ç­–ç•¥é€‰æ‹©è¿‡ç¨‹ï¼‰
  - åœ¨è€å¹´ä»£ç©ºé—´ä¸è¶³æ—¶ï¼Œä¼šå…ˆå°è¯•è§¦å‘ Minor GCï¼Œå¦‚æœä¹‹åç©ºé—´è¿˜ä¸è¶³ï¼Œåˆ™è§¦å‘ Major GC
- Major GCçš„é€Ÿåº¦ä¸€èˆ¬ä¼šæ¯” Minor GC  æ…¢ 10 å€ä»¥ä¸Šï¼ŒSTWçš„æ—¶é—´æ›´é•¿
- å¦‚æœ Major GC åï¼Œå†…å­˜è¿˜ä¸è¶³ï¼Œå°±ä¼š OOM
- Major GC çš„é€Ÿåº¦ä¸€èˆ¬ä¼šæ¯” Minor GC æ…¢ 10 å€ä»¥ä¸Š



### TLAB

#### ä»€ä¹ˆæ˜¯ TLAB ï¼ˆThread Local Allocation Bufferï¼‰?

- ä»å†…å­˜æ¨¡å‹è€Œä¸æ˜¯åƒåœ¾å›æ”¶çš„è§’åº¦ï¼Œå¯¹ Eden åŒºåŸŸç»§ç»­è¿›è¡Œåˆ’åˆ†ï¼ŒJVM ä¸ºæ¯ä¸ªçº¿ç¨‹åˆ†é…äº†ä¸€ä¸ªç§æœ‰ç¼“å­˜åŒºåŸŸï¼Œå®ƒåŒ…å«åœ¨ Eden ç©ºé—´å†…
- å¤šçº¿ç¨‹åŒæ—¶åˆ†é…å†…å­˜æ—¶ï¼Œä½¿ç”¨ TLAB å¯ä»¥é¿å…ä¸€ç³»åˆ—çš„éçº¿ç¨‹å®‰å…¨é—®é¢˜ï¼ŒåŒæ—¶è¿˜èƒ½æå‡å†…å­˜åˆ†é…çš„ååé‡ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å°†è¿™ç§å†…å­˜åˆ†é…æ–¹å¼ç§°ä¸º**å¿«é€Ÿåˆ†é…ç­–ç•¥**
- OpenJDK è¡ç”Ÿå‡ºæ¥çš„ JVM å¤§éƒ½æä¾›äº† TLAB è®¾è®¡

#### ä¸ºä»€ä¹ˆè¦æœ‰ TLAB ?

- å †åŒºæ˜¯çº¿ç¨‹å…±äº«çš„ï¼Œä»»ä½•çº¿ç¨‹éƒ½å¯ä»¥è®¿é—®åˆ°å †åŒºä¸­çš„å…±äº«æ•°æ®
- ç”±äºå¯¹è±¡å®ä¾‹çš„åˆ›å»ºåœ¨ JVM ä¸­éå¸¸é¢‘ç¹ï¼Œå› æ­¤åœ¨å¹¶å‘ç¯å¢ƒä¸‹ä»å †åŒºä¸­åˆ’åˆ†å†…å­˜ç©ºé—´æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„
- ä¸ºé¿å…å¤šä¸ªçº¿ç¨‹æ“ä½œåŒä¸€åœ°å€ï¼Œéœ€è¦ä½¿ç”¨åŠ é”ç­‰æœºåˆ¶ï¼Œè¿›è€Œå½±å“åˆ†é…é€Ÿåº¦





![](https://tva1.sinaimg.cn/large/007S8ZIlly1gfui9b7rugj31fm0q6e4x.jpg)





### å †æ˜¯åˆ†é…å¯¹è±¡å­˜å‚¨çš„å”¯ä¸€é€‰æ‹©å—

![](/Users/starfish/Desktop/æˆªå±2020-06-16ä¸Šåˆ11.27.10.png)



![](/Users/starfish/Desktop/æˆªå±2020-06-16ä¸Šåˆ11.33.11.png)



![](/Users/starfish/Desktop/æˆªå±2020-06-16ä¸Šåˆ11.33.53.png)

![](/Users/starfish/Desktop/æˆªå±2020-06-16ä¸Šåˆ11.34.49.png)



å‚æ•°è®¾ç½®ï¼š

- åœ¨ JDK 6u23ç‰ˆæœ¬ä¹‹åï¼ŒHotSpot ä¸­é»˜è®¤å°±å·²ç»å¼€å¯äº†é€ƒé€¸åˆ†æ
- å¦‚æœä½¿ç”¨è¾ƒæ—©ç‰ˆæœ¬ï¼Œå¯ä»¥é€šè¿‡`-XX"+DoEscapeAnalysis`æ˜¾å¼å¼€å¯

å¼€å‘ä¸­ä½¿ç”¨å±€éƒ¨å˜é‡ï¼Œå°±ä¸è¦åœ¨æ–¹æ³•å¤–å®šä¹‰





ä½¿ç”¨é€ƒé€¸åˆ†æï¼Œç¼–è¯‘å™¨å¯ä»¥å¯¹ä»£ç åšä¼˜åŒ–ï¼š

- æ ˆä¸Šåˆ†é…ï¼šå°†å †åˆ†é…è½¬åŒ–ä¸ºæ ˆåˆ†é…ã€‚å¦‚æœä¸€ä¸ªå¯¹è±¡åœ¨å­ç¨‹åºä¸­è¢«åˆ†é…ï¼Œè¦ä½¿æŒ‡å‘è¯¥å¯¹è±¡çš„æŒ‡é’ˆæ°¸è¿œä¸ä¼šé€ƒé€¸ï¼Œå¯¹è±¡å¯èƒ½æ˜¯æ ˆåˆ†é…çš„å€™é€‰ï¼Œè€Œä¸æ˜¯å †åˆ†é…
- åŒæ­¥çœç•¥ï¼šå¦‚æœä¸€ä¸ªå¯¹è±¡è¢«å‘ç°åªèƒ½ä»ä¸€ä¸ªçº¿ç¨‹è¢«è®¿é—®åˆ°ï¼Œé‚£ä¹ˆå¯¹äºè¿™ä¸ªå¯¹è±¡çš„æ“ä½œå¯ä»¥ä¸è€ƒè™‘åŒæ­¥
- åˆ†ç¦»å¯¹è±¡æˆ–æ ‡é‡æ›¿æ¢ï¼šæœ‰çš„å¯¹è±¡å¯èƒ½ä¸éœ€è¦ä½œä¸ºä¸€ä¸ªè¿ç»­çš„å†…å­˜ç»“æ„å­˜åœ¨ä¹Ÿå¯ä»¥è¢«è®¿é—®åˆ°ï¼Œé‚£ä¹ˆå¯¹è±¡çš„éƒ¨åˆ†ï¼ˆæˆ–å…¨éƒ¨ï¼‰å¯ä»¥ä¸å­˜å‚¨åœ¨å†…å­˜ï¼Œè€Œå­˜å‚¨åœ¨ CPU å¯„å­˜å™¨

JIT ç¼–è¯‘å™¨åœ¨ç¼–è¯‘æœŸé—´æ ¹æ®é€ƒé€¸åˆ†æçš„ç»“æœï¼Œå‘ç°å¦‚æœä¸€ä¸ªå¯¹è±¡å¹¶æ²¡æœ‰é€ƒé€¸å‡ºæ–¹æ³•çš„è¯ï¼Œå°±å¯èƒ½è¢«ä¼˜åŒ–æˆæ ˆä¸Šåˆ†é…ã€‚åˆ†é…å®Œæˆåï¼Œç»§ç»­åœ¨è°ƒç”¨æ ˆå†…æ‰§è¡Œï¼Œæœ€åçº¿ç¨‹ç»“æŸï¼Œæ ˆç©ºé—´è¢«å›æ”¶ï¼Œå±€éƒ¨å˜é‡å¯¹è±¡ä¹Ÿè¢«å›æ”¶ã€‚è¿™æ ·å°±æ— éœ€è¿›è¡Œåƒåœ¾å›æ”¶äº†ã€‚

å¸¸è§æ ˆä¸Šåˆ†é…çš„åœºæ™¯ï¼š

æˆå‘˜å˜é‡èµ‹å€¼ã€æ–¹æ³•è¿”å›å€¼ã€å®ä¾‹å¼•ç”¨ä¼ é€’



![](/Users/starfish/Desktop/æˆªå±2020-06-16ä¸‹åˆ1.37.02.png)



![](/Users/starfish/Desktop/æˆªå±2020-06-16ä¸‹åˆ1.37.54.png)

![](/Users/starfish/Desktop/æˆªå±2020-06-16ä¸‹åˆ1.40.37.png)

![](/Users/starfish/Desktop/æˆªå±2020-06-16ä¸‹åˆ1.44.26.png)

![](/Users/starfish/Desktop/æˆªå±2020-06-16ä¸Šåˆ10.59.28.png)

------



## äº”ã€æ–¹æ³•åŒº

- æ–¹æ³•åŒºï¼ˆMethod Areaï¼‰ä¸ Java å †ä¸€æ ·ï¼Œæ˜¯æ‰€æœ‰çº¿ç¨‹å…±äº«çš„å†…å­˜åŒºåŸŸã€‚
- JDK7 ä¹‹å‰ï¼ˆæ°¸ä¹…ä»£ï¼‰ç”¨äºå­˜å‚¨å·²è¢«è™šæ‹ŸæœºåŠ è½½çš„ç±»ä¿¡æ¯ã€å¸¸é‡ã€å­—ç¬¦ä¸²å¸¸é‡ã€ç±»é™æ€å˜é‡ã€å³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘åçš„ä»£ç ç­‰æ•°æ®ã€‚
- è™½ç„¶ Java è™šæ‹Ÿæœºè§„èŒƒæŠŠæ–¹æ³•åŒºæè¿°ä¸ºå †çš„ä¸€ä¸ªé€»è¾‘éƒ¨åˆ†ï¼Œä½†æ˜¯å®ƒå´æœ‰ä¸€ä¸ªåˆ«åå« Non-Heapï¼ˆéå †ï¼‰ï¼Œç›®çš„åº”è¯¥æ˜¯ä¸ Java å †åŒºåˆ†å¼€ã€‚
- è¿è¡Œæ—¶å¸¸é‡æ± ï¼ˆRuntime Constant Poolï¼‰æ˜¯æ–¹æ³•åŒºçš„ä¸€éƒ¨åˆ†ã€‚Class æ–‡ä»¶ä¸­é™¤äº†æœ‰ç±»çš„ç‰ˆæœ¬/å­—æ®µ/æ–¹æ³•/æ¥å£ç­‰æè¿°ä¿¡æ¯å¤–ï¼Œè¿˜æœ‰ä¸€é¡¹ä¿¡æ¯æ˜¯å¸¸é‡æ± ï¼ˆConstant Pool Tableï¼‰ï¼Œç”¨äºå­˜æ”¾ç¼–è¯‘æœŸç”Ÿæˆçš„å„ç§å­—é¢é‡å’Œç¬¦å·å¼•ç”¨ï¼Œè¿™éƒ¨åˆ†å†…å®¹å°†ç±»åœ¨åŠ è½½åè¿›å…¥æ–¹æ³•åŒºçš„è¿è¡Œæ—¶å¸¸é‡æ± ä¸­å­˜æ”¾ã€‚è¿è¡ŒæœŸé—´ä¹Ÿå¯èƒ½å°†æ–°çš„å¸¸é‡æ”¾å…¥æ± ä¸­ï¼Œè¿™ç§ç‰¹æ€§è¢«å¼€å‘äººå‘˜åˆ©ç”¨å¾—æ¯”è¾ƒå¤šçš„æ˜¯ [String.intern()](https://links.jianshu.com/go?to=https%3A%2F%2Ftech.meituan.com%2Fin_depth_understanding_string_intern.html) æ–¹æ³•ã€‚å—æ–¹æ³•åŒºå†…å­˜çš„é™åˆ¶ï¼Œå½“å¸¸é‡æ± æ— æ³•å†ç”³è¯·åˆ°å†…å­˜æ—¶ä¼šæŠ›å‡º OutOfMemoryError å¼‚å¸¸ã€‚
- æ–¹æ³•åŒºçš„å¤§å°å’Œå †ç©ºé—´ä¸€æ ·ï¼Œå¯ä»¥é€‰æ‹©å›ºå®šå¤§å°ä¹Ÿå¯é€‰æ‹©å¯æ‰©å±•ï¼Œæ–¹æ³•åŒºçš„å¤§å°å†³å®šäº†ç³»ç»Ÿå¯ä»¥æ”¾å¤šå°‘ä¸ªç±»ï¼Œå¦‚æœç³»ç»Ÿç±»å¤ªå¤šï¼Œå¯¼è‡´æ–¹æ³•åŒºæº¢å‡ºï¼Œè™šæ‹ŸæœºåŒæ ·ä¼šæŠ›å‡ºå†…å­˜æº¢å‡ºé”™è¯¯
- JVM å…³é—­åæ–¹æ³•åŒºå³è¢«é‡Šæ”¾



## è§£æƒ‘

ä½ æ˜¯å¦ä¹Ÿæœ‰çœ‹ä¸åŒçš„å‚è€ƒèµ„æ–™ï¼Œæœ‰çš„å†…å­˜ç»“æ„å›¾æœ‰æ–¹æ³•åŒºï¼Œæœ‰çš„åˆæ˜¯æ°¸ä¹…ä»£ï¼Œå…ƒæ•°æ®åŒºï¼Œä¸€è„¸æ‡µé€¼çš„æ—¶å€™ï¼Ÿ

- **æ–¹æ³•åŒºï¼ˆmethod areaï¼‰**åªæ˜¯**JVMè§„èŒƒ**ä¸­å®šä¹‰çš„ä¸€ä¸ª**æ¦‚å¿µ**ï¼Œç”¨äºå­˜å‚¨ç±»ä¿¡æ¯ã€å¸¸é‡æ± ã€é™æ€å˜é‡ã€JITç¼–è¯‘åçš„ä»£ç ç­‰æ•°æ®ï¼Œå¹¶æ²¡æœ‰è§„å®šå¦‚ä½•å»å®ç°å®ƒï¼Œä¸åŒçš„å‚å•†æœ‰ä¸åŒçš„å®ç°ã€‚è€Œ**æ°¸ä¹…ä»£ï¼ˆPermGenï¼‰**æ˜¯ **Hotspot** è™šæ‹Ÿæœºç‰¹æœ‰çš„æ¦‚å¿µï¼Œ Java8 çš„æ—¶å€™åˆè¢«**å…ƒç©ºé—´**å–ä»£äº†ï¼Œæ°¸ä¹…ä»£å’Œå…ƒç©ºé—´éƒ½å¯ä»¥ç†è§£ä¸ºæ–¹æ³•åŒºçš„è½åœ°å®ç°ã€‚
- æ°¸ä¹…ä»£ç‰©ç†æ˜¯å †çš„ä¸€éƒ¨åˆ†ï¼Œå’Œæ–°ç”Ÿä»£ï¼Œè€å¹´ä»£åœ°å€æ˜¯è¿ç»­çš„ï¼ˆå—åƒåœ¾å›æ”¶å™¨ç®¡ç†ï¼‰ï¼Œè€Œå…ƒç©ºé—´å­˜åœ¨äºæœ¬åœ°å†…å­˜ï¼ˆæˆ‘ä»¬å¸¸è¯´çš„å †å¤–å†…å­˜ï¼Œä¸å—åƒåœ¾å›æ”¶å™¨ç®¡ç†ï¼‰ï¼Œè¿™æ ·å°±ä¸å— JVM é™åˆ¶äº†ï¼Œä¹Ÿæ¯”è¾ƒéš¾å‘ç”ŸOOMï¼ˆéƒ½ä¼šæœ‰æº¢å‡ºå¼‚å¸¸ï¼‰
- Java7 ä¸­æˆ‘ä»¬é€šè¿‡`-XX:PermSize` å’Œ `-xx:MaxPermSize` æ¥è®¾ç½®æ°¸ä¹…ä»£å‚æ•°ï¼ŒJava8 ä¹‹åï¼Œéšç€æ°¸ä¹…ä»£çš„å–æ¶ˆï¼Œè¿™äº›å‚æ•°ä¹Ÿå°±éšä¹‹å¤±æ•ˆäº†ï¼Œæ”¹ä¸ºé€šè¿‡`-XX:MetaspaceSize` å’Œ `-XX:MaxMetaspaceSize` ç”¨æ¥è®¾ç½®å…ƒç©ºé—´å‚æ•°
- å­˜å‚¨å†…å®¹ä¸åŒï¼Œå…ƒç©ºé—´å­˜å‚¨ç±»çš„å…ƒä¿¡æ¯ï¼Œé™æ€å˜é‡å’Œå¸¸é‡æ± ç­‰å¹¶å…¥å †ä¸­ã€‚ç›¸å½“äºæ°¸ä¹…ä»£çš„æ•°æ®è¢«åˆ†åˆ°äº†å †å’Œå…ƒç©ºé—´ä¸­
- å¦‚æœæ–¹æ³•åŒºåŸŸä¸­çš„å†…å­˜ä¸èƒ½ç”¨äºæ»¡è¶³åˆ†é…è¯·æ±‚ï¼Œåˆ™ Java è™šæ‹ŸæœºæŠ›å‡º `OutOfMemoryError`
- JVM è§„èŒƒè¯´æ–¹æ³•åŒºåœ¨é€»è¾‘ä¸Šæ˜¯å †çš„ä¸€éƒ¨åˆ†ï¼Œä½†ç›®å‰å®é™…ä¸Šæ˜¯ä¸ Java å †åˆ†å¼€çš„ï¼ˆNon-Heapï¼‰



æ‰€ä»¥å¯¹äºæ–¹æ³•åŒºï¼ŒJava8 ä¹‹åçš„å˜åŒ–ï¼š

- ç§»é™¤äº†æ°¸ä¹…ä»£ï¼ˆPermGenï¼‰ï¼Œæ›¿æ¢ä¸ºå…ƒç©ºé—´ï¼ˆMetaspaceï¼‰ï¼›
- æ°¸ä¹…ä»£ä¸­çš„ class metadata è½¬ç§»åˆ°äº† native memoryï¼ˆæœ¬åœ°å†…å­˜ï¼Œè€Œä¸æ˜¯è™šæ‹Ÿæœºï¼‰ï¼›
- æ°¸ä¹…ä»£ä¸­çš„ interned Strings å’Œ class static variables è½¬ç§»åˆ°äº† Java heapï¼›
- æ°¸ä¹…ä»£å‚æ•° ï¼ˆPermSize MaxPermSizeï¼‰ -> å…ƒç©ºé—´å‚æ•°ï¼ˆMetaspaceSize MaxMetaspaceSizeï¼‰

![](/Users/starfish/Desktop/æˆªå±2020-06-16ä¸‹åˆ4.38.35.png)

![](/Users/starfish/Desktop/æˆªå±2020-06-16ä¸‹åˆ4.40.24.png)





![](/Users/starfish/Desktop/æˆªå±2020-06-16ä¸‹åˆ4.48.32.png)



### éšJDKç‰ˆæœ¬å˜è¿çš„æ–¹æ³•åŒº

![](/Users/starfish/Desktop/æˆªå±2020-06-16ä¸‹åˆ5.01.21.png)

![](/Users/starfish/Desktop/æˆªå±2020-06-16ä¸‹åˆ5.08.18.png)





![](/Users/starfish/Desktop/æˆªå±2020-06-16ä¸‹åˆ5.11.14.png)



![](/Users/starfish/Desktop/æˆªå±2020-06-16ä¸‹åˆ5.14.32.png)





### æ–¹æ³•åŒºå†…éƒ¨ç»“æ„

![](/Users/starfish/Desktop/æˆªå±2020-06-16ä¸‹åˆ5.20.04.png)

![](/Users/starfish/Desktop/æˆªå±2020-06-16ä¸‹åˆ5.21.10.png)



#### ç±»å‹ä¿¡æ¯

![](/Users/starfish/Desktop/æˆªå±2020-06-16ä¸‹åˆ5.23.29.png)

åŸŸï¼ˆFieldï¼‰ä¿¡æ¯

- JVM å¿…é¡»åœ¨æ–¹æ³•åŒºä¸­ä¿å­˜ç±»å‹çš„æ‰€æœ‰åŸŸçš„ç›¸å…³ä¿¡æ¯ä»¥åŠåŸŸçš„å£°æ˜é¡ºåº
- åŸŸçš„ç›¸å…³ä¿¡æ¯åŒ…æ‹¬ï¼šåŸŸåç§°ã€åŸŸç±»å‹ã€åŸŸä¿®é¥°ç¬¦ï¼ˆpublicã€privateã€protectedã€staticã€finalã€volatileã€transient çš„æŸä¸ªå­é›†ï¼‰

![](/Users/starfish/Desktop/æˆªå±2020-06-16ä¸‹åˆ5.24.15.png)



![](/Users/starfish/Desktop/æˆªå±2020-06-16ä¸‹åˆ5.29.39.png)

è¡¥å……è¯´æ˜ï¼šå…¨å±€å¸¸é‡ static final

è¢«å£°æ˜ä¸º final çš„ç±»å˜é‡çš„å¤„ç†æ–¹æ³•åˆ™ä¸åŒï¼Œæ¯ä¸ªå…¨å±€å¸¸é‡åœ¨ç¼–è¯‘çš„æ—¶å€™å°±ä¼šè¢«åˆ†é…äº†ã€‚

![](/Users/starfish/Desktop/æˆªå±2020-06-16ä¸‹åˆ5.35.34.png)

![](/Users/starfish/Desktop/æˆªå±2020-06-16ä¸‹åˆ5.38.46.png)

![](/Users/starfish/Desktop/æˆªå±2020-06-16ä¸‹åˆ5.40.00.png)





![](/Users/starfish/Desktop/æˆªå±2020-06-16ä¸‹åˆ5.43.28.png)



æ–¹æ³•åŒºåœ¨ JDK6ã€7ã€8ä¸­çš„æ¼”è¿›ç»†èŠ‚

![](/Users/starfish/Desktop/æˆªå±2020-06-16ä¸‹åˆ5.53.43.png)

#### JDK6

- Class å…ƒæ•°æ®ä¿¡æ¯
- æ¯ä¸ªç±»çš„è¿è¡Œæ—¶å¸¸é‡æ± ï¼ˆå­—æ®µã€æ–¹æ³•ã€ç±»ã€æ¥å£ç­‰ç¬¦å·å¼•ç”¨ï¼‰ã€ç¼–è¯‘åçš„ä»£ç 
- é™æ€å­—æ®µï¼ˆæ— è®ºæ˜¯å¦æœ‰finalï¼‰åœ¨ instanceKlass æœ«å°¾ï¼ˆä½äº PermGen å†…ï¼‰
- oopï¼ˆOrdinary Object Pointerï¼ˆæ™®é€šå¯¹è±¡æŒ‡é’ˆï¼‰ï¼‰ å…¶å®å°±æ˜¯ Class å¯¹è±¡å®ä¾‹
- å…¨å±€å­—ç¬¦ä¸²å¸¸é‡æ±  StringTableï¼Œæœ¬è´¨ä¸Šå°±æ˜¯ä¸ª Hashtable
- ç¬¦å·å¼•ç”¨ï¼ˆç±»å‹æŒ‡é’ˆæ˜¯ SymbolKlassï¼‰

#### JDK7

- Class å…ƒæ•°æ®ä¿¡æ¯
- æ¯ä¸ªç±»çš„è¿è¡Œæ—¶å¸¸é‡æ± ï¼ˆå­—æ®µã€æ–¹æ³•ã€ç±»ã€æ¥å£ç­‰ç¬¦å·å¼•ç”¨ï¼‰ã€ç¼–è¯‘åçš„ä»£ç 
- é™æ€å­—æ®µä» instanceKlass æœ«å°¾ç§»åŠ¨åˆ°äº† java.lang.Class å¯¹è±¡ï¼ˆoopï¼‰çš„æœ«å°¾ï¼ˆä½äº Java Heap å†…ï¼‰
- oop ä¸å…¨å±€å­—ç¬¦ä¸²å¸¸é‡æ± ç§»åˆ° Java Heap ä¸Š
- ç¬¦å·å¼•ç”¨è¢«ç§»åŠ¨åˆ° Native Heap ä¸­

#### JDK8

- ç§»é™¤æ°¸ä¹…ä»£ http://openjdk.java.net/jeps/122
- Class å…ƒæ•°æ®ä¿¡æ¯
- æ¯ä¸ªç±»çš„è¿è¡Œæ—¶å¸¸é‡æ± ã€ç¼–è¯‘åçš„ä»£ç ç§»åˆ°äº†å¦ä¸€å—ä¸å †ä¸ç›¸è¿çš„æœ¬åœ°å†…å­˜ -- å…ƒç©ºé—´ï¼ˆMetaspaceï¼‰



![](/Users/starfish/Desktop/æˆªå±2020-06-16ä¸‹åˆ6.00.25.png)

![](/Users/starfish/Desktop/æˆªå±2020-06-16ä¸‹åˆ5.58.51.png)

![](/Users/starfish/Desktop/æˆªå±2020-06-16ä¸‹åˆ5.58.14.png)

### ç§»é™¤æ°¸ä¹…ä»£åŸå› 

![](/Users/starfish/Desktop/æˆªå±2020-06-16ä¸‹åˆ6.02.56.png)

![](/Users/starfish/Desktop/æˆªå±2020-06-16ä¸‹åˆ6.05.26.png)

![](/Users/starfish/Desktop/æˆªå±2020-06-16ä¸‹åˆ6.07.47.png)

![](/Users/starfish/Desktop/æˆªå±2020-06-16ä¸‹åˆ6.08.15.png)



### æ–¹æ³•åŒºçš„åƒåœ¾å›æ”¶









## å…­ã€ è¿è¡Œæ—¶å¸¸é‡æ± 

## ä¸ƒã€ç›´æ¥å†…å­˜



## å…«ã€ OutOfMemoryError å¼‚å¸¸

### 8.1 Java å †æº¢å‡º

Java å †ç”¨äºå­˜å‚¨å¯¹è±¡å®ä¾‹ï¼Œåªè¦ä¸æ–­çš„åˆ›å»ºå¯¹è±¡ï¼Œå¹¶ä¸”ä¿è¯ GC Roots åˆ°å¯¹è±¡ä¹‹é—´æœ‰å¯è¾¾è·¯å¾„æ¥é¿å…åƒåœ¾å›æ”¶æœºåˆ¶æ¸…é™¤è¿™äº›å¯¹è±¡ï¼Œé‚£ä¹ˆåœ¨å¯¹è±¡æ•°é‡åˆ°è¾¾æœ€å¤§å †çš„å®¹é‡é™åˆ¶åå°±ä¼šäº§ç”Ÿå†…å­˜æº¢å‡ºå¼‚å¸¸

### 8.2 è™šæ‹Ÿæœºæ ˆå’Œæœ¬åœ°æ–¹æ³•æ ˆæº¢å‡º

### 8.3 æ–¹æ³•åŒºå’Œè¿è¡Œæ—¶å¸¸é‡æ± æº¢å‡º

### 8.4 æœ¬æœºç›´æ¥å†…å­˜æº¢å‡º



## ä¹ã€å†…å­˜æ³„éœ² / å†…å­˜æº¢å‡º





å‚è€ƒï¼š**Java Language and Virtual Machine Specificationsï¼šhttps://docs.oracle.com/javase/specs/index.html**

ã€Šæ·±å…¥ç†è§£ Java è™šæ‹Ÿæœº ç¬¬ä¸‰ç‰ˆã€‹

å®‹çº¢åº·JVMæ•™ç¨‹

https://www.cnblogs.com/wicfhwffg/p/9382677.html