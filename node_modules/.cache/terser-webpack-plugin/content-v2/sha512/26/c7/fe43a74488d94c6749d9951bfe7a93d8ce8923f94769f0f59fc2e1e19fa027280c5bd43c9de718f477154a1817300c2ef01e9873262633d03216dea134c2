{"code":"(window.webpackJsonp=window.webpackJsonp||[]).push([[61],{620:function(s,e,t){\"use strict\";t.r(e);var _=t(6),a=Object(_.a)({},(function(){var s=this,e=s.$createElement,t=s._self._c||e;return t(\"ContentSlotsDistributor\",{attrs:{\"slot-key\":s.$parent.slotKey}},[t(\"h1\",{attrs:{id:\"redis-哨兵模式\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#redis-哨兵模式\"}},[s._v(\"#\")]),s._v(\" Redis 哨兵模式\")]),s._v(\" \"),t(\"blockquote\",[t(\"p\",[s._v(\"我们知道 Reids 提供了主从模式的机制，来保证可用性，可是如果主库发生故障了，那就直接会影响到从库的同步，怎么办呢？\")]),s._v(\" \"),t(\"p\",[s._v(\"所以，如果主库挂了，我们就需要运行一个新主库，比如说把一个从库切换为主库，把它当成主库。这就涉及到三个问题：\")]),s._v(\" \"),t(\"ol\",[t(\"li\",[s._v(\"主库真的挂了吗？\")]),s._v(\" \"),t(\"li\",[s._v(\"该选择哪个从库作为主库？\")]),s._v(\" \"),t(\"li\",[s._v(\"怎么把新主库的相关信息通知给从库和客户端呢？\")])]),s._v(\" \"),t(\"p\",[s._v(\"围绕这 3 个问题，我们来看下不需要人工干预就可以解决这三个问题的 Redis 哨兵。\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://i02piccdn.sogoucdn.com/e9220e7b03e0103b\",alt:\"\"}})])]),s._v(\" \"),t(\"h3\",{attrs:{id:\"一、redis-sentinel-哨兵\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#一、redis-sentinel-哨兵\"}},[s._v(\"#\")]),s._v(\" 一、Redis Sentinel 哨兵\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://cdn.jsdelivr.net/gh/Jstarfish/picBed/redis/redis-sentinel.png\",alt:\"\"}})]),s._v(\" \"),t(\"p\",[s._v(\"上图 展示了一个典型的哨兵架构图，它由两部分组成，哨兵节点和数据节点：\")]),s._v(\" \"),t(\"ul\",[t(\"li\",[t(\"strong\",[s._v(\"哨兵节点：\")]),s._v(\" 哨兵系统由一个或多个哨兵节点组成，哨兵节点是特殊的 Redis 节点，\"),t(\"mark\",[s._v(\"不存储数据\")]),s._v(\"；\")]),s._v(\" \"),t(\"li\",[t(\"strong\",[s._v(\"数据节点：\")]),s._v(\" 主节点和从节点都是数据节点；\")])]),s._v(\" \"),t(\"p\",[s._v(\"在复制的基础上，哨兵实现了 \"),t(\"strong\",[s._v(\"自动化的故障恢复\")]),s._v(\" 功能，下面是官方对于哨兵功能的描述：\")]),s._v(\" \"),t(\"ul\",[t(\"li\",[t(\"p\",[t(\"strong\",[s._v(\"监控（Monitoring）：\")]),s._v(\" 哨兵会不断地检查主节点和从节点是否运作正常。\")]),s._v(\" \"),t(\"p\",[s._v(\"监控是指哨兵进程在运行时，周期性地给所有的主从库发送 PING 命令，检测它们是否仍然在线运行。如果从库没有在规定时间内响应哨兵的 PING 命令，哨兵就会把它标记为“下线状态”；同样，如果主库也没有在规定时间内响应哨兵的 PING 命令，哨兵就会判定主库下线，然后开始自动切换主库的流程。\")])]),s._v(\" \"),t(\"li\",[t(\"p\",[t(\"strong\",[s._v(\"通知（Notification）：\")]),s._v(\" 当被监控的某个 Redis 服务器出现问题时， 哨兵可以通过 API 向管理员或者其他应用程序发送通知。\")]),s._v(\" \"),t(\"p\",[s._v(\"在执行通知任务时，哨兵会把新主库的连接信息发给其他从库，让它们执行 \"),t(\"code\",[s._v(\"replicaof\")]),s._v(\" 命令，和新主库建立连接，并进行数据复制。同时，哨兵会把新主库的连接信息通知给客户端，让它们把请求操作发到新主库上。\")])]),s._v(\" \"),t(\"li\",[t(\"p\",[t(\"strong\",[s._v(\"自动故障转移（Automatic failover）/ 选主：\")]),s._v(\" 当 \"),t(\"strong\",[s._v(\"主节点\")]),s._v(\" 不能正常工作时，哨兵会开始 \"),t(\"strong\",[s._v(\"自动故障转移操作\")]),s._v(\"，它会将失效主节点的其中一个 \"),t(\"strong\",[s._v(\"从节点升级为新的主节点\")]),s._v(\"，并让其他从节点改为复制新的主节点。\")])]),s._v(\" \"),t(\"li\",[t(\"p\",[t(\"strong\",[s._v(\"配置提供者（Configuration provider）：\")]),s._v(\" 客户端在初始化时，通过连接哨兵来获得当前 Redis 服务的主节点地址。\")]),s._v(\" \"),t(\"p\",[s._v(\"当客户端试图连接失效的主服务器时， 集群也会向客户端返回新主服务器的地址， 使得集群可以使用新主服务器代替失效服务器。\")])])]),s._v(\" \"),t(\"p\",[s._v(\"其中，监控和自动故障转移功能，使得哨兵可以及时发现主节点故障并完成转移。而配置提供者和通知功能，则需要在与客户端的交互中才能体现。\")]),s._v(\" \"),t(\"h3\",{attrs:{id:\"二、-hello-wolrd\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#二、-hello-wolrd\"}},[s._v(\"#\")]),s._v(\" 二、 Hello Wolrd\")]),s._v(\" \"),t(\"h4\",{attrs:{id:\"_2-1-部署主从节点\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_2-1-部署主从节点\"}},[s._v(\"#\")]),s._v(\" 2.1 部署主从节点\")]),s._v(\" \"),t(\"p\",[s._v(\"哨兵系统中的主从节点，与普通的主从节点配置是一样的，并不需要做任何额外配置。\")]),s._v(\" \"),t(\"p\",[s._v(\"下面分别是主节点（port=6379）和 2 个从节点（port=6380、6381）的配置文件：\")]),s._v(\" \"),t(\"div\",{staticClass:\"language-bash extra-class\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-bash\"}},[t(\"code\",[t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"#redis.conf  master\")]),s._v(\"\\nport \"),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"6379\")]),s._v(\"\\ndaemonize \"),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"yes\")]),s._v(\"\\nlogfile \"),t(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"6379.log\"')]),s._v(\"\\ndbfilename \"),t(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"dump-6379.rdb\"')]),s._v(\"\\n\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"#redis_6380.conf\")]),s._v(\"\\nport \"),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"6380\")]),s._v(\"\\ndaemonize \"),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"yes\")]),s._v(\"\\nlogfile \"),t(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"6380.log\"')]),s._v(\"\\ndbfilename \"),t(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"dump-6380.rdb\"')]),s._v(\"\\nreplicaof \"),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"127.0\")]),s._v(\".0.1 \"),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"6379\")]),s._v(\"\\n\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"#redis_6381.conf\")]),s._v(\"\\nport \"),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"6381\")]),s._v(\"\\ndaemonize \"),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"yes\")]),s._v(\"\\nlogfile \"),t(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"6381.log\"')]),s._v(\"\\ndbfilename \"),t(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"dump-6381.rdb\"')]),s._v(\"\\nreplicaof \"),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"127.0\")]),s._v(\".0.1 \"),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"6379\")]),s._v(\"\\n\")])])]),t(\"p\",[s._v(\"然后我们可以执行 \"),t(\"code\",[s._v(\"redis-server\")]),s._v(\" 来根据配置文件启动不同的 Redis 实例，依次启动主从节点：\")]),s._v(\" \"),t(\"div\",{staticClass:\"language-bash extra-class\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-bash\"}},[t(\"code\",[s._v(\"redis-server redis.conf\\nredis-server redis_6380.conf \\nredis-server redis_6381.conf\\n\")])])]),t(\"p\",[s._v(\"节点启动后，我们执行 \"),t(\"code\",[s._v(\"redis-cli\")]),s._v(\" 默认连接到我们端口为 \"),t(\"code\",[s._v(\"6379\")]),s._v(\" 的主节点执行 \"),t(\"code\",[s._v(\"info Replication\")]),s._v(\" 检查一下主从状态是否正常：(可以看到下方正确地显示了两个从节点)\")]),s._v(\" \"),t(\"div\",{staticClass:\"language-bash extra-class\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-bash\"}},[t(\"code\",[t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"127.0\")]),s._v(\".0.1:637\"),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[t(\"span\",{pre:!0,attrs:{class:\"token file-descriptor important\"}},[s._v(\"9\")]),s._v(\">\")]),s._v(\" info replication\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"# Replication\")]),s._v(\"\\nrole:master\\nconnected_slaves:2\\nslave0:ip\"),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"127.0\")]),s._v(\".0.1,port\"),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"6380\")]),s._v(\",state\"),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),s._v(\"online,offset\"),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"154\")]),s._v(\",lag\"),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"1\")]),s._v(\"\\nslave1:ip\"),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"127.0\")]),s._v(\".0.1,port\"),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"6381\")]),s._v(\",state\"),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),s._v(\"online,offset\"),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"140\")]),s._v(\",lag\"),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"1\")]),s._v(\"\\nmaster_replid:52a58d69125881d3af366d0559439377a70ae879\\nmaster_replid2:0000000000000000000000000000000000000000\\nmaster_repl_offset:154\\nsecond_repl_offset:-1\\nrepl_backlog_active:1\\nrepl_backlog_size:1048576\\nrepl_backlog_first_byte_offset:1\\nrepl_backlog_histlen:154\\n\")])])]),t(\"h4\",{attrs:{id:\"_2-2-部署哨兵节点\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_2-2-部署哨兵节点\"}},[s._v(\"#\")]),s._v(\" 2.2 部署哨兵节点\")]),s._v(\" \"),t(\"p\",[s._v(\"按照上面同样的方法，我们给哨兵节点也创建三个配置文件。\"),t(\"em\",[s._v(\"(哨兵节点本质上是特殊的 Redis 节点，所以配置几乎没什么差别，只是在端口上做区分就好，每个哨兵只需要配置监控主节点，就可以自动发现其他的哨兵节点和从节点)\")])]),s._v(\" \"),t(\"div\",{staticClass:\"language-bash extra-class\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-bash\"}},[t(\"code\",[t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"# redis-sentinel-26379.conf\")]),s._v(\"\\nport \"),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"26379\")]),s._v(\"\\ndaemonize \"),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"yes\")]),s._v(\"\\nlogfile \"),t(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"26379.log\"')]),s._v(\"\\nsentinel monitor mymaster \"),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"127.0\")]),s._v(\".0.1 \"),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"6379\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"2\")]),s._v(\"\\n\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"# redis-sentinel-26380.conf\")]),s._v(\"\\nport \"),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"26380\")]),s._v(\"\\ndaemonize \"),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"yes\")]),s._v(\"\\nlogfile \"),t(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"26380.log\"')]),s._v(\"\\nsentinel monitor mymaster \"),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"127.0\")]),s._v(\".0.1 \"),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"6379\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"2\")]),s._v(\"\\n\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"# redis-sentinel-26381.conf\")]),s._v(\"\\nport \"),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"26381\")]),s._v(\"\\ndaemonize \"),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"yes\")]),s._v(\"\\nlogfile \"),t(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"26381.log\"')]),s._v(\"\\nsentinel monitor mymaster \"),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"127.0\")]),s._v(\".0.1 \"),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"6379\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"2\")]),s._v(\"\\n\")])])]),t(\"p\",[s._v(\"其中，\"),t(\"code\",[s._v(\"sentinel monitor mymaster 127.0.0.1 6379 2\")]),s._v(\" 配置的含义是：该哨兵节点监控 \"),t(\"code\",[s._v(\"127.0.0.1:6379\")]),s._v(\" 这个主节点，该主节点的名称是 \"),t(\"code\",[s._v(\"mymaster\")]),s._v(\"，最后的 \"),t(\"code\",[s._v(\"2\")]),s._v(\" 的含义与主节点的故障判定有关：至少需要 \"),t(\"code\",[s._v(\"2\")]),s._v(\" 个哨兵节点同意，才能判定主节点故障并进行故障转移。\")]),s._v(\" \"),t(\"p\",[s._v(\"启动 3 个哨兵节点：\")]),s._v(\" \"),t(\"div\",{staticClass:\"language-bash extra-class\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-bash\"}},[t(\"code\",[s._v(\"redis-sentinel redis-sentinel-26379.conf\\nredis-sentinel redis-sentinel-26380.conf\\nredis-server redis-sentinel-26381.conf --sentinel   \"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"#等同于 redis-sentinel redis-sentinel-26381.conf\")]),s._v(\"\\n\")])])]),t(\"p\",[s._v(\"使用 \"),t(\"code\",[s._v(\"redis-cil\")]),s._v(\" 工具连接哨兵节点，并执行 \"),t(\"code\",[s._v(\"info Sentinel\")]),s._v(\" 命令来查看是否已经在监视主节点了：\")]),s._v(\" \"),t(\"div\",{staticClass:\"language-bash extra-class\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-bash\"}},[t(\"code\",[s._v(\"redis-cli -p \"),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"26380\")]),s._v(\" \\n\"),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"127.0\")]),s._v(\".0.1:2638\"),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[t(\"span\",{pre:!0,attrs:{class:\"token file-descriptor important\"}},[s._v(\"0\")]),s._v(\">\")]),s._v(\" info sentinel\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"# Sentinel\")]),s._v(\"\\nsentinel_masters:1\\nsentinel_tilt:0\\nsentinel_running_scripts:0\\nsentinel_scripts_queue_length:0\\nsentinel_simulate_failure_flags:0\\nmaster0:name\"),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),s._v(\"mymaster,status\"),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),s._v(\"ok,address\"),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"127.0\")]),s._v(\".0.1:6379,slaves\"),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"2\")]),s._v(\",sentinels\"),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"3\")]),s._v(\"\\n\")])])]),t(\"p\",[s._v(\"此时你打开刚才写好的哨兵配置文件，你还会发现出现了一些变化。\")]),s._v(\" \"),t(\"h4\",{attrs:{id:\"_2-3-演示故障转移\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_2-3-演示故障转移\"}},[s._v(\"#\")]),s._v(\" 2.3 演示故障转移\")]),s._v(\" \"),t(\"p\",[s._v(\"我们先看下我们启动的 redis 进程，3 个数据节点，3 个哨兵节点\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://cdn.jsdelivr.net/gh/Jstarfish/picBed/redis/redis-sentinel-ps.png\",alt:\"\"}})]),s._v(\" \"),t(\"p\",[s._v(\"使用 \"),t(\"code\",[s._v(\"kill\")]),s._v(\" 命令来杀掉主节点，\"),t(\"strong\",[s._v(\"同时\")]),s._v(\" 在哨兵节点中执行 \"),t(\"code\",[s._v(\"info Sentinel\")]),s._v(\" 命令来观察故障节点的过程：\")]),s._v(\" \"),t(\"p\",[s._v(\"如果 \"),t(\"strong\",[s._v(\"刚杀掉瞬间\")]),s._v(\" 在哨兵节点中执行 \"),t(\"code\",[s._v(\"info\")]),s._v(\" 命令来查看，会发现主节点还没有切换过来，因为哨兵发现主节点故障并转移需要一段时间：\")]),s._v(\" \"),t(\"div\",{staticClass:\"language-bash extra-class\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-bash\"}},[t(\"code\",[t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"# 第一时间查看哨兵节点发现并未转移，还在 6379 端口\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"127.0\")]),s._v(\".0.1:2637\"),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[t(\"span\",{pre:!0,attrs:{class:\"token file-descriptor important\"}},[s._v(\"9\")]),s._v(\">\")]),s._v(\" info Sentinel\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"# Sentinel\")]),s._v(\"\\nsentinel_masters:1\\nsentinel_tilt:0\\nsentinel_running_scripts:0\\nsentinel_scripts_queue_length:0\\nsentinel_simulate_failure_flags:0\\nmaster0:name\"),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),s._v(\"mymaster,status\"),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),s._v(\"ok,address\"),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"127.0\")]),s._v(\".0.1:6379,slaves\"),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"2\")]),s._v(\",sentinels\"),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"3\")]),s._v(\"\\n\")])])]),t(\"p\",[s._v(\"一段时间之后你再执行 \"),t(\"code\",[s._v(\"info\")]),s._v(\" 命令，查看，你就会发现主节点已经切换成了 \"),t(\"code\",[s._v(\"6381\")]),s._v(\" 端口的从节点：\")]),s._v(\" \"),t(\"div\",{staticClass:\"language-bash extra-class\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-bash\"}},[t(\"code\",[t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"# 过一段时间之后在执行，发现已经切换了 6381 端口\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"127.0\")]),s._v(\".0.1:2637\"),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[t(\"span\",{pre:!0,attrs:{class:\"token file-descriptor important\"}},[s._v(\"9\")]),s._v(\">\")]),s._v(\" info Sentinel\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"# Sentinel\")]),s._v(\"\\nsentinel_masters:1\\nsentinel_tilt:0\\nsentinel_running_scripts:0\\nsentinel_scripts_queue_length:0\\nsentinel_simulate_failure_flags:0\\nmaster0:name\"),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),s._v(\"mymaster,status\"),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),s._v(\"ok,address\"),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"127.0\")]),s._v(\".0.1:6381,slaves\"),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"2\")]),s._v(\",sentinels\"),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"3\")]),s._v(\"\\n\")])])]),t(\"p\",[s._v(\"但同时还可以发现，\"),t(\"strong\",[s._v(\"哨兵节点认为新的主节点仍然有两个从节点\")]),s._v(\" \"),t(\"em\",[s._v(\"(上方 slaves=2)\")]),s._v(\"，这是因为哨兵在将 \"),t(\"code\",[s._v(\"6381\")]),s._v(\" 切换成主节点的同时，将 \"),t(\"code\",[s._v(\"6379\")]),s._v(\" 节点置为其从节点。虽然 \"),t(\"code\",[s._v(\"6379\")]),s._v(\" 从节点已经挂掉，但是由于 \"),t(\"strong\",[s._v(\"哨兵并不会对从节点进行客观下线\")]),s._v(\"，因此认为该从节点一直存在。当 \"),t(\"code\",[s._v(\"6379\")]),s._v(\" 节点重新启动后，会自动变成 \"),t(\"code\",[s._v(\"6381\")]),s._v(\" 节点的从节点。\")]),s._v(\" \"),t(\"p\",[s._v(\"另外，在故障转移的阶段，哨兵和主从节点的配置文件都会被改写：\")]),s._v(\" \"),t(\"ul\",[t(\"li\",[t(\"strong\",[s._v(\"对于主从节点：\")]),s._v(\" 主要是 \"),t(\"code\",[s._v(\"slaveof\")]),s._v(\" 配置的变化，新的主节点没有了 \"),t(\"code\",[s._v(\"slaveof\")]),s._v(\" 配置，其从节点则 \"),t(\"code\",[s._v(\"slaveof\")]),s._v(\" 新的主节点。\")]),s._v(\" \"),t(\"li\",[t(\"strong\",[s._v(\"对于哨兵节点：\")]),s._v(\" 除了主从节点信息的变化，纪元(epoch) \"),t(\"em\",[s._v(\"(记录当前集群状态的参数)\")]),s._v(\" 也会变化，纪元相关的参数都 +1 了。\")])]),s._v(\" \"),t(\"h3\",{attrs:{id:\"三、哨兵机制的工作流程\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#三、哨兵机制的工作流程\"}},[s._v(\"#\")]),s._v(\" 三、哨兵机制的工作流程\")]),s._v(\" \"),t(\"p\",[s._v(\"其实哨兵主要负责的就是三个任务：\"),t(\"strong\",[s._v(\"监控\")]),s._v(\"、\"),t(\"strong\",[s._v(\"选主\")]),s._v(\"和\"),t(\"strong\",[s._v(\"通知\")]),s._v(\"。\")]),s._v(\" \"),t(\"p\",[s._v(\"在监控和选主过程中，哨兵都需要做一些决策，比如\")]),s._v(\" \"),t(\"ul\",[t(\"li\",[s._v(\"在监控任务中，哨兵需要判断主库、从库是否处于下线状态\")]),s._v(\" \"),t(\"li\",[s._v(\"在选主任务中，哨兵也要决定选择哪个从库实例作为主库\")])]),s._v(\" \"),t(\"p\",[s._v(\"这就引出了两个概念，“主观下线”和“客观下线”\")]),s._v(\" \"),t(\"h4\",{attrs:{id:\"_3-1-主观下线和客观下线\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_3-1-主观下线和客观下线\"}},[s._v(\"#\")]),s._v(\" 3.1 主观下线和客观下线\")]),s._v(\" \"),t(\"p\",[s._v(\"我先解释下什么是“主观下线”。\")]),s._v(\" \"),t(\"p\",[t(\"strong\",[s._v(\"哨兵进程会使用 PING 命令检测它自己和主、从库的网络连接情况，用来判断实例的状态\")]),s._v(\"。如果哨兵发现主库或从库对 PING 命令的响应超时了，那么，哨兵就会先把它标记为“主观下线”。\")]),s._v(\" \"),t(\"p\",[s._v(\"如果检测的是从库，那么，哨兵简单地把它标记为“主观下线”就行了，因为从库的下线影响一般不太大，集群的对外服务不会间断。\")]),s._v(\" \"),t(\"p\",[s._v(\"但是，如果检测的是主库，那么，哨兵还不能简单地把它标记为“主观下线”，开启主从切换。因为很有可能存在这么一个情况：那就是哨兵误判了，其实主库并没有故障。可是，一旦启动了主从切换，后续的选主和通知操作都会带来额外的计算和通信开销。\")]),s._v(\" \"),t(\"p\",[s._v(\"为了避免这些不必要的开销，我们要特别注意误判的情况。\")]),s._v(\" \"),t(\"p\",[s._v(\"误判一般会发生在\"),t(\"strong\",[s._v(\"集群网络压力较大、网络拥塞，或者是主库本身压力较大\")]),s._v(\"的情况下。一旦哨兵判断主库下线了，就会开始选择新主库，并让从库和新主库进行数据同步，这个过程本身就会有开销，例如，哨兵要花时间选出新主库，从库也需要花时间和新主库同步。\")]),s._v(\" \"),t(\"p\",[s._v(\"那怎么减少误判呢？\")]),s._v(\" \"),t(\"p\",[s._v(\"在日常生活中，当我们要对一些重要的事情做判断的时候，经常会和家人或朋友一起商量一下，然后再做决定。\")]),s._v(\" \"),t(\"p\",[s._v(\"哨兵机制也是类似的，它通常会采用多实例组成的集群模式进行部署，这也被称为\"),t(\"strong\",[s._v(\"哨兵集群\")]),s._v(\"。引入多个哨兵实例一起来判断，就可以避免单个哨兵因为自身网络状况不好，而误判主库下线的情况。同时，多个哨兵的网络同时不稳定的概率较小，由它们一起做决策，误判率也能降低。\")]),s._v(\" \"),t(\"p\",[s._v(\"在判断主库是否下线时，不能由一个哨兵说了算，只有大多数的哨兵实例，都判断主库已经“主观下线”了，主库才会被标记为“\"),t(\"strong\",[s._v(\"客观下线\")]),s._v(\"”，这个叫法也是表明主库下线成为一个客观事实了。这个判断原则就是：少数服从多数。同时，这会进一步触发哨兵开始主从切换流程。\")]),s._v(\" \"),t(\"blockquote\",[t(\"p\",[t(\"strong\",[s._v(\"需要特别注意的是，客观下线是主节点才有的概念；如果从节点和哨兵节点发生故障，被哨兵主观下线后，不会再有后续的客观下线和故障转移操作。\")])])]),s._v(\" \"),t(\"h4\",{attrs:{id:\"_3-2-选举领导者哨兵节点\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_3-2-选举领导者哨兵节点\"}},[s._v(\"#\")]),s._v(\" 3.2 选举领导者哨兵节点\")]),s._v(\" \"),t(\"p\",[s._v(\"当主节点被判断客观下线以后，各个哨兵节点会进行协商，选举出一个领导者哨兵节点，并由该领导者节点对其进行故障转移操作。\")]),s._v(\" \"),t(\"p\",[s._v(\"监视该主节点的所有哨兵都有可能被选为领导者，选举使用的算法是 Raft 算法；Raft 算法的基本思路是先到先得：即在一轮选举中，哨兵 A 向 B 发送成为领导者的申请，如果 B 没有同意过其他哨兵，则会同意 A 成为领导者。(Raft 算法：https://raft.github.io/)\")]),s._v(\" \"),t(\"h4\",{attrs:{id:\"_3-3-故障转移\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_3-3-故障转移\"}},[s._v(\"#\")]),s._v(\" 3.3 故障转移\")]),s._v(\" \"),t(\"p\",[s._v(\"接着，选举出的领导者哨兵，开始故障转移操作，大概分 3 步：\")]),s._v(\" \"),t(\"ol\",[t(\"li\",[s._v(\"第一步要做的就是在已下线主服务器属下的所有从服务器中，挑选出一个状态良好、数据完整的从服务器\")]),s._v(\" \"),t(\"li\",[s._v(\"第二步，更新主从状态，向选出的从服务器发送 \"),t(\"code\",[s._v(\"slaveof no one\")]),s._v(\" 命令，将这个从服务器转换为主服务器，并通过 \"),t(\"code\",[s._v(\"slaveof\")]),s._v(\" 命令让其他节点成为其从节点\")]),s._v(\" \"),t(\"li\",[s._v(\"第三步将已下线的主节点设置为从节点\")])]),s._v(\" \"),t(\"p\",[s._v(\"细说下第一步的选主过程\")]),s._v(\" \"),t(\"p\",[s._v(\"一般来说，我把哨兵选择新主库的过程称为“\"),t(\"strong\",[s._v(\"筛选 + 打分\")]),s._v(\"”。\")]),s._v(\" \"),t(\"p\",[s._v(\"筛选就是先过滤掉不健康的从节点，那些被标记为主观下线、已断线、或者最后一次回复 PING 命令的时间大于五秒钟的从服务器都会被 \"),t(\"strong\",[s._v(\"淘汰\")]),s._v(\"。\")]),s._v(\" \"),t(\"p\",[s._v(\"打分就是按 Redis 给定的三个规则，给剩下的从库逐个打分，将得分最高的从库选为新主库，这个规则分别是：\")]),s._v(\" \"),t(\"ul\",[t(\"li\",[t(\"p\",[s._v(\"优先级最高的从库得分最高\")]),s._v(\" \"),t(\"p\",[s._v(\"用户可以通过 \"),t(\"code\",[s._v(\"slave-priority\")]),s._v(\" 配置项，给不同的从库设置不同优先级。比如，你有两个从库，它们的内存大小不一样，你可以手动给内存大的实例设置一个高优先级。在选主时，哨兵会给优先级高的从库打高分，如果有一个从库优先级最高，那么它就是新主库了。如果从库的优先级都一样，那么哨兵开始第二轮打分。\")])]),s._v(\" \"),t(\"li\",[t(\"p\",[s._v(\"和旧主库同步程度最接近的从库得分高\")]),s._v(\" \"),t(\"p\",[s._v(\"从库的 \"),t(\"code\",[s._v(\"slave_repl_offset\")]),s._v(\" 需要最接近 \"),t(\"code\",[s._v(\"master_repl_offset\")]),s._v(\"，即得分最高。\")])]),s._v(\" \"),t(\"li\",[t(\"p\",[s._v(\"ID 号小的从库得分高\")]),s._v(\" \"),t(\"p\",[s._v(\"每个实例都会有一个 runid，这个 ID 就类似于这里的从库的编号。目前，Redis 在选主库时，有一个默认的规定：在优先级和复制进度都相同的情况下，ID 号最小的从库得分最高，会被选为新主库。\")])])]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://cdn.jsdelivr.net/gh/Jstarfish/picBed/redis/redis-select-master%20(1).jpg\",alt:\"\"}})]),s._v(\" \"),t(\"h3\",{attrs:{id:\"四、哨兵集群的原理\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#四、哨兵集群的原理\"}},[s._v(\"#\")]),s._v(\" 四、哨兵集群的原理\")]),s._v(\" \"),t(\"p\",[s._v(\"实际上，一旦多个实例组成了\"),t(\"strong\",[s._v(\"哨兵集群\")]),s._v(\"，即使有哨兵实例出现故障挂掉了，其他哨兵还能继续协作完成主从库切换的工作，包括判定主库是不是处于下线状态，选择新主库，以及通知从库和客户端。\")]),s._v(\" \"),t(\"p\",[s._v(\"认真看到这里的话，应该会有个疑问，我们在 hello world 环节中只是在哨兵节点加了一条配置\")]),s._v(\" \"),t(\"div\",{staticClass:\"language-bash extra-class\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-bash\"}},[t(\"code\",[s._v(\"sentinel monitor mymaster \"),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"127.0\")]),s._v(\".0.1 \"),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"6379\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"2\")]),s._v(\"\\n\")])])]),t(\"p\",[s._v(\"怎么就能组成一个哨兵集群呢？\")]),s._v(\" \"),t(\"p\",[s._v(\"一套合理的监控机制是哨兵节点判定节点不可达的重要保证，Redis 哨兵通过\"),t(\"mark\",[t(\"strong\",[s._v(\"三个定时监控任务\")])]),s._v(\"完成对各个节点发现和监控：\")]),s._v(\" \"),t(\"ol\",[t(\"li\",[t(\"p\",[t(\"strong\",[s._v(\"每隔 10 秒，每个哨兵节点会向主节点和从节点发送 info 命令获取最新的拓扑结构\")])]),s._v(\" \"),t(\"p\",[s._v(\"这个定时任务的作用具体可以表现在三个方面：\")]),s._v(\" \"),t(\"ul\",[t(\"li\",[s._v(\"通过向主节点执行 \"),t(\"em\",[s._v(\"info\")]),s._v(\" 命令，获取从节点的信息，这也是为什么哨兵节点不需要显式配置监控从节点。\")]),s._v(\" \"),t(\"li\",[s._v(\"当有新的从节点加入时都可以立刻感知出来。\")]),s._v(\" \"),t(\"li\",[s._v(\"节点不可达或者故障转移后，可以通过 info 命令实时更新节点拓扑信息\")])])]),s._v(\" \"),t(\"li\",[t(\"p\",[t(\"strong\",[s._v(\"每隔 2 秒，每个哨兵节点会向 Redis 数据节点的 __sentinel__:hello 频道上发送该哨兵节点对于主节点的判断以及当前哨兵节点的信息，同时每个哨兵节点也会订阅该频道，来了解其他哨兵节点以及它们对主节点的判断。\")])]),s._v(\" \"),t(\"p\",[s._v(\"这个定时任务可以完成以下两个工作：\")]),s._v(\" \"),t(\"ul\",[t(\"li\",[s._v(\"发现新的哨兵节点：通过订阅主节点的 \"),t(\"code\",[s._v(\"__sentinel__：hello\")]),s._v(\" 了解其他的哨兵节点信息，如果是新加入的哨兵节点，将该哨兵节点信息保存起来，并与该哨兵节点创建连接。\")]),s._v(\" \"),t(\"li\",[s._v(\"哨兵节点之间交换主节点的状态，作为后面客观下线以及领导者选举的依据。\")])])]),s._v(\" \"),t(\"li\",[t(\"p\",[t(\"strong\",[s._v(\"每隔 1 秒，每个哨兵节点会向主节点、从节点、其余哨兵节点发送一条 ping 命令做一次心跳检测，来确认这些节点当前是否可达。\")])]),s._v(\" \"),t(\"p\",[s._v(\"通过这个定时任务，哨兵节点对主节点、从节点、其余哨兵节点都建立起连接，实现了对每个节点的监控，这个定时任务是节点失败判定的重要依据\")])])]),s._v(\" \"),t(\"h4\",{attrs:{id:\"_4-1-基于-pub-sub-机制的哨兵集群组成\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_4-1-基于-pub-sub-机制的哨兵集群组成\"}},[s._v(\"#\")]),s._v(\" 4.1 基于 pub/sub 机制的哨兵集群组成\")]),s._v(\" \"),t(\"p\",[s._v(\"哨兵实例之间可以相互发现，要归功于 Redis 提供的 pub/sub 机制，也就是 发布/订阅 机制。\")]),s._v(\" \"),t(\"p\",[s._v(\"哨兵只要和主库建立起了连接，就可以在主库上发布消息了，比如说发布它自己的连接信息（IP 和端口）。同时，它也可以从主库上订阅消息，获得其他哨兵发布的连接信息。当多个哨兵实例都在主库上做了发布和订阅操作后，它们之间就能知道彼此的 IP 地址和端口。\")]),s._v(\" \"),t(\"p\",[s._v('在主从集群中，主库上有一个名为 \"'),t(\"strong\",[s._v(\"_ _sentinel_ _:hello\")]),s._v('\" 的频道，不同哨兵就是通过它来相互发现，实现互相通信的。')]),s._v(\" \"),t(\"p\",[s._v(\"举个例子，具体说明一下。\")]),s._v(\" \"),t(\"p\",[s._v(\"在下图中，哨兵 sentinel_26379 把自己的 IP（127.0.0.1）和端口（26379）发布到频道上，哨兵 26380 和 26381 订阅了该频道。那么此时，其他哨兵就可以从这个频道直接获取哨兵 sentinel_26379 的 IP 地址和端口号。通过这个方式，各个哨兵之间就可以建立网络连接，哨兵集群就形成了。它们相互间可以通过网络连接进行通信，比如说对主库有没有下线这件事儿进行判断和协商。\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://cdn.jsdelivr.net/gh/Jstarfish/picBed/redis/redis-sentinel-cluster.png\",alt:\"\"}})]),s._v(\" \"),t(\"h4\",{attrs:{id:\"_4-2-哨兵和从库的连接\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_4-2-哨兵和从库的连接\"}},[s._v(\"#\")]),s._v(\" 4.2 哨兵和从库的连接\")]),s._v(\" \"),t(\"p\",[s._v(\"哨兵除了彼此之间建立起连接形成集群外，还需要和从库建立连接。这是因为，在哨兵的监控任务中，它需要对主从库都进行心跳判断，而且在主从库切换完成后，它还需要通知从库，让它们和新主库进行同步。\")]),s._v(\" \"),t(\"p\",[t(\"strong\",[s._v(\"哨兵是如何知道从库的 IP 地址和端口的呢？\")])]),s._v(\" \"),t(\"p\",[t(\"strong\",[s._v(\"这是由哨兵向主库发送 INFO 命令来完成的。\")])]),s._v(\" \"),t(\"p\",[s._v(\"就像下图所示，哨兵 sentinel_26380 给主库发送 INFO 命令，主库接受到这个命令后，就会把从库列表返回给哨兵。接着，哨兵就可以根据从库列表中的连接信息，和每个从库建立连接，并在这个连接上持续地对从库进行监控。senetinel_26379 和 senetinel_26381 可以通过相同的方法和从库建立连接。\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://cdn.jsdelivr.net/gh/Jstarfish/picBed/redis/redis-sentinel-slave.png\",alt:\"\"}})]),s._v(\" \"),t(\"h4\",{attrs:{id:\"_4-3-哨兵和客户端的连接\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_4-3-哨兵和客户端的连接\"}},[s._v(\"#\")]),s._v(\" 4.3 哨兵和客户端的连接\")]),s._v(\" \"),t(\"p\",[s._v(\"但是，哨兵不能只和主、从库连接。因为，主从库切换后，客户端也需要知道新主库的连接信息，才能向新主库发送请求操作。所以，哨兵还需要完成把新主库的信息告诉客户端这个任务。\")]),s._v(\" \"),t(\"p\",[s._v(\"在实际使用哨兵时，我们有时会遇到这样的问题：如何在客户端通过监控了解哨兵进行主从切换的过程呢？比如说，主从切换进行到哪一步了？这其实就是要求，客户端能够获取到哨兵集群在监控、选主、切换这个过程中发生的各种事件。此时，我们仍然可以\"),t(\"mark\",[t(\"strong\",[s._v(\"依赖 pub/sub 机制\")])]),s._v(\"，来帮助我们完成哨兵和客户端间的信息同步。\")]),s._v(\" \"),t(\"p\",[s._v(\"从本质上说，哨兵就是一个运行在特定模式下的 Redis 实例，只不过它并不服务请求操作，只是完成监控、选主和通知的任务。所以，每个哨兵实例也提供 pub/sub 机制，客户端可以从哨兵订阅消息。\")]),s._v(\" \"),t(\"p\",[s._v(\"哨兵提供的消息订阅频道有很多，不同频道包含了主从库切换过程中的不同关键事件。（这里就不一一列出了）\")]),s._v(\" \"),t(\"p\",[s._v(\"知道了这些频道之后，你就可以让客户端从哨兵这里订阅消息了。具体的操作步骤是，客户端读取哨兵的配置文件后，可以获得哨兵的地址和端口，和哨兵建立网络连接。然后，我们可以在客户端执行订阅命令，来获取不同的事件消息。\")]),s._v(\" \"),t(\"p\",[s._v(\"举个例子，你可以执行如下命令，来订阅“所有实例进入客观下线状态的事件”：\")]),s._v(\" \"),t(\"div\",{staticClass:\"language- extra-class\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-text\"}},[t(\"code\",[s._v(\"SUBSCRIBE +odown\\n\")])])]),t(\"p\",[s._v(\"当然，你也可以执行如下命令，订阅所有的事件：\")]),s._v(\" \"),t(\"div\",{staticClass:\"language- extra-class\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-text\"}},[t(\"code\",[s._v(\"PSUBSCRIBE *\\n\")])])]),t(\"h3\",{attrs:{id:\"五、小结\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#五、小结\"}},[s._v(\"#\")]),s._v(\" 五、小结\")]),s._v(\" \"),t(\"blockquote\",[t(\"p\",[s._v(\"Redis 哨兵是 Redis 的高可用实现方案：故障发现、故障自动转移、配置中心、客户端通知。\")])]),s._v(\" \"),t(\"h4\",{attrs:{id:\"_5-1-哨兵机制其实就有三大功能\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_5-1-哨兵机制其实就有三大功能\"}},[s._v(\"#\")]),s._v(\" 5.1 哨兵机制其实就有三大功能：\")]),s._v(\" \"),t(\"ul\",[t(\"li\",[t(\"p\",[s._v(\"监控：监控主库运行状态，并判断主库是否客观下线；\")])]),s._v(\" \"),t(\"li\",[t(\"p\",[s._v(\"选主：在主库客观下线后，选取新主库；\")])]),s._v(\" \"),t(\"li\",[t(\"p\",[s._v(\"通知：选出新主库后，通知从库和客户端。\")])])]),s._v(\" \"),t(\"h4\",{attrs:{id:\"_5-2-一个哨兵-实际上可以监控多个主节点-通过配置多条-sentinel-monitor-即可实现。\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_5-2-一个哨兵-实际上可以监控多个主节点-通过配置多条-sentinel-monitor-即可实现。\"}},[s._v(\"#\")]),s._v(\" 5.2 一个哨兵，实际上可以监控多个主节点，通过配置多条 sentinel monitor 即可实现。\")]),s._v(\" \"),t(\"h4\",{attrs:{id:\"_5-3-哨兵集群的关键机制\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_5-3-哨兵集群的关键机制\"}},[s._v(\"#\")]),s._v(\" 5.3 哨兵集群的关键机制：\")]),s._v(\" \"),t(\"ul\",[t(\"li\",[s._v(\"哨兵集群是基于 pub/sub 机制组成的\")]),s._v(\" \"),t(\"li\",[s._v(\"基于 INFO 命令的从库列表，这可以帮助哨兵和从库建立连接\")]),s._v(\" \"),t(\"li\",[s._v(\"基于哨兵自身的 pub/sub 功能，这实现了客户端和哨兵之间的事件通知\")])]),s._v(\" \"),t(\"p\",[t(\"code\",[s._v(\"Sentinel\")]),s._v(\" 与 \"),t(\"code\",[s._v(\"Redis\")]),s._v(\" \"),t(\"strong\",[s._v(\"主节点\")]),s._v(\" 和 \"),t(\"strong\",[s._v(\"从节点\")]),s._v(\" 交互的命令，主要包括：\")]),s._v(\" \"),t(\"table\",[t(\"thead\",[t(\"tr\",[t(\"th\",[s._v(\"命令\")]),s._v(\" \"),t(\"th\",[s._v(\"作 用\")])])]),s._v(\" \"),t(\"tbody\",[t(\"tr\",[t(\"td\",[s._v(\"PING\")]),s._v(\" \"),t(\"td\",[t(\"code\",[s._v(\"Sentinel\")]),s._v(\" 向 \"),t(\"code\",[s._v(\"Redis\")]),s._v(\" 节点发送 \"),t(\"code\",[s._v(\"PING\")]),s._v(\" 命令，检查节点的状态\")])]),s._v(\" \"),t(\"tr\",[t(\"td\",[s._v(\"INFO\")]),s._v(\" \"),t(\"td\",[t(\"code\",[s._v(\"Sentinel\")]),s._v(\" 向 \"),t(\"code\",[s._v(\"Redis\")]),s._v(\" 节点发送 \"),t(\"code\",[s._v(\"INFO\")]),s._v(\" 命令，获取它的 \"),t(\"strong\",[s._v(\"从节点信息\")])])]),s._v(\" \"),t(\"tr\",[t(\"td\",[s._v(\"PUBLISH\")]),s._v(\" \"),t(\"td\",[t(\"code\",[s._v(\"Sentinel\")]),s._v(\" 向其监控的 \"),t(\"code\",[s._v(\"Redis\")]),s._v(\" 节点 \"),t(\"code\",[s._v(\"__sentinel__:hello\")]),s._v(\" 这个 \"),t(\"code\",[s._v(\"channel\")]),s._v(\" 发布 \"),t(\"strong\",[s._v(\"自己的信息\")]),s._v(\" 及 \"),t(\"strong\",[s._v(\"主节点\")]),s._v(\" 相关的配置\")])]),s._v(\" \"),t(\"tr\",[t(\"td\",[s._v(\"SUBSCRIBE\")]),s._v(\" \"),t(\"td\",[t(\"code\",[s._v(\"Sentinel\")]),s._v(\" 通过订阅 \"),t(\"code\",[s._v(\"Redis\")]),s._v(\" \"),t(\"strong\",[s._v(\"主节点\")]),s._v(\" 和 \"),t(\"strong\",[s._v(\"从节点\")]),s._v(\" 的 \"),t(\"code\",[s._v(\"__sentinel__:hello\")]),s._v(\" 这个 \"),t(\"code\",[s._v(\"channnel\")]),s._v(\"，获取正在监控相同服务的其他 \"),t(\"code\",[s._v(\"Sentinel\")]),s._v(\" 节点\")])])])]),s._v(\" \"),t(\"p\",[t(\"code\",[s._v(\"Sentinel\")]),s._v(\" 与 \"),t(\"code\",[s._v(\"Sentinel\")]),s._v(\" 交互的命令，主要包括：\")]),s._v(\" \"),t(\"table\",[t(\"thead\",[t(\"tr\",[t(\"th\",[s._v(\"命令\")]),s._v(\" \"),t(\"th\",[s._v(\"作 用\")])])]),s._v(\" \"),t(\"tbody\",[t(\"tr\",[t(\"td\",[s._v(\"PING\")]),s._v(\" \"),t(\"td\",[t(\"code\",[s._v(\"Sentinel\")]),s._v(\" 向其他 \"),t(\"code\",[s._v(\"Sentinel\")]),s._v(\" 节点发送 \"),t(\"code\",[s._v(\"PING\")]),s._v(\" 命令，检查节点的状态\")])]),s._v(\" \"),t(\"tr\",[t(\"td\",[s._v(\"SENTINEL:is-master-down-by-addr\")]),s._v(\" \"),t(\"td\",[s._v(\"和其他 \"),t(\"code\",[s._v(\"Sentinel\")]),s._v(\" 协商 \"),t(\"strong\",[s._v(\"主节点\")]),s._v(\" 的状态，如果 \"),t(\"strong\",[s._v(\"主节点\")]),s._v(\" 处于 \"),t(\"code\",[s._v(\"SDOWN\")]),s._v(\" 状态，则投票自动选出新的 \"),t(\"strong\",[s._v(\"主节点\")])])])])]),s._v(\" \"),t(\"h4\",{attrs:{id:\"_5-4-建议\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_5-4-建议\"}},[s._v(\"#\")]),s._v(\" 5.4 建议\")]),s._v(\" \"),t(\"ul\",[t(\"li\",[t(\"p\",[s._v(\"尽可能在不同物理机上部署 Redis 哨兵所有节点\")])]),s._v(\" \"),t(\"li\",[t(\"p\",[s._v(\"Redis 哨兵中的哨兵节点个数应该为大于等于 3 且最好为奇数\")]),s._v(\" \"),t(\"p\",[s._v(\"推荐奇数个节点，主要是从成本上考虑，因为，集群中，半数以上节点认为主节点故障了，才会选举新的节点。这样的话奇数个节点和偶数个节点允许宕机的节点数就是一样的，比如 3 个节点和 4 个节点都只允许宕机一台，那么为什么要搞 4 个节点去浪费服务资源呢？但是 4 个节点的性能和容量肯定是更高的哈。\")])])]),s._v(\" \"),t(\"h3\",{attrs:{id:\"参考与来源\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#参考与来源\"}},[s._v(\"#\")]),s._v(\" 参考与来源\")]),s._v(\" \"),t(\"ul\",[t(\"li\",[s._v(\"《Redis 开发与运维》\")]),s._v(\" \"),t(\"li\",[s._v(\"《Redis 核心技术与实战》\")]),s._v(\" \"),t(\"li\",[s._v(\"https://redis.io/topics/sentinel\")]),s._v(\" \"),t(\"li\",[s._v(\"https://www.cnblogs.com/kismetv/p/9609938.html\")])])])}),[],!1,null,null,null);e.default=a.exports}}]);","extractedComments":[]}